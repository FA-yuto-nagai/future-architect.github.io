<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <!--
    ███████╗██╗░░░██╗████████╗██╗░░░██╗██████╗░███████╗
    ██╔════╝██║░░░██║╚══██╔══╝██║░░░██║██╔══██╗██╔════╝
    █████╗░░██║░░░██║░░░██║░░░██║░░░██║██████╔╝█████╗░░
    ██╔══╝░░██║░░░██║░░░██║░░░██║░░░██║██╔══██╗██╔══╝░░
    ██║░░░░░╚██████╔╝░░░██║░░░╚██████╔╝██║░░██║███████╗
    ╚═╝░░░░░░╚═════╝░░░░╚═╝░░░░╚═════╝░╚═╝░░╚═╝╚══════╝
    ████████╗███████╗░█████╗░██╗░░██╗
    ╚══██╔══╝██╔════╝██╔══██╗██║░░██║
    ░░░██║░░░█████╗░░██║░░╚═╝███████║
    ░░░██║░░░██╔══╝░░██║░░██╗██╔══██║
    ░░░██║░░░███████╗╚█████╔╝██║░░██║
    ░░░╚═╝░░░╚══════╝░╚════╝░╚═╝░░╚═╝
    ██████╗░██╗░░░░░░█████╗░░██████╗░
    ██╔══██╗██║░░░░░██╔══██╗██╔════╝░
    ██████╦╝██║░░░░░██║░░██║██║░░██╗░
    ██╔══██╗██║░░░░░██║░░██║██║░░╚██╗
    ██████╦╝███████╗╚█████╔╝╚██████╔╝
    ╚═════╝░╚══════╝░╚════╝░░╚═════╝░
    Welcome engineer.
    https://www.future.co.jp/recruit/
  -->
  
  <title>Terraform連載2024 Terraformにおける変数の制御について | フューチャー技術ブログ</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  
  <meta name="description" content="Terraform 連載2024の3本目です。 はじめにはじめまして。フューチャーキャリア入社1年半の森と申します。 Terraformにおける変数を、構築するインフラの要件に合わせてどのように制御していくかについてまとめます。 Terraformにおける変数制御は、構築するインフラの要件を明確化させる上で重要です。そのため、どのような変数制御があるか、ユースケースを踏まえ見ていきます。 Te">
<meta property="og:type" content="article">
<meta property="og:title" content="Terraform連載2024 Terraformにおける変数の制御について | フューチャー技術ブログ">
<meta property="og:url" content="https://future-architect.github.io/articles/20240313a/index.html">
<meta property="og:site_name" content="フューチャー技術ブログ">
<meta property="og:description" content="Terraform 連載2024の3本目です。 はじめにはじめまして。フューチャーキャリア入社1年半の森と申します。 Terraformにおける変数を、構築するインフラの要件に合わせてどのように制御していくかについてまとめます。 Terraformにおける変数制御は、構築するインフラの要件を明確化させる上で重要です。そのため、どのような変数制御があるか、ユースケースを踏まえ見ていきます。 Te">
<meta property="og:locale" content="ja_JP">
<meta property="og:image" content="https://future-architect.github.io/images/20240313a/terraform_top.png">
<meta property="article:published_time" content="2024-03-12T15:00:00.000Z">
<meta property="article:modified_time" content="2024-03-14T00:24:17.043Z">
<meta property="article:tag" content="Terraform">
<meta property="article:tag" content="Terraform1.2">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://future-architect.github.io/images/20240313a/terraform_top.png">
  
  <link rel="alternate" href="/atom.xml" title="フューチャー技術ブログ" type="application/atom+xml">
  
  <link rel="icon" href="/logo.svg" sizes="any" type="image/svg+xml">
  <link rel="mask-icon" href="/logo.svg" sizes="any" color="#0bd">
  <link rel="icon alternate" href="/favicon.ico">
  <link rel="apple-touch-icon" sizes='180x180' href="/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes='57x57' href="/apple-touch-icon-57x57.png">
  <link rel="canonical" href="https://future-architect.github.io/articles/20240313a/">
  <meta content="Terraform,Terraform1.2" name="keywords">
  <meta content="森大作" name="author">
  <link rel="preload" as="image" href="/banner.jpg" />
  <link rel='manifest' href='/manifest.webmanifest'/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">
  <link rel="stylesheet" href="/metronic/assets/style.css">
  <link rel="stylesheet" href="/css/theme-styles.css">
<meta name="generator" content="Hexo 5.4.2"></head>

<body class="corporate">
  <div class="wrap" itemscope itemtype="https://schema.org/TechArticle">
  <!-- BEGIN HEADER -->
<header class="header">
	<div class="header-overlay">
		<div class="header-menu"></div>
		<div class="header-title"><a href="/">Future Tech Blog</a></div>
		<div class="header-title-sub">フューチャー技術ブログ</div>
	</div>
</header>
<!-- Header END -->

  <div class="container">
  <ul class="breadcrumb">
    <li><a href="/">Home</a></li>
    <li><a href="/articles/">Blog</a></li>
    <li class="active">Post</li>
  </ul>
  <section id="main" class="margin-top-30">
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Programming/">Programmingカテゴリ</a>
  </div>


    <h2 itemprop="name" class="article-title">Terraform連載2024 Terraformにおける変数の制御について
  
  <a target="_blank" rel="noopener" href="https://github.com/future-architect/tech-blog/edit/master/source/_posts/2024/20240313a_terraformにおける変数の制御について.md" title="Suggest Edits" class="github-edit"><i class="github-edit-icon"></i></a>
  
</h2>

    <div class="row">
  <main class="col-md-9 blog-posts">
    <article id="post-2024/20240313a_terraformにおける変数の制御について" class="article article-type-post blog-item" itemscope itemprop="blogPost">
      <div class="article-inner">
        
        <header class="article-header">
          <ul class="blog-info">
            <li class="blog-info-item"><a href="/articles/2024/" class="publish-date"><time datetime="2024-03-12T15:00:00.000Z" itemprop="datePublished">2024.03.13</time></a>
</li>
            <li class="blog-info-item"><li><a href="/authors/%E6%A3%AE%E5%A4%A7%E4%BD%9C" title="森大作さんの記事一覧へ" class="post-author">森大作</a></li></li>
            <li class="blog-info-item">
  
    
    <a href="/tags/Terraform/" title="Terraformタグの記事へ" class="tag-list-link">Terraform</a>
  
    
    <a href="/tags/Terraform1-2/" title="Terraform1.2タグの記事へ" class="tag-list-link">Terraform1.2</a>
  

</li>
          </ul>
          </header>
        
        <div class="article-entry" itemprop="articleBody">
          
            <img src="/images/20240313a/terraform_top.png" alt="" width="900" height="628">

<p><a href="/articles/20240311a/">Terraform 連載2024</a>の3本目です。</p>
<h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>はじめまして。フューチャーキャリア入社1年半の森と申します。</p>
<p>Terraformにおける変数を、構築するインフラの要件に合わせてどのように制御していくかについてまとめます。</p>
<p>Terraformにおける変数制御は、構築するインフラの要件を明確化させる上で重要です。そのため、どのような変数制御があるか、ユースケースを踏まえ見ていきます。</p>
<h2 id="Terraformの変数制御"><a href="#Terraformの変数制御" class="headerlink" title="Terraformの変数制御"></a>Terraformの変数制御</h2><p>Terraformには型による制約の他に、下記3種類の変数の制御方法があります。</p>
<ul>
<li>validation : 変数の<strong>静的な事前チェック</strong>を実施する</li>
<li>precondition(v1.2以降) : 変数の<strong>動的な事前チェック</strong>を実施する</li>
<li>postcondition(v1.2以降) : 変数の<strong>動的な事後チェック</strong>を実施する</li>
</ul>
<p>静的・動的の可不可や、事前・事後のチェックなどの違いがありますが、図にするとこのような感じです。</p>
<div class="scroll"><table>
<thead>
<tr>
<th></th>
<th>動的チェック</th>
<th>事前チェック</th>
<th>事後チェック</th>
</tr>
</thead>
<tbody><tr>
<td>validation</td>
<td>不可</td>
<td>可</td>
<td>不可</td>
</tr>
<tr>
<td>precondition</td>
<td>可</td>
<td>可</td>
<td>不可</td>
</tr>
<tr>
<td>postcondition</td>
<td>可</td>
<td>不可</td>
<td>可</td>
</tr>
</tbody></table></div>
<p>具体的に1つずつ確認していきましょう。</p>
<h2 id="validationについて"><a href="#validationについて" class="headerlink" title="validationについて"></a>validationについて</h2><p><code>validation</code>は3つの変数制御の中でも最もシンプルで簡単な制御の方法です</p>
<p>例えば、AWSのEC2でEBSを暗号化したい場合、以下のように<code>validation</code>ブロックを暗号化の有無に関する変数に追加します。</p>
<p>このブロックの<code>condition</code>の内容で真偽を判定し、偽の場合<code>error_message</code>で指定のエラーメッセージを出力できます。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">resource <span class="string">&quot;aws_instance&quot;</span> <span class="string">&quot;example&quot;</span> &#123;</span><br><span class="line">  ami           = <span class="string">&quot;ami-020283e959651b381&quot;</span></span><br><span class="line">  instance_type = <span class="string">&quot;t2.micro&quot;</span></span><br><span class="line">  subnet_id     = <span class="string">&quot;subnet-xxxxxxx&quot;</span></span><br><span class="line"></span><br><span class="line">  ebs_block_device &#123;</span><br><span class="line">    device_name = <span class="string">&quot;/dev/sdh&quot;</span></span><br><span class="line">    encrypted   = var.ebs_encryption</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable <span class="string">&quot;ebs_encryption&quot;</span> &#123;</span><br><span class="line">  <span class="built_in">type</span> = bool</span><br><span class="line">  validation &#123;</span><br><span class="line">    condition     = var.ebs_encryption == <span class="literal">true</span></span><br><span class="line">    error_message = <span class="string">&quot;EBS Should Be Encrypted&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">  description = <span class="string">&quot;A Boolean of EBS Encryption in the EC2 Instances&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ebs_encryption</code>に<code>false</code>を指定した場合、<code>terraform plan</code>時に<code>validation</code>ブロックで指定した下記のエラーメッセージが出されます。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">╷</span><br><span class="line">│ Error: Invalid value <span class="keyword">for</span> variable</span><br><span class="line">│</span><br><span class="line">│   on variables.tf line 1:</span><br><span class="line">│    1: variable <span class="string">&quot;ebs_encryption&quot;</span> &#123;</span><br><span class="line">│     ├────────────────</span><br><span class="line">│     │ var.ebs_encryption is <span class="literal">false</span></span><br><span class="line">│</span><br><span class="line">│ EBS Should Be Encrypted</span><br><span class="line">│</span><br><span class="line">│ This was checked by the validation rule at variables.tf:3,3-13.</span><br></pre></td></tr></table></figure>

<p>このように<code>condition</code>に条件式を書いておくことで、誤ってEBSの暗号化を無効にする事のないように事前にチェックをしてくれるのが<code>validation</code>の特徴です。</p>
<h3 id="validationのユースケース"><a href="#validationのユースケース" class="headerlink" title="validationのユースケース"></a>validationのユースケース</h3><p>構築したいインフラに対して、あらかじめ変数の条件をハードコードすることで制約を課したい場合に<code>validation</code>ブロックが使えます。</p>
<h2 id="preconditionについて"><a href="#preconditionについて" class="headerlink" title="preconditionについて"></a>preconditionについて</h2><p>上述の<code>validation</code>で課すことのできる制約は静的な条件に限りました。つまり、全て条件式にハードコードして制御する必要があり、動的にAWSから情報を取得して条件を絞ることは不可能でした。</p>
<p>これを解決したのがTerraform v1.2から追加された<code>precondition</code>です。例えば、EC2のインスタンスタイプを無料利用枠のみに制限したい場合、<code>aws_ec2_instance_type</code>データソースから最新の無料利用枠の情報をAWSから取得し、インスタンス構築の際の条件に課すことが可能です。</p>
<p><code>lifecycle</code>ブロック内に<code>precondition</code>ブロックを作成し、<code>condition</code>の条件で真偽を判定し、偽の場合に<code>error_message</code>に記載されているメッセージを出力できます。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">data <span class="string">&quot;aws_ec2_instance_type&quot;</span> <span class="string">&quot;example&quot;</span> &#123;</span><br><span class="line">  instance_type = <span class="string">&quot;c5.xlarge&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource <span class="string">&quot;aws_instance&quot;</span> <span class="string">&quot;example&quot;</span> &#123;</span><br><span class="line">  ami           = <span class="string">&quot;ami-0f7b55661ecbbe44c&quot;</span></span><br><span class="line">  instance_type = data.aws_ec2_instance_type.example.instance_type</span><br><span class="line">  subnet_id     = <span class="string">&quot;subnet-xxxxxxxxxx&quot;</span></span><br><span class="line">  lifecycle &#123;</span><br><span class="line">    precondition &#123;</span><br><span class="line">      condition     = data.aws_ec2_instance_type.example.free_tier_eligible</span><br><span class="line">      error_message = <span class="string">&quot;This instance type is not free in AWS&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上記のようにインスタンスタイプを<code>c5.xlarge</code>(無料利用枠でないインスタンスタイプ)でplanを流してみるとどうなるでしょうか？</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">╷</span><br><span class="line">│ Error: Resource precondition failed</span><br><span class="line">│</span><br><span class="line">│   on main.tf line 18, <span class="keyword">in</span> resource <span class="string">&quot;aws_instance&quot;</span> <span class="string">&quot;example&quot;</span>:</span><br><span class="line">│   18:       condition     = data.aws_ec2_instance_type.example.free_tier_eligible</span><br><span class="line">│     ├────────────────</span><br><span class="line">│     │ data.aws_ec2_instance_type.example.free_tier_eligible is <span class="literal">false</span></span><br><span class="line">│</span><br><span class="line">│ This instance <span class="built_in">type</span> is not free <span class="keyword">in</span> AWS</span><br></pre></td></tr></table></figure>

<p>指定のエラーメッセージとともに無事？planが通らなくなりました。(当然、applyもできません。)</p>
<p>このように<code>validation</code>と違って動的な変数の制御を可能にするのが<code>precondition</code>の特徴です。</p>
<h3 id="preconditionのユースケース"><a href="#preconditionのユースケース" class="headerlink" title="preconditionのユースケース"></a>preconditionのユースケース</h3><p><code>validation</code>でハードコーディングするのが難しい場合に使うのが良いでしょう。</p>
<p>最新のAWSからの情報が常に反映されるため、より安定的なチェックが実施できます。</p>
<h2 id="postconditionについて"><a href="#postconditionについて" class="headerlink" title="postconditionについて"></a>postconditionについて</h2><p><code>varidation</code>や<code>precondition</code>はapply前に変数をチェックする<strong>事前チェック</strong>でした。一方で<code>postcondition</code>は、<strong>applyの後にエラーを追跡</strong>する事後チェックが可能です。</p>
<p>例としてオートスケーリンググループを作成する際、AZが２つ以上あるかどうかをチェックしたい場合を考えます。書き方は<code>precondition</code>と同様で、<code>postcondition</code>ブロックの<code>condition</code>でAZの数が1よりも大きくない場合に指定のエラーメッセージを出力するようにします。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">resource <span class="string">&quot;aws_launch_configuration&quot;</span> <span class="string">&quot;example&quot;</span> &#123;</span><br><span class="line">  image_id      = <span class="string">&quot;ami-020283e959651b381&quot;</span></span><br><span class="line">  instance_type = <span class="string">&quot;t2.micro&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource <span class="string">&quot;aws_autoscaling_group&quot;</span> <span class="string">&quot;example&quot;</span> &#123;</span><br><span class="line">  name                 = <span class="string">&quot;ASG&quot;</span></span><br><span class="line">  launch_configuration = aws_launch_configuration.example.name</span><br><span class="line">  vpc_zone_identifier  = [<span class="string">&quot;subnet-xxxxxxx&quot;</span>]</span><br><span class="line">  min_size             = 1</span><br><span class="line">  max_size             = 1</span><br><span class="line"></span><br><span class="line">  lifecycle &#123;</span><br><span class="line">    postcondition &#123;</span><br><span class="line">      condition     = length(self.availability_zones) &gt; 1</span><br><span class="line">      error_message = <span class="string">&quot;You need to choose more than 1 AZ to ensure high availability&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>planをしてみましょう。この時点でAZは<code>known after apply</code>とあるので、エラーは捕捉されずにplan自体は通ります。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">Terraform will perform the following actions:</span><br><span class="line"></span><br><span class="line">  <span class="comment"># aws_autoscaling_group.example will be created</span></span><br><span class="line">  + resource <span class="string">&quot;aws_autoscaling_group&quot;</span> <span class="string">&quot;example&quot;</span> &#123;</span><br><span class="line">      + arn                              = (known after apply)</span><br><span class="line">      + availability_zones               = (known after apply)</span><br><span class="line">      + default_cooldown                 = (known after apply)</span><br><span class="line">      + desired_capacity                 = (known after apply)</span><br><span class="line">      + force_delete                     = <span class="literal">false</span></span><br><span class="line">      + force_delete_warm_pool           = <span class="literal">false</span></span><br><span class="line">      + health_check_grace_period        = 300</span><br><span class="line">      + health_check_type                = (known after apply)</span><br><span class="line">      + <span class="built_in">id</span>                               = (known after apply)</span><br><span class="line">      + ignore_failed_scaling_activities = <span class="literal">false</span></span><br><span class="line">      + launch_configuration             = (known after apply)</span><br><span class="line">      + load_balancers                   = (known after apply)</span><br><span class="line">      + max_size                         = 1</span><br><span class="line">      + metrics_granularity              = <span class="string">&quot;1Minute&quot;</span></span><br><span class="line">      + min_size                         = 1</span><br><span class="line">      + name                             = <span class="string">&quot;ASG&quot;</span></span><br><span class="line">      + name_prefix                      = (known after apply)</span><br><span class="line">      + predicted_capacity               = (known after apply)</span><br><span class="line">      + protect_from_scale_in            = <span class="literal">false</span></span><br><span class="line">      + service_linked_role_arn          = (known after apply)</span><br><span class="line">      + target_group_arns                = (known after apply)</span><br><span class="line">      + vpc_zone_identifier              = [</span><br><span class="line">          + <span class="string">&quot;subnet-xxxxxxx&quot;</span>,</span><br><span class="line">        ]</span><br><span class="line">      + wait_for_capacity_timeout        = <span class="string">&quot;10m&quot;</span></span><br><span class="line">      + warm_pool_size                   = (known after apply)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># aws_launch_configuration.example will be created</span></span><br><span class="line">  + resource <span class="string">&quot;aws_launch_configuration&quot;</span> <span class="string">&quot;example&quot;</span> &#123;</span><br><span class="line">      + arn                         = (known after apply)</span><br><span class="line">      + associate_public_ip_address = (known after apply)</span><br><span class="line">      + ebs_optimized               = (known after apply)</span><br><span class="line">      + enable_monitoring           = <span class="literal">true</span></span><br><span class="line">      + <span class="built_in">id</span>                          = (known after apply)</span><br><span class="line">      + image_id                    = <span class="string">&quot;ami-020283e959651b381&quot;</span></span><br><span class="line">      + instance_type               = <span class="string">&quot;t2.micro&quot;</span></span><br><span class="line">      + key_name                    = (known after apply)</span><br><span class="line">      + name                        = (known after apply)</span><br><span class="line">      + name_prefix                 = (known after apply)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">Plan: 2 to add, 0 to change, 0 to destroy.</span><br></pre></td></tr></table></figure>

<p>この状態でapplyすると完了後に下記のエラーが出ます。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">╷</span><br><span class="line">│ Error: Resource postcondition failed</span><br><span class="line">│</span><br><span class="line">│   on main.tf line 38, <span class="keyword">in</span> resource <span class="string">&quot;aws_autoscaling_group&quot;</span> <span class="string">&quot;example&quot;</span>:</span><br><span class="line">│   38:       condition     = length(self.availability_zones) &gt; 1</span><br><span class="line">│     ├────────────────</span><br><span class="line">│     │ self.availability_zones is <span class="built_in">set</span> of string with 1 element</span><br><span class="line">│</span><br><span class="line">│ You need to choose more than 1 AZ to ensure high availability</span><br></pre></td></tr></table></figure>

<p>エラーは出力されていますが、<code>precondition</code>と異なり、planはちゃんと通ってリソースまで作成されているのが分かります。</p>
<p>これが<code>postcondition</code>の事後チェックというもので、apply後へのリソースの変数に対するチェックを実施することが可能になっています。</p>
<h3 id="postconditionのユースケース"><a href="#postconditionのユースケース" class="headerlink" title="postconditionのユースケース"></a>postconditionのユースケース</h3><p><code>validation</code>や<code>precondition</code>などの事前チェックのみで補足しきれない条件を課すのが良いでしょう。</p>
<p>上記のような例だと、apply時にリソースが作成されてしまうので、事前チェックのようにリソース作成前に制限を課すような強い制約ができないことには注意が必要です。</p>
<h2 id="おまけ"><a href="#おまけ" class="headerlink" title="おまけ"></a>おまけ</h2><p>インスタンスタイプの選定で<code>precondition</code>を使いましたが、<code>precondition</code>→<code>postcondition</code>と単純に置き換えてみたらどうなるでしょうか？</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">data <span class="string">&quot;aws_ec2_instance_type&quot;</span> <span class="string">&quot;example&quot;</span> &#123;</span><br><span class="line">  instance_type = <span class="string">&quot;c5.xlarge&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource <span class="string">&quot;aws_instance&quot;</span> <span class="string">&quot;example&quot;</span> &#123;</span><br><span class="line">  ami           = <span class="string">&quot;ami-0f7b55661ecbbe44c&quot;</span></span><br><span class="line">  instance_type = data.aws_ec2_instance_type.example.instance_type</span><br><span class="line">  subnet_id     = <span class="string">&quot;subnet-xxxxxxx&quot;</span></span><br><span class="line">  lifecycle &#123;</span><br><span class="line">    postcondition &#123;</span><br><span class="line">      condition     = data.aws_ec2_instance_type.example.free_tier_eligible</span><br><span class="line">      error_message = <span class="string">&quot;This instance type is not free in AWS&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上記は<a href="#precondition%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">preconditionについて</a>におけるコードで<code>precondition</code>が<code>postcondition</code>に置き換わっているだけです。</p>
<p>planで下記エラーが出てきます。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:</span><br><span class="line">  + create</span><br><span class="line"></span><br><span class="line">Terraform planned the following actions, but <span class="keyword">then</span> encountered a problem:</span><br><span class="line"></span><br><span class="line">  <span class="comment"># aws_instance.example will be created</span></span><br><span class="line">  + resource <span class="string">&quot;aws_instance&quot;</span> <span class="string">&quot;example&quot;</span> &#123;</span><br><span class="line">      + ami                                  = <span class="string">&quot;ami-0f7b55661ecbbe44c&quot;</span></span><br><span class="line">      + arn                                  = (known after apply)</span><br><span class="line">      + associate_public_ip_address          = (known after apply)</span><br><span class="line">      + availability_zone                    = (known after apply)</span><br><span class="line">      + cpu_core_count                       = (known after apply)</span><br><span class="line">      + cpu_threads_per_core                 = (known after apply)</span><br><span class="line">      + disable_api_stop                     = (known after apply)</span><br><span class="line">      + disable_api_termination              = (known after apply)</span><br><span class="line">      + ebs_optimized                        = (known after apply)</span><br><span class="line">      + get_password_data                    = <span class="literal">false</span></span><br><span class="line">      + host_id                              = (known after apply)</span><br><span class="line">      + host_resource_group_arn              = (known after apply)</span><br><span class="line">      + iam_instance_profile                 = (known after apply)</span><br><span class="line">      + <span class="built_in">id</span>                                   = (known after apply)</span><br><span class="line">      + instance_initiated_shutdown_behavior = (known after apply)</span><br><span class="line">      + instance_lifecycle                   = (known after apply)</span><br><span class="line">      + instance_state                       = (known after apply)</span><br><span class="line">      + instance_type                        = <span class="string">&quot;c5.xlarge&quot;</span></span><br><span class="line">      + ipv6_address_count                   = (known after apply)</span><br><span class="line">      + ipv6_addresses                       = (known after apply)</span><br><span class="line">      + key_name                             = (known after apply)</span><br><span class="line">      + monitoring                           = (known after apply)</span><br><span class="line">      + outpost_arn                          = (known after apply)</span><br><span class="line">      + password_data                        = (known after apply)</span><br><span class="line">      + placement_group                      = (known after apply)</span><br><span class="line">      + placement_partition_number           = (known after apply)</span><br><span class="line">      + primary_network_interface_id         = (known after apply)</span><br><span class="line">      + private_dns                          = (known after apply)</span><br><span class="line">      + private_ip                           = (known after apply)</span><br><span class="line">      + public_dns                           = (known after apply)</span><br><span class="line">      + public_ip                            = (known after apply)</span><br><span class="line">      + secondary_private_ips                = (known after apply)</span><br><span class="line">      + security_groups                      = (known after apply)</span><br><span class="line">      + source_dest_check                    = <span class="literal">true</span></span><br><span class="line">      + spot_instance_request_id             = (known after apply)</span><br><span class="line">      + subnet_id                            = <span class="string">&quot;subnet-xxxxxxx&quot;</span></span><br><span class="line">      + tags_all                             = (known after apply)</span><br><span class="line">      + tenancy                              = (known after apply)</span><br><span class="line">      + user_data                            = (known after apply)</span><br><span class="line">      + user_data_base64                     = (known after apply)</span><br><span class="line">      + user_data_replace_on_change          = <span class="literal">false</span></span><br><span class="line">      + vpc_security_group_ids               = (known after apply)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">Plan: 1 to add, 0 to change, 0 to destroy.</span><br><span class="line">╷</span><br><span class="line">│ Error: Resource postcondition failed</span><br><span class="line">│</span><br><span class="line">│   on main.tf line 11, <span class="keyword">in</span> resource <span class="string">&quot;aws_instance&quot;</span> <span class="string">&quot;example&quot;</span>:</span><br><span class="line">│   11:       condition     = data.aws_ec2_instance_type.example.free_tier_eligible</span><br><span class="line">│     ├────────────────</span><br><span class="line">│     │ data.aws_ec2_instance_type.example.free_tier_eligible is <span class="literal">false</span></span><br><span class="line">│</span><br><span class="line">│ This instance <span class="built_in">type</span> is not free <span class="keyword">in</span> AWS</span><br></pre></td></tr></table></figure>

<p>エラーメッセージは<code>precondition</code>とほぼ変わらないのですが、<code>postcondition</code>では plan によるリソース出力が成功します（<code>precondition</code>ではplanが失敗してリソース出力がされませんでした）。</p>
<p>これは<code>postcondition</code>が事後チェックであることを反映している例で、データソースやリソースが取得された後で値が評価されていることを如実に表しています。</p>
<p>こうなると <code>postcondition</code>で全部チェックしてしまっても良い気もしますが、事後チェックであるか事後チェックであるかを明示するため、<code>precondition</code>で制御できる箇所は<code>precondition</code>で制御するようにしましょう。</p>
<h2 id="さいごに"><a href="#さいごに" class="headerlink" title="さいごに"></a>さいごに</h2><p>多くの変数に対して制限を課すのはなかなか大変で工数を取る上、可読性にも影響します。</p>
<p>修正の際にupdate in placeなどで気軽にアップデート出来ない変数(EBS暗号化の有無など)に対する制約から優先的に実施するのが個人的には良いと思います。</p>
<h2 id="参考リンク"><a href="#参考リンク" class="headerlink" title="参考リンク"></a>参考リンク</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.oreilly.co.jp/books/9784814400522/">詳解Terraform</a></li>
</ul>

          
        </div>
        <footer>
          <section class="social-area">
          <!-- シェアボタン START -->
  <ul class="social-button">
    
    <!-- Twitter -->
    <li>
      <a class="social-btn twitter-btn" target="_blank" href="https://twitter.com/share?url=https://future-architect.github.io/articles/20240313a/&related=twitterapi%2Ctwitter&text=Terraform%E9%80%A3%E8%BC%892024%20Terraform%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E5%A4%89%E6%95%B0%E3%81%AE%E5%88%B6%E5%BE%A1%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6%20%7C%20%E3%83%95%E3%83%A5%E3%83%BC%E3%83%81%E3%83%A3%E3%83%BC%E6%8A%80%E8%A1%93%E3%83%96%E3%83%AD%E3%82%B0" rel="nofollow noopener">
        <i></i><span class="social-btn-label">ツイート</span>
      </a>
    </li>
    <!-- Facebook -->
    <li>
      <a class="social-btn fb-btn" target="_blank" href="http://www.facebook.com/share.php?u=https://future-architect.github.io/articles/20240313a/&t=Terraform%E9%80%A3%E8%BC%892024%20Terraform%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E5%A4%89%E6%95%B0%E3%81%AE%E5%88%B6%E5%BE%A1%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6" rel="nofollow noopener">
        <i></i><span class="social-btn-label">シェア</span>
      </a>
    </li>
    <!-- hatebu -->
    <li>
      <a class="social-btn hatebu-btn" target="_blank" href="https://b.hatena.ne.jp/entry/s/future-architect.github.io/articles/20240313a/" rel="nofollow noopener">
        <i></i><span class="social-btn-label">4</span>
      </a>
    </li>
    <!-- pocket -->
    <li>
      <a class="social-btn pocket-btn" target="_blank" href="https://getpocket.com/save?url=https://future-architect.github.io/articles/20240313a/" rel="nofollow noopener">
        <i></i><span class="social-btn-label">2</span>
      </a>
    </li>
    
  </ul>
<!-- シェアボタン END -->

          </section>
          <aside>
            <section class="related-post margin-bottom-40 nav">
              <h2 id="related"><a href="#related" class="headerlink" title="関連記事"></a>関連記事</h2>
              
  <div class="widget">
    <ul class="nav related-post-link"><li class="related-posts-item"><span>2024.03.28</span><span class="snscount">&#9825;5</span><a href=/articles/20240328b/ title="Terraformでは似たリソースを複数構築する際に、ループ処理や条件分岐を利用することで、コードの冗長化を防ぎ、可読性や保守性を上げることができます。初心者目線で「Terraformのコードをスマートに書きたい！」というモチベーションのもと本記事を書いてみました。">Terraformでのループ処理と条件分岐<span class="newitem">NEW</span></a></li><li class="related-posts-item"><span>2024.03.27</span><span class="snscount">&#9825;7</span><a href=/articles/20240327a/ title="Cloudflareで管理しているドメインのDNS設定や、Cloudflare Pages等のサービスの設定を、Terraform管理に移行した際の手順等を、備忘録がてら記載します。">手動運用しているCloudflareをTerraformでInfrastructure as Codeする<span class="newitem">NEW</span></a></li><li class="related-posts-item"><span>2024.03.26</span><span class="snscount">&#9825;5</span><a href=/articles/20240326a/ title="Terraform 連載ということで、そういえば、実装コードは Go で書かれていたな、コマンドの使い方はインフラエンジニアの皆様が書いてくれるはずなので、コードリーディングしようかな">Terraformの実装コードを、動かしながら読む<span class="newitem">NEW</span></a></li><li class="related-posts-item"><span>2024.03.25</span><span class="snscount">&#9825;1</span><a href=/articles/20240325a/ title="昨今のOpenAI需要によって、Azure環境の利用を本格的に始める方も多いかと思います。今回はAzure環境でTerraformを利用する際、裏で動いているリソースプロバイダーについてご紹介します。">Azure環境Terraform実行におけるリソースプロバイダーについて<span class="newitem">NEW</span></a></li><li class="related-posts-item"><span>2024.03.21</span><span class="snscount">&#9825;12</span><a href=/articles/20240321a/ title="Terraform を使ってクラウド環境とか構築する人は多くいると思います。その中で毎回のようにどうやってテストをやるべきなのかなーとか悩んで、結果大したことも出来ずにリリースまで来てしまったということはないでしょうか。今回は、その悩みを少しでも払拭できないかと思い、Terraform v1.6 とv1.7 で提供されたtestsに触れていきたいと思います。">Terraform連載2024 テストとモックを使ってみる<span class="newitem">NEW</span></a></li><li class="related-posts-item"><span>2024.03.18</span><span class="snscount">&#9825;3</span><a href=/articles/20240318a/ title="cfn-guardを使用してTerraformをポリシーチェックしようとした話をします。">cfn-guardを使ってTerraformをポリシーチェックしようとした話<span class="newitem">NEW</span></a></li></ul>
  </div>
            </section>
            <section class="reference-post margin-bottom-40 nav">
              
  <div class="card">
    <div id="reference" class="reference-lede"><a href="#reference" class="headerlink" title="参照されている記事"></a>この記事を参照している記事</div>
    <ul class="reference-post-link"><li class="reference-posts-item"><a href=/articles/20240311a/ title="Terraform連載を開始します。">Terraform連載2024を開始します & TerraformにおけるDR戦略を考える<span class="newitem">NEW</span></a></li></ul>
  </div>
            </section>
          </aside>
        </footer>
      </div>
    </article>
  </main>
  <aside class="col-md-3 blog-sidebar">
    <!-- START SIDEBAR  -->


<section class="toc-section">
  <h2 class="margin-top-30">目次</h2>
  <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><span class="toc-text">はじめに</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Terraform%E3%81%AE%E5%A4%89%E6%95%B0%E5%88%B6%E5%BE%A1"><span class="toc-text">Terraformの変数制御</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#validation%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><span class="toc-text">validationについて</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#validation%E3%81%AE%E3%83%A6%E3%83%BC%E3%82%B9%E3%82%B1%E3%83%BC%E3%82%B9"><span class="toc-text">validationのユースケース</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#precondition%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><span class="toc-text">preconditionについて</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#precondition%E3%81%AE%E3%83%A6%E3%83%BC%E3%82%B9%E3%82%B1%E3%83%BC%E3%82%B9"><span class="toc-text">preconditionのユースケース</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#postcondition%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><span class="toc-text">postconditionについて</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#postcondition%E3%81%AE%E3%83%A6%E3%83%BC%E3%82%B9%E3%82%B1%E3%83%BC%E3%82%B9"><span class="toc-text">postconditionのユースケース</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E3%81%8A%E3%81%BE%E3%81%91"><span class="toc-text">おまけ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E3%81%95%E3%81%84%E3%81%94%E3%81%AB"><span class="toc-text">さいごに</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E3%83%AA%E3%83%B3%E3%82%AF"><span class="toc-text">参考リンク</span></a></li></ol></li></ol>
</section>

<section class="category">
<h2 class="margin-top-30">カテゴリー</h2>
<div class="widget">
  <ul class="nav sidebar-categories margin-bottom-40">
  
  <li class=""><a href="/categories/Programming/">Programming (442)</a></li>
<li class=""><a href="/categories/Infrastructure/">Infrastructure (267)</a></li>
<li class=""><a href="/categories/Culture/">Culture (98)</a></li>
<li class=""><a href="/categories/DataScience/">DataScience (62)</a></li>
<li class=""><a href="/categories/IoT/">IoT (35)</a></li>
<li class=""><a href="/categories/DB/">DB (25)</a></li>
<li class=""><a href="/categories/DevOps/">DevOps (23)</a></li>
<li class=""><a href="/categories/%E8%AA%8D%E8%A8%BC%E8%AA%8D%E5%8F%AF/">認証認可 (21)</a></li>
<li class=""><a href="/categories/Business/">Business (21)</a></li>
<li class=""><a href="/categories/Management/">Management (17)</a></li>
<li class=""><a href="/categories/Security/">Security (15)</a></li>
<li class=""><a href="/categories/VR/">VR (13)</a></li>
<li class=""><a href="/categories/Design/">Design (11)</a></li>

  </ul>
</div>

</section>
<section class="podcast-link">
<h2 class="margin-top-30">Tech Cast</h2>

  <div class="class="widget-wrap">
  <div class="widget">
    <ul class="nav techcast">
      
    </ul>
  </div>
  </div>
  
</section>
<section class="advent-calendar">
<h2 class="margin-top-30">アドベントカレンダー</h2>
<div class="widget">
  <ul class="nav-flex">
    <li><a href="http://qiita.com/advent-calendar/2023/future" title="フューチャー Advent Calendar 2023 #Qiita" target="_blank" rel="noopener">2023年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2022/future" title="フューチャー Advent Calendar 2022 #Qiita" target="_blank" rel="noopener">2022年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2021/future" title="フューチャー Advent Calendar 2021 #Qiita" target="_blank" rel="noopener">2021年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2020/future" title="フューチャー Advent Calendar 2020 #Qiita" target="_blank" rel="noopener">2020年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2019/future" title="フューチャー Advent Calendar 2019 #Qiita" target="_blank" rel="noopener">2019年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2018/future" title="フューチャー Advent Calendar 2018 #Qiita" target="_blank" rel="noopener">2018年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2017/future" title="フューチャー Advent Calendar 2017 #Qiita" target="_blank" rel="noopener">2017年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2016/future" title="フューチャー Advent Calendar 2016 #Qiita" target="_blank" rel="noopener">2016年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2015/future" title="フューチャー Advent Calendar 2015 #Qiita" target="_blank" rel="noopener">2015年</a></li>
  </ul>
</div>

</section>
<!-- END SIDEBAR -->

  </aside>
</div>

  </section>
</div>

      <!-- BEGIN PRE-FOOTER -->
    <footer>
      <div class="pre-footer">
        <div class="container">
          <div class="row">
            <div class="col-lg-4 col-md-4 col-sm-6 col-6 pre-footer-col">
              <h2>About Us</h2>
              <p>経営とITをデザインする、フューチャーの技術ブログです。業務で利用している幅広い技術について紹介します。<br /><br /><a target="_blank" rel="noopener" href="http://www.future.co.jp/">http://www.future.co.jp/</a></p>
              <div class="social-btn twitter-btn twitter-follow-btn">
                <a href="https://twitter.com/intent/follow?screen_name=future_techblog " target="_blank" rel="nofollow noopener">
                  <i></i><span class="tw-btn-label">フューチャー技術ブログをフォロー</span>
                </a>
              </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-4 col-4 pre-footer-col">
              <h2>Contact</h2>
              <address class="margin-bottom-40">
                <a href="https://www.future.co.jp/recruit/recruit/rec-fresh/" title="新卒採用" target="_blank" rel="noopener">新卒採用</a><br>
                <a href="https://www.future.co.jp/recruit/recruit/rec-career/" title="キャリア採用" target="_blank" rel="noopener">キャリア採用</a><br>
                <a href="https://www.future.co.jp/contact_us/" title="お問い合わせページ" target="_blank" rel="noopener">お問い合わせ</a><br>
                <a href="https://www.future.co.jp/architect/socialmediapolicy/" title="ソーシャルメディアポリシー" target="_blank" rel="noopener">メディアポリシー</a><br><br>
                <a href="mailto:techblog@future.co.jp">techblog@future.co.jp</a>
              </address>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 col-6 pre-footer-col">
              <h2>Contents</h2>
              <a href="https://future-architect.github.io/coding-standards/" title="Future Enterprise Coding Standards" target="_blank" rel="noopener">コーディング規約</a><br>
              <a href="https://future-architect.github.io/typescript-guide/" title="仕事ですぐに使えるTypeScript" target="_blank" rel="noopener">仕事ですぐに使えるTypeScript</a><br>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-3 col-3 pre-footer-col">
              <h2>Event</h2>
              <a href="https://future.connpass.com/" title="経営とITをデザインするフューチャーの勉強会です" target="_blank" rel="noopener">connpass</a><br>
              <a href="https://www.future.co.jp/futureinsightseminar/" title="フューチャーインサイトセミナー" target="_blank" rel="noopener">Webセミナー</a><br>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-3 col-3 pre-footer-col">
              <h2>SNS</h2>
              <a href="https://github.com/future-architect" title="Future's official open source repositories" target="_blank" rel="noopener">GitHub</a><br>
              <a href="https://qiita.com/organizations/future" title="フューチャーのQiita Organizationです" target="_blank" rel="noopener">Qiita</a><br>
              <a href="https://note.future.co.jp/" title="フューチャーの公式note" target="_blank" rel="noopener">未来報</a><br>
              <a href="https://www.youtube.com/channel/UCJUSwYYd0CkGgmEKAW7QVpw" title="フューチャーYoutubeチャネル" target="_blank" rel="noopener">Youtube</a>
            </div>
          </div>
        </div>
      </div>
      <div class="footer">
        <div class="container">
          <div class="row">
            <div class="col-md-6 col-sm-6 padding-top-10">
              &copy; 2024 フューチャー技術ブログ<br>
            </div>
          </div>
        </div>
      </div>
    </footer>

  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-X1C28R8H0M"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-X1C28R8H0M');
  gtag('config', 'UA-74047147-1'); // 過渡期対応
</script>

  </div>
</body>
</html>
