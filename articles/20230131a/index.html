<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <!--
    ███████╗██╗░░░██╗████████╗██╗░░░██╗██████╗░███████╗
    ██╔════╝██║░░░██║╚══██╔══╝██║░░░██║██╔══██╗██╔════╝
    █████╗░░██║░░░██║░░░██║░░░██║░░░██║██████╔╝█████╗░░
    ██╔══╝░░██║░░░██║░░░██║░░░██║░░░██║██╔══██╗██╔══╝░░
    ██║░░░░░╚██████╔╝░░░██║░░░╚██████╔╝██║░░██║███████╗
    ╚═╝░░░░░░╚═════╝░░░░╚═╝░░░░╚═════╝░╚═╝░░╚═╝╚══════╝
    ████████╗███████╗░█████╗░██╗░░██╗
    ╚══██╔══╝██╔════╝██╔══██╗██║░░██║
    ░░░██║░░░█████╗░░██║░░╚═╝███████║
    ░░░██║░░░██╔══╝░░██║░░██╗██╔══██║
    ░░░██║░░░███████╗╚█████╔╝██║░░██║
    ░░░╚═╝░░░╚══════╝░╚════╝░╚═╝░░╚═╝
    ██████╗░██╗░░░░░░█████╗░░██████╗░
    ██╔══██╗██║░░░░░██╔══██╗██╔════╝░
    ██████╦╝██║░░░░░██║░░██║██║░░██╗░
    ██╔══██╗██║░░░░░██║░░██║██║░░╚██╗
    ██████╦╝███████╗╚█████╔╝╚██████╔╝
    ╚═════╝░╚══════╝░╚════╝░░╚═════╝░
    Welcome engineer.
    https://www.future.co.jp/recruit/
  -->
  
  <title>New ReverseProxy Rewrite hook を動かしながら理解する | フューチャー技術ブログ</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  
  <meta name="description" content="目次 はじめに 概要を確認 Proposal の内容と RFC の確認 実際に動かしながら、Go1.19 と Go1.20 の違いを確認 まとめ  はじめにこんにちは。フューチャーアーキテクト株式会社、HR&#x2F;新卒採用チームの棚井です。 略歴として、フューチャーに新卒入社、Technology Innovation Group で IT コンサルタントを 3 年、Global Desi">
<meta property="og:type" content="article">
<meta property="og:title" content="New ReverseProxy Rewrite hook を動かしながら理解する | フューチャー技術ブログ">
<meta property="og:url" content="https://future-architect.github.io/articles/20230131a/index.html">
<meta property="og:site_name" content="フューチャー技術ブログ">
<meta property="og:description" content="目次 はじめに 概要を確認 Proposal の内容と RFC の確認 実際に動かしながら、Go1.19 と Go1.20 の違いを確認 まとめ  はじめにこんにちは。フューチャーアーキテクト株式会社、HR&#x2F;新卒採用チームの棚井です。 略歴として、フューチャーに新卒入社、Technology Innovation Group で IT コンサルタントを 3 年、Global Desi">
<meta property="og:locale" content="ja_JP">
<meta property="og:image" content="https://future-architect.github.io/images/20230131a/top.png">
<meta property="article:published_time" content="2023-01-30T15:00:00.000Z">
<meta property="article:modified_time" content="2023-06-07T02:25:54.539Z">
<meta property="article:tag" content="Go">
<meta property="article:tag" content="Go1.20">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://future-architect.github.io/images/20230131a/top.png">
  
  <link rel="alternate" href="/atom.xml" title="フューチャー技術ブログ" type="application/atom+xml">
  
  <link rel="icon" href="/logo.svg" sizes="any" type="image/svg+xml">
  <link rel="mask-icon" href="/logo.svg" sizes="any" color="#0bd">
  <link rel="icon alternate" href="/favicon.ico">
  <link rel="apple-touch-icon" sizes='180x180' href="/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes='57x57' href="/apple-touch-icon-57x57.png">
  <link rel="canonical" href="https://future-architect.github.io/articles/20230131a/">
  <meta content="Go,Go1.20" name="keywords">
  <meta content="棚井龍之介" name="author">
  <link rel="preload" as="image" href="/banner.jpg" />
  <link rel='manifest' href='/manifest.webmanifest'/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">
  <link rel="stylesheet" href="/metronic/assets/style.css">
  <link rel="stylesheet" href="/css/theme-styles.css">
<meta name="generator" content="Hexo 5.4.2"></head>

<body class="corporate">
  <div class="wrap" itemscope itemtype="https://schema.org/TechArticle">
  <!-- BEGIN HEADER -->
<header class="header">
	<div class="header-overlay">
		<div class="header-menu"></div>
		<div class="header-title"><a href="/">Future Tech Blog</a></div>
		<div class="header-title-sub">フューチャー技術ブログ</div>
	</div>
</header>
<!-- Header END -->

  <div class="container">
  <ul class="breadcrumb">
    <li><a href="/">Home</a></li>
    <li><a href="/articles/">Blog</a></li>
    <li class="active">Post</li>
  </ul>
  <section id="main" class="margin-top-30">
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Programming/">Programmingカテゴリ</a>
  </div>


    <h2 itemprop="name" class="article-title">New ReverseProxy Rewrite hook を動かしながら理解する
  
  <a target="_blank" rel="noopener" href="https://github.com/future-architect/tech-blog/edit/master/source/_posts/20230131a_New_ReverseProxy_Rewrite_hook_を動かしながら理解する.md" title="Suggest Edits" class="github-edit"><i class="github-edit-icon"></i></a>
  
</h2>

    <div class="row">
  <main class="col-md-9 blog-posts">
    <article id="post-20230131a_New_ReverseProxy_Rewrite_hook_を動かしながら理解する" class="article article-type-post blog-item" itemscope itemprop="blogPost">
      <div class="article-inner">
        
        <header class="article-header">
          <ul class="blog-info">
            <li class="blog-info-item"><a href="/articles/2023/" class="publish-date"><time datetime="2023-01-30T15:00:00.000Z" itemprop="datePublished">2023.01.31</time></a>
</li>
            <li class="blog-info-item"><li><a href="/authors/%E6%A3%9A%E4%BA%95%E9%BE%8D%E4%B9%8B%E4%BB%8B" title="棚井龍之介さんの記事一覧へ" class="post-author">棚井龍之介</a></li></li>
            <li class="blog-info-item">
  
    
    <a href="/tags/Go/" title="Goタグの記事へ" class="tag-list-link">Go言語</a>
  
    
    <a href="/tags/Go1-20/" title="Go1.20タグの記事へ" class="tag-list-link">Go1.20</a>
  

</li>
          </ul>
          </header>
        
        <div class="article-entry" itemprop="articleBody">
          
            <img src="/images/20230131a/top.png" alt="" width="800" height="481">

<h1 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h1><ul>
<li>はじめに</li>
<li>概要を確認</li>
<li>Proposal の内容と RFC の確認</li>
<li>実際に動かしながら、Go1.19 と Go1.20 の違いを確認</li>
<li>まとめ</li>
</ul>
<h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>こんにちは。<br>フューチャーアーキテクト株式会社、HR&#x2F;新卒採用チームの棚井です。</p>
<p>略歴として、フューチャーに新卒入社、Technology Innovation Group で IT コンサルタントを 3 年、Global Design Group で新規事業開発を 1 年と担当し、現在は Human Resources（つまり HR）でバックオフィスの新卒採用業務を担当しております。</p>
<p>本記事は<a href="/articles/20230123a/">Go 1.20 リリース連載</a> の 1 つです。<br>Go1.20 の <strong>New ReverseProxy Rewrite hook</strong> について解説していきます。</p>
<h1 id="概要を確認"><a href="#概要を確認" class="headerlink" title="概要を確認"></a>概要を確認</h1><p>New ReverseProxy Rewrite hook はコアライブラリー（httputil）への機能追加です。<br>Release Note では<a target="_blank" rel="noopener" href="https://tip.golang.org/doc/go1.20#reverseproxy_rewrite">こちら</a>、Proposal は<a target="_blank" rel="noopener" href="https://github.com/golang/go/issues/50580">こちら</a>から確認できます。</p>
<p>リリースノートを見ると、英文で以下のような記載があります。</p>
<blockquote>
<p><strong>New ReverseProxy Rewrite hook</strong><br>The httputil.ReverseProxy forwarding proxy includes a new Rewrite hook function, superseding the previous Director hook.</p>
<p>The Rewrite hook accepts a ProxyRequest parameter, which includes both the inbound request received by the proxy and the outbound request that it will send. Unlike Director hooks, which only operate on the outbound request, this permits Rewrite hooks to avoid certain scenarios where a malicious inbound request may cause headers added by the hook to be removed before forwarding. See issue <a target="_blank" rel="noopener" href="https://github.com/golang/go/issues/50580">#50580</a>.</p>
<p>The ProxyRequest.SetURL method routes the outbound request to a provided destination and supersedes the NewSingleHostReverseProxy function. Unlike NewSingleHostReverseProxy, SetURL also sets the Host header of the outbound request.</p>
<p>The ProxyRequest.SetXForwarded method sets the X-Forwarded-For, X-Forwarded-Host, and X-Forwarded-Proto headers of the outbound request. When using a Rewrite, these headers are not added by default.</p>
<p>An example of a Rewrite hook using these features is:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">proxyHandler := &amp;httputil.ReverseProxy&#123;</span><br><span class="line">   Rewrite: <span class="function"><span class="keyword">func</span><span class="params">(r *httputil.ProxyRequest)</span></span> &#123;</span><br><span class="line">    r.SetURL(outboundURL) <span class="comment">// Forward request to outboundURL.</span></span><br><span class="line">    r.SetXForwarded()     <span class="comment">// Set X-Forwarded-* headers.</span></span><br><span class="line">   r.Out.Header.Set(<span class="string">&quot;X-Additional-Header&quot;</span>, <span class="string">&quot;header set by the proxy&quot;</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ReverseProxy no longer adds a User-Agent header to forwarded requests when the incoming request does not have one.</p>
</blockquote>
<p>リリースノートでの説明について、<a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/release-branch.go1.20/src/net/http/httputil/reverseproxy.go">Go1.20 の実コード</a>と照らし合わせながら私なりに日本語訳しますと、</p>
<ul>
<li>httputil パッケージの ReverseProxy に、Rewrite hook を追加します。<ul>
<li>Rewrite が提供する機能は、Director に取って代わる（supersede する）ものです。</li>
<li>この機能より、プロキシサーバーにて付与した “hop-by-hop” ヘッダーが、意図せずに削除されてしまう問題（<a target="_blank" rel="noopener" href="https://github.com/golang/go/issues/50580">issue</a>）に対応できるようになります。</li>
</ul>
</li>
<li>Rewrite が受け取る構造体として ProxyRequest も追加します。<ul>
<li>ProxyRequest.SetURL が提供する機能は、NewSingleHostReverseProxy に取って代わるものです。</li>
<li>アウトバウンドリクエストのホストヘッダを設定します。</li>
</ul>
</li>
</ul>
<p>という感じでしょうか。</p>
<p>私自身が Go でリバースプロキシを立てた経験に疎く、1.19 から 1.20 への変更箇所がどのようなものなのか？をイメージできなかったので、テストコード側の利用例を見たところ、httptest.NewServer の引数に http.Handler として渡す中身が NewSingleHostReverseProxy（Director 型）から func(r *httputil.ProxyRequest) {…} （Rewrite 型）に変わっていました。</p>
<p>それぞれのコードについて、Go1.20は<a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/release-branch.go1.20/src/net/http/httputil/example_test.go#L96-L128">release-branch.go1.20</a>を、Go1.19は<a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/release-branch.go1.19/src/net/http/httputil/example_test.go#L96-L123">release-branch.go1.19</a>を参照しています。また、Go1.20とGo1.19のコード差分について、Go1.20 は「+」 1.19は「-」の diff で表現します。</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">package httputil</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	&quot;fmt&quot;</span><br><span class="line">	&quot;io&quot;</span><br><span class="line">	&quot;log&quot;</span><br><span class="line">	&quot;net/http&quot;</span><br><span class="line">	&quot;net/url&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func ExampleReverseProxy() &#123;</span><br><span class="line">	backendServer := httptest.NewServer(http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) &#123;</span><br><span class="line">		fmt.Fprintln(w, &quot;this call was relayed by the reverse proxy&quot;)</span><br><span class="line">	&#125;))</span><br><span class="line">	defer backendServer.Close()</span><br><span class="line"></span><br><span class="line">	rpURL, err := url.Parse(backendServer.URL)</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line"><span class="addition">+	frontendProxy := httptest.NewServer(&amp;httputil.ReverseProxy&#123;</span></span><br><span class="line"><span class="addition">+		Rewrite: func(r *httputil.ProxyRequest) &#123;</span></span><br><span class="line"><span class="addition">+			r.SetXForwarded()</span></span><br><span class="line"><span class="addition">+			r.SetURL(rpURL)</span></span><br><span class="line"><span class="addition">+		&#125;,</span></span><br><span class="line"><span class="addition">+	&#125;)</span></span><br><span class="line"><span class="deletion">-	frontendProxy := httptest.NewServer(httputil.NewSingleHostReverseProxy(rpURL))</span></span><br><span class="line">	defer frontendProxy.Close()</span><br><span class="line"></span><br><span class="line">	resp, err := http.Get(frontendProxy.URL)</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	b, err := io.ReadAll(resp.Body)</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fmt.Printf(&quot;%s&quot;, b)</span><br><span class="line"></span><br><span class="line">	// Output:</span><br><span class="line">	// this call was relayed by the reverse proxy</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>どちらのコードも実行してみると、プロキシ経由でのレスポンスが出力されます。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ go run main.go</span><br><span class="line">this call was relayed by the reverse proxy</span><br></pre></td></tr></table></figure>

<p>リリースノートでの説明が「取って代わる（supersede する）機能」になっていることに対応して、利用例のコードも当然 Go1.20 スタイルにアップデートされているようです。</p>
<p>概要の確認はここまでとして、この Rewrite hook について「それで、何が嬉しいの？」の疑問を解消するために、Proposal の内容と照らし合わせながら説明していきます。</p>
<h1 id="Proposal-の内容と-RFC-の確認"><a href="#Proposal-の内容と-RFC-の確認" class="headerlink" title="Proposal の内容と RFC の確認"></a>Proposal の内容と RFC の確認</h1><p>Proposal は <a target="_blank" rel="noopener" href="https://github.com/golang/go/issues/50580">net&#x2F;http&#x2F;httputil: ReverseProxy can remove headers added by Director #50580</a> です。</p>
<p>issue では 2 つの RFC（RFC 2616, section 13.5.11、RFC 7230, section 6.1）に言及されています。<br>RFC のリンクを貼ってもらえているので、ちょっとだけ内容を確認してみます。</p>
<p>まず、RFC 2616, section 13.5.1 End-to-end and Hop-by-hop Headers の内容を見ていくと、以下のような記述があります。<br><a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc2616#section-13.5.1">RFC 2616, section 13.5.1</a></p>
<blockquote>
<p>キャッシュプロキシと非キャッシュプロキシの動作を定義する目的のため、HTTP ヘッダーを「end-to-end」と「hop-by-hop」という 2 つのカテゴリに分類します。end-to-end はリクエストまたはレスポンスの最終的な受信者にまで送信されるヘッダーで、hop-by-hop はプロキシやキャッシュを通過しないヘッダーです。<br>RFC にて言及された hop-by-hop に該当するヘッダーは以下です。</p>
<ul>
<li>Connection</li>
<li>Keep-Alive</li>
<li>Proxy-Authenticate</li>
<li>Proxy-Authorization</li>
<li>TE</li>
<li>Trailers</li>
<li>Transfer-Encoding</li>
<li>Upgrade</li>
</ul>
<p>上記以外で HTTP&#x2F;1.1 にて定義されたヘッダーは end-to-end 側に含まれます。</p>
</blockquote>
<p>ちなみに、issue 内では</p>
<blockquote>
<p>RFC 2616, section 13.5.1 specified a list of hop-by-hop headers which HTTP proxies should not forward.<br>RFC 2616 セクション 13.5.1 は、プロキシサーバがフォワーディングすべきでない hop-by-hop ヘッダーのリストを定義している</p>
</blockquote>
<p>と説明されています。</p>
<p>次に、 RFC 7230, section 6.1 Connection については、issue にて<br><a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc7230#section-6.1">RFC 7230, section 6.1</a></p>
<blockquote>
<p>RFC 7230, section 6.1 replaces the hardcoded list of hop-by-hop headers with the ability for the originator of a request to specify the hop-by-hop headers in the “Connection” header.<br>RFC7230 セクション 6.1 では、リクエストの送信元が、ハードコードされた hop-by-hop ヘッダーのリストを、Connection ヘッダーで指定した hop-by-hop ヘッダーのリストに置き換えている。</p>
</blockquote>
<p>との説明があります。</p>
<p>ざっくりと要約すると、RFC 2616,section 13.5.1 にて hop-by-hop ヘッダーに該当する項目が定義されて、RFC 7230, section 6.1 にてクライアントと通信するサーバーとの hop-by-hop な情報については Connection ヘッダーを利用することになった、ということです。</p>
<p>このような RFC にて定義された「hop-by-hop ヘッダーを通過させない仕様」や「Connection ヘッダー情報のハンドリング仕様」への対応実装は、<a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/release-branch.go1.20/src/net/http/httputil/reverseproxy.go#L289-L543">この部分</a>で確認できます。</p>
<h1 id="実際に動かしながら、Go1-19-と-Go1-20-の違いを確認"><a href="#実際に動かしながら、Go1-19-と-Go1-20-の違いを確認" class="headerlink" title="実際に動かしながら、Go1.19 と Go1.20 の違いを確認"></a>実際に動かしながら、Go1.19 と Go1.20 の違いを確認</h1><p><a target="_blank" rel="noopener" href="https://wgithub.com/golang/go/blob/release-branch.go1.20/src/net/http/httputil/example_test.go">example_test.go</a>のコードを加工しながら、Go1.20 と Go1.19 での挙動の違いを見ていきます。</p>
<p>Go1.20 側のコードでは、新しく追加された <code>Rewrite</code> を呼び出しています。<br>Go1.19 には <code>Rewrite</code> がないため、代わりに <code>Director</code> を利用します。</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	&quot;fmt&quot;</span><br><span class="line">	&quot;io&quot;</span><br><span class="line">	&quot;log&quot;</span><br><span class="line">	&quot;net/http&quot;</span><br><span class="line">	&quot;net/http/httptest&quot;</span><br><span class="line">	&quot;net/http/httputil&quot;</span><br><span class="line">	&quot;net/url&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">	backendServer := httptest.NewServer(http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) &#123;</span><br><span class="line">		dump, err := httputil.DumpRequest(r, false)</span><br><span class="line">		if err != nil &#123;</span><br><span class="line">			fmt.Fprintln(w, err)</span><br><span class="line">		&#125;</span><br><span class="line">		fmt.Fprintln(w, string(dump))</span><br><span class="line">	&#125;))</span><br><span class="line">	defer backendServer.Close()</span><br><span class="line"></span><br><span class="line">	rpURL, err := url.Parse(backendServer.URL)</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line"><span class="addition">+	frontendProxy := httptest.NewServer(&amp;httputil.ReverseProxy&#123;</span></span><br><span class="line"><span class="addition">+		Rewrite: func(r *httputil.ProxyRequest) &#123;</span></span><br><span class="line"><span class="addition">+			r.SetURL(rpURL)</span></span><br><span class="line"><span class="addition">+		&#125;,</span></span><br><span class="line"><span class="addition">+	&#125;)</span></span><br><span class="line"><span class="deletion">-	frontendProxy := httptest.NewServer(&amp;httputil.ReverseProxy&#123;</span></span><br><span class="line"><span class="deletion">-		Director: func(r *http.Request) &#123;</span></span><br><span class="line"><span class="deletion">-			r.URL = rpURL</span></span><br><span class="line"><span class="deletion">-		&#125;,</span></span><br><span class="line"><span class="deletion">-	&#125;)</span></span><br><span class="line">	defer frontendProxy.Close()</span><br><span class="line"></span><br><span class="line">	resp, err := http.Get(frontendProxy.URL)</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	b, err := io.ReadAll(resp.Body)</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fmt.Printf(&quot;%s&quot;, b)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>この状態で動かしてみると、Go1.20 と Go1.19 では、それぞれ以下の出力が得られます。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ go run main.go</span><br><span class="line"></span><br><span class="line"><span class="comment"># Go1.20</span></span><br><span class="line">GET / HTTP/1.1</span><br><span class="line">Host: 127.0.0.1:39973</span><br><span class="line">Accept-Encoding: gzip</span><br><span class="line">User-Agent: Go-http-client/1.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># Go1.19</span></span><br><span class="line">GET / HTTP/1.1</span><br><span class="line">Host: 127.0.0.1:39259</span><br><span class="line">Accept-Encoding: gzip</span><br><span class="line">User-Agent: Go-http-client/1.1</span><br><span class="line">X-Forwarded-For: 127.0.0.1</span><br></pre></td></tr></table></figure>

<p>Go1.19 には <code>X-Forwarded-For</code> が自動追加されていますが、Go1.20 には追加されていないことがわかります。</p>
<p>リリースノートにて</p>
<blockquote>
<p>The ProxyRequest.SetXForwarded method sets the X-Forwarded-For, X-Forwarded-Host, and X-Forwarded-Proto headers of the outbound request. When using a Rewrite, these headers are not added by default.</p>
</blockquote>
<p>と記載があるとおり、<code>Rewrite</code> を使う場合には、ProxyRequest.SetXForwarded を呼び出すことで <code>X-Forwarded-For</code>, <code>X-Forwarded-Host</code>, <code>X-Forwarded-Proto</code> の 3 つのヘッダーが追加されるようです。Director では <code>X-Forwarded-For</code> だけだったため、残りの 2 つも同時に追加したいという提案は<a target="_blank" rel="noopener" href="https://github.com/golang/go/issues/50465">こちらの issue</a>で会話されています。</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">func main() &#123;</span><br><span class="line">	...</span><br><span class="line">	frontendProxy := httptest.NewServer(&amp;httputil.ReverseProxy&#123;</span><br><span class="line">		Rewrite: func(r *httputil.ProxyRequest) &#123;</span><br><span class="line">			r.SetURL(rpURL)</span><br><span class="line"><span class="addition">+			r.SetXForwarded()</span></span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;)</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上記のように、ProxyRequest.SetXForwarded を追加して再度実行すると、バックエンドに到達するリクエスト内のヘッダーが 3 つ増えていることがわかります。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ go run main.go</span><br><span class="line"></span><br><span class="line"><span class="comment"># Go1.20</span></span><br><span class="line">GET / HTTP/1.1</span><br><span class="line">Host: 127.0.0.1:46465</span><br><span class="line">Accept-Encoding: gzip</span><br><span class="line">User-Agent: Go-http-client/1.1</span><br><span class="line">X-Forwarded-For: 127.0.0.1</span><br><span class="line">X-Forwarded-Host: 127.0.0.1:44977</span><br><span class="line">X-Forwarded-Proto: http</span><br></pre></td></tr></table></figure>

<p>RFC2616 では「hop-by-hop ヘッダーの削除」が定義されているので、次はこの動作確認として以下のコードを動かしてみます。<br>処理内部で新たにリクエストを作成して、ヘッダーに「Connection: Keep-Alive」を追加しています。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;io&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http/httptest&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http/httputil&quot;</span></span><br><span class="line">	<span class="string">&quot;net/url&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	backendServer := httptest.NewServer(http.HandlerFunc(<span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">		dump, err := httputil.DumpRequest(r, <span class="literal">false</span>)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Fprintln(w, err)</span><br><span class="line">		&#125;</span><br><span class="line">		fmt.Fprintln(w, <span class="type">string</span>(dump))</span><br><span class="line">	&#125;))</span><br><span class="line">	<span class="keyword">defer</span> backendServer.Close()</span><br><span class="line"></span><br><span class="line">	rpURL, err := url.Parse(backendServer.URL)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	frontendProxy := httptest.NewServer(&amp;httputil.ReverseProxy&#123;</span><br><span class="line">		Rewrite: <span class="function"><span class="keyword">func</span><span class="params">(r *httputil.ProxyRequest)</span></span> &#123;</span><br><span class="line">			r.SetURL(rpURL)</span><br><span class="line">			r.SetXForwarded()</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">defer</span> frontendProxy.Close()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// create request</span></span><br><span class="line">	req, err := http.NewRequest(http.MethodGet, frontendProxy.URL, <span class="literal">nil</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// add connection header</span></span><br><span class="line">	req.Header.Set(<span class="string">&quot;Connection&quot;</span>, <span class="string">&quot;keep-alive&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// check request content</span></span><br><span class="line">	dump, err := httputil.DumpRequest(req, <span class="literal">false</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(<span class="type">string</span>(dump))</span><br><span class="line"></span><br><span class="line">	resp, err := <span class="built_in">new</span>(http.Client).Do(req)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	b, err := io.ReadAll(resp.Body)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">&quot;%s&quot;</span>, b)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>こちらも、Go1.20 と Go1.19 のそれぞれで動かしてみると、どちらのバージョンにおいても、リクエスト生成直後に付与したヘッダー「Connection: Keep-Alive」が、プロキシサーバーを経由したのちに RFC の定義通りに削除されていることがわかります。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ go run main.go</span><br><span class="line"></span><br><span class="line"><span class="comment"># Go1.20</span></span><br><span class="line">GET / HTTP/1.1</span><br><span class="line">Host: 127.0.0.1:45977</span><br><span class="line">Connection: Keep-Alive</span><br><span class="line"></span><br><span class="line">GET / HTTP/1.1</span><br><span class="line">Host: 127.0.0.1:32815</span><br><span class="line">Accept-Encoding: gzip</span><br><span class="line">User-Agent: Go-http-client/1.1</span><br><span class="line">X-Forwarded-For: 127.0.0.1</span><br><span class="line">X-Forwarded-Host: 127.0.0.1:44977</span><br><span class="line">X-Forwarded-Proto: http</span><br><span class="line"></span><br><span class="line"><span class="comment"># Go1.19</span></span><br><span class="line">GET / HTTP/1.1</span><br><span class="line">Host: 127.0.0.1:43403</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">GET / HTTP/1.1</span><br><span class="line">Host: 127.0.0.1:43403</span><br><span class="line">Accept-Encoding: gzip</span><br><span class="line">User-Agent: Go-http-client/1.1</span><br><span class="line">X-Forwarded-For: 127.0.0.1</span><br></pre></td></tr></table></figure>

<p>こまで来てやっと、Proposal タイトルの「ReverseProxy can remove headers added by Director」について説明できます。<br>Proposal で提起された問題箇所を引用すると</p>
<blockquote>
<p>For example, if an inbound request contains a Connection: forwarded header, then any Forwarded header added by the Director will not be sent to the backend. This is probably surprising; under some circumstances, it may be a security vulnerability.<br>例えば、もしインバウンドリクエストが「Connection: forwarded」のヘッダーを保持している場合、Director により追加された Forwarded ヘッダーは、バックエンド側に送信されません。これはおそらく驚くべきことであり、ある状況下においてはセキュリティ上の脆弱性かもしれません。</p>
</blockquote>
<p>とあります。<br>この現象を再現するために、以下のコードを Go1.19 環境にて動かしてみます。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;io&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http/httptest&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http/httputil&quot;</span></span><br><span class="line">	<span class="string">&quot;net/url&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	backendServer := httptest.NewServer(http.HandlerFunc(<span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">		dump, err := httputil.DumpRequest(r, <span class="literal">false</span>)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Fprintln(w, err)</span><br><span class="line">		&#125;</span><br><span class="line">		fmt.Fprintln(w, <span class="type">string</span>(dump))</span><br><span class="line">	&#125;))</span><br><span class="line">	<span class="keyword">defer</span> backendServer.Close()</span><br><span class="line"></span><br><span class="line">	rpURL, err := url.Parse(backendServer.URL)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	frontendProxy := httptest.NewServer(&amp;httputil.ReverseProxy&#123;</span><br><span class="line">		Director: <span class="function"><span class="keyword">func</span><span class="params">(r *http.Request)</span></span> &#123;</span><br><span class="line">			r.URL = rpURL</span><br><span class="line">			r.Header.Set(<span class="string">&quot;X-Forwarded-Proto&quot;</span>, <span class="string">&quot;http&quot;</span>)</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">defer</span> frontendProxy.Close()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// define request</span></span><br><span class="line">	req, err := http.NewRequest(http.MethodGet, frontendProxy.URL, <span class="literal">nil</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// add connection:forwarded header</span></span><br><span class="line">	req.Header.Set(<span class="string">&quot;Connection&quot;</span>, <span class="string">&quot;X-Forwarded-Proto&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// check request content</span></span><br><span class="line">	dump, err := httputil.DumpRequest(req, <span class="literal">false</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(<span class="type">string</span>(dump))</span><br><span class="line"></span><br><span class="line">	resp, err := <span class="built_in">new</span>(http.Client).Do(req)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	b, err := io.ReadAll(resp.Body)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">&quot;%s&quot;</span>, b)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>インバウンドリクエストのヘッダーに「Connection: X-Forwarded-Proto」を付与して、Director にて「X-Forwarded-Proto: http」を追加しています。<br>この状態で実行すると、以下の出力が得られます。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ go run main.go</span><br><span class="line"><span class="comment"># Go1.19</span></span><br><span class="line"></span><br><span class="line">GET / HTTP/1.1</span><br><span class="line">Host: 127.0.0.1:46127</span><br><span class="line">Connection: X-Forwarded-Proto</span><br><span class="line"></span><br><span class="line">GET / HTTP/1.1</span><br><span class="line">Host: 127.0.0.1:46127</span><br><span class="line">Accept-Encoding: gzip</span><br><span class="line">User-Agent: Go-http-client/1.1</span><br><span class="line">X-Forwarded-For: 127.0.0.1</span><br></pre></td></tr></table></figure>

<p>出力内容から、Director で追加した「X-Forwarded-Proto: http」がバックエンドまで到達していないことがわかります。</p>
<p>Go1.20 で追加された Rewrite hook はこの問題に対応するもので、先に見ましたように <a target="_blank" rel="noopener" href="https://pkg.go.dev/net/http/httputil@master#ProxyRequest.SetXForwarded">ProxyRequest.SetXForwarded</a> を利用して 3 つの Forwarded ヘッダー（The X-Forwarded-For、X-Forwarded-Host、X-Forwarded-Proto）を追加することで「Director で追加した X-Forwarded- ヘッダーが削除されてしまう現象」対応しています。</p>
<h1 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h1><ul>
<li>プロキシサーバーのリクエストルーティングで、これまで Director を使っていたところは、これからは Rewrite を使おう</li>
<li>Rwrite に渡す ProxyRequest にて SetXForwarded を呼ぶことで、プロキシサーバーの情報 X-Forwarded-For,Host,Proto を自動追加してくれて便利</li>
</ul>
<p>次は今泉さんの<a href="/articles/20230202a/">vetのアップデート</a>です。</p>

          
        </div>
        <footer>
          <section class="social-area">
          <!-- シェアボタン START -->
  <ul class="social-button">
    
    <!-- Twitter -->
    <li>
      <a class="social-btn twitter-btn" target="_blank" href="https://twitter.com/share?url=https://future-architect.github.io/articles/20230131a/&related=twitterapi%2Ctwitter&text=New%20ReverseProxy%20Rewrite%20hook%20%E3%82%92%E5%8B%95%E3%81%8B%E3%81%97%E3%81%AA%E3%81%8C%E3%82%89%E7%90%86%E8%A7%A3%E3%81%99%E3%82%8B%20%7C%20%E3%83%95%E3%83%A5%E3%83%BC%E3%83%81%E3%83%A3%E3%83%BC%E6%8A%80%E8%A1%93%E3%83%96%E3%83%AD%E3%82%B0" rel="nofollow noopener">
        <i></i><span class="social-btn-label">12</span>
      </a>
    </li>
    <!-- Facebook -->
    <li>
      <a class="social-btn fb-btn" target="_blank" href="http://www.facebook.com/share.php?u=https://future-architect.github.io/articles/20230131a/&t=New%20ReverseProxy%20Rewrite%20hook%20%E3%82%92%E5%8B%95%E3%81%8B%E3%81%97%E3%81%AA%E3%81%8C%E3%82%89%E7%90%86%E8%A7%A3%E3%81%99%E3%82%8B" rel="nofollow noopener">
        <i></i><span class="social-btn-label">シェア</span>
      </a>
    </li>
    <!-- hatebu -->
    <li>
      <a class="social-btn hatebu-btn" target="_blank" href="https://b.hatena.ne.jp/entry/s/future-architect.github.io/articles/20230131a/" rel="nofollow noopener">
        <i></i><span class="social-btn-label">はてな</span>
      </a>
    </li>
    <!-- pocket -->
    <li>
      <a class="social-btn pocket-btn" target="_blank" href="https://getpocket.com/save?url=https://future-architect.github.io/articles/20230131a/" rel="nofollow noopener">
        <i></i><span class="social-btn-label">3</span>
      </a>
    </li>
    
  </ul>
<!-- シェアボタン END -->

          </section>
          <aside>
            <section class="related-post margin-bottom-40 nav">
              <h2 id="related"><a href="#related" class="headerlink" title="関連記事"></a>関連記事</h2>
              
  <div class="widget">
    <ul class="nav related-post-link"><li class="related-posts-item"><span>2020.03.11</span><span class="snscount">&#9825;566</span><a href=/articles/20200311/ title="Java to Go in-depth tutorialの日本語訳です。原文の著者に許諾を得て翻訳・公開いたします。このチュートリアルは、JavaプログラマーがすばやくGo言語にキャッチアップできるようにすることを目的としています。">JavaプログラマーのためのGo言語入門</a></li><li class="related-posts-item"><span>2023.02.03</span><span class="snscount">&#9825;36</span><a href=/articles/20230203a/ title="Go 1.20 連載 7 記事目にして、最終回の本記事では、`go build`コマンドに新たに追加される`-cover`オプションについてお伝えします。せっかくなので実際に使ってみたレポートもお届けしようと思います。">Go 1.20 リリース連載 go build に追加される cover オプション（利用例付き）</a></li><li class="related-posts-item"><span>2023.02.02</span><span class="snscount">&#9825;14</span><a href=/articles/20230202a/ title="Go 1.20連載の6本目です。Goの標準ライブラリに組み込まれている、コンパイラによってキャッチされないエラーや懸念を検出し報告してくれるコードの静的解析ツールです。機能の詳細は本記事では割愛しますが、以下コマンドで利用可能なチェックの一覧を確認することができます。">Go 1.20 vetのアップデート</a></li><li class="related-posts-item"><span>2023.01.28</span><span class="snscount">&#9825;96</span><a href=/articles/20230128a/ title="Go 1.20リリース連載の5本目はHTTP ResponseControllerのアップデートを紹介しますnet/httpパッケージに新しく esponseController型が追加されます">Go 1.20 HTTP ResponseController</a></li><li class="related-posts-item"><span>2023.01.27</span><span class="snscount">&#9825;66</span><a href=/articles/20230127a/ title="Go 1.20連載の4本目です。Minor changes to the libraryの`time`パッケージのアップデート4点について解説します。"">Go 1.20 timeパッケージのアップデート</a></li><li class="related-posts-item"><span>2023.01.26</span><span class="snscount">&#9825;37</span><a href=/articles/20230126a/ title="Go 1.20リリース連載の3本目です。Wrapping multiple errors についてお話します。エラーのラップが拡張されて、複数のエラーをラップしたマルチエラーを作成できるようになりました。">Go 1.20 Wrapping multiple errors</a></li></ul>
  </div>
            </section>
            <section class="reference-post margin-bottom-40 nav">
              
  <div class="card">
    <div id="reference" class="reference-lede"><a href="#reference" class="headerlink" title="参照されている記事"></a>この記事を参照している記事</div>
    <ul class="reference-post-link"><li class="reference-posts-item"><a href=/articles/20230128a/ title="Go 1.20リリース連載の5本目はHTTP ResponseControllerのアップデートを紹介しますnet/httpパッケージに新しく esponseController型が追加されます">Go 1.20 HTTP ResponseController</a></li><li class="reference-posts-item"><a href=/articles/20230123a/ title="フューチャーのテックブログ恒例のGoの新バージョンリリース記念のブログが始まります。この執筆時点でrc3が出ています。かつてこんな順調なことがあったでしょうか？">Go 1.20リリース連載が始まります＆メモリアリーナの紹介＆落ち穂拾い</a></li></ul>
  </div>
            </section>
          </aside>
        </footer>
      </div>
    </article>
  </main>
  <aside class="col-md-3 blog-sidebar">
    <!-- START SIDEBAR  -->


<section class="toc-section">
  <h2 class="margin-top-30">目次</h2>
  <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%9B%AE%E6%AC%A1"><span class="toc-text">目次</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><span class="toc-text">はじめに</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A6%82%E8%A6%81%E3%82%92%E7%A2%BA%E8%AA%8D"><span class="toc-text">概要を確認</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Proposal-%E3%81%AE%E5%86%85%E5%AE%B9%E3%81%A8-RFC-%E3%81%AE%E7%A2%BA%E8%AA%8D"><span class="toc-text">Proposal の内容と RFC の確認</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9F%E9%9A%9B%E3%81%AB%E5%8B%95%E3%81%8B%E3%81%97%E3%81%AA%E3%81%8C%E3%82%89%E3%80%81Go1-19-%E3%81%A8-Go1-20-%E3%81%AE%E9%81%95%E3%81%84%E3%82%92%E7%A2%BA%E8%AA%8D"><span class="toc-text">実際に動かしながら、Go1.19 と Go1.20 の違いを確認</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E3%81%BE%E3%81%A8%E3%82%81"><span class="toc-text">まとめ</span></a></li></ol>
</section>

<section class="category">
<h2 class="margin-top-30">カテゴリー</h2>
<div class="widget">
  <ul class="nav sidebar-categories margin-bottom-40">
  
  <li class=""><a href="/categories/Programming/">Programming (417)</a></li>
<li class=""><a href="/categories/Infrastructure/">Infrastructure (250)</a></li>
<li class=""><a href="/categories/Culture/">Culture (97)</a></li>
<li class=""><a href="/categories/DataScience/">DataScience (60)</a></li>
<li class=""><a href="/categories/IoT/">IoT (34)</a></li>
<li class=""><a href="/categories/DB/">DB (25)</a></li>
<li class=""><a href="/categories/DevOps/">DevOps (23)</a></li>
<li class=""><a href="/categories/Business/">Business (21)</a></li>
<li class=""><a href="/categories/%E8%AA%8D%E8%A8%BC%E8%AA%8D%E5%8F%AF/">認証認可 (20)</a></li>
<li class=""><a href="/categories/Management/">Management (17)</a></li>
<li class=""><a href="/categories/Security/">Security (15)</a></li>
<li class=""><a href="/categories/VR/">VR (13)</a></li>
<li class=""><a href="/categories/Design/">Design (11)</a></li>

  </ul>
</div>

</section>
<section class="podcast-link">
<h2 class="margin-top-30">Tech Cast</h2>

  <div class="class="widget-wrap">
  <div class="widget">
    <ul class="nav techcast">
      <li><a href="https://podcasters.spotify.com/pod/show/futuretechcast/episodes/38-AIAI-e22h1v0" title="フューチャーがお届けするポッドキャストです。#38 AIグループリーダー加藤さんに聞く「AIチームのミッションと展望」" target="_blank" rel="noopener"> #38 AIグループリーダー加藤さんに聞く「AIチームのミッションと展望」</a></li>
<li><a href="https://podcasters.spotify.com/pod/show/futuretechcast/episodes/37-e227p84" title="フューチャーがお届けするポッドキャストです。#37 自然言語処理を使った文書検索エンジンシステム開発と新規サービス検討（後編）" target="_blank" rel="noopener"> #37 自然言語処理を使った文書検索エンジンシステム開発と新規サービス検討（後編）</a></li>
<li><a href="https://podcasters.spotify.com/pod/show/futuretechcast/episodes/36-e1rdbcu" title="フューチャーがお届けするポッドキャストです。#36 自然言語処理を使った文書検索エンジンシステム開発と新規サービス検討（前編）" target="_blank" rel="noopener"> #36 自然言語処理を使った文書検索エンジンシステム開発と新規サービス検討（前編）</a></li>
    </ul>
  </div>
  </div>
  
</section>
<section class="advent-calendar">
<h2 class="margin-top-30">アドベントカレンダー</h2>
<div class="widget">
  <ul class="nav-flex">
    <li><a href="http://qiita.com/advent-calendar/2023/future" title="フューチャー Advent Calendar 2023 #Qiita" target="_blank" rel="noopener">2023年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2022/future" title="フューチャー Advent Calendar 2022 #Qiita" target="_blank" rel="noopener">2022年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2021/future" title="フューチャー Advent Calendar 2021 #Qiita" target="_blank" rel="noopener">2021年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2020/future" title="フューチャー Advent Calendar 2020 #Qiita" target="_blank" rel="noopener">2020年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2019/future" title="フューチャー Advent Calendar 2019 #Qiita" target="_blank" rel="noopener">2019年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2018/future" title="フューチャー Advent Calendar 2018 #Qiita" target="_blank" rel="noopener">2018年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2017/future" title="フューチャー Advent Calendar 2017 #Qiita" target="_blank" rel="noopener">2017年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2016/future" title="フューチャー Advent Calendar 2016 #Qiita" target="_blank" rel="noopener">2016年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2015/future" title="フューチャー Advent Calendar 2015 #Qiita" target="_blank" rel="noopener">2015年</a></li>
  </ul>
</div>

</section>
<!-- END SIDEBAR -->

  </aside>
</div>

  </section>
</div>

      <!-- BEGIN PRE-FOOTER -->
    <footer>
      <div class="pre-footer">
        <div class="container">
          <div class="row">
            <div class="col-lg-4 col-md-4 col-sm-6 col-6 pre-footer-col">
              <h2>About Us</h2>
              <p>経営とITをデザインする、フューチャーの技術ブログです。業務で利用している幅広い技術について紹介します。<br /><br /><a target="_blank" rel="noopener" href="http://www.future.co.jp/">http://www.future.co.jp/</a></p>
              <div class="social-btn twitter-btn twitter-follow-btn">
                <a href="https://twitter.com/intent/follow?screen_name=future_techblog " target="_blank" rel="nofollow noopener">
                  <i></i><span class="tw-btn-label">フューチャー技術ブログをフォロー</span>
                </a>
              </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-4 col-4 pre-footer-col">
              <h2>Contact</h2>
              <address class="margin-bottom-40">
                <a href="https://www.future.co.jp/recruit/recruit/rec-fresh/" title="新卒採用" target="_blank" rel="noopener">新卒採用</a><br>
                <a href="https://www.future.co.jp/recruit/recruit/rec-career/" title="キャリア採用" target="_blank" rel="noopener">キャリア採用</a><br>
                <a href="https://www.future.co.jp/contact_us/" title="お問い合わせページ" target="_blank" rel="noopener">お問い合わせ</a><br>
                <a href="https://www.future.co.jp/architect/socialmediapolicy/" title="ソーシャルメディアポリシー" target="_blank" rel="noopener">メディアポリシー</a><br><br>
                <a href="mailto:techblog@future.co.jp">techblog@future.co.jp</a>
              </address>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 col-6 pre-footer-col">
              <h2>Contents</h2>
              <a href="https://future-architect.github.io/coding-standards/" title="Future Enterprise Coding Standards" target="_blank" rel="noopener">コーディング規約</a><br>
              <a href="https://future-architect.github.io/typescript-guide/" title="仕事ですぐに使えるTypeScript" target="_blank" rel="noopener">仕事ですぐに使えるTypeScript</a><br>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-3 col-3 pre-footer-col">
              <h2>Event</h2>
              <a href="https://future.connpass.com/" title="経営とITをデザインするフューチャーの勉強会です" target="_blank" rel="noopener">connpass</a><br>
              <a href="https://www.future.co.jp/futureinsightseminar/" title="フューチャーインサイトセミナー" target="_blank" rel="noopener">Webセミナー</a><br>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-3 col-3 pre-footer-col">
              <h2>SNS</h2>
              <a href="https://github.com/future-architect" title="Future's official open source repositories" target="_blank" rel="noopener">GitHub</a><br>
              <a href="https://qiita.com/organizations/future" title="フューチャーのQiita Organizationです" target="_blank" rel="noopener">Qiita</a><br>
              <a href="https://note.future.co.jp/" title="フューチャーの公式note" target="_blank" rel="noopener">未来報</a><br>
              <a href="https://www.youtube.com/channel/UCJUSwYYd0CkGgmEKAW7QVpw" title="フューチャーYoutubeチャネル" target="_blank" rel="noopener">Youtube</a>
            </div>
          </div>
        </div>
      </div>
      <div class="footer">
        <div class="container">
          <div class="row">
            <div class="col-md-6 col-sm-6 padding-top-10">
              &copy; 2023 フューチャー技術ブログ<br>
            </div>
          </div>
        </div>
      </div>
    </footer>

  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-X1C28R8H0M"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-X1C28R8H0M');
  gtag('config', 'UA-74047147-1'); // 過渡期対応
</script>

  </div>
</body>
</html>
