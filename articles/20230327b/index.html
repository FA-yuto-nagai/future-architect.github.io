<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <!--
    ███████╗██╗░░░██╗████████╗██╗░░░██╗██████╗░███████╗
    ██╔════╝██║░░░██║╚══██╔══╝██║░░░██║██╔══██╗██╔════╝
    █████╗░░██║░░░██║░░░██║░░░██║░░░██║██████╔╝█████╗░░
    ██╔══╝░░██║░░░██║░░░██║░░░██║░░░██║██╔══██╗██╔══╝░░
    ██║░░░░░╚██████╔╝░░░██║░░░╚██████╔╝██║░░██║███████╗
    ╚═╝░░░░░░╚═════╝░░░░╚═╝░░░░╚═════╝░╚═╝░░╚═╝╚══════╝
    ████████╗███████╗░█████╗░██╗░░██╗
    ╚══██╔══╝██╔════╝██╔══██╗██║░░██║
    ░░░██║░░░█████╗░░██║░░╚═╝███████║
    ░░░██║░░░██╔══╝░░██║░░██╗██╔══██║
    ░░░██║░░░███████╗╚█████╔╝██║░░██║
    ░░░╚═╝░░░╚══════╝░╚════╝░╚═╝░░╚═╝
    ██████╗░██╗░░░░░░█████╗░░██████╗░
    ██╔══██╗██║░░░░░██╔══██╗██╔════╝░
    ██████╦╝██║░░░░░██║░░██║██║░░██╗░
    ██╔══██╗██║░░░░░██║░░██║██║░░╚██╗
    ██████╦╝███████╗╚█████╔╝╚██████╔╝
    ╚═════╝░╚══════╝░╚════╝░░╚═════╝░
    Welcome engineer.
    https://www.future.co.jp/recruit/
  -->
  
  <title>Terraform 1.4 Update:Private Service Connectを利用したbackend/gcsへのアクセス | フューチャー技術ブログ</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  
  <meta name="description" content="初めにこんにちは！筋肉エンジニアのTIG渡邉です。Terraform連載2023 の1リソース目の記事です。 Terraform 1.4.0のENHANCEMENTSで以下の機能が追加されました。  backend&#x2F;gcs: Add storage_custom_endpoint argument, to allow communication with the backend via">
<meta property="og:type" content="article">
<meta property="og:title" content="Terraform 1.4 Update:Private Service Connectを利用したbackend&#x2F;gcsへのアクセス | フューチャー技術ブログ">
<meta property="og:url" content="https://future-architect.github.io/articles/20230327b/index.html">
<meta property="og:site_name" content="フューチャー技術ブログ">
<meta property="og:description" content="初めにこんにちは！筋肉エンジニアのTIG渡邉です。Terraform連載2023 の1リソース目の記事です。 Terraform 1.4.0のENHANCEMENTSで以下の機能が追加されました。  backend&#x2F;gcs: Add storage_custom_endpoint argument, to allow communication with the backend via">
<meta property="og:locale" content="ja_JP">
<meta property="og:image" content="https://future-architect.github.io/images/20230327b/architecture01.drawio.png">
<meta property="og:image" content="https://future-architect.github.io/images/20230327b/architecture02.drawio.png">
<meta property="og:image" content="https://future-architect.github.io/images/20230327b/image.png">
<meta property="og:image" content="https://future-architect.github.io/images/20230327b/image_2.png">
<meta property="og:image" content="https://future-architect.github.io/images/20230327b/image_3.png">
<meta property="og:image" content="https://future-architect.github.io/images/20230327b/image_4.png">
<meta property="og:image" content="https://future-architect.github.io/images/20230327b/image_5.png">
<meta property="article:published_time" content="2023-03-26T15:00:01.000Z">
<meta property="article:modified_time" content="2023-03-27T03:05:45.260Z">
<meta property="article:tag" content="GCP">
<meta property="article:tag" content="Terraform">
<meta property="article:tag" content="Terraform1.4">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://future-architect.github.io/images/20230327b/architecture01.drawio.png">
  
  <link rel="alternate" href="/atom.xml" title="フューチャー技術ブログ" type="application/atom+xml">
  
  <link rel="icon" href="/favicon.ico">
  <link rel="apple-touch-icon" sizes='180x180' href="/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes='57x57' href="/apple-touch-icon-57x57.png">
  <link rel="canonical" href="https://future-architect.github.io/articles/20230327b/">
  <meta content="GCP,Terraform,Terraform1.4" name="keywords">
  <meta content="渡邉光" name="author">
  <link rel="preload" as="image" href="/banner.jpg" />
  <link rel='manifest' href='/manifest.webmanifest'/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">
  <link rel="stylesheet" href="/metronic/assets/style.css">
  <link rel="stylesheet" href="/css/theme-styles.css">
<meta name="generator" content="Hexo 5.4.2"></head>

<body class="corporate">
  <div class="wrap" itemscope itemtype="https://schema.org/TechArticle">
  <!-- BEGIN HEADER -->
<header class="header">
	<div class="header-overlay">
		<div class="header-menu"></div>
		<div class="header-title"><a href="/">Future Tech Blog</a></div>
		<div class="header-title-sub">フューチャー技術ブログ</div>
	</div>
</header>
<!-- Header END -->

  <div class="container">
  <ul class="breadcrumb">
    <li><a href="/">Home</a></li>
    <li><a href="/articles/">Blog</a></li>
    <li class="active">Post</li>
  </ul>
  <section id="main" class="margin-top-30">
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Infrastructure/">Infrastructureカテゴリ</a>
  </div>


    <h2 itemprop="name" class="article-title">Terraform 1.4 Update:Private Service Connectを利用したbackend/gcsへのアクセス
  
  <a target="_blank" rel="noopener" href="https://github.com/future-architect/tech-blog/edit/master/source/_posts/20230327b_terraform_1.4_Update：Private_Service_Connectを利用したbackend／gcsへのアクセス.md" title="Suggest Edits" class="github-edit"><i class="github-edit-icon"></i></a>
  
</h2>

    <div class="row">
  <main class="col-md-9 blog-posts">
    <article id="post-20230327b_terraform_1.4_Update：Private_Service_Connectを利用したbackend／gcsへのアクセス" class="article article-type-post blog-item" itemscope itemprop="blogPost">
      <div class="article-inner">
        
        <header class="article-header">
          <ul class="blog-info">
            <li class="blog-info-item"><a href="/articles/2023/" class="publish-date"><time datetime="2023-03-26T15:00:01.000Z" itemprop="datePublished">2023.03.27</time></a>
</li>
            <li class="blog-info-item"><li><a href="/authors/%E6%B8%A1%E9%82%89%E5%85%89" title="渡邉光さんの記事一覧へ" class="post-author">渡邉光</a></li></li>
            <li class="blog-info-item">
  
    
    <a href="/tags/GCP/" title="GCPタグの記事へ" class="tag-list-link">GCP</a>
  
    
    <a href="/tags/Terraform/" title="Terraformタグの記事へ" class="tag-list-link">Terraform</a>
  
    
    <a href="/tags/Terraform1-4/" title="Terraform1.4タグの記事へ" class="tag-list-link">Terraform1.4</a>
  

</li>
          </ul>
          </header>
        
        <div class="article-entry" itemprop="articleBody">
          
            <h1 id="初めに"><a href="#初めに" class="headerlink" title="初めに"></a>初めに</h1><p>こんにちは！筋肉エンジニアのTIG渡邉です。<a href="/articles/20230327a/">Terraform連載2023</a> の1リソース目の記事です。</p>
<p>Terraform 1.4.0の<code>ENHANCEMENTS</code>で以下の機能が追加されました。</p>
<blockquote>
<p>backend&#x2F;gcs: Add storage_custom_endpoint argument, to allow communication with the backend via a Private Service Connect endpoint.</p>
</blockquote>
<p>内容はtfstateが保存されているGCSへのアクセスがインターネット経由ではなく、Private Service Connectエンドポイントを利用したプライベートネットワーク経由でbackendに指定したGCSへアクセスすることができる機能です。今回はこの機能を検証します。</p>
<p>以下のリソースは構築済みとします。</p>
<ul>
<li>Google Cloud Project</li>
<li>Network系リソース（VPC&#x2F;Subnet&#x2F;Cloud Nat&#x2F;Cloud Router&#x2F;Firewall）</li>
<li>GCE</li>
<li>GCS</li>
</ul>
<h1 id="Private-Service-Connectを利用しない構成"><a href="#Private-Service-Connectを利用しない構成" class="headerlink" title="Private Service Connectを利用しない構成"></a>Private Service Connectを利用しない構成</h1><p>Private Service Connectを利用しない構成はこちらです。</p>
<p>GCEにTerraformをインストールし、Terraform Serverとしています。Terraform Serverでterraform initを実行するとVPCに構築済みのCloud Nat&#x2F;インターネット経由でGCSへアクセスされます。</p>
<p>この構成は皆さんお使いのいつもの構成だと思います。</p>
<img src="/images/20230327b/architecture01.drawio.png" alt="" width="772" height="591" loading="lazy">


<h1 id="Private-Service-Connectを利用した構成"><a href="#Private-Service-Connectを利用した構成" class="headerlink" title="Private Service Connectを利用した構成"></a>Private Service Connectを利用した構成</h1><p>Private Service Connectを利用した構成はこちらになります。</p>
<p>こちらもGCEにTerraformをインストールし、Terraform Serverとしています。Terraform Serverでterraform initを実行するとVPCに構築済みのCloud Nat&#x2F;インターネットを経由するのではなく、Private Service Connect Endpoint(10.0.3.0)を経由してGCSへアクセスされます。</p>
<p>今回はこの構成を検証します。</p>
<img src="/images/20230327b/architecture02.drawio.png" alt="architecture02.drawio.png" width="772" height="591" loading="lazy">


<h2 id="Private-Service-Connectとは"><a href="#Private-Service-Connectとは" class="headerlink" title="Private Service Connectとは"></a>Private Service Connectとは</h2><p>Private Service Connectとは一言でいうと、Google Cloud API にプライベートネットワーク経由でアクセスするための機能になります。</p>
<p>詳しくはG-genの杉村さんの技術ブログがすごくわかりやすくまとまっているのでこちらを参照ください。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.g-gen.co.jp/entry/google-api-private-service-connect-explained">https://blog.g-gen.co.jp/entry/google-api-private-service-connect-explained</a></li>
</ul>
<h2 id="Private-Service-Connectの作成"><a href="#Private-Service-Connectの作成" class="headerlink" title="Private Service Connectの作成"></a>Private Service Connectの作成</h2><p>以下公式ドキュメントを参考にPrivate Service Connectを作成します。</p>
<p><a target="_blank" rel="noopener" href="https://cloud.google.com/vpc/docs/configure-private-service-connect-apis?hl=ja#console_1">https://cloud.google.com/vpc/docs/configure-private-service-connect-apis?hl=ja#console_1</a></p>
<p>ネットワークサービス→Private Service Connectをクリックします。<br>Private Service Connectから「エンドポイントを接続」をクリックします。</p>
<img src="/images/20230327b/image.png" alt="" width="1200" height="856" loading="lazy">

<ul>
<li>対象：すべてのGoogle API</li>
<li>エンドポイント名：sampleendpoint</li>
<li>ネットワーク：my-stg-environment01-vpc</li>
<li>sample-endpoint-ip (10.0.3.0)</li>
<li>リージョン：asia-northeast1</li>
<li>名前空間：自動割り当て済みのものを設定</li>
</ul>
<p>を設定し、「エンドポイントを追加」をクリックします。</p>
<img src="/images/20230327b/image_2.png" alt="" width="1200" height="847" loading="lazy">

<p>するとPrivate Service Connectの接続エンドポイントが作成されます。</p>
<img src="/images/20230327b/image_3.png" alt="" width="1200" height="855" loading="lazy">

<p>Service Directoryも作成されています。</p>
<img src="/images/20230327b/image_4.png" alt="" width="1200" height="851" loading="lazy">



<p>限定公開DNSゾーンも作成されています。<br><img src="/images/20230327b/image_5.png" alt="" width="1200" height="852" loading="lazy"></p>
<p>ここまででPrivate Service Connectの設定は完了です。</p>
<p>Private Service Connectエンドポイントが正しく機能しているかを確認するために、GCEへSSHしてcurlコマンドを実行してエンドポイントへアクセスします。</p>
<p>エンドポイントが機能している場合は、HTTP 204 レスポンス コードが表示されます。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">xxxxxxxxxx@tky-bastion:~/terraform$ curl -v 10.0.3.0/generate_204</span><br><span class="line">*   Trying 10.0.3.0:80...</span><br><span class="line">* TCP_NODELAY <span class="built_in">set</span></span><br><span class="line">* Connected to 10.0.3.0 (10.0.3.0) port 80 (<span class="comment">#0)</span></span><br><span class="line">&gt; GET /generate_204 HTTP/1.1</span><br><span class="line">&gt; Host: 10.0.3.0</span><br><span class="line">&gt; User-Agent: curl/7.68.0</span><br><span class="line">&gt; Accept: */*</span><br><span class="line">&gt;</span><br><span class="line">* Mark bundle as not supporting multiuse</span><br><span class="line">&lt; HTTP/1.1 204 No Content　★204のレスポンスを確認</span><br><span class="line">&lt; Content-Length: 0</span><br><span class="line">&lt; Cross-Origin-Resource-Policy: cross-origin</span><br><span class="line">&lt; Date: Sat, 25 Mar 2023 05:02:30 GMT</span><br><span class="line">&lt;</span><br><span class="line">* Connection <span class="comment">#0 to host 10.0.3.0 left intact</span></span><br></pre></td></tr></table></figure>


<h2 id="Terraform-の設定"><a href="#Terraform-の設定" class="headerlink" title="Terraform の設定"></a>Terraform の設定</h2><p>準備ができたのでTerraform 1.4.0の追加機能を検証していきます。<br>Terraform公式ドキュメント(1.4.0)のBackend&#x2F;gcsにstorage_custom_endpointが追加されていることが確認できます。</p>
<p><a target="_blank" rel="noopener" href="https://developer.hashicorp.com/terraform/language/settings/backends/gcs">https://developer.hashicorp.com/terraform/language/settings/backends/gcs</a></p>
<blockquote>
<p>storage_custom_endpoint &#x2F; GOOGLE_BACKEND_STORAGE_CUSTOM_ENDPOINT &#x2F; GOOGLE_STORAGE_CUSTOM_ENDPOINT - (Optional) A URL containing three parts: the protocol, the DNS name pointing to a Private Service Connect endpoint, and the path for the Cloud Storage API (&#x2F;storage&#x2F;v1&#x2F;b, see here). You can either use a DNS name automatically made by the Service Directory or a custom DNS name made by you. For example, if you create an endpoint called xyz and want to use the automatically-created DNS name, you should set the field value as <a target="_blank" rel="noopener" href="https://storage-xyz.p.googleapis.com/storage/v1/b">https://storage-xyz.p.googleapis.com/storage/v1/b</a>. For help creating a Private Service Connect endpoint using Terraform, see this guide.</p>
</blockquote>
<h2 id="Private-Service-Connect経由のGCSアクセス確認"><a href="#Private-Service-Connect経由のGCSアクセス確認" class="headerlink" title="Private Service Connect経由のGCSアクセス確認"></a>Private Service Connect経由のGCSアクセス確認</h2><h3 id="Terraform-Backendの設定"><a href="#Terraform-Backendの設定" class="headerlink" title="Terraform Backendの設定"></a>Terraform Backendの設定</h3><p>backend.tfにterraform 1.4で追加された<code>storage_custom_endpoint</code>を追加してみます。</p>
<p>こちらの設定を追加することで、tfstateが保存されているbackendのGCSへのアクセスをPrivate Service Connectのエンドポイント経由にすることができます。<br><code>https://storage-xyz.p.googleapis.com/storage/v1/b</code>をベースに値の置き換えをします。</p>
<ul>
<li>xyz→sampleendpoint（Private Service Connectのエンドポイント名）</li>
</ul>
<figure class="highlight plaintext"><figcaption><span>backend.tf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">terraform &#123;</span><br><span class="line">  backend &quot;gcs&quot; &#123;</span><br><span class="line">    bucket                  = &quot;xxxxxxxxxxxxxxxxx&quot;</span><br><span class="line">    prefix                  = &quot;terraform/state&quot;</span><br><span class="line">    storage_custom_endpoint = &quot;https://storage-sampleendpoint.p.googleapis.com/storage/v1/b&quot; ★追加</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="tcpdumpを利用したPrivate-Service-Connect経由のGCSアクセス確認"><a href="#tcpdumpを利用したPrivate-Service-Connect経由のGCSアクセス確認" class="headerlink" title="tcpdumpを利用したPrivate Service Connect経由のGCSアクセス確認"></a>tcpdumpを利用したPrivate Service Connect経由のGCSアクセス確認</h3><p>tcpdumpを利用してPrivate Service Connectのエンドポイント(10.0.3.0)を経由してbackendのgcsへアクセスできていることを確認します。</p>
<p>コンソールを2つ開きます。</p>
<ul>
<li>terraform initを実行するコンソール</li>
<li>tcpdumpを実行するコンソール</li>
</ul>
<p>先にtcpdumpを実行するコンソールからtcpdumpコマンド<code>sudo tcpdump dst 10.0.3.0</code>を実行し、Private Service Connectのエンドポイント(10.0.3.0)を経由するパケットをキャプチャする準備をします。</p>
<p>tcpdumpコマンドを実行後に、terraform initを実行するコンソールからterraform initを実行するとPrivate Service Connectのエンドポイント(10.0.3.0)を経由するパケットがキャプチャされていることが確認できました。Private Service Connectのエンドポイント(10.0.3.0)を経由して無事GCSにアクセスできたようです。</p>
<figure class="highlight bash"><figcaption><span>terraform init実行</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">xxxxxxxxxx@tky-bastion:~/terraform$ <span class="built_in">date</span> &amp;&amp; terraform init</span><br><span class="line">Sat Mar 25 02:13:50 UTC 2023</span><br><span class="line"></span><br><span class="line">Initializing the backend...</span><br><span class="line"></span><br><span class="line">Initializing provider plugins...</span><br><span class="line">- Reusing previous version of hashicorp/google from the dependency lock file</span><br><span class="line">- Using previously-installed hashicorp/google v4.57.0</span><br><span class="line"></span><br><span class="line">Terraform has been successfully initialized!</span><br><span class="line"></span><br><span class="line">You may now begin working with Terraform. Try running <span class="string">&quot;terraform plan&quot;</span> to see</span><br><span class="line">any changes that are required <span class="keyword">for</span> your infrastructure. All Terraform commands</span><br><span class="line">should now work.</span><br><span class="line"></span><br><span class="line">If you ever <span class="built_in">set</span> or change modules or backend configuration <span class="keyword">for</span> Terraform,</span><br><span class="line">rerun this <span class="built_in">command</span> to reinitialize your working directory. If you forget, other</span><br><span class="line">commands will detect it and remind you to <span class="keyword">do</span> so <span class="keyword">if</span> necessary.</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><figcaption><span>tcpdumpの実行</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">xxxxxxxxxx@tky-bastion:~$ <span class="built_in">date</span> &amp;&amp; sudo tcpdump dst 10.0.3.0</span><br><span class="line">Sat Mar 25 02:13:49 UTC 2023</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on ens4, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">02:13:50.920469 IP tky-bastion.asia-northeast1-c.c.xxxxxxxxxxxxx.internal.44474 &gt; 10.0.3.0.https: Flags [S], <span class="built_in">seq</span> 665228907, win 65320, options [mss 1420,sackOK,TS val 3343093648 ecr 0,nop,wscale 7], length 0</span><br><span class="line">02:13:50.921158 IP tky-bastion.asia-northeast1-c.c.xxxxxxxxxxxxx.internal.44474 &gt; 10.0.3.0.https: Flags [.], ack 692049395, win 511, options [nop,nop,TS val 3343093649 ecr 2560562916], length 0</span><br><span class="line">02:13:50.921387 IP tky-bastion.asia-northeast1-c.c.xxxxxxxxxxxxx.internal.44474 &gt; 10.0.3.0.https: Flags [P.], <span class="built_in">seq</span> 0:305, ack 1, win 511, options [nop,nop,TS val 3343093649 ecr 2560562916], length 305</span><br><span class="line">02:13:50.959772 IP tky-bastion.asia-northeast1-c.c.xxxxxxxxxxxxx.internal.44474 &gt; 10.0.3.0.https: Flags [.], ack 7041, win 479, options [nop,nop,TS val 3343093687 ecr 2560562955], length 0</span><br><span class="line">02:13:50.959781 IP tky-bastion.asia-northeast1-c.c.xxxxxxxxxxxxx.internal.44474 &gt; 10.0.3.0.https: Flags [.], ack 9820, win 467, options [nop,nop,TS val 3343093687 ecr 2560562955], length 0</span><br><span class="line">02:13:50.975543 IP tky-bastion.asia-northeast1-c.c.xxxxxxxxxxxxx.internal.44474 &gt; 10.0.3.0.https: Flags [P.], <span class="built_in">seq</span> 305:369, ack 9820, win 501, options [nop,nop,TS val 3343093703 ecr 2560562955], length 64</span><br><span class="line">02:13:50.975657 IP tky-bastion.asia-northeast1-c.c.xxxxxxxxxxxxx.internal.44474 &gt; 10.0.3.0.https: Flags [P.], <span class="built_in">seq</span> 369:455, ack 9820, win 501, options [nop,nop,TS val 3343093703 ecr 2560562955], length 86</span><br><span class="line">02:13:50.975798 IP tky-bastion.asia-northeast1-c.c.xxxxxxxxxxxxx.internal.44474 &gt; 10.0.3.0.https: Flags [.], ack 9913, win 501, options [nop,nop,TS val 3343093703 ecr 2560562971], length 0</span><br><span class="line">02:13:50.975857 IP tky-bastion.asia-northeast1-c.c.xxxxxxxxxxxxx.internal.44474 &gt; 10.0.3.0.https: Flags [P.], <span class="built_in">seq</span> 455:1659, ack 9913, win 501, options [nop,nop,TS val 3343093703 ecr 2560562971], length 1204</span><br><span class="line">02:13:50.976394 IP tky-bastion.asia-northeast1-c.c.xxxxxxxxxxxxx.internal.44474 &gt; 10.0.3.0.https: Flags [P.], <span class="built_in">seq</span> 1659:1690, ack 9913, win 501, options [nop,nop,TS val 3343093704 ecr 2560562971], length 31</span><br><span class="line">02:13:50.993635 IP tky-bastion.asia-northeast1-c.c.xxxxxxxxxxxxx.internal.44474 &gt; 10.0.3.0.https: Flags [.], ack 11081, win 501, options [nop,nop,TS val 3343093721 ecr 2560562989], length 0</span><br><span class="line">02:13:50.993983 IP tky-bastion.asia-northeast1-c.c.xxxxxxxxxxxxx.internal.44474 &gt; 10.0.3.0.https: Flags [.], ack 11151, win 501, options [nop,nop,TS val 3343093722 ecr 2560562989], length 0</span><br><span class="line">02:13:50.994012 IP tky-bastion.asia-northeast1-c.c.xxxxxxxxxxxxx.internal.44474 &gt; 10.0.3.0.https: Flags [P.], <span class="built_in">seq</span> 1690:1729, ack 11151, win 501, options [nop,nop,TS val 3343093722 ecr 2560562989], length 39</span><br><span class="line">02:13:51.194072 IP tky-bastion.asia-northeast1-c.c.xxxxxxxxxxxxx.internal.44474 &gt; 10.0.3.0.https: Flags [P.], <span class="built_in">seq</span> 1729:1854, ack 11151, win 501, options [nop,nop,TS val 3343093922 ecr 2560562994], length 125</span><br><span class="line">02:13:51.213234 IP tky-bastion.asia-northeast1-c.c.xxxxxxxxxxxxx.internal.44474 &gt; 10.0.3.0.https: Flags [.], ack 11863, win 501, options [nop,nop,TS val 3343093941 ecr 2560563208], length 0</span><br><span class="line">02:13:51.213423 IP tky-bastion.asia-northeast1-c.c.xxxxxxxxxxxxx.internal.44474 &gt; 10.0.3.0.https: Flags [P.], <span class="built_in">seq</span> 1854:1893, ack 11863, win 501, options [nop,nop,TS val 3343093941 ecr 2560563208], length 39</span><br><span class="line">02:13:51.213662 IP tky-bastion.asia-northeast1-c.c.xxxxxxxxxxxxx.internal.44474 &gt; 10.0.3.0.https: Flags [P.], <span class="built_in">seq</span> 1893:2137, ack 11863, win 501, options [nop,nop,TS val 3343093941 ecr 2560563208], length 244</span><br><span class="line">02:13:51.237109 IP tky-bastion.asia-northeast1-c.c.xxxxxxxxxxxxx.internal.44474 &gt; 10.0.3.0.https: Flags [.], ack 12963, win 501, options [nop,nop,TS val 3343093965 ecr 2560563232], length 0</span><br><span class="line">02:13:51.237265 IP tky-bastion.asia-northeast1-c.c.xxxxxxxxxxxxx.internal.44474 &gt; 10.0.3.0.https: Flags [P.], <span class="built_in">seq</span> 2137:2176, ack 12963, win 501, options [nop,nop,TS val 3343093965 ecr 2560563232], length 39</span><br><span class="line">02:13:51.237810 IP tky-bastion.asia-northeast1-c.c.xxxxxxxxxxxxx.internal.44474 &gt; 10.0.3.0.https: Flags [P.], <span class="built_in">seq</span> 2176:2256, ack 12963, win 501, options [nop,nop,TS val 3343093965 ecr 2560563232], length 80</span><br><span class="line">02:13:51.257360 IP tky-bastion.asia-northeast1-c.c.xxxxxxxxxxxxx.internal.44474 &gt; 10.0.3.0.https: Flags [.], ack 13326, win 501, options [nop,nop,TS val 3343093985 ecr 2560563253], length 0</span><br><span class="line">02:13:51.257569 IP tky-bastion.asia-northeast1-c.c.xxxxxxxxxxxxx.internal.44474 &gt; 10.0.3.0.https: Flags [.], ack 13396, win 501, options [nop,nop,TS val 3343093985 ecr 2560563253], length 0</span><br><span class="line">02:13:51.257665 IP tky-bastion.asia-northeast1-c.c.xxxxxxxxxxxxx.internal.44474 &gt; 10.0.3.0.https: Flags [P.], <span class="built_in">seq</span> 2256:2295, ack 13396, win 501, options [nop,nop,TS val 3343093985 ecr 2560563253], length 39</span><br><span class="line">02:13:51.257755 IP tky-bastion.asia-northeast1-c.c.xxxxxxxxxxxxx.internal.44474 &gt; 10.0.3.0.https: Flags [P.], <span class="built_in">seq</span> 2295:2450, ack 13396, win 501, options [nop,nop,TS val 3343093985 ecr 2560563253], length 155</span><br><span class="line">02:13:51.273998 IP tky-bastion.asia-northeast1-c.c.xxxxxxxxxxxxx.internal.44474 &gt; 10.0.3.0.https: Flags [.], ack 14405, win 501, options [nop,nop,TS val 3343094002 ecr 2560563269], length 0</span><br><span class="line">02:13:51.274108 IP tky-bastion.asia-northeast1-c.c.xxxxxxxxxxxxx.internal.44474 &gt; 10.0.3.0.https: Flags [.], ack 14475, win 501, options [nop,nop,TS val 3343094002 ecr 2560563269], length 0</span><br><span class="line">02:13:51.274127 IP tky-bastion.asia-northeast1-c.c.xxxxxxxxxxxxx.internal.44474 &gt; 10.0.3.0.https: Flags [P.], <span class="built_in">seq</span> 2450:2489, ack 14475, win 501, options [nop,nop,TS val 3343094002 ecr 2560563269], length 39</span><br><span class="line">02:13:51.707967 IP tky-bastion.asia-northeast1-c.c.xxxxxxxxxxxxx.internal.44474 &gt; 10.0.3.0.https: Flags [F.], <span class="built_in">seq</span> 2489, ack 14475, win 501, options [nop,nop,TS val 3343094436 ecr 2560563274], length 0</span><br><span class="line">02:13:51.708100 IP tky-bastion.asia-northeast1-c.c.xxxxxxxxxxxxx.internal.44474 &gt; 10.0.3.0.https: Flags [.], ack 14476, win 501, options [nop,nop,TS val 3343094436 ecr 2560563703], length 0</span><br></pre></td></tr></table></figure>

<p>また、nslookupコマンドでbackend.tfのstorage_custom_endpointに設定している<code>storage-sampleendpoint.p.googleapis.com</code>を指定して実行すると10.0.3.0で名前解決されることも確認できました。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">xxxxxxxxxx@tky-bastion:~/terraform$ nslookup storage-sampleendpoint.p.googleapis.com</span><br><span class="line">Server:         127.0.0.53</span><br><span class="line">Address:        127.0.0.53<span class="comment">#53</span></span><br><span class="line"></span><br><span class="line">Non-authoritative answer:</span><br><span class="line">Name:   storage-sampleendpoint.p.googleapis.com</span><br><span class="line">Address: 10.0.3.0</span><br></pre></td></tr></table></figure>

<h1 id="余談"><a href="#余談" class="headerlink" title="余談"></a>余談</h1><p>余談ですが、<code>tcpdump -n -vv dst port 443</code>コマンドを実行してterraform initを実施し、GCEから443ポートへアクセスしたパケットをキャプチャしてみました。</p>
<figure class="highlight bash"><figcaption><span>tcpdump -n -vv dst port 443コマンド実行結果</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line">xxxxxxxxxx@tky-bastion:~/terraform$ sudo tcpdump -n -vv dst port 443</span><br><span class="line">tcpdump: listening on ens4, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">05:14:59.618319 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 11848, offset 0, flags [DF], proto TCP (6), length 60)</span><br><span class="line">    10.0.0.2.53478 &gt; 10.0.3.0.443: Flags [S], <span class="built_in">cksum</span> 0x1730 (incorrect -&gt; 0xad7d), <span class="built_in">seq</span> 1890652633, win 65320, options [mss 1420,sackOK,TS val 3353962346 ecr 0,nop,wscale 7], length 0</span><br><span class="line">05:14:59.618778 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 11849, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class="line">    10.0.0.2.53478 &gt; 10.0.3.0.443: Flags [.], <span class="built_in">cksum</span> 0x1728 (incorrect -&gt; 0x3d3b), <span class="built_in">seq</span> 1890652634, ack 3216389491, win 511, options [nop,nop,TS val 3353962346 ecr 1133339465], length 0</span><br><span class="line">05:14:59.619011 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 11850, offset 0, flags [DF], proto TCP (6), length 357)</span><br><span class="line">    10.0.0.2.53478 &gt; 10.0.3.0.443: Flags [P.], <span class="built_in">cksum</span> 0x1859 (incorrect -&gt; 0x80b7), <span class="built_in">seq</span> 0:305, ack 1, win 511, options [nop,nop,TS val 3353962347 ecr 1133339465], length 305</span><br><span class="line">05:14:59.655194 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 11851, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class="line">    10.0.0.2.53478 &gt; 10.0.3.0.443: Flags [.], <span class="built_in">cksum</span> 0x1728 (incorrect -&gt; 0x2063), <span class="built_in">seq</span> 305, ack 7041, win 477, options [nop,nop,TS val 3353962383 ecr 1133339501], length 0</span><br><span class="line">05:14:59.655208 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 11852, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class="line">    10.0.0.2.53478 &gt; 10.0.3.0.443: Flags [.], <span class="built_in">cksum</span> 0x1728 (incorrect -&gt; 0x1596), <span class="built_in">seq</span> 305, ack 9822, win 461, options [nop,nop,TS val 3353962383 ecr 1133339501], length 0</span><br><span class="line">05:14:59.671136 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 11853, offset 0, flags [DF], proto TCP (6), length 116)</span><br><span class="line">    10.0.0.2.53478 &gt; 10.0.3.0.443: Flags [P.], <span class="built_in">cksum</span> 0x1768 (incorrect -&gt; 0x3471), <span class="built_in">seq</span> 305:369, ack 9822, win 501, options [nop,nop,TS val 3353962399 ecr 1133339501], length 64</span><br><span class="line">05:14:59.671287 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 11854, offset 0, flags [DF], proto TCP (6), length 138)</span><br><span class="line">    10.0.0.2.53478 &gt; 10.0.3.0.443: Flags [P.], <span class="built_in">cksum</span> 0x177e (incorrect -&gt; 0x3286), <span class="built_in">seq</span> 369:455, ack 9822, win 501, options [nop,nop,TS val 3353962399 ecr 1133339501], length 86</span><br><span class="line">05:14:59.671463 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 11855, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class="line">    10.0.0.2.53478 &gt; 10.0.3.0.443: Flags [.], <span class="built_in">cksum</span> 0x1728 (incorrect -&gt; 0x145b), <span class="built_in">seq</span> 455, ack 9915, win 501, options [nop,nop,TS val 3353962399 ecr 1133339517], length 0</span><br><span class="line">05:14:59.671615 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 11856, offset 0, flags [DF], proto TCP (6), length 1246)</span><br><span class="line">    10.0.0.2.53478 &gt; 10.0.3.0.443: Flags [P.], <span class="built_in">cksum</span> 0x1bd2 (incorrect -&gt; 0xb465), <span class="built_in">seq</span> 455:1649, ack 9915, win 501, options [nop,nop,TS val 3353962399 ecr 1133339517], length 1194</span><br><span class="line">05:14:59.671989 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 11857, offset 0, flags [DF], proto TCP (6), length 83)</span><br><span class="line">    10.0.0.2.53478 &gt; 10.0.3.0.443: Flags [P.], <span class="built_in">cksum</span> 0x1747 (incorrect -&gt; 0xfb7a), <span class="built_in">seq</span> 1649:1680, ack 9915, win 501, options [nop,nop,TS val 3353962400 ecr 1133339517], length 31</span><br><span class="line">05:14:59.695902 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 11858, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class="line">    10.0.0.2.53478 &gt; 10.0.3.0.443: Flags [.], <span class="built_in">cksum</span> 0x1728 (incorrect -&gt; 0x0ab2), <span class="built_in">seq</span> 1680, ack 11114, win 501, options [nop,nop,TS val 3353962423 ecr 1133339542], length 0</span><br><span class="line">05:14:59.696324 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 11859, offset 0, flags [DF], proto TCP (6), length 91)</span><br><span class="line">    10.0.0.2.53478 &gt; 10.0.3.0.443: Flags [P.], <span class="built_in">cksum</span> 0x174f (incorrect -&gt; 0x000a), <span class="built_in">seq</span> 1680:1719, ack 11153, win 501, options [nop,nop,TS val 3353962424 ecr 1133339542], length 39</span><br><span class="line">05:14:59.896847 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 11860, offset 0, flags [DF], proto TCP (6), length 177)</span><br><span class="line">    10.0.0.2.53478 &gt; 10.0.3.0.443: Flags [P.], <span class="built_in">cksum</span> 0x17a5 (incorrect -&gt; 0x7c61), <span class="built_in">seq</span> 1719:1844, ack 11153, win 501, options [nop,nop,TS val 3353962624 ecr 1133339548], length 125</span><br><span class="line">05:14:59.919871 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 11861, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class="line">    10.0.0.2.53478 &gt; 10.0.3.0.443: Flags [.], <span class="built_in">cksum</span> 0x1728 (incorrect -&gt; 0x0577), <span class="built_in">seq</span> 1844, ack 11841, win 501, options [nop,nop,TS val 3353962647 ecr 1133339766], length 0</span><br><span class="line">05:14:59.920025 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 11862, offset 0, flags [DF], proto TCP (6), length 91)</span><br><span class="line">    10.0.0.2.53478 &gt; 10.0.3.0.443: Flags [P.], <span class="built_in">cksum</span> 0x174f (incorrect -&gt; 0xf0a1), <span class="built_in">seq</span> 1844:1883, ack 11841, win 501, options [nop,nop,TS val 3353962648 ecr 1133339766], length 39</span><br><span class="line">05:14:59.920303 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 11863, offset 0, flags [DF], proto TCP (6), length 296)</span><br><span class="line">    10.0.0.2.53478 &gt; 10.0.3.0.443: Flags [P.], <span class="built_in">cksum</span> 0x181c (incorrect -&gt; 0x465c), <span class="built_in">seq</span> 1883:2127, ack 11841, win 501, options [nop,nop,TS val 3353962648 ecr 1133339766], length 244</span><br><span class="line">05:14:59.935230 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 11864, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class="line">    10.0.0.2.53478 &gt; 10.0.3.0.443: Flags [.], <span class="built_in">cksum</span> 0x1728 (incorrect -&gt; 0x001d), <span class="built_in">seq</span> 2127, ack 12897, win 501, options [nop,nop,TS val 3353962663 ecr 1133339781], length 0</span><br><span class="line">05:14:59.935406 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 11865, offset 0, flags [DF], proto TCP (6), length 91)</span><br><span class="line">    10.0.0.2.53478 &gt; 10.0.3.0.443: Flags [P.], <span class="built_in">cksum</span> 0x174f (incorrect -&gt; 0x01e6), <span class="built_in">seq</span> 2127:2166, ack 12936, win 501, options [nop,nop,TS val 3353962663 ecr 1133339781], length 39</span><br><span class="line">05:14:59.935919 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 11866, offset 0, flags [DF], proto TCP (6), length 133)</span><br><span class="line">    10.0.0.2.53478 &gt; 10.0.3.0.443: Flags [P.], <span class="built_in">cksum</span> 0x1779 (incorrect -&gt; 0x2c27), <span class="built_in">seq</span> 2166:2247, ack 12936, win 501, options [nop,nop,TS val 3353962663 ecr 1133339781], length 81</span><br><span class="line">05:14:59.959617 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 11867, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class="line">    10.0.0.2.53478 &gt; 10.0.3.0.443: Flags [.], <span class="built_in">cksum</span> 0x1728 (incorrect -&gt; 0xfde0), <span class="built_in">seq</span> 2247, ack 13300, win 501, options [nop,nop,TS val 3353962687 ecr 1133339806], length 0</span><br><span class="line">05:14:59.959735 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 11868, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class="line">    10.0.0.2.53478 &gt; 10.0.3.0.443: Flags [.], <span class="built_in">cksum</span> 0x1728 (incorrect -&gt; 0xfd9a), <span class="built_in">seq</span> 2247, ack 13370, win 501, options [nop,nop,TS val 3353962687 ecr 1133339806], length 0</span><br><span class="line">05:14:59.959759 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 11869, offset 0, flags [DF], proto TCP (6), length 91)</span><br><span class="line">    10.0.0.2.53478 &gt; 10.0.3.0.443: Flags [P.], <span class="built_in">cksum</span> 0x174f (incorrect -&gt; 0x5782), <span class="built_in">seq</span> 2247:2286, ack 13370, win 501, options [nop,nop,TS val 3353962687 ecr 1133339806], length 39</span><br><span class="line">05:14:59.959992 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 11870, offset 0, flags [DF], proto TCP (6), length 208)</span><br><span class="line">    10.0.0.2.53478 &gt; 10.0.3.0.443: Flags [P.], <span class="built_in">cksum</span> 0x17c4 (incorrect -&gt; 0x4db0), <span class="built_in">seq</span> 2286:2442, ack 13370, win 501, options [nop,nop,TS val 3353962688 ecr 1133339806], length 156</span><br><span class="line">05:14:59.975804 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 11871, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class="line">    10.0.0.2.53478 &gt; 10.0.3.0.443: Flags [.], <span class="built_in">cksum</span> 0x1728 (incorrect -&gt; 0xf8ac), <span class="built_in">seq</span> 2442, ack 14405, win 501, options [nop,nop,TS val 3353962703 ecr 1133339822], length 0</span><br><span class="line">05:14:59.975974 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 11872, offset 0, flags [DF], proto TCP (6), length 91)</span><br><span class="line">    10.0.0.2.53478 &gt; 10.0.3.0.443: Flags [P.], <span class="built_in">cksum</span> 0x174f (incorrect -&gt; 0x1781), <span class="built_in">seq</span> 2442:2481, ack 14444, win 501, options [nop,nop,TS val 3353962704 ecr 1133339822], length 39</span><br><span class="line">05:14:59.990384 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 49768, offset 0, flags [DF], proto TCP (6), length 60)</span><br><span class="line">    10.0.0.2.34760 &gt; 18.65.202.87.443: Flags [S], <span class="built_in">cksum</span> 0xe6c8 (incorrect -&gt; 0x3154), <span class="built_in">seq</span> 804049769, win 65320, options [mss 1420,sackOK,TS val 118988064 ecr 0,nop,wscale 7], length 0</span><br><span class="line">05:14:59.992174 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 49769, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class="line">    10.0.0.2.34760 &gt; 18.65.202.87.443: Flags [.], <span class="built_in">cksum</span> 0xe6c0 (incorrect -&gt; 0x36cd), <span class="built_in">seq</span> 804049770, ack 2881392399, win 511, options [nop,nop,TS val 118988066 ecr 3287754621], length 0</span><br><span class="line">05:14:59.992465 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 49770, offset 0, flags [DF], proto TCP (6), length 339)</span><br><span class="line">    10.0.0.2.34760 &gt; 18.65.202.87.443: Flags [P.], <span class="built_in">cksum</span> 0xe7df (incorrect -&gt; 0xcbaf), <span class="built_in">seq</span> 0:287, ack 1, win 511, options [nop,nop,TS val 118988066 ecr 3287754621], length 287</span><br><span class="line">05:14:59.994083 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 49771, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class="line">    10.0.0.2.34760 &gt; 18.65.202.87.443: Flags [.], <span class="built_in">cksum</span> 0xe6c0 (incorrect -&gt; 0x1fc4), <span class="built_in">seq</span> 287, ack 5633, win 485, options [nop,nop,TS val 118988068 ecr 3287754623], length 0</span><br><span class="line">05:14:59.995701 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 49772, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class="line">    10.0.0.2.34760 &gt; 18.65.202.87.443: Flags [.], <span class="built_in">cksum</span> 0xe6c0 (incorrect -&gt; 0x1dd9), <span class="built_in">seq</span> 287, ack 6105, win 501, options [nop,nop,TS val 118988069 ecr 3287754625], length 0</span><br><span class="line">05:14:59.996879 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 49773, offset 0, flags [DF], proto TCP (6), length 116)</span><br><span class="line">    10.0.0.2.34760 &gt; 18.65.202.87.443: Flags [P.], <span class="built_in">cksum</span> 0xe700 (incorrect -&gt; 0x0739), <span class="built_in">seq</span> 287:351, ack 6105, win 501, options [nop,nop,TS val 118988070 ecr 3287754625], length 64</span><br><span class="line">05:14:59.996970 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 49774, offset 0, flags [DF], proto TCP (6), length 138)</span><br><span class="line">    10.0.0.2.34760 &gt; 18.65.202.87.443: Flags [P.], <span class="built_in">cksum</span> 0xe716 (incorrect -&gt; 0x6424), <span class="built_in">seq</span> 351:437, ack 6105, win 501, options [nop,nop,TS val 118988071 ecr 3287754625], length 86</span><br><span class="line">05:14:59.997049 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 49775, offset 0, flags [DF], proto TCP (6), length 184)</span><br><span class="line">    10.0.0.2.34760 &gt; 18.65.202.87.443: Flags [P.], <span class="built_in">cksum</span> 0xe744 (incorrect -&gt; 0xeaa5), <span class="built_in">seq</span> 437:569, ack 6105, win 501, options [nop,nop,TS val 118988071 ecr 3287754625], length 132</span><br><span class="line">05:14:59.998619 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 49776, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class="line">    10.0.0.2.34760 &gt; 18.65.202.87.443: Flags [.], <span class="built_in">cksum</span> 0xe6c0 (incorrect -&gt; 0x1be0), <span class="built_in">seq</span> 569, ack 6322, win 501, options [nop,nop,TS val 118988072 ecr 3287754628], length 0</span><br><span class="line">05:14:59.998648 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 49777, offset 0, flags [DF], proto TCP (6), length 83)</span><br><span class="line">    10.0.0.2.34760 &gt; 18.65.202.87.443: Flags [P.], <span class="built_in">cksum</span> 0xe6df (incorrect -&gt; 0x4699), <span class="built_in">seq</span> 569:600, ack 6322, win 501, options [nop,nop,TS val 118988072 ecr 3287754628], length 31</span><br><span class="line">05:15:00.001052 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 27837, offset 0, flags [DF], proto TCP (6), length 60)</span><br><span class="line">    10.0.0.2.50122 &gt; 18.65.202.96.443: Flags [S], <span class="built_in">cksum</span> 0xe6d1 (incorrect -&gt; 0xe0d7), <span class="built_in">seq</span> 4293780694, win 65320, options [mss 1420,sackOK,TS val 2768777777 ecr 0,nop,wscale 7], length 0</span><br><span class="line">05:15:00.002878 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 27838, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class="line">    10.0.0.2.50122 &gt; 18.65.202.96.443: Flags [.], <span class="built_in">cksum</span> 0xe6c9 (incorrect -&gt; 0x5b53), <span class="built_in">seq</span> 4293780695, ack 1618472241, win 511, options [nop,nop,TS val 2768777778 ecr 4104875756], length 0</span><br><span class="line">05:15:00.003079 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 27839, offset 0, flags [DF], proto TCP (6), length 339)</span><br><span class="line">    10.0.0.2.50122 &gt; 18.65.202.96.443: Flags [P.], <span class="built_in">cksum</span> 0xe7e8 (incorrect -&gt; 0xa7d9), <span class="built_in">seq</span> 0:287, ack 1, win 511, options [nop,nop,TS val 2768777779 ecr 4104875756], length 287</span><br><span class="line">05:15:00.015189 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 27840, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class="line">    10.0.0.2.50122 &gt; 18.65.202.96.443: Flags [.], <span class="built_in">cksum</span> 0xe6c9 (incorrect -&gt; 0x4435), <span class="built_in">seq</span> 287, ack 5633, win 485, options [nop,nop,TS val 2768777791 ecr 4104875768], length 0</span><br><span class="line">05:15:00.019172 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 27841, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class="line">    10.0.0.2.50122 &gt; 18.65.202.96.443: Flags [.], <span class="built_in">cksum</span> 0xe6c9 (incorrect -&gt; 0x4245), <span class="built_in">seq</span> 287, ack 6105, win 501, options [nop,nop,TS val 2768777795 ecr 4104875772], length 0</span><br><span class="line">05:15:00.020132 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 27842, offset 0, flags [DF], proto TCP (6), length 116)</span><br><span class="line">    10.0.0.2.50122 &gt; 18.65.202.96.443: Flags [P.], <span class="built_in">cksum</span> 0xe709 (incorrect -&gt; 0x4fa9), <span class="built_in">seq</span> 287:351, ack 6105, win 501, options [nop,nop,TS val 2768777796 ecr 4104875772], length 64</span><br><span class="line">05:15:00.020226 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 27843, offset 0, flags [DF], proto TCP (6), length 138)</span><br><span class="line">    10.0.0.2.50122 &gt; 18.65.202.96.443: Flags [P.], <span class="built_in">cksum</span> 0xe71f (incorrect -&gt; 0xbc63), <span class="built_in">seq</span> 351:437, ack 6105, win 501, options [nop,nop,TS val 2768777796 ecr 4104875772], length 86</span><br><span class="line">05:15:00.020313 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 27844, offset 0, flags [DF], proto TCP (6), length 171)</span><br><span class="line">    10.0.0.2.50122 &gt; 18.65.202.96.443: Flags [P.], <span class="built_in">cksum</span> 0xe740 (incorrect -&gt; 0x1e38), <span class="built_in">seq</span> 437:556, ack 6105, win 501, options [nop,nop,TS val 2768777796 ecr 4104875772], length 119</span><br><span class="line">05:15:00.025659 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 27845, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class="line">    10.0.0.2.50122 &gt; 18.65.202.96.443: Flags [.], <span class="built_in">cksum</span> 0xe6c9 (incorrect -&gt; 0x4052), <span class="built_in">seq</span> 556, ack 6322, win 501, options [nop,nop,TS val 2768777801 ecr 4104875779], length 0</span><br><span class="line">05:15:00.025711 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 27846, offset 0, flags [DF], proto TCP (6), length 83)</span><br><span class="line">    10.0.0.2.50122 &gt; 18.65.202.96.443: Flags [P.], <span class="built_in">cksum</span> 0xe6e8 (incorrect -&gt; 0xd5e8), <span class="built_in">seq</span> 556:587, ack 6322, win 501, options [nop,nop,TS val 2768777801 ecr 4104875779], length 31</span><br><span class="line">05:15:00.043638 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 49778, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class="line">    10.0.0.2.34760 &gt; 18.65.202.87.443: Flags [.], <span class="built_in">cksum</span> 0xe6c0 (incorrect -&gt; 0x1665), <span class="built_in">seq</span> 600, ack 7648, win 501, options [nop,nop,TS val 118988117 ecr 3287754629], length 0</span><br><span class="line">05:15:00.233601 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 27847, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class="line">    10.0.0.2.50122 &gt; 18.65.202.96.443: Flags [.], <span class="built_in">cksum</span> 0xe6c9 (incorrect -&gt; 0x2bd4), <span class="built_in">seq</span> 587, ack 11121, win 501, options [nop,nop,TS val 2768778009 ecr 4104875987], length 0</span><br><span class="line">05:15:00.234626 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 27848, offset 0, flags [DF], proto TCP (6), length 87)</span><br><span class="line">    10.0.0.2.50122 &gt; 18.65.202.96.443: Flags [P.], <span class="built_in">cksum</span> 0xe6ec (incorrect -&gt; 0x6bac), <span class="built_in">seq</span> 587:622, ack 11152, win 501, options [nop,nop,TS val 2768778010 ecr 4104875987], length 35</span><br><span class="line">05:15:00.434281 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 27849, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class="line">    10.0.0.2.50122 &gt; 18.65.202.96.443: Flags [F.], <span class="built_in">cksum</span> 0xe6c9 (incorrect -&gt; 0x2ac5), <span class="built_in">seq</span> 622, ack 11152, win 501, options [nop,nop,TS val 2768778210 ecr 4104875990], length 0</span><br><span class="line">05:15:00.434304 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 49779, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class="line">    10.0.0.2.34760 &gt; 18.65.202.87.443: Flags [F.], <span class="built_in">cksum</span> 0xe6c0 (incorrect -&gt; 0x14dd), <span class="built_in">seq</span> 600, ack 7648, win 501, options [nop,nop,TS val 118988508 ecr 3287754629], length 0</span><br><span class="line">05:15:00.434314 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 11873, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class="line">    10.0.0.2.53478 &gt; 10.0.3.0.443: Flags [F.], <span class="built_in">cksum</span> 0x1728 (incorrect -&gt; 0xf68d), <span class="built_in">seq</span> 2481, ack 14444, win 501, options [nop,nop,TS val 3353963162 ecr 1133339827], length 0</span><br><span class="line">05:15:00.434467 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 11874, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class="line">    10.0.0.2.53478 &gt; 10.0.3.0.443: Flags [.], <span class="built_in">cksum</span> 0x1728 (incorrect -&gt; 0xf4c6), <span class="built_in">seq</span> 2482, ack 14445, win 501, options [nop,nop,TS val 3353963162 ecr 1133340281], length 0</span><br><span class="line">05:15:00.436252 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 27850, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class="line">    10.0.0.2.50122 &gt; 18.65.202.96.443: Flags [.], <span class="built_in">cksum</span> 0xe6c9 (incorrect -&gt; 0x29fb), <span class="built_in">seq</span> 623, ack 11153, win 501, options [nop,nop,TS val 2768778212 ecr 4104876189], length 0</span><br><span class="line">05:15:00.436271 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 49780, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class="line">    10.0.0.2.34760 &gt; 18.65.202.87.443: Flags [.], <span class="built_in">cksum</span> 0xe6c0 (incorrect -&gt; 0x1325), <span class="built_in">seq</span> 601, ack 7649, win 501, options [nop,nop,TS val 118988510 ecr 3287755066], length 0</span><br></pre></td></tr></table></figure>

<p>以下はGCE(10.0.0.2)からPrivate Service Connectエンドポイント(10.0.3.0)へのアクセスしてGCSへアクセスしているパケットのキャプチャだと思います。</p>
<blockquote>
<p>05:14:59.618319 IP (tos 0x0, ttl 64, id 11848, offset 0, flags [DF], proto TCP (6), length 60)<br>    10.0.0.2.53478 &gt; 10.0.3.0.443: Flags [S], cksum 0x1730 (incorrect -&gt; 0xad7d), seq 1890652633, win 65320, options [mss 1420,sackOK,TS val 3353962346 ecr 0,nop,wscale 7], length 0</p>
</blockquote>
<p>もう一つterraform init時にGCE(10.0.0.2)から18.65.202.87へアクセスしているパケットをキャプチャすることができました。</p>
<blockquote>
<p>05:15:00.436271 IP (tos 0x0, ttl 64, id 49780, offset 0, flags [DF], proto TCP (6), length 52)<br>    10.0.0.2.34760 &gt; 18.65.202.87.443: Flags [.], cksum 0xe6c0 (incorrect -&gt; 0x1325), seq 601, ack 7649, win 501, options [nop,nop,TS val 118988510 ecr 3287755066], length 0</p>
</blockquote>
<p>こちらについてもう少し調べてみます。<br>tcpdump -n -vv dst port 53コマンドを実行してterraform initを実施し、GCEから53ポートへアクセスしたパケットをキャプチャしてみました。</p>
<figure class="highlight bash"><figcaption><span>tcpdump -n -vv dst port 53コマンド実行結果</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">xxxxxxxxxx@tky-bastion:~/terraform$ sudo tcpdump -n -vv dst port 53</span><br><span class="line">tcpdump: listening on ens4, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">05:28:31.201384 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 52411, offset 0, flags [DF], proto UDP (17), length 96)</span><br><span class="line">    10.0.0.2.59890 &gt; 169.254.169.254.53: [bad udp <span class="built_in">cksum</span> 0x5e5c -&gt; 0xa496!] 31699+ [1au] AAAA? storage-sampleendpoint.p.googleapis.com. ar: . OPT UDPsize=512 (68)</span><br><span class="line">05:28:31.201482 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 37003, offset 0, flags [DF], proto UDP (17), length 96)</span><br><span class="line">    10.0.0.2.52697 &gt; 169.254.169.254.53: [bad udp <span class="built_in">cksum</span> 0x5e5c -&gt; 0x3727!] 8284+ [1au] A? storage-sampleendpoint.p.googleapis.com. ar: . OPT UDPsize=512 (68)</span><br><span class="line">05:28:31.596564 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 831, offset 0, flags [DF], proto UDP (17), length 78)</span><br><span class="line">    10.0.0.2.43466 &gt; 169.254.169.254.53: [bad udp <span class="built_in">cksum</span> 0x5e4a -&gt; 0x143a!] 35627+ [1au] A? registry.terraform.io. ar: . OPT UDPsize=512 (50)</span><br><span class="line">05:28:31.596653 IP (tos 0x0, ttl 64, <span class="built_in">id</span> 27444, offset 0, flags [DF], proto UDP (17), length 78)</span><br><span class="line">    10.0.0.2.58257 &gt; 169.254.169.254.53: [bad udp <span class="built_in">cksum</span> 0x5e4a -&gt; 0x126e!] 14384+ [1au] AAAA? registry.terraform.io. ar: . OPT UDPsize=512 (50)</span><br></pre></td></tr></table></figure>
<p>すると、<code>storage-sampleendpoint.p.googleapis.com</code>のほかに<code>registry.terraform.io</code>を名前解決していることがわかりました。</p>
<blockquote>
<p>05:28:31.596564 IP (tos 0x0, ttl 64, id 831, offset 0, flags [DF], proto UDP (17), length 78)<br>    10.0.0.2.43466 &gt; 169.254.169.254.53: [bad udp cksum 0x5e4a -&gt; 0x143a!] 35627+ [1au] A? registry.terraform.io. ar: . OPT UDPsize&#x3D;512 (50)<br>05:28:31.596653 IP (tos 0x0, ttl 64, id 27444, offset 0, flags [DF], proto UDP (17), length 78)<br>    10.0.0.2.58257 &gt; 169.254.169.254.53: [bad udp cksum 0x5e4a -&gt; 0x126e!] 14384+ [1au] AAAA? registry.terraform.io. ar: . OPT UDPsize&#x3D;512 (50</p>
</blockquote>
<p>今度はdigコマンドを利用して<code>registry.terraform.io</code>を名前解決してみます。<br>すると先ほどの<code>tcpdump -n -vv dst port 443</code>コマンドを実行して出力されたIPアドレス<code>18.65.202.87</code>が存在することがわかりました。<br>registry.terraform.io(18.65.202.87)への通信はCloud Nat&#x2F;インターネット経由でアクセスしています。</p>
<figure class="highlight bash"><figcaption><span>dig registry.terraform.ioコマンド実行結果</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">xxxxxxxxxx@tky-bastion:~/terraform$ dig registry.terraform.io</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.16.1-Ubuntu &lt;&lt;&gt;&gt; registry.terraform.io</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- <span class="string">opcode: QUERY, status: NOERROR, id: 7463</span></span><br><span class="line"><span class="string">;; flags: qr rd ra; QUERY: 1, ANSWER: 5, AUTHORITY: 0, ADDITIONAL: 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; OPT PSEUDOSECTION:</span></span><br><span class="line"><span class="string">; EDNS: version: 0, flags:; udp: 65494</span></span><br><span class="line"><span class="string">;; QUESTION SECTION:</span></span><br><span class="line"><span class="string">;registry.terraform.io.         IN      A</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; ANSWER SECTION:</span></span><br><span class="line"><span class="string">registry.terraform.io.  80      IN      CNAME   d3rdzqodp6w8cx.cloudfront.net.</span></span><br><span class="line"><span class="string">d3rdzqodp6w8cx.cloudfront.net. 60 IN    A       18.65.202.96</span></span><br><span class="line"><span class="string">d3rdzqodp6w8cx.cloudfront.net. 60 IN    A       18.65.202.27</span></span><br><span class="line"><span class="string">d3rdzqodp6w8cx.cloudfront.net. 60 IN    A       18.65.202.107</span></span><br><span class="line"><span class="string">d3rdzqodp6w8cx.cloudfront.net. 60 IN    A       18.65.202.87　★該当IPアドレス</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; Query time: 52 msec</span></span><br><span class="line"><span class="string">;; SERVER: 127.0.0.53#53(127.0.0.53)</span></span><br><span class="line"><span class="string">;; WHEN: Sat Mar 25 05:32:10 UTC 2023</span></span><br><span class="line"><span class="string">;; MSG SIZE  rcvd: 157</span></span><br></pre></td></tr></table></figure>

<p>このことからTerraform 1.4.0で追加されたPrivate Service Connectを利用したbackend&#x2F;gcsへのアクセスの機能を利用してもbackendのGCSへの通信のみプライベート接続され、Terraformのgoogle providerなどを利用するためにregistry.terraform.ioへのインターネットアクセスは避けられず完全プライベートではterraformは利用できないことが分かりました（当たり前か…）</p>
<h1 id="最後に"><a href="#最後に" class="headerlink" title="最後に"></a>最後に</h1><p>今回はTerraform 1.4で追加されたPrivate Service Connectエンドポイント経由でbackendに指定したGCSへアクセスできることができる機能を検証しました。</p>
<p>Private Service Connect自体も実務で使用したことがなかったので、勉強になりました。Private Service Connectを利用しプライベートネットワーク経由で backendのGCSへアクセスすることは確認できましたが、結局Terraformを利用するためには、インターネットへ接続できることが条件なので、Private Service Connectの構築・運用コストを考えるとよほどのセキュリティ要件がなければ通常のインターネット経由でbackendのGCSへアクセスする構成が無難かと思いました。</p>

          
        </div>
        <footer>
          <section class="social-area">
          <!-- シェアボタン START -->
  <ul class="social-button">
    
    <!-- Twitter -->
    <li>
      <a class="social-btn twitter-btn" target="_blank" href="https://twitter.com/share?url=https://future-architect.github.io/articles/20230327b/&related=twitterapi%2Ctwitter&text=Terraform%201.4%20Update:Private%20Service%20Connect%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%9Fbackend/gcs%E3%81%B8%E3%81%AE%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%20%7C%20%E3%83%95%E3%83%A5%E3%83%BC%E3%83%81%E3%83%A3%E3%83%BC%E6%8A%80%E8%A1%93%E3%83%96%E3%83%AD%E3%82%B0" rel="nofollow noopener">
        <i></i><span class="social-btn-label">3</span>
      </a>
    </li>
    <!-- Facebook -->
    <li>
      <a class="social-btn fb-btn" target="_blank" href="http://www.facebook.com/share.php?u=https://future-architect.github.io/articles/20230327b/&t=Terraform%201.4%20Update:Private%20Service%20Connect%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%9Fbackend/gcs%E3%81%B8%E3%81%AE%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9" rel="nofollow noopener">
        <i></i><span class="social-btn-label">シェア</span>
      </a>
    </li>
    <!-- hatebu -->
    <li>
      <a class="social-btn hatebu-btn" target="_blank" href="https://b.hatena.ne.jp/entry/s/future-architect.github.io/articles/20230327b/" rel="nofollow noopener">
        <i></i><span class="social-btn-label">はてな</span>
      </a>
    </li>
    <!-- pocket -->
    <li>
      <a class="social-btn pocket-btn" target="_blank" href="https://getpocket.com/save?url=https://future-architect.github.io/articles/20230327b/" rel="nofollow noopener">
        <i></i><span class="social-btn-label">1</span>
      </a>
    </li>
    
  </ul>
<!-- シェアボタン END -->

          </section>
          <aside>
            <section class="related-post margin-bottom-40 nav">
              <h2 id="related"><a href="#related" class="headerlink" title="関連記事"></a>関連記事</h2>
              
  <div class="widget">
    <ul class="nav related-post-link"><li class="related-posts-item"><span>2023.03.31</span><span class="snscount">&#9825;17</span><a href=/articles/20230331a/ title="最近、Terraform内での機密情報の取り扱いについて触れることがあり、Terraformのv1.4のInteractive input for sensitive variables is now masked in the UI (#29520) についてのENHANCEMENTを取り上げつつ、Terraform環境上での機密情報の取り扱いについて..">Terraformでの機密情報の取り扱い on Google Cloud<span class="newitem">NEW</span></a></li><li class="related-posts-item"><span>2023.03.30</span><span class="snscount">&#9825;8</span><a href=/articles/20230330a/ title="プロジェクトでJenikisを利用する機会があり、初めてJenkinsfileでTerraformのCI/CD環境を構築する機会があったので記事に残そうと思います。クラウドを使っているとAWSではCodeBuild、Google CloudではCloudBuildのサービスをCI/CD環境として利用するのでyamlでのCI/CDスクリプトには慣れていましたが...">JenkinsでのTerraform CI/CD<span class="newitem">NEW</span></a></li><li class="related-posts-item"><span>2023.04.07</span><span class="snscount">&#9825;7</span><a href=/articles/20230407a/ title="Terraformのv1.0が出て約2年弱、ついにv1.4までやってきました。Terraformのv1.4のリリースノートの、ENHANCEMENTのうち、私個人が特に気になった機能を見つつ、ユースケースが考えられるものについて探れればと思います。">Terraform v1.4のリリースノートを眺める<span class="newitem">NEW</span></a></li><li class="related-posts-item"><span>2023.03.27</span><span class="snscount">&#9825;20</span><a href=/articles/20230327a/ title="Terraform連載のインデックス記事です。最近では当社も前提としてクラウドを利用する案件が増えてきました。その際に利用するツールとしては">Terraform連載2023を開始します<span class="newitem">NEW</span></a></li><li class="related-posts-item"><span>2023.02.10</span><span class="snscount">&#9825;10</span><a href=/articles/20230210a/ title="こんにちは！筋肉エンジニアの渡邉です。最近はGCP/GKEについて勉強しています。今回はGitHubへのPushをトリガーにCloudBuildを起動し、プライベートエンドポイントのみのGKEへデプロイする基盤を作りましたので、共有したいと思います。GCPリソースはTerraformで作成しています。">CloudBuildを使ってプライベートエンドポイントのみのGKEへデプロイ</a></li><li class="related-posts-item"><span>2023.01.13</span><span class="snscount">&#9825;16</span><a href=/articles/20230113a/ title="GKE を利用したWebアプリケーションのGoogleアカウント認証について記事を書きます。公式ドキュメントを引用します。IAP を使用すると、HTTPS によってアクセスされるアプリケーションの一元的な承認レイヤを確立できるため、ネットワーク レベルのファイアウォールに頼らずに、アプリケーション レベルのアクセス制御モデルを使用できます。">GKEでIdentity-Aware Proxyを利用したWebアプリケーション認証</a></li></ul>
  </div>
            </section>
            <section class="reference-post margin-bottom-40 nav">
              
  <div class="card">
    <div id="reference" class="reference-lede"><a href="#reference" class="headerlink" title="参照されている記事"></a>この記事を参照している記事</div>
    <ul class="reference-post-link"><li class="reference-posts-item"><a href=/articles/20230407a/ title="Terraformのv1.0が出て約2年弱、ついにv1.4までやってきました。Terraformのv1.4のリリースノートの、ENHANCEMENTのうち、私個人が特に気になった機能を見つつ、ユースケースが考えられるものについて探れればと思います。">Terraform v1.4のリリースノートを眺める<span class="newitem">NEW</span></a></li><li class="reference-posts-item"><a href=/articles/20230327a/ title="Terraform連載のインデックス記事です。最近では当社も前提としてクラウドを利用する案件が増えてきました。その際に利用するツールとしては">Terraform連載2023を開始します<span class="newitem">NEW</span></a></li></ul>
  </div>
            </section>
          </aside>
        </footer>
      </div>
    </article>
  </main>
  <aside class="col-md-3 blog-sidebar">
    <!-- START SIDEBAR  -->


<section class="toc-section">
  <h2 class="margin-top-30">目次</h2>
  <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%9D%E3%82%81%E3%81%AB"><span class="toc-text">初めに</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Private-Service-Connect%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%AA%E3%81%84%E6%A7%8B%E6%88%90"><span class="toc-text">Private Service Connectを利用しない構成</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Private-Service-Connect%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%9F%E6%A7%8B%E6%88%90"><span class="toc-text">Private Service Connectを利用した構成</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Private-Service-Connect%E3%81%A8%E3%81%AF"><span class="toc-text">Private Service Connectとは</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Private-Service-Connect%E3%81%AE%E4%BD%9C%E6%88%90"><span class="toc-text">Private Service Connectの作成</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Terraform-%E3%81%AE%E8%A8%AD%E5%AE%9A"><span class="toc-text">Terraform の設定</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Private-Service-Connect%E7%B5%8C%E7%94%B1%E3%81%AEGCS%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E7%A2%BA%E8%AA%8D"><span class="toc-text">Private Service Connect経由のGCSアクセス確認</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Terraform-Backend%E3%81%AE%E8%A8%AD%E5%AE%9A"><span class="toc-text">Terraform Backendの設定</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tcpdump%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%9FPrivate-Service-Connect%E7%B5%8C%E7%94%B1%E3%81%AEGCS%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E7%A2%BA%E8%AA%8D"><span class="toc-text">tcpdumpを利用したPrivate Service Connect経由のGCSアクセス確認</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BD%99%E8%AB%87"><span class="toc-text">余談</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9C%80%E5%BE%8C%E3%81%AB"><span class="toc-text">最後に</span></a></li></ol>
</section>

<section class="category">
<h2 class="margin-top-30">カテゴリー</h2>
<div class="widget">
  <ul class="nav sidebar-categories margin-bottom-40">
  
  <li class=""><a href="/categories/Programming/">Programming (369)</a></li>
<li class=""><a href="/categories/Infrastructure/">Infrastructure (217)</a></li>
<li class=""><a href="/categories/Culture/">Culture (86)</a></li>
<li class=""><a href="/categories/DataScience/">DataScience (50)</a></li>
<li class=""><a href="/categories/IoT/">IoT (32)</a></li>
<li class=""><a href="/categories/DB/">DB (22)</a></li>
<li class=""><a href="/categories/Business/">Business (21)</a></li>
<li class=""><a href="/categories/%E8%AA%8D%E8%A8%BC%E8%AA%8D%E5%8F%AF/">認証認可 (20)</a></li>
<li class=""><a href="/categories/DevOps/">DevOps (18)</a></li>
<li class=""><a href="/categories/Management/">Management (14)</a></li>
<li class=""><a href="/categories/VR/">VR (12)</a></li>
<li class=""><a href="/categories/Design/">Design (11)</a></li>
<li class=""><a href="/categories/Security/">Security (9)</a></li>

  </ul>
</div>

</section>
<section class="podcast-link">
<h2 class="margin-top-30">Tech Cast</h2>

  <div class="class="widget-wrap">
  <div class="widget">
    <ul class="nav techcast">
      <li><a href="https://podcasters.spotify.com/pod/show/futuretechcast/episodes/37-e227p84" title="フューチャーがお届けするポッドキャストです。#37 自然言語処理を使った文書検索エンジンシステム開発と新規サービス検討（後編）" target="_blank" rel="noopener"><span class="newitem">NEW</span> #37 自然言語処理を使った文書検索エンジンシステム開発と新規サービス検討（後編）</a></li>
<li><a href="https://podcasters.spotify.com/pod/show/futuretechcast/episodes/36-e1rdbcu" title="フューチャーがお届けするポッドキャストです。#36 自然言語処理を使った文書検索エンジンシステム開発と新規サービス検討（前編）" target="_blank" rel="noopener"><span class="newitem">NEW</span> #36 自然言語処理を使った文書検索エンジンシステム開発と新規サービス検討（前編）</a></li>
<li><a href="https://podcasters.spotify.com/pod/show/futuretechcast/episodes/35-MLOps-e1qe4st" title="フューチャーがお届けするポッドキャストです。#35 MLOpsエンジニアって何やるの？（後編）" target="_blank" rel="noopener"> #35 MLOpsエンジニアって何やるの？（後編）</a></li>
    </ul>
  </div>
  </div>
  
</section>
<section class="advent-calendar">
<h2 class="margin-top-30">アドベントカレンダー</h2>
<div class="widget">
  <ul class="nav-flex">
    <li><a href="http://qiita.com/advent-calendar/2022/future" title="フューチャー Advent Calendar 2022 #Qiita" target="_blank" rel="noopener">2022年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2021/future" title="フューチャー Advent Calendar 2021 #Qiita" target="_blank" rel="noopener">2021年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2020/future" title="フューチャー Advent Calendar 2020 #Qiita" target="_blank" rel="noopener">2020年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2019/future" title="フューチャー Advent Calendar 2019 #Qiita" target="_blank" rel="noopener">2019年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2018/future" title="フューチャー Advent Calendar 2018 #Qiita" target="_blank" rel="noopener">2018年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2017/future" title="フューチャー Advent Calendar 2017 #Qiita" target="_blank" rel="noopener">2017年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2016/future" title="フューチャー Advent Calendar 2016 #Qiita" target="_blank" rel="noopener">2016年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2015/future" title="フューチャー Advent Calendar 2015 #Qiita" target="_blank" rel="noopener">2015年</a></li>
  </ul>
</div>

</section>
<!-- END SIDEBAR -->

  </aside>
</div>

  </section>
</div>

      <!-- BEGIN PRE-FOOTER -->
    <footer>
      <div class="pre-footer">
        <div class="container">
          <div class="row">
            <div class="col-lg-4 col-md-4 col-sm-6 col-6 pre-footer-col">
              <h2>About Us</h2>
              <p>経営とITをデザインする、フューチャーの技術ブログです。業務で利用している幅広い技術について紹介します。<br /><br /><a target="_blank" rel="noopener" href="http://www.future.co.jp/">http://www.future.co.jp/</a></p>
              <div class="social-btn twitter-btn twitter-follow-btn">
                <a href="https://twitter.com/intent/follow?screen_name=future_techblog " target="_blank" rel="nofollow noopener">
                  <i></i><span class="tw-btn-label">フューチャー技術ブログをフォロー</span>
                </a>
              </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-4 col-4 pre-footer-col">
              <h2>Contact</h2>
              <address class="margin-bottom-40">
                <a href="https://www.future.co.jp/recruit/recruit/rec-fresh/" title="新卒採用" target="_blank" rel="noopener">新卒採用</a><br>
                <a href="https://www.future.co.jp/recruit/recruit/rec-career/" title="キャリア採用" target="_blank" rel="noopener">キャリア採用</a><br>
                <a href="https://www.future.co.jp/contact_us/" title="お問い合わせページ" target="_blank" rel="noopener">お問い合わせ</a><br>
                <a href="https://www.future.co.jp/architect/socialmediapolicy/" title="ソーシャルメディアポリシー" target="_blank" rel="noopener">メディアポリシー</a><br><br>
                <a href="mailto:techblog@future.co.jp">techblog@future.co.jp</a>
              </address>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 col-6 pre-footer-col">
              <h2>Contents</h2>
              <a href="https://future-architect.github.io/coding-standards/" title="Future Enterprise Coding Standards" target="_blank" rel="noopener">コーディング規約</a><br>
              <a href="https://future-architect.github.io/typescript-guide/" title="仕事ですぐに使えるTypeScript" target="_blank" rel="noopener">仕事ですぐに使えるTypeScript</a><br>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-3 col-3 pre-footer-col">
              <h2>Event</h2>
              <a href="https://future.connpass.com/" title="経営とITをデザインするフューチャーの勉強会です" target="_blank" rel="noopener">connpass</a><br>
              <a href="https://www.future.co.jp/futureinsightseminar/" title="フューチャーインサイトセミナー" target="_blank" rel="noopener">Webセミナー</a><br>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-3 col-3 pre-footer-col">
              <h2>SNS</h2>
              <a href="https://github.com/future-architect" title="Future's official open source repositories" target="_blank" rel="noopener">GitHub</a><br>
              <a href="https://qiita.com/organizations/future" title="フューチャーのQiita Organizationです" target="_blank" rel="noopener">Qiita</a><br>
              <a href="https://note.future.co.jp/" title="フューチャーの公式note" target="_blank" rel="noopener">未来報</a><br>
              <a href="https://www.youtube.com/channel/UCJUSwYYd0CkGgmEKAW7QVpw" title="フューチャーYoutubeチャネル" target="_blank" rel="noopener">Youtube</a>
            </div>
          </div>
        </div>
      </div>
      <div class="footer">
        <div class="container">
          <div class="row">
            <div class="col-md-6 col-sm-6 padding-top-10">
              &copy; 2023 フューチャー技術ブログ<br>
            </div>
          </div>
        </div>
      </div>
    </footer>

  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-X1C28R8H0M"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-X1C28R8H0M');
  gtag('config', 'UA-74047147-1'); // 過渡期対応
</script>

  </div>
</body>
</html>
