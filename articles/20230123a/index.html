<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <!--
    ███████╗██╗░░░██╗████████╗██╗░░░██╗██████╗░███████╗
    ██╔════╝██║░░░██║╚══██╔══╝██║░░░██║██╔══██╗██╔════╝
    █████╗░░██║░░░██║░░░██║░░░██║░░░██║██████╔╝█████╗░░
    ██╔══╝░░██║░░░██║░░░██║░░░██║░░░██║██╔══██╗██╔══╝░░
    ██║░░░░░╚██████╔╝░░░██║░░░╚██████╔╝██║░░██║███████╗
    ╚═╝░░░░░░╚═════╝░░░░╚═╝░░░░╚═════╝░╚═╝░░╚═╝╚══════╝
    ████████╗███████╗░█████╗░██╗░░██╗
    ╚══██╔══╝██╔════╝██╔══██╗██║░░██║
    ░░░██║░░░█████╗░░██║░░╚═╝███████║
    ░░░██║░░░██╔══╝░░██║░░██╗██╔══██║
    ░░░██║░░░███████╗╚█████╔╝██║░░██║
    ░░░╚═╝░░░╚══════╝░╚════╝░╚═╝░░╚═╝
    ██████╗░██╗░░░░░░█████╗░░██████╗░
    ██╔══██╗██║░░░░░██╔══██╗██╔════╝░
    ██████╦╝██║░░░░░██║░░██║██║░░██╗░
    ██╔══██╗██║░░░░░██║░░██║██║░░╚██╗
    ██████╦╝███████╗╚█████╔╝╚██████╔╝
    ╚═════╝░╚══════╝░╚════╝░░╚═════╝░
    Welcome engineer.
    https://www.future.co.jp/recruit/
  -->
  
  <title>Go 1.20リリース連載が始まります＆メモリアリーナの紹介＆落ち穂拾い | フューチャー技術ブログ</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  
  <meta name="description" content="フューチャーのテックブログ恒例のGoの新バージョンリリース記念のブログが始まります。この執筆時点でrc3が出ています。かつてこんな順調なことがあったでしょうか？    Date Title Author    1&#x2F;23(月) メモリアリーナの紹介＆落ち穂拾い 澁川喜規   1&#x2F;24(火) contextパッケージのWithCancelCauseとCause 真野隼記さん   1">
<meta property="og:type" content="article">
<meta property="og:title" content="Go 1.20リリース連載が始まります＆メモリアリーナの紹介＆落ち穂拾い | フューチャー技術ブログ">
<meta property="og:url" content="https://future-architect.github.io/articles/20230123a/index.html">
<meta property="og:site_name" content="フューチャー技術ブログ">
<meta property="og:description" content="フューチャーのテックブログ恒例のGoの新バージョンリリース記念のブログが始まります。この執筆時点でrc3が出ています。かつてこんな順調なことがあったでしょうか？    Date Title Author    1&#x2F;23(月) メモリアリーナの紹介＆落ち穂拾い 澁川喜規   1&#x2F;24(火) contextパッケージのWithCancelCauseとCause 真野隼記さん   1">
<meta property="og:locale" content="ja_JP">
<meta property="og:image" content="https://future-architect.github.io/images/20230123a/スクリーンショット_2023-01-18_0.08.44.png">
<meta property="og:image" content="https://future-architect.github.io/images/20230123a/スクリーンショット_2023-01-18_0.13.05.png">
<meta property="article:published_time" content="2023-01-22T15:00:00.000Z">
<meta property="article:modified_time" content="2023-02-03T04:35:28.729Z">
<meta property="article:tag" content="Go">
<meta property="article:tag" content="インデックス">
<meta property="article:tag" content="Go1.20">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://future-architect.github.io/images/20230123a/スクリーンショット_2023-01-18_0.08.44.png">
  
  <link rel="alternate" href="/atom.xml" title="フューチャー技術ブログ" type="application/atom+xml">
  
  <link rel="icon" href="/favicon.ico">
  <link rel="apple-touch-icon" sizes='180x180' href="/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes='57x57' href="/apple-touch-icon-57x57.png">
  <link rel="canonical" href="https://future-architect.github.io/articles/20230123a/">
  <meta content="Go,インデックス,Go1.20" name="keywords">
  <meta content="澁川喜規" name="author">
  <link rel="preload" as="image" href="/banner.jpg" />
  <link rel='manifest' href='/manifest.webmanifest'/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">
  <link rel="stylesheet" href="/metronic/assets/style.css">
  <link rel="stylesheet" href="/css/theme-styles.css">
<meta name="generator" content="Hexo 5.4.2"></head>

<body class="corporate">
  <div class="wrap" itemscope itemtype="https://schema.org/TechArticle">
  <!-- BEGIN HEADER -->
<header class="header">
	<div class="header-overlay">
		<div class="header-menu"></div>
		<div class="header-title"><a href="/">Future Tech Blog</a></div>
		<div class="header-title-sub">フューチャー技術ブログ</div>
	</div>
</header>
<!-- Header END -->

  <div class="container">
  <ul class="breadcrumb">
    <li><a href="/">Home</a></li>
    <li><a href="/articles/">Blog</a></li>
    <li class="active">Post</li>
  </ul>
  <section id="main" class="margin-top-30">
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Programming/">Programmingカテゴリ</a>
  </div>


    <h2 itemprop="name" class="article-title">Go 1.20リリース連載が始まります＆メモリアリーナの紹介＆落ち穂拾い
  
  <a target="_blank" rel="noopener" href="https://github.com/future-architect/tech-blog/edit/master/source/_posts/20230123a_Go_1.20リリース連載が始まります＆メモリアリーナの紹介＆落ち穂拾い.md" title="Suggest Edits" class="github-edit"><i class="github-edit-icon"></i></a>
  
</h2>

    <div class="row">
  <main class="col-md-9 blog-posts">
    <article id="post-20230123a_Go_1.20リリース連載が始まります＆メモリアリーナの紹介＆落ち穂拾い" class="article article-type-post blog-item" itemscope itemprop="blogPost">
      <div class="article-inner">
        
        <header class="article-header">
          <ul class="blog-info">
            <li class="blog-info-item"><a href="/articles/2023/" class="publish-date"><time datetime="2023-01-22T15:00:00.000Z" itemprop="datePublished">2023.01.23</time></a>
</li>
            <li class="blog-info-item"><li><a href="/authors/%E6%BE%81%E5%B7%9D%E5%96%9C%E8%A6%8F" title="澁川喜規さんの記事一覧へ" class="post-author">澁川喜規</a></li></li>
            <li class="blog-info-item">
  
    
    <a href="/tags/Go/" title="Goタグの記事へ" class="tag-list-link">Go言語</a>
  
    
    <a href="/tags/インデックス/" title="インデックスタグの記事へ" class="tag-list-link">インデックス</a>
  
    
    <a href="/tags/Go1-20/" title="Go1.20タグの記事へ" class="tag-list-link">Go1.20</a>
  

</li>
          </ul>
          </header>
        
        <div class="article-entry" itemprop="articleBody">
          
            <p>フューチャーのテックブログ恒例のGoの新バージョンリリース記念のブログが始まります。この執筆時点でrc3が出ています。かつてこんな順調なことがあったでしょうか？</p>
<div class="scroll"><table>
<thead>
<tr>
<th align="center">Date</th>
<th align="left">Title</th>
<th align="left">Author</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1&#x2F;23(月)</td>
<td align="left">メモリアリーナの紹介＆落ち穂拾い</td>
<td align="left">澁川喜規</td>
</tr>
<tr>
<td align="center">1&#x2F;24(火)</td>
<td align="left"><a href="/articles/20230125a/">contextパッケージのWithCancelCauseとCause</a></td>
<td align="left">真野隼記さん</td>
</tr>
<tr>
<td align="center">1&#x2F;25(水)</td>
<td align="left"><a href="/articles/20230126a/">Wrapping multiple errors</a></td>
<td align="left">川口翔大さん</td>
</tr>
<tr>
<td align="center">1&#x2F;26(木)</td>
<td align="left"><a href="/articles/20230127a/">timeのアップデート</a></td>
<td align="left">宮永崇史さん</td>
</tr>
<tr>
<td align="center">1&#x2F;27(金)</td>
<td align="left"><a href="/articles/20230128a/">HTTP ResponseController</a></td>
<td align="left">辻大志郎さん</td>
</tr>
<tr>
<td align="center">1&#x2F;30(月)</td>
<td align="left"><a href="/articles/20230131a/">New ReverseProxy Rewrite hook を動かしながら理解する</a></td>
<td align="left">棚井龍之介さん</td>
</tr>
<tr>
<td align="center">1&#x2F;31(火)</td>
<td align="left"><a href="/articles/20230202a/">vetのアップデート</a></td>
<td align="left">今泉智義さん</td>
</tr>
<tr>
<td align="center">2&#x2F;1(水)</td>
<td align="left"><a href="/articles/20230203a/">go build に追加される cover オプション（利用例付き）</a></td>
<td align="left">藤井亮佑さん</td>
</tr>
</tbody></table></div>
<p>初回は、メモリアリーナの紹介ついでに、他の人が触れない残ったネタも紹介します。</p>
<h1 id="メモリアリーナとは"><a href="#メモリアリーナとは" class="headerlink" title="メモリアリーナとは"></a>メモリアリーナとは</h1><p>メモリアリーナについては以下のプロポーザルで提案されたものです。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/golang/go/issues/51317">proposal: arena: new package providing memory arenas</a></li>
</ul>
<p>Goはガベージコレクタを備えた言語ですが、ガベージコレクタは実行時にコストが多少かかります。メモリをスキャンし、他から参照されていないかどうかを探索する必要があるからです。メモリアリーナとして、あらかじめGC対象外のメモリ領域を手動で確保することで、GCがオブジェクトを探索するコストなどが節約できて、15%ほどの性能向上があった、とプロポーザルにはあります。</p>
<p>しかし、メモリの解放を手動で行う必要があったり、本質的に「危険」な機能であるし、プロポーザルで提案されている使い方（protobufのデコードとか）以外はほとんどパフォーマンスに寄与しない可能性もあります。</p>
<h2 id="ドキュメントがない？どこにあるの？"><a href="#ドキュメントがない？どこにあるの？" class="headerlink" title="ドキュメントがない？どこにあるの？"></a>ドキュメントがない？どこにあるの？</h2><p>Goは開発版のリリースノートやライブラリリファレンスも公開してくれています。さっそく、arenaパッケージのドキュメントを見てみましょう！</p>
<p><a target="_blank" rel="noopener" href="https://pkg.go.dev/std@go1.20rc3">https://pkg.go.dev/std@go1.20rc3</a></p>
<p>と思ったけどない？インストールすると、確かに<code>$GOROOT/src/arena</code>フォルダは存在します。フォルダがあるならローカルのgodocで見られそうなのでgodocを入れて見てみます。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ go install golang.org/x/tools/cmd/godoc@latest</span><br><span class="line">$ godoc</span><br></pre></td></tr></table></figure>

<p>しかし、これでもリファレンスは表示されず、パッケージドキュメントしか表示されません。</p>
<img src="/images/20230123a/スクリーンショット_2023-01-18_0.08.44.png" alt="スクリーンショット_2023-01-18_0.08.44.png" width="1200" height="684" loading="lazy">

<p>この機能はオプトインで動くもので、ビルドの時に環境変数が必要だったことを思い出し、これを指定するとようやく見れました！機能はシンプルですね。　ちなみに、これを書く時にまったく違う<a target="_blank" rel="noopener" href="https://pkg.go.dev/github.com/google/gapid@v1.6.1/core/memory/arena">同名のライブラリ</a>を見て、ふむふむと読んでいたのですが、本家の方は検索では出てこないのでみなさまもお気をつけください。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ GOEXPERIMENT=arenas godoc</span><br></pre></td></tr></table></figure>

<img src="/images/20230123a/スクリーンショット_2023-01-18_0.13.05.png" alt="スクリーンショット_2023-01-18_0.13.05.png" width="758" height="402" loading="lazy">

<p>使い方はシンプルですね。</p>
<ul>
<li>まずは <code>arena.NewArena()</code>で<code>*Arena</code>を作成</li>
<li>使い終わったら <code>Free()</code>メソッドを呼び出す</li>
<li><code>arena.MakeSlice[Type](arena)</code>や<code>arena.New[Type](arena)</code>といった関数を使ってアリーナ内部のメモリを利用</li>
<li><code>arena.Clone(obj)</code>を使うと、アリーナが終了しても残るよう、ヒープに値を移動する(浅いコピー)</li>
</ul>
<p>Goはメソッドのジェネリクスが使えないのですが、そのかわりに、1番目の引数に値を取るジェネリクスなヘルパー関数を用意するという、C言語でオブジェクト指向している時代のような設計をすることで代替するというテクニックが使われていますね。</p>
<h2 id="ベンチマーク"><a href="#ベンチマーク" class="headerlink" title="ベンチマーク"></a>ベンチマーク</h2><p>小さいオブジェクトをたくさん確保するユースケースで性能差が出るということで、標準ライブラリのリンクドリストのcontainer&#x2F;listをちょびっと改造してみました。<code>Element</code>はポインタが3つと<code>interface&#123;&#125;</code>を1つ持つ構造体です。<code>interface</code>にポインタを入れるとしたら４０バイト(インタフェースはポインタ2つ保持するので)の値のメモリの確保にarenaを利用する、というユースケースになります。</p>
<p>既存のコードのメモリ確保部分をいじるだけであれば、そんなに難しくないですね。</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+import (</span></span><br><span class="line"><span class="addition">+	&quot;arena&quot;</span></span><br><span class="line"><span class="addition">+)</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> // Element is an element of a linked list.</span><br><span class="line"> type Element struct &#123;</span><br><span class="line"> 	// Next and previous pointers in the doubly-linked list of elements.</span><br><span class="line"><span class="meta">@@ -48,6 +52,7 @@</span></span><br><span class="line"> type List struct &#123;</span><br><span class="line"> 	root Element // sentinel list element, only &amp;root, root.prev, and root.next are used</span><br><span class="line"> 	len  int     // current list length excluding (this) sentinel element</span><br><span class="line"><span class="addition">+	a    *arena.Arena</span></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> // Init initializes or clears list l.</span><br><span class="line"><span class="meta">@@ -59,8 +64,16 @@</span></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> // New returns an initialized list.</span><br><span class="line"><span class="deletion">-func New() *List &#123; return new(List).Init() &#125;</span></span><br><span class="line"><span class="addition">+func NewWithArena(a *arena.Arena) *List &#123;</span></span><br><span class="line"><span class="addition">+	r := arena.New[List](a)</span></span><br><span class="line"><span class="addition">+	r.a = a</span></span><br><span class="line"><span class="addition">+	return r.Init()</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"></span><br><span class="line"> // Len returns the number of elements of list l.</span><br><span class="line"> // The complexity is O(1).</span><br><span class="line"> func (l *List) Len() int &#123; return l.len &#125;</span><br><span class="line"><span class="meta">@@ -101,7 +114,9 @@</span></span><br><span class="line"></span><br><span class="line"> // insertValue is a convenience wrapper for insert(&amp;Element&#123;Value: v&#125;, at).</span><br><span class="line"> func (l *List) insertValue(v any, at *Element) *Element &#123;</span><br><span class="line"><span class="deletion">-	return l.insert(&amp;Element&#123;Value: v&#125;, at)</span></span><br><span class="line"><span class="addition">+	e := arena.New[Element](l.a)</span></span><br><span class="line"><span class="addition">+	e.Value = v</span></span><br><span class="line"><span class="addition">+	return l.insert(e, at)</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>ベンチマークのコードは以下の通りです。通常の実装、arena利用、中に入れる要素もarenaを利用の3つでテストしています。一回に入れる要素数を要素数を1万、10万、100万と変えてみています。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> list2</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;arena&quot;</span></span><br><span class="line">	<span class="string">&quot;container/list&quot;</span></span><br><span class="line">	<span class="string">&quot;testing&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> V <span class="keyword">struct</span> &#123;</span><br><span class="line">	n <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkListWithoutArena</span><span class="params">(b *testing.B)</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> n := <span class="number">0</span>; n &lt; b.N; n++ &#123;</span><br><span class="line">		l := list.New()</span><br><span class="line">		<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++ &#123;</span><br><span class="line">			l.PushBack(&amp;V&#123;i&#125;)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkListWithArena</span><span class="params">(b *testing.B)</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> n := <span class="number">0</span>; n &lt; b.N; n++ &#123;</span><br><span class="line">		a := arena.NewArena()</span><br><span class="line">		l := NewWithArena(a)</span><br><span class="line">		<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++ &#123;</span><br><span class="line">			l.PushBack(&amp;V&#123;i&#125;) <span class="comment">// valueはarena使わず</span></span><br><span class="line">		&#125;</span><br><span class="line">		a.Free()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkListWithArena2</span><span class="params">(b *testing.B)</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> n := <span class="number">0</span>; n &lt; b.N; n++ &#123;</span><br><span class="line">		a := arena.NewArena()</span><br><span class="line">		l := NewWithArena(a)</span><br><span class="line">		<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++ &#123;</span><br><span class="line">			v := arena.New[V](a) <span class="comment">// valueもarena利用</span></span><br><span class="line">			v.n = i</span><br><span class="line">			l.PushBack(v)</span><br><span class="line">		&#125;</span><br><span class="line">		a.Free()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>結果は以下の通りです。1万要素程度だとほとんど差がつきません。10万ぐらいになるとだいぶ差が・・・という感じです。ちなみに、最初に書いたときは<code>Free()</code>を書き忘れてしまいました。そうしたら処理時間が3倍になってました。要注意です。</p>
<div class="scroll"><table>
<thead>
<tr>
<th align="center">方式＼要素数</th>
<th align="center">10,000</th>
<th align="center">100,000</th>
<th align="center">1,000,000</th>
</tr>
</thead>
<tbody><tr>
<td align="center">標準のメモリ戦略</td>
<td align="center">0.30mS</td>
<td align="center">4.58mS</td>
<td align="center">62.07mS</td>
</tr>
<tr>
<td align="center">arena利用(Elementのみ)</td>
<td align="center">0.29mS (-4.2%)</td>
<td align="center">2.77mS (-39.5%)</td>
<td align="center">28.00mS (-54.9%)</td>
</tr>
<tr>
<td align="center">arena利用(valueも利用)</td>
<td align="center">0.28mS (-8.4%)</td>
<td align="center">2.65mS (-42.1%)</td>
<td align="center">26.80mS (-56.8%)</td>
</tr>
</tbody></table></div>
<h2 id="どこで使えるのか？"><a href="#どこで使えるのか？" class="headerlink" title="どこで使えるのか？"></a>どこで使えるのか？</h2><p>パフォーマンスがあがる！素敵！じゃあ明日からガンガン使う！ということにはならなそうなのが今回の機能です。なんといっても、コンパイラのフラグをセットしないと使えません。後述のライフサイクルを考えると、APIの形がアリーナ利用とそうでない場合で変わる可能性があり、公開するライブラリだと、後方互換性を考えると、最低でも1.21がリリースされ、1.20がサポートされている最低バージョンになってから、となるかもしれません。そもそもExperimentalが外れてからその次、の方がいいかもしれません。もちろん、個別のアプリで使うなら自己責任ですぐにでも使えるとは思います。</p>
<h2 id="ユースケースには何があるか？"><a href="#ユースケースには何があるか？" class="headerlink" title="ユースケースには何があるか？"></a>ユースケースには何があるか？</h2><p>そもそも、小さいメモリをたくさん使う、というユースケースがどこにあるのか、というところが問題です。一番考えられるのが何かしらの木構造の処理ですね。あとは常駐プロセスでたくさんのオブジェクトを扱うケースです。考えられるのはだいたいこんな感じでしょうか？</p>
<ul>
<li>XMLのパース（Excelのパース)</li>
<li>言語処理系の構文木</li>
<li>HTMLのサーバーサイドレンダリング（DOMツリー）</li>
<li>RDB自作勢（タプルなどの内部のデータ管理）</li>
</ul>
<p>一番上が一番有望なユースケースな気がしています。というのも、前職で作ったExcelからのマスターデータ変換はプロファイルを取ると、ほとんどがメモリ確保の処理時間でした。Goのxmlパッケージは<a target="_blank" rel="noopener" href="https://github.com/golang/go/issues/21823">処理が遅いというissue</a>も上がっていたりします。最近のGoでは試していないですが、attributeとかをパースのときにそれぞれメモリ確保して格納しているようなところが遅かったと記憶しています。</p>
<h2 id="ライフサイクル管理とAPI設計の考察"><a href="#ライフサイクル管理とAPI設計の考察" class="headerlink" title="ライフサイクル管理とAPI設計の考察"></a>ライフサイクル管理とAPI設計の考察</h2><p>もう1つあるのが、Arenaのライフサイクルの戦略をどうするか、です。たとえば、Excelのファイルのパースであれば1ファイルごとにArenaを作る方法もあります。ただし、同時処理数の最大が見えていて、最大メモリ量が見積もれるのであれば、複数のExcelファイルを処理するのに、1つのArenaを共有し、sync.Pool的な再利用の仕組みも作って載せる、というのが一番効率よくなりそうです。</p>
<p>ただし、Arena上のメモリの解放はArena一括で行う必要があります。徐々にメモリが少なくなったからといって、「じゃあGC実行して開けよう」みたいなことはできません。データベースのような仕組みを作るのであれば、自分で確保したメモリの量も見ながら、ときどきArenaにメモリを返す、みたいなメモリ管理の仕組みを自作する必要があるかもしれません。</p>
<p>僕が最初に間違って読んでいた<a target="_blank" rel="noopener" href="https://pkg.go.dev/github.com/google/gapid@v1.6.1/core/memory/arena">Google製の同名のライブラリ</a>では<code>context.Context</code>にArenaを登録したり取り出せるAPIがありましたが、これと同じように<code>context.Context</code>と同じライフサイクルで使う、というのも1つの手かと思います。そうすると、ある程度まとまった処理単位でArenaを共有する、といったことが可能となりますし、アリーナ利用とそうでない場合にAPIを変えずにできます（あまり良いことでもないかもですが）。プロポーザルの議論の中でもこのようなリクエスト単位での解放というのが紹介されていました。</p>
<p>ライブラリのAPIとしては、最低限、Arenaを外から渡せるように、という口の用意すれば、使う側で、これらの戦略を利用者が選べるので良さそうですね。あとは、レスポンスで返すオブジェクトをヒープにするか、Arenaの上に作るかはオプションで指定できる必要もありそうです。たとえば、Excelのパースであれば、XMLのメモリはArena上において、Excelとして処理するライブラリが使い終わったらXMLのメモリを解放してあげて、ブックの値はヒープにおいておくことでユーザーに返す、というのが可能です。最終的に返すブックがArenaだと、それを使う間はArenaの解放はできません。ただし、Excelから値を読み取って作ったドメインオブジェクトが必要なレスポンスであれば、ブックがArenaでも良い（ドメインオブジェクトを作ったら不要になる)となります。誰がどう使うかでどちらにあると良いかが変わってきてしまうので、汎用的なライブラリを作るなら明示的に指定できる必要がありそうです。</p>
<p>ビルド時に環境変数を指定するのですが、環境変数だと条件コンパイルに使えないので、別途ビルドタグでArenaなし版のみをビルドするように、というのも1.21が出るまでは必要そうですね。</p>
<h2 id="Arenaから追い出されないように気を付ける-x2F-開放後はArenaを触らないようにする"><a href="#Arenaから追い出されないように気を付ける-x2F-開放後はArenaを触らないようにする" class="headerlink" title="Arenaから追い出されないように気を付ける&#x2F;開放後はArenaを触らないようにする"></a>Arenaから追い出されないように気を付ける&#x2F;開放後はArenaを触らないようにする</h2><p>Arenaを活用するには、そこでメモリを確保して、そこをきちんと使う必要がありますが、Goの場合はエスケープ処理が便利かつ強力なので、ヒープ側にメモリが確保されてGC対象になってしまう可能性があります。Arenaをせっかく使うのであれば、Arenaから追い出されないようにする必要があります。</p>
<ul>
<li>スライスは<code>arena.MakeSlice[Type](a)</code>で毎回確保する。可変長として使おうとして<code>append()</code>をすると、伸長するために新しいメモリ領域を確保するためにヒープに逃げていってしまい、Arenaから外に出てしまうので、次のように伸長する必要がある場合は再度<code>arena.MakeSlice[Type](a)</code>で確保してコピーを自前でやる必要がある。ただし、伸長したときに、前のスライスのメモリがArenaを解放するまでは残り続けるため、やはり基本的に固定長のみで運用で、可変長で扱わない方が良さそう。</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	mem := arena.NewArena()</span><br><span class="line">	s := arena.MakeSlice[<span class="type">int</span>](mem, <span class="number">10</span>, <span class="number">10</span>)</span><br><span class="line">	s = Append(mem, s, <span class="number">11</span>)</span><br><span class="line">	log.Println(s)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Append</span>[<span class="title">T</span> <span class="title">any</span>]<span class="params">(mem *arena.Arena, s []T, v T)</span></span> []T &#123;</span><br><span class="line">	l := <span class="built_in">len</span>(s)</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">cap</span>(s) == l &#123;</span><br><span class="line">		newS := arena.MakeSlice[T](mem, l+<span class="number">1</span>, l*<span class="number">2</span>)</span><br><span class="line">		<span class="built_in">copy</span>(newS, s)</span><br><span class="line">		newS[l] = v</span><br><span class="line">		<span class="keyword">return</span> newS</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">append</span>(s, v)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>文字列も、<code>[]byte</code>としてArenaに置いておく必要がある（以下のコード参照）。</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">src := <span class="string">&quot;source string&quot;</span></span><br><span class="line"></span><br><span class="line">mem := arena.NewArena()</span><br><span class="line"><span class="keyword">defer</span> mem.Free()</span><br><span class="line"></span><br><span class="line">bs := arena.MakeSlice[<span class="type">byte</span>](mem, <span class="built_in">len</span>(src), <span class="built_in">len</span>(src))</span><br><span class="line"><span class="built_in">copy</span>(bs, src)</span><br><span class="line">str := unsafe.String(&amp;bs[<span class="number">0</span>], <span class="built_in">len</span>(bs))</span><br></pre></td></tr></table></figure>

<ul>
<li>mapやchanはArenaを使う版がないので、必要であれば作る必要がある。ただし、chanはそこまで大量に作って・・・ということもなさそうなので、問題はない気がします。mapが必要であれば頑張って実装する必要がありますね。</li>
</ul>
<p>文字列は<a target="_blank" rel="noopener" href="https://uptrace.dev/blog/posts/go-memory-arena.html">Uptraceのブログ</a>のブログから引用しました。</p>
<p>もう1つはアリーナが解放された後にアリーナの中のメモリを触らない、というのもあります。<code>go run -asan main.go</code>のようにアドレスサニタイザーを有効にして実行すると、このようなエラーは検知できます。アリーナ解放後も利用する必要がある値は<code>arena.Clone()</code>を使って、ヒープに逃してあげましょう。</p>
<h2 id="アリーナのまとめ"><a href="#アリーナのまとめ" class="headerlink" title="アリーナのまとめ"></a>アリーナのまとめ</h2><p>マイクロベンチマークで性能が2倍以上になる、というのをやってみました。Uptraceのブログでも2分探索のコードを改造して使っていたので、この手の小さなメモリをたくさん使うケースに適用すると良さそうです。</p>
<p>ただし、APIデザインを考えると、汎用的な設計を作るのは結構大変そうだな、と思いました。</p>
<h1 id="その他の小ネタ"><a href="#その他の小ネタ" class="headerlink" title="その他の小ネタ"></a>その他の小ネタ</h1><p>コンパイラとかcgo周りとか細かくいろいろアップデートがあります。CGo依存でデフォルトで実装されていたmacOSが非依存になったりして、デフォルトのmac上のビルドとクロスビルドで違いがなくなりました（他のCGo依存ライブラリがない場合）。まあ、大きく実装が変わるとかに関わるものは今のところなさそう？CPUアーキテクチャのサブタイプごとに細かくかき分けたい（ARMの中の命令セットごととか）人向けにビルドタグとか追加されていますが、多くの人には関係ないかな？<br>あとは、標準ライブラリのビルド済みのパッケージが添付されなくなって、配布物が小さくなっています。まあクロスコンパイルをする場合などはローカルでビルドされてキャッシュされていたので、それと同じような感じの扱いになっただけで、初回ビルドがちょっと遅いかな？ぐらいのものです。二酸化炭素を減らさないと！という会社さんはローカルがキャッシュ済みのイメージを作って使うといいかも？</p>
<h2 id="ライブラリ系"><a href="#ライブラリ系" class="headerlink" title="ライブラリ系"></a>ライブラリ系</h2><h3 id="unsafe"><a href="#unsafe" class="headerlink" title="unsafe"></a><code>unsafe</code></h3><p>文字列とバイト列のファイルコピーをしない変換、スライスの裏の配列の取得ができるようになります。<a target="_blank" rel="noopener" href="https://pkg.go.dev/github.com/valyala/fasthttp">github.com&#x2F;valyala&#x2F;fasthttp</a>はなるべくstringを作らないことで高速なベンチマークを達成している（と思う）のですが、net&#x2F;httpの標準ライブラリでも同じぐらいのパフォーマンスアップを期待しちゃいますね。</p>
<h3 id="圧縮系のライブラリ"><a href="#圧縮系のライブラリ" class="headerlink" title="圧縮系のライブラリ"></a>圧縮系のライブラリ</h3><p><code>archive/tar</code>と<code>archive/zip</code>で現在のフォルダの外だったり、絶対パスが入ると<code>ErrInsecurePath</code>を返すようになりました。ディレクトリトラバーサル攻撃対策ですね。<code>GODEBUG=tarinsecurepath=0</code>とか<code>GODEBUG=zipinsecurepath=0</code>を設定して実行すれば前と同じ動作にはなります。</p>
<h3 id="暗号系ライブラリ"><a href="#暗号系ライブラリ" class="headerlink" title="暗号系ライブラリ"></a>暗号系ライブラリ</h3><p><code>crypto/ecdh</code>で楕円暗号のパッケージが追加になりました。<a target="_blank" rel="noopener" href="https://qiita.com/lemiyachi/items/c20a18b172c6f192a262">RSAの終わりの始まり - 暗号移行再び</a>にあるように、暗号強度を強くしよう、という流れがまた来そうなので、要注目パッケージです。<br>あとは<code>crypto/ecdsa</code>とか<code>crypto/rsa</code>とかめずらしく、性能が悪くなる改善ですが、処理速度が定数時間で終わるようになるということで、処理する時間で内容が推測できちゃう系の最近たまに話題になる系統のセキュリティ対策ですかね。</p>
<h3 id="io-OffsetWriter"><a href="#io-OffsetWriter" class="headerlink" title="io.OffsetWriter"></a><code>io.OffsetWriter</code></h3><p><code>io.Reader</code>には<code>io.SectionReader</code>という、オフセット＋サイズ制限、<code>io.LimitReader</code>というサイズ制限のReaderはありましたが、実は<code>io.Writer</code>としてはオフセット系のはなかったんですね。書き込み上限のWriter（<code>LimitWriter？</code>)はなさそうなので、誰か提案すると良い気がします。</p>
<h3 id="math-rand"><a href="#math-rand" class="headerlink" title="math/rand"></a><code>math/rand</code></h3><p>地味に変更が多いです。1.20から、デフォルトの乱数の種が固定値でなくなりました。1.19までは間違ったプログラムの実行の仕方を防ぐために、常に同じ乱数が変えるようになっていて、開発者に適切な種の設定を即す挙動になっていました。実行時に<code>GODEBUG=randautoseed=0</code>をつけると、以前と同じ挙動になります。このグローバルな乱数ジェネレータの乱数の種を設定するグローバルな<code>rand.Seed()</code>は廃止になっています。種を固定した乱数が必要な場合は、乱数生成器を明示的に作って使いましょう。<br>あと、<code>rand.Read()</code>も廃止になっています。ランダムなバイト列取得というセキュリティ用途でよくあるユースケースで間違って使われるケースが多かったんでしょうか？<code>crypto/rand</code>の<code>Read</code>を使えとなっていますね。</p>
<h3 id="regexp"><a href="#regexp" class="headerlink" title="regexp"></a><code>regexp</code></h3><p>正規表現でメモリを消費しすぎるパターンの場合に<code>syntax.ErrLarge</code>が返るようになりました。Go 1.19のパッチリリースでセキュリティ対策されたのですが、そのときは新しいAPIを導入しないルールに従い、<code> syntax.ErrInternalError</code>を一時的に返していたが、1.20からは上記のエラーが新規で作られたとのことです。バージョンアップのやり方として参考になりますね。</p>
<h2 id="さいごに"><a href="#さいごに" class="headerlink" title="さいごに"></a>さいごに</h2><p>明日(1&#x2F;24)は真野さんの <a href="/articles/20230125a/">contextパッケージのWithCancelCauseとCause</a>です。</p>

          
        </div>
        <footer>
          <section class="social-area">
          <!-- シェアボタン START -->
  <ul class="social-button">
    
    <!-- Twitter -->
    <li>
      <a class="social-btn twitter-btn" target="_blank" href="https://twitter.com/share?url=https://future-architect.github.io/articles/20230123a/&related=twitterapi%2Ctwitter&text=Go%201.20%E3%83%AA%E3%83%AA%E3%83%BC%E3%82%B9%E9%80%A3%E8%BC%89%E3%81%8C%E5%A7%8B%E3%81%BE%E3%82%8A%E3%81%BE%E3%81%99%EF%BC%86%E3%83%A1%E3%83%A2%E3%83%AA%E3%82%A2%E3%83%AA%E3%83%BC%E3%83%8A%E3%81%AE%E7%B4%B9%E4%BB%8B%EF%BC%86%E8%90%BD%E3%81%A1%E7%A9%82%E6%8B%BE%E3%81%84%20%7C%20%E3%83%95%E3%83%A5%E3%83%BC%E3%83%81%E3%83%A3%E3%83%BC%E6%8A%80%E8%A1%93%E3%83%96%E3%83%AD%E3%82%B0" rel="nofollow noopener">
        <i></i><span class="social-btn-label">61</span>
      </a>
    </li>
    <!-- Facebook -->
    <li>
      <a class="social-btn fb-btn" target="_blank" href="http://www.facebook.com/share.php?u=https://future-architect.github.io/articles/20230123a/&t=Go%201.20%E3%83%AA%E3%83%AA%E3%83%BC%E3%82%B9%E9%80%A3%E8%BC%89%E3%81%8C%E5%A7%8B%E3%81%BE%E3%82%8A%E3%81%BE%E3%81%99%EF%BC%86%E3%83%A1%E3%83%A2%E3%83%AA%E3%82%A2%E3%83%AA%E3%83%BC%E3%83%8A%E3%81%AE%E7%B4%B9%E4%BB%8B%EF%BC%86%E8%90%BD%E3%81%A1%E7%A9%82%E6%8B%BE%E3%81%84" rel="nofollow noopener">
        <i></i><span class="social-btn-label">シェア</span>
      </a>
    </li>
    <!-- hatebu -->
    <li>
      <a class="social-btn hatebu-btn" target="_blank" href="https://b.hatena.ne.jp/entry/s/future-architect.github.io/articles/20230123a/" rel="nofollow noopener">
        <i></i><span class="social-btn-label">13</span>
      </a>
    </li>
    <!-- pocket -->
    <li>
      <a class="social-btn pocket-btn" target="_blank" href="https://getpocket.com/save?url=https://future-architect.github.io/articles/20230123a/" rel="nofollow noopener">
        <i></i><span class="social-btn-label">12</span>
      </a>
    </li>
    
  </ul>
<!-- シェアボタン END -->

          </section>
          <aside>
            <section class="related-post margin-bottom-40 nav">
              <h2 id="related"><a href="#related" class="headerlink" title="関連記事"></a>関連記事</h2>
              
  <div class="widget">
    <ul class="nav related-post-link"><li class="related-posts-item"><span>2023.07.31</span><span class="snscount">&#9825;0</span><a href=/articles/20230731a/ title="恒例のGo 1.21連載が始まります。">Go 1.21連載始まります＆slogをどう使うべきか<span class="newitem">NEW</span></a></li><li class="related-posts-item"><span>2022.08.01</span><span class="snscount">&#9825;153</span><a href=/articles/20220801a/ title="Go 1.18のジェネリクス導入の大規模リリースと比べると比較的小さな1.19ですが、それでもさまざまな変更があります。今回ももちろん、恒例行事になりつつある、このテックブログでリリース連載をやります。まずは、GoDocと、その他ツール周りのアップデートの紹介です。"> Go 1.19リリース連載始まります GoDoc/ツール周りのアップデート</a></li><li class="related-posts-item"><span>2022.02.09</span><span class="snscount">&#9825;92</span><a href=/articles/20220209a/ title="Go 1.18のリリースが迫っているため、最近恒例でやっている新機能を何人かで紹介する集中連載を行います。ただ、Go 1.18は機能が大きく、ベータが長くなっており、当初2月予定だったのが、3月リリース見込みとなっています。Go 1.18で入る機能で注目度が高い新機能がジェネリクスです。Goに対する批判的な言葉としてよく使われるものが「ジェネリクスがない」というものでした">Go 1.18集中連載 ジェネリクス</a></li><li class="related-posts-item"><span>2021.08.10</span><span class="snscount">&#9825;253</span><a href=/articles/20210810a/ title="Go 1.17の集中連載を行います。Go 1.17のリリースの足音が聞こえてきました。1.16のgo:embedのような「うぉっ」と声が出るような大きな新機能はなく、APIが変わらずに勝手に改善されるようなものと、小粒なAPIの追加が多い感じです">Go 1.17連載が始まります: コンパイラとgo mod</a></li><li class="related-posts-item"><span>2021.02.07</span><span class="snscount">&#9825;75</span><a href=/articles/20210207/ title="毎年2月と8月はGoの新バージョンがリリースされます。2021年2月は1.16です。本ブログでは1.16のリリースを記念してGo 1.16の新機能を紹介する集中連載を行います">Go 1.16連載が始まります</a></li><li class="related-posts-item"><span>2020.03.11</span><span class="snscount">&#9825;563</span><a href=/articles/20200311/ title="Java to Go in-depth tutorialの日本語訳です。原文の著者に許諾を得て翻訳・公開いたします。このチュートリアルは、JavaプログラマーがすばやくGo言語にキャッチアップできるようにすることを目的としています。">JavaプログラマーのためのGo言語入門</a></li></ul>
  </div>
            </section>
            <section class="reference-post margin-bottom-40 nav">
              
  <div class="card">
    <div id="reference" class="reference-lede"><a href="#reference" class="headerlink" title="参照されている記事"></a>この記事を参照している記事</div>
    <ul class="reference-post-link"><li class="reference-posts-item"><a href=/articles/20230314a/ title="2023年に計画している、ブログ連載のスケジュールを紹介します。">2023年 フューチャー技術ブログ連載の企画スケジュール </a></li><li class="reference-posts-item"><a href=/articles/20230202a/ title="Go 1.20連載の6本目です。Goの標準ライブラリに組み込まれている、コンパイラによってキャッチされないエラーや懸念を検出し報告してくれるコードの静的解析ツールです。機能の詳細は本記事では割愛しますが、以下コマンドで利用可能なチェックの一覧を確認することができます。">Go 1.20 vetのアップデート</a></li><li class="reference-posts-item"><a href=/articles/20230203a/ title="Go 1.20 連載 7 記事目にして、最終回の本記事では、`go build`コマンドに新たに追加される`-cover`オプションについてお伝えします。せっかくなので実際に使ってみたレポートもお届けしようと思います。">Go 1.20 リリース連載 go build に追加される cover オプション（利用例付き）</a></li><li class="reference-posts-item"><a href=/articles/20230131a/ title="- はじめに- 概要を確認- Proposal の内容と RFC の確認- 実際に動かしながら、Go1.19 と Go1.20 の違いを確認- まとめ">New ReverseProxy Rewrite hook を動かしながら理解する</a></li><li class="reference-posts-item"><a href=/articles/20230125a/ title="Go 1.20リリース連載の2本目はcontext についてです。Go 1.7で `context.Context`が入ってから、context界隈において久しぶりのアップデートです。">Go1.20リリース連載 contextパッケージのWithCancelCauseとCause</a></li></ul>
  </div>
            </section>
          </aside>
        </footer>
      </div>
    </article>
  </main>
  <aside class="col-md-3 blog-sidebar">
    <!-- START SIDEBAR  -->


<section class="toc-section">
  <h2 class="margin-top-30">目次</h2>
  <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E3%83%A1%E3%83%A2%E3%83%AA%E3%82%A2%E3%83%AA%E3%83%BC%E3%83%8A%E3%81%A8%E3%81%AF"><span class="toc-text">メモリアリーナとは</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E3%83%89%E3%82%AD%E3%83%A5%E3%83%A1%E3%83%B3%E3%83%88%E3%81%8C%E3%81%AA%E3%81%84%EF%BC%9F%E3%81%A9%E3%81%93%E3%81%AB%E3%81%82%E3%82%8B%E3%81%AE%EF%BC%9F"><span class="toc-text">ドキュメントがない？どこにあるの？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E3%83%99%E3%83%B3%E3%83%81%E3%83%9E%E3%83%BC%E3%82%AF"><span class="toc-text">ベンチマーク</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E3%81%A9%E3%81%93%E3%81%A7%E4%BD%BF%E3%81%88%E3%82%8B%E3%81%AE%E3%81%8B%EF%BC%9F"><span class="toc-text">どこで使えるのか？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E3%83%A6%E3%83%BC%E3%82%B9%E3%82%B1%E3%83%BC%E3%82%B9%E3%81%AB%E3%81%AF%E4%BD%95%E3%81%8C%E3%81%82%E3%82%8B%E3%81%8B%EF%BC%9F"><span class="toc-text">ユースケースには何があるか？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E3%83%A9%E3%82%A4%E3%83%95%E3%82%B5%E3%82%A4%E3%82%AF%E3%83%AB%E7%AE%A1%E7%90%86%E3%81%A8API%E8%A8%AD%E8%A8%88%E3%81%AE%E8%80%83%E5%AF%9F"><span class="toc-text">ライフサイクル管理とAPI設計の考察</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Arena%E3%81%8B%E3%82%89%E8%BF%BD%E3%81%84%E5%87%BA%E3%81%95%E3%82%8C%E3%81%AA%E3%81%84%E3%82%88%E3%81%86%E3%81%AB%E6%B0%97%E3%82%92%E4%BB%98%E3%81%91%E3%82%8B-x2F-%E9%96%8B%E6%94%BE%E5%BE%8C%E3%81%AFArena%E3%82%92%E8%A7%A6%E3%82%89%E3%81%AA%E3%81%84%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B"><span class="toc-text">Arenaから追い出されないように気を付ける&#x2F;開放後はArenaを触らないようにする</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E3%82%A2%E3%83%AA%E3%83%BC%E3%83%8A%E3%81%AE%E3%81%BE%E3%81%A8%E3%82%81"><span class="toc-text">アリーナのまとめ</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E3%81%9D%E3%81%AE%E4%BB%96%E3%81%AE%E5%B0%8F%E3%83%8D%E3%82%BF"><span class="toc-text">その他の小ネタ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E7%B3%BB"><span class="toc-text">ライブラリ系</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#unsafe"><span class="toc-text">unsafe</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A7%E7%B8%AE%E7%B3%BB%E3%81%AE%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA"><span class="toc-text">圧縮系のライブラリ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9A%97%E5%8F%B7%E7%B3%BB%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA"><span class="toc-text">暗号系ライブラリ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#io-OffsetWriter"><span class="toc-text">io.OffsetWriter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#math-rand"><span class="toc-text">math&#x2F;rand</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#regexp"><span class="toc-text">regexp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E3%81%95%E3%81%84%E3%81%94%E3%81%AB"><span class="toc-text">さいごに</span></a></li></ol></li></ol>
</section>

<section class="category">
<h2 class="margin-top-30">カテゴリー</h2>
<div class="widget">
  <ul class="nav sidebar-categories margin-bottom-40">
  
  <li class=""><a href="/categories/Programming/">Programming (384)</a></li>
<li class=""><a href="/categories/Infrastructure/">Infrastructure (238)</a></li>
<li class=""><a href="/categories/Culture/">Culture (88)</a></li>
<li class=""><a href="/categories/DataScience/">DataScience (53)</a></li>
<li class=""><a href="/categories/IoT/">IoT (33)</a></li>
<li class=""><a href="/categories/DB/">DB (23)</a></li>
<li class=""><a href="/categories/DevOps/">DevOps (21)</a></li>
<li class=""><a href="/categories/Business/">Business (21)</a></li>
<li class=""><a href="/categories/%E8%AA%8D%E8%A8%BC%E8%AA%8D%E5%8F%AF/">認証認可 (20)</a></li>
<li class=""><a href="/categories/Management/">Management (15)</a></li>
<li class=""><a href="/categories/Security/">Security (13)</a></li>
<li class=""><a href="/categories/VR/">VR (12)</a></li>
<li class=""><a href="/categories/Design/">Design (11)</a></li>
<li class=""><a href="/categories/Programing/">Programing (1)</a></li>

  </ul>
</div>

</section>
<section class="podcast-link">
<h2 class="margin-top-30">Tech Cast</h2>

  <div class="class="widget-wrap">
  <div class="widget">
    <ul class="nav techcast">
      <li><a href="https://podcasters.spotify.com/pod/show/futuretechcast/episodes/38-AIAI-e22h1v0" title="フューチャーがお届けするポッドキャストです。#38 AIグループリーダー加藤さんに聞く「AIチームのミッションと展望」" target="_blank" rel="noopener"> #38 AIグループリーダー加藤さんに聞く「AIチームのミッションと展望」</a></li>
<li><a href="https://podcasters.spotify.com/pod/show/futuretechcast/episodes/37-e227p84" title="フューチャーがお届けするポッドキャストです。#37 自然言語処理を使った文書検索エンジンシステム開発と新規サービス検討（後編）" target="_blank" rel="noopener"> #37 自然言語処理を使った文書検索エンジンシステム開発と新規サービス検討（後編）</a></li>
<li><a href="https://podcasters.spotify.com/pod/show/futuretechcast/episodes/36-e1rdbcu" title="フューチャーがお届けするポッドキャストです。#36 自然言語処理を使った文書検索エンジンシステム開発と新規サービス検討（前編）" target="_blank" rel="noopener"> #36 自然言語処理を使った文書検索エンジンシステム開発と新規サービス検討（前編）</a></li>
    </ul>
  </div>
  </div>
  
</section>
<section class="advent-calendar">
<h2 class="margin-top-30">アドベントカレンダー</h2>
<div class="widget">
  <ul class="nav-flex">
    <li><a href="http://qiita.com/advent-calendar/2022/future" title="フューチャー Advent Calendar 2022 #Qiita" target="_blank" rel="noopener">2022年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2021/future" title="フューチャー Advent Calendar 2021 #Qiita" target="_blank" rel="noopener">2021年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2020/future" title="フューチャー Advent Calendar 2020 #Qiita" target="_blank" rel="noopener">2020年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2019/future" title="フューチャー Advent Calendar 2019 #Qiita" target="_blank" rel="noopener">2019年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2018/future" title="フューチャー Advent Calendar 2018 #Qiita" target="_blank" rel="noopener">2018年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2017/future" title="フューチャー Advent Calendar 2017 #Qiita" target="_blank" rel="noopener">2017年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2016/future" title="フューチャー Advent Calendar 2016 #Qiita" target="_blank" rel="noopener">2016年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2015/future" title="フューチャー Advent Calendar 2015 #Qiita" target="_blank" rel="noopener">2015年</a></li>
  </ul>
</div>

</section>
<!-- END SIDEBAR -->

  </aside>
</div>

  </section>
</div>

      <!-- BEGIN PRE-FOOTER -->
    <footer>
      <div class="pre-footer">
        <div class="container">
          <div class="row">
            <div class="col-lg-4 col-md-4 col-sm-6 col-6 pre-footer-col">
              <h2>About Us</h2>
              <p>経営とITをデザインする、フューチャーの技術ブログです。業務で利用している幅広い技術について紹介します。<br /><br /><a target="_blank" rel="noopener" href="http://www.future.co.jp/">http://www.future.co.jp/</a></p>
              <div class="social-btn twitter-btn twitter-follow-btn">
                <a href="https://twitter.com/intent/follow?screen_name=future_techblog " target="_blank" rel="nofollow noopener">
                  <i></i><span class="tw-btn-label">フューチャー技術ブログをフォロー</span>
                </a>
              </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-4 col-4 pre-footer-col">
              <h2>Contact</h2>
              <address class="margin-bottom-40">
                <a href="https://www.future.co.jp/recruit/recruit/rec-fresh/" title="新卒採用" target="_blank" rel="noopener">新卒採用</a><br>
                <a href="https://www.future.co.jp/recruit/recruit/rec-career/" title="キャリア採用" target="_blank" rel="noopener">キャリア採用</a><br>
                <a href="https://www.future.co.jp/contact_us/" title="お問い合わせページ" target="_blank" rel="noopener">お問い合わせ</a><br>
                <a href="https://www.future.co.jp/architect/socialmediapolicy/" title="ソーシャルメディアポリシー" target="_blank" rel="noopener">メディアポリシー</a><br><br>
                <a href="mailto:techblog@future.co.jp">techblog@future.co.jp</a>
              </address>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 col-6 pre-footer-col">
              <h2>Contents</h2>
              <a href="https://future-architect.github.io/coding-standards/" title="Future Enterprise Coding Standards" target="_blank" rel="noopener">コーディング規約</a><br>
              <a href="https://future-architect.github.io/typescript-guide/" title="仕事ですぐに使えるTypeScript" target="_blank" rel="noopener">仕事ですぐに使えるTypeScript</a><br>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-3 col-3 pre-footer-col">
              <h2>Event</h2>
              <a href="https://future.connpass.com/" title="経営とITをデザインするフューチャーの勉強会です" target="_blank" rel="noopener">connpass</a><br>
              <a href="https://www.future.co.jp/futureinsightseminar/" title="フューチャーインサイトセミナー" target="_blank" rel="noopener">Webセミナー</a><br>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-3 col-3 pre-footer-col">
              <h2>SNS</h2>
              <a href="https://github.com/future-architect" title="Future's official open source repositories" target="_blank" rel="noopener">GitHub</a><br>
              <a href="https://qiita.com/organizations/future" title="フューチャーのQiita Organizationです" target="_blank" rel="noopener">Qiita</a><br>
              <a href="https://note.future.co.jp/" title="フューチャーの公式note" target="_blank" rel="noopener">未来報</a><br>
              <a href="https://www.youtube.com/channel/UCJUSwYYd0CkGgmEKAW7QVpw" title="フューチャーYoutubeチャネル" target="_blank" rel="noopener">Youtube</a>
            </div>
          </div>
        </div>
      </div>
      <div class="footer">
        <div class="container">
          <div class="row">
            <div class="col-md-6 col-sm-6 padding-top-10">
              &copy; 2023 フューチャー技術ブログ<br>
            </div>
          </div>
        </div>
      </div>
    </footer>

  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-X1C28R8H0M"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-X1C28R8H0M');
  gtag('config', 'UA-74047147-1'); // 過渡期対応
</script>

  </div>
</body>
</html>
