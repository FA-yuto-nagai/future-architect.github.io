<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <!--
    ███████╗██╗░░░██╗████████╗██╗░░░██╗██████╗░███████╗
    ██╔════╝██║░░░██║╚══██╔══╝██║░░░██║██╔══██╗██╔════╝
    █████╗░░██║░░░██║░░░██║░░░██║░░░██║██████╔╝█████╗░░
    ██╔══╝░░██║░░░██║░░░██║░░░██║░░░██║██╔══██╗██╔══╝░░
    ██║░░░░░╚██████╔╝░░░██║░░░╚██████╔╝██║░░██║███████╗
    ╚═╝░░░░░░╚═════╝░░░░╚═╝░░░░╚═════╝░╚═╝░░╚═╝╚══════╝
    ████████╗███████╗░█████╗░██╗░░██╗
    ╚══██╔══╝██╔════╝██╔══██╗██║░░██║
    ░░░██║░░░█████╗░░██║░░╚═╝███████║
    ░░░██║░░░██╔══╝░░██║░░██╗██╔══██║
    ░░░██║░░░███████╗╚█████╔╝██║░░██║
    ░░░╚═╝░░░╚══════╝░╚════╝░╚═╝░░╚═╝
    ██████╗░██╗░░░░░░█████╗░░██████╗░
    ██╔══██╗██║░░░░░██╔══██╗██╔════╝░
    ██████╦╝██║░░░░░██║░░██║██║░░██╗░
    ██╔══██╗██║░░░░░██║░░██║██║░░╚██╗
    ██████╦╝███████╗╚█████╔╝╚██████╔╝
    ╚═════╝░╚══════╝░╚════╝░░╚═════╝░
    Welcome engineer.
    https://www.future.co.jp/recruit/
  -->
  
  <title>TetragonでeBPFとセキュリティオブサーバビリティ入門 | フューチャー技術ブログ</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  
  <meta name="description" content="CNCF連載 の4本目です。 はじめに数年前にクラウドネイティブ注目技術として挙げられたeBPFにかねてよりキャッチアップしたいなと思っていたので、この連載のタイミングでeBPFとその関連プロダクトに入門してみることにしました。 CNCFプロジェクト傘下のeBPFを活用したプロダクトとしてはCilium, Falcoなどが挙げられます。CiliumはKubernetesなどのクラウドネイティブな環">
<meta property="og:type" content="article">
<meta property="og:title" content="TetragonでeBPFとセキュリティオブサーバビリティ入門 | フューチャー技術ブログ">
<meta property="og:url" content="https://future-architect.github.io/articles/20230623a/index.html">
<meta property="og:site_name" content="フューチャー技術ブログ">
<meta property="og:description" content="CNCF連載 の4本目です。 はじめに数年前にクラウドネイティブ注目技術として挙げられたeBPFにかねてよりキャッチアップしたいなと思っていたので、この連載のタイミングでeBPFとその関連プロダクトに入門してみることにしました。 CNCFプロジェクト傘下のeBPFを活用したプロダクトとしてはCilium, Falcoなどが挙げられます。CiliumはKubernetesなどのクラウドネイティブな環">
<meta property="og:locale" content="ja_JP">
<meta property="og:image" content="https://future-architect.github.io/images/20230623a/tetragon-2023-06-21-2234.png">
<meta property="article:published_time" content="2023-06-22T15:00:00.000Z">
<meta property="article:modified_time" content="2023-07-11T03:40:32.136Z">
<meta property="article:tag" content="Kubernetes">
<meta property="article:tag" content="CNCF">
<meta property="article:tag" content="Tetragon">
<meta property="article:tag" content="eBPF">
<meta property="article:tag" content="オブサーバビリティ">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://future-architect.github.io/images/20230623a/tetragon-2023-06-21-2234.png">
  
  <link rel="alternate" href="/atom.xml" title="フューチャー技術ブログ" type="application/atom+xml">
  
  <link rel="icon" href="/favicon.ico">
  <link rel="apple-touch-icon" sizes='180x180' href="/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes='57x57' href="/apple-touch-icon-57x57.png">
  <link rel="canonical" href="https://future-architect.github.io/articles/20230623a/">
  <meta content="Kubernetes,CNCF,Tetragon,eBPF,オブサーバビリティ" name="keywords">
  <meta content="鈴木崇史" name="author">
  <link rel="preload" as="image" href="/banner.jpg" />
  <link rel='manifest' href='/manifest.webmanifest'/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">
  <link rel="stylesheet" href="/metronic/assets/style.css">
  <link rel="stylesheet" href="/css/theme-styles.css">
<meta name="generator" content="Hexo 5.4.2"></head>

<body class="corporate">
  <div class="wrap" itemscope itemtype="https://schema.org/TechArticle">
  <!-- BEGIN HEADER -->
<header class="header">
	<div class="header-overlay">
		<div class="header-menu"></div>
		<div class="header-title"><a href="/">Future Tech Blog</a></div>
		<div class="header-title-sub">フューチャー技術ブログ</div>
	</div>
</header>
<!-- Header END -->

  <div class="container">
  <ul class="breadcrumb">
    <li><a href="/">Home</a></li>
    <li><a href="/articles/">Blog</a></li>
    <li class="active">Post</li>
  </ul>
  <section id="main" class="margin-top-30">
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Security/">Securityカテゴリ</a>
  </div>


    <h2 itemprop="name" class="article-title">TetragonでeBPFとセキュリティオブサーバビリティ入門
  
  <a target="_blank" rel="noopener" href="https://github.com/future-architect/tech-blog/edit/master/source/_posts/20230623a_TetragonでeBPFとセキュリティオブサーバビリティ入門.md" title="Suggest Edits" class="github-edit"><i class="github-edit-icon"></i></a>
  
</h2>

    <div class="row">
  <main class="col-md-9 blog-posts">
    <article id="post-20230623a_TetragonでeBPFとセキュリティオブサーバビリティ入門" class="article article-type-post blog-item" itemscope itemprop="blogPost">
      <div class="article-inner">
        
        <header class="article-header">
          <ul class="blog-info">
            <li class="blog-info-item"><a href="/articles/2023/" class="publish-date"><time datetime="2023-06-22T15:00:00.000Z" itemprop="datePublished">2023.06.23</time></a>
</li>
            <li class="blog-info-item"><li><a href="/authors/%E9%88%B4%E6%9C%A8%E5%B4%87%E5%8F%B2" title="鈴木崇史さんの記事一覧へ" class="post-author">鈴木崇史</a></li></li>
            <li class="blog-info-item">
  
    
    <a href="/tags/Kubernetes/" title="Kubernetesタグの記事へ" class="tag-list-link">Kubernetes</a>
  
    
    <a href="/tags/CNCF/" title="CNCFタグの記事へ" class="tag-list-link">CNCF</a>
  
    
    <a href="/tags/Tetragon/" title="Tetragonタグの記事へ" class="tag-list-link">Tetragon</a>
  
    
    <a href="/tags/eBPF/" title="eBPFタグの記事へ" class="tag-list-link">eBPF</a>
  
    
    <a href="/tags/オブサーバビリティ/" title="オブサーバビリティタグの記事へ" class="tag-list-link">オブサーバビリティ</a>
  

</li>
          </ul>
          </header>
        
        <div class="article-entry" itemprop="articleBody">
          
            <p><a href="/articles/20230619a/">CNCF連載</a> の4本目です。</p>
<h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>数年前に<a target="_blank" rel="noopener" href="https://twitter.com/CloudNativeFdn/status/1329863326428499971?s=20">クラウドネイティブ注目技術として挙げられた</a>eBPFにかねてよりキャッチアップしたいなと思っていたので、この連載のタイミングでeBPFとその関連プロダクトに入門してみることにしました。</p>
<p>CNCFプロジェクト傘下のeBPFを活用したプロダクトとしては<a target="_blank" rel="noopener" href="https://cilium.io/">Cilium</a>, <a target="_blank" rel="noopener" href="https://falco.org/">Falco</a>などが挙げられます。CiliumはKubernetesなどのクラウドネイティブな環境でネットワーク、オブサーバビリティの機能を提供するOSSなのですが、今回はそのいわばサブプロジェクト的な位置づけのセキュリティツールである、<a target="_blank" rel="noopener" href="https://github.com/cilium/tetragon">Tetragon</a>に触ってみます。</p>
<p>Cilium, Tetragonの開発をメイン行っているIsovalent社は、書籍やハンズオンラボなどで自社の製品・eBPFについての学習リソースを多く提供しています。</p>
<p><a target="_blank" rel="noopener" href="https://isovalent.com/resource-library/books">https://isovalent.com/resource-library/books</a></p>
<p>eBPFを学ぶ書籍はいくつかあると思うのですが、今回ブログを書くにあたってはIsovalentが提供しているeBook、<a target="_blank" rel="noopener" href="https://isovalent.com/learning-ebpf/">Learning eBPF</a>にざっと目を通しました。</p>
<h2 id="eBPF入門"><a href="#eBPF入門" class="headerlink" title="eBPF入門"></a>eBPF入門</h2><p>eBPFとはLinuxカーネル内部で高速安全にプログラムを実行する技術です。これにより、ネットワーキング、セキュリティ、アプリケーションのカーネルレベルでの振る舞いを、カーネルをビルドしなおしたりOSの再起動をしたりせずに動的に観測・制御することができます。</p>
<p>eBPFそのものの実態は、カーネルのイベントをトリガーとして動作するプログラムとその実行環境です。基本的にC言語で記述してeBPFのバイトコードにコンパイルされ、eBPFのVMで動きます。eBPFバイトコードはカーネルにロードされる前に検証器にチェックされるようになっており、そのおかげでカーネルをクラッシュさせたり脆弱性のもとになるバグを埋め込まず安全に実行できるようです。</p>
<p>eBPFを使ったツールを開発する場合、eBPFプログラムそのものと、それをカーネルのイベントソースにアタッチしてeBPFとデータをやり取りするユーザスペースのコードを書く必要があります。</p>
<p>実際にeBPFのサンプルプログラムを動かしてみましょう。サンプルプログラムには<a target="_blank" rel="noopener" href="https://github.com/iovisor/bcc">BCC</a> (BPF Compiler Collection）という、Python&#x2F;LuaでeBPFを扱うことのできるツールを使います。インストール方法は<a target="_blank" rel="noopener" href="https://github.com/iovisor/bcc/blob/master/INSTALL.md">こちら</a>が参考になります。</p>
<p>次はHello Worldプログラムです。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3  </span></span><br><span class="line"><span class="keyword">from</span> bcc <span class="keyword">import</span> BPF</span><br><span class="line"></span><br><span class="line">program = <span class="string">r&quot;&quot;&quot;  </span></span><br><span class="line"><span class="string">int hello(void *ctx) &#123;</span></span><br><span class="line"><span class="string">    bpf_trace_printk(&quot;Hello World!&quot;);</span></span><br><span class="line"><span class="string">    return 0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">b = BPF(text=program)</span><br><span class="line">syscall = b.get_syscall_fnname(<span class="string">&quot;execve&quot;</span>)</span><br><span class="line">b.attach_kprobe(event=syscall, fn_name=<span class="string">&quot;hello&quot;</span>)</span><br><span class="line"></span><br><span class="line">b.trace_print()</span><br></pre></td></tr></table></figure>

<ul>
<li>eBPFプログラムはヒアドキュメントで書かれた部分です。C言語の文法で書かれています。</li>
<li><code>BPF(text=program)</code> でeBPFプログラムを渡してBPFオブジェクトを作っていますが、このタイミングでeBPFプログラムがコンパイルされます。</li>
<li><code>get_syscall_fname(&quot;execve&quot;)</code>で execveシステムコール（実行可能ファイルが実行される時に呼ばれるシステムコール）に対応するカーネル関数を検索します。</li>
<li><code>b.attach_kprobe(event=syscall, fn_name=&quot;hello&quot;)</code> でebpfプログラムを検索したカーネル関数にアタッチします。ここではkprobeという実行中のカーネルに動的に処理を差し込むための仕組みでイベントにアタッチしています。</li>
</ul>
<p>このPythonスクリプトを実行し、別ターミナルで <code>ls</code> コマンドを実行すると、<code>ls</code>が実行される時にexecve()が呼ばれ、それにアタッチされたeBPFプログラムが次のようなトレースを出力します。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">b&#x27;           &lt;...&gt;-2140994 [000] d...1 556700.676560: bpf_trace_printk: Hello World!&#x27;</span></span><br></pre></td></tr></table></figure>

<p>“Hello World” だけでなく、どのようなプロセスがトレースされているのかを表示できるようにしてみましょう。eBPFプログラムの中からプロセス名を取得するために、<code>bpf_get_current_comm()</code>というヘルパー関数を使ってみます。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3  </span></span><br><span class="line"><span class="keyword">from</span> bcc <span class="keyword">import</span> BPF</span><br><span class="line"></span><br><span class="line">program = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">#include &lt;linux/sched.h&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">int hello(void *ctx) &#123;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    char comm[TASK_COMM_LEN];</span></span><br><span class="line"><span class="string">    bpf_get_current_comm(&amp;comm, sizeof(comm)); </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    bpf_trace_printk(&quot;%s\\n&quot;, comm);</span></span><br><span class="line"><span class="string">    return 0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">b = BPF(text=program)</span><br><span class="line">syscall = b.get_syscall_fnname(<span class="string">&quot;execve&quot;</span>)</span><br><span class="line">b.attach_kprobe(event=syscall, fn_name=<span class="string">&quot;hello&quot;</span>)</span><br><span class="line"></span><br><span class="line">b.trace_print()</span><br></pre></td></tr></table></figure>

<p>このPythonスクリプトを実行した状態で別ターミナルで <code>ls</code> を実行すると、<code>bash</code> から <code>ls</code> が起動したのだということがわかります。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">b&#x27;           &lt;...&gt;-2196911 [000] d...1 567624.022345: bpf_trace_printk: bash&#x27;</span></span><br><span class="line"><span class="string">b&#x27;           &lt;...&gt;-2196912 [002] d...1 567624.380166: bpf_trace_printk: bash&#x27;</span></span><br></pre></td></tr></table></figure>

<p>今までトレースを出力するために <code>bpf_trace_printk</code> という関数を使ってきましたが、これは主にデバッグ目的で使うようなもので、PythonのユーザスペースのプログラムとeBPFプログラムの間で情報をやり取りするには、eBPF mapというデータ構造を使います。<br>eBPF mapとして利用できるデータ構造はいくつかありますが、今回はring bufferを使ってみます。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3  </span></span><br><span class="line"><span class="keyword">from</span> bcc <span class="keyword">import</span> BPF</span><br><span class="line"></span><br><span class="line">program = <span class="string">r&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">BPF_PERF_OUTPUT(output); </span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">struct data_t &#123;     </span></span><br><span class="line"><span class="string">   int pid;</span></span><br><span class="line"><span class="string">   int uid;</span></span><br><span class="line"><span class="string">   char command[16];</span></span><br><span class="line"><span class="string">&#125;;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">int hello(void *ctx) &#123;</span></span><br><span class="line"><span class="string">   struct data_t data = &#123;&#125;; </span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">   data.pid = bpf_get_current_pid_tgid() &gt;&gt; 32;</span></span><br><span class="line"><span class="string">   data.uid = bpf_get_current_uid_gid() &amp; 0xFFFFFFFF;</span></span><br><span class="line"><span class="string">   </span></span><br><span class="line"><span class="string">   bpf_get_current_comm(&amp;data.command, sizeof(data.command));</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">   output.perf_submit(ctx, &amp;data, sizeof(data)); </span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">   return 0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">b = BPF(text=program) </span><br><span class="line">syscall = b.get_syscall_fnname(<span class="string">&quot;execve&quot;</span>)</span><br><span class="line">b.attach_kprobe(event=syscall, fn_name=<span class="string">&quot;hello&quot;</span>)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_event</span>(<span class="params">cpu, data, size</span>):  </span><br><span class="line">   data = b[<span class="string">&quot;output&quot;</span>].event(data)</span><br><span class="line">   <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;data.pid&#125;</span> <span class="subst">&#123;data.uid&#125;</span> <span class="subst">&#123;data.command.decode()&#125;</span>&quot;</span>)</span><br><span class="line"> </span><br><span class="line">b[<span class="string">&quot;output&quot;</span>].open_perf_buffer(print_event) </span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:   </span><br><span class="line">   b.perf_buffer_poll()</span><br></pre></td></tr></table></figure>

<ul>
<li><code>BPF_PERF_OUTPUT</code>の部分がリングバッファーを作成するマクロです。 <code>output</code> という名前で定義されています。</li>
<li><code>bpf_get_current_pid_tgid()</code>  <code>bpf_get_current_uid_gid()</code>  でイベントをトリガーしたプロセスのプロセスID・UIDを取得し、<code>data_t</code>にセットします。<code>output.perf_submit</code>でmapにデータを送ります。</li>
<li><code>print_event()</code> は バッファにデータが届いたときに呼び出されるコールバック関数です。バッファには <code>b[&quot;output&quot;]</code> のようにアクセスできます。</li>
<li><code>b[&quot;output&quot;].open_perf_buffer</code>でコールバック関数を登録しています。</li>
<li><code>b.perf_buffer_poll()</code> でバッファにポーリングしています。</li>
</ul>
<p>このPythonスクリプトを実行し、別ターミナルでコマンドを実行してみます。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2461142</span> <span class="number">1000</span> bash</span><br><span class="line"><span class="number">2461144</span> <span class="number">1000</span> bash</span><br><span class="line"><span class="number">2461152</span> <span class="number">1000</span> bash</span><br></pre></td></tr></table></figure>

<p>トレースされている情報は先ほどと同じですが、Python側のコードで出力を整えられるので見やすくなっていますね。</p>
<p>BPF mapは複数のeBPFプログラム間のデータのやり取りも可能です。</p>
<p>BCC + Pythonは初心者にとっつきやすいですが、実際にはeBPFのコードを実行時に毎回コンパイルするオーバーヘッドがあるだとか、コンパイルするホストと実行するホストが異なるとその差分に影響されてポータビリティが低いといった理由で、現在ではプロダクトの開発に使われていないみたいです。その代わりCO-RE (Compile Once- Run Everywhere)という仕組みをサポートするライブラリを使って実装されているようです。</p>
<p>ここまでくると次から紹介するTetragonの振る舞いやその設定方法がなんとなく理解できるようになります。</p>
<h2 id="Tetragon"><a href="#Tetragon" class="headerlink" title="Tetragon"></a>Tetragon</h2><p><a target="_blank" rel="noopener" href="https://github.com/cilium/tetragon">Tetragon</a>はもともとCilium Enterpriseの機能として提供されていたセキュリティ可観測性ツールで、2022年にOSSとして発表されました。主にKubernetesでの利用が想定されています。</p>
<p>主な機能としては、定義したポリシーに従ってKuberntesクラスター上のコンテナ内で実行されるプロセスのシステムコールやネットワーク関連のイベントをフィルタリングし、ログとして出力するというものです。ポリシーに応じて動的にeBPFプログラムをアタッチし、カーネル空間内で直接フィルタリングしています。</p>
<img src="/images/20230623a/tetragon-2023-06-21-2234.png" alt="tetragon-2023-06-21-2234.png" width="1065" height="637" loading="lazy">


<h3 id="プロセス実行の監視"><a href="#プロセス実行の監視" class="headerlink" title="プロセス実行の監視"></a>プロセス実行の監視</h3><p>まずはデモを動かしてどういうことができるのか確かめましょう。kindでクラスターを作り、helmでTetragonをインストールします。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kind create cluster </span><br><span class="line"></span><br><span class="line">helm repo add cilium https://helm.cilium.io</span><br><span class="line">helm repo update</span><br><span class="line">helm install tetragon cilium/tetragon -n kube-system</span><br><span class="line">kubectl rollout status -n kube-system ds/tetragon -w</span><br><span class="line"></span><br><span class="line"><span class="comment"># tetragonがDaemonSetとしてインストールされます。</span></span><br><span class="line">kubectl get ds -n kube-system tetragon</span><br></pre></td></tr></table></figure>

<p>次にセキュリティイベントの観測対象となる実験用のPodを作成しておきます。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl run <span class="built_in">test</span> --image=busybox -- <span class="built_in">sleep</span> 3600</span><br></pre></td></tr></table></figure>

<p>Tetragonではデフォルトでプロセスの実行に対して検知ログを出すようになっています。例えばコンテナでデバッグ用途以外でシェルが起動しているのはいかにも怪しいですが、そのようなイベントを観測できるということです。</p>
<p>Tetragonのログをtailしながら、別のターミナルから先ほど作ったPodで <code>/bin/sh</code> を動かしてみましょう</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl logs -f -n kube-system -l app.kubernetes.io/name=tetragon -c export-stdout</span><br><span class="line"></span><br><span class="line"><span class="comment"># 別のターミナルから</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it <span class="built_in">test</span> -- /bin/sh</span><br></pre></td></tr></table></figure>

<p>Tetragonから以下のようなログが出力されたと思います。長いので途中を省略していますが、”binary” を見ると確かに <code>/bin/sh</code> が実行されていると分かります。そしてPodのMetadataとしてPod名やNamespaceコンテナイメージも出力できています。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;process_exec&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;process&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;exec_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;a2luZC1jb250cm9sLXBsYW5lOjY3NTM5MDg3NTQ3MTA4MToyNTI5NTM3&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pid&quot;</span><span class="punctuation">:</span> <span class="number">2529537</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;cwd&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;binary&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/bin/sh&quot;</span><span class="punctuation">,</span></span><br><span class="line">...</span><br><span class="line">      <span class="attr">&quot;pod&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;namespace&quot;</span><span class="punctuation">:</span> <span class="string">&quot;default&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;container&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;containerd://a78169cb68982bba2925460d3b3c6cbe09788168f67e102acf228037b341b20f&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;image&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      ...</span><br><span class="line">          <span class="attr">&quot;pid&quot;</span><span class="punctuation">:</span> <span class="number">13</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;pod_labels&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;run&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;docker&quot;</span><span class="punctuation">:</span> <span class="string">&quot;a78169cb68982bba2925460d3b3c6cb&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;parent_exec_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;a2luZC1jb250cm9sLXBsYW5lOjY3NTM5MDgxNzEwOTM3MDoyNTI5NTI4&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;parent&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;exec_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;a2luZC1jb250cm9sLXBsYW5lOjY3NTM5MDgxNzEwOTM3MDoyNTI5NTI4&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pid&quot;</span><span class="punctuation">:</span> <span class="number">2529528</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>ところで、<code>bpftool</code> というBPFユーティリティツールを使うと、カーネルにロードされたeBPFプログラムをリストできます。Tetragonをインストールしたノード上でリストしてみると、Tetragonをインストールした直後（ロードされた時刻も表示されるのでそこでわかります）にいくつかeBPFプログラムがロードされているようです。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">bpftool prog <span class="built_in">list</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="number">20668</span>: kprobe  name event_exit  tag 6ae01771cf3bfcee  gpl</span><br><span class="line">        loaded_at <span class="number">2023</span>-06-04T19:<span class="number">11</span>:<span class="number">54</span>+0900  uid <span class="number">0</span></span><br><span class="line">        xlated 760B  jited 428B  memlock 4096B  map_ids <span class="number">54302</span>,<span class="number">54308</span>,<span class="number">54306</span>,<span class="number">54303</span></span><br><span class="line">        btf_id <span class="number">108378</span></span><br><span class="line"><span class="number">20670</span>: kprobe  name event_wake_up_n  tag 71207899142b2062  gpl</span><br><span class="line">        loaded_at <span class="number">2023</span>-06-04T19:<span class="number">11</span>:<span class="number">54</span>+0900  uid <span class="number">0</span></span><br><span class="line">        xlated 4648B  jited 2467B  memlock 8192B  map_ids <span class="number">54302</span>,<span class="number">54314</span>,<span class="number">54303</span>,<span class="number">54301</span>,<span class="number">54306</span></span><br><span class="line">        btf_id <span class="number">108387</span></span><br><span class="line"><span class="number">20671</span>: tracepoint  name event_execve  tag be83f62b7aed485e  gpl</span><br><span class="line">        loaded_at <span class="number">2023</span>-06-04T19:<span class="number">11</span>:<span class="number">54</span>+0900  uid <span class="number">0</span></span><br><span class="line">        xlated 123200B  jited 75857B  memlock 126976B  map_ids <span class="number">54327</span>,<span class="number">54302</span>,<span class="number">54322</span>,<span class="number">54306</span>,<span class="number">54320</span>,<span class="number">54305</span>,<span class="number">54323</span>,<span class="number">54324</span>,<span class="number">54303</span>,<span class="number">54301</span>,<span class="number">54304</span></span><br><span class="line">        btf_id <span class="number">108396</span></span><br><span class="line"><span class="number">20672</span>: tracepoint  name execve_send  tag 9db3dc5bc0c71d85  gpl</span><br><span class="line">        loaded_at <span class="number">2023</span>-06-04T19:<span class="number">11</span>:<span class="number">54</span>+0900  uid <span class="number">0</span></span><br><span class="line">        xlated 1040B  jited 626B  memlock 4096B  map_ids <span class="number">54327</span>,<span class="number">54302</span>,<span class="number">54324</span>,<span class="number">54303</span>,<span class="number">54306</span></span><br><span class="line">        btf_id <span class="number">108397</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>そのうちの一つ、<code>20671: tracepoint  name event_execve  tag be83f62b7aed485e  gpl</code> は、その名前から察するに <code>execve</code> システムコールをトレースしているようです。先ほどのサンプルコードと似ていますね。これらのeBPFプログラムたちがプロセスの起動やexitを監視しているみたいです。</p>
<p>eBPFのソースコードはおそらく<a target="_blank" rel="noopener" href="https://github.com/cilium/tetragon/blob/eb69bdc84405547733ccabfc69b355ae20d0eaa3/bpf/process/bpf_execve_event.c#L156">このあたり</a>でしょう。先ほどのサンプルコードと違う部分として、kprobeではなく静的なイベントソースであるTracepointという仕組みにアタッチされていたり、複数のeBPFプログラムが組み合わさっていたりします。</p>
<p>ちなみにTetragonの長いjsonログをパースして必要に応じてフィルタリングして、見やすく表示してくれる <code>tetra</code> というCLIツールがあります。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl logs -n kube-system -l app.kubernetes.io/name=tetragon -c export-stdout -f | tetra getevents --namespace default  -o compact</span><br><span class="line"></span><br><span class="line">🚀 process default/test /bin/sh</span><br><span class="line">💥 <span class="built_in">exit</span>    default/test /bin/sh  0</span><br></pre></td></tr></table></figure>

<h3 id="ファイルアクセスの監視"><a href="#ファイルアクセスの監視" class="headerlink" title="ファイルアクセスの監視"></a>ファイルアクセスの監視</h3><p>別のユースケースとして、コンテナ内のファイルアクセスをトレースしてみましょう。コンテナ内のファイルを書き換えることによって例えばWebコンテンツの改竄をすることが可能になるので、そういったイベントは検知するべきです。</p>
<p>Tetragonでは、TracingPolicyというCRDを作成することでトレースしたいカーネル関数を動的に指定することができます。ファイルアクセスをトレースしたい場合、その時に呼ばれるカーネル関数やシステムコールをトレースするTracingPolicyを作るということになります。</p>
<p>ここでは <code>/etc/</code> ディレクトリ内のファイルを読み書きしている様子をトレースしてみましょう。Tetragonの<a target="_blank" rel="noopener" href="https://github.com/cilium/tetragon/blob/main/examples/tracingpolicy/sys_write_follow_fd_prefix.yaml">examplesとして提供されているmanifest</a>を使います。</p>
<figure class="highlight yaml"><figcaption><span>sys_write_follow_fd_prefix.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">cilium.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">TracingPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&quot;sys-read-follow-prefix&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">kprobes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">call:</span> <span class="string">&quot;fd_install&quot;</span></span><br><span class="line">    <span class="attr">syscall:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">return:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">index:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">int</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">index:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">&quot;file&quot;</span></span><br><span class="line">    <span class="attr">selectors:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">matchPIDs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">operator:</span> <span class="string">NotIn</span></span><br><span class="line">        <span class="attr">followForks:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">isNamespacePID:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">values:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">matchArgs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">index:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">operator:</span> <span class="string">&quot;Prefix&quot;</span></span><br><span class="line">        <span class="attr">values:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;/etc/&quot;</span></span><br><span class="line">      <span class="attr">matchActions:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">FollowFD</span></span><br><span class="line">        <span class="attr">argFd:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">argName:</span> <span class="number">1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">call:</span> <span class="string">&quot;sys_close&quot;</span></span><br><span class="line">    <span class="attr">syscall:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">index:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">&quot;int&quot;</span></span><br><span class="line">    <span class="attr">selectors:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">matchActions:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">UnfollowFD</span></span><br><span class="line">        <span class="attr">argFd:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">argName:</span> <span class="number">0</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">call:</span> <span class="string">&quot;sys_read&quot;</span></span><br><span class="line">    <span class="attr">syscall:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">index:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">&quot;fd&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">index:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">&quot;char_buf&quot;</span></span><br><span class="line">      <span class="attr">returnCopy:</span> <span class="literal">true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">index:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">&quot;size_t&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">call:</span> <span class="string">&quot;sys_write&quot;</span></span><br><span class="line">    <span class="attr">syscall:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">index:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">&quot;fd&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">index:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">&quot;char_buf&quot;</span></span><br><span class="line">      <span class="attr">sizeArgIndex:</span> <span class="number">3</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">index:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">&quot;size_t&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f sys_write_follow_fd_prefix.yaml</span><br></pre></td></tr></table></figure>

<p>試しに実験用のPod内で <code>/etc/passwd</code> を編集してみましょう。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">exec</span> -it busybox -- /bin/sh</span><br><span class="line">/ <span class="comment"># vi /etc/passwd</span></span><br></pre></td></tr></table></figure>

<p>Tetragonのログを見るとファイルの <code>open</code> <code>read</code> <code>close</code> をトレースできています。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">🚀 process default/busybox /bin/vi /etc/passwd</span><br><span class="line">📬 open    default/busybox /bin/vi /etc/passwd</span><br><span class="line">📚 <span class="built_in">read</span>    default/busybox /bin/vi /etc/passwd 340 bytes</span><br><span class="line">📪 close   default/busybox /bin/vi</span><br><span class="line">💥 <span class="built_in">exit</span>    default/busybox /bin/vi /etc/passwd 0</span><br></pre></td></tr></table></figure>

<p><code>/etc/</code> ディレクトリ以外のファイルへの書き込みはトレースされません。なぜなら、eBPFプログラムがトレーシング対象のカーネル関数の引数として渡されるファイル名を取得し、フィルタリングしているからです。</p>
<p>Tracing Policyの内容の詳しく見て行きましょう。一部を取り出してみました。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span>   </span><br><span class="line">  <span class="attr">kprobes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">call:</span> <span class="string">&quot;fd_install&quot;</span></span><br><span class="line">    <span class="attr">syscall:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">return:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">index:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">int</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">index:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">&quot;file&quot;</span></span><br><span class="line">    <span class="attr">selectors:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">matchPIDs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">operator:</span> <span class="string">NotIn</span></span><br><span class="line">        <span class="attr">followForks:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">isNamespacePID:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">values:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">matchArgs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">index:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">operator:</span> <span class="string">&quot;Prefix&quot;</span></span><br><span class="line">        <span class="attr">values:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;/etc/&quot;</span></span><br><span class="line">      <span class="attr">matchActions:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">FollowFD</span></span><br><span class="line">        <span class="attr">argFd:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">argName:</span> <span class="number">1</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>kprobeというのは先ほども出てきましたが、カーネルの関数に動的に処理を差し込むための仕組みなのでした。<code>spec.krpobes</code> より下の階層はつぎのような意味です</p>
<ul>
<li><code>call</code>にはトレース対象のカーネル関数を定義します。今回は<code>fd_install</code>が対象です。この関数はファイルテーブルに新しいファイルディスクリプタを割り当てる関数、、、早い話がファイルオープン時に必ず呼ばれる関数です。この関数にkprobeを使ってeBPFプログラムをアタッチする、ということです。fd_install&#96; の引数の0番目はint型、1番目はfileという構造体であり、これらの引数をトレースに含めます。</li>
<li><code>selectors</code>以下はフィルタリング条件と、フィルターにマッチしたときの挙動を定義しています。<ul>
<li><code>matchPID</code><ul>
<li>PID Namespace内でpid&#x3D;1ではないプロセスに対してトレースする（つまりコンテナで動かす本来のプロセスはpid 1なのでトレース対象外で、 <code>kubectl exec</code> などで実行したプロセスがトレース対象となります）</li>
</ul>
</li>
<li>matchArgs<ul>
<li>indexの1番目&#x3D;fileのprefixが <code>etc</code> の場合にトレースする。</li>
</ul>
</li>
<li><code>matchActions.action: FollowFD</code><ul>
<li>カーネル関数に渡されたファイルディスクリプタとファイル名をBPF mapに保存する。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>他の<code>spec.kprobe</code>以下の部分も同じように、どの関数にeBPFをアタッチするかを定義しています。</p>
<p><code>FllowFD</code>によってBPF mapに保存されたファイルディスクリプタは、他の関数にアタッチされたeBPFからルックアップされます。今回のTracingPolicyだと<code>sys_read()</code>にアタッチされたeBPFが、関数の引数として渡されるファイルディスクリプタがBPF mapに保存されているものかどうかを参照し、そうであればトレースする、という挙動をとります。</p>
<p>今までトレーシング機能を紹介してきましたが、フィルタリング条件に合致するイベントを検出した際に、プロセスに直接SIGKILLを送出する、といったことも可能です。</p>
<h2 id="終わりに"><a href="#終わりに" class="headerlink" title="終わりに"></a>終わりに</h2><p>eBPFとeBPF製品Tetragonに入門にしてみました。Tetragonの親プロジェクトのCiliumでは、eBPFでネットワークを効率化しています。主要クラウドプロバイダーのKubernetesサービスでは、Ciliumが使用できるようになっており、例えばGoogle CloudのGKEでは<a target="_blank" rel="noopener" href="https://cloud.google.com/kubernetes-engine/docs/concepts/dataplane-v2?hl=ja">Dataplane V2</a>というモードで提供されています。暇があればCilium, eBPF+ネットワークも勉強したいなと思います。</p>
<p>TetragonやBCCの公式ドキュメントのほか、以下のブログを参考にしました。</p>
<p><a target="_blank" rel="noopener" href="https://blog.yuuk.io/entry/2021/ebpf-tracing">https://blog.yuuk.io/entry/2021/ebpf-tracing</a></p>
<p><a target="_blank" rel="noopener" href="https://gihyo.jp/admin/serial/01/ubuntu-recipe/0688">https://gihyo.jp/admin/serial/01/ubuntu-recipe/0688</a></p>

          
        </div>
        <footer>
          <section class="social-area">
          <!-- シェアボタン START -->
  <ul class="social-button">
    
    <!-- Twitter -->
    <li>
      <a class="social-btn twitter-btn" target="_blank" href="https://twitter.com/share?url=https://future-architect.github.io/articles/20230623a/&related=twitterapi%2Ctwitter&text=Tetragon%E3%81%A7eBPF%E3%81%A8%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3%E3%82%AA%E3%83%96%E3%82%B5%E3%83%BC%E3%83%90%E3%83%93%E3%83%AA%E3%83%86%E3%82%A3%E5%85%A5%E9%96%80%20%7C%20%E3%83%95%E3%83%A5%E3%83%BC%E3%83%81%E3%83%A3%E3%83%BC%E6%8A%80%E8%A1%93%E3%83%96%E3%83%AD%E3%82%B0" rel="nofollow noopener">
        <i></i><span class="social-btn-label">ツイート</span>
      </a>
    </li>
    <!-- Facebook -->
    <li>
      <a class="social-btn fb-btn" target="_blank" href="http://www.facebook.com/share.php?u=https://future-architect.github.io/articles/20230623a/&t=Tetragon%E3%81%A7eBPF%E3%81%A8%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3%E3%82%AA%E3%83%96%E3%82%B5%E3%83%BC%E3%83%90%E3%83%93%E3%83%AA%E3%83%86%E3%82%A3%E5%85%A5%E9%96%80" rel="nofollow noopener">
        <i></i><span class="social-btn-label">シェア</span>
      </a>
    </li>
    <!-- hatebu -->
    <li>
      <a class="social-btn hatebu-btn" target="_blank" href="https://b.hatena.ne.jp/entry/s/future-architect.github.io/articles/20230623a/" rel="nofollow noopener">
        <i></i><span class="social-btn-label">33</span>
      </a>
    </li>
    <!-- pocket -->
    <li>
      <a class="social-btn pocket-btn" target="_blank" href="https://getpocket.com/save?url=https://future-architect.github.io/articles/20230623a/" rel="nofollow noopener">
        <i></i><span class="social-btn-label">17</span>
      </a>
    </li>
    
  </ul>
<!-- シェアボタン END -->

          </section>
          <aside>
            <section class="related-post margin-bottom-40 nav">
              <h2 id="related"><a href="#related" class="headerlink" title="関連記事"></a>関連記事</h2>
              
  <div class="widget">
    <ul class="nav related-post-link"><li class="related-posts-item"><span>2022.01.12</span><span class="snscount">&#9825;85</span><a href=/articles/20220112a/ title="チームの輪読会でKuberntes完全ガイドを読みました。 k8s本は、GKEを例にしながら、k8sのCLIツールだったりマニフェストのyamlファイルを丁寧に紹介しており、実践的に勉強するの適しています。手を動かしつつ勉強したいところですが、クラウドプロバイダーが提供するマネージドk8sはコストが高めで気分的にほいほい使えないところがあります。となるとローカル環境でk8sを用意したくなります。 ">Minikubeでk8s学習を進めるためのヒント</a></li><li class="related-posts-item"><span>2020.10.01</span><span class="snscount">&#9825;8</span><a href=/articles/20201001/ title="CNCF連載の第3回はLinkerdについて書いていきます。LinkerdはCNCFのIncubating projectsに所属しているサービスメッシュプロダクトです。">Linkerdで始めるサービスメッシュ</a></li><li class="related-posts-item"><span>2020.09.29</span><span class="snscount">&#9825;33</span><a href=/articles/20200929/ title="こんにちは。TIG/DXチームの伊藤太斉です。アプリケーションをコンテナ化することが主流になった昨今、エッジコンピューティングでもコンテナを利用する機会が出てきました。そのため、サーバー上でKubernetesを利用して、コンテナをオーケストレーションをするのと同じようにエッジデバイスでもコンテナを管理する機能が求められるようになってきました。ここで、本記事では2020年の8月にCNCF入りを果たしたk3sについて触れていきます。">k3sを知る、動かす、感じる</a></li><li class="related-posts-item"><span>2020.09.29</span><span class="snscount">&#9825;0</span><a href=/articles/en/20200929/ title="Containerization of applications has become mainstream these days, and there are opportunities to use containers in edge computing as well. In this article, I would like to share some of the key points of this article.">Know, move, and feel k3s</a></li><li class="related-posts-item"><span>2023.06.27</span><span class="snscount">&#9825;10</span><a href=/articles/20230627a/ title="業務では主にCIとしてJenkinsを利用しているのですが、前々から気になっていたArgo CDを本連載を機に体感してみたいと思います。">Argo CDを体感してみる</a></li><li class="related-posts-item"><span>2023.06.26</span><span class="snscount">&#9825;40</span><a href=/articles/20230626a/ title="CNCF の Knative を基盤として利用している Cloud Run と CNCF の各種ビルドツール ko, skaffold、Cloud Deploy を用いたうえで、アプリケーションのビルドからデプロイまでを行います。">Cloud Run に ko と skaffold を使ってデプロイまでやってみる</a></li></ul>
  </div>
            </section>
            <section class="reference-post margin-bottom-40 nav">
              
  <div class="card">
    <div id="reference" class="reference-lede"><a href="#reference" class="headerlink" title="参照されている記事"></a>この記事を参照している記事</div>
    <ul class="reference-post-link"><li class="reference-posts-item"><a href=/articles/20230619a/ title="Cloud Native Computing FoundationのOSSを取り扱うブログ連載のインデックスです。">CNCF連載2023を始めます</a></li></ul>
  </div>
            </section>
          </aside>
        </footer>
      </div>
    </article>
  </main>
  <aside class="col-md-3 blog-sidebar">
    <!-- START SIDEBAR  -->


<section class="toc-section">
  <h2 class="margin-top-30">目次</h2>
  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><span class="toc-text">はじめに</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#eBPF%E5%85%A5%E9%96%80"><span class="toc-text">eBPF入門</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Tetragon"><span class="toc-text">Tetragon</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E3%83%97%E3%83%AD%E3%82%BB%E3%82%B9%E5%AE%9F%E8%A1%8C%E3%81%AE%E7%9B%A3%E8%A6%96"><span class="toc-text">プロセス実行の監視</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%AE%E7%9B%A3%E8%A6%96"><span class="toc-text">ファイルアクセスの監視</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B5%82%E3%82%8F%E3%82%8A%E3%81%AB"><span class="toc-text">終わりに</span></a></li></ol>
</section>

<section class="category">
<h2 class="margin-top-30">カテゴリー</h2>
<div class="widget">
  <ul class="nav sidebar-categories margin-bottom-40">
  
  <li class=""><a href="/categories/Programming/">Programming (399)</a></li>
<li class=""><a href="/categories/Infrastructure/">Infrastructure (239)</a></li>
<li class=""><a href="/categories/Culture/">Culture (88)</a></li>
<li class=""><a href="/categories/DataScience/">DataScience (58)</a></li>
<li class=""><a href="/categories/IoT/">IoT (34)</a></li>
<li class=""><a href="/categories/DB/">DB (23)</a></li>
<li class=""><a href="/categories/DevOps/">DevOps (21)</a></li>
<li class=""><a href="/categories/Business/">Business (21)</a></li>
<li class=""><a href="/categories/%E8%AA%8D%E8%A8%BC%E8%AA%8D%E5%8F%AF/">認証認可 (20)</a></li>
<li class=""><a href="/categories/Management/">Management (15)</a></li>
<li class=""><a href="/categories/Security/">Security (13)</a></li>
<li class=""><a href="/categories/VR/">VR (12)</a></li>
<li class=""><a href="/categories/Design/">Design (11)</a></li>

  </ul>
</div>

</section>
<section class="podcast-link">
<h2 class="margin-top-30">Tech Cast</h2>

  <div class="class="widget-wrap">
  <div class="widget">
    <ul class="nav techcast">
      <li><a href="https://podcasters.spotify.com/pod/show/futuretechcast/episodes/38-AIAI-e22h1v0" title="フューチャーがお届けするポッドキャストです。#38 AIグループリーダー加藤さんに聞く「AIチームのミッションと展望」" target="_blank" rel="noopener"> #38 AIグループリーダー加藤さんに聞く「AIチームのミッションと展望」</a></li>
<li><a href="https://podcasters.spotify.com/pod/show/futuretechcast/episodes/37-e227p84" title="フューチャーがお届けするポッドキャストです。#37 自然言語処理を使った文書検索エンジンシステム開発と新規サービス検討（後編）" target="_blank" rel="noopener"> #37 自然言語処理を使った文書検索エンジンシステム開発と新規サービス検討（後編）</a></li>
<li><a href="https://podcasters.spotify.com/pod/show/futuretechcast/episodes/36-e1rdbcu" title="フューチャーがお届けするポッドキャストです。#36 自然言語処理を使った文書検索エンジンシステム開発と新規サービス検討（前編）" target="_blank" rel="noopener"> #36 自然言語処理を使った文書検索エンジンシステム開発と新規サービス検討（前編）</a></li>
    </ul>
  </div>
  </div>
  
</section>
<section class="advent-calendar">
<h2 class="margin-top-30">アドベントカレンダー</h2>
<div class="widget">
  <ul class="nav-flex">
    <li><a href="http://qiita.com/advent-calendar/2022/future" title="フューチャー Advent Calendar 2022 #Qiita" target="_blank" rel="noopener">2022年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2021/future" title="フューチャー Advent Calendar 2021 #Qiita" target="_blank" rel="noopener">2021年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2020/future" title="フューチャー Advent Calendar 2020 #Qiita" target="_blank" rel="noopener">2020年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2019/future" title="フューチャー Advent Calendar 2019 #Qiita" target="_blank" rel="noopener">2019年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2018/future" title="フューチャー Advent Calendar 2018 #Qiita" target="_blank" rel="noopener">2018年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2017/future" title="フューチャー Advent Calendar 2017 #Qiita" target="_blank" rel="noopener">2017年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2016/future" title="フューチャー Advent Calendar 2016 #Qiita" target="_blank" rel="noopener">2016年</a></li>
    <li><a href="http://qiita.com/advent-calendar/2015/future" title="フューチャー Advent Calendar 2015 #Qiita" target="_blank" rel="noopener">2015年</a></li>
  </ul>
</div>

</section>
<!-- END SIDEBAR -->

  </aside>
</div>

  </section>
</div>

      <!-- BEGIN PRE-FOOTER -->
    <footer>
      <div class="pre-footer">
        <div class="container">
          <div class="row">
            <div class="col-lg-4 col-md-4 col-sm-6 col-6 pre-footer-col">
              <h2>About Us</h2>
              <p>経営とITをデザインする、フューチャーの技術ブログです。業務で利用している幅広い技術について紹介します。<br /><br /><a target="_blank" rel="noopener" href="http://www.future.co.jp/">http://www.future.co.jp/</a></p>
              <div class="social-btn twitter-btn twitter-follow-btn">
                <a href="https://twitter.com/intent/follow?screen_name=future_techblog " target="_blank" rel="nofollow noopener">
                  <i></i><span class="tw-btn-label">フューチャー技術ブログをフォロー</span>
                </a>
              </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-4 col-4 pre-footer-col">
              <h2>Contact</h2>
              <address class="margin-bottom-40">
                <a href="https://www.future.co.jp/recruit/recruit/rec-fresh/" title="新卒採用" target="_blank" rel="noopener">新卒採用</a><br>
                <a href="https://www.future.co.jp/recruit/recruit/rec-career/" title="キャリア採用" target="_blank" rel="noopener">キャリア採用</a><br>
                <a href="https://www.future.co.jp/contact_us/" title="お問い合わせページ" target="_blank" rel="noopener">お問い合わせ</a><br>
                <a href="https://www.future.co.jp/architect/socialmediapolicy/" title="ソーシャルメディアポリシー" target="_blank" rel="noopener">メディアポリシー</a><br><br>
                <a href="mailto:techblog@future.co.jp">techblog@future.co.jp</a>
              </address>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 col-6 pre-footer-col">
              <h2>Contents</h2>
              <a href="https://future-architect.github.io/coding-standards/" title="Future Enterprise Coding Standards" target="_blank" rel="noopener">コーディング規約</a><br>
              <a href="https://future-architect.github.io/typescript-guide/" title="仕事ですぐに使えるTypeScript" target="_blank" rel="noopener">仕事ですぐに使えるTypeScript</a><br>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-3 col-3 pre-footer-col">
              <h2>Event</h2>
              <a href="https://future.connpass.com/" title="経営とITをデザインするフューチャーの勉強会です" target="_blank" rel="noopener">connpass</a><br>
              <a href="https://www.future.co.jp/futureinsightseminar/" title="フューチャーインサイトセミナー" target="_blank" rel="noopener">Webセミナー</a><br>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-3 col-3 pre-footer-col">
              <h2>SNS</h2>
              <a href="https://github.com/future-architect" title="Future's official open source repositories" target="_blank" rel="noopener">GitHub</a><br>
              <a href="https://qiita.com/organizations/future" title="フューチャーのQiita Organizationです" target="_blank" rel="noopener">Qiita</a><br>
              <a href="https://note.future.co.jp/" title="フューチャーの公式note" target="_blank" rel="noopener">未来報</a><br>
              <a href="https://www.youtube.com/channel/UCJUSwYYd0CkGgmEKAW7QVpw" title="フューチャーYoutubeチャネル" target="_blank" rel="noopener">Youtube</a>
            </div>
          </div>
        </div>
      </div>
      <div class="footer">
        <div class="container">
          <div class="row">
            <div class="col-md-6 col-sm-6 padding-top-10">
              &copy; 2023 フューチャー技術ブログ<br>
            </div>
          </div>
        </div>
      </div>
    </footer>

  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-X1C28R8H0M"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-X1C28R8H0M');
  gtag('config', 'UA-74047147-1'); // 過渡期対応
</script>

  </div>
</body>
</html>
