<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0"
  xmlns:atom="http://www.w3.org/2005/Atom"
  xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>フューチャー技術ブログ</title>
    <link>https://future-architect.github.io/</link>
    
    <image>
      <url>https://future-architect.github.io/feed_icon.png</url>
      <title>フューチャー技術ブログ</title>
      <link>https://future-architect.github.io/</link>
    </image>
    
    <atom:link href="https://future-architect.github.io/rss2.xml" rel="self" type="application/rss+xml"/>
    
    <description>フューチャーの開発者による公式技術ブログです。業務で利用している技術を幅広く紹介します。</description>
    <pubDate>Wed, 31 Jan 2024 01:33:37 GMT</pubDate>
    <generator>http://hexo.io/</generator>
    
    <item>
      <title>Go 1.22リリース連載 archive/tar, archive/zip, bufio, io</title>
      <link>https://future-architect.github.io/articles/20240131a/</link>
      <guid>https://future-architect.github.io/articles/20240131a/</guid>
      <pubDate>Tue, 30 Jan 2024 15:00:00 GMT</pubDate>
      
        
        
          
          
      <description>&lt;img src=&quot;/images/20240131a/top.png&quot; alt=&quot;&quot; width=&quot;1000&quot; height=&quot;642&quot;&gt;

&lt;p&gt;The Gopher character is based on the Go mascot designed by &lt;a</description>
          
        
      
      
      
      <content:encoded><![CDATA[<img src="/images/20240131a/top.png" alt="" width="1000" height="642"><p>The Gopher character is based on the Go mascot designed by <a href="http://reneefrench.blogspot.com/">Renée French</a></p><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>TIG 真野です。<a href="/articles/20240129a/">Go1.22連載</a>の3本目です。</p><p>Go 1.22のマイナーアップデートのうち、ファイルなどの入出力に関連しそうな <code>archive/tar</code> ・<code>archive/zip</code>・<code>bufio</code>・<code>io</code> を取り上げて紹介します。</p><h2 id="アップデートサマリ"><a href="#アップデートサマリ" class="headerlink" title="アップデートサマリ"></a>アップデートサマリ</h2><ul><li>archive&#x2F;zip に <code>Writer.AddFS</code> が追加された <a href="https://go.dev/issue/54898">#54898</a></li><li>archive&#x2F;tar に <code>Writer.AddFS</code> が追加された <a href="https://github.com/golang/go/issues/58000">#58000</a></li><li>bufio の Scannerが、<code>SplitFunc</code> が <code>ErrFinalToken</code> を返すときに即時停するようになった。従来は <code>[]byte&#123;&#125;</code>を返していた <a href="https://github.com/golang/go/issues/56381">#56381</a></li><li>io の <code>SectionReader.Outer()</code> メソッドが追加された <a href="https://github.com/golang/go/issues/61870">#61870</a></li></ul><h2 id="archive-x2F-zip-54898"><a href="#archive-x2F-zip-54898" class="headerlink" title="archive&#x2F;zip #54898"></a>archive&#x2F;zip <a href="https://go.dev/issue/54898">#54898</a></h2><p>archive&#x2F;zipパッケージに<a href="https://pkg.go.dev/archive/zip@master#Writer.AddFS">Writer.AddFS</a> というメソッドが追加されました。処理としては、FS、つまりファイルシステムを入力として、ルートからディレクトリツリーを辿ってフォルダ構成を維持しながら全ファイルをzip化します。便利ですね。</p><p>これが登場する以前は、<a href="https://stackoverflow.com/questions/37869793/how-do-i-zip-a-directory-containing-sub-directories-or-files-in-golang">Stack Overflow</a>など複数の記事でいくつか実装例を参考にしながら各自が実装していたようで、揺れていたり実装ミスが発生したようです。zip.NewWriter()でzipに追加したいファイルを1つ1つ追加する必要がありました。</p><p>Stack Overflowの例もFileWalkerなどを使って（それなりの量を）実装する必要があります。また、w.Create()の前に書いてあるコメント通り、指定されたパスが相対パスにする必要があったり、Windowsでも動作するようにするためには、一工夫がさらに必要です。</p><figure class="highlight go"><figcaption><span>StackOverflowトップ回答の実装例からコメント追加</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;archive/zip&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;io&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">    <span class="string">&quot;path/filepath&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Zips &quot;./input&quot; into &quot;./output.zip&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    zipFile, err := os.Create(<span class="string">&quot;output.zip&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err) <span class="comment">// サンプルコードなのでpanicしています</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> zipFile.Close()</span><br><span class="line"></span><br><span class="line">    w := zip.NewWriter(zipFile)</span><br><span class="line">    <span class="keyword">defer</span> w.Close()</span><br><span class="line"></span><br><span class="line">    walker := <span class="function"><span class="keyword">func</span><span class="params">(path <span class="type">string</span>, info os.FileInfo, err <span class="type">error</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> info.IsDir() &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span> <span class="comment">// ディレクトリは無視してOK（ファイル追加のときに自動で追加されるため）</span></span><br><span class="line">        &#125;</span><br><span class="line">        file, err := os.Open(path)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">defer</span> file.Close()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Ensure that `path` is not absolute; it should not start with &quot;/&quot;.</span></span><br><span class="line">        <span class="comment">// This snippet happens to work because I don&#x27;t use </span></span><br><span class="line">        <span class="comment">// absolute paths, but ensure your real-world code </span></span><br><span class="line">        <span class="comment">// transforms path into a zip-root relative path.</span></span><br><span class="line">        f, err := w.Create(path)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        _, err = io.Copy(f, file)</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> err = filepath.Walk(<span class="string">&quot;input&quot;</span>, walker); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err) <span class="comment">// サンプルコードなのでpanicしています</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>これが次のように書き換わります。</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;archive/zip&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">zipFile, err := os.Create(<span class="string">&quot;output.zip&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err) <span class="comment">// サンプルコードなのでpanicしています</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> zipFile.Close()</span><br><span class="line"></span><br><span class="line">w := zip.NewWriter(zipFile)</span><br><span class="line"><span class="keyword">defer</span> w.Close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err := w.AddFS(os.DirFS(<span class="string">&quot;input&quot;</span>)); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>とても楽ですし、直感的ですね！ちなみに、空フォルダはzip化されないようです。</p><p>また、何かしらのファイルを除去したいなどのフィルター処理をしたい場合は、それを行う <code>fs.FS</code> を作成して回避するといった考えのようです。</p><p><code>fs.FS</code> を引数に取るということは、別の応用も効かせられます。<a href="https://github.com/jszwec/s3fs">jszwec&#x2F;s3fs</a> はS3の指定されたバケットに対して<code>fs.FS</code> インターフェースを満たすライブラリです。例えばこれを用いると、S3バケットがそのままzip化されます。</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;archive/zip&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;github.com/aws/aws-sdk-go/aws&quot;</span></span><br><span class="line"><span class="string">&quot;github.com/aws/aws-sdk-go/aws/endpoints&quot;</span></span><br><span class="line"><span class="string">&quot;github.com/aws/aws-sdk-go/aws/session&quot;</span></span><br><span class="line"><span class="string">&quot;github.com/aws/aws-sdk-go/service/s3&quot;</span></span><br><span class="line"><span class="string">&quot;github.com/jszwec/s3fs&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">zipFile, err := os.Create(<span class="string">&quot;output.zip&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> zipFile.Close()</span><br><span class="line"></span><br><span class="line">w := zip.NewWriter(zipFile)</span><br><span class="line"><span class="keyword">defer</span> w.Close()</span><br><span class="line"></span><br><span class="line">fs := s3fs.New(s3.New(session.Must(session.NewSessionWithOptions(session.Options&#123;</span><br><span class="line">Profile:           <span class="string">&quot;YOUR PROFILE&quot;</span>,</span><br><span class="line">SharedConfigState: session.SharedConfigEnable,</span><br><span class="line">Config: aws.Config&#123;</span><br><span class="line">Region: aws.String(endpoints.ApNortheast1RegionID),</span><br><span class="line">&#125;,</span><br><span class="line">&#125;))), <span class="string">&quot;my-example-bucket&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err := w.AddFS(fs); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">&quot;finish&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ビルディングブロック的に、zip化ができるようになったのは画期的だと思います。</p><p>【注意】上記のコードはS3バケットまるごとダウンロードするので、バケットのデータ量によっては利用を控えたほうが無難です。また、s3fs側の実装とAddFS()の組み合わせが悪いのか、S3に空フォルダオブジェクト（キー名が<code>/</code>で終わるオブエジェクト）が含まれる場合は、上手くzip化されないようです（実行時エラーとなります）。ご注意ください。</p><h2 id="archive-x2F-tar-58000"><a href="#archive-x2F-tar-58000" class="headerlink" title="archive&#x2F;tar #58000"></a>archive&#x2F;tar <a href="https://github.com/golang/go/issues/58000">#58000</a></h2><p>archive&#x2F;tarパッケージに<a href="https://pkg.go.dev/archive/tar@master#Writer.AddFS">Writer.AddFS</a> というメソッドが追加されました。背景や内容については、<code>archive/zip</code> と全く同じでしたので割愛します。</p><h2 id="bufio-56381"><a href="#bufio-56381" class="headerlink" title="bufio #56381"></a>bufio <a href="https://github.com/golang/go/issues/56381">#56381</a></h2><p>Scannerが、<a href="https://pkg.go.dev/bufio@master#SplitFunc">bufio.SplitFunc</a> を受け取り、 <code>ErrFinalToken</code> を返した場合は停止するようになりました。従来は <code>[]byte</code> を返していました。</p><p>まずScannerには<a href="https://pkg.go.dev/bufio@master#Scanner.Split">Split()</a> という関数があり、<code>Split()</code> は <code>SplitFunc</code> を引数に取ります。</p><figure class="highlight go"><figcaption><span>Scanner</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Scanner)</span></span> Split(split SplitFunc)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> SplitFunc <span class="function"><span class="keyword">func</span><span class="params">(data []<span class="type">byte</span>, atEOF <span class="type">bool</span>)</span></span> (advance <span class="type">int</span>, token []<span class="type">byte</span>, err <span class="type">error</span>)</span><br></pre></td></tr></table></figure><p>例としてIssueにあったScannerの実装を上げます。</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">const</span> input = <span class="string">&quot;1,2,STOP,4,&quot;</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">// Scannerの宣言</span></span><br><span class="line">scanner := bufio.NewScanner(strings.NewReader(input))</span><br><span class="line"></span><br><span class="line"> <span class="comment">// SplitFunc</span></span><br><span class="line">onComma := <span class="function"><span class="keyword">func</span><span class="params">(data []<span class="type">byte</span>, atEOF <span class="type">bool</span>)</span></span> (advance <span class="type">int</span>, token []<span class="type">byte</span>, err <span class="type">error</span>) &#123;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(data); i++ &#123;</span><br><span class="line"><span class="keyword">if</span> data[i] == <span class="string">&#x27;,&#x27;</span> &#123;</span><br><span class="line"><span class="comment">// if the token is &quot;STOP&quot;, ignore the rest</span></span><br><span class="line"><span class="keyword">if</span> <span class="type">string</span>(data[:i]) == <span class="string">&quot;STOP&quot;</span> &#123;</span><br><span class="line"><span class="keyword">return</span> i + <span class="number">1</span>, <span class="literal">nil</span>, bufio.ErrFinalToken</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> i + <span class="number">1</span>, data[:i], <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>, data, bufio.ErrFinalToken</span><br><span class="line">&#125;</span><br><span class="line"> <span class="comment">// ScannerにSplitFuncを設定</span></span><br><span class="line">scanner.Split(onComma)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 読み取り処理（SplitFuncで入力を分割しながら読み取れる）</span></span><br><span class="line"><span class="keyword">for</span> scanner.Scan() &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;Got a token %q\n&quot;</span>, scanner.Text())</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> err := scanner.Err(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Fprintln(os.Stderr, <span class="string">&quot;reading input:&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上記で、scanner.Scan() ですが、inputは1行ですが、ループはカンマごとにSplitFunc() で分割され、またSTOPという文字列で停止するために2回ループが実行されるのが想定だと思います。</p><p>go1.21以前では、これが3回実行されていましたが、go1.22以降では2回の実行となります。</p><p>go1.21以前:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Got a token &quot;1&quot;</span><br><span class="line">Got a token &quot;2&quot;</span><br><span class="line">Got a token &quot;&quot;</span><br></pre></td></tr></table></figure><p>go1.22以降：</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Got a token &quot;1&quot;</span><br><span class="line">Got a token &quot;2&quot;</span><br></pre></td></tr></table></figure><p>変更理由は、このデータを取りたいケースは存在しないだろうということで、どちらかといえばあるべき動きに訂正されたようです。</p><h2 id="io-61870"><a href="#io-61870" class="headerlink" title="io(#61870)"></a>io(<a href="https://github.com/golang/go/issues/61870">#61870</a>)</h2><p><code>io.SectionReader</code> に以下のメソッドが追加されました。</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SectionReader)</span></span> Outer() (r ReaderAt, off <span class="type">int64</span>, n <span class="type">int64</span>)</span><br></pre></td></tr></table></figure><p>SectionReader自体はRead(), Seek(), ReadAt() を実装する、入力を指定された オフセット～長さに区切ったReaderです。GoDocのExampleを見ると何をするようなものか一目瞭然です。</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;io&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line"><span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">r := strings.NewReader(<span class="string">&quot;some io.Reader stream to be read\n&quot;</span>)</span><br><span class="line">s := io.NewSectionReader(r, <span class="number">5</span>, <span class="number">17</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> _, err := io.Copy(os.Stdout, s); err != <span class="literal">nil</span> &#123; <span class="comment">// 「io.Reader stream」と出力</span></span><br><span class="line"> log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>これに <code>Outer()</code> を追加します。</p><figure class="highlight diff"><table><tr><td class="code"><pre><span class="line">func main() &#123;</span><br><span class="line">r := strings.NewReader(&quot;some io.Reader stream to be read\n&quot;)</span><br><span class="line">s := io.NewSectionReader(r, 5, 17)</span><br><span class="line"></span><br><span class="line">if _, err := io.Copy(os.Stdout, s); err != nil &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="addition">+outer, off, n := s.Outer()</span></span><br><span class="line"><span class="addition">+fmt.Println(reflect.TypeOf(outer), off, n) // 「io.Reader stream *strings.Reader 5 17」が出力</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>実行すると、引数で渡した<code>strings.Reader, offset=5, length=17</code> が取得できます。</p><p>さて、機能はわかったところで、これが追加された理由です。<code>io</code> 側のコメントを追っていくと、<a href="https://github.com/golang/go/issues/61727">net: support zero-copy send on TCPConn when reading from File via SectionReader #61727</a>がモチベーションのようです。</p><p><code>#61727</code> の内容は私が理解しきれた範囲だと以下です（補足、訂正大歓迎です）</p><ul><li><code>net.TCPConn</code> でファイル送信する場合に、ゼロコピーになるのは現在、<code>LimitedReader</code> のみ<ul><li><a href="https://github.com/golang/go/blob/cc85462b3d23193e4861813ea85e254cfe372403/src/net/sendfile_linux.go#L23-L28">https://github.com/golang/go/blob/cc85462b3d23193e4861813ea85e254cfe372403/src/net/sendfile_linux.go#L23-L28</a> の実装を見ると、 handled&#x3D;trueの場合はゼロコピーとなる。</li><li>そうじゃない場合は、netパッケージのgenericReadFromが呼ばれる</li></ul></li><li><code>SectionReader</code> もゼロコピー対応したい</li><li>対応できると、FD（File descriptor）を同時に使用して同じファイルを複数の TCP 接続に送信できるようになり、他のユースケース (範囲リクエストなど) もサポートできる</li><li>今でもそれはできるが、システムコールやメモリ割り当てが発生してしまう（≒genericReadFromが呼ばれる）</li></ul><p>この対応が入れば、GoのHTTPサーバの応答性能がさらに上がりそう、というのがわかります。今後に期待ですね。</p><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>派手さはないですが、こういった細かいアップデートを確認していくと、Stack Overflowなどでコミュニティ側が混乱していそうな点を標準パッケージ側で吸収しGoアプリケーションとしての品質向上に努めたり、性能観点など、確実にGoが良くなっているのが感じられます。</p><p>個人的には、fs.FSをインターフェースにzip化できるのは、便利で応用力が高くて良い設計だな感嘆しました。私が設計者なら、普通にディレクリパスを渡して、あるフォルダごとzip化するようなインターフェースを考えてしまいそうです。</p><p>ライブラリのAPI設計の勉強にもなり学びでした。次のバージョンでもこのブログ連載に参加しようと思います。</p>]]></content:encoded>
      
      
      <category domain="https://future-architect.github.io/categories/Programming/">Programming</category>
      
      
      <category domain="https://future-architect.github.io/tags/Go/">Go</category>
      
      <category domain="https://future-architect.github.io/tags/Go1-22/">Go1.22</category>
      
      <category domain="https://future-architect.github.io/tags/tar/">tar</category>
      
      <category domain="https://future-architect.github.io/tags/zip/">zip</category>
      
      
      <comments>https://future-architect.github.io/articles/20240131a/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>Go 1.22 リリース連載 slicesのマイナーアップデート</title>
      <link>https://future-architect.github.io/articles/20240130a/</link>
      <guid>https://future-architect.github.io/articles/20240130a/</guid>
      <pubDate>Mon, 29 Jan 2024 15:00:00 GMT</pubDate>
      
        
        
          
          
      <description>&lt;img src=&quot;/images/20240130a/top.png&quot; alt=&quot;&quot; width=&quot;1000&quot; height=&quot;675&quot;&gt;

&lt;p&gt;The Gopher character is based on the Go mascot designed by &lt;a</description>
          
        
      
      
      
      <content:encoded><![CDATA[<img src="/images/20240130a/top.png" alt="" width="1000" height="675"><p>The Gopher character is based on the Go mascot designed by <a href="http://reneefrench.blogspot.com/">Renée French</a></p><h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>TIGの辻です。<a href="/articles/20240129a/">Go1.22連載</a>の2本目です。</p><p>この記事では、マイナーアップデートから slices パッケージを取り上げて紹介します。</p><h1 id="slices-のアップデート内容"><a href="#slices-のアップデート内容" class="headerlink" title="slices のアップデート内容"></a>slices のアップデート内容</h1><ul><li>slice を連結する <code>Concat()</code> API が追加になった(<a href="https://github.com/golang/go/issues/56353">#56353</a>)</li><li>slice の長さを小さくする関数で、破棄された slice の要素をゼロ値とする(<a href="https://github.com/golang/go/issues/63393">#63393</a>)</li><li><code>Insert()</code> で引数が範囲外の場合に、常に panic させる(<a href="https://github.com/golang/go/issues/63913">#63913</a>)</li></ul><h2 id="slice-を連結する-Concat-API-が追加になった-56353"><a href="#slice-を連結する-Concat-API-が追加になった-56353" class="headerlink" title="slice を連結する Concat() API が追加になった(#56353)"></a>slice を連結する <code>Concat()</code> API が追加になった(<a href="https://github.com/golang/go/issues/56353">#56353</a>)</h2><p>以下の API が追加になりました。渡された slice を連結して新しい slice を返却します</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Concat</span>[<span class="title">S</span> ~[]<span class="title">E</span>, <span class="title">E</span> <span class="title">any</span>]<span class="params">(slices ...S)</span></span> S</span><br></pre></td></tr></table></figure><p>コード例です</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;slices&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">n1 := []<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>&#125;</span><br><span class="line">n2 := []<span class="type">int</span>&#123;<span class="number">10</span>, <span class="number">20</span>&#125;</span><br><span class="line">n3 := []<span class="type">int</span>&#123;<span class="number">100</span>, <span class="number">200</span>&#125;</span><br><span class="line">result := slices.Concat(n1, n2, n3)</span><br><span class="line">fmt.Println(result) <span class="comment">// [1 2 10 20 100 200]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ちなみにGo 1.21ですと appned() では複数の slice を連結できず、slice を unpack して以下のように実装する必要がありました。</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">n1 := []<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>&#125;</span><br><span class="line">n2 := []<span class="type">int</span>&#123;<span class="number">10</span>, <span class="number">20</span>&#125;</span><br><span class="line">n3 := []<span class="type">int</span>&#123;<span class="number">100</span>, <span class="number">200</span>&#125;</span><br><span class="line">result := <span class="built_in">append</span>(n1, <span class="built_in">append</span>(n2, n3...)...)</span><br><span class="line">fmt.Println(result) <span class="comment">// [1 2 10 20 100 200]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="slice-の長さを小さくする関数で、破棄された-slice-の要素をゼロ値とする-63393"><a href="#slice-の長さを小さくする関数で、破棄された-slice-の要素をゼロ値とする-63393" class="headerlink" title="slice の長さを小さくする関数で、破棄された slice の要素をゼロ値とする(#63393)"></a>slice の長さを小さくする関数で、破棄された slice の要素をゼロ値とする(<a href="https://github.com/golang/go/issues/63393">#63393</a>)</h2><p>以下のAPIの機能改善です。slice の長さが小さくなる関数で、破棄すべき slice の要素をゼロ値でクリアするようになっています</p><ul><li>Delete()</li><li>DeleteFunc()</li><li>Compact()</li><li>CompactFunc()</li><li>Replace()</li></ul><p><code>Delete()</code> のコード例です</p><h3 id="Go1-21"><a href="#Go1-21" class="headerlink" title="Go1.21"></a>Go1.21</h3><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;slices&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">src := []<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>&#125;</span><br><span class="line">result := slices.Delete(src, <span class="number">1</span>, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 元の slice では Delete() 後に元々あった 4, 5番目の要素が残っている</span></span><br><span class="line">fmt.Println(src) <span class="comment">// [1 4 5 6 5 6]</span></span><br><span class="line"></span><br><span class="line">fmt.Println(result) <span class="comment">// [1 4 5 6]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Go1-22"><a href="#Go1-22" class="headerlink" title="Go1.22"></a>Go1.22</h3><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;slices&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">src := []<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>&#125;</span><br><span class="line">result := slices.Delete(src, <span class="number">1</span>, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 元の slice では Delete() 後に元々あった 4, 5番目の要素はゼロ値でクリアされている</span></span><br><span class="line">fmt.Println(src) <span class="comment">// [1 4 5 6 0 0]</span></span><br><span class="line"></span><br><span class="line">fmt.Println(result) <span class="comment">// [1 4 5 6]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>横道にそれますが <code>Delete()</code> に関して CL#541477 からコードの変更内容を見てみました。<br><a href="https://go-review.googlesource.com/c/go/+/541477">https://go-review.googlesource.com/c/go/+/541477</a></p><p>変更前は要素を除いた値を <code>appned()</code> しているだけですが、変更後は明示的に <code>clear()</code> しています</p><ul><li>変更前</li></ul><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Delete</span>[<span class="title">S</span> ~[]<span class="title">E</span>, <span class="title">E</span> <span class="title">any</span>]<span class="params">(s S, i, j <span class="type">int</span>)</span></span> S &#123;</span><br><span class="line">_ = s[i:j] <span class="comment">// bounds check</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="built_in">append</span>(s[:i], s[j:]...)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>変更後</li></ul><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Delete</span>[<span class="title">S</span> ~[]<span class="title">E</span>, <span class="title">E</span> <span class="title">any</span>]<span class="params">(s S, i, j <span class="type">int</span>)</span></span> S &#123;</span><br><span class="line">_ = s[i:j] <span class="comment">// bounds check</span></span><br><span class="line"></span><br><span class="line">oldlen := <span class="built_in">len</span>(s)</span><br><span class="line">s = <span class="built_in">append</span>(s[:i], s[j:]...)</span><br><span class="line">clear(s[<span class="built_in">len</span>(s):oldlen]) <span class="comment">// zero/nil out the obsolete elements, for GC</span></span><br><span class="line"><span class="keyword">return</span> s</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Insert-で引数が範囲外の場合に、常に-panic-させる-63913"><a href="#Insert-で引数が範囲外の場合に、常に-panic-させる-63913" class="headerlink" title="Insert() で引数が範囲外の場合に、常に panic させる(#63913)"></a><code>Insert()</code> で引数が範囲外の場合に、常に panic させる(<a href="https://github.com/golang/go/issues/63913">#63913</a>)</h2><p><code>Insert()</code> APIの機能改善です。<br>Go1.21では範囲外の Index が渡されても、挿入する要素が存在しない場合は panic しませんでした。<br>ただドキュメント上での説明では <code>Insert panics if i is out of range</code> とあり動きにドキュメントと動作に乖離がありました。<br><a href="https://pkg.go.dev/slices@go1.21.0#Insert">https://pkg.go.dev/slices@go1.21.0#Insert</a></p><p>Go1.21では以下のコードが実行できます</p><h3 id="Go1-21-1"><a href="#Go1-21-1" class="headerlink" title="Go1.21"></a>Go1.21</h3><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;slices&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">s := []<span class="type">string</span>&#123;<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>&#125;</span><br><span class="line">s = slices.Insert(s, <span class="number">-1</span>) <span class="comment">// panic は起きない</span></span><br><span class="line"></span><br><span class="line">fmt.Println(s) <span class="comment">// [a b c]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ただし範囲外の Index に値を追加する場合はGo.1.21でも panic になります</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;slices&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">s := []<span class="type">string</span>&#123;<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// panic: runtime error: slice bounds out of range [:-1]</span></span><br><span class="line">s = slices.Insert(s, <span class="number">-1</span>, <span class="string">&quot;x&quot;</span>) <span class="comment">// panic が起きる</span></span><br><span class="line">    </span><br><span class="line">fmt.Println(s)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Go1-22-1"><a href="#Go1-22-1" class="headerlink" title="Go1.22"></a>Go1.22</h3><p>Go1.22では範囲外の Index が指定されている場合は要素の有無に関わらず、panic するようになります</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;slices&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">s := []<span class="type">string</span>&#123;<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// panic: runtime error: slice bounds out of range [-1:]</span></span><br><span class="line">s = slices.Insert(s, <span class="number">-1</span>) <span class="comment">// panic が起きる</span></span><br><span class="line"></span><br><span class="line">fmt.Println(s)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h1><p>slices パッケージの機能追加&#x2F;更新を紹介しました。<br>slices パッケージはGo1.21で標準ライブラリに追加されましたが、ユーザーに見える&#x2F;見えにくい内容含めて、まだまだ進化しそうでこれからも楽しみですね</p>]]></content:encoded>
      
      
      <category domain="https://future-architect.github.io/categories/Programming/">Programming</category>
      
      
      <category domain="https://future-architect.github.io/tags/Go/">Go</category>
      
      <category domain="https://future-architect.github.io/tags/Go1-22/">Go1.22</category>
      
      
      <comments>https://future-architect.github.io/articles/20240130a/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>Go 1.22リリース連載始まります &amp; ループの変化とTinyGo 0.31</title>
      <link>https://future-architect.github.io/articles/20240129a/</link>
      <guid>https://future-architect.github.io/articles/20240129a/</guid>
      <pubDate>Sun, 28 Jan 2024 15:00:00 GMT</pubDate>
      
        
        
          
          
      <description>&lt;img src=&quot;/images/20240129a/top.png&quot; alt=&quot;&quot; width=&quot;1000&quot; height=&quot;615&quot;&gt;

&lt;p&gt;The Gopher character is based on the Go mascot designed by &lt;a</description>
          
        
      
      
      
      <content:encoded><![CDATA[<img src="/images/20240129a/top.png" alt="" width="1000" height="615"><p>The Gopher character is based on the Go mascot designed by <a href="http://reneefrench.blogspot.com/">Renée French</a></p><p>Future Tech Blog恒例のGoリリース連載が始まります。</p><div class="scroll"><table><thead><tr><th align="center">Date</th><th align="center">Title</th><th align="center">Author</th></tr></thead><tbody><tr><td align="center">1&#x2F;29</td><td align="center">インデックス &amp; ループの変化とtinygo 1.31</td><td align="center">渋川</td></tr><tr><td align="center">1&#x2F;30</td><td align="center"><a href="/articles/20240130a/">slicesのマイナーアップデート</a></td><td align="center">辻大志郎</td></tr><tr><td align="center">1&#x2F;31</td><td align="center"><a href="/articles/20240131a/">archive&#x2F;tar, archive&#x2F;zip, bufio, io</a></td><td align="center">真野隼記</td></tr><tr><td align="center">2&#x2F;1</td><td align="center">encoding, encoding&#x2F;json</td><td align="center">棚井龍之介</td></tr><tr><td align="center">2&#x2F;2</td><td align="center">os&#x2F;exec(仮)</td><td align="center">谷村元気</td></tr><tr><td align="center">2&#x2F;5</td><td align="center">HTTPルーティング強化(ServeMux)</td><td align="center">武田大輝</td></tr><tr><td align="center">2&#x2F;6</td><td align="center">TBD</td><td align="center"></td></tr></tbody></table></div><p>Go 1.22のトピックとしては以下のようなものがあります。だいぶ安定版になってきたからか、言語もライブラリもこつぶなものが多くなってきたかな、という印象です。</p><ul><li>ループ変数の挙動の変化</li><li>ツール系<ul><li>GO111MODULE&#x3D;offオプションの廃止</li><li>トレースツールのUI改善</li><li>net&#x2F;httpのServeMuxでパス変数が扱えるように</li><li>go vet強化</li><li>コンパイラでGCが1-3%高速化。PGOで2-14%改善</li><li>リンカーの生成するバイナリがよりデバッガフレンドリーに</li></ul></li><li>ライブラリ<ul><li>math&#x2F;rand&#x2F;v2追加</li><li>database&#x2F;sql.NUllの追加</li><li>net&#x2F;httpのルーターがパスパラメータをとれるように</li><li>その他</li></ul></li></ul><p>個人的に注目しているHTTP&#x2F;3やQUICへの対応は、準標準ライブラリのgolang.org&#x2F;x&#x2F;net&#x2F;internal&#x2F;quicの中で進行中。将来的にはinternalが外れたgolang.org&#x2F;x&#x2F;net&#x2F;quicができて、そののちに標準ライブラリ化される予定のようですが、まだ時間かかりそうですね。</p><p><a href="https://github.com/golang/net/tree/master/internal/quic">https://github.com/golang/net/tree/master/internal/quic</a></p><h1 id="ループの変化-1"><a href="#ループの変化-1" class="headerlink" title="ループの変化(1)"></a>ループの変化(1)</h1><p>Go 1.22は言語の変化としては<a href="https://go.dev/wiki/LoopvarExperiment">ループ変数の扱いが変わったり</a>、固定回数のループが描きやすくなったり、今後のバージョンで入る予定の<a href="https://go.dev/wiki/RangefuncExperiment">range over function</a>という機能が <code>GOEXPERIMENT=rangefunc</code> という環境変数のスイッチで有効になったりします。まずはループ変数の扱いの変化から説明します。</p><p>Goのループ変数は単なる参照でした。で、goroutineの起動には時間がかかります。次のようなコードを1.21までのGoで実行するとgoroutineが起動するころには呼び出し元のループは終わっていました。iは単なる参照で、iの最終の値は9なので、だいたい9が出力されます。</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;sync&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">values := <span class="built_in">make</span>([]<span class="type">int</span>, <span class="number">10</span>)</span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">wg.Add(<span class="built_in">len</span>(values))</span><br><span class="line"><span class="keyword">for</span> i := <span class="keyword">range</span> values &#123;</span><br><span class="line">        <span class="comment">// ループごとにgoroutineを起動</span></span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">             <span class="comment">// goroutineの起動は単なるforループよりは思い処理なので</span></span><br><span class="line">             <span class="comment">// ここが実行されるころにはもうループは終わっている</span></span><br><span class="line">      fmt.Println(i)</span><br><span class="line">wg.Done()</span><br><span class="line">&#125;()</span><br><span class="line">&#125;</span><br><span class="line">wg.Wait()</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>これに対処するために、わざわざ新しいメモリ領域が確保されるようにする必要がありました。主に2つの方法がありました。しかし、</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ループの中で変数を定義して代入</span></span><br><span class="line"><span class="comment">// この変数はクロージャ（別の関数）から参照されるため、エスケープ解析により</span></span><br><span class="line"><span class="comment">// ヒープ領域にメモリが確保される</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="keyword">range</span> values &#123;</span><br><span class="line">    i := i</span><br><span class="line">    :</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// goroutine作成時に明示的に渡す</span></span><br><span class="line"><span class="comment">// goroutine側のスタックメモリにコピーされる</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="keyword">range</span> values &#123;</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(i <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">        :</span><br><span class="line">    &#125;(i)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Go 1.22からは、ループ変数が内部のクロージャなどから参照されたりした場合は<code>i := i</code>を自動で差し込むようになり、呼び出したタイミングでのループ変数の値が中でも利用できます。</p><p>Goでgoroutineをループであつかう場合のよくある落とし穴が塞がれました。</p><h1 id="ループの変化-2"><a href="#ループの変化-2" class="headerlink" title="ループの変化(2)"></a>ループの変化(2)</h1><p>range over intというのが入りました。今まで、10回繰り返したい！みたいなループはC言語からの伝統のループを書く必要がありました。</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// C言語からの伝統のループ</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">    fmt.Println(i)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>これがこのように書けるようなります。</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 1.22からの新しいループ</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="keyword">range</span> <span class="number">10</span> &#123;</span><br><span class="line">    fmt.Println(i)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="ループの変化-3"><a href="#ループの変化-3" class="headerlink" title="ループの変化(3)"></a>ループの変化(3)</h1><p>Go 1.23以降に入る予定だが、1.22で実験的に実装されているものがrange over functionです。</p><p>古の書のデザインパターンを読んだことがある人もいるかもしれません。その中で「イテレーターパターン」というものがありました。繰り返し処理を自前で実装する方法を表現したものです。Goの標準ライブラリの中にもいくつかあります。イテレーターパターンはその実装方法から、内部と外部と2種類の分類が知られています</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 内部イテレータ</span></span><br><span class="line"><span class="comment">// ループ条件の判断などは　Walk()関数が行い、ユーザーはループの中身だけ実装する</span></span><br><span class="line">err := filepath.Walk(rootpath, <span class="function"><span class="keyword">func</span><span class="params">(path <span class="type">string</span>, info os.FileInfo, err <span class="type">error</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// ここでファイルごとの繰り返し処理</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 外部イテレータ</span></span><br><span class="line"><span class="comment">// ループの条件判断はイテレータオブジェクトのNext()メソッドなどで行う</span></span><br><span class="line"><span class="comment">// Next()はboolを返したり、値を返すがEOFのような番兵を返すことで有効なデータがあるか</span></span><br><span class="line"><span class="comment">// 判断する</span></span><br><span class="line">rows := db.Query(<span class="string">&quot;select name, email from users&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> rows.Next() &#123;</span><br><span class="line">    <span class="comment">// ここで行ごとの繰り返し処理</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>だいたいの言語にはforループがあり、うまく外部イテレータを言語が定めるプロトコル通りに実装することで言語標準の文法の中で使えるような言語がいくつもあります。C++やJavaScriptのfor ofループや、Pythonの__iter__メソッドなどです。range over functionも、この仲間です。</p><p>使い方とかはすでに詳しくわかりやすく解説してくれているブログ記事があったりするのでそちらを見てもらえればよいかな、と思います。</p><ul><li><a href="https://qiita.com/kidach1/items/afa4c6c29a6eb6be487a">every Tech Blog: Go 1.22で追加予定のrange over intと、GOEXPERIMENT入り予定のrange over funcを触ってみる</a></li></ul><p>これらがリリースされると、そのうち、次のように書けるようになるかと思います。まだExperimentalで変更もありえるので詳しくは説明しません。</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// メソッド名は適当です</span></span><br><span class="line"><span class="keyword">for</span> path, info := <span class="keyword">range</span> filepath.WalkOver(rootpath) &#123;</span><br><span class="line">    <span class="comment">// ここでファイルごとの繰り返し処理</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// メソッド名は適当です</span></span><br><span class="line"><span class="keyword">for</span> row := <span class="keyword">range</span> db.QueryOver(<span class="string">&quot;select name, email from users&quot;</span>) &#123;</span><br><span class="line">    <span class="comment">// ここで行ごとの繰り返し処理</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="TinyGo-0-31"><a href="#TinyGo-0-31" class="headerlink" title="TinyGo 0.31"></a>TinyGo 0.31</h1><p>Go本体のリリースしかあまり見てなかったのですが、以下のtakasagoさんの投稿を見て、TinyGoもリリースを予定していることを知りました。</p><blockquote class="twitter-tweet"><p lang="ja" dir="ltr">Go 1.22 リリースに合わせて TinyGo 0.31 がリリースされる予定です。 Go 1.22 の encoding/json で新たに必要となった reflect.TypeFor の実装を足せばリリースできそうな感じ。<br>大きな変更として net package が TinyGo 内に用意され大幅に更新されました。このあたりは、別途。</p>&mdash; takasago (@sago35tk) <a href="https://twitter.com/sago35tk/status/1747763656329400788?ref_src=twsrc%5Etfw">January 17, 2024</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><p>ここ数年のGoのリリースと、それらのバージョンにあわせたTinyGoのバージョンを表にしたものが次の通りです。READMEの説明を見ると、昔は「完全ではない」という表現もあったりしたのですが、おおむね、2-3週間のラグで対応するバージョンが出ているようです。</p><div class="scroll"><table><thead><tr><th align="center"></th><th align="center">リリース日</th><th align="center">対応するTinyGoバージョン(リリース日)</th></tr></thead><tbody><tr><td align="center">Go 1.21</td><td align="center">2023&#x2F;8&#x2F;8</td><td align="center">0.29 (2023&#x2F;8&#x2F;26)</td></tr><tr><td align="center">Go 1.20</td><td align="center">2023&#x2F;2&#x2F;1</td><td align="center">0.27 (2023&#x2F;2&#x2F;12)</td></tr><tr><td align="center">Go 1.19</td><td align="center">2022&#x2F;8&#x2F;2</td><td align="center">0.24 (2022&#x2F;7&#x2F;1、ただしベータ扱い), 0.25? (2022&#x2F;8&#x2F;3)</td></tr><tr><td align="center">Go 1.18</td><td align="center">2022&#x2F;3&#x2F;15</td><td align="center">0.23 (2022&#x2F;4&#x2F;29、ただし全機能ではない)</td></tr><tr><td align="center">Go 1.17</td><td align="center">2021&#x2F;8&#x2F;16</td><td align="center">0.20 (2021&#x2F;9&#x2F;22)</td></tr></tbody></table></div><p>せっかくなので、Go 1.22サポートを目指している開発版のTinyGoをインストールしてみます。手順はTinyGoのウェブサイトの<a href="https://tinygo.org/docs/guides/build/">Build from source</a>のページにあります。</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> --recursive https://github.com/tinygo-org/tinygo.git</span><br><span class="line">$ <span class="built_in">cd</span> tinygo</span><br><span class="line">$ git checkout dev</span><br><span class="line">$ git submodule update --init</span><br><span class="line">// macなので。他の環境のやり方は上記ウェブサイト参照</span><br><span class="line">$ brew install llvm</span><br><span class="line">$ go install</span><br></pre></td></tr></table></figure><p>さっそく実行してみようとすると、Go 1.22がないぞ、とのエラー。Go 1.22 rc 1をインストールして以下のrange over intのコードを動かしてみます。もう最新の言語サーバーのgoplsはrange over intを正しく解釈してくれるのですね。</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="keyword">range</span> <span class="number">10</span> &#123;</span><br><span class="line">        fmt.Println(i)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以下のように実行すると、Go 1.22のコードをコンパイルして実行できました。小さいバイナリができてWASMでの利用もしやすいし、今後はちょくちょく触ってみようと思います。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ tinygo run main.go</span><br><span class="line">0</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">:</span><br></pre></td></tr></table></figure>]]></content:encoded>
      
      
      <category domain="https://future-architect.github.io/categories/Programming/">Programming</category>
      
      
      <category domain="https://future-architect.github.io/tags/Go/">Go</category>
      
      <category domain="https://future-architect.github.io/tags/%E3%82%A4%E3%83%B3%E3%83%87%E3%83%83%E3%82%AF%E3%82%B9/">インデックス</category>
      
      <category domain="https://future-architect.github.io/tags/Go1-22/">Go1.22</category>
      
      
      <comments>https://future-architect.github.io/articles/20240129a/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>ぼくのかんがえたさいきょうのキャッシュ戦略</title>
      <link>https://future-architect.github.io/articles/20240124a/</link>
      <guid>https://future-architect.github.io/articles/20240124a/</guid>
      <pubDate>Tue, 23 Jan 2024 15:00:00 GMT</pubDate>
      
        
        
          
          
      <description>&lt;img src=&quot;/images/20240124a/キャッシュ.png&quot; alt=&quot;&quot; width=&quot;1200&quot; height=&quot;686&quot; loading=&quot;lazy&quot;&gt;

&lt;h1 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot;</description>
          
        
      
      
      
      <content:encoded><![CDATA[<img src="/images/20240124a/キャッシュ.png" alt="" width="1200" height="686" loading="lazy"><h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>こんにちは。TIG村瀬です。</p><p>動作が遅いサービスはストレスがたまるので利用したくないですよね。</p><p>例えばネットショッピングする際に商品ページの表示が遅かったり検索してもすぐに結果が表示されないとそのサービスを利用するのをやめてしまいたくなります。</p><p>ページの表示や検索結果を高速化する手段の一つとしてキャッシュがあります。ということで今回はぼくのかんがえたさいきょうのキャッシュ戦略に関して解説します。</p><h1 id="キャッシュとは"><a href="#キャッシュとは" class="headerlink" title="キャッシュとは"></a>キャッシュとは</h1><p>キャッシュとは現金を意味するcashではなく、cacheであり、</p><p><code>一度読み込んだ情報を一時的に保存しておき、次回参照する際に素早く読み込めるようにする仕組み</code></p><p>です。</p><h1 id="なぜキャッシュを使うのか"><a href="#なぜキャッシュを使うのか" class="headerlink" title="なぜキャッシュを使うのか"></a>なぜキャッシュを使うのか</h1><p>大別して3つ理由があります。</p><ol><li>システムにおける処理高速化のため</li><li>RDBなどの負荷軽減のため</li><li>コスト削減のため</li></ol><h2 id="1-システムにおける処理高速化のため"><a href="#1-システムにおける処理高速化のため" class="headerlink" title="1.システムにおける処理高速化のため"></a>1.システムにおける処理高速化のため</h2><p>冒頭でも軽く説明した通り、何らかの処理の遅いサービスを高速化したい場合に、そのサービスを提供するために裏で動作しているシステムを高速化する必要があります。高速化の方法は一度処理した情報をキャッシュに保存し、次回参照する際に素早く読み込めるようにすることであり、書き込みや一度目の計算処理が高速化するわけではないのでそれを意識した上で設計することになります。</p><h2 id="2-RDBなどの負荷軽減のため"><a href="#2-RDBなどの負荷軽減のため" class="headerlink" title="2.RDBなどの負荷軽減のため"></a>2.RDBなどの負荷軽減のため</h2><p>よくあるシステムの構成としてバックエンドではRDBが利用されていることでしょう。RDBを利用していないシステムにおいては何か負荷の高い処理をするサーバと読み替えてください。システム全体においては、大量データを保持し、計算処理を実行するRDBの負荷が大きくなるかと思います。</p><p>負荷が大きくなると処理が遅延し、許容時間内にレスポンスが返却できなくなったり、ハングアップしてしまうことでしょう。システムの心臓部とも言えるRDBがこのような状態になってしまうとサービスの提供が困難になります。</p><p>サービスを提供し続ける為、計算済みの結果は一定時間キャッシュに保持し、計算済みの結果がある場合はRDBにアクセスすることなくキャッシュから結果を取得することでRDBに掛かる負荷を軽減することが可能です。</p><h2 id="3-コスト削減"><a href="#3-コスト削減" class="headerlink" title="3.コスト削減"></a>3.コスト削減</h2><p>クラウドサービスを利用している場合、コンピューティングリソースを利用した分だけコストが掛かる料金体系になっているかと思います。</p><p>その場合にコストを低減するためにはコンピューティングに要する時間を短縮するのが効果的です。RDBの処理時間が長くクライアント側が待たされるようであれば、キャッシュにアクセスし短時間でレスポンスを受けられるようにすることでコスト削減が期待できます。</p><p>クラウドサービスを利用しキャッシュを実現するのであればそのキャッシュ自体のコストも考慮すべきではありますが、中・大規模システムであればまずキャッシュ自体のコストよりも削減できるコストやメリットの方が大きいことでしょう。</p><h1 id="キャッシュするデータ"><a href="#キャッシュするデータ" class="headerlink" title="キャッシュするデータ"></a>キャッシュするデータ</h1><p>キャッシュするデータに相応しいのはどのようなものでしょうか？</p><p>キャッシュの特性と利用用途を踏まえると以下のようなものをキャッシュするのが良いでしょう。</p><ol><li>変更がリアルタイムに必要ではないもの</li><li>計算処理に時間を要するもの</li><li>変更が発生しないまたは滅多に発生しないもの</li><li>参照頻度が高いもの</li></ol><h1 id="どこにキャッシュを配置すべきか"><a href="#どこにキャッシュを配置すべきか" class="headerlink" title="どこにキャッシュを配置すべきか"></a>どこにキャッシュを配置すべきか</h1><p>よくある構成を元にどこにキャッシュを配置すべきかを検討していきます。</p><img src="/images/20240124a/キャッシュ_構成.png" alt="キャッシュ_構成.png" width="867" height="165" loading="lazy"><h2 id="クライアント"><a href="#クライアント" class="headerlink" title="クライアント"></a>クライアント</h2><img src="/images/20240124a/キャッシュ_構成_クライアント.png" alt="キャッシュ_構成_クライアント.png" width="860" height="151" loading="lazy"><p>速度を最優先に考えた場合、クライアントにキャッシュを設けるのが最も効果的です。</p><p>クライアントにキャッシュがある場合にはネットワーク通信が不要のため、高速に結果を取り出すことが可能です。クライアントが何で構成されているかにもよりますが、Webブラウザベースの構成でない限り、キャッシュ機能を何らかの形で用意する必要があり、キャッシュを用意しない場合と比較すると開発コストは増加します。</p><p>データをどれぐらいの期間保持するかのルールはWeb APIにてデータを取得する場合はHTTPにおけるCache-Controlに倣った保持期間するのがデファクトスタンダードかと思います。</p><p>常にキャッシュを表示するのではなく、ユーザによる簡単な操作(※)でクライアントのキャッシュを破棄し、最新情報を取得できるようにすると良いでしょう。</p><p>※スマホアプリであれば、更新ボタンのタップやリストを下にスワイプするなど</p><h2 id="Web-APIバックエンド"><a href="#Web-APIバックエンド" class="headerlink" title="Web APIバックエンド"></a>Web APIバックエンド</h2><p>Web APIバックエンドにキャッシュを配置する場合、サーバの内、外の2パターンあるので分けて説明します。</p><h3 id="Web-APIサーバ内"><a href="#Web-APIサーバ内" class="headerlink" title="Web APIサーバ内"></a>Web APIサーバ内</h3><img src="/images/20240124a/キャッシュ_構成_webapi1.png" alt="キャッシュ_構成_webapi1.png" width="847" height="153" loading="lazy"><p>代表的なサービスとしてはMemcachedやRedisがあります。</p><p>Web APIサーバと同一のサーバ内に設けるパターン。Web APIサーバからキャッシュまでのアクセスにおいてネットワークを介さないため高速にキャッシュから結果を取り出すことが可能です。</p><p>しかしながら一方で同一サーバ内に設けるため、Web APIサーバが複数存在する場合にキャッシュを共有できません。Web APIサーバが1台の構成であれば効率よく動作しますが、可用性を考慮すると進んで採用したい構成ではありません。またナウでヤングなコンテナを利用したい場合、コンテナの原則である1コンテナ1プロセスから逸脱するためおすすめできません。</p><h3 id="Web-APIサーバ外"><a href="#Web-APIサーバ外" class="headerlink" title="Web APIサーバ外"></a>Web APIサーバ外</h3><img src="/images/20240124a/キャッシュ_構成_webapi2.png" alt="キャッシュ_構成_webapi2.png" width="850" height="205" loading="lazy"><p>Web APIサーバ外にキャッシュを設ける王道パターン。Web APIが複数台ある場合にキャッシュを共用できます。</p><p>他のキャッシュ配置と比較してキャッシュのコントロールが容易であり、例えばキーを指定した一部データの削除が行えます。</p><p>システムにキャッシュを配置するとなった際に一番最初に思いつくのがこのパターンかと思います。MemcachedやRedisが利用でき、Web APIの開発チームがキャッシュをコントロールしたい場合に最適です。</p><h2 id="RDB"><a href="#RDB" class="headerlink" title="RDB"></a>RDB</h2><img src="/images/20240124a/キャッシュ_構成_rdb.png" alt="キャッシュ_構成_rdb.png" width="856" height="153" loading="lazy"><p>大抵のRDBではキャッシュを内蔵しています。これにより初回のアクセスよりも二回目以降のアクセスの方がレスポンスを素早く返すことがあります。キャッシュのコントロールはRDB外からはできないため、キャッシュ設定はONにするけれど過信はしないようにしましょう。</p><h2 id="CDN"><a href="#CDN" class="headerlink" title="CDN"></a>CDN</h2><img src="/images/20240124a/キャッシュ_構成_CDN.png" alt="キャッシュ_構成_CDN.png" width="851" height="155" loading="lazy"><p>クライアントでキャッシュを持たない場合に最も近い場所でキャッシュを提供できます。</p><p>サーバサイドとクライアントサイドを別のチームが開発する場合、サーバサイドのチームからするとクライアントサイドでキャッシュしてくれる保証はありません。クライアントサイドで適切なキャッシュがなされず、サーバサイドへのアクセス量が多くなることを想定するとCDNでキャッシュするのが有効です。</p><p>CDNの後方に位置するサーバサイドをクラウドサービスを利用して構築している場合、クラウドサービスに対するアクセスを低減でき、その結果クラウドサービスのコンピューティングリソースの利用量を低減できます。利用量が低減されるということはクラウドサービスのコストが低減できます。</p><p>一方でキャッシュキーに関しては慎重に取り扱う必要があり、Web APIにおいてどのキーの値が同一であれば同一のキャッシュキーとするか詳細に設計する必要があります。CDNのキャッシュは細かなコントロールが出来ず、一部のデータを削除できないのが大半かと思います。</p><h2 id="で結局どこに配置すれば良いの？"><a href="#で結局どこに配置すれば良いの？" class="headerlink" title="で結局どこに配置すれば良いの？"></a>で結局どこに配置すれば良いの？</h2><p>複数の選択肢の中から一つのみ選択する必要はなく、適切な箇所を必要な分だけ選択するのが良いと思います。選択の際にはサービスの特性、費用対効果、開発者が調達できるかなど複数の観点で検討が必要になります。</p><p>複数個所にキャッシュを配置した場合、エンドユーザからするとストレスなく利用できるため嬉しい一方で運用者は大変になるかと思います。万能なものはありません。トレードオフを考慮し決定しましょう。</p><h1 id="キャッシュアルゴリズムの選択"><a href="#キャッシュアルゴリズムの選択" class="headerlink" title="キャッシュアルゴリズムの選択"></a>キャッシュアルゴリズムの選択</h1><p>キャッシュは保持期間を指定するため、保持期間を過ぎると削除されていきますが、保持期間内であってもキャッシュ可能なサイズを超えた場合はキャッシュアルゴリズムに従い、何れかのデータが削除されます。</p><p>代表的なキャッシュアルゴリズムは以下の通りです。</p><ul><li>FIFO（First-In, First-Out）: 最初にキャッシュされたデータを最初に削除する。</li><li>LFU（Least Frequently Used）: 最も使用頻度が低いデータを削除する。</li><li>LIFO（Last-In, First-Out）: 最後にキャッシュされたデータを最初に削除する。</li><li>LRU（Least Recently Used）: 最も長い間、使用されていないデータを削除する。</li></ul><p>システムの特性を踏まえて選択すべきですが、一般的にはLFU（Least Frequently Used）かLRU（Least Recently Used）を選択するのが良いと思います。</p><p>コストとの兼ね合い次第ですが必要なデータが全て保存可能なサイズのキャッシュを用意できるのがキャッシュヒット率の観点では理想です。</p><h1 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h1><p>キャッシュを利用する上で注意すべき点があります。</p><ul><li>何らかの理由でキャッシュを全て削除した際にRDBに対する負荷が集中することになります。サービス停止にならないよう流量制御するなどの対策が必要になるかもしれません。</li><li>初回アクセス(正確に言うとキャッシュが作成されるまでの間に実行されたアクセス)はキャッシュにデータがないので遅くなります。最初にアクセスしたユーザはストレスに感じるかもしれません。ユーザにストレスを与えないようにキャッシュにデータを用意する仕組みが有効かもしれません。</li><li>変更が発生しないと思われるデータでも無期限にキャッシュするのはおすすめしません。設計当初は変更が発生しないと考えられるものであっても後々変更が発生したり、誤ってキャッシュしてしまった際に削除が困難にならないよう保持期間を設けましょう。最長でも1日とかで様子を見るところからスタートするのがよろしいかと思います。</li><li>個人情報のキャッシュは慎重に扱う必要があります。ユーザ自身の名前や電話番号などの情報はRDBから取得するにしても計算処理時間は短いためキャッシュしなくても良いでしょう。一方でネットショッピングであれば購入履歴など計算処理に時間を要するものがありキャッシュしたくなります。CDNの仕様理解不足などにより誤って他者に閲覧可能な状態になると個人情報漏洩インシデントになりかねません。キャッシュするのであればクライアントにキャッシュすることを優先的に検討したいところです。とはいえCDNの仕様理解不足によりCDNに意図せずキャッシュされてしまったり、Web APIの不具合により他者の情報を誤って返却してしまうことがありえます。システム全体で複数人で同時期にアクセスした際に非機能要件面だけではなく機能要件面でのテストを十分実施することで個人情報漏洩リスクを低減できることでしょう。</li></ul><h1 id="さいごに"><a href="#さいごに" class="headerlink" title="さいごに"></a>さいごに</h1><p>性能要件が緩いサービスであればキャッシュを設けない方がシンプルな設計となり、開発や保守も楽でしょう。しかしながら高い性能要件が求められるサービスになると話が別です。</p><p>Amazonの調査によると、サイト表示が0.1秒遅くなると、売り上げが1%減少し、1秒高速化すると10%の売上が向上するとのことなのでクライアントへ如何に早く表示するか・レスポンスを返すかが重要となり、その対応の一つとしてキャッシュが必要となります。</p><p>冒頭で、キャッシュとは現金を意味するcashではなく、cacheであると言う説明をしましたが、cacheを利用することでcashを増やすことが可能です。この記事を参考にしていただき、世の中から遅いサービスが減り、ユーザのストレスが低減できれば幸いです。</p><p>以上、ぼくのかんがえたさいきょうのキャッシュ戦略でした。</p>]]></content:encoded>
      
      
      <category domain="https://future-architect.github.io/categories/Programming/">Programming</category>
      
      
      <category domain="https://future-architect.github.io/tags/%E8%A8%AD%E8%A8%88/">設計</category>
      
      <category domain="https://future-architect.github.io/tags/Redis/">Redis</category>
      
      <category domain="https://future-architect.github.io/tags/CDN/">CDN</category>
      
      <category domain="https://future-architect.github.io/tags/%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5/">キャッシュ</category>
      
      <category domain="https://future-architect.github.io/tags/memcached/">memcached</category>
      
      
      <comments>https://future-architect.github.io/articles/20240124a/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>人工知能学会ビジネス・インフォマティクス研究会で登壇しました。</title>
      <link>https://future-architect.github.io/articles/20240122a/</link>
      <guid>https://future-architect.github.io/articles/20240122a/</guid>
      <pubDate>Sun, 21 Jan 2024 15:00:00 GMT</pubDate>
      
        
        
          
          
      <description>&lt;h1 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot;</description>
          
        
      
      
      
      <content:encoded><![CDATA[<h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>2023年11月にフューチャーにキャリア入社した引網康暁です。前職の総合商社で物流ビジネスに従事した後、現在は、フューチャーアーキテクトの物流サービス事業部で、物流DXのコンサルティングやビジネス・ディベロップメントをしています。</p><p>現在51歳。人生100年時代のリスキリングとして、働きながら<a href="https://ai.rikkyo.ac.jp/index.html">大学院</a>で人工知能の研究をしている私が、2023年9月に開催された<a href="http://sig-bi.jp/">人工知能学会ビジネス・インフォマティクス研究会</a>に登壇して、研究発表をしましたので、その体験記をご紹介します！</p><img src="/images/20240122a/図1.png" alt="図1.png" width="821" height="555" loading="lazy"><h1 id="人工知能学会ビジネス・インフォマティクス研究会"><a href="#人工知能学会ビジネス・インフォマティクス研究会" class="headerlink" title="人工知能学会ビジネス・インフォマティクス研究会"></a>人工知能学会ビジネス・インフォマティクス研究会</h1><p>人工知能学会ビジネス・インフォマティクス研究会とは、経営に関連する知能情報技術を表す<strong>ビジネス・インフォマティクス</strong>をキーワードとして、経営に関わる基礎から応用までの幅広い研究課題を対象に、経営分野において人工知能で取り組むべき課題を発掘する課題発掘型研究を目的とした、人工知能学会が開催する研究会です。</p><p>2023年9月23日と24日の2日間にわたり、慶應義塾大学三田キャンパスとオンラインのハイブリッド形式で開催され、16件の研究が発表されました。ビジネス・インフォマティクスを主題としている研究会であるため、社会的な課題や経営戦略への人工知能の応用に関する研究が目立っていた印象があります。また、9月という季節柄、研究の中間報告をここで発表し、多くの知見をお持ちの聴講者からのフィードバックを取り入れて修士論文に仕上げていく、という発表者も多くいらっしゃいました。</p><h1 id="私の発表内容"><a href="#私の発表内容" class="headerlink" title="私の発表内容"></a>私の発表内容</h1><p><strong>物流の2024年問題</strong>という言葉をお聞きになられたことはありますか？2024年4月から、トラックドライバーの時間外労働の960時間上限規制等が適用され、労働時間が短くなることで輸送能力の不足が懸念される社会的な問題です。実は、商品を出荷する側の倉庫でも、トラックドライバーをお待たせすることができませんので、出荷業務の効率化のため、<strong>倉庫ロボット</strong>の導入が始まっています。</p><p><a href="https://www.gov-online.go.jp/pr/media/tv/miraino/movie/20230920.html">https://www.gov-online.go.jp/pr/media/tv/miraino/movie/20230920.html</a></p><p>倉庫ロボットは、倉庫で働いてくださるヒトとの協調システムであり、作業員の方々には身体の屈伸や段取り替えなど、さまざまな付帯作業が発生します。人手不足が待ったなしの課題である中、作業員の方々の疲労の軽減も考慮した業務の効率化が求められます。そこで、私は「倉庫ロボットによる稼働時間の最小化」と「作業員による作業時間の最小化」で構成される<strong>多目的最適化問題</strong>を<strong>イジングモデル</strong>を用いて求解することで、出荷業務の効率化につながる、<strong>最適な商品配置計画</strong>を明らかにしました。</p><img src="/images/20240122a/image.png" alt="image.png" width="480" height="230" loading="lazy">・最適化された商品配置計画を可視化した一例<p>当日は緊張してしまい、うまく発表できませんでしたが、聴講者の皆さまからたくさんのフィードバックを頂き、とても励みとなる機会になりました。研究の内容もさることながら、学会発表を機に、論文をまとめたり、プレゼンテーション資料を作成したりすることで、自分の考えが整理できたことが貴重な経験となりました。</p><h1 id="イジングモデルとは"><a href="#イジングモデルとは" class="headerlink" title="イジングモデルとは"></a>イジングモデルとは</h1><p>私が研究で使用した<strong>イジングモデル</strong>についても触れておきたいと思います。イジングモデルとは、粒子の量子力学的な内部自由度の一つであるスピンが格子状に整列し、定められた向き及びその反対向きの2つの向きだけをとり、最近接のスピン同士だけに相互作用があるとするモデルです[1]。</p><p>一般的なイジングモデルは、以下の式で示されるエネルギー関数で表されます。</p><p><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -3.112ex;" xmlns="http://www.w3.org/2000/svg" width="35.317ex" height="5.261ex" role="img" focusable="false" viewBox="0 -950 15610 2325.3"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D43B" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 219 683Q260 681 355 681Q389 681 418 681T463 682T483 682Q499 682 499 672Q499 670 497 658Q492 641 487 638H485Q483 638 480 638T473 638T464 637T455 637Q416 636 405 634T387 623Q384 619 355 500Q348 474 340 442T328 395L324 380Q324 378 469 378H614L615 381Q615 384 646 504Q674 619 674 627T617 637Q594 637 587 639T580 648Q580 650 582 660Q586 677 588 679T604 682Q609 682 646 681T740 680Q802 680 835 681T871 682Q888 682 888 672Q888 645 876 638H874Q872 638 869 638T862 638T853 637T844 637Q805 636 794 634T776 623Q773 618 704 340T634 58Q634 51 638 51Q646 48 692 46H723Q729 38 729 37T726 19Q722 6 716 0H701Q664 2 567 2Q533 2 504 2T458 2T437 1Q420 1 420 10Q420 15 423 24Q428 43 433 45Q437 46 448 46H454Q481 46 514 49Q520 50 522 50T528 55T534 64T540 82T547 110T558 153Q565 181 569 198Q602 330 602 331T457 332H312L279 197Q245 63 245 58Q245 51 253 49T303 46H334Q340 38 340 37T337 19Q333 6 327 0H312Q275 2 178 2Q144 2 115 2T69 2T48 1Q31 1 31 10Q31 12 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"></path></g><g data-mml-node="mo" transform="translate(1165.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="munder" transform="translate(2221.6,0)"><g data-mml-node="mo"><path data-c="2211" d="M60 948Q63 950 665 950H1267L1325 815Q1384 677 1388 669H1348L1341 683Q1320 724 1285 761Q1235 809 1174 838T1033 881T882 898T699 902H574H543H251L259 891Q722 258 724 252Q725 250 724 246Q721 243 460 -56L196 -356Q196 -357 407 -357Q459 -357 548 -357T676 -358Q812 -358 896 -353T1063 -332T1204 -283T1307 -196Q1328 -170 1348 -124H1388Q1388 -125 1381 -145T1356 -210T1325 -294L1267 -449L666 -450Q64 -450 61 -448Q55 -446 55 -439Q55 -437 57 -433L590 177Q590 178 557 222T452 366T322 544L56 909L55 924Q55 945 60 948Z"></path></g><g data-mml-node="TeXAtom" transform="translate(179.3,-1123.3) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mo" transform="translate(345,0)"><path data-c="2260" d="M166 -215T159 -215T147 -212T141 -204T139 -197Q139 -190 144 -183L306 133H70Q56 140 56 153Q56 168 72 173H327L406 327H72Q56 332 56 347Q56 360 70 367H426Q597 702 602 707Q605 716 618 716Q625 716 630 712T636 703T638 696Q638 692 471 367H707Q722 359 722 347Q722 336 708 328L451 327L371 173H708Q722 163 722 153Q722 140 707 133H351Q175 -210 170 -212Q166 -215 159 -215Z"></path></g><g data-mml-node="mi" transform="translate(1123,0)"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"></path></g></g></g><g data-mml-node="msub" transform="translate(3832.2,0)"><g data-mml-node="mi"><path data-c="1D43D" d="M447 625Q447 637 354 637H329Q323 642 323 645T325 664Q329 677 335 683H352Q393 681 498 681Q541 681 568 681T605 682T619 682Q633 682 633 672Q633 670 630 658Q626 642 623 640T604 637Q552 637 545 623Q541 610 483 376Q420 128 419 127Q397 64 333 21T195 -22Q137 -22 97 8T57 88Q57 130 80 152T132 174Q177 174 182 130Q182 98 164 80T123 56Q115 54 115 53T122 44Q148 15 197 15Q235 15 271 47T324 130Q328 142 387 380T447 625Z"></path></g><g data-mml-node="TeXAtom" transform="translate(588,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(345,0)"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"></path></g></g></g><g data-mml-node="msub" transform="translate(5005.5,0)"><g data-mml-node="mi"><path data-c="1D70E" d="M184 -11Q116 -11 74 34T31 147Q31 247 104 333T274 430Q275 431 414 431H552Q553 430 555 429T559 427T562 425T565 422T567 420T569 416T570 412T571 407T572 401Q572 357 507 357Q500 357 490 357T476 358H416L421 348Q439 310 439 263Q439 153 359 71T184 -11ZM361 278Q361 358 276 358Q152 358 115 184Q114 180 114 178Q106 141 106 117Q106 67 131 47T188 26Q242 26 287 73Q316 103 334 153T356 233T361 278Z"></path></g><g data-mml-node="TeXAtom" transform="translate(604,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g></g></g><g data-mml-node="msub" transform="translate(5903.5,0)"><g data-mml-node="mi"><path data-c="1D70E" d="M184 -11Q116 -11 74 34T31 147Q31 247 104 333T274 430Q275 431 414 431H552Q553 430 555 429T559 427T562 425T565 422T567 420T569 416T570 412T571 407T572 401Q572 357 507 357Q500 357 490 357T476 358H416L421 348Q439 310 439 263Q439 153 359 71T184 -11ZM361 278Q361 358 276 358Q152 358 115 184Q114 180 114 178Q106 141 106 117Q106 67 131 47T188 26Q242 26 287 73Q316 103 334 153T356 233T361 278Z"></path></g><g data-mml-node="TeXAtom" transform="translate(604,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"></path></g></g></g><g data-mml-node="mo" transform="translate(7071,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="munder" transform="translate(8071.2,0)"><g data-mml-node="mo"><path data-c="2211" d="M60 948Q63 950 665 950H1267L1325 815Q1384 677 1388 669H1348L1341 683Q1320 724 1285 761Q1235 809 1174 838T1033 881T882 898T699 902H574H543H251L259 891Q722 258 724 252Q725 250 724 246Q721 243 460 -56L196 -356Q196 -357 407 -357Q459 -357 548 -357T676 -358Q812 -358 896 -353T1063 -332T1204 -283T1307 -196Q1328 -170 1348 -124H1388Q1388 -125 1381 -145T1356 -210T1325 -294L1267 -449L666 -450Q64 -450 61 -448Q55 -446 55 -439Q55 -437 57 -433L590 177Q590 178 557 222T452 366T322 544L56 909L55 924Q55 945 60 948Z"></path></g><g data-mml-node="TeXAtom" transform="translate(600,-1084.4) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g></g></g><g data-mml-node="msub" transform="translate(9681.9,0)"><g data-mml-node="mi"><path data-c="210E" d="M137 683Q138 683 209 688T282 694Q294 694 294 685Q294 674 258 534Q220 386 220 383Q220 381 227 388Q288 442 357 442Q411 442 444 415T478 336Q478 285 440 178T402 50Q403 36 407 31T422 26Q450 26 474 56T513 138Q516 149 519 151T535 153Q555 153 555 145Q555 144 551 130Q535 71 500 33Q466 -10 419 -10H414Q367 -10 346 17T325 74Q325 90 361 192T398 345Q398 404 354 404H349Q266 404 205 306L198 293L164 158Q132 28 127 16Q114 -11 83 -11Q69 -11 59 -2T48 16Q48 30 121 320L195 616Q195 629 188 632T149 637H128Q122 643 122 645T124 664Q129 683 137 683Z"></path></g><g data-mml-node="TeXAtom" transform="translate(609,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g></g></g><g data-mml-node="msub" transform="translate(10584.8,0)"><g data-mml-node="mi"><path data-c="1D70E" d="M184 -11Q116 -11 74 34T31 147Q31 247 104 333T274 430Q275 431 414 431H552Q553 430 555 429T559 427T562 425T565 422T567 420T569 416T570 412T571 407T572 401Q572 357 507 357Q500 357 490 357T476 358H416L421 348Q439 310 439 263Q439 153 359 71T184 -11ZM361 278Q361 358 276 358Q152 358 115 184Q114 180 114 178Q106 141 106 117Q106 67 131 47T188 26Q242 26 287 73Q316 103 334 153T356 233T361 278Z"></path></g><g data-mml-node="TeXAtom" transform="translate(604,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g></g></g><g data-mml-node="mrow" transform="translate(11649.5,0)"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mi" transform="translate(389,0)"><path data-c="1D70E" d="M184 -11Q116 -11 74 34T31 147Q31 247 104 333T274 430Q275 431 414 431H552Q553 430 555 429T559 427T562 425T565 422T567 420T569 416T570 412T571 407T572 401Q572 357 507 357Q500 357 490 357T476 358H416L421 348Q439 310 439 263Q439 153 359 71T184 -11ZM361 278Q361 358 276 358Q152 358 115 184Q114 180 114 178Q106 141 106 117Q106 67 131 47T188 26Q242 26 287 73Q316 103 334 153T356 233T361 278Z"></path></g><g data-mml-node="mo" transform="translate(1237.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mo" transform="translate(2293.6,0)"><path data-c="B1" d="M56 320T56 333T70 353H369V502Q369 651 371 655Q376 666 388 666Q402 666 405 654T409 596V500V353H707Q722 345 722 333Q722 320 707 313H409V40H707Q722 32 722 20T707 0H70Q56 7 56 20T70 40H369V313H70Q56 320 56 333Z"></path></g><g data-mml-node="mn" transform="translate(3071.6,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(3571.6,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></g></svg></mjx-container></p><p><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.357ex;" xmlns="http://www.w3.org/2000/svg" width="2.032ex" height="1.332ex" role="img" focusable="false" viewBox="0 -431 898 588.8"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D70E" d="M184 -11Q116 -11 74 34T31 147Q31 247 104 333T274 430Q275 431 414 431H552Q553 430 555 429T559 427T562 425T565 422T567 420T569 416T570 412T571 407T572 401Q572 357 507 357Q500 357 490 357T476 358H416L421 348Q439 310 439 263Q439 153 359 71T184 -11ZM361 278Q361 358 276 358Q152 358 115 184Q114 180 114 178Q106 141 106 117Q106 67 131 47T188 26Q242 26 287 73Q316 103 334 153T356 233T361 278Z"></path></g><g data-mml-node="TeXAtom" transform="translate(604,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g></g></g></g></g></svg></mjx-container>は入力変数、<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.666ex;" xmlns="http://www.w3.org/2000/svg" width="2.654ex" height="2.211ex" role="img" focusable="false" viewBox="0 -683 1173.3 977.2"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D43D" d="M447 625Q447 637 354 637H329Q323 642 323 645T325 664Q329 677 335 683H352Q393 681 498 681Q541 681 568 681T605 682T619 682Q633 682 633 672Q633 670 630 658Q626 642 623 640T604 637Q552 637 545 623Q541 610 483 376Q420 128 419 127Q397 64 333 21T195 -22Q137 -22 97 8T57 88Q57 130 80 152T132 174Q177 174 182 130Q182 98 164 80T123 56Q115 54 115 53T122 44Q148 15 197 15Q235 15 271 47T324 130Q328 142 387 380T447 625Z"></path></g><g data-mml-node="TeXAtom" transform="translate(588,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(345,0)"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"></path></g></g></g></g></g></svg></mjx-container>は二体の相互作用パラメータ、<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.357ex;" xmlns="http://www.w3.org/2000/svg" width="2.043ex" height="1.927ex" role="img" focusable="false" viewBox="0 -694 903 851.8"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="210E" d="M137 683Q138 683 209 688T282 694Q294 694 294 685Q294 674 258 534Q220 386 220 383Q220 381 227 388Q288 442 357 442Q411 442 444 415T478 336Q478 285 440 178T402 50Q403 36 407 31T422 26Q450 26 474 56T513 138Q516 149 519 151T535 153Q555 153 555 145Q555 144 551 130Q535 71 500 33Q466 -10 419 -10H414Q367 -10 346 17T325 74Q325 90 361 192T398 345Q398 404 354 404H349Q266 404 205 306L198 293L164 158Q132 28 127 16Q114 -11 83 -11Q69 -11 59 -2T48 16Q48 30 121 320L195 616Q195 629 188 632T149 637H128Q122 643 122 645T124 664Q129 683 137 683Z"></path></g><g data-mml-node="TeXAtom" transform="translate(609,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g></g></g></g></g></svg></mjx-container>は一体のパラメータ（磁場）で、これらのパラメータをイジングマシンに入力することで、エネルギー関数が最小となる組合せ<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="1.292ex" height="1ex" role="img" focusable="false" viewBox="0 -431 571 442"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D70E" d="M184 -11Q116 -11 74 34T31 147Q31 247 104 333T274 430Q275 431 414 431H552Q553 430 555 429T559 427T562 425T565 422T567 420T569 416T570 412T571 407T572 401Q572 357 507 357Q500 357 490 357T476 358H416L421 348Q439 310 439 263Q439 153 359 71T184 -11ZM361 278Q361 358 276 358Q152 358 115 184Q114 180 114 178Q106 141 106 117Q106 67 131 47T188 26Q242 26 287 73Q316 103 334 153T356 233T361 278Z"></path></g></g></g></svg></mjx-container>の近似解が出力される仕組みです[2]。</p><p>イジングマシンの一種であり、量子焼きなまし法の原理に基づいて動くマシンを<strong>量子アニーリングマシン</strong>と言い、カナダの<a href="https://www.dwavesys.com/">D-Wave</a>が有名です。量子アニーリングマシンやイジングマシンは、世の中に数多く存在する、さまざまな組合せ最適化問題を解くための特化型マシンであり、物流の最適化にも力を発揮していくと期待されています。</p><p><a href="https://www.dwavesys.com/">https://www.dwavesys.com/</a></p><h1 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h1><p>いかがでしたか？今回のブログでは、人工知能関連の研究会で登壇した経験を書いてみました。こんな形でブログで発表するのであれば、もっとピシッとした服装の方が良かったかなとすこし反省しています。次回は5月に開催される人工知能学会全国大会での発表を目指して、研究を続けていきます！</p><h1 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h1><p>[1]松下貢、物理学講座 統計力学入門、裳華房、2019<br>[2]株式会社Fixstars Amplifyホームページ</p>]]></content:encoded>
      
      
      <category domain="https://future-architect.github.io/categories/DataScience/">DataScience</category>
      
      
      <category domain="https://future-architect.github.io/tags/%E7%99%BB%E5%A3%87%E3%83%AC%E3%83%9D%E3%83%BC%E3%83%88/">登壇レポート</category>
      
      <category domain="https://future-architect.github.io/tags/%E7%89%A9%E6%B5%81/">物流</category>
      
      <category domain="https://future-architect.github.io/tags/%E3%83%AD%E3%83%9C%E3%83%83%E3%83%88/">ロボット</category>
      
      <category domain="https://future-architect.github.io/tags/%E3%82%A4%E3%82%B8%E3%83%B3%E3%82%B0%E3%83%A2%E3%83%87%E3%83%AB/">イジングモデル</category>
      
      <category domain="https://future-architect.github.io/tags/%E5%A4%9A%E7%9B%AE%E7%9A%84%E6%9C%80%E9%81%A9%E5%8C%96/">多目的最適化</category>
      
      <category domain="https://future-architect.github.io/tags/%E4%BA%BA%E5%B7%A5%E7%9F%A5%E8%83%BD%E5%AD%A6%E4%BC%9A/">人工知能学会</category>
      
      
      <comments>https://future-architect.github.io/articles/20240122a/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>リリース直前にライブラリのインストールエラーが発生した際にどのように対応したか</title>
      <link>https://future-architect.github.io/articles/20240119a/</link>
      <guid>https://future-architect.github.io/articles/20240119a/</guid>
      <pubDate>Thu, 18 Jan 2024 15:00:00 GMT</pubDate>
      
        
        
          
          
      <description>&lt;img src=&quot;/images/20240119a/d6788854-dfac-4797-979e-3f40531a1eee.jpeg&quot; alt=&quot;&quot; width=&quot;1024&quot; height=&quot;1024&quot; loading=&quot;lazy&quot;&gt;

&lt;p&gt;(DALL-E3</description>
          
        
      
      
      
      <content:encoded><![CDATA[<img src="/images/20240119a/d6788854-dfac-4797-979e-3f40531a1eee.jpeg" alt="" width="1024" height="1024" loading="lazy"><p>(DALL-E3 で生成)</p><h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><p>先日、本番リリースを控えたシステムで OSS ライブラリのインストール起因のエラーが発生しました。<br>実際に起きた事象と、どのように検討して対応したのかを残すべく、ポストモーテムの形式で当記事を書きました。</p><h2 id="ポストモーテム"><a href="#ポストモーテム" class="headerlink" title="ポストモーテム"></a>ポストモーテム</h2><h3 id="発生日"><a href="#発生日" class="headerlink" title="発生日"></a>発生日</h3><p>2023&#x2F;12&#x2F;30</p><h3 id="サマリ"><a href="#サマリ" class="headerlink" title="サマリ"></a>サマリ</h3><p>AWS Glue (PythonShell)を起動する際に、<a href="https://pypi.org/project/awswrangler/">awswrangler</a> ライブラリをインストールする工程で、依存関係にある <a href="https://pypi.org/project/lxml/">lxml</a> のインストールに失敗しました。その結果、Glue ジョブの起動に失敗しエラーとなりました。</p><h4 id="バージョン"><a href="#バージョン" class="headerlink" title="バージョン"></a>バージョン</h4><div class="scroll"><table><thead><tr><th>システム&#x2F;ライブラリ</th><th>バージョン</th></tr></thead><tbody><tr><td>AWS Glue PythonShell</td><td>Glue version&#x3D;3.0 <br>Python version&#x3D;Python3.9<br>DPU&#x3D;0.0625</td></tr><tr><td><a href="https://pypi.org/project/awswrangler/">awswrangler</a></td><td>1.5.2</td></tr><tr><td><a href="https://pypi.org/project/lxml/">lxml</a></td><td>5.0.0</td></tr></tbody></table></div><h3 id="インパクト"><a href="#インパクト" class="headerlink" title="インパクト"></a>インパクト</h3><p>AWS Glue PythonShell の Libraries 設定に、  </p><p>wheel 形式で <a href="https://pypi.org/project/awswrangler/">awswrangler</a>  を指定<br>or<br>wheel形式で <a href="https://pypi.org/project/awswrangler/">awswrangler</a> に依存しているライブラリを指定</p><p>している Glue ジョブが全て実行エラーとなりました。</p><h3 id="根本原因"><a href="#根本原因" class="headerlink" title="根本原因"></a>根本原因</h3><p><a href="https://pypi.org/project/awswrangler/">awswrangler</a> が依存している、<a href="https://pypi.org/project/lxml/">lxml</a> ライブラリの最新バージョン <code>5.0.0</code> のインストール時に、以下 2種類のエラーが発生しました。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wheel パッケージで lxml のインストールに失敗</span></span><br><span class="line"></span><br><span class="line">Using legacy <span class="string">&#x27;setup.py install&#x27;</span> <span class="keyword">for</span> lxml, since package <span class="string">&#x27;wheel&#x27;</span> is not installed.</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># setup.py でインストール時に、</span></span><br><span class="line"><span class="comment"># gcc で src/lxml/etree.c をコンパイルする際に、out of memory エラーが発生</span></span><br><span class="line"></span><br><span class="line">× Running setup.py install <span class="keyword">for</span> lxml did not run successfully.  </span><br><span class="line">│ <span class="built_in">exit</span> code: 1  </span><br><span class="line">╰─&gt; [112 lines of output]</span><br><span class="line">(省略)</span><br><span class="line">    gcc -pthread -Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall -fPIC -DCYTHON_CLINE_IN_TRACEBACK=0 -I/usr/include/libxml2 -Isrc -Isrc/lxml/includes -I/.pyenv/versions/python39_loaded/include -I/.pyenv/versions/3.9.10/include/python3.9 -c src/lxml/etree.c -o build/temp.linux-x86_64-3.9/src/lxml/etree.o -w  </span><br><span class="line">      </span><br><span class="line">    cc1: out of memory allocating 65536 bytes after a total of 31883264 bytes  </span><br><span class="line">    Compile failed: <span class="built_in">command</span> <span class="string">&#x27;/usr/bin/gcc&#x27;</span> failed with <span class="built_in">exit</span> code 1  </span><br><span class="line">    creating tmp  </span><br><span class="line">    cc -I/usr/include/libxml2 -I/usr/include/libxml2 -c /tmp/xmlXPathInit3c3vwixm.c -o tmp/xmlXPathInit3c3vwixm.o  </span><br><span class="line">    cc tmp/xmlXPathInit3c3vwixm.o -lxml2 -o a.out  </span><br><span class="line">    error: <span class="built_in">command</span> <span class="string">&#x27;/usr/bin/gcc&#x27;</span> failed with <span class="built_in">exit</span> code 1  </span><br><span class="line">    [end of output]  </span><br><span class="line">  </span><br><span class="line">note: This error originates from a subprocess, and is likely not a problem with pip.  </span><br><span class="line">error: legacy-install-failure</span><br><span class="line">× Encountered error <span class="keyword">while</span> trying to install package.  </span><br><span class="line">╰─&gt; lxml</span><br></pre></td></tr></table></figure><h3 id="発生要因"><a href="#発生要因" class="headerlink" title="発生要因"></a>発生要因</h3><p><a href="https://pypi.org/project/lxml/">lxml</a> 最新バージョン <code>5.0.0</code> が、<a href="https://pypi.org/project/lxml/5.0.0/">2023&#x2F;12&#x2F;30 05:29 (JST)</a> にリリースされたためです。</p><h3 id="検出"><a href="#検出" class="headerlink" title="検出"></a>検出</h3><p>Glue ジョブの実行時に、 <code>Internal service error</code> 、タイムアウトエラー、もしくは以下のエラーが発生しました。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CommandFailedException: /tmp/glue-python-libs-XXXX/&lt;ライブラリ&gt;.whl installation failed after 2th retry due to exception: CalledProcessError</span><br></pre></td></tr></table></figure><h3 id="対応"><a href="#対応" class="headerlink" title="対応"></a>対応</h3><h4 id="対応案の検討"><a href="#対応案の検討" class="headerlink" title="対応案の検討"></a>対応案の検討</h4><p>以下の A と B、 2 つの対応案を検討しました。</p><h5 id="A-awswrangler-を-AWS-Glue-PythonShell-で事前にパッケージ済みのライブラリ利用へ変更"><a href="#A-awswrangler-を-AWS-Glue-PythonShell-で事前にパッケージ済みのライブラリ利用へ変更" class="headerlink" title="A. awswrangler を AWS Glue PythonShell で事前にパッケージ済みのライブラリ利用へ変更"></a>A. <a href="https://pypi.org/project/awswrangler/">awswrangler</a> を AWS Glue PythonShell で事前にパッケージ済みのライブラリ利用へ変更</h5><p>今回利用していた <code>awswrangler==1.5.2</code> は、AWS Glue PythonShell において事前にパッケージ済みのライブラリセットに含まれています。</p><p><a href="https://docs.aws.amazon.com/ja_jp/glue/latest/dg/add-job-python.html">参考: AWS Glueでの Python シェルジョブ - AWS Glue (amazon.com)</a></p><p>そのため、 <code>awswrangler</code> を明示的にインストールせずとも利用することが可能であるため、<br>AWS Glue ジョブの Libraries 設定から awswrangler の指定を削除することで、起動時のインストールを防ぎ、ライブラリの利用継続を行う案です。</p><p>メリット</p><ul><li>AWS 側で用意されたライブラリが利用でき、一般に利用できることから、ライブラリの状態は枯れている</li><li>起動時のインストール処理が省略され、実処理を実行するまでの時間が早くなり、全体的な処理速度向上が見込める<ul><li>※ 最大30秒程度の短縮であるため、全体のジョブ実行時間次第で支配的かどうか判断する</li></ul></li></ul><p>デメリット</p><ul><li>単体テスト&#x2F;結合テスト時にインストールしていたバージョンと、 <code>awswrangler==1.5.2</code> に依存する他パッケージのバージョンに差異が生まれる可能性がある</li></ul><h5 id="B-Glue-ジョブ設定の、DPU-x3D-0-0625-から-DPU-x3D-1-へ設定変更"><a href="#B-Glue-ジョブ設定の、DPU-x3D-0-0625-から-DPU-x3D-1-へ設定変更" class="headerlink" title="B. Glue ジョブ設定の、DPU&#x3D;0.0625 から DPU&#x3D;1 へ設定変更"></a>B. Glue ジョブ設定の、DPU&#x3D;0.0625 から DPU&#x3D;1 へ設定変更</h5><p>根本原因にて記載した通り、<a href="https://pypi.org/project/lxml/">lxml</a>を setup.py にてインストールする際に、<code>out of memory</code> エラーが発生していました。<br>そのため、マシンスペックを上げることで解消できないかと推測し、検証環境にて DPU&#x3D;0.0625 → DPU&#x3D;1 へ変更して実行したところ、正常に処理が完了しました。</p><p>メリット</p><ul><li>エラーが発生する前のライブラリのバージョン状態に近い環境で、Glue ジョブを動作させることができる<ul><li><a href="https://pypi.org/project/awswrangler/">awswrangler</a>に依存するライブラリのバージョンをエラー直前の成功したバージョンに近い状態とできる<ul><li>※ 近いという表現は、設定次第で依存する他のライブラリバージョンも変更される可能性があることに由来する(後述するが、そもそも実行時にバージョンが揺れること自体が本当の根本原因である)</li></ul></li></ul></li></ul><p>デメリット</p><ul><li>ビルドして作成する必要があり、wheel でのインストールに失敗する <a href="https://pypi.org/project/lxml/">lxml</a>のバージョンが利用される</li><li>DPU 値を上げるため、金銭的なコストが増加する</li></ul><h4 id="対応案の選択"><a href="#対応案の選択" class="headerlink" title="対応案の選択"></a>対応案の選択</h4><p>結論、対応案 A を選択しました。</p><p>判断基準として、”不具合を追加で発生させないこと” を置きました。<br>システム性質上、本番環境での継続的な実行ではなく、数回の実行を安定して行うことが求められていました。その結果、ライブラリの最新バージョン追従よりも、成熟し安定したバージョンでの実行を優先しました。</p><p>リスク評価としては、インストールエラーが発生した、最新の <a href="https://pypi.org/project/lxml/">lxml</a> により発生する不具合リスクと、<a href="https://pypi.org/project/awswrangler/">awswrangler</a>に依存するライブラリのバージョンが下がることで発生する不具合のリスクを考慮し、定量的ではないですが後者のほうがより発生するリスクが低いと判断しました。</p><p>ただ、どちらにせよリスクは発生するため、単体テストと AWS 環境上での結合テストを再度実行し、動作保証の上で本番稼働を行いました。</p><h4 id="修正事項"><a href="#修正事項" class="headerlink" title="修正事項"></a>修正事項</h4><p>AWS Glue ジョブの Libraries 設定に指定している wheel ライブラリ内で、<a href="https://pypi.org/project/awswrangler/">awswrangler</a> をインストールしない設定へ修正しました。<br>具体的には、 <code>poetry build -f wheel</code> で独自ライブラリを wheel ファイルへビルドしていたため、<a href="https://pypi.org/project/awswrangler/">awswrangler</a> を <code>poertry</code> における <code>dev group</code>   の依存へ変更しました。</p><p>before</p><figure class="highlight toml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># pyproject.toml</span></span><br><span class="line"></span><br><span class="line"><span class="section">[tool.poetry.dependencies]</span></span><br><span class="line"><span class="attr">awswrangler</span> = <span class="string">&quot;2.15.1&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[tool.poetry.group.dev.dependencies]</span></span><br></pre></td></tr></table></figure><p>after</p><figure class="highlight toml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># pyproject.toml</span></span><br><span class="line"></span><br><span class="line"><span class="section">[tool.poetry.dependencies]</span></span><br><span class="line"></span><br><span class="line"><span class="section">[tool.poetry.group.dev.dependencies]</span></span><br><span class="line"><span class="attr">awswrangler</span> = <span class="string">&quot;2.15.1&quot;</span> <span class="comment"># dev group へ変更</span></span><br></pre></td></tr></table></figure><h3 id="学び"><a href="#学び" class="headerlink" title="学び"></a>学び</h3><h4 id="うまくいったこと"><a href="#うまくいったこと" class="headerlink" title="うまくいったこと"></a>うまくいったこと</h4><p>幸いなことに、単体テスト&#x2F;結合テストにて追加の問題が発生せず、本番環境での実行も安定していました。</p><h4 id="振り返り"><a href="#振り返り" class="headerlink" title="振り返り"></a>振り返り</h4><p>後から振り返ると、リスク判断において正確な要素を抽出できていなかった点がありました。<br>その点は、<a href="https://pypi.org/project/lxml/">lxml</a> に対して実際に依存している処理があったのか否かです。<a href="https://pypi.org/project/lxml/">lxml</a>への依存は、<a href="https://pypi.org/project/awswrangler/">awswrangler</a> (正確には、内部で利用している <code>pandas</code> )内の処理のため、ライブラリの実装を読む必要がありましたが、正確なリスク評価としては必要だったのではと思いました。<br>時間的余裕次第ですが、調査をする選択肢をもっておくべきでした。</p><p>また、案の比較時に、インストールエラーが発生した <a href="https://pypi.org/project/lxml/">lxml</a> を利用すること自体が心理的障壁となり、選択時にバイアスがかかってしまったという点もありました。これは、エラーが発生したバージョンを使いたくないという感情から来るものでした。<br>客観的な判断で、より正確にリスク評価ができるとより良かったなと感じています。</p><h4 id="そもそもの話"><a href="#そもそもの話" class="headerlink" title="そもそもの話"></a>そもそもの話</h4><p>根本的には、実行時のライブラリのバージョンが固定されていないことが発生の要因です。<br>バージョンが固定 “されている”・”されていない” (※1) で少しメリット・デメリットを考えてみると、<br>メリットとしては、設定次第ではありますが最新のバージョンに近いバージョンが選択されることで、脆弱性の修正や性能向上等のバージョンアップによる改善を取り込むことができます。<br>デメリットとしては、当事象のようにバージョンが揺れることで、テスト時に発生していなかった不具合が突然発生するリスクが生まれます。</p><p>ケースバイケースではありますが、安定して運用することが第一である場合はデメリットは許容できないことが多い印象です。<br>そのため、ライブラリのバージョンを lock ファイル等を利用して固定の上で安定運用しつつ、もし継続して利用されるシステムの場合、適切にメンテナンスして如何にバージョンを上げていくかを考えることになるのかなと思います。(余談ですが、メンテナンスが検討できておらず、塩漬けにされて、いざ大きめの脆弱性が発見され、いきなり対応できないといった問題はありがちな気がします。)</p><p>ちなみに、AWS Glue の追加ライブラリにおいて、lock ファイル利用したライブラリのバージョン固定を行う方法は現時点ではわかりませんでした。</p><p><strong>※1 <code>バージョンが固定されていない</code> とは、ライブラリに対する依存ライブラリ設定に沿っている上という前提になります。</strong></p><p>例えば、<a href="https://github.com/aws/aws-sdk-pandas/blob/9d5c1a67af3f5e7e8d7aa506da1b97277d3e3bd6/pyproject.toml#L28">pyproject.toml - awswrangler</a> の設定を参考にすると、以下の通りです。</p><ul><li>boto3 は <code>1.20.32</code> 以上のバージョンに依存</li><li>pandas の場合<ul><li>python version が 3.9 より小さい場合は、 <code>1.2.0 &lt;= version &lt; 2.1.0</code> の間のバージョンに依存</li><li>python version が 3.9 以上の場合は、 <code>1.2.0 &lt;= version &lt; 3.0.0</code> の間のバージョンに依存</li></ul></li></ul><figure class="highlight toml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 参考: https://github.com/aws/aws-sdk-pandas/blob/9d5c1a67af3f5e7e8d7aa506da1b97277d3e3bd6/pyproject.toml#L28</span></span><br><span class="line"></span><br><span class="line"><span class="section">[tool.poetry.dependencies]</span></span><br><span class="line"><span class="attr">python</span> = <span class="string">&quot;&gt;=3.8, &lt;4.0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Required</span></span><br><span class="line"><span class="attr">boto3</span> = <span class="string">&quot;^1.20.32&quot;</span></span><br><span class="line"><span class="attr">botocore</span> = <span class="string">&quot;^1.23.32&quot;</span></span><br><span class="line"><span class="attr">pandas</span> = [</span><br><span class="line">    &#123; version = <span class="string">&quot;&gt;=1.2.0,&lt;2.1.0&quot;</span>, markers = <span class="string">&quot;python_version &lt; \&quot;3.9\&quot;&quot;</span> &#125;,</span><br><span class="line">    &#123; version = <span class="string">&quot;&gt;=1.2.0,&lt;3.0.0&quot;</span>, markers = <span class="string">&quot;python_version &gt;= \&quot;3.9\&quot;&quot;</span> &#125;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>上記設定のため、boto3 であれば実行時に <code>1.20.32</code> 以上のバージョン (最新バージョン) が利用され、pandas もバージョン指定内の最新バージョンが利用される可能性があります。</p><h2 id="補足"><a href="#補足" class="headerlink" title="補足"></a>補足</h2><h3 id="lxml-の-wheel-インストールエラー自体の解消"><a href="#lxml-の-wheel-インストールエラー自体の解消" class="headerlink" title="lxml の wheel インストールエラー自体の解消"></a><a href="https://pypi.org/project/lxml/">lxml</a> の wheel インストールエラー自体の解消</h3><p>バージョン 5.0.1 と 5.1.0 にて、解消されたバージョンがリリースされています。</p><p>参考: <a href="https://lxml.de/5.1/changes-5.1.0.html">lxml changelog</a><br><img src="/images/20240119a/image.png" alt="image.png" width="1200" height="358" loading="lazy"></p><h3 id="wheel-とは"><a href="#wheel-とは" class="headerlink" title="wheel とは"></a>wheel とは</h3><p><a href="https://peps.python.org/pep-0427/">PEP 427</a> で定義された Python のパッケージファイルフォーマットを指します。拡張子は <code>.whl</code> であり、中身としては ZIP 形式のアーカイブです。</p><p>フォルダ構成は、ZIP 解凍をすることでわかりますが、以下の通りです。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">├─ &lt;ライブラリディレクトリ&gt;</span><br><span class="line">   ├─ ...</span><br><span class="line">└─ &lt;ライブラリ名&gt;.dist-info</span><br><span class="line">   ├─ METADATA</span><br><span class="line">   ├─ RECORD</span><br><span class="line">   └─ WHEEL</span><br></pre></td></tr></table></figure><p>当事象に関連する内容としては、 <code>.dist-info</code> 以下の <code>METADATA</code> に依存するライブラリのバージョンが記載されています。<br><code>pip</code> で <code>wheel</code> ファイルを指定してインストールした際に、<code>Requires-Dist</code> に記載されているライブラリがインストールされます。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">Metadata-Version: 2.1</span><br><span class="line">Name: &lt;ライブラリ名&gt;</span><br><span class="line">Version: 1.0.0</span><br><span class="line">Summary: </span><br><span class="line">Author: XXX</span><br><span class="line">Requires-Python: &gt;=3.9.10,&lt;3.11</span><br><span class="line">Classifier: Programming Language :: Python :: 3</span><br><span class="line">Classifier: Programming Language :: Python :: 3.10</span><br><span class="line">Requires-Dist: boto3 (==1.28.64)</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">Description-Content-Type: text/markdown</span><br><span class="line"></span><br><span class="line">(README.md の内容が記載)</span><br></pre></td></tr></table></figure><h2 id="所感"><a href="#所感" class="headerlink" title="所感"></a>所感</h2><p>ポストモーテムとして、振り返りをまとめてみました。<br>数年に一回あるかないかの問題ではありますが、同様の問題が発生した際に判断の参考になれば良いなと思います。</p><h2 id="参考情報"><a href="#参考情報" class="headerlink" title="参考情報"></a>参考情報</h2><ul><li><a href="https://qiita.com/an_sony/items/0565ad980f9097c76d11#fn1">ポストモーテムを理解する #運用 - Qiita</a></li><li><a href="https://lxml.de/5.1/changes-5.1.0.html">lxml changelog</a></li></ul>]]></content:encoded>
      
      
      <category domain="https://future-architect.github.io/categories/Infrastructure/">Infrastructure</category>
      
      
      <category domain="https://future-architect.github.io/tags/AWS/">AWS</category>
      
      <category domain="https://future-architect.github.io/tags/Glue/">Glue</category>
      
      <category domain="https://future-architect.github.io/tags/%E3%83%88%E3%83%A9%E3%83%96%E3%83%AB%E3%82%B7%E3%83%A5%E3%83%BC%E3%83%88/">トラブルシュート</category>
      
      <category domain="https://future-architect.github.io/tags/%E3%83%9D%E3%82%B9%E3%83%88%E3%83%A2%E3%83%BC%E3%83%86%E3%83%A0/">ポストモーテム</category>
      
      <category domain="https://future-architect.github.io/tags/awswrangler/">awswrangler</category>
      
      
      <comments>https://future-architect.github.io/articles/20240119a/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>ウォーターフォールでもアジャイルでも「タイムラインふりかえり」をやってみたらどうでしょう？という話</title>
      <link>https://future-architect.github.io/articles/20240118a/</link>
      <guid>https://future-architect.github.io/articles/20240118a/</guid>
      <pubDate>Wed, 17 Jan 2024 15:00:00 GMT</pubDate>
      
        
        
          
          
      <description>&lt;img src=&quot;/images/20240118a/image.png&quot; alt=&quot;image.png&quot; width=&quot;1024&quot; height=&quot;1024&quot; loading=&quot;lazy&quot;&gt;

&lt;h2 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot;</description>
          
        
      
      
      
      <content:encoded><![CDATA[<img src="/images/20240118a/image.png" alt="image.png" width="1024" height="1024" loading="lazy"><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>Global Design Group所属の山本です。</p><p>フューチャーに新卒入社してこれまで、ウォーターフォール開発のプロダクトにいくつか携わっていましたが、この度はじめてアジャイル開発に関わりました。</p><p>その中で、チーム内での「振り返り」の大切さを感じたのでどんな振り返りがよいのか、個人的に考えたことをまとめます。</p><p>また、「振り返り」のひとつのアプローチとして、「タイムラインふりかえり」を主催してみたらいい感じだったのでそれについても書きます。</p><h2 id="システム開発ライフサイクルについて"><a href="#システム開発ライフサイクルについて" class="headerlink" title="システム開発ライフサイクルについて"></a>システム開発ライフサイクルについて</h2><p>そもそも、ウォーターフォール開発やアジャイル開発とはなんなのでしょうか？</p><p>どちらも、システム開発をいくつかの段階に定義して行うプロセスである、システム開発ライフサイクル（Systems Development Life Cycle）の手法の1つです。</p><p>このシステム開発ライフサイクルの分類や定義、メリット・デメリットもいくつかあるので、詳細はこの記事では触れません。</p><p>1つ大きな分類を上げると、<br>ウォーターフォール開発に代表されるような、ひとつひとつのステップを完了させて次のステップに進む「シーケンシャル開発モデル」と、<br>アジャイル開発に代表されるような、システムをいくつかの単位に分けて、単位ごとに一連のステップを徐々に開発する「インクリメンタル開発モデル」</p><p>の2つに大別するものがあります。</p><p>私が今まで関わったプロジェクトは、「シーケンシャル開発モデル」の中でも、「V字モデル」に分類されるものが多かったです。</p><p>要求定義、要件定義からはじまり、基本設計-&gt;…-&gt;コーディング-&gt;単体テスト…とステップごとに進むもので、基本的には次のステップに進んだ場合には前のステップに戻らないことを前提としています。</p><p>一般的にウォーターフォール開発として想像されるものですね。</p><p>両者を比較すると、大きな違いとしてはステップサイクルの単位や期間が異なることが挙げられます。</p><h2 id="インクリメンタル開発モデルと「振り返り」"><a href="#インクリメンタル開発モデルと「振り返り」" class="headerlink" title="インクリメンタル開発モデルと「振り返り」"></a>インクリメンタル開発モデルと「振り返り」</h2><img src="/images/20240118a/image_2.png" alt="image.png" width="879" height="398" loading="lazy"><p>今回、私ははじめてアジャイル開発でのプロジェクトに参加しました。ウォーターフォールとリリースサイクルや動き方が大きく変わるため、良い経験になりました。</p><p>その経験の中で、「振り返り」という文脈で考えると、1つの大きな特徴として「キリが良い」ということが挙げられると思います。数週間単位でサイクルを回すので、自然と1つのサイクルが終わったときに振り返りをしやすいんですね。また、類似したステップを次のサイクルでも回すことになるので、作業内容自体の振り返りがダイレクトに活用できるということがあります。</p><p>スクラム開発の著名なガイドラインである「スクラムガイド<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>」でも、スクラム開発の1サイクル(スプリント)の終了時に、レトロスペクティブ(振り返り)として「スプリントレトロスペクティブ」を行うことが定義されており、振り返りがサイクルの中でも重要なポジションを占めています。</p><p>「スプリントレトロスペクティブ」の章については、以下のように記載されています。</p><blockquote><p>スプリントレトロスペクティブの⽬的は、品質と効果を⾼める⽅法を計画することである。<br>スクラムチームは、個⼈、相互作⽤、プロセス、ツール、完成の定義に関して、今回のスプリントがどのように進んだかを検査する。多くの場合、検査する要素は作業領域によって異なる。<br>スクラムチームを迷わせた仮説があれば特定し、その真因を探求する。スクラムチームは、スプリント中に何がうまくいったか、どのような問題が発⽣したか、そしてそれらの問題がどのように解決されたか（または解決されなかったか）について話し合う。<br>スクラムチームは、⾃分たちの効果を改善するために最も役⽴つ変更を特定する。最も影響の⼤きな改善は、できるだけ早く対処する。</p></blockquote><p>スクラム開発に限らず、振り返りとして行いたいコンテンツとしては他の開発モデルにも共通する物があるのではないでしょうか？</p><p>今回の経験を通して、短期間で振り返り・フィードバックを行うことは、アジャイルに限らず有意義なことと感じました。では、ウォーターフォール開発などのスプリント単位がない場合ではどうなるのでしょうか？</p><h2 id="シーケンシャル開発モデルと「振り返り」"><a href="#シーケンシャル開発モデルと「振り返り」" class="headerlink" title="シーケンシャル開発モデルと「振り返り」"></a>シーケンシャル開発モデルと「振り返り」</h2><img src="/images/20240118a/image_3.png" alt="image.png" width="806" height="533" loading="lazy"><p>次に上の図のような、典型的なウォーターフォール開発とチーム内での「振り返り」について考えてみましょう。<br>メンバー目線での上記の特徴としては、「要件定義」や「コーディング」の1つのステップに数ヶ月、大規模なシステムでは年単位の時間がかかることが挙げられると思います。</p><p>「振り返り」の目線ではどうでしょうか？</p><p>1つ悪い特徴としては、ステップ単位でとらえると「キリが良い」と感じるタイミングまで数ヶ月〜数年単位で時間がかかるということです。また、ステップ単位で振り返りを行っても、次のステップと作業内容自体はダイレクトにはかぶらないこともあります。</p><p>他にも、受注や要件定義のタイミングで全体のスケジュールを決定してしまうため、(トラブルが発生した場合の)後半のテストフェーズなどでは、期日通りに仕事を終わらせることで頭がいっぱいで「振り返り」をしている場合ではない！といった心情になりやすいと感じています。</p><p>実際に自分が今まで参加したウォーターフォール開発のプロジェクトでは、個人に対しては定期的な1on1、360度フィードバックなどの実施はありました。(これは会社としても取り組んでいます。良いことですね)</p><p>一方で、チーム単位での「振り返り」としては受け入れテストまで完了した時点でKPT法での全体の振り返りを行う事が多かったです。</p><p>この振り返りを行うことで、個人的な学びはありますが全く同じチームではすぐに仕事はしないので悩ましいものがあると感じていました。</p><h2 id="ウォーターフォール開発でいつ振り返りをすればよいのか問題"><a href="#ウォーターフォール開発でいつ振り返りをすればよいのか問題" class="headerlink" title="ウォーターフォール開発でいつ振り返りをすればよいのか問題"></a>ウォーターフォール開発でいつ振り返りをすればよいのか問題</h2><p>チームでの振り返りをする目的の大きなひとつとして、チームレベルでの課題を洗い出し、対応・改善して次に活かすといったことが挙げられると思います。</p><p>その視点で考えると、「ステップの終了時」「すべてのステップの終了時」に行うのはそこまで良くない気がしてきますね。</p><img src="/images/20240118a/image_4.png" alt="image.png" width="885" height="551" loading="lazy"><p>例えば、基本設計終了時に、基本設計フェーズに関する課題や学びが得られても、工程自体に依存するものであった場合は次にメンバーが関わる・活かせるのは数年後とかになりかねません。<br>(※もちろん、課題が次のステップに関連があり有用なケースも考えられます)</p><p>また、振り返りの対象の期間が長くなるため、粒度としても大きくあいまいなものになりがちです。</p><p>そのため、ステップやプロジェクトの「キリの良さ」にとらわれず、数週間〜数ヶ月に1回の定期的なイベントとして組むことが1つのアプローチとして考えられます。</p><h2 id="どのような振り返りをすればよいのか？"><a href="#どのような振り返りをすればよいのか？" class="headerlink" title="どのような振り返りをすればよいのか？"></a>どのような振り返りをすればよいのか？</h2><p>さて、個人的にはアジャイル開発でも、ウォーターフォール開発でも「振り返り」を行いたいわけですが、実際にはどのような方法を行えばよいのでしょうか？</p><p>「振り返り」のフレームワーク・手法については山のようにあります。有名なものを上げるだけでも、以下のようなものがあります。</p><ul><li><strong>KPT(Keep Problem Try)</strong><br>Keep(継続すること)・Problem(課題)を洗い出し、Try(次に取り組むこと)を検討する</li><li><strong>Good &amp; New</strong><br>良かったこと（Good）と新しい発見（New）を発表して共有する</li><li><strong>FDL(Fun&#x2F;Done&#x2F;Learn)</strong><br>Fun(楽しかったこと)・Done(アウトプットしたこと)・Learn(学んだこと)で振り返りを行う</li><li><strong>SSC(Start Stop Continue)</strong><br>Start(はじめること)・Stop(やめること)・Continue(続けること)で振り返りを行う</li><li><strong>Elephants, dead fish &amp; vomit</strong><br>象(大きく、無視されている問題)・死んだ魚(放置すると問題があるもの)・吐瀉物(蓄積された考えを吐き出す)の3つの観点から課題を考える</li></ul><p>特徴・振り返りの目的に応じて選択するべきだとは思うのですが、自分のこれまでの関わりや経験上では、知名度とシンプルさから「KPT」が第一選択肢とされることが多かったです。</p><h2 id="「KPT」で振り返りをするとどうなる？"><a href="#「KPT」で振り返りをするとどうなる？" class="headerlink" title="「KPT」で振り返りをするとどうなる？"></a>「KPT」で振り返りをするとどうなる？</h2><p>KPTで振り返りをした個人の感想としては、以下のようなものがあります。</p><p>■メリット</p><ul><li>シンプルでわかりやすい。チームメンバー全員が認識している可能性が高い。</li><li>振り返りの成果として、次に繋げる(Try)ことを明文化しやすい</li></ul><p>■デメリット</p><ul><li>議論が発散しやすい、ファシリテーターの質に依存しやすい</li><li>Problemに集中していまい、反省会のようなムードになりやすい</li><li>チームメンバーが何をしていたのか分かりづらい</li></ul><p>手法の選択肢としては良いところもありなのですが、個人的にはデメリットの部分が気になってしまいます。<br>特に、Problemに話題が集中してお通夜のような雰囲気となってしまえば、「振り返り」自体にネガティブなイメージを持つことに繋がりかねません。</p><p>この課題については、チームメンバーやファシリテーションに大きく依存してしまう部分であるため、安定した解決策を求めることが難しいのではないか…？と個人的には感じてます。</p><p>なので今回チームとしては、フレームワークを変えて、「タイムラインふりかえり」 + 「KPT」での振り返りをトライしてみました。</p><h2 id="タイムラインふりかえり-KPT"><a href="#タイムラインふりかえり-KPT" class="headerlink" title="タイムラインふりかえり + KPT"></a>タイムラインふりかえり + KPT</h2><p>「タイムラインふりかえり」については、以下書籍<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup>に記載されていたものを参考にアレンジして取り入れました。</p><p><a href="https://www.shoeisha.co.jp/book/detail/9784798165387">https://www.shoeisha.co.jp/book/detail/9784798165387</a></p><ul><li>社内やチームの出来事を時系列で付箋に書き出す</li><li>メンバーごとに時系列に対する「感情グラフ」を書き出す</li></ul><p>ことが大きな特徴です。今回は会議室でホワイトボードでやったのですが、イメージとしては以下のようなものとなります。</p><img src="/images/20240118a/image_5.png" alt="image.png" width="828" height="650" loading="lazy"><p>この「感情グラフ」の部分がユニークなポイントで、実際にやってみると盛り上がりやすいので、ポジティブなムードの醸成といった意味でも良かったです。</p><h2 id="具体的にやった手順"><a href="#具体的にやった手順" class="headerlink" title="具体的にやった手順"></a>具体的にやった手順</h2><p>「振り返り、次につなげる」「反省会のようなムードにしない」「チームメンバー間でのタスク内容を共有できる」ことを目的に、いくつかアレンジして振り返り会を実践しましたので、その手順などを紹介します。</p><p>■前準備</p><ul><li>振り返り会の前日、チームメンバーに時系列で発生したイベントをざっと書き出してもらう(スプレッドシートを使用しました)</li><li>振り返り会の開催直前、ホワイトボードにチーム単位&#x2F;時系列の枠を書き出す。また、時間節約のためわかっているイベントは付箋として張り出しておく</li></ul><p>■実施手順</p><ol><li>説明：アイスブレイク・振り返り会の方法を紹介する</li><li>ワーク：それぞれ思いつくイベント・個人の感想などを付箋に書き出し貼ってもらう</li><li>ワーク：感情グラフを記入してもらう</li><li>ディスカッション：感情グラフについての簡単な雑談、タイムラインでカードが少ない部分や感情グラフの起伏に対応したイベントが有る場合には、追加で付箋を貼ってもらう</li><li>ワーク：メンバーで議論しながら、付箋をGood&#x2F;Badに分類してもらう。</li><li>ディスカッション：作成された付箋や感情グラフを見て、ディスカッションを行う</li><li>ディスカッション：ディスカッション内容をもとに、KPTを抽出する</li><li>まとめ</li></ol><p>実施手順ごとの成果物のイメージとしては、以下の図のようなものとなります。</p><img src="/images/20240118a/image_6.png" alt="image.png" width="1162" height="322" loading="lazy"><p>最初はタイムラインでイベントや感想を洗い出し、次に分類し、最後にKPTとしてまとめるといった寸法ですね。</p><h2 id="やってみた感想"><a href="#やってみた感想" class="headerlink" title="やってみた感想"></a>やってみた感想</h2><p>さて、実際に上記の方法で振り返り会を実施してました。</p><p>単純にKPTで振り返りを実施することと比較すると、以下のようなGood&#x2F;Badがあったと感じてます。</p><p>■Good</p><ul><li>時系列で振り返ることで、イベント・メンバーの感想を網羅して洗い出すことができた</li><li>感情グラフを作成することで、チームのモチベーションを高く維持するためにはどうすればよいのか？ということまで検討できた</li><li>関わりが少ないチームメンバーについても、タスク内容やモチベーションを共有することができた</li><li>振り返り会の中で、極端にネガティブな雰囲気とならなかった(※実施したチームメンバーが良かったこともありますが)</li></ul><p>■Bad</p><ul><li>事前準備が必要になる</li><li>実施自体に時間がかかる。とくに、タイムラインのレンジが広いほど実施時間がかかる</li></ul><p>こうして考えると、チームメンバー間の共有や雰囲気作り、モチベーション設計の検討についてはかなり有意義な手法ではないかと思いました。</p><p>今回はアジャイル開発を行っているチームで採用したのですが、開発サイクルにとらわれず実施できる方法であると感じたので、ウォーターフォール開発でも数週間単位で積極的に取り入れたいですね。</p><p>また、Badについては、数週間単位で定期的に実行していればある程度緩和できるものとも思います。</p><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>この記事では、チームの「振り返り」という部分に焦点を当てて、アジャイル開発とウォーターフォール開発での個人的な経験や取り組み、感想を紹介しました。</p><p>どうしても仕事が忙しいときには、目の前のタスクで頭が一杯になってしまい、視野が狭まりがちです。</p><p>そのような状況でも、チームでの「振り返り」は開発サイクルに関わらず、チームの改善や個人の成長につながる重要なことで、可能であれば数週間単位のスパンで取り入れたいものだと思ってます。</p><p>「振り返り」の手法・フレームワークについてはいろいろなものがありますが、今回実施した「タイムラインふりかえり + KPT」はやりやすくメリットも多いものでした。</p><p>まだまだ自分が知らない「振り返り」のフレームワークもあるので、今後どのような開発サイクルに関わる場合でも、チームの振り返りについては有意義なものとすべく勉強し続けたいものです。</p><p>最後まで読んでいただきありがとうございました。<br>※アイキャッチ画像はDALL-Eで生成しました</p><h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><div id="footnotes"><hr><div id="footnotelist"><ol style="list-style:none; padding-left: 0;"><li id="fn:1"><span style="vertical-align: top; padding-right: 10px;">1.</span><span style="vertical-align: top;"><a href="https://scrumguides.org/docs/scrumguide/v2020/2020-Scrum-Guide-Japanese.pdf">https://scrumguides.org/docs/scrumguide/v2020/2020-Scrum-Guide-Japanese.pdf</a></span><a href="#fnref:1" rev="footnote"> ↩</a></li><li id="fn:2"><span style="vertical-align: top; padding-right: 10px;">2.</span><span style="vertical-align: top;">沢渡 あまね (著), 新井 剛 (著).「ここはウォーターフォール市、アジャイル町 ストーリーで学ぶアジャイルな組織のつくり方」. 2020. 翔泳社</span><a href="#fnref:2" rev="footnote"> ↩</a></li></ol></div></div>]]></content:encoded>
      
      
      <category domain="https://future-architect.github.io/categories/Culture/">Culture</category>
      
      
      <category domain="https://future-architect.github.io/tags/%E3%82%A2%E3%82%B8%E3%83%A3%E3%82%A4%E3%83%AB/">アジャイル</category>
      
      <category domain="https://future-architect.github.io/tags/%E3%81%B5%E3%82%8A%E3%81%8B%E3%81%88%E3%82%8A/">ふりかえり</category>
      
      <category domain="https://future-architect.github.io/tags/%E3%82%A6%E3%82%A9%E3%83%BC%E3%82%BF%E3%83%BC%E3%83%95%E3%82%A9%E3%83%BC%E3%83%AB/">ウォーターフォール</category>
      
      
      <comments>https://future-architect.github.io/articles/20240118a/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>【合格記】Google Cloud Professional Developer認定資格を振り返る</title>
      <link>https://future-architect.github.io/articles/20240117a/</link>
      <guid>https://future-architect.github.io/articles/20240117a/</guid>
      <pubDate>Tue, 16 Jan 2024 15:00:00 GMT</pubDate>
      
        
        
          
          
      <description>&lt;img src=&quot;/images/20240117a/Professional_Level_Google_Meets_Background.png&quot; alt=&quot;&quot; width=&quot;1200&quot; height=&quot;682&quot; loading=&quot;lazy&quot;&gt;


&lt;h2</description>
          
        
      
      
      
      <content:encoded><![CDATA[<img src="/images/20240117a/Professional_Level_Google_Meets_Background.png" alt="" width="1200" height="682" loading="lazy"><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>TIG岸下です。</p><p>Futureに中途で入社して今月で2年になります。2年前に初めてGoogle Cloudのプロジェクトに携わることになってから、ありがたいことに2年間Google Cloudに触れてきました。そこで、今回はDeveloper力を試すべくProfessional Developer認定資格を受験し、無事に合格を果たすことができました。</p><p>本記事では試験の特徴や学習内容、頻出しそうな項目について記していきたいと思います。</p><p>また本試験はGoogle Cloudパートナー企業向けのバウチャーを活用して受験しました。大変感謝しております！</p><p>Google Cloud 認定資格関連の過去記事：</p><p><a href="https://future-architect.github.io/articles/20231226a/">【合格体験記】Google Cloudの入門試験：Cloud Digital Leader</a><br><a href="https://future-architect.github.io/articles/20230921a/">【合格記】Google Cloud Professional Cloud Security Engineer認定資格を振り返る </a><br><a href="https://future-architect.github.io/articles/20211013a/">【合格記】Google Cloud Professional Data Engineer認定資格を振り返る</a><br><a href="https://future-architect.github.io/articles/20220930a/">【合格記】Google Cloud Professional Machine Learning Engineer認定資格を振り返る</a><br><a href="https://future-architect.github.io/articles/20220411a/">Google Cloud Professional Cloud Architectの再認定に合格しました</a><br><a href="https://future-architect.github.io/articles/20200902/">GCP Professional Cloud Network Engineer に合格しました</a><br><a href="https://future-architect.github.io/articles/20210625a/">GCP Associate Cloud Engineer 合格記</a></p><p>皆さんの協力のおかげで残りの合格記は</p><ul><li>Cloud Database Engineer</li><li>Cloud DevOps Engineer</li><li>Google Workspace Administrator</li></ul><p>の3つのみとなり、非常に感慨深いです。</p><h2 id="試験と出題範囲"><a href="#試験と出題範囲" class="headerlink" title="試験と出題範囲"></a>試験と出題範囲</h2><p><a href="https://cloud.google.com/learn/certification/cloud-developer?hl=ja">公式の出題範囲</a>と、実際に自分が受けた際の所感は以下になります。</p><h3 id="スケーラビリティ、可用性、信頼性に優れたクラウドネイティブ-アプリケーションの設計"><a href="#スケーラビリティ、可用性、信頼性に優れたクラウドネイティブ-アプリケーションの設計" class="headerlink" title="スケーラビリティ、可用性、信頼性に優れたクラウドネイティブ アプリケーションの設計"></a>スケーラビリティ、可用性、信頼性に優れたクラウドネイティブ アプリケーションの設計</h3><ul><li>コンテナの基礎知識<ul><li>アプリケーションのコンテナ化におけるベストプラクティス</li></ul></li><li>アーキ設計とサービスの使い分け<ul><li>Cloud Run、Google Kubernetes Engine、App Engine、Managed Instance Groupなどアプリケーションのデプロイ環境</li><li>Cloud SQL、Spanner、Bigtable、Firebaseなどのデータベース環境</li><li>内部通信のみを利用したいケース（限定公開のGoogleアクセスを利用するなど）</li></ul></li><li>GKE（Kubernetes）の基礎知識<ul><li>Ingress、Service、Deployment、Podなどの役割、何を定義するのか</li><li>Workload Identityを利用したサービスアカウントとの紐づけ</li><li>Namespaceの使い分けにおけるベストプラクティス</li><li>Pod同士の通信方法</li><li>水平スケーリングと垂直スケーリング</li><li>Istio（Google CloudマネージドであればAnthos Service Mesh）</li></ul></li><li>PubSubの基礎知識<ul><li>トピックやサブスクリプションの置き方</li><li>トピックからPushされるのか、Pullするのか</li></ul></li></ul><h3 id="アプリケーションのデプロイ"><a href="#アプリケーションのデプロイ" class="headerlink" title="アプリケーションのデプロイ"></a>アプリケーションのデプロイ</h3><ul><li>デプロイ方法の理解<ul><li>カナリアリリース、Blue&#x2F;Green、ローリングアップデートなど</li></ul></li><li>トラフィックの分割<ul><li>サービスそのものの機能としての分割（Cloud Runなど）、Kubernetesの機能としての分割</li></ul></li><li>デプロイタイミングの制御<ul><li>Cloud Buildを利用した自動化</li></ul></li></ul><h3 id="デプロイされたアプリケーションの管理"><a href="#デプロイされたアプリケーションの管理" class="headerlink" title="デプロイされたアプリケーションの管理"></a>デプロイされたアプリケーションの管理</h3><ul><li>Cloud Loggingへのログ出力<ul><li>JSON形式による吐き出しの推奨</li><li>エラー標準出力を利用した連携</li></ul></li><li>Cloud Loggingの他サービスとの連携<ul><li>ログルーターを利用したPubSub、BigQuery、Cloud Storageとの連携</li><li>Google Cloud外のサービスと連携するにはPubSubにルーティングしておくなど</li></ul></li><li>Cloud Monitoringを利用したアラートの設定<ul><li>ログベースなのか、メトリクスベースなのか</li></ul></li><li>Cloud ProfilerやTraceを利用したエラーやサービス遅延の解明</li><li>権限回り<ul><li>最小権限の法則に従う</li><li>エラー内容から足りない権限のトラブルシューティング</li></ul></li></ul><h3 id="アプリケーションのビルドとテスト"><a href="#アプリケーションのビルドとテスト" class="headerlink" title="アプリケーションのビルドとテスト"></a>アプリケーションのビルドとテスト</h3><ul><li>Cloud Buildを利用したイメージビルド<ul><li>Cloud Source Repositoryとの連携による自動化</li></ul></li><li>Artifact Registryを利用したイメージの脆弱性チェック<ul><li>Binary Authorization</li></ul></li><li>単体テストのベストプラクティス<ul><li>PubSubやCloud Runエミュレータを利用したローカルでのテスト</li></ul></li></ul><h3 id="Google-Cloud-サービスの統合"><a href="#Google-Cloud-サービスの統合" class="headerlink" title="Google Cloud サービスの統合"></a>Google Cloud サービスの統合</h3><ul><li>オンプレとGoogle Cloudサービスの統合<ul><li>Kubernetesクラスターの共存</li></ul></li><li>リフトアンドシフト<ul><li>業務影響を最小に抑えた移行戦略</li><li>データベースとして利用されているアプリケーションを考慮した移行</li></ul></li></ul><h3 id="全体的な所感"><a href="#全体的な所感" class="headerlink" title="全体的な所感"></a>全体的な所感</h3><p>やはりDeveloperということもあって、Google Cloudを利用したアプリケーション開発におけるベストプラクティスを問われる問題が多かったです。特に<strong>Kubernetesの基礎知識、GKEやCloud Runなど、アプリケーションをデプロイするためのサービスへの基礎知識</strong>は絶対に必要になります。<br>また、どの試験もあるあるな出題ですが、要求されるサービスがマネージドを希望しているのかどうか、可用性が重視されているのかなど、問いの文脈からサービスを選ぶ能力は必須です。<br>ただどの試験も4～5択なので、答えがわからなくても問いの文脈から消去法を使って選択肢を絞り込むことはできるので、サービスごとの違いを理解しておくと答えやすくなります。</p><h2 id="受験までの過程"><a href="#受験までの過程" class="headerlink" title="受験までの過程"></a>受験までの過程</h2><p>出題範囲の内容はほとんど実務で経験済みだったので、勉強期間は1週間ほどで済みました。試験への理解度を測るために、毎度おなじみのUdemyで問題集を購入し、各模擬試験セットを2周しておきました。</p><p><a href="https://www.udemy.com/course/google-professional-cloud-developer-2023/">詳解Google Professional Cloud Developer 模擬試験2024</a></p><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>Google Cloudのサービスは多岐にわたるため数が多く、存在を知らないサービスが結構あります。<br>今回受験してみて、Cloud ProfilerやCloud Traceというサービスの存在や利用用途を知ることができました。特にデプロイされたアプリケーションの関数毎でリソースに対する使用割合を計測することができるCloud Profilerは今後使うことがでてきそうだなーと思いました。<br>また、デプロイ環境はほとんどのケースでまずCloud Runがファーストチョイスでいいのでは？ってくらいCloud Runは便利なサービスだと試験内容を復習する中で感じました。</p><p><a href="https://cloud.google.com/architecture?hl=ja">Cloud アーキテクチャセンター</a>をベースにした問題も多く、ここらへんのドキュメントを1つずつハンズオンでやっていくと、更に理解を深められそうです。<br>Developer力を試したい方は一度受けてみてはいかがでしょうか！</p><p>アイキャッチ画像は<a href="https://sites.google.com/robertsonmarketing.com/digitalassetdownloadportal/digital-toolkit">Google Cloud Certification</a>から付与されたものになります。</p>]]></content:encoded>
      
      
      <category domain="https://future-architect.github.io/categories/Infrastructure/">Infrastructure</category>
      
      
      <category domain="https://future-architect.github.io/tags/GCP/">GCP</category>
      
      <category domain="https://future-architect.github.io/tags/%E5%90%88%E6%A0%BC%E8%A8%98/">合格記</category>
      
      <category domain="https://future-architect.github.io/tags/Google-Cloud/">Google Cloud</category>
      
      
      <comments>https://future-architect.github.io/articles/20240117a/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>【合格体験記】（ドローン）二等無人航空機操縦士の振り返り</title>
      <link>https://future-architect.github.io/articles/20240109a/</link>
      <guid>https://future-architect.github.io/articles/20240109a/</guid>
      <pubDate>Mon, 08 Jan 2024 15:00:00 GMT</pubDate>
      
        
        
          
          
      <description>&lt;p&gt;こんにちは。公共サービス事業部の村上一彦です。2020年フューチャーに中途入社し、これまで金融業・公共業にわたりシステム開発に従事してきました。&lt;/p&gt;
&lt;p&gt;そんな私が、無人航空機操縦士試験（二等）に合格するまでの体験記をご紹介します。&lt;/p&gt;
&lt;p&gt;↓著者の相棒</description>
          
        
      
      
      
      <content:encoded><![CDATA[<p>こんにちは。公共サービス事業部の村上一彦です。2020年フューチャーに中途入社し、これまで金融業・公共業にわたりシステム開発に従事してきました。</p><p>そんな私が、無人航空機操縦士試験（二等）に合格するまでの体験記をご紹介します。</p><p>↓著者の相棒 DJI社製 Mini3<br><img src="/images/20240109a/IMG_6263.jpg" alt="IMG_6263.jpg" width="562" height="323" loading="lazy"></p><h1 id="1-無人航空機操縦士試験（二等）とは"><a href="#1-無人航空機操縦士試験（二等）とは" class="headerlink" title="1. 無人航空機操縦士試験（二等）とは"></a>1. 無人航空機操縦士試験（二等）とは</h1><p>無人航空機操縦士試験（二等）とは、ドローン等（無人航空機）に関する唯一の国家資格になります。</p><p>2022年12月5日から技能証明制度が施行されており、ドローン等を飛行させるのに必要な技能（知識及び能力）を有することを証明する資格制度です。</p><p>資格の取得には、以下の３つの試験をクリアする必要があります。</p><p>仮免試験がない車の免許をイメージして頂くと近いと思います。</p><ul><li>学科試験</li><li>実地試験</li><li>身体検査</li></ul><p>また資格には、以下の限定(車で言うとAT限定のようなもの)があり、限定解除する場合は、通常の資格に追加して講習や試験が必要になります。</p><dl><dt>無人航空機の種類（機体の種類）</dt><dd> 回転翼航空機（マルチローター）</dd><dd> 回転翼航空機（ヘリコプター）</dd><dd> 飛行機（固定翼）</dd><dt>無人航空機の種類（機体の重量）</dt><dd>上記の機体の種類それぞれに対して最大離陸重量25kg未満</dd><dt>飛行の方法</dt><dd>目視内飛行(モニターを見ず、機体を目視しながら飛行させること)</dd><dd>昼間飛行</dd></dl><p>著者は、回転翼航空機（マルチローター）で資格を取得し、他の限定解除は行っておりません。</p><h1 id="2-無人航空機操縦士のメリットと有用性"><a href="#2-無人航空機操縦士のメリットと有用性" class="headerlink" title="2. 無人航空機操縦士のメリットと有用性"></a>2. 無人航空機操縦士のメリットと有用性</h1><p>この資格は以下のメリットがあります。</p><ol><li>認証済みの機体と合わせて申請することで、（ルールの範囲内で）自由に飛ばすことができる。</li><li>国土交通省への飛行許可申請の際に、一部手続きを省略できる。</li><li>建設業等で入札条件に含まれている。</li></ol><p>著者も飛行許可申請を出していますが、実際に手続きを一部省略して申請しています。</p><p>しかしドローンを取り巻く環境は、まだ成長途中です。国家資格を利用して、（ルールの範囲内で）自由に飛ばすことができるようになるには、以下の２つをクリアすることが必要です。</p><ul><li>操縦者技能証明（無人航空機操縦士の資格）</li><li>型式認証済みの機体 or 機体認証済みの機体</li></ul><p>現在、個人で買えるような価格帯で、型式認証をクリアしている機体が少なく、この資格が効力を発揮できない状況となっております。</p><p>今後、メーカーが基準を満たす機体を幅広く製造してくれることを願っています。</p><p>※なお、上記認証済みでない機体でも、国土交通省への飛行許可申請を実施すれば、（ルールの範囲内で）ドローン自体は飛ばせます。</p><p>著者がドローンに興味を持った経緯として、物流を担うシステムを担当したことがきっかけとなっています。物流業界は2024年問題をはじめ、あらゆる課題がある業界です。そして、ドローンはその解決策の一つであると同時に、複雑な法制度や制約に縛られているということを知り、自分で勉強してその壁を超えたいと思うようになりました。ちょうど国家資格が始まったこともあり、国家資格を取りながら体系的に学びたいと思い、今回チャレンジすることにしました。</p><h1 id="3-資格取得までの道のり"><a href="#3-資格取得までの道のり" class="headerlink" title="3. 資格取得までの道のり"></a>3. 資格取得までの道のり</h1><p>資格取得までの道のりは、以下の通りです。全体で2か月程かかりました。</p><img src="/images/20240109a/資格取得フロー.png" alt="資格取得フロー.png" width="570" height="523" loading="lazy"><p>こちらの順で詳細を紹介させて頂きます。</p><ol><li>ドローンスクールに入会</li><li>学科試験の講習→受験</li><li>実地試験の講習→受験</li><li>身体検査</li><li>証明書交付</li></ol><h3 id="1-ドローンスクールに入会"><a href="#1-ドローンスクールに入会" class="headerlink" title="1.ドローンスクールに入会"></a>1.ドローンスクールに入会</h3><p>まずは、無人航空機操縦士試験に対応しているドローンスクールを選びました。</p><p>著者は、株式会社モビリティテクノのドローンマスターズスクール(通称DMS)を選びました。</p><p>公式サイト：<a href="https://drone-school.mobility-techno.jp/">https://drone-school.mobility-techno.jp</a></p><p>選んだ理由は、「都内にある」「価格が安い」「練習場が利用できる」という理由でした。当時の基準で選んでいるため、選ぶ際は最新の情報で確認をお願いします。2023年12月22日時点では、二等資格の初学者コースは25万円(税込)に設定されておりました。</p><h3 id="2-学科試験の講習→受験"><a href="#2-学科試験の講習→受験" class="headerlink" title="2.学科試験の講習→受験"></a>2.学科試験の講習→受験</h3><p>スクールに入校後は、e-learningで学科試験の勉強が始まります。</p><p>全体で約8時間＋確認テストの内容になっています。</p><ol><li>はじめに</li><li>無人航空機操縦者の心得</li><li>無人航空機に関する規則</li><li>無人航空機のシステム</li><li>無人航空機の操縦者及び運航体制</li><li>運行上のリスク管理</li></ol><p>受験はテストセンターで受験しました。</p><p>無事、一発合格できました。</p><h3 id="3-実地試験の講習→受験"><a href="#3-実地試験の講習→受験" class="headerlink" title="3.実地試験の講習→受験"></a>3.実地試験の講習→受験</h3><p>実地試験は以下のようなスケジュールです。</p><div class="scroll"><table><thead><tr><th align="center">日数</th><th align="center">時間</th><th align="center">内容</th></tr></thead><tbody><tr><td align="center">1日目</td><td align="center">10:00～16:30</td><td align="center">机上試験対策＋実技対策</td></tr><tr><td align="center">2日目</td><td align="center">10:00～16:30</td><td align="center">机上試験対策＋実技対策</td></tr><tr><td align="center">3日目</td><td align="center">約1時間</td><td align="center">実地試験</td></tr></tbody></table></div><p>1,2日目は東京足立校で実施し、3日目の試験は埼玉浦和校で実施しました。</p><p>実施講習の中で、操縦時間が目一杯あるわけではなく、技能に不安を感じていたので、モバイルアプリで300円ほど課金して、練習もしました。</p><p>実地試験では、満点合格で試験管の人に技能を褒めて頂けました。</p><p>試験会場の様子はこちらです。</p><h3 id="4-身体検査"><a href="#4-身体検査" class="headerlink" title="4.身体検査"></a>4.身体検査</h3><p>著者は、普通自動車運転免許を持っていたため、システム上の手続きで完了しました。</p><p>検査内容は、以下のように定められています。</p><p><a href="https://ua-remote-pilot-exam.com/">https://ua-remote-pilot-exam.com/</a></p><blockquote><p>身体検査は、①有効な公的証明書の提出、②-1医療機関の診断書の提出（一等25㎏未満限定及び二等）、②-2医療機関の診断書の提出（一等25kg以上）、③指定試験機関の身体検査受検（一等25㎏未満限定及び二等）のいずれかの方法で受検ができます。</p></blockquote><div class="scroll"><table><thead><tr><th align="center">項目</th><th align="left">身体検査基準</th></tr></thead><tbody><tr><td align="center">視力</td><td align="left">視力が両眼で0.7以上、かつ、一眼でそれぞれ0.3以上であること、または一眼の視力が0.3に満たない者若しくは一眼が見えない者については、他眼の視野が左右150度以上で、視力が0.7以上であること。</td></tr><tr><td align="center">色覚</td><td align="left">赤色、青色及び黄色の識別ができること。</td></tr><tr><td align="center">聴力</td><td align="left">後方2メートルの距離から発せられた通常の強さの会話の音声が正しく聞き取れること。</td></tr><tr><td align="center">一般</td><td align="left">1．施行規則第236条の62第4項第1号または第2号にあげる身体の障害が無いこと。<br>2．1．に定めるもののほか、無人航空機の安全な飛行に必要な認知または操作のいずれかに係る能力を欠くこととなる四股又は体幹の障害があるが、法第132条の44の規定による条件を付すことにより、無人航空機の安全な飛行に支障を及ぼす恐れがないと認められること。</td></tr></tbody></table></div><h3 id="5-技能証明書交付"><a href="#5-技能証明書交付" class="headerlink" title="5.技能証明書交付"></a>5.技能証明書交付</h3><p>ここまでで、技能証明書交付までの要件が完了したため、システム上で発行手続きを行い、2週間ほどで手元に証明書が届きました。</p><h1 id="4-ドローンを飛ばしてみて"><a href="#4-ドローンを飛ばしてみて" class="headerlink" title="4. ドローンを飛ばしてみて"></a>4. ドローンを飛ばしてみて</h1><p>ドローンの飛行には、国土交通省への飛行許可申請や、関係各所への許可取り等も行う必要があります。警察署に連絡したり、土木管理事務所に使用許可申請を提出したりすることもあります。</p><p>また、著者は新たにドローンを購入したため、機体登録、リモートID（車のナンバーのようなもの）の登録など、様々な手続きを行っています。</p><p>それらを完了させて、実際に撮影した写真はこちらになります。（実際は映像ですがここでは静止画で紹介となります。）</p><img src="/images/20240109a/image.png" alt="image.png" width="889" height="504" loading="lazy"><img src="/images/20240109a/image_2.png" alt="image.png" width="1200" height="554" loading="lazy"><h1 id="5-まとめ"><a href="#5-まとめ" class="headerlink" title="5.まとめ"></a>5.まとめ</h1><p>ドローンを飛ばすのはとても楽しく、やってみたら多くの人がはまると思います。しかし、危険性も高く、法律も複雑です。何も理解しないまま飛行させると、知らぬ間に違法な飛行として、警察のお世話になる可能性や、重大な事故に発展する可能性もあります。</p><p>そのため、しっかり勉強したうえで取り組む必要があると思います。また、ドローンを飛ばしているだけではなかなか価値が生まれませんが、武器の一つになると思っています。これからも、楽しみながら、よりよいドローンの活用を考え実践していきたいと思います。</p>]]></content:encoded>
      
      
      <category domain="https://future-architect.github.io/categories/IoT/">IoT</category>
      
      
      <category domain="https://future-architect.github.io/tags/%E5%90%88%E6%A0%BC%E8%A8%98/">合格記</category>
      
      <category domain="https://future-architect.github.io/tags/%E3%83%89%E3%83%AD%E3%83%BC%E3%83%B3/">ドローン</category>
      
      <category domain="https://future-architect.github.io/tags/%E7%84%A1%E4%BA%BA%E8%88%AA%E7%A9%BA%E6%A9%9F%E6%93%8D%E7%B8%A6%E5%A3%AB/">無人航空機操縦士</category>
      
      
      <comments>https://future-architect.github.io/articles/20240109a/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>Entra IDを使うウェブサービスのバックエンドのテスト</title>
      <link>https://future-architect.github.io/articles/20231227a/</link>
      <guid>https://future-architect.github.io/articles/20231227a/</guid>
      <pubDate>Tue, 26 Dec 2023 15:00:00 GMT</pubDate>
      
        
        
          
          
      <description>&lt;p&gt;Entra ID（旧名Azure</description>
          
        
      
      
      
      <content:encoded><![CDATA[<p>Entra ID（旧名Azure AD）は企業での利用の割合が高く、社内システムを作る場合はこれを使って認証して欲しいという要件が積まれることがほとんどでしょう。とはいえ、現物を使ってテストを作るのは都合がよくないこともあったりします。例えば処理時間が延びる（大量のE2Eテストを走らせる場合）とか、たくさんのユーザーのバリエーションを作る場合にそれだけユーザーを登録しないといけないとか、多要素認証の認証をどうするかとか。そんな感じのウェブサービスの単体テストを簡略化する方法について検討して組み込んだので紹介します。</p><h1 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h1><p>Entra IDを組み込む方法については以前のエントリーで紹介しています。</p><ul><li><a href="https://future-architect.github.io/articles/20221118a/">MSAL.jsを使ってウェブフロントエンドだけでAzureAD認証する</a></li><li><a href="https://future-architect.github.io/articles/20221122a/">AzureAD＋MSAL for Goでバッチコマンドの認証</a></li></ul><p>後者は他の認証基盤でもだいたい同じですが、前者は、MSAL.jsのおかげでフロントエンドのみで認証が完了するということを紹介しました。多くの場合はサーバーにもコールバックがきたりとか、サーバーもログイン処理の一部に入っているのですが、そこが不要となっています。そのため、バックエンドとしては有効なJWTがリクエストについてきて、その署名の検証だけすればOKという状態となっています。</p><p>問題はその署名入りのJWTトークンをどうつくるか、という一点に絞られます。</p><p>ちなみに、JWTのTがトークンでJWTトークンと書くと「JSONウェブトークン・トークン」となってしまうのですが、毎回JWTをロングで書くのも面倒ですし、JWTだけだと不親切かと思いますJWTトークンにしています。江戸川や利根川を英語に翻訳するときに「エドガワーリバー」とか「トネガワリバー」とかになるのと同じようなものだと思っていただければ。</p><h1 id="自前で署名とJWTトークンを作る"><a href="#自前で署名とJWTトークンを作る" class="headerlink" title="自前で署名とJWTトークンを作る"></a>自前で署名とJWTトークンを作る</h1><p>Entra IDの場合、 <code>https://login.microsoftonline.com/&#123;テナントID&#125;/v2.0/.well-known/openid-configuration</code> にアクセスし、その中の <code>jwks_uri</code>というキーを見ると、署名検証のためのJWKの公開鍵が手に入ります。おそらくは<code>https://login.microsoftonline.com/&#123;テナントID&#125;/discovery/v2.0/keys</code>というURLのはずですが。ですが、この公開鍵はEntra IDが内部で保持している秘密鍵を使った署名の検証にしか使えないため、テスト用のJWTトークンを作る場合はこの鍵は使えません。そのため、まずはローカルの公開鍵と暗号鍵のペアを作ります。以下のサイトを使うのが簡単でしょう。</p><ul><li><a href="https://mkjwk.org/">https://mkjwk.org/</a></li></ul><p>RSAタブを開き以下のように入れるとEntra IDっぽくなります。KeyIDは任意です。</p><ul><li>Key Size(鍵のビット数): 2048</li><li>Key Use(鍵の用途): Signature</li><li>Algorithm(アルゴリズム): RS256</li><li>Key ID(鍵の識別子): “for test”</li><li>Show X.509(): No</li></ul><p>生成されたら、一番左と一番右をそれぞれJWTトークン作成用に保存しておきます。真ん中はサーバーで利用するのに便利な情報なのでこれも保存しておきます。</p><img src="/images/20231227a/image.png" alt="image.png" width="1200" height="986" loading="lazy"><h1 id="JWTトークンを作成"><a href="#JWTトークンを作成" class="headerlink" title="JWTトークンを作成"></a>JWTトークンを作成</h1><p>次にJWTを作ります。テナントIDとアプリケーションIDはテスト環境のEntraIDで生成したものと同じものを使う、あるいは独自に作るでもどちらでもよいですが決めておきます。UUIDの型式です。このサンプルではテナントIDを0000000-0000-0000-0000-000000000000、アプリケーションIDを1111111-1111-1111-1111-111111111111とします。</p><p>Entra ID相当のトークンを作りたいので、こんな感じのclaimを用意します。重要な項目は以下の通りです。</p><ul><li>tid: テナントIDとする</li><li>aud: クライアントID＝アプリケーションID</li><li>iss: <a href="https://login.microsoftonline.com/(%E3%83%86%E3%83%8A%E3%83%B3%E3%83%88ID)/v2.0">https://login.microsoftonline.com/(テナントID)/v2.0</a></li><li>exp: 有効日時(2035年にしてある)</li><li>iat&#x2F;nbf: ログイン日時</li><li>exp: 有効期限</li><li>sub: ユーザーのキー</li></ul><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;aud&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1111111-1111-1111-1111-111111111111&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;iss&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://login.microsoftonline.com/0000000-0000-0000-0000-000000000000/v2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;iat&quot;</span><span class="punctuation">:</span> <span class="number">1671015703</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;nbf&quot;</span><span class="punctuation">:</span> <span class="number">1671015703</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;exp&quot;</span><span class="punctuation">:</span> <span class="number">2071019603</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;idp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://sts.windows.net/3eca0868-d511-4342-8659-e88a2e3bf9fe/&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Test User(テストユーザー)&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;nonce&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ce3fd167-0e5a-43ae-bb8b-11d8d003d8c6&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;oid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;daf6a6c6-d549-4421-bf71-3b59fd74d531&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;preferred_username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test.user@example.co.jp&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;rh&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.AWoA733wxZg0tkymktoZGQzOJ_1Ryon2gERMsUs1n-XnFcpqAFQ.&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;sub&quot;</span><span class="punctuation">:</span> <span class="string">&quot;oXxd31705vfpTnrSPcdVCdAoalq7ZgQ_gx7Msq7OBzY&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;tid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0000000-0000-0000-0000-000000000000&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;uti&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Fw7ZoF0z1UCipEF8hfwZAA&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;ver&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>subはユーザーを表すユニークなキーとされていますが、Entra ID上のこのsubと、実際のシステム上のユーザーの対応付けは別途決めておく必要があります。Entra IDとHRのシステムの同期をきちんととっておくのであればこのsubを使ってユーザーを決められますが、そうでない場合はマニフェストを変更してユーザーコード相当の情報を登録したり、preferred_usernameを使うといったことが必要になります。そのあたりはサーバー側の方針に合わせて上記のclaimは修正してください。</p><p>次にjwt.ioを開きます。</p><p><a href="https://jwt.io/">https://jwt.io/</a></p><p>アルゴリズムをRS256に変更し、PAYLOADに上記のclaimを、その下の署名欄の上の公開鍵にはmkjwk.orgで作った公開鍵を、その下の秘密鍵にはmkjwk.orgで作った秘密鍵を貼り付けます。</p><p>これで左側にJWTが生成されます。</p><img src="/images/20231227a/image_2.png" alt="image.png" width="1200" height="1334" loading="lazy"><p>これはmkjws.orgで作成したjwks.orgの証明書を使って署名の確認が行えます。サーバー側でJWTトークンの検証を行うときは、Entra IDの秘密鍵ではなく、mkjwk.orgで生成した秘密鍵（真ん中のPublic and Private Keypair Setが同じ形式なので扱いやすい）を使って署名の検証が行えます。任意のユーザー情報を作ってトークンを量産できますし、実際のログインは不要なのでテストでも扱いやすいでしょう。このトークンを使えばcurlでもなんでも自由にリクエストが飛ばせるようになります。</p>]]></content:encoded>
      
      
      <category domain="https://future-architect.github.io/categories/%E8%AA%8D%E8%A8%BC%E8%AA%8D%E5%8F%AF/">認証認可</category>
      
      
      <category domain="https://future-architect.github.io/tags/%E3%83%86%E3%82%B9%E3%83%88/">テスト</category>
      
      <category domain="https://future-architect.github.io/tags/AzureAD/">AzureAD</category>
      
      <category domain="https://future-architect.github.io/tags/EntraID/">EntraID</category>
      
      <category domain="https://future-architect.github.io/tags/JWT/">JWT</category>
      
      
      <comments>https://future-architect.github.io/articles/20231227a/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>【合格体験記】Google Cloudの入門試験：Cloud Digital Leader</title>
      <link>https://future-architect.github.io/articles/20231226a/</link>
      <guid>https://future-architect.github.io/articles/20231226a/</guid>
      <pubDate>Mon, 25 Dec 2023 15:00:00 GMT</pubDate>
      
        
        
          
          
      <description>&lt;img src=&quot;/images/20231226a/IMG_6276.JPG&quot; alt=&quot;IMG_6276.JPG&quot; width=&quot;509&quot; height=&quot;509&quot;</description>
          
        
      
      
      
      <content:encoded><![CDATA[<img src="/images/20231226a/IMG_6276.JPG" alt="IMG_6276.JPG" width="509" height="509" loading="lazy"><p>こんにちは。<br>公共サービス事業部の村上一彦です。</p><p>先日、Google Cloudの認定資格である「Cloud Digital Leader認定資格」を受験し、取得できました。</p><p>Cloud Digital Leader認定資格の合格に至った学習過程について書いていきます。</p><h1 id="筆者のバックグラウンドについて"><a href="#筆者のバックグラウンドについて" class="headerlink" title="筆者のバックグラウンドについて"></a>筆者のバックグラウンドについて</h1><p>大学は経営学部で、会計を中心に学んでおりました。その為、ITスキルはほぼゼロに等しい状況でした。</p><p>新卒から約3年ほど金融系システム(Java)の業務に従事、1年ほどAWSに触れる機会がありました。しかし、アプリ主体のチームに所属しており、インフラは別チームでしたので、機能を少し知っている程度です。その後、2020年にフューチャーに転職しましたが、クラウドに関わる経験はなく、クラウドに関する経験はほぼゼロの状況です。</p><p>他の資格としては、応用情報技術者試験を取得していますが、今回の試験にはほぼアドバンテージはないと思います。</p><h1 id="試験と出題範囲について"><a href="#試験と出題範囲について" class="headerlink" title="試験と出題範囲について"></a>試験と出題範囲について</h1><p>Cloud Digital Leaderの試験は、Google Cloudの認定資格の中でも一番基礎的な試験として位置づけられています。<br>※ここから公式サイトの抜粋を引用しています。<br><a href="https://cloud.google.com/learn/certification/cloud-digital-leader?hl=ja">https://cloud.google.com/learn/certification/cloud-digital-leader?hl=ja</a></p><h3 id="推奨される経験"><a href="#推奨される経験" class="headerlink" title="推奨される経験"></a>推奨される経験</h3><blockquote><p>技術専門家と連携した経験<br>技術的な前提条件はありません</p></blockquote><p>自身が技術専門家として従事した業務経験を前提としていない為、私のようにインフラやクラウドが未経験の人でも目指せる資格ということがわかります。</p><h3 id="試験の形式"><a href="#試験の形式" class="headerlink" title="試験の形式"></a>試験の形式</h3><blockquote><p>試験時間: 90 分<br>登録料: $99<br>言語: 英語、日本語</p></blockquote><h3 id="出題範囲"><a href="#出題範囲" class="headerlink" title="出題範囲"></a>出題範囲</h3><div class="scroll"><table><thead><tr><th align="left">内容</th><th align="center">配点</th></tr></thead><tbody><tr><td align="left">Google Cloud によるデジタル トランスフォーメーション</td><td align="center">10%</td></tr><tr><td align="left">データと Google Cloud によるイノベーション</td><td align="center">30%</td></tr><tr><td align="left">インフラストラクチャとアプリケーションのモダナイゼーション</td><td align="center">30%</td></tr><tr><td align="left">Google Cloud のセキュリティとオペレーション</td><td align="center">30%</td></tr></tbody></table></div><p>ざっくり言うと、Google Cloudで提供している各機能の内容と、導入するメリットなどがメインの内容です。</p><h1 id="学習過程"><a href="#学習過程" class="headerlink" title="学習過程"></a>学習過程</h1><h2 id="1-「図解即戦力-Google-Cloudのしくみと技術がこれ1冊でしっかりわかる教科書」の読了"><a href="#1-「図解即戦力-Google-Cloudのしくみと技術がこれ1冊でしっかりわかる教科書」の読了" class="headerlink" title="1. 「図解即戦力 Google Cloudのしくみと技術がこれ1冊でしっかりわかる教科書」の読了"></a>1. 「図解即戦力 Google Cloudのしくみと技術がこれ1冊でしっかりわかる教科書」の読了</h2><p>私は、Google Cloudについての予備知識が全くなかったため、まず入門書の「図解即戦力 Google Cloudのしくみと技術がこれ1冊でしっかりわかる教科書」を読みました。</p><p>この本については、他の方が詳しく紹介されていますので、ぜひお読みいただければと思います。</p><blockquote><p>フューチャー技術ブログ「Google Cloudのしくみと技術がしっかりわかる教科書を読んだ感想」<br><a href="https://future-architect.github.io/articles/20230302a/">https://future-architect.github.io/articles/20230302a/</a></p></blockquote><p>こちらの本は入門書なので読みやすかったです。試験の対策としては、一部カバーしていない部分はありますが、次で紹介する模擬試験でカバーできるので、問題ありませんでした。</p><p>模擬試験がメインの試験対策になるため、本の内容は熟読せずに流し読みでも問題ないです。私は１周流し読みしました。4時間くらいかかりました。（細かい記載は飛ばしました。）</p><h2 id="2-Udemyの模擬試験の反復"><a href="#2-Udemyの模擬試験の反復" class="headerlink" title="2. Udemyの模擬試験の反復"></a>2. Udemyの模擬試験の反復</h2><p>Udemyにて、こちらの模擬試験を購入し反復しました。</p><blockquote><p>GCP：Google Cloud Digital Leader模擬試験問題集（6回分320問）<br><a href="https://www.udemy.com/course/google-cloud-digital-leader6320/">https://www.udemy.com/course/google-cloud-digital-leader6320/</a></p></blockquote><p>模擬試験は6回分収録されていますが、私は勉強時間が取れず、5回までを2周しました。</p><p>1周目を解いた後、模擬試験の解説をしっかり読み、わからない箇所については、先述の入門書に戻ったりもしました。そのように振り返りをすることで、1周目は40～50点でしたが、2周目では80点以上を取れるようになりました。</p><p>おすすめはできませんが、正直、理解を後回しにして、模擬試験の繰り返し学習で、反射的に問題を解けるようになるだけで、合格点を出せるのではないかと思います。</p><p>見直し時間も含め、20時間くらいかかりました。</p><h3 id="模擬試験のいい点"><a href="#模擬試験のいい点" class="headerlink" title="模擬試験のいい点"></a>模擬試験のいい点</h3><ul><li>本試験の内容をカバーしている。</li><li>本試験と似たような形式で出題される。</li><li>解説が非常によく、間違いの選択肢がなぜ誤りかも書いてあるため、腕試しという意味よりも、インプット学習に使用できる内容でした。</li></ul><h3 id="コツ"><a href="#コツ" class="headerlink" title="コツ"></a>コツ</h3><ul><li>各サービスとキーワードの組み合わせを覚える。</li><li>メインの機能がどのように拡張できるか(できないか)を理解する。</li><li>非推奨サービスは正答にならない。(経験則)</li><li>計算問題は答えを覚える。（理由は後述）</li></ul><h1 id="試験当日"><a href="#試験当日" class="headerlink" title="試験当日"></a>試験当日</h1><p>試験は近くのテストセンターで受験しました。</p><p><strong>ここで問題だったのが、会場内に筆記用具が持ち込めず（貸し出しもNG）、計算問題を暗算でやるしかありませんでした。</strong></p><p>試験時間は30分以上残して終了しましたので、時間配分はそれほど意識しなくても問題ないと思います。</p><h1 id="さいごに"><a href="#さいごに" class="headerlink" title="さいごに"></a>さいごに</h1><p>初めてのGoogle Cloudの認定資格の試験でしたが、業務経験を問わず、丁度いい内容と難易度だと思いました。試験内容が技術に寄りすぎておらず、「Google Cloudにはどんなメリットがあるか」ということを理解することができたので、私のように、インフラエンジニアではない人にも、生かしていける知識だと思いました。</p><p>また、AWSやAzureなど、他のクラウドサービスにもGoogle Cloudにあるような機能がある為、クラウド全般の入門としてもいいと思いました。</p><p>これからクラウドの知識やインフラの知識を身に着けたい人のスタートに良い試験だと思います。ぜひ受験してみてください！</p>]]></content:encoded>
      
      
      <category domain="https://future-architect.github.io/categories/Infrastructure/">Infrastructure</category>
      
      
      <category domain="https://future-architect.github.io/tags/GCP/">GCP</category>
      
      <category domain="https://future-architect.github.io/tags/%E5%90%88%E6%A0%BC%E8%A8%98/">合格記</category>
      
      <category domain="https://future-architect.github.io/tags/CloudDigitalLeader/">CloudDigitalLeader</category>
      
      
      <comments>https://future-architect.github.io/articles/20231226a/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>ドキュメント管理を制する 陳腐化を防ぐための実践事例 Lunch LT に登壇しました</title>
      <link>https://future-architect.github.io/articles/20231215a/</link>
      <guid>https://future-architect.github.io/articles/20231215a/</guid>
      <pubDate>Thu, 14 Dec 2023 15:00:00 GMT</pubDate>
      
        
        
          
          
      <description>&lt;img src=&quot;/images/20231215a/21e04bb5f66c5949239f7bfa759a38d5.png&quot; alt=&quot;21e04bb5f66c5949239f7bfa759a38d5.png&quot; width=&quot;560&quot; height=&quot;238&quot;</description>
          
        
      
      
      
      <content:encoded><![CDATA[<img src="/images/20231215a/21e04bb5f66c5949239f7bfa759a38d5.png" alt="21e04bb5f66c5949239f7bfa759a38d5.png" width="560" height="238" loading="lazy"><p>2023&#x2F;12&#x2F;6、Findyさん主催の<a href="https://findy.connpass.com/event/302508/">ドキュメント管理を制する 陳腐化を防ぐための実践事例 Lunch LT</a>に「設計ドキュメント腐る問題、Git管理で運用してみた本当のところ」というタイトルで登壇しました。</p><ul><li><a href="https://togetter.com/li/2271272">togetter</a></li><li><a href="https://findy.connpass.com/event/302508/presentation/">スライドまとめ</a></li></ul><h2 id="ドキュメント管理を制する-陳腐化を防ぐための実践事例-Lunch-LT-会とは"><a href="#ドキュメント管理を制する-陳腐化を防ぐための実践事例-Lunch-LT-会とは" class="headerlink" title="ドキュメント管理を制する 陳腐化を防ぐための実践事例 Lunch LT 会とは"></a>ドキュメント管理を制する 陳腐化を防ぐための実践事例 Lunch LT 会とは</h2><p>ドキュメントの管理方法を確立、整備されてこられた方々にお話を伺い、工夫点や考え方、テクニック等を広く共有していただくことで、明日から使える技術やノウハウを共有することを目的にした勉強会です。</p><p>Lunch LTということで、お昼時に4名で10分枠、質疑応答で15分ごとに交代でした。私の家族構成的に夕方以降の勉強会参加が厳しいので、ランチLTだと視聴だけではなく登壇もできるということで、控えめに言って画期的だなと思いました。</p><h2 id="登壇"><a href="#登壇" class="headerlink" title="登壇"></a>登壇</h2><p>トップバッターで「設計ドキュメント腐る問題、Git管理で運用してみた本当のところ」というタイトルで登壇しました。登壇のきっかけが、<a href="https://future-architect.github.io/articles/20231101a/">設計ドキュメント腐る問題、Git管理で運用してみた結果</a>という記事を見たFindyさんが声をかけてくれたことですので、記事を見ていない人向けに、記事のエッセンスや書きそびれてことを話しました。</p><iframe src="https://docs.google.com/presentation/d/e/2PACX-1vQIkC7si1x4mB4uWMtGYXQaR3oL951AEUp8B2CKoeB-yJGX1fssMgdXQlMq5dJ70eOCaTfFhH1TBIcp/embed?start=false&loop=false&delayms=3000" frameborder="0" width="100%" height="569" allowfullscreen="true" mozallowfullscreen="true" webkitallowfullscreen="true"></iframe><p>このスライドも微妙にふわっとした内容で人によって捉え方も様々であり、ツッコミしやすいためか、SNSなどでたくさんコメントを頂いています。糧としたいと思います。</p><p>久々の勉強会の登壇で楽しかったです。他の登壇者の方の考えも聞けてよかったです。重複する部分もあれば、先に進んでいる施策を取っているところもあり、私の勉強になりました。</p><h2 id="質疑応答や反応"><a href="#質疑応答や反応" class="headerlink" title="質疑応答や反応"></a>質疑応答や反応</h2><p>勉強会で頂いた質問についてです。</p><ol><li>最初にドキュメントをGit管理へ移す際に、苦労された点はありますか？<ul><li>(回答) スライドやスプレッドシートをファイルサーバ（Google Drive)に保存する方式でしたので、それらへの記載内容をテキストベースで記載できるか、実現性を示すことが大変でした。特に、表形式の情報はどう頑張ってもExcelに記載するほうが楽なので、Markdownでも書けるとか、Diffで差分が管理できるなどをチームに説明した記憶があります</li></ul></li></ol><p>当日にもう1点、質問に答えたのですが、内容を忘れちゃいました。</p><p>Web上で上手く探せなかったのですが、発表を聞いてくれた人のコメントで、「ドキュメントを後で揃えるのは、テストコードを後から書こうとするのに似ている」というのがあって、「確かに！」と思いました。最初にどういった構成、粒度、レベル感で記載するかを定義し、リファレンス実装（ドキュメント）を用意することが重要な点も似ていますね。</p><h2 id="設計ドキュメント、主題はアーキテクチャ方針をどこで管理するか話だったかもしれない"><a href="#設計ドキュメント、主題はアーキテクチャ方針をどこで管理するか話だったかもしれない" class="headerlink" title="設計ドキュメント、主題はアーキテクチャ方針をどこで管理するか話だったかもしれない"></a>設計ドキュメント、主題はアーキテクチャ方針をどこで管理するか話だったかもしれない</h2><p>設計ドキュメントの管理ですが、「コードと設計ドキュメントを同時に更新する開発ルールにすればおしまいだよね、それで話が終わりじゃない？」みたいなリアクションがあり、一定その通りだと思います。おそらくプログラム設計書とか、アーキテクチャ図、システム間連携I&#x2F;F仕様書、DBのテーブル設計書あたりは機械的にそのルールで行ける気がします。静的解析やコード自動生成でCI的なワークフローにも組み込みしやすそうです。</p><p>逆に、システムの構成が変わるようなものの、検討経緯はそのパターンで扱いきれないときがあります。アーキテクチャ方針とかそういったものです。</p><p>いくつか例をあげます。</p><ul><li>ある処理は非同期に切り出そう<ul><li>あるファイルアップロードはいったんS3に格納して受付OKをクライアントに戻し、取り込み要求をキューイングして、非同期で処理する。なぜそうしたか？同期で全て取り込むAPIもあり、2種類あるのはなぜで、使い分けはどう考えるべきのか</li></ul></li><li>出荷指示、在庫引当などモノが動く以上、トランザクション観点で同期で処理すべきだが、非同期になっている。なぜか。もし、実在庫とシステムでズレが出た時のデータ不整合はどう救済するのか</li><li>DBのテーブルが命名体系があり多段になっている。データレイク層・正規化層・データマート層といったレイヤー分けがある。なぜそうなったのか。どういう使い分けか？</li></ul><p>最初に全てアーキテクチャ的な方針が決まっていれば良いですが、設計開発～保守運用など様々な場面で、方針を進化させる時期が出てきます。それらをコード（というより暗黙的なチームの合意事項）と同期を取るために、開発ルールを決めれば、ちゃんと書いてくれるでしょうか？ もし開発ルールを決めて自発的・自律的にアーキテクチャレベルのドキュメントを同期とってくれるチームであればかなりハッピーだと思います。良いチームですね。そういったチーム文化を作るためには通常は工夫が必要です。最初にPull requestで設計レビューを挟む（やりすぎると重厚ですが、チームメンバーの規模・スキルセットによっては厳密化する）方式でレールに乗せるまではレビューで担保するとか、色々です。</p><p>勉強会では、それらアーキテクチャデザインレコード的な内容は、イミュータブルドキュメントモデルとして切り出して管理したり、あるいはドキュメントサイトをVitePress（Vue.jsを利用した静的サイトジェネレータ）で構築したり記載する障壁を下げる工夫をしたり、各社の知見が大集合で話されていました。</p><p>勉強会名は今思うと、「アーキテクチャ方針を陳腐化させないための実践事例 Lunch LT」というのにすれば、ブレが少なかったかもなと感じます。</p><h2 id="設計ドキュメントはブログ運営に似ている"><a href="#設計ドキュメントはブログ運営に似ている" class="headerlink" title="設計ドキュメントはブログ運営に似ている"></a>設計ドキュメントはブログ運営に似ている</h2><p>アーキテクチャ方針など、決定事項の経緯や議論内容を上手く記載するにはそれなりの訓練が必要です。ブログをよく書くメンバーは筆が軽く、そうじゃないメンバーは腰が重いことがあると、発表でも伝えました。</p><p>個人的にサイト化すると、TOCを自動生成の他にも、そのページのPVや、記事に対するコメント、いいねなどのリアクションを遅れるようになると感じました。また、その記事に対する、被リンク記事を収集したり、関連性の高い記事をサジェストするなどです。人気の記事ランキング、みたいなのを出しても良いかも知れません。良い記事に多くコントリビュートした人を礼賛する、ドキュメントライター賞みたいなのを作っても良いかも知れませんね。</p><p>ドキュメントの質を上げるため、メンバーのモチベーションを上げる取り組みがあに越したことはないでしょう。この面はブログ運営のナレッジが役立つと思います。また、こうした設計ドキュメントを書く文化を整えれば、メンバーが自社の技術ブログを執筆する際の心理的障壁も取り除け、スキルセットもシームレスになります。</p><p>社内ドキュメントを書いていけば、技術ブログ執筆スキルが上がるし、逆もまたしかり。相互に影響しながら進化させれるなと気づけたので、勉強会に参加して良かったです。</p><h2 id="最後に"><a href="#最後に" class="headerlink" title="最後に"></a>最後に</h2><p>Findyさんの抜群の集客力で400名以上の方が参加申し込みしてくれ、またLunch LTという私にとって登壇しやすい時間帯・形式で勉強会に参加でき、とても嬉しかったです。</p><p>また、今後はドキュメント周りについてはプログラム設計の話をしているのか、アーキテクチャ設計の話をしているかで取り扱いノウハウが異なりそうなので、解像度を上げていきます。</p>]]></content:encoded>
      
      
      <category domain="https://future-architect.github.io/categories/Programming/">Programming</category>
      
      
      <category domain="https://future-architect.github.io/tags/%E7%99%BB%E5%A3%87%E3%83%AC%E3%83%9D%E3%83%BC%E3%83%88/">登壇レポート</category>
      
      <category domain="https://future-architect.github.io/tags/%E3%83%89%E3%82%AD%E3%83%A5%E3%83%A1%E3%83%B3%E3%83%88/">ドキュメント</category>
      
      <category domain="https://future-architect.github.io/tags/%E9%96%8B%E7%99%BA%E6%89%8B%E6%B3%95/">開発手法</category>
      
      
      <comments>https://future-architect.github.io/articles/20231215a/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>React Server ComponentでもContextで状態を共有する</title>
      <link>https://future-architect.github.io/articles/20231214a/</link>
      <guid>https://future-architect.github.io/articles/20231214a/</guid>
      <pubDate>Wed, 13 Dec 2023 15:00:00 GMT</pubDate>
      
        
        
          
          
      <description>&lt;p&gt;Next.jsの最近の大きな目玉機能はReact Server Component(以下サーバーコンポーネント)です。パフォーマンスアップに有効だったり、gRPCだRESTだGraphQLだ論争を終わりにするServer</description>
          
        
      
      
      
      <content:encoded><![CDATA[<p>Next.jsの最近の大きな目玉機能はReact Server Component(以下サーバーコンポーネント)です。パフォーマンスアップに有効だったり、gRPCだRESTだGraphQLだ論争を終わりにするServer Actionsなど盛りだくさんです。</p><p>一方で、サーバーコンポーネントはコーディング上の制約がいろいろあります。</p><ul><li>サーバーコンポーネントではhooksが使えない</li><li>サーバーコンポーネントのソースからクライアントコンポーネントは<code>import</code>できるが逆はできない。レンダーツリーを工夫すればクライアントコンポーネントの下にサーバーコンポーネントを配置することは可能</li></ul><p>サーバーコンポーネントでは非同期コンポーネントを作成でき、<code>fetch</code>でサーバーから情報をとってきたり、DBアクセスした結果を利用できます。しかし、最近のモダンReactの場合、状態管理などはすべてhooksに寄せるので大きくコードの変更が必要になってしまいます。せっかくとってきたデータを全部propsでバケツリレーしなければならないとなると不便です。利用が必要な個所で個別にフェッチするという実装もありです。Next.jsはキャッシュして呼び出しを減らしてくれますが以下のようなケースではカバーしきれません</p><ul><li><code>fetch()</code>以外の、たとえばDB接続での取得では重複リクエストになる</li><li>利用したい箇所がクライアントコンポーネントの場合、最寄りのサーバーコンポーネントからバケツリレーが必要</li></ul><p>コード量も増え、速度も遅くなったらうれしくないですよね。</p><p>しかし、後者の制約の脱出ハッチを使えばContextを利用してサーバーから取得した値を子供のコンポーネントに流してやれるのではないか、と思ったので試してみました。これが利用できればサーバーから取得する値はコンテキストに入れておいて、バケツリレーを回避できます。サーバーコンポーネントは根っこの方に近いコンポーネントで利用されますが、そこでコンテキストが使えれば既存のコードから大幅な書き換えを減らせるはずです。</p><h1 id="Next-jsアプリケーションの作成"><a href="#Next-jsアプリケーションの作成" class="headerlink" title="Next.jsアプリケーションの作成"></a>Next.jsアプリケーションの作成</h1><p>次のコマンドでさっと作成します。いろいろオプションを聞かれますが、サーバーコンポーネントを使うためにappルーターを選びます。このサンプルはTypeScriptにしているのでTypeScriptも選んでいますが、型を外せばJSでも動くでしょう。</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ npx create-next-app@latest</span><br></pre></td></tr></table></figure><p>さっそくトップページを書き換えていきます。まずダメだった例を紹介します。</p><figure class="highlight ts"><figcaption><span>src/state/index.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">// ダメだった例</span></span><br><span class="line"><span class="keyword">import</span> &#123; createContext, useContext &#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// コンテキストに入れるデータ型</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">User</span> = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="built_in">string</span>;</span><br><span class="line">    <span class="attr">email</span>: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// コンテキストを作成</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">LoginContext</span> = <span class="title function_">createContext</span>(&#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;default&quot;</span>,</span><br><span class="line">    <span class="attr">email</span>: <span class="string">&quot;default@example.com&quot;</span></span><br><span class="line">&#125; <span class="keyword">as</span> <span class="title class_">User</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 値を取得するカスタムフック</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">useUser</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">useContext</span>(<span class="title class_">LoginContext</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight tsx"><figcaption><span>src/app/page.tsx</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">// ダメだった例</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">LoginContext</span> &#125; <span class="keyword">from</span> <span class="string">&quot;../state&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Child</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./child&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Home</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 本当はここでDBアクセスや外部APIアクセスをしてユーザー情報をとってくる</span></span><br><span class="line">  <span class="keyword">const</span> user = &#123;<span class="attr">name</span>: <span class="string">&quot;shibukawa&quot;</span>, <span class="attr">email</span>: <span class="string">&quot;shibukawa@example.com&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">LoginContext.Provider</span> <span class="attr">value</span>=<span class="string">&#123;user&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">main</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Child</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">main</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">LoginContext.Provider</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight tsx"><figcaption><span>src/app/child.tsx</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">// コンテキストから値を取得して表示するクライアントコンポーネント</span></span><br><span class="line"><span class="string">&quot;use client&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; useUser &#125; <span class="keyword">from</span> <span class="string">&quot;@/state&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">Child</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> user = <span class="title function_">useUser</span>()</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(user)</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">dl</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">dt</span>&gt;</span><span class="tag">&lt;<span class="name">label</span> <span class="attr">htmlFor</span>=<span class="string">&quot;name&quot;</span>&gt;</span>name<span class="tag">&lt;/<span class="name">label</span>&gt;</span><span class="tag">&lt;/<span class="name">dt</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">dd</span>&gt;</span><span class="tag">&lt;<span class="name">output</span> <span class="attr">id</span>=<span class="string">&quot;name&quot;</span>&gt;</span>&#123;user.name&#125;<span class="tag">&lt;/<span class="name">output</span>&gt;</span><span class="tag">&lt;/<span class="name">dd</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">dt</span>&gt;</span><span class="tag">&lt;<span class="name">label</span> <span class="attr">htmlFor</span>=<span class="string">&quot;email&quot;</span>&gt;</span>email<span class="tag">&lt;/<span class="name">label</span>&gt;</span><span class="tag">&lt;/<span class="name">dt</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">dd</span>&gt;</span><span class="tag">&lt;<span class="name">output</span> <span class="attr">id</span>=<span class="string">&quot;email&quot;</span>&gt;</span>&#123;user.email&#125;<span class="tag">&lt;/<span class="name">output</span>&gt;</span><span class="tag">&lt;/<span class="name">dd</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">dl</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>どこがダメでしょうか？実行してみると、<code>createContext()</code>の呼出はダメよ、とエラーになっています。このファイルに”use client”を足してもダメです。</p><img src="/images/20231214a/image.png" alt="image.png" width="1159" height="688" loading="lazy"><p>この<code>createContext()</code>を含むコードを全部クライアントコンポーネントに追い出せばOKです。次のステップでこれを直していきます。</p><h1 id="OKなコード"><a href="#OKなコード" class="headerlink" title="OKなコード"></a>OKなコード</h1><p>まず、コンテキストを作成するだけではなく、それをラップした<code>&lt;Provider&gt;</code>クライアントコンポーネントを作成します。</p><figure class="highlight tsx"><figcaption><span>src/state/index.tsx</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;use client&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; createContext, useContext, <span class="title class_">ReactNode</span> &#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// User, LoginContext, useUserは変化なし</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Props</span> = &#123;</span><br><span class="line">    <span class="attr">children</span>: <span class="title class_">ReactNode</span>,</span><br><span class="line">    <span class="attr">user</span>: <span class="title class_">User</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// コンテキストのProviderを呼び出すクライアントコンポーネントを作成する</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">Provider</span>(<span class="params">&#123; children, user &#125;: Props</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">LoginContext.Provider</span> <span class="attr">value</span>=<span class="string">&#123;user&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123;children&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">LoginContext.Provider</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight tsx"><figcaption><span>src/app/page.tsx</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Child</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./child&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Provider</span> &#125; <span class="keyword">from</span> <span class="string">&quot;../state&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Home</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// LoginProviderの代わりに、クライアントコンポーネントのProviderを利用</span></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">Provider</span> <span class="attr">user</span>=<span class="string">&#123;&#123;</span> <span class="attr">name:</span> &quot;<span class="attr">shibukawa</span>&quot;, <span class="attr">email:</span> &quot;<span class="attr">shibukawa</span>@<span class="attr">example.com</span>&quot; &#125;&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">main</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Child</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">main</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">Provider</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>これでうまく表示されます。</p><img src="/images/20231214a/image_2.png" alt="image.png" width="1004" height="469" loading="lazy"><p>レンダリングツリーとしては次のような形になります。Homeコンポーネントで、現在は即値ですがサーバーから取得した情報をProviderコンポーネントに渡し、このコンポーネントがコンテキストに格納します。Childコンポーネントはバケツリレーではなく、コンテキスト経由でユーザー情報を取得します。</p><img src="/images/20231214a/名称未設定ファイル-ページ1.drawio.png" alt="名称未設定ファイル-ページ1.drawio.png" width="339" height="211" loading="lazy"><p>ソースコードのインポートの依存関係は次の通りで、サーバー→クライアントの参照はあるが、クライアント→サーバーの参照はないため、React Server Componentの規約には反していません。</p><img src="/images/20231214a/名称未設定ファイル-ページ2.drawio.png" alt="名称未設定ファイル-ページ2.drawio.png" width="401" height="131" loading="lazy"><p>これでサーバーから取得した値もコンテキスト経由で子供のコンポーネントに参照させてあげられますね。もちろん、間に挟まるサーバーコンポーネントでは<code>useContext</code>は使えないため、サーバーコンポーネントが利用したい値はフェッチで取るか、親からPropsで渡す必要があります。</p><h1 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h1><p>クライアントコンポーネントを経由することでコンテキストが利用できました。Reduxも、Recoilも、Jotaiも、すべて内部ではコンテキストを使って実現しています。コンテキストをクライアントコンポーネントとしてラップすることで使えるということは、これらの状態管理ライブラリもサーバーコンポーネントであろうと今まで通り使えるということです。</p><p>この手法を使えば既存のコードからの変更を小さくできるので、appルーターに移植するときに「とりあえず全部に”use client”をつけて回る、ということをしないでもよくなりますね。</p>]]></content:encoded>
      
      
      <category domain="https://future-architect.github.io/categories/Programming/">Programming</category>
      
      
      <category domain="https://future-architect.github.io/tags/%E3%83%95%E3%83%AD%E3%83%B3%E3%83%88%E3%82%A8%E3%83%B3%E3%83%89/">フロントエンド</category>
      
      <category domain="https://future-architect.github.io/tags/React/">React</category>
      
      <category domain="https://future-architect.github.io/tags/Next-js/">Next.js</category>
      
      <category domain="https://future-architect.github.io/tags/RSC/">RSC</category>
      
      
      <comments>https://future-architect.github.io/articles/20231214a/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>とちぎRuby 200回目をお祝いしてきた</title>
      <link>https://future-architect.github.io/articles/20231213a/</link>
      <guid>https://future-architect.github.io/articles/20231213a/</guid>
      <pubDate>Tue, 12 Dec 2023 15:00:00 GMT</pubDate>
      
        
        
          
          
      <description>&lt;p&gt;とちぎRubyは月に1回の読書会形式で、今月でちょうど200回目とのことで、有給をとって行ってきました。200回ということは16年8ヶ月ほど続いている計算になります。&lt;/p&gt;
&lt;p&gt;僕の前々職は栃木の芳賀工業団地にある本田技術研究所でした。当時から趣味で使う第一言語はPyt</description>
          
        
      
      
      
      <content:encoded><![CDATA[<p>とちぎRubyは月に1回の読書会形式で、今月でちょうど200回目とのことで、有給をとって行ってきました。200回ということは16年8ヶ月ほど続いている計算になります。</p><p>僕の前々職は栃木の芳賀工業団地にある本田技術研究所でした。当時から趣味で使う第一言語はPythonだったのですが、栃木県にはPythonのコミュニティなどはなく、活発なコミュニティといえばとちぎRubyだったので人付き合いを求めてとちぎRubyに片道2時間ぐらいかけて下道で通っていました。最後に参加したのはホンダを辞める直前の2010年12月でちょうど13年前です。2-3年は通っていたと思うのでほぼ最初の年からは参加していたのかな、というところですかね。</p><p>僕が本田労組の職場委員なぞやっていたころの宇都宮市長選挙で争点になっていて、開通したら乗りたい！と思っていたLRTも1区間往復で乗ってきました。かっこいいし快適でした。これで通勤したかったな。</p><img src="/images/20231213a/IMG_3436.JPG" alt="" width="800" height="600" loading="lazy"><p>場所はいつもの西那須野公民館です。名札は作り直されたのか新しいですね。</p><img src="/images/20231213a/IMG_3439.JPG" alt="" width="800" height="600" loading="lazy"><img src="/images/20231213a/IMG_3440.JPG" alt="" width="800" height="600" loading="lazy"><p>残念ながら、本日はスタート時からのメンバーの半数がお休みということで、読書会は中止になって急遽食事会になってしまいましたが、その分じっくりお話ができました。</p><p>200回目ということではありますが、特に特別なことは企画しておらず、いつも通りの読書会の予定だったとのことです。とくにがんばらず、完全に習慣化して「そういえば第一水曜日だから行こう」ぐらい肩肘張らずにやる、また、今読んでいる研鑽Rubyもあと来年1年ぐらいはかかるだろう、みたいに話されていて、あせらずじっくりのんびりというのも良いですね。このあたりがここまで継続している秘訣ですね。思えば、本家Ruby会議に行っても、出張版とかいっていつもの読書会をそのままやるようなコミュニティでした。</p><p>発起人の一人の池澤さん（お休みでしたが）も、僕がいたころにはすでに還暦になられて、それから10年以上たつのですが、こういう刺激を定例化するのは自分が高齢になったあとのことを考えると素敵だな、真似したいなと思いますね。</p><p>トラディショナルでカラメルソースたっぷりの硬いプリンはとちぎRubyを祝うのに最高の料理でした（みんな車なのでお酒は飲めない）。今回はお会いできなかった方々もいたので、また近日中に、拡大版torubyかとちぎRuby会議あたりを狙ってまた来たいですね。</p><img src="/images/20231213a/IMG_3444.JPG" alt="" width="600" height="800" loading="lazy"><p>あとは会食ではリモートワークかオフラインか、というのも話題になりました。オフラインは確かに情報量が多く早いフィードバックで速度が出せるのだろうな、というのを聞いて思ったのですが、オフラインだったとしても、ウォーターフォール式の必ず仕様書などを書いてから会話、というのではその速度は出ないし、ミーティングだらけでなかなか顔を見る時間が少ないとそのオフラインのメリットは完全には出ないんだろうな、というのは思いました。</p><p>オフラインになってもストレスがあまりない、という状況自体、遅いことに慣れてしまっているということなのかな、と。もちろん個人ごとにとかうまくタスク分割がうまくいっているということもあるかもしれませんが。</p>]]></content:encoded>
      
      
      <category domain="https://future-architect.github.io/categories/Programming/">Programming</category>
      
      
      <category domain="https://future-architect.github.io/tags/%E5%8F%82%E5%8A%A0%E3%83%AC%E3%83%9D%E3%83%BC%E3%83%88/">参加レポート</category>
      
      <category domain="https://future-architect.github.io/tags/Ruby/">Ruby</category>
      
      <category domain="https://future-architect.github.io/tags/%E3%81%A8%E3%81%A1%E3%81%8ERuby/">とちぎRuby</category>
      
      
      <comments>https://future-architect.github.io/articles/20231213a/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>Dev Containersの始め方(2) : Python環境</title>
      <link>https://future-architect.github.io/articles/20231212a/</link>
      <guid>https://future-architect.github.io/articles/20231212a/</guid>
      <pubDate>Mon, 11 Dec 2023 15:00:00 GMT</pubDate>
      
        
        
          
          
      <description>&lt;p&gt;&lt;a href=&quot;/articles/20231206a/&quot;&gt;前回のエントリー&lt;/a&gt;では、Dev Containersの動作原理を理解したのでそれにあわせたPython環境を作っていきます。&lt;/p&gt;
&lt;h1 id=&quot;ベースの環境&quot;&gt;&lt;a href=&quot;#ベースの環境&quot;</description>
          
        
      
      
      
      <content:encoded><![CDATA[<p><a href="/articles/20231206a/">前回のエントリー</a>では、Dev Containersの動作原理を理解したのでそれにあわせたPython環境を作っていきます。</p><h1 id="ベースの環境"><a href="#ベースの環境" class="headerlink" title="ベースの環境"></a>ベースの環境</h1><p>まずリポジトリのフォルダを作ります。<code>python-dev</code>とします。</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mkdir</span> python-dev</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> python-dev</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git init</span></span><br></pre></td></tr></table></figure><p>ここをVSCodeで開き、Dev Containersの設定をしていきます。左下のリモートのボタンを押して <strong>Add Dev Container Configuration Files…</strong>　を選択します。</p><p>基本のPython3を選びます。公式を選んでおくのが吉。オプションでPythonバージョンを選びます。Apple Silliconは-busterついているのを選べって言ってますね。半年前にスクリーンショットを撮ったときは3.11までしかありませんでしたが、今は3.12も選べます。</p><img src="/images/20231212a/スクリーンショット_2023-04-17_20.53.40.png" alt="スクリーンショット_2023-04-17_20.53.40.png" width="787" height="226" loading="lazy"><p>Pythonのイメージをインストールすると、有名どころのツールはすでにインストール済みとなっていますこの辺りは特にインストールする必要はありません。</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">ls</span> -1 /usr/local/py-utils/bin</span><br><span class="line">autopep8</span><br><span class="line">bandit</span><br><span class="line">bandit-baseline</span><br><span class="line">bandit-config-generator</span><br><span class="line">black</span><br><span class="line">blackd</span><br><span class="line">dmypy</span><br><span class="line">flake8</span><br><span class="line">mypy</span><br><span class="line">mypyc</span><br><span class="line">pipenv</span><br><span class="line">pipenv-resolver</span><br><span class="line">pipx</span><br><span class="line">py.test</span><br><span class="line">pycodestyle</span><br><span class="line">pydocstyle</span><br><span class="line">pylint</span><br><span class="line">pylint-config</span><br><span class="line">pyreverse</span><br><span class="line">pytest</span><br><span class="line">stubgen</span><br><span class="line">stubtest</span><br><span class="line">symilar</span><br><span class="line">virtualenv</span><br><span class="line">yapf</span><br><span class="line">yapf-diff</span><br></pre></td></tr></table></figure><p><a href="https://docs.astral.sh/ruff/">ruff</a>など、ここにないツールはあとから入れる必要があります。ただし、Dev Containers以外の環境、たとえばWindowsやmacOSネイティブ環境でも検証したりテストしたいのであれば、必要なツールをインストールするようにpyproject.tomlに書いておいて、別途インストールするようにした方が良いでしょう。バージョンを合わせたりもしやすいですし。</p><h1 id="パッケージの管理方法を考える"><a href="#パッケージの管理方法を考える" class="headerlink" title="パッケージの管理方法を考える"></a>パッケージの管理方法を考える</h1><p>Pythonで開発するときの開発環境作りをどうするか、というのは定期的に話題に上がるネタです。Python歴20年の経験からすると、最低限分離はするものの、必要以上の複雑な機構を持ち込まないのがコツだと考えています。特に経験が浅い人ほど、依存が複雑に絡まったツールを使うとトラブルシュートできません。情報が多く、なるべく公式に寄せる方がベストです。過去に2回ほどそういう記事を書きましたが、今でも変わりません。</p><ul><li><a href="https://qiita.com/shibukawa/items/0daab479a2fd2cb8a0e7">pyenvが必要かどうかフローチャート(2016年)</a></li><li><a href="https://future-architect.github.io/articles/20210611a/">サーバーアプリ開発環境(Python／FastAPI)(2021年)</a></li></ul><p>オプションがいくつか考えられます。が、ここではpoetryを使わずに、<code>pip isntall</code>がベストだと考えています。理由は長くなるので後述しますが、これを使うための追加のインストールは不要で、何らかの設定を入れずにVSCodeからも情報が取得できて良いことが多く、　Dev Containersを使わないローカル開発(.venv利用)とも操作が一致するからです。</p><h2 id="pip-install以外の方法を選ばない理由-読み飛ばしOK"><a href="#pip-install以外の方法を選ばない理由-読み飛ばしOK" class="headerlink" title="pip install以外の方法を選ばない理由(読み飛ばしOK)"></a><code>pip install</code>以外の方法を選ばない理由(読み飛ばしOK)</h2><p>標準のpipと、poetryで考えてみます。環境分離が2重にならずに、VSCodeからも設定いらずで参照できて、ワークフォルダを汚さなくて、普段のローカルと互換性のある都合の良い方法はありません。もちろん、VSCode参照をきちんと設定するとか、ワークフォルダのオプトアウトをきちんとするとか、ローカル開発ときちんと別のやり方を使い分けられるのであればどれもOKです。ですが、なるべく手間は減らしたいものです。</p><div class="scroll"><table><thead><tr><th align="left">方式</th><th align="left">環境分離</th><th align="left">VSCode参照</th><th align="left">インストール先</th><th align="left">ローカル互換</th></tr></thead><tbody><tr><td align="left">venv + pip</td><td align="left">2重</td><td align="left">OK</td><td align="left">$WORK&#x2F;.venv</td><td align="left">OK</td></tr><tr><td align="left">venv + poetry (デフォルト)</td><td align="left">2重</td><td align="left">NG</td><td align="left">$HOME&#x2F;.local&#x2F;share&#x2F;pypoetry</td><td align="left">OK</td></tr><tr><td align="left">venv + poetry (in-project true)</td><td align="left">2重</td><td align="left">OK</td><td align="left">$WORK&#x2F;.venv</td><td align="left">OK</td></tr><tr><td align="left">pip + <code>--user</code></td><td align="left">1重</td><td align="left">OK</td><td align="left">$HOME&#x2F;.local&#x2F;lib</td><td align="left">NG</td></tr><tr><td align="left">pip</td><td align="left">1重</td><td align="left">OK</td><td align="left">&#x2F;usr&#x2F;local&#x2F;lib (権限がない場合<code>--user</code>にフォールバック)</td><td align="left">NG(ローカルが.venvならOK）</td></tr><tr><td align="left">poetry (virtualenvs.create &#x3D; false)</td><td align="left">1重</td><td align="left">OK</td><td align="left">&#x2F;usr&#x2F;local&#x2F;lib</td><td align="left">NG</td></tr></tbody></table></div><ul><li>venvを利用するとDev Containersですでに環境分離がされているのに、2重に分離することになってしまいます。</li><li>VSCode参照NGというのはVSCodeの設定を修正しないとインストールしたパッケージが見えないということを意味しています。</li><li>インストール先は&#x2F;usr&#x2F;local&#x2F;libだとsudoが必要です。また、ワーク以下へのインストールだとホスト側のファイルシステムとのボリューム同期をしないような設定を<code>devcontainer.json</code>に入れないと、余計なファイルアクセスが発生します。</li><li>ローカル互換NGというのはローカルで実行するとプロジェクト間で共有する場所に入れてしまうので、通常はやるべきではない操作であることを意味しています。</li></ul><p>実は<code>pip install</code>はインストール先に書き込み権限がなければ、<code>--user</code>をつけたのと同じ動作にフォールバックします。そうすると、venvでpip利用の場合と同じコマンドが使えますし、追加の設定も不要でVSCodeからも読めるので、一番これがベストであると考えられます。もっとも、毎回「Defaulting to user installation because normal site-packages is not writeable」とお小言を言われますが、デメリットはそれぐらいです。</p><p>Poetryが–user相当のオプションを用意してくれれば良かったのですがね。と思ったら<a href="https://github.com/python-poetry/poetry/issues/1214#issuecomment-1397088866">ちょうどこのユースケースについて議論されていま</a>すね。みんな考えることは同じ。人類皆兄弟。</p><h2 id="pyproject-tomlを手書きする"><a href="#pyproject-tomlを手書きする" class="headerlink" title="pyproject.tomlを手書きする"></a>pyproject.tomlを手書きする</h2><p>初期のファイル作成と、パッケージの追加、パッケージ追加時のrequirements.txtの更新ぐらいの薄いツールがあれば便利だな、とも思うのですが、残念ながら今のところは見つけられませんでした。Python系のツールでも議論には上がっていますが、すぐに解決というわけにはいかなそうです。</p><ul><li><a href="https://discuss.python.org/t/manually-adding-dependencies-to-pyproject-toml/18345">https://discuss.python.org/t/manually-adding-dependencies-to-pyproject-toml/18345</a></li><li><a href="https://github.com/pypa/hatch/discussions/437">https://github.com/pypa/hatch/discussions/437</a></li></ul><p>そのため、手作業で作ってみることにします。</p><p><a href="https://marketplace.visualstudio.com/items?itemName=tamasfe.even-better-toml">Even Better TOML</a>といった拡張機能を入れると、JSON Schemaを使ってTOMLのバリデーションができます。これで多少は楽にpyproject.tomlが作成できます。インストールしてpyproject.tomlファイルを開いたら、右下のところからスキーマ選択を起動し、pyproject.jsonというのを選択します。これでOK。</p><img src="/images/20231212a/スクリーンショット_2023-11-21_20.56.27.png" alt="スクリーンショット_2023-11-21_20.56.27.png" width="932" height="323" loading="lazy"><p>大体、最小限だと内容的にはこんな感じかと思います。<a href="https://peps.python.org/pep-0621/">PEP-0621の定義</a>やら<a href="https://github.com/python-jsonschema/jsonschema/blob/main/pyproject.toml">もっと大きなサンプル</a>などもみつつ充実させていけば良いでしょう。</p><figure class="highlight toml"><figcaption><span>pyproject.toml</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="section">[project]</span></span><br><span class="line"></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;sample&quot;</span></span><br><span class="line"><span class="attr">version</span> = <span class="string">&quot;1.0&quot;</span></span><br><span class="line"><span class="attr">description</span> = <span class="string">&quot;hand written pyproject.toml sample&quot;</span></span><br><span class="line"><span class="attr">authors</span> = [</span><br><span class="line">    &#123;name=<span class="string">&quot;Yoshiki Shibukawa&quot;</span>&#125;,</span><br><span class="line">    &#123;email=<span class="string">&quot;yoshiki@shibu.jp&quot;</span>&#125;</span><br><span class="line">]</span><br><span class="line"><span class="attr">license</span> = &#123;file=<span class="string">&quot;LICENSE&quot;</span>&#125;</span><br><span class="line"><span class="attr">readme</span> = <span class="string">&quot;README.md&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pip install .</span></span><br><span class="line"><span class="comment"># でインストールする利用パッケージ</span></span><br><span class="line"><span class="attr">dependencies</span> = [</span><br><span class="line">    <span class="string">&quot;django &gt;= 4.2.7, &lt; 5&quot;</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="section">[project.optional-dependencies]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pip install .[dev]</span></span><br><span class="line"><span class="comment"># でインストールする開発ツール類</span></span><br><span class="line"><span class="attr">dev</span> = [</span><br><span class="line">    <span class="string">&quot;ruff &gt;= 0.1.6, &lt; 1&quot;</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>devcontainer.jsonに以下のように書いておくと、起動のたびにパッケージを最新化してくれます。”postCreateCommand”を勧める記事なども見かけましたが、それだとイメージの再ビルドが必要になるので、こっちの方がよいかと思います。</p><figure class="highlight json"><figcaption><span>.devcontainer/devcontainer.json</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;postStartCommand&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pip3 install --user .[dev]&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>アプリ開発で必要なライブラリを追加するときは、pyproject.tomlのproject&#x2F;dependenciesのリストに追加した後に、インストールしてlockファイル相当のrequirements.txtを作ります。このファイルはコンテナ作成やデプロイに使えます。このままだとdevセクションのものも入ってしまうのですが・・・このあたりもPythonツールチェーンが良くなって欲しいところの一つ。</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ pip3 install --user .</span><br><span class="line">$ pip3 freeze --user &gt; requirements.txt</span><br></pre></td></tr></table></figure><p>プロジェクトの雛形ができたら開発ツール類を整備します。必要な拡張、あとは設定などはdevcontainer.jsonに書いておくと環境を作った瞬間にチーム内で同じ設定を共有できます。</p><figure class="highlight json"><figcaption><span>.devcontainer/devcontainer.json</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;customizations&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;vscode&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;extensions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line"><span class="string">&quot;ms-python.python&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="string">&quot;tamasfe.even-better-toml&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="string">&quot;oderwat.indent-rainbow&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="string">&quot;charliermarsh.ruff&quot;</span></span><br><span class="line"><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;[python]&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;analysis.typeCheckingMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;strict&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;editor.formatOnSave&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;editor.defaultFormatter&quot;</span><span class="punctuation">:</span> <span class="string">&quot;charliermarsh.ruff&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;editor.codeActionsOnSave&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;source.fixAll&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;source.organizeImports&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="あえて別のプロジェクト管理ツールを使う"><a href="#あえて別のプロジェクト管理ツールを使う" class="headerlink" title="あえて別のプロジェクト管理ツールを使う"></a>あえて別のプロジェクト管理ツールを使う</h2><p>これまでの方法は全部手作りすることで、Docker&#x2F;Dev Containersによる環境分離のみでなるべくシンプルにする方法でした。</p><p>一方で、Poetryや、最近話題のryeなどを使えば、pyproject.tomlが作成されますし、実際にインストールされたバージョンをrequirements.txtのような形式で出力してくれます。前に触れたように、Dockerの環境分離とvenvの環境分離が2重でかかってしまって無駄かな、とは思いますが、SimpleよりもEasyを優先したいケースもあるでしょうし、作り込まれたEasyはそれほど悪くはない、と思っています。</p><p>ryeを使う場合はdevcontainer.jsonのpostCreateCommandに次のコマンドを入れておきます。これでコンテナビルド時にryeがインストールされます。</p><figure class="highlight json"><figcaption><span>.devcontainer/devcontainer.json</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="attr">&quot;postCreateCommand&quot;</span><span class="punctuation">:</span> <span class="string">&quot;curl -sSf https://rye-up.com/get | </span></span><br><span class="line"><span class="string">   RYE_INSTALL_OPTION=\&quot;--yes\&quot; bash &amp;&amp; echo &#x27;source \&quot;$HOME/.rye/env\&quot;&#x27; &gt;&gt;</span></span><br><span class="line"><span class="string">   ~/.bashrc&quot;</span></span><br></pre></td></tr></table></figure><p>別のプロジェクトツールはvenv環境を裏で自動で作りますが、このフォルダをどこに作るかは問題となります。ryeはワークフォルダ内に.vnevフォルダを作ります。これは作業場所ごとに独立しておくべきで、ホストとワークスペースで同期する必要がないフォルダです。ホストがmacやWindowsでゲストがLinuxのときに、Linuxバイナリをホスト側に戻す必要はないですからね。次のように、.venvを同期対象から外す設定を追加します。</p><figure class="highlight json"><figcaption><span>.devcontainer/devcontainer.json</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mounts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;target=$&#123;containerWorkspaceFolder&#125;/.venv,type=volume&quot;</span> <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>ここではryeを使いましたが、poetryなどでも同じように使えるでしょう。</p><h1 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h1><p>他の人に開発環境を気軽に配れますし、その開発環境も自体も簡単にリビルドして更新できるのがDev Containersです。Pythonを例に使い方を紹介しました。</p><p>歴史が長いPythonの場合、環境分離の方法がいくつかあり、どれを選ぶかのトレードオフがあります。本エントリーでは、Dev Containersを唯一の環境分離手段として使い、モジュールは<code>pip install --user</code>でインストールする方法と、環境分離が二重がけになってしまい複雑になってしまうが、便利なryeの設定方法を紹介しました。</p><p>pyproject.tomlを手作りするあたりはこれからツールの進歩があればだいぶマシになるかと思いますが<code>setup.py</code>を手書きしていたのと比べて別に悪化はしてないし許容範囲かな、と思っています。まあ他の言語と比べていまいち、というのはわかりますが。</p>]]></content:encoded>
      
      
      <category domain="https://future-architect.github.io/categories/Programming/">Programming</category>
      
      
      <category domain="https://future-architect.github.io/tags/Python/">Python</category>
      
      <category domain="https://future-architect.github.io/tags/%E7%92%B0%E5%A2%83%E6%A7%8B%E7%AF%89/">環境構築</category>
      
      <category domain="https://future-architect.github.io/tags/Docker/">Docker</category>
      
      <category domain="https://future-architect.github.io/tags/VSCode/">VSCode</category>
      
      <category domain="https://future-architect.github.io/tags/Dev-Containers/">Dev Containers</category>
      
      <category domain="https://future-architect.github.io/tags/rye/">rye</category>
      
      
      <comments>https://future-architect.github.io/articles/20231212a/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>Dev Containersの始め方(1) : 仕組み編</title>
      <link>https://future-architect.github.io/articles/20231206a/</link>
      <guid>https://future-architect.github.io/articles/20231206a/</guid>
      <pubDate>Tue, 05 Dec 2023 15:00:00 GMT</pubDate>
      
        
        
          
          
      <description>&lt;img src=&quot;/images/20231206a/53296952672_95495d5f01_k.jpg&quot; alt=&quot;53296952672_95495d5f01_k.jpg&quot; width=&quot;1200&quot; height=&quot;800&quot;</description>
          
        
      
      
      
      <content:encoded><![CDATA[<img src="/images/20231206a/53296952672_95495d5f01_k.jpg" alt="53296952672_95495d5f01_k.jpg" width="1200" height="800" loading="lazy"><p>PyCon APAC 2023でDev Containersで発表してきました。写真はスタッフに撮っていただいた写真のアルバムから引用させていただきました。本エントリーではその発表の元ネタとして半年ぐらい前にいろいろ調べていた内容をお伝えします。</p><iframe src="https://docs.google.com/presentation/d/e/2PACX-1vTwNT6bUGRiLwk2e8sgug_DQak4qUavSA5_XW32CrWKdJHyFVprWT9qosUJrtuRNItxAF94QHGVSv_i/embed?start=false&loop=false&delayms=3000" frameborder="0" width="95%" height="569" allowfullscreen="true" mozallowfullscreen="true" webkitallowfullscreen="true"></iframe><p>個人的には、バイナリ互換とか仮想マシンってあんまり興味なくて、多くの人が努力して作り上げてきたソースコード互換のアプリでWindows&#x2F;macOS&#x2F;Linuxでネイティブで動く、という世界観が好きだったりするのですが、仕事柄、開発環境をまるっと配るというのも調べておきたいな、ということで、「俺はやらないぞ」という気持ちでいたDev Containersに触れてみて、仕組みとか使い方とか調べてみたのでそれのまとめです。</p><h1 id="普通のDockerとも違うDev-Containersの仕組み"><a href="#普通のDockerとも違うDev-Containersの仕組み" class="headerlink" title="普通のDockerとも違うDev Containersの仕組み"></a>普通のDockerとも違うDev Containersの仕組み</h1><p>devcontainerは<a href="https://code.visualstudio.com/docs/devcontainers/containers">VSCodeの持つ仕組み</a>です。この図がよく引用されていますね。ユーザーが操作しているOS上には、ソースコードと、VSCodeのみがいます。git cloneしてきてVSCodeでそのプロジェクトを開くと、<code>.devcontainer</code>というフォルダがあり、その設定を元に、VSCodeがコンテナ内部に開発環境を作ってくれます。</p><img src="/images/20231206a/image.png" alt="image.png" width="968" height="402" loading="lazy"><p>リモートで開発というと、VDI (Virtual Desktop Infrastructure)というものもあります。Amazon Workspacesとか、Azure Virtual Desktopとか、Google Virtual Desktopsとかですね。Webサービスを開発するとして、これらの代表的なVDI環境と比較するとこんな感じかと思います。</p><div class="scroll"><table><thead><tr><th align="center"></th><th align="center">通常</th><th align="center">Virtual Desktop Infrastructure</th><th align="center">Dev Containers</th></tr></thead><tbody><tr><td align="center">エディタ&#x2F;IDE</td><td align="center">ローカル</td><td align="center">仮想PC内部(RDP)</td><td align="center">ローカル</td></tr><tr><td align="center">検証用ブラウザ</td><td align="center">ローカル</td><td align="center">仮想PC内部(RDP)</td><td align="center">ローカル</td></tr><tr><td align="center">サーバー</td><td align="center">ローカル</td><td align="center">仮想PC内部</td><td align="center">Docker内部</td></tr><tr><td align="center">ソースコード</td><td align="center">ローカル</td><td align="center">仮想PC内部</td><td align="center">ローカル→Dockerにコピー</td></tr></tbody></table></div><p>VDIでもGitHub Codespacesなんかだとエディタはローカルのブラウザで動いたり、検証用ブラウザはポートフォワードでローカルのブラウザが使えたり、というのはありDev Containersとだいぶ近いのです。</p><p>ソースコードなどもローカル側が主で、そのコピーがDockerにコピーされます。実際にエディタが編集するのはコンテナ内部にコピーされたファイルだったりする（変更はローカルに同期される）のですが、基本的に通常のローカル開発と感覚はほとんど変わりません。⌘ + JとかCtrl + Jでターミナルを開くと、Docker内部に繋がっている以外は操作感覚は変わらないです。</p><p>いくつかネットで記事を見ると、いろいろコンテナを作り込んでいる記事とかも見かけるのですが、さぞ、特別なコンテナなんだろう、と<a href="https://github.com/microsoft/vscode-dev-containers/tree/main/containers">いくつかMicrosoft謹製のDev Containers用のコンテナ定義</a>を辿ってみたのですが、ユーザーを作ったり、するぐらいで、一見すると特別なことをしているようには見えません。<a href="https://github.com/microsoft/vscode-dev-containers/blob/main/containers/debian/.devcontainer/library-scripts/common-debian.sh#L77">エディタ類とかjqとかはデフォルトで入れてくれて、便利です</a>。</p><p>実は、Dockerの外でいろいろ作り込まれているのがこのDev Containersです。</p><p>Dockerのイメージのアーキテクチャとしては1つの親を持って、それに必要なファイルを追加していく作り方をします。Javaのイメージ、Pythonのイメージなど用途ごとにベースイメージを選んでいきますが、「JavaとPython両方持ったイメージが欲しい」と思うと急に便利なレールから外れます。</p><p>Dev Containersは1つベースを選ぶというのは変わらないのですが「Feature」を選んでトッピングしていきます。そうすると、それらのツール群をインストールするDockerfileが内部的に作られ、ビルドされて使えるようになります。</p><img src="/images/20231206a/devcontainer2.png" alt="devcontainer2.png" width="571" height="311" loading="lazy"><p>VSCodeのサーバー側の実装やら、拡張機能はvscodeという名前のボリュームの中に置かれて実行時にマウントしています。Dockerをいじくるソケットも内部にマウントされていて、中から結構やりたい放題できるようになっており、「完璧なイメージファイルを起動するだけ」ではなく、「必要に応じてイメージを改変して再ビルドもするし、Dockerをこき使う」感じの実装になっています。いつも引用される図からは隠されていますが、おとなしく見えて結構獰猛な作りです。もちろん、自分でイメージを作り切ってそれを利用することもできますが、この「イメージ作成機能をも内包しているツール」と考えるべきです。</p><h1 id="Dev-Containers環境の作り方・始め方"><a href="#Dev-Containers環境の作り方・始め方" class="headerlink" title="Dev Containers環境の作り方・始め方"></a>Dev Containers環境の作り方・始め方</h1><p>既存のDockerとかコンテナの知識がなまじあると、「必要なツールがそろったDockerイメージをまず作らないと」という考えになってしまい身構えがちですが（僕がそう）、Featureをバシバシ足していけば良いのだ、と思えば気軽なものです。最初からJavaとかPythonとか入っているイメージもありますが、ベースのOSイメージ（Debian, Ubuntu, Alpine)を選んで、Featureを足していくのが良さそうです。</p><p>まずは、Dev Containerの拡張を入れてから、 <strong>Add Dev Container Configuration Files…</strong> メニューを選びます。これを選ぶと、次にベースイメージとFeatureを選びます。バージョン選択などのオプションもあります。</p><img src="/images/20231206a/スクリーンショット_2023-04-16_22.45.58.png" alt="スクリーンショット_2023-04-16_22.45.58.png" width="1089" height="516" loading="lazy"><p>なお、一番目立つ <strong>New Dev Container…</strong> はイメージを作成して即座に起動するのですが、そのイメージの設定などは残りません。VSCodeの履歴にはあるのでそこから再度立ち上げ直したりもできますし、おそらくDockerの操作でイメージとしてコンテナレジストリに送ることはできて、それを起動しつつVSCodeからアタッチ、という運用は可能だと思われますが、あとでパラメータを足したり、Featureを追加したり削除したりといったことがやりにくいので、レシピが手元に残る方を選ぶ方が良いです。</p><p>ぽちぽちやると、<code>.devcontainer</code>フォルダに設定ファイルが出力され、コンテナのビルドが裏で実行され、完了するとVSCodeに表示されます。</p><p>なお、いくつかエラーに遭遇してビルドができないことがありました。</p><ul><li>Javaのオプションで17を入れると選択すると「見つからない」というエラー</li><li>FeatureでJavaを選ぶとプロキシを超えられないエラー(証明書を入れる必要がありそう)</li><li>GraalVMを選択すると、M2のMacだと「Aarch64には非対応」というエラー</li></ul><p>Dev Container関連のブログ記事とか見ると、アプリケーションで使うライブラリとかをイメージに焼き込む（Dockerfileにパッケージ一覧のファイルをADDして、RUNでインストール実行）している例もありますが、ライブラリは頻繁に追加されたりバージョンが更新されることを考えると、イメージの中には置かない方が良いでしょう。その度に再ビルドは重いですし、コンテナのビルドをしないとバージョン検証できないのは不便でしかないと思います。</p><h1 id="２回目以降"><a href="#２回目以降" class="headerlink" title="２回目以降"></a>２回目以降</h1><p>2回目以降は、一度起動したことがあるならWelcomeページで<code>[Dev Container]</code>と書いてあるプロジェクトを選択すると、Dockerコンテナが起動し、そこからの編集が開始できます。</p><img src="/images/20231206a/スクリーンショット_2023-04-17_0.15.56.png" alt="スクリーンショット_2023-04-17_0.15.56.png" width="926" height="380" loading="lazy"><p><code>.devcontainer</code>があるプロジェクトを開くと、「コンテナの中で開き直しますか？」とダイアログが出ますし、左下の緑のDev Containerアイコン<strong>Reopen in Container</strong>メニューを選んでも開けます。</p><img src="/images/20231206a/スクリーンショット_2023-04-17_0.18.00.png" alt="スクリーンショット_2023-04-17_0.18.00.png" width="564" height="149" loading="lazy"><h1 id="Dev-Containersがやってくれること・やってくれないこと"><a href="#Dev-Containersがやってくれること・やってくれないこと" class="headerlink" title="Dev Containersがやってくれること・やってくれないこと"></a>Dev Containersがやってくれること・やってくれないこと</h1><p>通常のDockerはいろいろ明示的に書かなければならないのですが、Dev Containersでは少し便利におせっかいを焼いてくれます。</p><h2 id="OK-ワークスペースのマウント"><a href="#OK-ワークスペースのマウント" class="headerlink" title="OK: ワークスペースのマウント"></a>OK: ワークスペースのマウント</h2><p>まず、Dockerのマウントとかボリューム設定をせずとも、最初にローカルで開いた（Reopenする前の)フォルダを、ワークスペースとしてマウントしてくれます。プロジェクトのフォルダ（<code>.devcontainer</code>の親フォルダ)の名前が<code>awesomeproject</code>だったとすると、<code>/workspaces/awesomeproject</code>というフォルダがコンテナ内に作られ、ローカルフォルダと同期されます。マウント設定をぽちぽちやる必要はありません。ただし、ワークフォルダに大量に自作でないファイルが作られる<code>node_modules</code>だと、ローカルとの同期が入るとかなり速度が遅くなります。これをオプトアウトする必要があります。これについてはフロントエンドの環境構築の方でまた紹介します。</p><h2 id="OK-クレデンシャルのマウント"><a href="#OK-クレデンシャルのマウント" class="headerlink" title="OK: クレデンシャルのマウント"></a>OK: クレデンシャルのマウント</h2><p>Dev Containersの設定を開発環境としてチームに配るケースやリポジトリにアップロードすることを考えると、クレデンシャルなどの情報が入るのは望ましくないことがわかります。幸い、Dev Containersはいくつかの開発者の個人設定をマウントして起動時に持ってきてくれます。イメージの内部には書き込まれないので、イメージを配布しても安全になります。ソースコードの管理はGitHubやらGitLabを使うのがだいたいエンタープライズ開発でも一般的になっているので（少なくとも僕が関わっている案件は全部）、ここが自動的に行われるとチームでの開発がスムーズです。</p><ul><li>Gitユーザーのメールアドレス: .gitconfig</li><li>Dockerのクレデンシャル: .docker&#x2F;setting.json</li></ul><p>SSHの鍵は直接インポートはしませんが、<a href="https://code.visualstudio.com/remote/advancedcontainers/sharing-git-credentials">SSH通信はホスト環境のssh-agent経由で通信しようとする</a>ので、ホスト側のエージェントに<code>ssh-add</code>で鍵を登録するだけで大丈夫です。コンテナの中に鍵を持ち込むことは不要です。</p><h2 id="NG-プロキシ設定"><a href="#NG-プロキシ設定" class="headerlink" title="NG: プロキシ設定"></a>NG: プロキシ設定</h2><p>ホストのプロキシ設定は取り込んでくれないので、もし会社にプロキシがある方は以下の設定を<code>.devcontainer/devcontainer.json</code>に入れておきましょう。ホストOSの環境変数として<code>HTTPS_PROXY</code>が定義されている想定です。認証情報をつけても大丈夫です。</p><figure class="highlight json"><figcaption><span>.devcontainer/devcontainer.json</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line">  <span class="attr">&quot;remoteEnv&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;HTTPS_PROXY&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;localEnv:HTTPS_PROXY&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;https_proxy&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;localEnv:HTTPS_PROXY&#125;&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="OK-VSCode設定"><a href="#OK-VSCode設定" class="headerlink" title="OK: VSCode設定"></a>OK: VSCode設定</h2><p><code>.devcontainer/devcontainer.json</code>にVSCodeに入れたい設定を書けます。インストールしたい拡張と、使いたい設定ですね。</p><figure class="highlight json"><figcaption><span>.devcontainer/devcontainer.json</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;customizations&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;vscode&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;extensions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line"><span class="string">&quot;oderwat.indent-rainbow&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="string">&quot;streetsidesoftware.code-spell-checker&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;python.formatting.provider&quot;</span><span class="punctuation">:</span> <span class="string">&quot;autopep8&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>いつも使っている通常の<code>.vscode/extensions.json</code>と<code>.vscode/settings.json</code>ですが、拡張機能の推奨の方は読まれません。設定は使われ、<code>devcontainer.json</code>よりも優先されます。Dev Containersを使うと、設定がUser&#x2F;Remote&#x2F;Workspaceの3階層になりますが、<code>devcontainer.json</code>はRemoteに設定され、<code>.vscode/settings.json</code>はWorkspaceに反映されます。</p><h2 id="OK-作業ユーザー"><a href="#OK-作業ユーザー" class="headerlink" title="OK: 作業ユーザー"></a>OK: 作業ユーザー</h2><p><code>vscode</code>ユーザーも作ってくれます。Dockerコンテナでは自分以外はいない環境ではあるのですが、デフォルトではrootユーザーになってしまいます。よく使うベースイメージでは<code>vscode</code>というrootではないユーザーがデフォルトでいます。どのユーザーで起動するかは<code>devcontainer.json</code>でも上書き設定できます。</p><h2 id="OK-ポート設定"><a href="#OK-ポート設定" class="headerlink" title="OK: ポート設定"></a>OK: ポート設定</h2><p><code>devcontainer.json</code>には、フォワードするポート設定の設定があります。テストサーバーを起動したときにポートを開くと、ホストのブラウザでテストできたりするのですが、実はこのポートは設定不要です。新しいサーバーが起動すると、VSCode側で「フォワードする？」って聞いてくれます。便利ですね。</p><h2 id="OK-or-NG-GUI"><a href="#OK-or-NG-GUI" class="headerlink" title="OK or NG: GUI"></a>OK or NG: GUI</h2><p>あとは試してはないのですが、Waylandのソケットも自動のフォワードしてくれるらしいので、GUIアプリケーションを起動することも可能なようです。WindowsであればWLSgでWaylandを表示してくれる機能がデフォルトで入っているため、設定いらずで表示できるかもしれません。macOSの場合はXサーバーを入れる必要があります。</p><ul><li><a href="https://blog.mohyo.net/2022/02/11591/">G2’s Forest: WSLg を使って Docker 上で GUI アプリを動かす（GPUサポート付き）</a></li><li><a href="https://future-architect.github.io/articles/20230823a/">Futureテックブログ: Playwrightの環境構築（VSCode Dev Container編）</a></li></ul><h1 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h1><p>Dev Containersの仕組みをいろいろと調べて学びました。単にDockerコンテナの中で開発するよ、というだけでなく、その外でVSCodeがいろいろと気を利かせてくれて、認証情報をホスト側と共有したり、開発サーバーが起動したらホストのブラウザからアクセスできるようにポートを開いたりしてくれることがわかりました。</p><p>Dockerのコンテナは、UNIX的な思想を体現したもので、1アプリだけが動くミニOS環境を再現したもので、外と独立した環境が作れるのは良いのですが、プリミティブすぎる感じがありました。カスタマイズポイントもコンテナによって違い、どの環境変数を設定するか、ファイルを<code>/docker-entrypoint-initdb.d</code>にマウントするとかとか、設定ポイントやインタフェースが「契約」として定義されていません。TypeDockerが欲しいな、と常々思っていました。</p><p>一方で、Dev Containersは、カスタムポイントがウィザード化されたFeature機能でトッピングしたり、クレデンシャルをイメージに焼き込まない形で取り入れる機構が用意されていたり、自動でポートを開いたり、少し文明が進んだ感じがあります。</p><p>なお、本エントリーを書くにあたって、 <a href="https://twitter.com/lambda_sakura">@lambda_sakura</a> さん、 <a href="https://twitter.com/ryushi">@ryushi</a> さん、 <a href="https://twitter.com/tk0miya">@tk0miya</a> さんにアドバイスをいろいろ教えてもらいました。ありがとうございます。</p><p><a href="/articles/20231212a/">次回</a>はPythonの環境を作っていきます。</p>]]></content:encoded>
      
      
      <category domain="https://future-architect.github.io/categories/Programming/">Programming</category>
      
      
      <category domain="https://future-architect.github.io/tags/%E7%99%BB%E5%A3%87%E3%83%AC%E3%83%9D%E3%83%BC%E3%83%88/">登壇レポート</category>
      
      <category domain="https://future-architect.github.io/tags/Docker/">Docker</category>
      
      <category domain="https://future-architect.github.io/tags/PyCon/">PyCon</category>
      
      <category domain="https://future-architect.github.io/tags/VSCode/">VSCode</category>
      
      <category domain="https://future-architect.github.io/tags/PyCon-APAC-2023/">PyCon APAC 2023</category>
      
      <category domain="https://future-architect.github.io/tags/Dev-Containers/">Dev Containers</category>
      
      
      <comments>https://future-architect.github.io/articles/20231206a/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>Qiita Advent Calendar 2023 に参加します</title>
      <link>https://future-architect.github.io/articles/20231130b/</link>
      <guid>https://future-architect.github.io/articles/20231130b/</guid>
      <pubDate>Wed, 29 Nov 2023 15:00:01 GMT</pubDate>
      
        
        
          
          
      <description>&lt;img src=&quot;/images/20231130b/IMG_0698.JPG&quot; alt=&quot;&quot; width=&quot;1181&quot; height=&quot;1181&quot; loading=&quot;lazy&quot;&gt;


&lt;h2 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot;</description>
          
        
      
      
      
      <content:encoded><![CDATA[<img src="/images/20231130b/IMG_0698.JPG" alt="" width="1181" height="1181" loading="lazy"><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>こんにちは。技術ブログ運営の伊藤です。</p><p>11月も終わりに差し掛かり、毎年後１ヶ月あるにも関わらず年末に急かされている気持ちになります。そんな12月ですが、エンジニアとしてはもはや風物詩となっているQiita Advent Calendarにフューチャーは今年も参加します。本記事ではこれまでの振り返りと今年の記事内容について触れます。</p><h2 id="アドベントカレンダーとは"><a href="#アドベントカレンダーとは" class="headerlink" title="アドベントカレンダーとは"></a>アドベントカレンダーとは</h2><p>アドベントカレンダーは以下のように<a href="https://ja.wikipedia.org/wiki/%E3%82%A2%E3%83%89%E3%83%99%E3%83%B3%E3%83%88%E3%82%AB%E3%83%AC%E3%83%B3%E3%83%80%E3%83%BC">Wikipedia</a>には書かれています。</p><blockquote><p>アドベントカレンダー (Advent calendar) は、クリスマスまでの期間に日数を数えるために使用されるカレンダーである。待降節の期間（アドベント、イエス・キリストの降誕を待ち望む期間）に窓を毎日ひとつずつ開けていくカレンダーである。すべての窓を開け終わると迎えたことになる。</p></blockquote><p>このように、クリスマス(25日)を迎えるまでに1日1日数えるカレンダーですが、エンジニアの業界では毎年これになぞらえて、リレー形式で記事を公開していくイベントとなっています。<br>このうち<a href="https://qiita.com/advent-calendar/2023">Qiita Advent Calendar</a>については2015年からフューチャーが参加しているイベントであり、今年も社内で参加者を募りました。</p><h2 id="2023年のカレンダー"><a href="#2023年のカレンダー" class="headerlink" title="2023年のカレンダー"></a>2023年のカレンダー</h2><p><a href="https://qiita.com/advent-calendar/2023">2023年</a>は以下の参加状況になっています。</p><img src="/images/20231130b/スクリーンショット_2023-11-29_15.58.00.png" alt="スクリーンショット_2023-11-29_15.58.00.png" width="1071" height="759" loading="lazy"><p>参加者については全社から以下のような方々が集まりました。</p><ul><li>数年来毎年参加し続けている方</li><li>アドベントカレンダーを機にブログを投稿する方</li><li>今回は現在新人研修を終えてOJT期間に入ったフレッシュな新卒</li><li>他薦によって記事を執筆する方</li></ul><p>例年のアドベントカレンダーから比べると、これまで技術ブログに投稿したことのない方も多くいます。そのため、普段技術ブログでは見れないような内容も見ることができるかもしれません。</p><p>また、シリーズ1が無事全て埋まったので、シリーズ2も開けております。こちらはシリーズ1で投稿したけどまだまだ書き足りない、シリーズ1の参加を逃してしまったけど投稿したい、といった方が参加しております。シリーズ１から含めると３本投稿する予定の方もいたり、こちらもぜひご覧になってください。<br>どちらのシリーズについても本記事投稿時点ではネタが定まっていない方がいますが、当日に向けて鋭意執筆中ですので、公開当日をお待ちください。</p><h2 id="発表テーマについて"><a href="#発表テーマについて" class="headerlink" title="発表テーマについて"></a>発表テーマについて</h2><p>例年の記事で掲載している内容を改めて引用します。</p><blockquote><p>例年と同じく、IT技術であること以外はフリーテーマです。</p></blockquote><blockquote><p>ポリシーとしては基本的にはQiitaそのものに投稿していただくスタイルですが（順位も少し気にしています）、Qiitaの投稿規約に沿わない記事（エッセー過ぎるもの、プログラミングに関係ないもの）は技術ブログ側に投稿することもあります。このあたりの決めは各人にお願いしています。<br>その他、個人ブログへのリンクは非推奨で基本的にはNGとアナウンスしています。</p></blockquote><p>記事投稿については個人が気になる場合は内部で確認するなどしますが、基本はガイドラインや倫理的に反しない内容で投稿していただくようお願いしております。また、個人ブログへのリンクは原則として当社のアドベントカレンダーではNGとしているので、参加される方は注意してください。</p><h2 id="さいごに"><a href="#さいごに" class="headerlink" title="さいごに"></a>さいごに</h2><p>エンジニア業界、年末の大きなイベントになっており、当社に関わらず様々なところで外部発信が溢れて色々な記事を読むことが楽しい時期でもあるのがこのアドベントカレンダーです。<br>参加者一丸で盛り上げるので、ぜひご一読いただければと思います！</p>]]></content:encoded>
      
      
      <category domain="https://future-architect.github.io/categories/Culture/">Culture</category>
      
      
      <category domain="https://future-architect.github.io/tags/%E3%82%A4%E3%83%B3%E3%83%87%E3%83%83%E3%82%AF%E3%82%B9/">インデックス</category>
      
      <category domain="https://future-architect.github.io/tags/%E3%82%A2%E3%83%89%E3%83%99%E3%83%B3%E3%83%88%E3%82%AB%E3%83%AC%E3%83%B3%E3%83%80%E3%83%BC/">アドベントカレンダー</category>
      
      <category domain="https://future-architect.github.io/tags/%E3%82%A2%E3%83%89%E3%83%99%E3%83%B3%E3%83%88%E3%82%AB%E3%83%AC%E3%83%B3%E3%83%80%E3%83%BC2023/">アドベントカレンダー2023</category>
      
      
      <comments>https://future-architect.github.io/articles/20231130b/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>Next.jsのServer Actionsは、サーバー側のバリデーションは不要なのか？</title>
      <link>https://future-architect.github.io/articles/20231130a/</link>
      <guid>https://future-architect.github.io/articles/20231130a/</guid>
      <pubDate>Wed, 29 Nov 2023 15:00:00 GMT</pubDate>
      
        
        
          
          
      <description>&lt;p&gt;Next.jsの新機能でTwitter(X)上でも少しバズったのがServer</description>
          
        
      
      
      
      <content:encoded><![CDATA[<p>Next.jsの新機能でTwitter(X)上でも少しバズったのがServer Actionsです。クライアントコンポーネント上にサーバー上で行うロジックを直接書き込むことが可能です。しかし、今までサーバーAPIを実装したことがあるのであれば、サーバー上のロジックであれば何かしらの認証のチェックやらCSRF対策などが必要なのではないか？という疑問を持つはずです。公式ドキュメントを見ても、ブログなどを検索してもそのあたりの話が出てこなかったので、少し動かしてみて検証してみました。</p><h1 id="Server-Actionsとは"><a href="#Server-Actionsとは" class="headerlink" title="Server Actionsとは"></a>Server Actionsとは</h1><p><a href="https://nextjs.org/docs/app/api-reference/functions/server-actions">Server Actions</a>は<code>&lt;form&gt;</code>タグの<code>action</code>に設定する特殊なイベントハンドラです。2種類の書き方があります。1つはサーバーコンポーネントの定義の中に書いてしまう方法です。</p><figure class="highlight tsx"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;use server&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Home</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// FormDataを受け取るasync関数を定義すると、これがServer Actionsになる</span></span><br><span class="line">  <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">onAction</span>(<span class="params">formData: FormData</span>) &#123;</span><br><span class="line">    <span class="string">&quot;use server&quot;</span></span><br><span class="line">    <span class="comment">// ここのコードはサーバーの中で実行される</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">main</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;/* Server Actionsの関数は*/&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&#123;onAction&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span>実行<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">main</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>もう1つは関数だけを作成する方法です。このファイルだけ<code>&quot;use server&quot;</code>がついていますが、この関数はクライアントコンポーネントでインポートして利用できます。</p><figure class="highlight tsx"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;use server&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">onAction</span>(<span class="params">formData: FormData</span>) &#123;</span><br><span class="line">  <span class="comment">// ここのコードはサーバーの中で実行される</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通常、サーバー側でロジックを動かす場合、ウェブサーバーのルーターにエンドポイント（ハンドラ）を追加し、レスポンスを受け取ってパースしてそれを使って動かすといったボイラープレートを実装する必要があります。外部システムからのリクエストであるため、CSRFトークンをフォームに設定したり、バリデーションなども実装する必要があります。ですが、Server Actionsではエンドポイントを追加したりといった手間はありません。</p><h1 id="どのような通信が起きているのか確認する"><a href="#どのような通信が起きているのか確認する" class="headerlink" title="どのような通信が起きているのか確認する"></a>どのような通信が起きているのか確認する</h1><p>実際にどのような通信が起きているのか見てみましょう。通常のフォーム送信と比較するために2つフォームを作成しています。</p><figure class="highlight tsx"><figcaption><span>src/app/page.tsx</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Home</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">onAction</span>(<span class="params">formData: FormData</span>) &#123;</span><br><span class="line">    <span class="string">&quot;use server&quot;</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">of</span> formData.<span class="title function_">keys</span>()) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;key&#125;</span>: <span class="subst">$&#123;formData.get(key)&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">main</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;/*Server Actions*/&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&#123;onAction&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">label</span> <span class="attr">htmlFor</span>=<span class="string">&quot;name&quot;</span>&gt;</span>name: <span class="tag">&lt;/<span class="name">label</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;name&quot;</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> /&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">label</span> <span class="attr">htmlFor</span>=<span class="string">&quot;email&quot;</span>&gt;</span>email: <span class="tag">&lt;/<span class="name">label</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;email&quot;</span> <span class="attr">name</span>=<span class="string">&quot;email&quot;</span> /&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span>Server Action<span class="tag">&lt;/<span class="name">button</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;/*通常のPOST*/&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;/api/action&quot;</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">label</span> <span class="attr">htmlFor</span>=<span class="string">&quot;name&quot;</span>&gt;</span>name: <span class="tag">&lt;/<span class="name">label</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;name&quot;</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> /&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">label</span> <span class="attr">htmlFor</span>=<span class="string">&quot;email&quot;</span>&gt;</span>email: <span class="tag">&lt;/<span class="name">label</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;email&quot;</span> <span class="attr">name</span>=<span class="string">&quot;email&quot;</span> /&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span>/api/action<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">main</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通常のPOST処理ではエンドポイントが必要になるため、これも実装しておきます。</p><figure class="highlight ts"><figcaption><span>src/app/api/action/route.ts</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">POST</span>(<span class="params">req: Request</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> formData = <span class="keyword">await</span> req.<span class="title function_">formData</span>()</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">of</span> formData.<span class="title function_">keys</span>()) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;key&#125;</span>: <span class="subst">$&#123;formData.get(key)&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Response</span>(<span class="string">&#x27;ok&#x27;</span>, &#123;</span><br><span class="line">        <span class="attr">status</span>: <span class="number">200</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>まず通常の方を見てみると、フォームのnameがキーとして利用されており、素直なフォームデータが送られています。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">name: しぶかわ</span><br><span class="line">email: shibukawa@example.com</span><br></pre></td></tr></table></figure><p>次にServer Actionsを見てみます。</p><img src="/images/20231130a/image.png" alt="image.png" width="488" height="117" loading="lazy"><p>サーバー側のハンドラで受け取ったコンテンツは次の通りで、$ACTION_IDなる項目が増えています。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ACTION_ID_0826d283a8eec2e3e98a3ef9e3e4269aca493681: </span><br><span class="line">name: しぶかわ</span><br><span class="line">email: shbiukawa@example.com</span><br></pre></td></tr></table></figure><p>しかし、開発者ツールで見ると、キーの名前などが改変されていたり、ハンドラで受け取っていない値なども入っていますね。Next.jsのサーバー側のコードが、このあたりを成型してからハンドラを呼んでいるようです。</p><img src="/images/20231130a/image_2.png" alt="image.png" width="459" height="159" loading="lazy"><p>まず、送り先ですが表示しているページと同じURLにPOSTで送っています。ちょっと変わったところとしては、いくつか<code>Next-</code>がつくヘッダーフィールドを送っています。</p><img src="/images/20231130a/image_3.png" alt="image.png" width="478" height="130" loading="lazy"><p>Next-Actionの方はリロードしても値は変わらないため、Server Actionsのハンドラの識別子なのではないかと思います。別パスに同じ内容で作成しても別のIDになりました。よく見ると、Next-Actionヘッダーフィールドの値と、$ACTION_IDは同じですね。いろいろついていますが、curlで次のようなリクエストを送ったところ、外からもServer Actionsのハンドラを起動できました。CSRFトークンのようなものはなく、わかってしまえば外からリクエストが投げられてしまうというのは、パブリックに公開するAPIの場合はちょっと警戒しておいた方が良さそうですね。</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl -F <span class="string">&#x27;1_$ACTION_ID_0826d283a8eec2e3e98a3ef9e3e4269aca493681=&#x27;</span></span><br><span class="line">  -F <span class="string">&#x27;1_name=shibukawa&#x27;</span> -F <span class="string">&#x27;1_email=shibukawa@example.com&#x27;</span></span><br><span class="line">  -F <span class="string">&#x27;0=[&quot;$K1&quot;]&#x27;</span></span><br><span class="line">  -H <span class="string">&#x27;Next-Action: 0826d283a8eec2e3e98a3ef9e3e4269aca493681&#x27;</span></span><br><span class="line">  http://localhost:3000/</span><br></pre></td></tr></table></figure><p><a href="https://nextjs.org/docs/app/building-your-application/data-fetching/forms-and-mutations#reading-cookies">クッキーの認証情報を取得する方法</a>もサンプルにありますが、ヘッダー値も取得できます。いきなりSQLを呼ぶとか話題になっていますが、セキュリティの防護はいつも通り行う必要がありそうです。次のコードはヘッダーとクッキーをすべてダンプしています。必要な情報を取得してリクエスト元の認証や認可の検証をしたり、入力情報のバリデーションは行いましょう。</p><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">onAction</span>(<span class="params">formData: FormData</span>) &#123;</span><br><span class="line">  <span class="string">&quot;use server&quot;</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> [key, value] <span class="keyword">of</span> <span class="title function_">headers</span>()) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`header: <span class="subst">$&#123;key&#125;</span>: <span class="subst">$&#123;value&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> cookie <span class="keyword">of</span> <span class="title function_">cookies</span>().<span class="title function_">getAll</span>()) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`cookie: <span class="subst">$&#123;cookie.name&#125;</span>: <span class="subst">$&#123;cookie.value&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">cookies</span>().<span class="title function_">set</span>(<span class="string">&quot;sample&quot;</span>, <span class="string">&quot;test&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>お客さんから教えてもらったのですが、React-Hook-Formにはzodを使って検証できるアダプターがあるらしいので、これを使えばクライアントのフォーム検証とサーバーの検証を同じzodのモデルを使ってできそうですね。</p><ul><li>React-Hook-Formの3rd partyへのアダプタ集: <a href="https://www.npmjs.com/package/@hookform/resolvers">https://www.npmjs.com/package/@hookform/resolvers</a></li><li>React-Hook-Form公式からリンクされているサイト: <a href="https://ui.shadcn.com/docs/components/form">https://ui.shadcn.com/docs/components/form</a></li></ul><p>おまけで、<a href="https://nextjs.org/docs/app/api-reference/functions/server-actions#binding-arguments">binding arguments</a>の仕組みを使ったら簡単にCSRFトークンの実装ができるかも試してみましたが簡単にはできませんでした。厳密にやるなら、クライアントコンポーネントにしつつ公開鍵も渡しつつ、それで署名して、サーバー側で秘密鍵で検証とかでしょうか。結構大がかりになってしまいますが。</p><h1 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h1><p>Server Actionsの実態としては、ちょっとキー名が改変されたリクエストを受け取るハンドラが生えて、そこに対するリクエストを投げるような動きをしていることが分かりました。</p><p>そのあたりの実装の手間が省けるのは便利ではありますが、外からリクエストが通ってしまうため、悪意のあるクライアントからのリクエストをチェックしてサニタイズするというロジックは別途必要なんだろうな、と思います。Next.jsのドキュメントに書いてあることとずれてしまいますが・・・</p>]]></content:encoded>
      
      
      <category domain="https://future-architect.github.io/categories/Programming/">Programming</category>
      
      
      <category domain="https://future-architect.github.io/tags/Web/">Web</category>
      
      <category domain="https://future-architect.github.io/tags/%E3%83%95%E3%83%AD%E3%83%B3%E3%83%88%E3%82%A8%E3%83%B3%E3%83%89/">フロントエンド</category>
      
      <category domain="https://future-architect.github.io/tags/React/">React</category>
      
      <category domain="https://future-architect.github.io/tags/Next-js/">Next.js</category>
      
      
      <comments>https://future-architect.github.io/articles/20231130a/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>MegaLinterを使ってみる</title>
      <link>https://future-architect.github.io/articles/20231129a/</link>
      <guid>https://future-architect.github.io/articles/20231129a/</guid>
      <pubDate>Tue, 28 Nov 2023 15:00:00 GMT</pubDate>
      
        
        
          
          
      <description>&lt;h1 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot; title=&quot;はじめに&quot;&gt;&lt;/a&gt;はじめに&lt;/h1&gt;&lt;p&gt;こんにちは、宮永 ( &lt;a</description>
          
        
      
      
      
      <content:encoded><![CDATA[<h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>こんにちは、宮永 ( <a href="https://x.com/orangekame3">@orangekame3</a> ) と申します。</p><p>現在は大阪大学で研究員をしておりフューチャー社員ではないですが、外部寄稿という形で記事を執筆しました。</p><p>今後も機会があったら寄稿させて頂きますのでよろしくお願いいたします。</p><hr><p><a href="https://megalinter.io/latest/">MegaLinter</a>を最近個人開発のリポジトリに導入してみたので概要や使い方、所感などを記事にまとめました。<br>とても便利なツールなので本記事を機に利用してみてください。</p><h1 id="MegaLinterとは"><a href="#MegaLinterとは" class="headerlink" title="MegaLinterとは"></a>MegaLinterとは</h1><p>MegaLinterはdockerイメージをベースに各種リンターやフォーマッタを各リポジトリに導入できるOSSツールです。ローカルでも利用できますし、dockerイメージが用意されているため、各種CIサービスでも簡単に導入できます。</p><p>以下MegaLinterのHPからの引用です。</p><blockquote><p>MegaLinter is an Open-Source tool for CI&#x2F;CD workflows that analyzes the consistency of your code, IAC, configuration, and scripts in your repository sources, to ensure all your projects sources are clean and formatted whatever IDE&#x2F;toolbox is used by their developers, powered by OX Security.<br>Supporting 55 languages, 24 formats, 20 tooling formats and ready to use out of the box, as a GitHub action or any CI system highly configurable and free for all uses.</p></blockquote><p>55言語というのは55個のLinterツールが用意されている。ということみたいです。例えばGo言語であれば<code>golangci-lint</code>と<code>revive</code>がサポートされており、これを2つ分とカウントしています。他の言語に関しても1言語1ツールというわけではなく、かなり広範にサポートしているため、普通に利用する分にはMegaLinter一つ入れておけばリンターやフォーマッタはカバーできそうです。</p><h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><p>基本的なフローは下図のようにコミットがある度にLinterが走り、各種レポートが作成されるというものです。</p><div align="center">▼MegaLinterの基本的なフロー<img src="/images/20231129a/属性.png" alt="属性" width="1200" height="621" loading="lazy"></div><p>レポートの形式は豊富で、Pull Requestにコメントする方式やEmailに配信する方法などが用意されています。</p><p>多くの場合はPull Requestsにコメントする方法を採用するのではないかと思います。</p><div align="center">▼Pull Requestにコメントする例<img src="/images/20231129a/属性_2.png" alt="属性" width="825" height="499" loading="lazy"></div><p>フォーマッタによってはオートフォーマットが有効なものもあるため、非常に便利です。<br>「Linterを一箇所に集約して管理したい」「メジャーどころのLinterをとりあえず揃えたい」「LinterをCIに簡単に導入したい」という方にはおすすめのツールです。</p><p>一方で、「CIにかかる時間を最適化したい」「MegaLinterにないLinterを使いたい」という方には向かないかもしれないです。</p><h2 id="実際に使ってみた"><a href="#実際に使ってみた" class="headerlink" title="実際に使ってみた"></a>実際に使ってみた</h2><p>サンプル用に”Hello, 世界”と標準出力するGoのファイルを用意します。</p><p>コミットID：<a href="https://github.com/orangekame3/megalinter-sample/commit/0af6a42e85460282b43bcbac980ea45c8cc4d79e">0af6a42</a>(<a href="https://github.com/orangekame3/megalinter-sample">こちらのリポジトリ</a>にサンプルを用意したので参考にしてください)</p><figure class="highlight go"><figcaption><span>main.go</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;Hello, 世界&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>MegaLinterにはインタラクティブに設定ファイルを生成するコマンドが用意されているので、そちらを利用します。</p><p>以下コマンドをプロジェクト直下で実行してください。</p><div class="note info" style="background: #e5f8e2; padding:16px; margin:24px 12px; border-radius:8px;">  <span class="fa fa-fw fa-check-circle"></span><p><a href="https://nodejs.org/en/">node.js</a>はインストールされているものとします。</p></div><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">npx mega-linter-runner --install</span><br></pre></td></tr></table></figure><p>コマンドを実行すると</p><p>下図のようなプロンプトが立ち上がるので選択をしていきます。<br><img src="/images/20231129a/image.png" alt="image.png" width="1153" height="356" loading="lazy"></p><p>今回はGoのプロジェクトを選択しています。自分の環境に合わせて選択してください。</p><p>すべて選択し終えると設定ファイルが自動生成されます。<br>以下、この断面のコミットIとディレクトリ構成です。<br>コミットID：<a href="https://github.com/orangekame3/megalinter-sample/commit/98c3d85d333584f067f3ed47da3f97e51eaf0eeb">98c3d85</a></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">.</span><br><span class="line">├── .github</span><br><span class="line">│   └── workflows</span><br><span class="line">│       └── mega-linter.yml</span><br><span class="line">├── .gitignore</span><br><span class="line">├── .jscpd.json</span><br><span class="line">├── .mega-linter.yml</span><br><span class="line">├── README.md</span><br><span class="line">└── main.go</span><br></pre></td></tr></table></figure><p>主に編集する設定ファイルは<code>.mega-linter.yml</code>です。</p><figure class="highlight yml"><figcaption><span>.megalinter.yml</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment"># Configuration file for MegaLinter</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># See all available variables at https://megalinter.io/configuration/ and in</span></span><br><span class="line"><span class="comment"># linters documentation</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># all, none, or list of linter keys</span></span><br><span class="line"><span class="attr">APPLY_FIXES:</span> <span class="string">all</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># If you use ENABLE variable, all other languages/formats/tooling-formats will</span></span><br><span class="line"><span class="comment"># be disabled by default</span></span><br><span class="line"><span class="comment"># ENABLE:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># If you use ENABLE_LINTERS variable, all other linters will be disabled by</span></span><br><span class="line"><span class="comment"># default</span></span><br><span class="line"><span class="comment"># ENABLE_LINTERS:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># DISABLE:</span></span><br><span class="line">  <span class="comment"># - COPYPASTE # Uncomment to disable checks of excessive copy-pastes</span></span><br><span class="line">  <span class="comment"># - SPELL # Uncomment to disable checks of spelling mistakes</span></span><br><span class="line"></span><br><span class="line"><span class="attr">SHOW_ELAPSED_TIME:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">FILEIO_REPORTER:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Uncomment if you want MegaLinter to detect errors but not block CI to pass</span></span><br><span class="line"><span class="comment"># DISABLE_ERRORS: true</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>デフォルトの設定ではLinterが多すぎるため必要なLinterのみ有効化します。今回は初期設定時にGoのプロジェクトを選択したため、Go Flavorを利用しています。</p><div class="note info" style="background: #e5f8e2; padding:16px; margin:24px 12px; border-radius:8px;">  <span class="fa fa-fw fa-check-circle"></span><p>FlavorとはMegaLinterで用意している言語ごとのプリセットです。</p></div><p>Go Flavorに採用されているLinterは<a href="https://megalinter.io/latest/flavors/go/">こちら</a>で確認できます。</p><p>今回はGoのLinterとしてRivive、MarkdownのLinterとしてMarkdownlintを利用します。</p><figure class="highlight diff"><table><tr><td class="code"><pre><span class="line"><span class="addition">+ENABLE_LINTERS:</span></span><br><span class="line"><span class="addition">+  - GO_REVIVE</span></span><br><span class="line"><span class="addition">+  - MARKDOWN_MARKDOWNLINT</span></span><br></pre></td></tr></table></figure><p>ではローカルでLinterを実行してみます。MegaLinterはdockerを利用するため、ローカル環境のDockerエンジンを起動して以下コマンドを実行してください。</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">npx mega-linter-runner --flavor go</span><br></pre></td></tr></table></figure><p>コマンドを実行するとLinterが走ります。<br>以下実行結果です。</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">npx mega-linter-runner --flavor go</span><br><span class="line">Pulling docker image oxsecurity/megalinter-go:v7 ...</span><br><span class="line">INFO: this operation can be long during the first use of mega-linter-runner</span><br><span class="line">The next runs, it will be immediate (thanks to docker cache !)</span><br><span class="line">v7: Pulling from oxsecurity/megalinter-go</span><br><span class="line">Digest: sha256:d3f363206d1f99a5b1def54ed4f6601bd6dbb03d1fd04e5731dafe9813f6ef12</span><br><span class="line">Status: Image is up to date for oxsecurity/megalinter-go:v7</span><br><span class="line">docker.io/oxsecurity/megalinter-go:v7</span><br><span class="line">Command: docker run --platform linux/amd64 -v /var/run/docker.sock:/var/run/docker.sock:rw -v C:\Users\miyao\megalinter-sample:/tmp/lint:rw oxsecurity/megalinter-go:v7</span><br><span class="line">Skipped setting git safe.directory DEFAULT_WORKSPACE:  ...</span><br><span class="line">Setting git safe.directory default: /github/workspace ...</span><br><span class="line">Setting git safe.directory to /tmp/lint ...</span><br><span class="line">[MegaLinter init] ONE-SHOT RUN</span><br><span class="line">[config] /tmp/lint/.mega-linter.yml + Environment variables</span><br><span class="line"></span><br><span class="line">    .:oool&#x27;                                  ,looo;</span><br><span class="line">    .xNXNXl                                 .dXNNXo.</span><br><span class="line">     lXXXX0c.                              &#x27;oKXXN0;</span><br><span class="line">     .oKNXNX0kxdddddddoc,.    .;lodddddddxk0XXXX0c</span><br><span class="line">      .:kKXXXXXXXXXXXXNXX0dllx0XXXXXXXXXXXXXXXKd,</span><br><span class="line">        .,cdkOOOOOOOO0KXXXXXXXXXXK0OOOOOOOkxo:&#x27;</span><br><span class="line">                      &#x27;ckKXNNNXkc&#x27;</span><br><span class="line">              &#x27;:::::;.  .c0XX0l.  .;::::;.</span><br><span class="line">              &#x27;xXXXXXx&#x27;   :kx:   ;OXXXXKd.</span><br><span class="line">               .dKNNXXO;   ..   :0XXXXKl.</span><br><span class="line">                .lKXXXX0:     .lKXXXX0:</span><br><span class="line">                  :0XXXXKl.  .dXXXXXk,</span><br><span class="line">                   ;kXXXXKd:cxXXXXXx&#x27;</span><br><span class="line">                    &#x27;xXNXXXXXXXXXKo.</span><br><span class="line">                     .oKXXXXNXXX0l.</span><br><span class="line">                      .lKNNXNNXO:</span><br><span class="line">                        ,looool&#x27;</span><br><span class="line"></span><br><span class="line">==========================================================</span><br><span class="line">=============   MegaLinter, by OX.security   =============</span><br><span class="line">=========  https://ox.security?ref=megalinter  ===========</span><br><span class="line">==========================================================</span><br><span class="line"></span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line">------------------------------------ MegaLinter, by OX Security ------------------------------------</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line"> - Image Creation Date: 2023-09-22T15:10:52Z</span><br><span class="line"> - Image Revision: a87b2872713c6bdde46d2473c5d7ed23e5752dc2</span><br><span class="line"> - Image Version: v7.4.0</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line">The MegaLinter documentation can be found at:</span><br><span class="line"> - https://megalinter.io/7.4.0</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line">MegaLinter initialization</span><br><span class="line">MegaLinter will analyze workspace [/tmp/lint]</span><br><span class="line"></span><br><span class="line">MARKDOWN_REMARK_LINT has been temporary disabled in MegaLinter, please use a previous MegaLinter version or wait for the next one !</span><br><span class="line">Skipped linters: ACTION_ACTIONLINT, ANSIBLE_ANSIBLE_LINT, ARM_ARM_TTK, BASH_EXEC, BASH_SHELLCHECK, BASH_SHFMT, BICEP_BICEP_LINTER, CLOJURE_CLJSTYLE, CLOJURE_CLJ_KONDO, CLOUDFORMATION_CFN_LINT, COFFEE_COFFEELINT, COPYPASTE_JSCPD, CPP_CPPLINT, CSHARP_CSHARPIER, CSHARP_DOTNET_FORMAT, CSS_SCSS_LINT, CSS_STYLELINT, C_CPPLINT, DART_DARTANALYZER, DOCKERFILE_HADOLINT, EDITORCONFIG_EDITORCONFIG_CHECKER, ENV_DOTENV_LINTER, GHERKIN_GHERKIN_LINT, GO_GOLANGCI_LINT, GRAPHQL_GRAPHQL_SCHEMA_LINTER, GROOVY_NPM_GROOVY_LINT, HTML_DJLINT, HTML_HTMLHINT, JAVASCRIPT_ES, JAVASCRIPT_PRETTIER, JAVASCRIPT_STANDARD, JAVA_CHECKSTYLE, JAVA_PMD, JSON_ESLINT_PLUGIN_JSONC, JSON_JSONLINT, JSON_NPM_PACKAGE_JSON_LINT, JSON_PRETTIER, JSON_V8R, JSX_ESLINT, KOTLIN_KTLINT, KUBERNETES_HELM, KUBERNETES_KUBECONFORM, KUBERNETES_KUBESCAPE, LATEX_CHKTEX, LUA_LUACHECK, MAKEFILE_CHECKMAKE, MARKDOWN_MARKDOWN_LINK_CHECK, MARKDOWN_MARKDOWN_TABLE_FORMATTER, MARKDOWN_REMARK_LINT, OPENAPI_SPECTRAL, PERL_PERLCRITIC, PHP_PHPCS, PHP_PHPLINT, PHP_PHPSTAN, PHP_PSALM, POWERSHELL_POWERSHELL, POWERSHELL_POWERSHELL_FORMATTER, PROTOBUF_PROTOLINT, PUPPET_PUPPET_LINT, PYTHON_BANDIT, PYTHON_BLACK, PYTHON_FLAKE8, PYTHON_ISORT, PYTHON_MYPY, PYTHON_PYLINT, PYTHON_PYRIGHT, PYTHON_RUFF, RAKU_RAKU, REPOSITORY_CHECKOV, REPOSITORY_DEVSKIM, REPOSITORY_DUSTILOCK, REPOSITORY_GITLEAKS, REPOSITORY_GIT_DIFF, REPOSITORY_GRYPE, REPOSITORY_KICS, REPOSITORY_SECRETLINT, REPOSITORY_SEMGREP, REPOSITORY_SYFT, REPOSITORY_TRIVY, REPOSITORY_TRIVY_SBOM, REPOSITORY_TRUFFLEHOG, RST_RSTCHECK, RST_RSTFMT, RST_RST_LINT, RUBY_RUBOCOP, RUST_CLIPPY, R_LINTR, SALESFORCE_SFDX_SCANNER_APEX, SALESFORCE_SFDX_SCANNER_AURA, SALESFORCE_SFDX_SCANNER_LWC, SCALA_SCALAFIX, SNAKEMAKE_LINT, SNAKEMAKE_SNAKEFMT, SPELL_CSPELL, SPELL_LYCHEE, SPELL_PROSELINT, SPELL_VALE, SQL_SQLFLUFF, SQL_SQL_LINT, SQL_TSQLLINT, SWIFT_SWIFTLINT, TEKTON_TEKTON_LINT, TERRAFORM_TERRAFORM_FMT, TERRAFORM_TERRAGRUNT, TERRAFORM_TERRASCAN, TERRAFORM_TFLINT, TSX_ESLINT, TYPESCRIPT_ES, TYPESCRIPT_PRETTIER, TYPESCRIPT_STANDARD, VBDOTNET_DOTNET_FORMAT, XML_XMLLINT, YAML_PRETTIER, YAML_V8R, YAML_YAMLLINT</span><br><span class="line">To receive reports as email, please set variable EMAIL_REPORTER_EMAIL</span><br><span class="line"></span><br><span class="line">MegaLinter now collects the files to analyse</span><br><span class="line">Listing all files in directory [/tmp/lint], then filter with:</span><br><span class="line">- File extensions: .go, .md</span><br><span class="line">- Excluding .gitignored files [39]: megalinter-reports/.cspell.json, megalinter-reports/IDE-config.txt, megalinter-reports/IDE-config/.checkov.yml, megalinter-reports/IDE-config/.eslintrc-json.json, megalinter-reports/IDE-config/.gitleaks.toml, megalinter-reports/IDE-config/.golangci.yml, megalinter-reports/IDE-config/.grype.yaml, megalinter-reports/IDE-config/.idea/externalDependencies.xml, megalinter-reports/IDE-config/.markdown-link-check.json, megalinter-reports/IDE-config/.markdownlint.json,…(full list in DEBUG)</span><br><span class="line">Kept [2] files on [7] found files</span><br><span class="line"></span><br><span class="line">+----MATCHING LINTERS-------+----------+----------------+------------+</span><br><span class="line">| Descriptor | Linter       | Criteria | Matching files | Format/Fix |</span><br><span class="line">+------------+--------------+----------+----------------+------------+</span><br><span class="line">| GO         | revive       | .go      | 1              | no         |</span><br><span class="line">| MARKDOWN   | markdownlint | .md      | 1              | yes        |</span><br><span class="line">+------------+--------------+----------+----------------+------------+</span><br><span class="line"></span><br><span class="line">Processing linters on [4] parallel cores…</span><br><span class="line">✅ Linted [MARKDOWN] files with [markdownlint] successfully - (1.93s)</span><br><span class="line">- Using [markdownlint v0.37.0] https://megalinter.io/7.4.0/descriptors/markdown_markdownlint</span><br><span class="line">- MegaLinter key: [MARKDOWN_MARKDOWNLINT]</span><br><span class="line">- Rules config: [.markdownlint.json]</span><br><span class="line">- Number of files analyzed: [1]</span><br><span class="line"></span><br><span class="line">❌ Linted [GO] files with [revive]: Found 1 error(s) - (9.25s)</span><br><span class="line">- Using [revive v1.3.4] https://megalinter.io/7.4.0/descriptors/go_revive</span><br><span class="line">- MegaLinter key: [GO_REVIVE]</span><br><span class="line">- Rules config: identified by [revive]</span><br><span class="line">- Number of files analyzed: [1]</span><br><span class="line">--Error detail:</span><br><span class="line">main.go:1:1: should have a package comment</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">+----SUMMARY--+--------------+---------------+-------+-------+--------+--------------+</span><br><span class="line">| Descriptor  | Linter       | Mode          | Files | Fixed | Errors | Elapsed time |</span><br><span class="line">+-------------+--------------+---------------+-------+-------+--------+--------------+</span><br><span class="line">| ❌ GO       | revive       | list_of_files |     1 |       |      1 |        9.25s |</span><br><span class="line">| ✅ MARKDOWN | markdownlint | list_of_files |     1 |     0 |      0 |        1.93s |</span><br><span class="line">+-------------+--------------+---------------+-------+-------+--------+--------------+</span><br><span class="line"></span><br><span class="line">[Updated Sources Reporter] copied 1 fixed source files in folder /tmp/lint/megalinter-reports/updated_sources.</span><br><span class="line">Download it from artifacts then copy-paste it in your local repo to apply linters updates</span><br><span class="line">❌ Error(s) have been found during linting</span><br><span class="line">To disable linters or customize their checks, you can use a .mega-linter.yml file at the root of your repository</span><br><span class="line">More info at https://megalinter.io/7.4.0/configuration/</span><br></pre></td></tr></table></figure><p>Goでエラーが出ていますね。出力結果の最後にレポートが出力されるため、Linterの結果がわかりやすいです。</p><p>では該当の部分を修正して再度Linterを走らせます。</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">❌ Linted [GO] files with [revive]: Found 1 error(s) - (9.25s)</span><br><span class="line">- Using [revive v1.3.4] https://megalinter.io/7.4.0/descriptors/go_revive</span><br><span class="line">- MegaLinter key: [GO_REVIVE]</span><br><span class="line">- Rules config: identified by [revive]</span><br><span class="line">- Number of files analyzed: [1]</span><br><span class="line">--Error detail:</span><br><span class="line">main.go:1:1: should have a package comment</span><br></pre></td></tr></table></figure><p>reviveのログを確認すると、packageのコメントを記載していなかったことが原因そうです。</p><p>以下のようにmain.goを修正します。</p><figure class="highlight go"><figcaption><span>main.go</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">// Package main print &quot;Hello 世界&quot;</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;Hello, 世界&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以下再実行した結果です。エラーが解消したことを確認できます。</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">+----MATCHING LINTERS-------+----------+----------------+------------+</span><br><span class="line">| Descriptor | Linter       | Criteria | Matching files | Format/Fix |</span><br><span class="line">+------------+--------------+----------+----------------+------------+</span><br><span class="line">| GO         | revive       | .go      | 1              | no         |</span><br><span class="line">| MARKDOWN   | markdownlint | .md      | 1              | yes        |</span><br><span class="line">+------------+--------------+----------+----------------+------------+</span><br><span class="line"></span><br><span class="line">Processing linters on [4] parallel cores…</span><br><span class="line">✅ Linted [MARKDOWN] files with [markdownlint] successfully - (1.3s)</span><br><span class="line">- Using [markdownlint v0.37.0] https://megalinter.io/7.4.0/descriptors/markdown_markdownlint</span><br><span class="line">- MegaLinter key: [MARKDOWN_MARKDOWNLINT]</span><br><span class="line">- Rules config: [.markdownlint.json]</span><br><span class="line">- Number of files analyzed: [1]</span><br><span class="line"></span><br><span class="line">✅ Linted [GO] files with [revive] successfully - (7.38s)</span><br><span class="line">- Using [revive v1.3.4] https://megalinter.io/7.4.0/descriptors/go_revive</span><br><span class="line">- MegaLinter key: [GO_REVIVE]</span><br><span class="line">- Rules config: identified by [revive]</span><br><span class="line">- Number of files analyzed: [1]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">+----SUMMARY--+--------------+---------------+-------+-------+--------+--------------+</span><br><span class="line">| Descriptor  | Linter       | Mode          | Files | Fixed | Errors | Elapsed time |</span><br><span class="line">+-------------+--------------+---------------+-------+-------+--------+--------------+</span><br><span class="line">| ✅ GO       | revive       | list_of_files |     1 |       |      0 |        7.38s |</span><br><span class="line">| ✅ MARKDOWN | markdownlint | list_of_files |     1 |     0 |      0 |         1.3s |</span><br><span class="line">+-------------+--------------+---------------+-------+-------+--------+--------------+</span><br><span class="line"></span><br><span class="line">[Updated Sources Reporter] copied 2 fixed source files in folder /tmp/lint/megalinter-reports/updated_sources.</span><br><span class="line">Download it from artifacts then copy-paste it in your local repo to apply linters updates</span><br><span class="line">✅ Successfully linted all files without errors</span><br></pre></td></tr></table></figure><h2 id="PR上のコメント機能"><a href="#PR上のコメント機能" class="headerlink" title="PR上のコメント機能"></a>PR上のコメント機能</h2><p>では、このブランチをリモートリポジトリにPushしてPR上のコメントを確認します。</p><p>以下がPR上でのコメントの様子です。</p><img src="/images/20231129a/image_2.png" alt="image.png" width="651" height="725" loading="lazy"><p>表形式にまとめてくれているため、非常にわかりやすいですね。</p><p>PRは<a href="https://github.com/orangekame3/megalinter-sample/pull/1">こちら</a>です。</p><h1 id="さいごに"><a href="#さいごに" class="headerlink" title="さいごに"></a>さいごに</h1><p>以上、 MegaLinterの紹介と簡単な利用方法を解説しました。</p><p>欲を言うと<a href="https://github.com/reviewdog/reviewdog">Reviewdog</a>のようなツールと簡単に連携できると嬉しいです。Reviewdogの<a href="https://github.com/reviewdog/reviewdog/issues/841">Issue#841</a>で議論されているようですが、まだ簡単に連携できる状態ではなさそうです。</p><p>とりあえず、Linterを導入したいと言う方には非常におすすめなツールですのでぜひ活用してみてください。</p>]]></content:encoded>
      
      
      <category domain="https://future-architect.github.io/categories/DevOps/">DevOps</category>
      
      
      <category domain="https://future-architect.github.io/tags/Linter/">Linter</category>
      
      <category domain="https://future-architect.github.io/tags/GitHubActions/">GitHubActions</category>
      
      <category domain="https://future-architect.github.io/tags/GitHub/">GitHub</category>
      
      <category domain="https://future-architect.github.io/tags/Markdownlint/">Markdownlint</category>
      
      <category domain="https://future-architect.github.io/tags/MegaLinter/">MegaLinter</category>
      
      <category domain="https://future-architect.github.io/tags/Rivive/">Rivive</category>
      
      
      <comments>https://future-architect.github.io/articles/20231129a/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>data-testidはいつ使うべきか？そもそも使うべきなのか？</title>
      <link>https://future-architect.github.io/articles/20231128a/</link>
      <guid>https://future-architect.github.io/articles/20231128a/</guid>
      <pubDate>Mon, 27 Nov 2023 15:00:00 GMT</pubDate>
      
        
        
          
          
      <description>&lt;img src=&quot;/images/20231128a/top.png&quot; alt=&quot;&quot; width=&quot;329&quot; height=&quot;153&quot;&gt;

&lt;p&gt;Playwrightあるいはそのロケーターの元ネタとなっているTesting Libraryでは、DOMを指定する方法として</description>
          
        
      
      
      
      <content:encoded><![CDATA[<img src="/images/20231128a/top.png" alt="" width="329" height="153"><p>Playwrightあるいはそのロケーターの元ネタとなっているTesting Libraryでは、DOMを指定する方法として <code>data-testid</code> 属性を扱ったクエリーを提供しています。どちらでも <code>getByTestId(ID文字列)</code> メソッドを使い、この属性値を使った要素の取得が行えます。しかし、ドキュメントを見ると、PlaywrightもTesting Libraryも、「他の手法が使えないときの最終手段」としています。</p><blockquote><p>In the spirit of the guiding principles, it is recommended to use this only after the other queries don’t work for your use case. Using data-testid attributes do not resemble how your software is used and should be avoided if possible. That said, they are way better than querying based on DOM structure or styling css class names. Learn more about data-testids from the blog post “Making your UI tests resilient to change”</p><p><a href="https://testing-library.com/docs/guiding-principles">方針の原則</a>の精神に基づき、他のクエリではユースケースに合わなかった場合にのみ、これを使用することをお勧めします。 <code>data-testid</code> 属性の使用は(エンドユーザーが)ソフトウェアを使用する方法とかけ離れているため、可能であれば避けてください。とはいえ、DOM構造に基づいてクエリを実行したり、(テストのために)CSSクラス名を設定するよりもはるかに優れています。 <code>data-testid</code> の詳細については、ブログ投稿の <a href="https://kentcdodds.com/blog/making-your-ui-tests-resilient-to-change">変更に対するUIテストの回復力の強化」</a>を参照してください。</p></blockquote><ul><li><a href="https://future-architect.github.io/articles/20210226/">アクセシビリティ情報を使った壊れにくいE2Eテスト</a></li></ul><p>以前書いた技術ブログの記事では「人間に近い感覚」で要素を取得するテストが壊れにくいテストであるということを書きました。<code>data-testid</code> はHTMLを見て初めて知り得る情報ですので、E2Eテストではなるべく使うべきではありません。エンドユーザーはDOM構造を見てウェブサイトにアクセスするわけではありません。ユーザーが操作するのはブラウザで操作するウェブアプリケーションであり、レンダリングされたウェブページを見て操作します。エンドユーザーから見れば、DOMの構造は実装の詳細であって、開発者ツールを見ないとわからない情報です。実装の詳細はリファクタリング等で変更されることがありますが、より抽象度の高い操作はそれよりも「意図せぬ変更」にはなりにくいです。</p><p>単体テストでも同様に使うべきではありません。同じようにテストできるのであれば、テストコードは少ない方が良いし、ホワイトボックステストよりもブラックボックステストで公開メンバーのみに対するテストで済むならそちらの方が良いというのは多くの開発者が合意してくれる内容だと思います。公開メソッドで済むのにわざわざリフレクション機能を使うのはよくないですよね？DOM構造を使ったテストはなるべく行うべきではないホワイトボックステストです。</p><p>そうなると、Testing-Libraryの原則で説明されているように、他の方法がある場合はそちらを使うべき、というのがわかるでしょう。「<code>data-testid</code>なんて新しい属性を作らなくても、 <code>id</code> や <code>class</code> でいいのでは？」と思う方もいると思います。 <code>id</code> や <code>class</code>ははテスト専用ではなくて別の役割も持っているため、テスト以外の動機によって変更されてしまうことがあります。 <code>data-testid</code> の立ち位置は、なるべく使うべきではないが <code>id</code> や <code>class</code> よりはまし、と覚えておきましょう。</p><p>唯一、気兼ねなく使っても問題がないと思われるケースは、単体テストかつ、これが外部に公開されたAPIである場合です。次のように、省略可能な <code>data-testid</code> 属性をコンポーネントに付与し、もし指定されたらコンポーネントのルートの要素にこの属性をフォワードして付与するようにします。</p><figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="comment">// data-testid属性をフォワードして設定するコンポーネント</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Component</span>(<span class="params">props: &#123;[<span class="string">&quot;data-testid&quot;</span>]?: string&#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">data-testid</span>=<span class="string">&#123;props[</span>&quot;<span class="attr">data-testid</span>&quot;]&#125;&gt;</span>My Component<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>こうすれば、単体テストにおいては、テストコードの見える場所で宣言と利用が行われます。「どこで定義されたかわからない謎の属性」感はなくなり、テストコードを読んだ人からはコンポーネントの中を知らずともその利用方法が想像できて、ブラックボックステストであるべき、という原則を壊さずに利用できていることがわかるでしょう。</p><figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="comment">// data-testidの問題ない利用例（Jest + @testing-library/react）</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">test</span>(<span class="string">&#x27;loads and displays greeting&#x27;</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="title function_">render</span>(<span class="language-xml"><span class="tag">&lt;<span class="name">Component</span> <span class="attr">data-testid</span>=<span class="string">&quot;test-target&quot;</span> /&gt;</span></span>)</span><br><span class="line"></span><br><span class="line">  <span class="title function_">expect</span>(screen.<span class="title function_">getByTestId</span>(<span class="string">&#x27;test-target&#x27;</span>)).<span class="title function_">toHaveTextContent</span>(<span class="string">&#x27;My Component&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>どちらにせよ、E2Eテストではなるべく使わない方が良いでしょう。眼に見える要素を使ってテストを書くべきです。</p><h1 id="代わりに何を使えば良いか？"><a href="#代わりに何を使えば良いか？" class="headerlink" title="代わりに何を使えば良いか？"></a>代わりに何を使えば良いか？</h1><p>Testing LibraryもPlaywrightも、どちらもリファレンスでは同じような並びに並んでいることがわかります。アルファベット順ではないです。この順番で利用を検討していけば良いという推奨の順番と考えても良いと思います。(Testing-LibraryはByの前に、get, find, query, getAll, findAll, queryAllと6パターンの接頭辞のバリエーションがあります)</p><div class="scroll"><table><thead><tr><th align="left">Playwright</th><th align="left">Testing-Library</th><th align="left">役割</th></tr></thead><tbody><tr><td align="left"><code>getByRole()</code></td><td align="left"><code>ByRole()</code></td><td align="left">ロールで取得</td></tr><tr><td align="left"><code>getByLabel()</code></td><td align="left"><code>ByLabelText()</code></td><td align="left">ラベルテキストで取得</td></tr><tr><td align="left"><code>getByPlaceholder()</code></td><td align="left"><code>ByPlaceholderText()</code></td><td align="left">プレースホルダのテキストで取得</td></tr><tr><td align="left"><code>getByText()</code></td><td align="left"><code>ByText()</code></td><td align="left">テキスト情報で取得</td></tr><tr><td align="left"></td><td align="left"><code>ByDisplayValue()</code></td><td align="left">input&#x2F;textareaのvalue値で取得</td></tr><tr><td align="left"><code>getByAltText()</code></td><td align="left"><code>ByAltText()</code></td><td align="left">画像などの代替テキスト(alt属性)で取得</td></tr><tr><td align="left"><code>getByTitle()</code></td><td align="left"><code>ByTitle()</code></td><td align="left">HTMLのtitle属性(ツールチップで表示される)で取得</td></tr><tr><td align="left"><code>getByTestId()</code></td><td align="left"><code>ByTestId()</code></td><td align="left">data-testid属性で取得</td></tr><tr><td align="left"><code>locator()</code></td><td align="left"></td><td align="left">CSS&#x2F;XPathで取得</td></tr></tbody></table></div><p>檳榔さんから教えてもらったのですが、Cypressのベストプラクティスは<code>data-</code>属性を付与することを推奨しています。</p><ul><li><a href="https://docs.cypress.io/guides/references/best-practices#Selecting-Elements">https://docs.cypress.io/guides/references/best-practices#Selecting-Elements</a></li></ul><p>これは本エントリーとは矛盾はしません。というのも、アクセシビリティの要素での要素取得はCypress本体の機能ではなく、外部のライブラリのTesint-Libraryの機能だからです。Cypress本体の機能で実現できるのは<code>getByText()</code>と、上記の表の末尾の2つです。このうち、テキストは変更されうるので非推奨としています。</p><p>アクセシビリティ要素に関して言えば、機能を起動する起点となるものはたいていロールを使います。テキストは結果の取得程度で、たいていは入力値と同じもの、あるいはそこから算出される期待するテキストの取得に使うと思うので問題はないでしょう。そんでもって末尾の2つの中では<code>data-testid</code>の方が優先度が高いのでCypressのドキュメントで書かれていることと矛盾はしないですよね？</p>]]></content:encoded>
      
      
      <category domain="https://future-architect.github.io/categories/Infrastructure/">Infrastructure</category>
      
      
      <category domain="https://future-architect.github.io/tags/React/">React</category>
      
      <category domain="https://future-architect.github.io/tags/Cypress/">Cypress</category>
      
      <category domain="https://future-architect.github.io/tags/Playwright/">Playwright</category>
      
      
      <comments>https://future-architect.github.io/articles/20231128a/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>Unreal Engine5で簡単な色塗りゲームを作ろう！</title>
      <link>https://future-architect.github.io/articles/20231127a/</link>
      <guid>https://future-architect.github.io/articles/20231127a/</guid>
      <pubDate>Sun, 26 Nov 2023 15:00:00 GMT</pubDate>
      
        
        
          
          
      <description>&lt;h1 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot; title=&quot;はじめに&quot;&gt;&lt;/a&gt;はじめに&lt;/h1&gt;&lt;p&gt;関根です。&lt;br&gt;Unreal</description>
          
        
      
      
      
      <content:encoded><![CDATA[<h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>関根です。<br>Unreal Engine5を使って簡単な「色塗りゲーム」を作ってみます。</p><p>次の画像のような Blueprintを作成しながら、キャラクターが歩いた箇所のブロックの色を変える、2秒時間が経過したら元の色に戻す、といった簡易的なものを作成します。</p><p>この記事で作成するもの<br><img src="/images/20231127a/スクリーンショット_(159)_R.jpg" alt="" width="1200" height="675" loading="lazy"></p><h2 id="想定読者"><a href="#想定読者" class="headerlink" title="想定読者"></a>想定読者</h2><p>想定している読者は、Unreal Engine5をインストールした直後の初学者及び、Unreal Engine5の具体的な使い方は知らないけれども、何か手を動かしながら作ってみたい人向けに記事を作成しました。</p><p>それでは早速始めていこうと思います。</p><h1 id="新規プロジェクトを立ち上げる。"><a href="#新規プロジェクトを立ち上げる。" class="headerlink" title="新規プロジェクトを立ち上げる。"></a>新規プロジェクトを立ち上げる。</h1><p>それではまず新規プロジェクトを作成しましょう。</p><p>EpicGameLauncherの<code>ライブラリ</code>、<code>Engineバージョン</code>から、Unreal Engine5を起動します。</p><p>今回の記事では5.3.1のバージョンを使用します。<br>(右上の起動ボタンからでもUnreal Engineの起動は行えます。)<br><img src="/images/20231127a/スクリーンショット_(22)_R.jpg" alt="" width="1200" height="675" loading="lazy"></p><p>Engineを起動すると、プロジェクトを設定する画面が出てきます。</p><p>左の<code>ゲーム</code>を選択し、その中の<code>サードパーソン</code>を選択します。</p><p>そして今回は<code>GameProject</code>というフォルダの中に<code>MyProject</code>というプロジェクトを作成します。</p><p>それ以外は変更せずに作成ボタンを押します。</p><img src="/images/20231127a/スクリーンショット_(23)_R.jpg" alt="" width="1200" height="675" loading="lazy"><p>しららく待つとこちらのような画面になります。</p><p>今回は<code>サードパーソン</code>というパックを選択したため、サードパーソンゲーム(TPS)で使われる最低限のロジック(キャラクターを動かす、カメラ移動など)はすでにある状態でプロジェクトがスタートしています。</p><p>こちらの画面はデモマップなので、少しこちらでゲームを動かしてみましょう。</p><p><code>画面上部の緑色の再生ボタン</code>もしくは<code>Alt+P</code>でゲームを開始することができます。<br><img src="/images/20231127a/スクリーンショット_(32)_R.jpg" alt="" width="1200" height="675" loading="lazy"></p><p>するとキャラクターが出現し、ゲームをプレイすることができるようになります。</p><p>WASDで移動、Spaceキーでジャンプ、マウスでカメラ操作が行えます。</p><p>ゲームを終了する際は停止ボタン、もしくは<code>esc</code>キーを押すことで終了する事が出来ます。<br>(もしキャラクターの操作が出来ない場合は、ゲーム画面をクリックしてみてください。)<br><img src="/images/20231127a/スクリーンショット_(33)_R.jpg" alt="" width="1200" height="675" loading="lazy"></p><h1 id="新しいマップを作成する、光源の設置"><a href="#新しいマップを作成する、光源の設置" class="headerlink" title="新しいマップを作成する、光源の設置"></a>新しいマップを作成する、光源の設置</h1><p>今回はこちらのデモマップは使用せず、一からマップを作成しようと思います。</p><p>画面上部の<code>ファイル</code>から<code>新規レベル</code>を選択します。</p><img src="/images/20231127a/スクリーンショット_(34)_R.jpg" alt="" width="1200" height="675" loading="lazy"><p>何もないマップからゲームを作成していくため、<code>空のレベル</code>を選択します。<br><img src="/images/20231127a/スクリーンショット_(35)_R.jpg" alt="" width="1200" height="675" loading="lazy"></p><p>そうすると新規レベル(新しいマップ)が立ち上がります。</p><p>しかし文字通り空のレベルのため、光源も何もありません。そのため画面が真っ黒になってしまっています。</p><img src="/images/20231127a/スクリーンショット_(36)_R.jpg" alt="" width="1200" height="675" loading="lazy"><p>そこでまずは光源を設置しようと思います。<code>ウィンドウ</code>の<code>環境ライトミキサー</code>を選択します。</p><img src="/images/20231127a/スクリーンショット_(37)_R.jpg" alt="" width="1200" height="675" loading="lazy"><p>画面が出てきたら、<code>スカイライトを作成</code>、<code>大気ライトを作成</code>、<code>Sky Atmosphereを作成</code>、<code>ボリュメトリッククラウドを作成</code>を全てクリックします。<br><img src="/images/20231127a/スクリーンショット_(38)_R.jpg" alt="" width="1200" height="675" loading="lazy"></p><p>そうすると光源の他に空や雲がマップに作成されます。</p><p>細かい設定等も行えますが、今回はこちらで進めていきます。</p><img src="/images/20231127a/スクリーンショット_(39)_R.jpg" alt="" width="1200" height="675" loading="lazy"><p>ここまで行えたら、一度レベル(マップ)の保存をします。<code>Ctrl+shift+S</code>ですべてを保存します。</p><p>するとどこに保存するのかを問われるため、今回は<code>コンテンツ</code>直下に右クリックをして新たに<code>MyStuff</code>というフォルダを作成します。<br><img src="/images/20231127a/スクリーンショット_(104)_R.jpg" alt="" width="1200" height="675" loading="lazy"></p><p>作成したフォルダをダブルクリックし、その中に<code>ColoringMap</code>という名前で現在のレベルを保存します。<br><img src="/images/20231127a/スクリーンショット_(105)_R.jpg" alt="" width="1200" height="675" loading="lazy"></p><h1 id="ステージの床を作ろう！"><a href="#ステージの床を作ろう！" class="headerlink" title="ステージの床を作ろう！"></a>ステージの床を作ろう！</h1><p>続いて床の配置をしていきます。</p><p>今回はキャラクターが歩いたブロックの色を変えたいので、複数ブロックを使用して床を作成していきます。</p><p><code>ウィンドウ</code>から<code>アクタを配置</code>を選択します。<br><img src="/images/20231127a/スクリーンショット_(106)_R.jpg" alt="" width="1200" height="675" loading="lazy"></p><p>この画面からレベル上にオブジェクトを配置していくことができます。</p><p>この中から<code>キューブ</code>を選択し、ビューポート(画面中央の画面)にドラッグアンドドロップします。</p><img src="/images/20231127a/スクリーンショット_(107)_R.jpg" alt="" width="1200" height="675" loading="lazy"><p>すると白いキューブが配置されました。</p><p>今回はこのキューブに「操作キャラクターが上を歩いたら、色を変える」というロジックを入れたいです。</p><p>そのロジックを入れるためには、<code>Blueprint</code>というものを作成していく必要があります。</p><p>配置したキューブのBlueprintを作成するために、右下の<code>詳細</code>にある<code>+追加ボタンの右のアイコン</code>をクリックします。</p><img src="/images/20231127a/スクリーンショット_(108)_R.jpg" alt="" width="1200" height="675" loading="lazy"><p><code>ブループリント名</code>を<code>BP_Cube</code>に変更し、<code>パス</code>を先ほど作成した<code>MyStuff</code>に変更します。<br>ここまで完了したら<code>選択</code>を押します。<br><img src="/images/20231127a/スクリーンショット_(109)_R.jpg" alt="" width="1200" height="675" loading="lazy"></p><p>すると<code>BP_Cube</code>の編集画面が表示されます。<br><img src="/images/20231127a/スクリーンショット_(110)_R.jpg" alt="" width="1200" height="675" loading="lazy"></p><p>すぐにBluePrintを書いていきたいところですが、まずは<code>Collision(コリジョン)</code>と呼ばれる当たり判定をCubeに追加していきます。</p><p>「CubeのこのCollisionにキャラクターが当たったら、色を変える」というロジックを作成するために必要となります。</p><p>それでは画面左の<code>コンポーネント</code>の下にある<code>+追加</code>ボタンをクリックし、検索欄に<code>box</code>と入力します。すると<code>box collision</code>が出てくるので、そちらをクリックします。そしてこのbox Collisionの名前を<code>Trigger</code>に変更します。<code>F2</code>か、右クリックをおして<code>名前変更</code>で名称を変更できます。<br><img src="/images/20231127a/スクリーンショット_(111)_R.jpg" alt="" width="1200" height="675" loading="lazy"></p><p>これでbox collisionがTriggerという名前で生成されました。</p><p>そうしたらこのTriggerの大きさ、位置を調整していきます。</p><p>画面右の<code>詳細</code>画面上部にある<code>トランスフォーム</code>で位置を調整できます。</p><p>今回は</p><ul><li>位置をそれぞれ<code>(x, y, z) = (0, 0, 50)</code></li><li>拡大縮小をそれぞれ<code>(x, y, z) = (1.2, 1.2, 0.2)</code><br>に変更します。</li></ul><p>これでキューブの上部にTriggerが表示されるようになります。<br><img src="/images/20231127a/スクリーンショット_(112)_R.jpg" alt="" width="1200" height="675" loading="lazy"></p><p>ここまで完了したら画面上部のタブから一度ColoringMapに戻ります。</p><p>そうすると先ほど作成したTriggerが、先ほど配置したキューブに反映されているのが確認できます。<br><img src="/images/20231127a/スクリーンショット_(113)_R.jpg" alt="" width="1200" height="675" loading="lazy"></p><p>そうしましたら、こちらのキューブの位置を調整し、複製をして床を作成していきます。<br><code>詳細</code>の<code>トランスフォーム</code>を全て0に設定します。<br><img src="/images/20231127a/スクリーンショット_(114)_R.jpg" alt="" width="1200" height="675" loading="lazy"></p><p>そしたらこちらを複製していきます。<code>Alt</code>を押しながら、ギズモ(3方向に延びている矢印)をドラッグします。<br>(ギズモの中央ではなく、矢印を選択するとやりやすいです。)</p><p>これでキューブを2つに複製することができました。<br><img src="/images/20231127a/スクリーンショット_(115)_R.jpg" alt="" width="1200" height="675" loading="lazy"></p><p>同様の作業を繰り返して床を作成します。</p><p>一つずつ複製していると大変なため、<code>Controll</code>を押しながら画面上のキューブを複数選択した状態で、<code>Alt</code>キーを使って同時に複数複製していきます。<br>数が多くなったら、画面右上の<code>アウトライナー</code>で<code>shift</code>を使って複数選択すると効率的に行えます。</p><img src="/images/20231127a/スクリーンショット_(116)_R.jpg" alt="" width="1200" height="675" loading="lazy"><p>これで床は完成しました。</p><p>しかしゲームスタート地点を設定していません。そのためこのまま再生ボタンをおすとキャラクターがそのまま落下してしまいます。<code>アクタを配置</code>から<code>Player Start</code>を選択しビューポート(中央の画面)にドラッグアンドドロップします。</p><img src="/images/20231127a/スクリーンショット_(117)_R.jpg" alt="" width="1200" height="675" loading="lazy"><p>そして<code>詳細</code>の<code>トランスフォーム</code>を変更します。<br>位置を<code>(x, y, z) = (0, 0, 150)</code><br>回転を<code>(x, y, z) = (0, 0, -135)</code><br>にします。<br><img src="/images/20231127a/スクリーンショット_(118)_R.jpg" alt="" width="1200" height="675" loading="lazy"></p><p>ここまできたら<code>Alt+P(もしくは上部の再生ボタン)</code>を押して、ゲームを再生します。設置した<code>Player Start</code>の位置、向きにキャラクターが出現し、WASDで移動、Spaceでジャンプ、マウスでカメラ操作が行えるようになります。<br><img src="/images/20231127a/スクリーンショット_(119)_R.jpg" alt="" width="1200" height="675" loading="lazy"></p><h1 id="色が変わる床に修正しよう！-Blueprintの作成"><a href="#色が変わる床に修正しよう！-Blueprintの作成" class="headerlink" title="色が変わる床に修正しよう！(Blueprintの作成)"></a>色が変わる床に修正しよう！(Blueprintの作成)</h1><p>それでは実際に<code>Trigger</code>に触れたら、キューブのマテリアル(色)を変えるようなBlueprintを組んでみましょう。<br><code>BP_Cube</code>を再度開きます。</p><p>BP_Cubeを既に閉じてしまっている場合は</p><ul><li><code>Ctrl+Space</code>でコンテンツドロワーを開き、<code>MyStruff</code>から<code>BP_Cube</code>を選択</li><li>ビューポートの任意のキューブを選択して、<code>Ctrl+E</code><br>のどちらかの手順で開く事ができます。<img src="/images/20231127a/スクリーンショット_(120)_R.jpg" alt="" width="1200" height="675" loading="lazy"></li></ul><p>こちらのキューブにはまだ何もマテリアルを設定していないため、マテリアルを設定しましょう。<br><code>詳細</code>の<code>マテリアル</code>から<code>M_Basic_Floor</code>を選択します。<br>(マテリアルはどれでも良いので好きな物を選んでください。)<br><img src="/images/20231127a/スクリーンショット_(141)_R.jpg" alt="" width="1200" height="675" loading="lazy"></p><p>するとキューブにマテリアルが適用されます。<br><img src="/images/20231127a/スクリーンショット_(142)_R.jpg" alt="" width="1200" height="675" loading="lazy"></p><p>ColoringMapに戻ってみると、すべてのキューブにマテリアルが適用されていることがわかります。<br><img src="/images/20231127a/スクリーンショット_(143)_R.jpg" alt="" width="1200" height="675" loading="lazy"></p><p>それでは再度<code>BP_Cube</code>に戻ります。<br>画面上部の<code>イベントグラフ</code>を選択します。<br><img src="/images/20231127a/スクリーンショット_(144)_R.jpg" alt="" width="1200" height="675" loading="lazy"></p><p>こちらの画面でBlueprintを作成していきます。<br><img src="/images/20231127a/スクリーンショット_(145)_R.jpg" alt="" width="1200" height="675" loading="lazy"></p><p>今回はキャラクターがCubeの上を通過したら、マテリアルを変更したいので、<code>Event ActorBeginOverlap</code>を使用します。(overlapは物体同氏が重なったときに発火するものです。詳しくは<a href="https://docs.unrealengine.com/4.27/ja/InteractiveExperiences/Physics/Collision/Overview/">overlapに関する公式ドキュメント</a>を参照ください)</p><p><code>Event ActorBeginOverlap</code>の右矢印をドラッグします。<br><img src="/images/20231127a/スクリーンショット_(146)_R.jpg" alt="" width="1200" height="675" loading="lazy"></p><p>するとどのBlueprintを<code>Event ActorBeginOverlap</code>と接続したいのかを聞かれます。</p><p>今回はoverlapしたらマテリアルを変更するようにしたいので<code>Set Material(StaticMeshComponent)</code>を検索し、クリックします。検索しても出てこない場合は左上の<code>コンポーネント</code>で<code>Static Mesh Component(StaticMeshComponent)</code>をクリックするか、検索画面の右上にある<code>状況に合わせた表示</code>のチェックを外します。</p><div class="note warn" style="background: #fdf9e2; padding:16px; margin:24px 12px; border-radius:8px;">  <span class="fa fa-fw fa-check-circle"></span><p>検索すると<code>Set Material(Trigger)</code>などが出てくることもあります。<br>しかし今回overlapした後に変更したいのはキューブ自体のマテリアルです。<br>そのため、こちらは選択せずに<code>set Material(StaticMeshComponent)</code>を選択するようにしてください。</p></div><img src="/images/20231127a/スクリーンショット_(147)_R.jpg" alt="" width="1200" height="675" loading="lazy"><p>配置をするとこちらのようになります。<br>ドラッグするとBlueprintの位置を変更できるので見やすい位置に配置をしてください。<br><img src="/images/20231127a/スクリーンショット_(148)_R.jpg" alt="" width="1200" height="675" loading="lazy"></p><p><code>Set Material</code>を設置したら、どのマテリアルに変更したいのかを決める必要があります。<br><code>Set Material</code>内の<code>Material</code>から今回は<code>M_Ground_Grass</code>を選択します。</p><p>これで</p><ol><li>キャラクターがCubeのTriggerと重なったら(Event ActorBeginOverlap)</li><li><code>Static Mesh Component</code>のマテリアルを<code>M_Ground_Grass</code>に変更する(Set Material)</li></ol><p>というBlueprintを作成することができました！<br><img src="/images/20231127a/スクリーンショット_(149)_R.jpg" alt="スクリーンショット_(149)_R.jpg" width="1200" height="675" loading="lazy"></p><p>ここまで出来たら<code>再生ボタンを押す</code>もしくは<code>Alt+P</code>でゲームを再生してみましょう。<br>キャラクターが歩いた所のマテリアルが変わっていくようになっていることを確認します。<br><img src="/images/20231127a/スクリーンショット_(150)_R.jpg" alt="スクリーンショット_(150)_R.jpg" width="1200" height="675" loading="lazy"></p><h1 id="2秒経過したら元の色に戻そう"><a href="#2秒経過したら元の色に戻そう" class="headerlink" title="2秒経過したら元の色に戻そう"></a>2秒経過したら元の色に戻そう</h1><p>練習として2秒経過したらマテリアルを元に戻す、というBlueprintも作成してみましょう。</p><p>今回はoverlapが終了したら、つまりキャラクターがキューブの上から離れたら、元のマテリアルに戻す、といったBlueprintを作成しようと思います。<br>そのためには新たにイベントを追加する必要があります。</p><p>画面左下の<code>マイブループリント</code>の<code>関数</code>にある<code>オーバーライド</code>から<code>ActorEndOverlap</code>を選択します。<br><img src="/images/20231127a/スクリーンショット_(151)_R.jpg" alt="スクリーンショット_(151)_R.jpg" width="1200" height="675" loading="lazy"></p><p>すると画面に<code>Event ActorEndOverlap</code>が追加されます。<br><img src="/images/20231127a/スクリーンショット_(152)_R.jpg" alt="スクリーンショット_(152)_R.jpg" width="1200" height="675" loading="lazy"></p><p>そうしたら<code>Event ActorEndOverlap</code>の右矢印をドラッグします。<br>前述のとおり、この<code>Event ActorEndOverlap</code>が呼び出されるのはキャラクターがキューブの上から離れたとき、になります。<br>離れてから2秒後にマテリアルを変更したいため、任意秒処理を遅らせる事ができる<code>Delay</code>を選択します。<br><img src="/images/20231127a/スクリーンショット_(153)_R.jpg" alt="スクリーンショット_(153)_R.jpg" width="1200" height="675" loading="lazy"></p><p><code>Delay</code>の設置が出来たら、<code>Duration</code>を2.0に設定し、2秒間遅らせるようにします。<br><img src="/images/20231127a/スクリーンショット_(157)_R.jpg" alt="スクリーンショット_(157)_R.jpg" width="1200" height="675" loading="lazy"></p><p>その後の処理は先ほどと同じになります。<br><code>Delay</code>の右矢印をドラッグし、<code>Set Material(Static Mesh Component)</code>を選択します。<br>今回の<code>Material</code>は<a href="#%E8%89%B2%E3%81%8C%E5%A4%89%E3%82%8F%E3%82%8B%E5%BA%8A%E3%81%AB%E4%BF%AE%E6%AD%A3%E3%81%97%E3%82%88%E3%81%86%EF%BC%81(Blueprint)">こちら</a>で設定した<code>M_Basic_Floor</code>を選択します。<br><img src="/images/20231127a/スクリーンショット_(158)_R.jpg" alt="スクリーンショット_(158)_R.jpg" width="1200" height="675" loading="lazy"></p><p>これで今回作成するBlueprintは以上になります。<br><code>Alt+P</code>でゲームを再生すると、歩いた箇所が2秒後に元の色に戻るようになりました。<br>これで簡易的な色塗りゲームが完成しました。<br><img src="/images/20231127a/スクリーンショット_(159)_R_2.jpg" alt="スクリーンショット_(159)_R.jpg" width="1200" height="675" loading="lazy"></p><h1 id="終わりに"><a href="#終わりに" class="headerlink" title="終わりに"></a>終わりに</h1><p>この記事では以下の事を行いました。</p><ul><li>プロジェクトの立ち上げ方</li><li>レベルをどのように作るのか</li><li>空などの設置方法</li><li>アクタ(オブジェクト)の配置方法、位置の変え方など</li><li>Blueprintを使った色塗りゲームのロジック開発</li></ul><p>かなり初歩的な所ではありますが、UnrealEngineの基本的な所に触れることができたのではないかと思います。</p><p>ここから自分で拡張してみても面白いかもしれません。</p><ul><li>ステージが狭いのでもう少し広げてみる</li><li>ジャンプしたときは別のマテリアルに変える</li><li>色を変えるではなく、歩いたところのブロックが落下するようにしてみる</li></ul><p>今回使用したノード(<code>Delay</code>や<code>Set Material</code>の事)は2つだけです。ノードはまだまだ沢山あるのでぜひ調べてみてください。</p><p>最後まで読んでいただきありがとうございました。</p>]]></content:encoded>
      
      
      <category domain="https://future-architect.github.io/categories/Infrastructure/">Infrastructure</category>
      
      
      <category domain="https://future-architect.github.io/tags/%E5%88%9D%E5%BF%83%E8%80%85/">初心者</category>
      
      <category domain="https://future-architect.github.io/tags/UnrealEngine5/">UnrealEngine5</category>
      
      <category domain="https://future-architect.github.io/tags/%E3%82%B2%E3%83%BC%E3%83%A0%E5%88%B6%E4%BD%9C/">ゲーム制作</category>
      
      <category domain="https://future-architect.github.io/tags/UnrealEngine/">UnrealEngine</category>
      
      
      <comments>https://future-architect.github.io/articles/20231127a/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>学習のSHA 〜ハッシュ関数の基本と安全性について学ぶ〜</title>
      <link>https://future-architect.github.io/articles/20231124a/</link>
      <guid>https://future-architect.github.io/articles/20231124a/</guid>
      <pubDate>Thu, 23 Nov 2023 15:00:00 GMT</pubDate>
      
        
        
          
          
      <description>&lt;img src=&quot;/images/20231124a/top.jpg&quot; alt=&quot;&quot; width=&quot;800&quot;</description>
          
        
      
      
      
      <content:encoded><![CDATA[<img src="/images/20231124a/top.jpg" alt="" width="800" height="800"><p>こんにちは。ペンギンになりたいエンジニアの島ノ江です。</p><p>普段はCSIGというサイバーセキュリティのグループに所属していて、「<a href="https://vuls.biz/">FutureVuls</a>」という脆弱性管理サービスの開発・営業などを行なっています。</p><p><a href="/articles/20231030a/">秋のブログ週間</a>の連載の17本目、「学習のSHA」というタイトルです。</p><p>暗号技術について学んでいると「<strong>ハッシュ値</strong>」という言葉に出会いますが、あまり詳細を追ったことはありませんでした。そこで今回はハッシュ関数およびその代表としてSHAに関する歴史や種類についてまとめます。念のため注意しますが、本記事と某アニメとは何も関係ありません。本当に。</p><p>本記事は次の2つを一次情報として参照しています。</p><ul><li>光成滋生　（2021）. 暗号と認証のしくみと理論がこれ1冊でしっかりわかる教科書　技術評論社（<a href="https://amzn.asia/d/2z81ZzR">Amazon</a>）</li><li>NIST の 「Hash Functions」 プロジェクト（<a href="https://csrc.nist.gov/projects/hash-functions">公式webページ</a>）</li></ul><p>せっかくなので、巻末に読書感想文として簡単に書籍の紹介もします。</p><h2 id="寄稿の背景"><a href="#寄稿の背景" class="headerlink" title="寄稿の背景"></a>寄稿の背景</h2><p>本記事を書こうと思ったのは、ふと暗号技術の安全性に思いを馳せたことからでした。</p><p>11月2日(木)に斉藤さんが「<a href="/articles/20231102a/">初心者が暗号の基礎と歴史を勉強して見た</a>」というタイトルで寄稿されています。これはシーザー暗号などのいわゆる古典暗号から公開鍵暗号などへの歴史を辿っている記事です。</p><p>このように暗号技術が変化してきたのには、技術などの発展に伴い暗号技術の安全性が変わっているからです。参考書籍にも「暗号は新しい安全な方式を提案する人と、それを解読しようとする人の両輪でよりよいものになっている」と書かれています。</p><p>では、「暗号技術のセキュリティ的な安全性とは？」という興味が湧くので、暗号技術の安全性に関する理解を深めよう、という流れでした。</p><h2 id="ハッシュ関数とは"><a href="#ハッシュ関数とは" class="headerlink" title="ハッシュ関数とは"></a>ハッシュ関数とは</h2><p><strong>ハッシュ関数</strong>とは「文章や画像・動画などの任意のデータから、予め決められた範囲内の値を計算する関数」です。ハッシュ関数は決定的アルゴリズムで、同じ入力値に対して常に同じ値を返します。この入力値をメッセージ、出力のことをハッシュ値、ダイジェストなどとも言います。</p><p>ハッシュ関数は様々な場面で利用されていて、具体的には次のようなものがあります。</p><ul><li>連想配列（JavaでのHashMapなど）</li><li>データベース検索(ハッシュインデックスによる完全一致検索など）</li><li>デジタル署名（送信者の認証など）</li><li>ブロックチェーン技術（データの整合性の確認など）</li></ul><p>このハッシュ関数の中で代表的なのが、本稿のタイトルにある「<strong>SHA</strong>」(Secure Hash Algorithm)です。これはNISTにより標準化されているハッシュアルゴリズムで、現代で広く用いられています。「エス・エイチ・エー」「シャー」と読まれていて、私は読みやすさから特にSHA256などは「シャー・ニゴロ」と読んでいます。</p><p>ハッシュ関数は現代で広く利用されている技術ですが、本記事では特に「<strong>暗号学的ハッシュ関数</strong>」について述べます。<br>暗号学的ハッシュ関数とは、さらに以下のような性質を持つハッシュ関数を指します。</p><h3 id="出力サイズが一定"><a href="#出力サイズが一定" class="headerlink" title="出力サイズが一定"></a>出力サイズが一定</h3><p>入力が1バイトであろうと4ギガバイトであろうと、出力されるサイズは全く同じになる性質があります。</p><p>入力データのサイズによらずハッシュ値のサイズが同じだと、処理の効率性や互換性が向上します。</p><p>また、ハッシュ値のサイズが同じでないと、出力値から入力値の情報が得られてしまい、暗号分析にも悪用されかねません。</p><img src="/images/20231124a/Hash_1.png" alt="Hash_1.png" width="865" height="260" loading="lazy"><h3 id="一方向性（原像計算困難性）"><a href="#一方向性（原像計算困難性）" class="headerlink" title="一方向性（原像計算困難性）"></a>一方向性（原像計算困難性）</h3><p>入力値からハッシュ値を求めることは簡単だが、その逆が難しい、という性質です。</p><p>ハッシュ値は分かるが元のメッセージが分からないという性質から、パスワードを比較的安全に保護することなどに利用されています。</p><img src="/images/20231124a/Hash_2.png" alt="Hash_2.png" width="868" height="188" loading="lazy"><h3 id="衝突困難性"><a href="#衝突困難性" class="headerlink" title="衝突困難性"></a>衝突困難性</h3><p>異なる2個の入力値から同じハッシュ値を得ること（衝突）が難しい（無視できる程度の確率である）、という性質です。</p><p>この性質を利用して、データを送る際にその入力値から計算したハッシュ値を併せて送ることで、データが改竄されていないかを確認することができます。</p><p>これは、入力データが1ビットでも異なると、全く異なるハッシュ値が出力されるためです。</p><img src="/images/20231124a/Hash_3.png" alt="Hash_3.png" width="860" height="265" loading="lazy"><p>また、衝突困難性には「第二原像計算困難性」という性質があります。</p><p>これは、あるハッシュ値が与えられた時に、それと同じハッシュ値になる別のデータを見つけるのが難しい、という性質です。</p><h4 id="小噺"><a href="#小噺" class="headerlink" title="小噺"></a>小噺</h4><p>その具体例として、学生時代の確率論の授業で、こんな確率を計算したことはあるでしょうか。</p><blockquote><p>(1) N人が所属するクラスの中で、自分と同じ誕生日の人がいる確率<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="6.209ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 2744.6 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="mn" transform="translate(675,-150) scale(0.707)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g><g data-mml-node="mo" transform="translate(1078.6,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mi" transform="translate(1467.6,0)"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path></g><g data-mml-node="mo" transform="translate(2355.6,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></svg></mjx-container>は？<br>(2) N人が所属するクラスの中で、誕生日が同じペアが存在する確率<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="6.209ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 2744.6 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="mn" transform="translate(675,-150) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g><g data-mml-node="mo" transform="translate(1078.6,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mi" transform="translate(1467.6,0)"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path></g><g data-mml-node="mo" transform="translate(2355.6,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></svg></mjx-container>は？</p></blockquote><p>(1)は自分と誕生日が同じ人を探すので第二原像を求める例、(2)はクラスの異なる2人で誕生日が一致するかを探すので衝突を見つける例になります。</p><p>計算自体は比較的単純なので、秋の夜長に学生時代に思いを馳せてやってみましょう。</p><ul><li><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.816ex;" xmlns="http://www.w3.org/2000/svg" width="21.932ex" height="2.79ex" role="img" focusable="false" viewBox="0 -872.7 9693.8 1233.3"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="mn" transform="translate(675,-150) scale(0.707)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g><g data-mml-node="mo" transform="translate(1078.6,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mi" transform="translate(1467.6,0)"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path></g><g data-mml-node="mo" transform="translate(2355.6,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g><g data-mml-node="mo" transform="translate(3022.3,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mn" transform="translate(4078.1,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(4800.3,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mo" transform="translate(5800.6,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mfrac" transform="translate(6189.6,0)"><g data-mml-node="mn" transform="translate(220,394) scale(0.707)"><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path data-c="36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z" transform="translate(500,0)"></path><path data-c="34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z" transform="translate(1000,0)"></path></g><g data-mml-node="mn" transform="translate(220,-345) scale(0.707)"><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path data-c="36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z" transform="translate(500,0)"></path><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z" transform="translate(1000,0)"></path></g><rect width="1260.7" height="60" x="120" y="220"></rect></g><g data-mml-node="msup" transform="translate(7690.2,0)"><g data-mml-node="mo"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g><g data-mml-node="TeXAtom" transform="translate(422,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path></g><g data-mml-node="mo" transform="translate(888,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mn" transform="translate(1666,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g></g></g></g></svg></mjx-container></li><li><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -1.439ex;" xmlns="http://www.w3.org/2000/svg" width="25.655ex" height="3.476ex" role="img" focusable="false" viewBox="0 -900.3 11339.4 1536.5"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="mn" transform="translate(675,-150) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g><g data-mml-node="mo" transform="translate(1078.6,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mi" transform="translate(1467.6,0)"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path></g><g data-mml-node="mo" transform="translate(2355.6,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g><g data-mml-node="mo" transform="translate(3022.3,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mn" transform="translate(4078.1,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(4800.3,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mfrac" transform="translate(5800.6,0)"><g data-mml-node="mrow" transform="translate(2140.8,394) scale(0.707)"><g data-mml-node="mn"><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path data-c="36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z" transform="translate(500,0)"></path><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z" transform="translate(1000,0)"></path></g><g data-mml-node="mo" transform="translate(1500,0)"><path data-c="21" d="M78 661Q78 682 96 699T138 716T180 700T199 661Q199 654 179 432T158 206Q156 198 139 198Q121 198 119 206Q118 209 98 431T78 661ZM79 61Q79 89 97 105T141 121Q164 119 181 104T198 61Q198 31 181 16T139 1Q114 1 97 16T79 61Z"></path></g></g><g data-mml-node="mrow" transform="translate(220,-459.4) scale(0.707)"><g data-mml-node="msup"><g data-mml-node="mn"><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path data-c="36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z" transform="translate(500,0)"></path><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z" transform="translate(1000,0)"></path></g><g data-mml-node="mi" transform="translate(1533,393.1) scale(0.707)"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path></g></g><g data-mml-node="mo" transform="translate(2210.9,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mo" transform="translate(2988.9,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mn" transform="translate(3377.9,0)"><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path data-c="36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z" transform="translate(500,0)"></path><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z" transform="translate(1000,0)"></path></g><g data-mml-node="mo" transform="translate(4877.9,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mi" transform="translate(5655.9,0)"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path></g><g data-mml-node="mo" transform="translate(6543.9,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g><g data-mml-node="mo" transform="translate(6932.9,0)"><path data-c="21" d="M78 661Q78 682 96 699T138 716T180 700T199 661Q199 654 179 432T158 206Q156 198 139 198Q121 198 119 206Q118 209 98 431T78 661ZM79 61Q79 89 97 105T141 121Q164 119 181 104T198 61Q198 31 181 16T139 1Q114 1 97 16T79 61Z"></path></g></g><rect width="5298.9" height="60" x="120" y="220"></rect></g></g></g></svg></mjx-container></li></ul><p>です。<a href="https://ja.wikipedia.org/wiki/%E8%AA%95%E7%94%9F%E6%97%A5%E3%81%AE%E3%83%91%E3%83%A9%E3%83%89%E3%83%83%E3%82%AF%E3%82%B9">wikipedia</a>にちょうどいいグラフがあったので示します。</p><img src="/images/20231124a/image.png" alt="image" width="1200" height="773" loading="lazy"><p>おおよそ<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="10.611ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 4690.1 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="mn" transform="translate(675,-150) scale(0.707)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g><g data-mml-node="mo" transform="translate(1078.6,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mn" transform="translate(1467.6,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z" transform="translate(500,0)"></path></g><g data-mml-node="mo" transform="translate(2467.6,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g><g data-mml-node="mo" transform="translate(3134.3,0)"><path data-c="223C" d="M55 166Q55 241 101 304T222 367Q260 367 296 349T362 304T421 252T484 208T554 189Q616 189 655 236T694 338Q694 350 698 358T708 367Q722 367 722 334Q722 260 677 197T562 134H554Q517 134 481 152T414 196T355 248T292 293T223 311Q179 311 145 286Q109 257 96 218T80 156T69 133Q55 133 55 166Z"></path></g><g data-mml-node="mn" transform="translate(4190.1,0)"><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z"></path></g></g></g></svg></mjx-container>%に対して、 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="11.742ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 5190.1 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="mn" transform="translate(675,-150) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g><g data-mml-node="mo" transform="translate(1078.6,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mn" transform="translate(1467.6,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z" transform="translate(500,0)"></path></g><g data-mml-node="mo" transform="translate(2467.6,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g><g data-mml-node="mo" transform="translate(3134.3,0)"><path data-c="223C" d="M55 166Q55 241 101 304T222 367Q260 367 296 349T362 304T421 252T484 208T554 189Q616 189 655 236T694 338Q694 350 698 358T708 367Q722 367 722 334Q722 260 677 197T562 134H554Q517 134 481 152T414 196T355 248T292 293T223 311Q179 311 145 286Q109 257 96 218T80 156T69 133Q55 133 55 166Z"></path></g><g data-mml-node="mn" transform="translate(4190.1,0)"><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(500,0)"></path></g></g></g></svg></mjx-container>%となります。</p><p>自分と同じ誕生日の人を探すと大変なのに、同じ誕生日になるペアが見つかるのはそれほど不思議ではない、というやや直感的でない結果が得られます（「誕生日のパラドックス」というそうです）。</p><p>このように、一般的には第二原像を見つけることより衝突を見つけることの方がずっと簡単です。</p><h2 id="暗号技術の標準化を目指す組織とハッシュアルゴリズムの種類"><a href="#暗号技術の標準化を目指す組織とハッシュアルゴリズムの種類" class="headerlink" title="暗号技術の標準化を目指す組織とハッシュアルゴリズムの種類"></a>暗号技術の標準化を目指す組織とハッシュアルゴリズムの種類</h2><p>このような暗号技術に関して、その安全性を監視・評価している機関が国内外にあります。</p><p>本資料で参考にしている <a href="https://www.nist.gov/">NIST</a>（National Institute of Standards and Technology：アメリカ国立標準技術研究所） は、ITL(Information Technology Laboratory：情報技術研究所) という研究部門で、このセキュリティに関する標準化をおこなっています。</p><p>日本では、<a href="https://www.cryptrec.go.jp/">CRYPTREC</a>（CRYPTography Research and Evaluation Committees：暗号技術評価委員会） という機関が、国内の電子政府推奨暗号の安全性を評価・監視しています。</p><p>NISTは標準のハッシュ関数として、 <a href="https://csrc.nist.gov/pubs/fips/180-4/upd1/final">FIPS 180-4</a> と <a href="https://csrc.nist.gov/pubs/fips/202/final">FIPS 202</a> を公開しています。日本国内でも、<a href="https://www.cryptrec.go.jp/list.html">電子政府推奨暗号リスト</a>としてこれらの利用を公開しています。</p><p>FIPS 180-4では、以下の7つが推奨されるハッシュ関数として規定されました。なお、2011年にはSHA-1の使用を非推奨にする発表を出し、2022年12月にはSHA-1を廃止する発表が出ています。（<a href="https://csrc.nist.gov/news/2022/nist-transitioning-away-from-sha-1-for-all-apps">参考</a>）</p><ul><li>SHA-1</li><li>SHA-2（SHA-224, SHA-256, SHA-384, SHA-512, SHA-512/224, SHA-512/256)</li></ul><p>SHAの後ろについている数字がハッシュ関数の出力ビット数です。SHA-256は長さが256ビットのハッシュ値を返す、という形です。これらは要求されるセキュリティレベルによって使い分けられます。</p><p>FIPS-202では、SHA-2に加えてSHA-3が追加されました。SHAKEはSHA3を拡張したハッシュ関数で、出力のハッシュ値をセキュリティレベルに応じて変更することができます。</p><ul><li>固定長を返すハッシュ関数： SHA3-224, SHA3-256, SHA3-384, SHA3-512</li><li>可変長を返すハッシュ関数： SHAKE128, SHAKE256</li></ul><h2 id="ハッシュ関数の歴史"><a href="#ハッシュ関数の歴史" class="headerlink" title="ハッシュ関数の歴史"></a>ハッシュ関数の歴史</h2><p>ここでは主なハッシュ関数の歴史に触れます。画像は参考図書にも掲載されているものです。（<a href="https://www.slideshare.net/herumi/6-250590292">引用元</a>）</p><img src="/images/20231124a/hashFunction_history.png" alt="hashFunction_history.png" width="937" height="386" loading="lazy"><ul><li>1992年にMD5が登場しましたが、暗号学的ハッシュ関数ではなかったこともあり、12年後に衝突困難性が破られてしまいました。メッセージから固定値(128bit)のハッシュ値を生成します。この関数は高速で単純だったことから、メッセージの整合性確認などで広く用いられたようです。</li><li>SHA-1は1995年に標準化され、理論的な攻撃可能性の提案に10年かかり、2017年には衝突困難性が破られました。先述の通り、2011年にはSHA-1の使用を非推奨にする発表を出し、2022年12月にはSHA-1を廃止する流れになっています。</li><li>SHA-2は2001年に標準化され、その中のSHA-256は現在も推奨暗号として広く利用されています。</li><li>SHA-3は、SHA-1の攻撃突破が危惧された頃に、これまでとは異なる構造のアルゴリズムが必要になるだろうという危惧から考えられたハッシュ関数群です。しかし幸いなことにSHA-2の衝突困難性がなかなか破られておらず、あまり積極的には利用されていません。</li></ul><p>SHA-2, SHA-3の理論的な側面まで深掘りをしたかったのですが、<del>それを書くには余白が足りず</del> 細かくて時間が足りないので、ここでは割愛します。気になる方は、参考書籍やNISTのFIPSの資料、および参考書籍の巻末に掲載されている資料を参照してください。 </p><h2 id="暗号技術の安全性とは"><a href="#暗号技術の安全性とは" class="headerlink" title="暗号技術の安全性とは"></a>暗号技術の安全性とは</h2><p>暗号技術をせっかく使うなら、理想的には「どうやっても絶対に破られない暗号」を使いたいです。しかし、小さな秘密鍵を使って大きな平文を暗号化しようとする以上、理論的にこのような理想の暗号技術を作ることはできません。そこで、「理想の安全性はないけれども現実的には破れないだろう」という暗号を考え、それを測る指標として「<strong>セキュリティパラメータ</strong>」というもので計算コストを考えます。</p><p>例えば、共通鍵暗号では鍵長が N ビットであればその種類は <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="2.74ex" height="1.914ex" role="img" focusable="false" viewBox="0 -846 1210.9 846"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="mi" transform="translate(533,363) scale(0.707)"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path></g></g></g></g></svg></mjx-container> 通りあるので、ブルートフォース法（しらみつぶしにパターンを試す）での計算量が <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="6.226ex" height="2.48ex" role="img" focusable="false" viewBox="0 -846 2751.9 1096"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path></g><g data-mml-node="mo" transform="translate(763,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="msup" transform="translate(1152,0)"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="mi" transform="translate(533,363) scale(0.707)"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path></g></g><g data-mml-node="mo" transform="translate(2362.9,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></svg></mjx-container> となります。例えば鍵長が 128 ビットであれば、これはおおよそ <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.05ex;" xmlns="http://www.w3.org/2000/svg" width="7.947ex" height="2.005ex" role="img" focusable="false" viewBox="0 -864 3512.6 886"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path></g><g data-mml-node="mo" transform="translate(722.2,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="msup" transform="translate(1722.4,0)"><g data-mml-node="mn"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(500,0)"></path></g><g data-mml-node="TeXAtom" transform="translate(1033,393.1) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path data-c="38" d="M70 417T70 494T124 618T248 666Q319 666 374 624T429 515Q429 485 418 459T392 417T361 389T335 371T324 363L338 354Q352 344 366 334T382 323Q457 264 457 174Q457 95 399 37T249 -22Q159 -22 101 29T43 155Q43 263 172 335L154 348Q133 361 127 368Q70 417 70 494ZM286 386L292 390Q298 394 301 396T311 403T323 413T334 425T345 438T355 454T364 471T369 491T371 513Q371 556 342 586T275 624Q268 625 242 625Q201 625 165 599T128 534Q128 511 141 492T167 463T217 431Q224 426 228 424L286 386ZM250 21Q308 21 350 55T392 137Q392 154 387 169T375 194T353 216T330 234T301 253T274 270Q260 279 244 289T218 306L210 311Q204 311 181 294T133 239T107 157Q107 98 150 60T250 21Z" transform="translate(500,0)"></path></g></g></g></g></g></svg></mjx-container> の計算量で、これはスーパーコンピュータでも数兆年はかかる程度の計算量です。そのため、これは現実的には安全だろうと考えられます。</p><p>ハッシュ関数では、衝突困難性を破るのに必要なコストはおおよそ <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="7.826ex" height="2.587ex" role="img" focusable="false" viewBox="0 -893.3 3459 1143.3"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path></g><g data-mml-node="mo" transform="translate(763,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="msup" transform="translate(1152,0)"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="TeXAtom" transform="translate(533,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(888,0)"><g data-mml-node="mo"><path data-c="2F" d="M423 750Q432 750 438 744T444 730Q444 725 271 248T92 -240Q85 -250 75 -250Q68 -250 62 -245T56 -231Q56 -221 230 257T407 740Q411 750 423 750Z"></path></g></g><g data-mml-node="mn" transform="translate(1388,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g></g><g data-mml-node="mo" transform="translate(3070,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></svg></mjx-container> になっています。SHA-256は256ビットのハッシュ値を返すため、128ビットセキュリティになります。参考図書によれば「現在は128ビットセキュリティなら数十年は安全だろう」と考えられているそうです。それもあり、SHA-256は十分なセキュリティ要件を持ちつつ使いやすいということから広く利用されているようです。</p><p>SHA-512の方が安全なのに、なぜSHA-256の方が広く利用されているのか？という点については、次のような背景があるようです。</p><ul><li>SHA-512の方がより安全ではあるが、SHA-256でも現時点では十分なセキュリティレベルがあり、かつその方がリソース使用量が小さくて済むため</li><li>広く利用されており、他のシステムやプロトコルとの互換性があるため</li><li>暗号技術が広く利用されているのはそれだけ検証が多くなされていることでもあり、信頼感があるため</li></ul><p>なお参考書籍によると、SHA-256およびSHA-512での内部構造を追っていくと、64ビットCPUで大きなデータを扱う場合には内部処理過程の関係でSHA-256よりSHA-512の方が高速に計算できるようです。これは知らなかったので、内部構造を知って驚きました。</p><p>なお、このような安全性というのはあくまで「現在の技術・攻撃手法の範囲で」安全というものであり、未来永劫安全というわけではありません。例えば、昨今発展している量子計算機を用いるとSHA-2の攻撃可能性が進展している研究もあります。また、よりよい攻撃手法が発見されて、セキュリティパラメータが下がる可能性もあります。ある日突然攻撃手法が発展し、人類は思い出した…ということになる可能性もあるので、注意は必要です。</p><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>本稿では暗号学的ハッシュ関数について整理し、その種類および歴史を追いました。自分はSHA-256には馴染みがありましたが、SHA3についてはあまり知らず、本稿を書く際に色々と学ぶことができて良い機会となりました。</p><p>あまり実装的な内容は書かないとのことなので、今回はコードについても記載していません。例えばGo言語では、SHA-256などは <a href="https://pkg.go.dev/crypto">crypto</a> パッケージに含まれているので、ご参照ください。</p><p>詳細を書ききれていないところも多くあるため、引用資料先のページなども参考にしていただけると幸いです。それでは快適なハッシュライフ(?)をお送りください。</p><h2 id="終わりに書籍の紹介"><a href="#終わりに書籍の紹介" class="headerlink" title="終わりに書籍の紹介"></a>終わりに書籍の紹介</h2><p>本書は広く「暗号と認証」をテーマに解説している参考書です。全部で9章で構成されており、各章がいくつかのセクションごとに分かれていてまとめもあるため、テンポ良く読み進めることができます。</p><p>第3章から「共通鍵暗号」「公開鍵暗号」「認証」の解説があり、最終章には「高機能な暗号技術」と題してゼロ知識証明や量子コンピュータなどの解説がされます。</p><p>個人的に思う本書の大きな特徴は、数式の解説も交えて暗号技術を解説するという点にあると思います。離散対数問題や楕円曲線暗号といった、高度な暗号技術を学ぶために必要な概念の基本も説明されています。暗号技術を学ぶにはどうしても高度な数学が絡みますが、本書はその部分をなるべく平易に解説していて、暗号技術を学習するハードルを下げている点が高評価です。</p><p>ただし、その分読み手を選んでしまう本かなという印象です。理系出身の方や、基本情報技術者試験などを経てより詳細に暗号技術について知りたい、という意欲のある方には良いかもしれません。巻末も充実しているので、本書を起点にさらに深く学習していくのに役立つ本だと思います。</p><p>本記事はこれで終わります。最後まで読んでいただきありがとうございました。</p><p>アイキャッチ画像はBing Image Creatorを利用しました。</p>]]></content:encoded>
      
      
      <category domain="https://future-architect.github.io/categories/Infrastructure/">Infrastructure</category>
      
      
      <category domain="https://future-architect.github.io/tags/Security/">Security</category>
      
      <category domain="https://future-architect.github.io/tags/%E3%83%8F%E3%83%83%E3%82%B7%E3%83%A5%E9%96%A2%E6%95%B0/">ハッシュ関数</category>
      
      
      <comments>https://future-architect.github.io/articles/20231124a/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>「リーダブルコード」を読んだ感想</title>
      <link>https://future-architect.github.io/articles/20231122a/</link>
      <guid>https://future-architect.github.io/articles/20231122a/</guid>
      <pubDate>Tue, 21 Nov 2023 15:00:00 GMT</pubDate>
      
        
        
          
          
      <description>&lt;img src=&quot;/images/20231122a/81+3DpjuMdL._SL1500_.jpg&quot; alt=&quot;&quot; width=&quot;500&quot; height=&quot;709&quot;&gt;

&lt;h1 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot;</description>
          
        
      
      
      
      <content:encoded><![CDATA[<img src="/images/20231122a/81+3DpjuMdL._SL1500_.jpg" alt="" width="500" height="709"><h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>こんにちは、2022年4月新卒入社、流通製造グループ所属の藤戸四恩です。<br><a href="/articles/20231030a/">秋のブログ週間2023</a>の16本目は「リーダブルコード」を読んでみた感想です。</p><p>最近ソースコードを書くことが多く、可読性の高いコードを書くことを意識していますが、いまいち正解がわからず、積読してあった「リーダブルコード」を読んでみたので、印象に残った箇所を紹介したいと思います。</p><h1 id="本書について"><a href="#本書について" class="headerlink" title="本書について"></a>本書について</h1><blockquote><p>美しいコードを見ると感動する。優れたコードは見た瞬間に何をしているかが伝わってくる。そういうコードは使うのが楽しいし、自分のコードもそうあるべきだと思わせてくれる。本書の目的は、君のコードを良くすることだ。（本書「はじめに」より）<br>コードは理解しやすくなければならない。本書はこの原則を日々のコーディングの様々な場面に当てはめる方法を紹介します。名前の付け方、コメントの書き方など表面上の改善について。コードを動かすための制御フロー、論理式、変数などループとロジックについて。またコードを再構成するための方法。さらにテストの書き方などについて、楽しいイラストと共に説明しています。日本語版ではRubyやgroongaのコミッタとしても著名な須藤功平氏による解説を収録。<br><a href="https://www.oreilly.co.jp/books/9784873115658/">引用元 - O’REILLY</a></p></blockquote><p>コードを書く上で命名の考え方や適切なコメントの書き方などが説明されており、総ページ数も200ページ少しと、ちょうどよい分量です。下記の通り15章から構成されています。</p><p>第1章　理解しやすいコード<br>第2章　名前に情報を詰め込む<br>第3章　誤解されない名前<br>第4章　美しさ<br>第5章　コメントすべきことを知る<br>第6章　コメントは正確で簡潔に<br>第7章　制御フローを読みやすくする<br>第8章　巨大な式を分割する<br>第9章　変数と読みやすさ<br>第10章 無関係な下位問題を抽出する<br>第11章 一度に１つのことを<br>第12章 コードに思いを込める<br>第13章 短いコードを書く<br>第14章 テストと読みやすさ<br>第15章 「分&#x2F;時間カウンタ」を設計・実装する</p><h1 id="印象に残った箇所"><a href="#印象に残った箇所" class="headerlink" title="印象に残った箇所"></a>印象に残った箇所</h1><h2 id="不要な単語を捨てる"><a href="#不要な単語を捨てる" class="headerlink" title="不要な単語を捨てる"></a>不要な単語を捨てる</h2><blockquote><p>名前に含まれる単語を削除しても情報が全く損なわれないこともある。例えば、ConvertToString()を短くしてToString()にしても、必要な情報は何も損なわれない。同様にDoServeLoop()をServeLoop()に変えても明確さは同じだ。</p></blockquote><p>個人的には、型変換のメソッドを作成する際に、メソッド名にConvertをつけることが多かったため、命名するときに不要な情報を削除することも必要だと思いました。</p><h2 id="一貫性のある簡潔な改行位置"><a href="#一貫性のある簡潔な改行位置" class="headerlink" title="一貫性のある簡潔な改行位置"></a>一貫性のある簡潔な改行位置</h2><p>以下は、Javaで書かれた任意の速度のネットワークに接続したときに、プログラムがどのように動くかを評価するコードのサンプルです。 また横幅80文字までというコーディング規約があるという想定です。<br>※書籍P.44参考</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PerformanceTester</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">TcpConnectionSimulator</span> <span class="variable">wifi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TcpConnectionSimulator</span>(</span><br><span class="line">        <span class="number">500</span>, <span class="comment">//接続速度(Kbps)</span></span><br><span class="line">        <span class="number">80</span>,  <span class="comment">//平均遅延時間(ms)</span></span><br><span class="line">        <span class="number">200</span>,  <span class="comment">//遅延時間(ms)</span></span><br><span class="line">        <span class="number">1</span> <span class="comment">//パケットロス率(%)</span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">TcpConnectionSimulator</span> <span class="variable">t3_fiber</span> <span class="operator">=</span> </span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">TcpConnectionSimulator</span>(</span><br><span class="line">            <span class="number">4500</span>, <span class="comment">//接続速度(Kbps)</span></span><br><span class="line">            <span class="number">10</span>,  <span class="comment">//平均遅延時間(ms)</span></span><br><span class="line">            <span class="number">0</span>,  <span class="comment">//遅延時間(ms)</span></span><br><span class="line">            <span class="number">0</span> <span class="comment">//パケットロス率(%)</span></span><br><span class="line">        );</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">TcpConnectionSimulator</span> <span class="variable">cell</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TcpConnectionSimulator</span>(</span><br><span class="line">        <span class="number">100</span>, <span class="comment">//接続速度(Kbps)</span></span><br><span class="line">        <span class="number">400</span>,  <span class="comment">//平均遅延時間(ms)</span></span><br><span class="line">        <span class="number">250</span>,  <span class="comment">//遅延時間(ms)</span></span><br><span class="line">        <span class="number">5</span> <span class="comment">//パケットロス率(%)</span></span><br><span class="line">    );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>上記の実装だと、コーデンディング規約により、余計な改行が入っているかつ同じコメントがくり返されているため、下記のようにコメントを最上部に移動して、仮引数を一行で書くように書籍では提案されています。</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PerformanceTester</span> &#123;</span><br><span class="line">    <span class="comment">// TcpConnectionSimulator(throughput, latency, jitter, packet_loss)</span></span><br><span class="line">    <span class="comment">//                          [kbps]      [ms]    [ms]    [percent]</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">TcpConnectionSimulator</span> <span class="variable">wifi</span> <span class="operator">=</span> </span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">TcpConnectionSimulator</span>(<span class="number">500</span>, <span class="number">80</span>, <span class="number">200</span>, <span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">TcpConnectionSimulator</span> <span class="variable">t3_fiber</span> <span class="operator">=</span> </span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">TcpConnectionSimulator</span>(<span class="number">4500</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">TcpConnectionSimulator</span> <span class="variable">cell</span> <span class="operator">=</span></span><br><span class="line">         <span class="keyword">new</span> <span class="title class_">TcpConnectionSimulator</span>(<span class="number">100</span>, <span class="number">400</span>, <span class="number">250</span>, <span class="number">5</span>);</span><br><span class="line">&#125;;   </span><br></pre></td></tr></table></figure><p>個人的には、見やすくなったと感じたが、あまり見ないコメントの記載方法(自分が知らないだけかもしれないですが)だっため、</p><p>同じコメントが続くようなときは上記を参考にコメントを記載したいと思いました。</p><h2 id="制御フローを読みやすくする"><a href="#制御フローを読みやすくする" class="headerlink" title="制御フローを読みやすくする"></a>制御フローを読みやすくする</h2><p>下記の二つの実装はどちらがよみやすいでしょうか？</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// No.1</span></span><br><span class="line"><span class="keyword">if</span> (length &gt;= <span class="number">10</span>)</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// No.2</span></span><br><span class="line"><span class="keyword">if</span> (<span class="number">10</span> 　&lt;= length)</span><br></pre></td></tr></table></figure><p>書籍では、No.1の方が読みやすいと答える人が多いのではないかと言及されてます。<br>私も最初に読んだ際に直感的にNo.1の方が読みやすいなと感じました。<br>あくまで指針ですが、書籍では下記のように述べられていました。</p><blockquote><p>条件式の左側には、「調査対象」の式。変化する。<br>条件式の右側には、「比較対象」の式。あまり変化しない。</p></blockquote><p>実際に自分が実装する際には、無意識で上記のように実装していましたが、今後条件式を書く際には、上記のことを意識して実装しようと思いました。</p><h2 id="ド・モルガンの法則を使う"><a href="#ド・モルガンの法則を使う" class="headerlink" title="ド・モルガンの法則を使う"></a>ド・モルガンの法則を使う</h2><blockquote><p>論理式を等価な式に置き換える方法がある。</p></blockquote><p>先日レビュアーから受けた指摘事項で、ド・モルガンの法則を使って修正したことがありました。</p><p>具体的には、型がbooleanである変数 <code>isXXX</code>がfalseかつと<code>isYYY</code>がfalseの時にのみ特定の処理を行いたく、下記のように実装していました。</p><figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> isXXX <span class="type">bool</span> = <span class="literal">false</span></span><br><span class="line"><span class="keyword">var</span> isYYY <span class="type">bool</span> = <span class="literal">false</span></span><br><span class="line"><span class="keyword">if</span> !(isXXX &amp;&amp; isYYY) &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ド・モルガンの法則を使って、下の実装ように修正しました。</p><figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> isXXX <span class="type">bool</span> = <span class="literal">false</span></span><br><span class="line"><span class="keyword">var</span> isYYY <span class="type">bool</span> = <span class="literal">false</span></span><br><span class="line"><span class="keyword">if</span> !isXXX || !isYYY &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>一般的には下の実装のほうが理解しやすいと言われています。</p><p>なぜ下の実装の方がわかりやすくなるのか考えてみました。</p><p>上の実装は、「isXXX と isYYY の両方が真でない場合に実行」となりisXXXとisYYYが複合的な論理演算なため理解しにくいですが、下の実装は、「isXXX が偽、または isYYY が偽の場合に実行」となり、isXXXとisYYYを分けて考えていることで単純な論理演算になるため分かやすくなるのではないかと思いました。</p><h2 id="テストに優しい開発"><a href="#テストに優しい開発" class="headerlink" title="テストに優しい開発"></a>テストに優しい開発</h2><blockquote><p>コードにはテストしやすいものとそうでないものがある。テストしやすいコードには、明確なインタフェースがある。状態や「セットアップ」がない。検査するデータが隠されていない。あとでテストを書くとおもしろいことが起きる。テストしやすいようにコードを設計するのだ！このようにコードを書いていけば、いいコードが書けるようになる！</p></blockquote><p>テストを意識して実装することでメリットはいろいろあるとは思いますが、個人的には、何を目的とするかをより明確な状態で実装できることが要因の一つではないかと思いました。</p><p>また、テスト駆動開発と呼ばれる、テストケースを先に実装することで、より堅牢でバグの少ないコードを生み出すことを目的としている手法をまだ体験したことがないので個人開発などする時に試してみたいと思いました。</p><h2 id="解決策を言葉で説明する"><a href="#解決策を言葉で説明する" class="headerlink" title="解決策を言葉で説明する"></a>解決策を言葉で説明する</h2><p>書籍では、コメントを数行書いての説明でしたが、私自身は、コードを書いている際に詰まったり悩んだりした際に、上長の方に質問をしている途中で解決策が思いうかぶことが多々あり言語化することは大切だと思っております。</p><p>そのため質問をする前に仮想の相手を用いて質問をすることを実践しているのですが、このことは、「ラバーダッキング」や「ラバーダック・デバッグ」<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>と呼ばれる技法で、名称の由来は、プログラマーがラバーダック（ゴム製のアヒル）を持ち歩き、そのダックに対してコードを一行ずつ説明しながらデバッグを行いことが由来だそうです。</p><h1 id="さいごに"><a href="#さいごに" class="headerlink" title="さいごに"></a>さいごに</h1><p>自分が実装をする上でなんとなくやっていることが言語化されており、改めて実装をする上で意識すべきことを考えさせられる良い書籍でした。</p><p>次回は、最終回で、島ノ江励さんの「人を選ぶ技術」です。</p><div id="footnotes"><hr><div id="footnotelist"><ol style="list-style:none; padding-left: 0;"><li id="fn:1"><span style="vertical-align: top; padding-right: 10px;">1.</span><span style="vertical-align: top;"><a href="https://ja.wikipedia.org/wiki/%E3%83%A9%E3%83%90%E3%83%BC%E3%83%80%E3%83%83%E3%82%AF%E3%83%BB%E3%83%87%E3%83%90%E3%83%83%E3%82%B0">https://ja.wikipedia.org/wiki/ラバーダック・デバッグ</a></span><a href="#fnref:1" rev="footnote"> ↩</a></li></ol></div></div>]]></content:encoded>
      
      
      <category domain="https://future-architect.github.io/categories/Culture/">Culture</category>
      
      
      <category domain="https://future-architect.github.io/tags/%E6%9B%B8%E8%A9%95/">書評</category>
      
      <category domain="https://future-architect.github.io/tags/%E3%83%AA%E3%83%95%E3%82%A1%E3%82%AF%E3%82%BF%E3%83%AA%E3%83%B3%E3%82%B0/">リファクタリング</category>
      
      <category domain="https://future-architect.github.io/tags/%E3%83%AA%E3%83%BC%E3%83%80%E3%83%96%E3%83%AB%E3%82%B3%E3%83%BC%E3%83%89/">リーダブルコード</category>
      
      
      <comments>https://future-architect.github.io/articles/20231122a/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>高校生だけじゃもったいない　仕事に役立つ新・必修科目「情報Ⅰ」のレビューに参加しました</title>
      <link>https://future-architect.github.io/articles/20231121a/</link>
      <guid>https://future-architect.github.io/articles/20231121a/</guid>
      <pubDate>Mon, 20 Nov 2023 15:00:00 GMT</pubDate>
      
        
        
          
          
      <description>&lt;p&gt;&lt;a href=&quot;/articles/20231030a/&quot;&gt;秋のブログ週間2023&lt;/a&gt;、4週目・16本目の記事です。&lt;/p&gt;
&lt;a href=&quot;https://www.amazon.co.jp/dp/4569855318&quot;&gt;
&lt;img</description>
          
        
      
      
      
      <content:encoded><![CDATA[<p><a href="/articles/20231030a/">秋のブログ週間2023</a>、4週目・16本目の記事です。</p><a href="https://www.amazon.co.jp/dp/4569855318"><img src="/images/20231121a/81p3z6gOFlL._SL1500_.jpg" alt="" width="500" height="719"></a><p>中山心太氏の最新作、高校生だけじゃもったいない　仕事に役立つ新・必修科目「情報Ⅰ」のレビューに参加し、お礼に献本をいただきました。ありがとうございました。読んだ感想としては発表されたタイミングでツイートしたのがそれにあたります。結構レビューではがんばってコメントを入れました。レイアウトの都合で入りません、と言われたものもいくつかあったのですが、その反映されなかったコメントも交えて本書の紹介をしようと思います。</p><blockquote class="twitter-tweet"><p lang="ja" dir="ltr">レビューに参加しました！単に教科書をなぞるだけじゃなくて、ところてん節がところどころにあって、社会人であっても、ITの専門家でなくても、リテラシーとしてITが何をできるのかというのを身につける大切さが書かれています。面白かったです。 <a href="https://t.co/tOUBpGiPtN">https://t.co/tOUBpGiPtN</a></p>&mdash; 渋川よしき (@shibu_jp) <a href="https://twitter.com/shibu_jp/status/1714969014127210913?ref_src=twsrc%5Etfw">October 19, 2023</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><p>コンピュータが基礎教養になるというのはどういうことか、というのは最初のP19で紹介されている問題の解法の解説で明らかになります。大学で学ぶような理論であっても、プリミティブな手でも解けるシンプルな計算や数のカウントといった簡単な手順に落とし、それをCPUのパワーで繰り返すことで高速かつ大量のデータに対して解決できるようにするのがコンピュータを使った問題解決です。この例では1つ1つはとてもシンプルな事象なので、それを手でシミュレートしています。これを繰り返すことでかなり複雑な予測でもコンピュータでできそうだという気持ちにさせてくれる本です。</p><p>そのように導入部から説得力のある形で始まるのですが、作者はChatGPT本も数ヶ月前に出しており、そちらも精通しています。最後にはそちら方面の情報のキャッチアップも行えるような構成になっております。情報Iの教科書を読み進めていく上ではガイドとして道を示してくれる本だと思いますし（僕は実際は読んではないですがITパスポートなどの学習にも使えそうという感想）、他の本を読まなかったとしても、単体で「自分の仕事にどのような影響があるのか？」というのを考える大きなきっかけを与えてくれる本かと思います。それだけではなく、P200のような神Excelがなぜダメなのか、なぜこれがDXではないのか、というのが理解できるようになってくるでしょう。</p><p>神Excelの方は説明はあっさりしたものですが、おろらく、後続の事務処理にはまったく手を入れる意思がなく（もしくは権限がない）、紙の申請書を回すフローをそのまま使うために「印刷したら過去の方法と互換性が生まれる」という方式になっており、仕事の流れ自体は全く変わっていない（もしくは増える）ため、本来のDXで得られるはずのメリットが享受できないということを説明しようとしていたのでは、と思います。</p><p>「ITは基礎教養」とか「これからはインターネット」とかふわっとしたものではなく、学ぶことによって何がどう変わるのか、というのをきちんと伝えてくれる良い本かと思います。システム開発をするにあたって、予算の都合で機能（スコープ）を削っていくというのはよくある話ですが、やはりどこを新しくすることでどのようなビジネス上のメリットを得るのか、どこが費用対効果が大きいのかというのをきちんと考え抜くスキルはITにかかわるけど本業がIT出ない人にもとても大切になり、かなり大きな金額のITプロジェクトの成否を決めるポイントになります。</p><p>なお、著者のところてん氏は本に入りきらなかった内容をブログ公開しているのですが、これらも面白いです。</p><blockquote class="twitter-tweet"><p lang="ja" dir="ltr">情報I本の未収録原稿をブログで公開しました。これでまだ半分くらい<br><br>「豚と符号化」が割とお気に入りだったんだけど、紙面の都合でカットされて辛かったので供養<a href="https://t.co/kCsYyfvOcS">https://t.co/kCsYyfvOcS</a></p>&mdash; ところてん (@tokoroten) <a href="https://twitter.com/tokoroten/status/1721189428692127921?ref_src=twsrc%5Etfw">November 5, 2023</a></blockquote><blockquote class="twitter-tweet"><p lang="ja" dir="ltr">情報I本の未収録原稿その２（ChatGPT関連、機械学習回り）です<a href="https://t.co/1hqlQodDPF">https://t.co/1hqlQodDPF</a></p>&mdash; ところてん (@tokoroten) <a href="https://twitter.com/tokoroten/status/1721527135293116850?ref_src=twsrc%5Etfw">November 6, 2023</a></blockquote><p>ITを仕事にしている人にも読み物として面白く、そうじゃない人には今後のビジネスを大きく飛躍させるのか、逆に時代遅れにしてしまうのかの分水嶺となる考えを学べる良い本だと思いますので多くの人に手に取ってもらえると良いのではないかと思います。実際、かなり売れているようです。</p><blockquote class="twitter-tweet"><p lang="ja" dir="ltr">AmazonでIT関連で1位になってた <a href="https://t.co/evVLLInyGd">pic.twitter.com/evVLLInyGd</a></p>&mdash; ところてん (@tokoroten) <a href="https://twitter.com/tokoroten/status/1720646425405710838?ref_src=twsrc%5Etfw">November 4, 2023</a></blockquote> <p>著者のところてん氏にはこのブログ原稿を見てもっと本文を引用してもいいのよ、と言われたのですが、本文を読む楽しみを最大化して欲しいのでこのままにしておきます。</p>]]></content:encoded>
      
      
      <category domain="https://future-architect.github.io/categories/Culture/">Culture</category>
      
      
      <category domain="https://future-architect.github.io/tags/%E5%85%A5%E9%96%80/">入門</category>
      
      <category domain="https://future-architect.github.io/tags/%E6%9B%B8%E8%A9%95/">書評</category>
      
      <category domain="https://future-architect.github.io/tags/%E6%83%85%E5%A0%B1%E2%85%A0/">情報Ⅰ</category>
      
      <category domain="https://future-architect.github.io/tags/%E3%82%B3%E3%83%B3%E3%83%94%E3%83%A5%E3%83%BC%E3%82%BF%E3%82%B5%E3%82%A4%E3%82%A8%E3%83%B3%E3%82%B9/">コンピュータサイエンス</category>
      
      
      <comments>https://future-architect.github.io/articles/20231121a/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>カイゼンジャーニーを読んで新しい挑戦に備える</title>
      <link>https://future-architect.github.io/articles/20231120b/</link>
      <guid>https://future-architect.github.io/articles/20231120b/</guid>
      <pubDate>Sun, 19 Nov 2023 15:00:01 GMT</pubDate>
      
        
        
          
          
      <description>&lt;img src=&quot;/images/20231120b/kaizen.jpg&quot; alt=&quot;&quot; width=&quot;331&quot; height=&quot;466&quot; loading=&quot;lazy&quot;&gt;

&lt;h1 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot;</description>
          
        
      
      
      
      <content:encoded><![CDATA[<img src="/images/20231120b/kaizen.jpg" alt="" width="331" height="466" loading="lazy"><h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>こんにちは。2023年３月キャリア入社、HIG所属の寒河江です。<br><a href="/articles/20231030a/">秋のブログ週間2023</a>、4週目・15本目の記事です。</p><p>現在は新規ビジネス立ち上げのPJに挑戦しており、少人数からスタートしていくにあたり、自分が何かスタートを切る場面もあるのではないかと思い、<a href="https://www.amazon.co.jp/dp/4798153346">カイゼン・ジャーニー たった1人からはじめて、「越境」するチームをつくるまで</a>を読んでみることにしました。</p><p>読んでみて書きたい内容はいろいろあったのですが、かなり長くなりそうだったので概要と感想に留めています。気になった方はぜひ書籍を読んでいただければと思います！</p><h1 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h1><p>20代のエンジニアである江島を主人公に、様々な状況下で様々な逆境を乗り越えていくストーリーとなっています。</p><p>会社に対し不満を抱えていた江島が社外のイベントに参加した際に、『それで、あなたは何をしている人なんですか？』と問われて自分は何も行動を起こしていないことに気づくところからストーリーが始まり、「一人→二人→チーム→さらに広げて」と、様々な人数や状況で逆境を乗り越え改善していきます。<br>一人の章ではタスクマネジメントの基本が、チームの章ではスクラムなどアジャイル開発の手法とチームマネジメントの手法が記載されており、様々な役割の登場人物が性格まで見えてくる書かれ方になっているため、感情移入もしやすく、現場の雰囲気もつかみやすいです。<br>また、現場の雰囲気まで伝わるため、こういった現場ではこのやり方が合う、こんな不満や意見が出てくる、こういった効果が期待できるのだと理解することが出来ます。</p><p>最後の章では他のチームとともに逆境を乗り越えるのですが、手法は一人の時やチームでの改善活動の時のものに近く、考え方や視点を変えて応用していく様子が描かれています。</p><h1 id="感想"><a href="#感想" class="headerlink" title="感想"></a>感想</h1><p>実際の現場での経験を踏まえたうえで、その時の心情も表現しながら記載されているため、自分の過去の経験とも照らし合わせて共感出来るので読みやすかったです。</p><p>一人→二人→チーム→さらに広げてと人数や関わり方が変わっていくのですが、一人で行うものについてはタスクマネジメントの基本が書かれているため、改善項目の有無に関係なく若手の方は読んで実践すると今後タスクマネジメントがしやすくなるのではないかなと思います。</p><p>アジャイル開発の手法については広く浅くといった感じで、ゴリゴリに開発の手法を説明するというより、メンバ視点でもマネジメント視点でも、プロジェクトの課題をどう解決していくか、チームでどう進めていくかという内容になっています。</p><p>アジャイル開発未経験の方には、用語の説明に加え現場の雰囲気も伝わりやすい本となっているので、かなりわかりやすい本だと思います。</p><p>また、チームとプロダクトオーナー、チームとチームリーダー、チームと新メンバそれぞれの境界について書かれている部分もあり、他の著書と比較して<strong>信頼関係</strong>の構築について重きを置いている印象があるので、開発手法を十分理解している方でも普段信頼関係を意識してこなかった方などは読んでみると学びがあるのかなと思います。</p><p>そのため、新人の方や新しくPMになる方、異なる役割間の関係性を改善したいという方にお勧めしたいです！</p><h1 id="さいごに"><a href="#さいごに" class="headerlink" title="さいごに"></a>さいごに</h1><p>本書で登場した『あなたは何をしている人なんですか？』という言葉は、課題に対してどんな取り組みをしている人かを問う質問で出てきています。</p><p>私は前職で色々と課題を打ち上げてはみてはいたものの、本書の主人公と同様、何かを変えるために自分一人で動いてはいなかったことに気づき主人公同様恥ずかしい気持ちになりました。</p><p>動き始める人は特別な人間ではなく、勇気を出した人（これが難しいけれど）なんだと教えてくれる本だと思うので、<strong>何かを変えたい、自分が変わりたい</strong>と思っても一歩踏み出せない方は是非読んでいただければと思います。</p><p>次は澁川さんの<a href="/articles/20231121a/">仕事に役立つ新・必修科目「情報Ⅰ」のレビューに参加しました</a>です。</p>]]></content:encoded>
      
      
      <category domain="https://future-architect.github.io/categories/Management/">Management</category>
      
      
      <category domain="https://future-architect.github.io/tags/%E3%83%9E%E3%83%8D%E3%82%B8%E3%83%A1%E3%83%B3%E3%83%88/">マネジメント</category>
      
      <category domain="https://future-architect.github.io/tags/%E3%82%A2%E3%82%B8%E3%83%A3%E3%82%A4%E3%83%AB/">アジャイル</category>
      
      <category domain="https://future-architect.github.io/tags/%E3%82%AB%E3%82%A4%E3%82%BC%E3%83%B3%E3%82%B8%E3%83%A3%E3%83%BC%E3%83%8B%E3%83%BC/">カイゼンジャーニー</category>
      
      
      <comments>https://future-architect.github.io/articles/20231120b/#disqus_thread</comments>
      
    </item>
    
  </channel>
</rss>
