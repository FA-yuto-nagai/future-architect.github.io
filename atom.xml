<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>フューチャー技術ブログ</title>
  <icon>https://future-architect.github.io/feed_icon.png</icon>
  <subtitle>Future Tech Blog</subtitle>
  <link href="https://future-architect.github.io/atom.xml" rel="self"/>
  
  <link href="https://future-architect.github.io/"/>
  <updated>2024-04-11T00:06:43.686Z</updated>
  <id>https://future-architect.github.io/</id>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>2024年Gitワークフロー再考</title>
    <link href="https://future-architect.github.io/articles/20240410a/"/>
    <id>https://future-architect.github.io/articles/20240410a/</id>
    <published>2024-04-09T15:00:00.000Z</published>
    <updated>2024-04-11T00:06:43.686Z</updated>
    
    <content type="html"><![CDATA[<p><a href="/articles/20240408a/">春の入門祭り2024</a>の2記事目です。</p><p>Gitは、出自としては1週間で作られたLinuxカーネルのための分散バージョン管理システムでした。当時のワークフローに合わせてパッチをテキスト化してメールに添付できるような機能だったりが備わっています。</p><p>一方で、現代のGitは、デファクトスタンダードなバージョン管理システムになりLinuxカーネル以外のアプリケーション開発で利用されています。分散バージョン管理ではあるものの、サーバー・クライアント型の使われ方をしていて、GitHubやGitLabを核にして、ローカルで作ったブランチをpushして、Pull Requestの形にして管理しています。少なくとも周りで見る限りでは、それ以外の使われ方の方が少なくなってきてます。そんなこんなで求められている使われ方が変わってきていて、それに合わせた機能がぼちぼち増えています。それを活用することで、ウェブ画面上での差分がみやすく、レビューもしやすくなります。</p><p>本来はそれに合わせてワークフローや設定を見直していくべきなんだとは思いますが、なんとなく昔覚えたメンタルモデルのまま使っているな、と思ったので、直近増えた機能を試しつつ、どんなお作法で使っていくべきか思考実験してみたのがこの記事です。基本路線としては、Gitの使い方の議論ポイント、履歴をきれいにする使い方を広めたいが、チームメンバーがついてこれない、というのはよく聞く話だと思いますが、それに対し、今時の設定を使ってmergeとrebaseの両方があって使い手が選べる世界ではなく、rebaseのみがある世界を作っていこうというものです。</p><p>実際に複数人で使ってみるとまたいろいろ気づきはあるかもしれません。あと、僕はgit操作はCLIでやっているのですが、これをきちんとガイドライン化するなら、利用者の多いGitクライアントツールの操作も併記するといいですね。</p><h1 id="本エントリーが想定する現代のGit使いに求められるメンタルモデル"><a href="#本エントリーが想定する現代のGit使いに求められるメンタルモデル" class="headerlink" title="本エントリーが想定する現代のGit使いに求められるメンタルモデル"></a>本エントリーが想定する現代のGit使いに求められるメンタルモデル</h1><ul><li>メインのブランチへのマージはPR単位。大きくなるほどコンフリクトしやすく、それの解決が大変になるので、Pull Request上でレビューを行うし、　CIのテストが走っていて、メインとなるブランチが不安定な状態にならないようにする</li><li>Pull Request上ではレビュー指摘に対する修正コミットがわかりやすい(前のコミットに対する差分が見える)が、マージ後は1つのPull Request&#x3D;&#x3D;1コミットで、どのPR由来の変更か追いかけやすくする(squash merge)</li><li>複数の修正はPull Requestには混ぜない。Pull Requestごとに、GitHubの機能を使ってrevertする</li></ul><p>開発はPull Requestベースで行いますが、1つのPull Requestをマージしてマージコミットが生成されて、他のPull Requestがぶっ壊れたら困るわけで、ようはRebaseをきちんとやる、という方向ですね。</p><p>マージコミットを生成するとどのようにマージしたのかの記録を残す、という言説はあったけど、マージコミットの情報が役に立ったことがないし、並列数が増えてくると困ることが増えてくると思うのでマージコミットは作らないようにしたいという感じかなと。</p><h1 id="設定"><a href="#設定" class="headerlink" title="設定"></a>設定</h1><h2 id="GitHub"><a href="#GitHub" class="headerlink" title="GitHub"></a>GitHub</h2><p>設定のGeneralのPull Requestsの項目にある、Allow merge commitsとAllow rebase mergingのチェックを外し、Allow squash mergingだけにしておきます。</p><img src="/images/20240410a/スクリーンショット_2024-03-26_12.21.11.png" alt="スクリーンショット_2024-03-26_12.21.11.png" width="821" height="451" loading="lazy"><p>ついでに、Automatically delete head branchesもチェックしておいて良いでしょう。</p><p>Pull Requestのマージ先の<code>develop</code>などはプロテクトブランチ設定しておきます。承認まわりとかCIはプロジェクト固有の話が出てきますのでそこはスキップして共通的な話だけを用意するとなると、次の2を設定すると良いでしょう。</p><ul><li>Require a pull request before merging</li><li>Require linear history</li></ul><p>後者を設定すると、Pull Requestのボタンは「Squash and merge」がデフォルトになるっぽいです。</p><p>なお、rebase主体だと一部force pushは必要となります。名前通りの<code>--force</code>自体は不要ですが(後述)、<code>develop</code>以外の<code>feature</code>ブランチに対しては許可しておきます。</p><h2 id="ローカル"><a href="#ローカル" class="headerlink" title="ローカル"></a>ローカル</h2><p>次の2つを設定します。</p><ul><li><code>git config pull.rebase true</code></li><li><code>git config rerere.enabled true</code></li></ul><h1 id="開発時のモデル操作"><a href="#開発時のモデル操作" class="headerlink" title="開発時のモデル操作"></a>開発時のモデル操作</h1><p>開発時にどのような操作をしていくのかをまとめます。</p><h2 id="1-featureブランチを作成して実装"><a href="#1-featureブランチを作成して実装" class="headerlink" title="1. featureブランチを作成して実装"></a>1. featureブランチを作成して実装</h2><p>マージ先となるブランチ（一般的には<code>develop</code>)から新しいフィーチャーブランチを作成します。 <code>feature/名前</code>みたいな。ローカルで一通り実装します。</p><p>もし、ローカル実装中に<code>develop</code>の最新を取り込む必要があれば<code>git pull origin develop</code>します。コンフリクトがあればrebaseをきちんと行います。</p><p>一通り動くまで実装します。</p><h2 id="2-リモートにpush前に整理"><a href="#2-リモートにpush前に整理" class="headerlink" title="2. リモートにpush前に整理"></a>2. リモートにpush前に整理</h2><p>リモートにpushしますが、2つの操作を忘れずに行います。</p><ul><li><code>git pull origin develop</code>で最新の<code>develop</code>を取り込む</li><li><code>git rebase -i develop</code>で最新の<code>develop</code>の上に変更が来るようにする。最後のコミット(一番上の行)以外はfixupして、1コミットにまとめる</li></ul><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pick   950b967　このコメントだけ残る</span><br><span class="line">fixup  6b66e35　このコメントは無視される</span><br><span class="line">fixup  806489c　このコメントは無視される</span><br><span class="line">fixup  aaf0eda このコメントは無視される</span><br></pre></td></tr></table></figure><p>これで1コミットにまとまるのでレビューしやすくなります。</p><p>なお、このステップはオプションでも良いかなと思います。ちょっと不安なら、bisectで問題を探すとかするかもしれません。また<code>develop</code>へのrebaseはGitHub上でもコンフリクトしない限りはやってくれはします。ただし、コンフリクトした場合はここで実施して解決しなければなりません。</p><h2 id="3-リモートにpushしてPull-Rquest作成"><a href="#3-リモートにpushしてPull-Rquest作成" class="headerlink" title="3. リモートにpushしてPull Rquest作成"></a>3. リモートにpushしてPull Rquest作成</h2><p>ここはいつもの操作なので省略します</p><h2 id="4-1-レビュー指摘に対応する修正"><a href="#4-1-レビュー指摘に対応する修正" class="headerlink" title="4.1. レビュー指摘に対応する修正"></a>4.1. レビュー指摘に対応する修正</h2><p>レビューで指摘された修正を行います。修正したらcommit&amp;pushします。一度Pull Requestを作成したら、rebaseで前のコミットにまとめたりはせず、コミットをバラバラの状態でpushします。レビューアが修正コミットのみを見たいと思うケースがあるからです。pushする前に「あ、ちょっとタイポ」と<code>commit --amend</code>するかもしれませんが。そうすればみんなが嫌いな<code>--force</code>は不要となります。</p><p>次のブログでは<code>--fixup</code>を推奨していますが、この形式のコメントはGitHubは現時点（記事公開日:2024&#x2F;4&#x2F;10）では考慮してくれないので気にしなくても良いです。</p><p><a href="https://blog-dry.com/entry/2024/02/26/090146">https://blog-dry.com/entry/2024/02/26/090146</a></p><h2 id="4-2-developのrebase"><a href="#4-2-developのrebase" class="headerlink" title="4.2. developのrebase"></a>4.2. developのrebase</h2><p>PR作成時は良かったかもしれませんが、その後の他の人のPRが先にマージされるとコンフリクトが発生して再度rebaseが必要になります。その場合は、<code>git pull origin develop</code>で最新の<code>develop</code>を取り込みます。</p><p>何度も<code>develop</code>をマージしなおすケースであれば<code>rerere.enabled true</code>のおかげで、変更を記録しておき操作が自動化されます。最初の一回の修正は必要ですし、コンフリクト時の<code>git add</code> &#x2F; <code>git rebase --continue</code>操作だけは必要ですが、何度もファイルを開いて修正する必要はありません。</p><p>rebase後は通常のpushは失敗するようになってしまいますが、<code>--force-with-lease</code>という<code>--force</code>のようで<code>--force</code>ではない、ちょっと<code>--force</code>なオプションを使います。</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git push origin [ブランチ] --force-with-lease</span><br></pre></td></tr></table></figure><h2 id="5-GitHub上でマージ"><a href="#5-GitHub上でマージ" class="headerlink" title="5. GitHub上でマージ"></a>5. GitHub上でマージ</h2><p>Squash and Mergeでマージします。Squash and Mergeするとこのブランチはもう再利用できないというか、ここから新しいコミットを伸ばしてマージしようとするとコンフリクトするのでブランチは削除しましょう。ローカルもです。</p><p>気軽にPull Requestに含まれる1コミットだけを取り消すといったこともできなくなります。</p><h1 id="Git操作の考え方"><a href="#Git操作の考え方" class="headerlink" title="Git操作の考え方"></a>Git操作の考え方</h1><p>上記のモデル操作における基本的なGit操作の考え方についても触れておきます。</p><p><code>develop</code>上では1コミット&#x3D; &#x3D; 1 Pull Requestとなるようにしますが、一方で、Pull Request上では無理にマージする必要はありません。Pull Request前にコミットは可能なら1つにしても良いとは思いますが、素直にコミット履歴を重ねていく方針です。</p><p>コミットをまとめるsquash操作はGitHub上でのみ行います。ローカルでsquash mergeを自分の手でやるということはしません。また、squash mergeしてしまうと、部分的な修正は難しくなるのでPull Request上のレビューやCIのチェックはきちんと行う想定です。</p><p>rebaseは「過去を書き換える機能」ですが、普段使うのは、マージしやすいように自分のコミットを最新のコミットよりも後に持っていく、という方向の修正のみです。</p><p>コミットしたあとに何か不具合を見つけて戻す場合は、その修正のPull Requestを上げて修正すればいいと考えています。rebaseで過去のコミットを修正して無かったことにする、までは不要かなと。</p><p><code>push --force</code>(<code>--force-with-lease</code>)は、rebaseを反映するためだけに利用します。</p><h1 id="トレードオフ"><a href="#トレードオフ" class="headerlink" title="トレードオフ"></a>トレードオフ</h1><p>この設定とか作法でもまだ100点ではないというか、一部ちょっとした困り事はあります。</p><h2 id="rebaseをしっかり覚える必要がある"><a href="#rebaseをしっかり覚える必要がある" class="headerlink" title="rebaseをしっかり覚える必要がある"></a>rebaseをしっかり覚える必要がある</h2><p>今まではrebase怖いと思っていた人もきちんとやっていく必要性があるかなと思います。しかし、やることといえば修正後に<code>git commit</code>の代わりに<code>git rebase --continue</code>をするぐらいと、コミット数分繰り返す必要がある点ですね。</p><p>いままでmergeの方がいいよ、という意見があったのはコンフリクト発生時の処理がrebaseの方がちょっと面倒だった、ということに尽きるかと思います。<code>rerere.enabled true</code>でだいぶ楽になったとはいえ、rebase元との差のコミット数が増えてくるとローカルでのコンフリクト発生時が大変になります。</p><p>あとはrebase時は、他の人の修正がメインで自分のコミットがサブ側になるというのがちょっとわかりにくいとかはありますが、ここはすぐに慣れるでしょう。</p><h2 id="branch-dでブランチが消せない"><a href="#branch-dでブランチが消せない" class="headerlink" title="branch -dでブランチが消せない"></a><code>branch -d</code>でブランチが消せない</h2><p>GitHub等でsquash and mergeを選ぶと、複数のコミットがマージされた1つのコミットになります。コミットが作り替えられます。マージ済みの<code>develop</code>をfetchしても、同一コミットは存在しないわけで、<code>branch -d</code>ではfeatureブランチが消せません。強制的な削除の<code>branch -D</code>を使う必要があります。</p><p>基本的にやることはないと思いますが、マージ済みの作業ブランチでそのまま修正作業を継続するとコンフリクトが必ず発生するというのはありますが、これはまあ問題にはならないと思います。作業フローが悪い。</p><h2 id="squashしてしまうと部分的なコミットの取り消しが不能になる"><a href="#squashしてしまうと部分的なコミットの取り消しが不能になる" class="headerlink" title="squashしてしまうと部分的なコミットの取り消しが不能になる"></a>squashしてしまうと部分的なコミットの取り消しが不能になる</h2><p>マージ後にPull Requestに問題があったと判明したとして取り消そうとした場合、Squashしていなければ内部に含まれるコミットがばらばらにあるので一部だけを消すなども可能です。しかし、Squashしてしまうと、履歴上は1つのコミットになってしまうので、一部だけをなかったことにはできません。</p><p>取り消しはGitHub上のrevert操作で良いと思いますが、これだと　Pull Requestの単位での取り消しになります。でかすぎるPull Requestにならないように、小さい機能に分けてコミットしていくような配慮は必要となるでしょう。</p><h1 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h1><p>Gitのおもしろさ（難しさ）は、複数の機能の掛け算で、便利なワークフローが変わってくるところです。</p><p><code>git config rerere.enabled true</code>が入ったおかげで、長期間生存し、<code>develop</code>からなんども変更を取り込むようなケースが楽になりました。<code>--force-with-lease</code>というちょっと安全な<code>push --force</code>も入りました。</p><p>最初にメールでパッチを送るケースについて紹介しましたが、実際にはまだ現役で、最近のバージョンのリリースノートでも着実に機能強化はされています。ですが、GitHubやGitLab主体の開発というフローを考えると、着実にrebaseを便利にする機能が強化されており、今後もこの方向性でワークフローを考えていけばどんどん便利になっていきそうです。あとは、rebaseの繰り返しのcontinueが軽減される機能が入ったら完璧ですね。それに期待。</p><h1 id="おまけ-pull-rebase-trueか、pull-ff-onlyか"><a href="#おまけ-pull-rebase-trueか、pull-ff-onlyか" class="headerlink" title="おまけ: pull.rebase trueか、pull.ff onlyか"></a>おまけ: <code>pull.rebase true</code>か、<code>pull.ff only</code>か</h1><p>ローカルでは何も設定しない(<code>git config pull.rebase false</code>相当)と、git pullしてきたときにマージを行おうとします。そうするとマージコミットが出てしまうわけで今回の説明の「なるべく履歴は綺麗に」と違う結果になってしまいます。それ以外の結果を得る設定としては、次の2種類のオプションがあります。</p><ul><li><code>git config pull.ff only</code></li><li><code>pull.rebase true</code></li></ul><p>基本的に他の修正が入る<code>develop</code>ブランチ上で直接作業しない限りは、<code>pull</code>してコンフリクトすることはありません。また、1つのPull Requestを複数人で修正することはない、という前提に立てば<code>pull.ff only</code>で良いかと思います。</p><p>それぞれの状況や設定ごとのgit pullでどうなるかを表でまとめました。</p><div class="scroll"><table><thead><tr><th align="left">設定</th><th align="left">git pull実行時</th><th align="left">操作結果</th><th align="left">どうすればよい？</th></tr></thead><tbody><tr><td align="left">pull.ff only</td><td align="left">インデックスに未コミットのファイルがある(コンフリクトしてない)</td><td align="left">成功</td><td align="left"></td></tr><tr><td align="left">pull.ff only</td><td align="left">ff可能なコミットがある</td><td align="left">エラー</td><td align="left">(1)</td></tr><tr><td align="left">pull.ff only</td><td align="left">ff不可なコミットがある</td><td align="left">エラー</td><td align="left">(1)</td></tr><tr><td align="left">pull.rebase true</td><td align="left">インデックスに未コミットのファイルがある(コンフリクトしてない)</td><td align="left">エラー</td><td align="left">(2)</td></tr><tr><td align="left">pull.rebase true</td><td align="left">ff可能なコミットがある</td><td align="left">成功</td><td align="left"></td></tr><tr><td align="left">pull.rebase true</td><td align="left">ff不可なコミットがある</td><td align="left">git rebaseがスタート</td><td align="left"></td></tr></tbody></table></div><p>表でエラーが発生するのは3箇所(2種類)あります。</p><p>(1)のpull.ff onlyの方は、<code>git pull origin develop --rebase</code>コマンドを使ってrebaseプロセスを始めれば問題なくいけます。</p><p>(2)はコミットするもしくは<code>git restore --staged &lt;ファイル&gt;...</code>でインデックスから除外して再実行すればOKです。</p><p>僕個人は最後までコミットせずに作業して、pull request寸前にgit addすることが多いのでff onlyの方が便利だったりするのですが、周りを見ているとこまめにコミットする人が多いので、おそらく<code>pull.rebase true</code>の方が良い人が多いと思います。なので、今回のこのガイドラインでは<code>pull.rebase true</code>の方を推しています。</p><h1 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h1><p><a href="https://qiita.com/tearoom6/items/0237080aaf2ad46b1963">https://qiita.com/tearoom6/items/0237080aaf2ad46b1963</a></p><ul><li><code>git config pull.rebase true</code></li><li><code>git config rerere.enabled true</code></li></ul><p><a href="https://blog-dry.com/entry/2024/02/26/090146">https://blog-dry.com/entry/2024/02/26/090146</a></p><ul><li><p><code>git commit --fixup</code></p></li><li><p><code>git push --force-with-lease</code></p></li></ul><p><a href="https://blog.colopl.dev/entry/2022/10/07/105919">https://blog.colopl.dev/entry/2022/10/07/105919</a></p><ul><li><code>scaler clone</code></li></ul><p><a href="https://zenn.dev/mary_pp/articles/eaac544eaf600a">https://zenn.dev/mary_pp/articles/eaac544eaf600a</a></p><ul><li>git push –force-with-lease –force-if-includes</li></ul>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;&lt;a</summary>
        
      
    
    
    
    <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
    <category term="Git" scheme="https://future-architect.github.io/tags/Git/"/>
    
    <category term="バージョン管理" scheme="https://future-architect.github.io/tags/%E3%83%90%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3%E7%AE%A1%E7%90%86/"/>
    
    <category term="ブランチ運用" scheme="https://future-architect.github.io/tags/%E3%83%96%E3%83%A9%E3%83%B3%E3%83%81%E9%81%8B%E7%94%A8/"/>
    
  </entry>
  
  <entry>
    <title>Testcontainersを用いてテスト実行前の docker compose up を無くし、Goで並列テストする</title>
    <link href="https://future-architect.github.io/articles/20240409a/"/>
    <id>https://future-architect.github.io/articles/20240409a/</id>
    <published>2024-04-08T15:00:00.000Z</published>
    <updated>2024-04-09T11:59:58.036Z</updated>
    
    <content type="html"><![CDATA[<p><a href="/articles/20240408a/">春の入門祭り2024</a>の1記事目です。</p><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>TIG真野です。</p><p>Testcontainers を用いて、単体テスト実行前に <code>docker compose up -d</code> 無しで、PostgreSQLにアクセスする単体テストを行う、入門記事です。</p><p>恩恵は次のような開発者体感の向上が個人的にあります。</p><ul><li>テストを実行するうえで、別プロセスのサービスを起動しておく必要があるといった前提条件を考えなくても済むため、テストを行うビジネスロジックに集中できる<ul><li><code>docker compose up -d</code> 打たないだけだが、テストに必要なコンテナを考慮しなくても済む</li><li>停止し忘れて、別のリポジトリの開発するときに混乱しなくても済む</li></ul></li><li>並列テストしやすくなるので、テストの実行速度が向上する<ul><li>Goにおいて、複数のパッケージを同時にテストするとき、 <code>-p 1</code> で絞らずに済む</li></ul></li></ul><h2 id="Testcontainers-とは"><a href="#Testcontainers-とは" class="headerlink" title="Testcontainers とは"></a>Testcontainers とは</h2><ul><li><a href="https://testcontainers.com/">https://testcontainers.com/</a></li></ul><p>テストコード上で任意のコンテナを起動・停止できるドライバのようなライブラリです。Java, Go, Python, Rustなど様々な言語でをサポートしています。次はGoでredisを起動するコードです。Dockerfileで記載されていた内容を、Goの構造体に渡するとコンテナが起動しそうだということが分かると思います。</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line">container, err := testcontainers.GenericContainer(ctx, testcontainers.GenericContainerRequest&#123;</span><br><span class="line">    ContainerRequest: testcontainers.ContainerRequest&#123;</span><br><span class="line">        Image:        <span class="string">&quot;redis:5.0.3-alpine&quot;</span>,</span><br><span class="line">        ExposedPorts: []<span class="type">string</span>&#123;<span class="string">&quot;6379/tcp&quot;</span>&#125;,</span><br><span class="line">        WaitingFor:   wait.ForLog(<span class="string">&quot;Ready to accept connections&quot;</span>),</span><br><span class="line">    &#125;,</span><br><span class="line">    Started:          <span class="literal">true</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>TestcontainersのAPIとしてはDockerfileを読み込んで起動させることもできます。</p><p>テストコードとの組み合わせは、<a href="https://testcontainers.com/getting-started/">getting-started</a>にかかれていた図が分かりやすいです。</p><p>「Set Up」にてTestcontainers経由でコンテナを取り上げ、テストでそれら立ち上げたサービスにアクセスし、テスト終了後にコンテナを削除する、という流れです。</p><img src="/images/20240409a/test-workflow.png" alt="test-workflow.png" width="820" height="326" loading="lazy"><p>テストコード上でコンテナを起動するという発想がない場合は、手動でコンテナを起動したり、テストスクリプト上（MakefileやTaskfile）に記載していたかと思いますが、単なる起動はともかく、コンテナの破棄を含めたライフサイクル管理は少し手間でした。また、よくありがちなミスは、コンテナは起動したけど、必要なリソースリソース（例えばRDBだとテーブル、S3だとバケットなど）の作成が終わっていないのに、テストが実行されてFailになってしまうというミスも私はやりがちです。</p><p>Testcontainersはそれらの負荷を低減してくれます。</p><h2 id="PostgreSQLを利用する"><a href="#PostgreSQLを利用する" class="headerlink" title="PostgreSQLを利用する"></a>PostgreSQLを利用する</h2><p>RDB（PostgreSQL）をテストで用いるときに、必要となるテーブルは作成されている前提が多いでしょう。例えば次のように schema ディレクトリ配下にCREATE文のSQLファイルが存在しているとします。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">.</span><br><span class="line">├── schema  <span class="comment"># DDL</span></span><br><span class="line">│   ├── create_m_xxx_xxx_1.sql</span><br><span class="line">│   ├── create_m_xxx_xxx_2.sql</span><br><span class="line">│   ├── ...</span><br><span class="line">│   └── create_m_xxx_xxx_9.sql</span><br><span class="line">│</span><br><span class="line">├── app    <span class="comment"># 各アプリ（パッケージ名をID管理する大人な管理をしているとします）</span></span><br><span class="line">│   ├── bl01</span><br><span class="line">│   |     ├── ...</span><br><span class="line">|   |     └── handler_test.go <span class="comment"># テストコード</span></span><br><span class="line">│   ├── bl02</span><br><span class="line">│   ├── bl03</span><br><span class="line">│   └── ...</span><br><span class="line">└── ...</span><br></pre></td></tr></table></figure><p>PostgreSQLのオフィシャルイメージでは、<a href="https://hub.docker.com/_/postgres#:~:text=and%20POSTGRES_DB.-,Initialization%20scripts,-If%20you%20would"><code>/docker-entrypoint-initdb.d/</code> 配下にSQLファイルをコピーすると、起動時にSQLを実行してくれます</a>。これをTestcontainersを用いてDDL実行済みのPostgreSQLを起動します。</p><h2 id="moduleの利用"><a href="#moduleの利用" class="headerlink" title="moduleの利用"></a>moduleの利用</h2><p>Testcontainers にはDockerfileで指定できる内容を実現するAPIが揃っているため、自分なりに細かくチューニングしても良いかと思いますが、一般的には「モジュール」と呼ばれる、良い感じに実装されたヘルパー関数のようなパッケージを経由して利用することが多いようです。このモジュールの中には、各プロダクトのベンダーと提携して作られた公式と呼ばれるものもあり、クオリティが高く保たれているため、基本的にここにある＋利用したい言語で存在するのであればモジュール経由でTestcontainersを利用することを私も推奨します。低レベルのAPIの利用を最初は試していましたが、イマイチ上手く動かせなかったところを、モジュールを利用するとすぐに解消されたことが何度かありました。</p><ul><li><a href="https://testcontainers.com/modules/">https://testcontainers.com/modules/</a></li></ul><p><a href="https://testcontainers.com/modules/postgresql/">PostgreSQLモジュール</a>はGo対応もしていますのでそのまま利用できます。</p><p>今回は複数のテストコードでコンテナを呼び出したいので、ヘルパーとして <code>testonly/testcontainers.go</code> のファイルを作ります。</p><p><code>/docker-entrypoint-initdb.d/</code> の起動スクリプトですが、PostgreSQLのモジュールでは、ディレクトリごとコピーはできないため、ファイルの一覧を取得して、 <code>postgres.WithInitScripts(scripts...)</code> で渡しています。</p><p>次のポイントとして、<code>testcontainers.WithWaitStrategy()</code> の部分ですが、これは起動スクリプトで作成したテーブルが存在するまでWaitさせるという指示です。他にもコンテナが起動するまでWaitするなど様々な指定ができますが、この例では <code>m_xxx_xxx_1 </code> テーブルが存在するまで確認させるようにしています。これで、必要なテーブルが作成されないまま、テストで検証するアプリコードが動いてしまうことを防ぎます。</p><figure class="highlight go"><figcaption><span>testcontainers.go</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> testonly</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;context&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;net&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line"><span class="string">&quot;testing&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;github.com/docker/go-connections/nat&quot;</span></span><br><span class="line"><span class="string">&quot;github.com/testcontainers/testcontainers-go&quot;</span></span><br><span class="line"><span class="string">&quot;github.com/testcontainers/testcontainers-go/modules/postgres&quot;</span></span><br><span class="line"><span class="string">&quot;github.com/testcontainers/testcontainers-go/wait&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> PostgresContainer <span class="keyword">struct</span> &#123;</span><br><span class="line">postgres.PostgresContainer</span><br><span class="line">ConnectionString <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c PostgresContainer)</span></span> Down() &#123;</span><br><span class="line"><span class="keyword">if</span> err := c.Terminate(context.Background()); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Printf(<span class="string">&quot;Could not stop postgres: %s\n&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SetupDB</span><span class="params">(t *testing.T)</span></span> *PostgresContainer &#123;</span><br><span class="line">t.Helper()</span><br><span class="line">ctx := context.Background()</span><br><span class="line"></span><br><span class="line">entries, err := os.ReadDir(<span class="string">&quot;../../schema&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">t.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">scripts := <span class="built_in">make</span>([]<span class="type">string</span>, <span class="number">0</span>, <span class="built_in">len</span>(entries))</span><br><span class="line"><span class="keyword">for</span> _, e := <span class="keyword">range</span> entries &#123;</span><br><span class="line">scripts = <span class="built_in">append</span>(scripts, <span class="string">&quot;../../schema&quot;</span>+e.Name())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pgContainer, err := postgres.RunContainer(ctx,</span><br><span class="line">testcontainers.WithImage(<span class="string">&quot;postgres:15.5&quot;</span>),</span><br><span class="line">postgres.WithInitScripts(scripts...),</span><br><span class="line">postgres.WithDatabase(<span class="string">&quot;postgres&quot;</span>),</span><br><span class="line">postgres.WithUsername(<span class="string">&quot;local&quot;</span>),</span><br><span class="line">postgres.WithPassword(<span class="string">&quot;pass&quot;</span>),</span><br><span class="line">testcontainers.WithWaitStrategy(</span><br><span class="line">wait.ForSQL(<span class="string">&quot;5432&quot;</span>, <span class="string">&quot;postgres&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(host <span class="type">string</span>, port nat.Port)</span></span> <span class="type">string</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;postgres://local:pass@%s/postgres?sslmode=disable&quot;</span>, net.JoinHostPort(host, port.Port()))</span><br><span class="line">&#125;).WithQuery(<span class="string">&quot;select 1 from m_xxx_xxx_9 limit 1&quot;</span>).WithPollInterval(<span class="number">1</span>*time.Second).WithStartupTimeout(<span class="number">10</span>*time.Second)),</span><br><span class="line">)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">&quot;postgres run container: %s&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">connStr, err := pgContainer.ConnectionString(ctx, <span class="string">&quot;sslmode=disable&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">t.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> &amp;PostgresContainer&#123;</span><br><span class="line">PostgresContainer: pgContainer,</span><br><span class="line">ConnectionString:  connStr,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上記のようなヘルパー関数を、テストコードから呼び出します。</p><p>ポイントは、接続文字列を<code>pgContainer.ConnectionString</code> から取得しているところです。理由ですがTestcontainersを用いると、ホスト側で利用するポートはランダムに決定します。そのため5432で決め打ちではなく、TestcontainersのPostgreSQLモジュールが割り当てた値を利用する必要があります。</p><figure class="highlight go"><figcaption><span>handler_test.go</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestHandler_GetXxxXxx</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">pgContainer := testonly.SetupDB(t) <span class="comment">// PostgreSQL起動</span></span><br><span class="line">t.Cleanup(pgContainer.Down)</span><br><span class="line"></span><br><span class="line"><span class="comment">// この例ではjackc/pgx/v4 を利用してコネクション接続</span></span><br><span class="line">pool, err := pgxpool.Connect(context.Background(), pgContainer.ConnectionString)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">t.Fatalf(<span class="string">&quot;connect db for test ,dsn = %s: %v&quot;</span>, dsn, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 個別のテスト</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><h2 id="Testcontainers-を用いると-Goのパッケージ構成は-package-by-feature-がマッチする？"><a href="#Testcontainers-を用いると-Goのパッケージ構成は-package-by-feature-がマッチする？" class="headerlink" title="Testcontainers を用いると Goのパッケージ構成は package by feature がマッチする？"></a>Testcontainers を用いると Goのパッケージ構成は package by feature がマッチする？</h2><p>Testcontainersを用いると、例えば bl01, bl02間で共通するDBテーブルが存在したとしても、利用するコンテナが別になるため、当たり前ですが、特段の工夫無しで並列にテストを動かせるようになります。モックの利用を無しにそれを簡単に行えるのは素敵だと感じます。</p><p>この恩恵を得やすくするためには、 <code>package by feature</code>、つまり機能ごとのパッケージで作っておくとよいでしょう。機能単位に並列でテストができ、機能単位ゆえそれなりにテスト実行時間がならされていると思うので、テスト実行時間の短縮が見込みやすいと考えられるためです。</p><p>逆に、<code>package by layer</code>、つまりDBアクセスするコントローラ層（controller, usecase, handlerなど）でパッケージを切って、その配下に <code>xxx_handler.go</code>, <code>yyy_handler.go</code> などをフラットに並べて配置をしない方が良いと思いました（<code>handler</code> パッケージの配下に、サブパッケージを作れば別ですが、それはしないとします）。この場合はRDBなどのリソースにアクセスするため、おそらく最も時間がかかるcontrollerのようなパッケージのテストを分割実行しにくいためです。これはテストポリシーとして、リポジトリのようなDB層単体のテストコードも書くといった、レイヤーごとにテストサイズMediumのテストを実行するケース（個人的に出会ったことがないですが、ライブラリなどはありえる？）には当てはまらないと思いますので、ここに書いていない前提が色々入った上での意見になっていると思います。</p><h2 id="使ってみての所感"><a href="#使ってみての所感" class="headerlink" title="使ってみての所感"></a>使ってみての所感</h2><p>Testcontainers経由での起動ですが、DDLが20ファイルほどでだいたい3~5秒程度の起動時間がかかります。これをどう見るかですが、個人的には複数のパッケージを並列でテスト実行できるというメリットがあり、受け入れられると感じています。</p><p>DBのような外部プロセスのサービスを、全テストで共有していた場合は、同じテーブルを複数のテストで書き換え競合してテストが落ちることを回避するために、同時実行数を1に抑えるため、<code>go test</code> に <code>-p 1</code> オプションを加えていましたが、これを無くせるのは嬉しいです。</p><p>Testcontainersを利用する前は、ローカル実行用の、Dockerfile, compose.yaml とTestcontainersのコードとのダブルメンテが嫌だなと感じていましたが、上記の利便性が大きいのでいつの間にか素直に受け入れられています。Testcontainersにも<a href="https://golang.testcontainers.org/features/build_from_dockerfile/">Dockerfileやcompose.yaml を利用するAPI</a>があるので、工夫すればダブルメンテ無しでメリットを享受することもできるかもしれませんが、私は未検証です。</p><p>また、テスト毎にコンテナを起動するメリットは、他のパッケージのテストが副作用を起こし、まれにテストが落ちるパターンのフレーキーテスト（Flaky Test：実行結果が不安定なテストのこと）を発生させにくくするメリットもあるかと思います。例えば、テスト実行前に、前提とするマスタデータが別のパッケージのテスト（特に自分以外の開発者の作業で行われた場合）で書き換えられていたりして、地味にハマるケースは回避できるでしょう。</p><h2 id="さいごに"><a href="#さいごに" class="headerlink" title="さいごに"></a>さいごに</h2><p>Testcontainersを用いてPostgreSQLにアクセスするGoのテストの書き方を紹介しました。</p><p>今回は割愛しましたが、私は <code>docker compose up</code> にて手動で起動済みの場合は、Testcontainers経由で起動せず、起動中のコンテナをそのままテストで利用するといった実装を入れています。そうすると、テスト実行後のDBの状態を見たいときと、単にテストを動かしたいだけのケースを棲み分けができ、開発時の切り分けがとても便利になりました。</p><p>上記のようなややトリッキーな制御も、Testcontainersだと比較的容易に実現でき、名前の通りテストコードとの統合性は高いと感じます。今後は他の案件にも横展開していこうと思います。オススメです。</p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;&lt;a href=&quot;/articles/20240408a/&quot;&gt;春の入門祭り2024&lt;/a&gt;の1記事目です。&lt;/p&gt;
&lt;h2 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot;</summary>
        
      
    
    
    
    <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
    <category term="Go" scheme="https://future-architect.github.io/tags/Go/"/>
    
    <category term="テスト" scheme="https://future-architect.github.io/tags/%E3%83%86%E3%82%B9%E3%83%88/"/>
    
    <category term="Testcontainers" scheme="https://future-architect.github.io/tags/Testcontainers/"/>
    
  </entry>
  
  <entry>
    <title>Go1.22リリースパーティに「ServeMuxの競合検知と性能」というタイトルで登壇しました</title>
    <link href="https://future-architect.github.io/articles/20240408b/"/>
    <id>https://future-architect.github.io/articles/20240408b/</id>
    <published>2024-04-07T15:00:01.000Z</published>
    <updated>2024-04-08T00:46:42.306Z</updated>
    
    <content type="html"><![CDATA[<h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>こんにちは。TIGの武田です。</p><p>2024&#x2F;3&#x2F;18に開催されたGo1.22のリリースパーティに登壇しました。少し時間が空いてしまいましたが、登壇レポートです。</p><h3 id="イベント概要"><a href="#イベント概要" class="headerlink" title="イベント概要"></a>イベント概要</h3><p>このイベントはGo1.22のリリースをお祝いすると共に、<a href="https://tip.golang.org/doc/go1.22">Go1.22のアップデート内容</a>を中心にワイワイするイベントです。今回は完全オンライン形式で開催されました。</p><p><a href="https://gocon.connpass.com/event/310606/">https://gocon.connpass.com/event/310606/</a></p><p>Goのリリースサイクルは半年ごとに設定（2月と8月）されており、リリースパーティの開催はGo1.6のリリースを初回として、今回で16回目となるそうです。</p><h3 id="登壇のきっかけ"><a href="#登壇のきっかけ" class="headerlink" title="登壇のきっかけ"></a>登壇のきっかけ</h3><p>tenntennさんから「フューチャーさんからどなたか登壇しませんか？」というお誘いを澁川さん経由で頂戴しました。<a href="https://future-architect.github.io/articles/20240129a/">Go1.22のリリース連載記事</a>を書いていたこともあり、手を上げさせていただきました。リリースパーティにはこれまで何度も参加していたので、登壇の機会をいただけたことを大変嬉しく思います。この場を借りて、改めてお礼申し上げます。</p><h2 id="登壇資料と動画"><a href="#登壇資料と動画" class="headerlink" title="登壇資料と動画"></a>登壇資料と動画</h2><p>登壇資料と動画は下記にて公開されています。</p><ul><li><p>登壇資料<br><a href="https://rhumie.github.io/go122party/">https://rhumie.github.io/go122party/</a></p></li><li><p>動画（30:40 より）<br><a href="https://www.youtube.com/watch?v=0nsryM4X-0I&t=1840s">https://www.youtube.com/watch?v=0nsryM4X-0I&amp;t=1840s</a></p></li></ul><h2 id="登壇内容"><a href="#登壇内容" class="headerlink" title="登壇内容"></a>登壇内容</h2><p>今回のリリースで比較的大きなアップデートが行われたServeMuxについて取り上げました。</p><p>ServeMuxのアップデートの背後には「リクエストマッチング」と「競合検知」という2つの性能論点があります。前者については、<a href="https://future-architect.github.io/articles/20240202a/">リリース連載ブログ</a>にてベンチマークを行う形で触れていたので、今回は後者の「競合検知」をテーマにしました。</p><img src="/images/20240408b/ServeMux-Conflict-Detection-Go-1-22-Release-Party.png" alt="ServeMux-Conflict-Detection-Go-1-22-Release-Party.png" width="1200" height="649" loading="lazy"><p>資料の構成として、前半部では「そもそも競合とは何か？」という基本的な問いから始め、なぜ競合検知が性能面で重要な論点となるのかを説明しています。</p><img src="/images/20240408b/ServeMux-Conflict-Detection-Go-1-22-Release-Party_2.png" alt="ServeMux-Conflict-Detection-Go-1-22-Release-Party.png" width="1200" height="649" loading="lazy"><p>そして後半部ではServeMuxが性能懸念に対してどのように対応しているのかを実装レベルで詳細に解説しています。</p><img src="/images/20240408b/ServeMux-Conflict-Detection-Go-1-22-Release-Party_3.png" alt="ServeMux-Conflict-Detection-Go-1-22-Release-Party.png" width="1200" height="649" loading="lazy"><h2 id="登壇資料を作る流れ"><a href="#登壇資料を作る流れ" class="headerlink" title="登壇資料を作る流れ"></a>登壇資料を作る流れ</h2><p>あえて章立てして書くほどの内容でもないですが、最近真野さんが<a href="https://future-architect.github.io/articles/20240307a/">Goリリースノートから技術ブログを書く流れ基礎</a>という記事を公開していたので、流れにのってログとして残しておきます。</p><p>資料を作成するにあたって、まずは関連するプロポーサルやディスカッションを読み、次にServeMuxのソースコード自体を読む形で色々とネタや気付きを集めました。</p><ul><li><p>Proposal<br><a href="https://github.com/golang/go/issues/61410">https://github.com/golang/go/issues/61410</a></p></li><li><p>Discussion<br><a href="https://github.com/golang/go/discussions/60227">https://github.com/golang/go/discussions/60227</a></p></li></ul><p>ネタを集めたらその後ストーリーを作り、ストーリーができたら個々のマテリアルを作っていく流れになります。<br>今回は「競合をわかりやすく伝えるためのパターン文字列の例をどうするか」、「インデックスの構造をどう視覚的に表現するか」などは簡潔明瞭になるよう気を遣って作成を行いました。</p><p>資料自体は<a href="Slidev">https://ja.sli.dev/</a>を使用して作成しています。<br>私は普段PowerPointでゴリゴリに資料を作りこむタイプですが、テキストベースのシンプルな資料やコードを引用することが多い資料の作成には相性が良いと感じました。</p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot;</summary>
        
      
    
    
    
    <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
    <category term="登壇レポート" scheme="https://future-architect.github.io/tags/%E7%99%BB%E5%A3%87%E3%83%AC%E3%83%9D%E3%83%BC%E3%83%88/"/>
    
    <category term="Go" scheme="https://future-architect.github.io/tags/Go/"/>
    
    <category term="Goリリースパーティ" scheme="https://future-architect.github.io/tags/Go%E3%83%AA%E3%83%AA%E3%83%BC%E3%82%B9%E3%83%91%E3%83%BC%E3%83%86%E3%82%A3/"/>
    
  </entry>
  
  <entry>
    <title>春の入門連載2024を始めます</title>
    <link href="https://future-architect.github.io/articles/20240408a/"/>
    <id>https://future-architect.github.io/articles/20240408a/</id>
    <published>2024-04-07T15:00:00.000Z</published>
    <updated>2024-04-10T00:55:07.359Z</updated>
    
    <content type="html"><![CDATA[<img src="/images/20240408a/DSC05372.JPG" alt="DSC05372.JPG" width="1200" height="802" loading="lazy"><p>こんにちは。技術ブログ運営の伊藤です。</p><p>春の入門連載2024のインデックス記事です。</p><h2 id="春の入門連載とは"><a href="#春の入門連載とは" class="headerlink" title="春の入門連載とは"></a>春の入門連載とは</h2><p>春の入門連載は2020年から始めた連載で、アドベントカレンダーを除いて技術ブログの中ではご長寿な連載となっていて、2024年で5年目です。</p><p>この連載は以下のテーマで社員向けには募集をかけています。</p><ul><li>今まで触って無かった技術のやってみた記事</li><li>先輩・同期・後輩宛に、知っておいて欲しい技術記事</li><li>好きな技術の布教活動をする記事</li></ul><p>他の連載に比べて、ジャンルを問わずに応募していることもあり、毎年初の寄稿となる社員も多く参加しています。参加者の中にはブログを書いてみたい、とブログ運営に直接連絡をくれたやる気に溢れた社員もいるほどです。</p><p>さて、フューチャーには100名を超える新卒が4月に入社しました。社内外問わず、新人はもちろん、新しいことに取り組むきっかけとしても是非この連載を読んでいただければと思います。</p><h2 id="参加者一覧-投稿タイトル"><a href="#参加者一覧-投稿タイトル" class="headerlink" title="参加者一覧&amp;投稿タイトル"></a>参加者一覧&amp;投稿タイトル</h2><p>今年の参加はインデックス記事を含めて15記事14名が参加します。<br>技術ブログにはお馴染みの顔から、今回の連載で初寄稿の社員まで幅広いメンバーで4月いっぱい投稿していきます。テーマがまだ決まっていないところや変わる場合がありますが、是非色々な記事をお楽しみにしていただければと思います。</p><div class="scroll"><table><thead><tr><th>日付</th><th>投稿者</th><th>テーマ</th></tr></thead><tbody><tr><td>4&#x2F;8(月)</td><td>伊藤太斉</td><td>本インデックス記事</td></tr><tr><td>4&#x2F;9(火)</td><td>真野隼記</td><td><a href="/articles/20240409a/">Testcontainersを用いてテスト実行前の docker compose up を無くし、Goで並列テストする</a></td></tr><tr><td>4&#x2F;10(水)</td><td>澁川喜規</td><td><a href="/articles/20240410a/">2024年Gitワークフロー再考</a></td></tr><tr><td>4&#x2F;11(木)</td><td>岸本卓也</td><td>TBD</td></tr><tr><td>4&#x2F;12(金)</td><td>伊藤太斉</td><td>PrometheusとGrafana</td></tr><tr><td>4&#x2F;15(月)</td><td>棚井龍之介</td><td>TBD</td></tr><tr><td>4&#x2F;16(火)</td><td>清水雄一郎</td><td>Swiftネタ</td></tr><tr><td>4&#x2F;17(水)</td><td>森大作</td><td>TBD</td></tr><tr><td>4&#x2F;18(木)</td><td>吉原涼子</td><td>Vue.jsの学習でオセロを作った話</td></tr><tr><td>4&#x2F;19(金)</td><td>中邨英里佳</td><td>Jenkins</td></tr><tr><td>4&#x2F;22(月)</td><td>大岩潤矢</td><td>unjs&#x2F;nitroで始めるサーバレスアプリケーション入門</td></tr><tr><td>4&#x2F;23(火)</td><td>小橋昌明</td><td>TBD</td></tr><tr><td>4&#x2F;24(水)</td><td>高世駿</td><td>ESP32とGoogle SpleadSheetで始めるIoT入門</td></tr><tr><td>4&#x2F;25(木)</td><td>山本竜玄</td><td>自作キーボード</td></tr><tr><td>4&#x2F;26(金)</td><td>山下雄大</td><td>シェルスクリプトの記法n選</td></tr><tr><td>4&#x2F;30(火)</td><td>後藤喜斗</td><td>GASネタ</td></tr><tr><td>5&#x2F;1(水)</td><td>橋本竜我</td><td>TBD</td></tr></tbody></table></div><h2 id="さいごに"><a href="#さいごに" class="headerlink" title="さいごに"></a>さいごに</h2><p>是非、良いと思った記事などはシェアなどのリアクションをいただければと思います！</p><ul><li><a href="/articles/20230417a/">2023年の連載記事</a></li><li><a href="/articles/20220418a/">2022年の連載記事</a></li><li><a href="/articles/20210414a/">2021年の連載記事</a></li><li><a href="/articles/20200529/">2020年の連載記事</a></li></ul>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;img src=&quot;/images/20240408a/DSC05372.JPG&quot; alt=&quot;DSC05372.JPG&quot; width=&quot;1200&quot; height=&quot;802&quot;</summary>
        
      
    
    
    
    <category term="Culture" scheme="https://future-architect.github.io/categories/Culture/"/>
    
    
    <category term="入門" scheme="https://future-architect.github.io/tags/%E5%85%A5%E9%96%80/"/>
    
    <category term="インデックス" scheme="https://future-architect.github.io/tags/%E3%82%A4%E3%83%B3%E3%83%87%E3%83%83%E3%82%AF%E3%82%B9/"/>
    
    <category term="春の入門祭り" scheme="https://future-architect.github.io/tags/%E6%98%A5%E3%81%AE%E5%85%A5%E9%96%80%E7%A5%AD%E3%82%8A/"/>
    
  </entry>
  
  <entry>
    <title>Vue.jsを2から3へバージョンアップした話</title>
    <link href="https://future-architect.github.io/articles/20240405a/"/>
    <id>https://future-architect.github.io/articles/20240405a/</id>
    <published>2024-04-04T15:00:00.000Z</published>
    <updated>2024-04-05T00:39:07.821Z</updated>
    
    <content type="html"><![CDATA[<img src="/images/20240405a/top.png" alt="" width="800" height="487"><h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>こんにちは。Technology Innovation Group所属の太田寛明です。</p><p>新人研修で触れた程度のVue.js経験者の私が、Vueのバージョンアップを行って得た、所感や躓いたポイントを共有します。</p><h1 id="経緯"><a href="#経緯" class="headerlink" title="経緯"></a>経緯</h1><p>Vue2は2023年12月31日にEnd of Life（EOL）を迎えることになりました。</p><p>EOL期日までにVue2をVue3にバージョンアップする必要があります。</p><p>今回の対応では、<a href="#%E5%AF%BE%E5%BF%9C%E5%86%85%E5%AE%B9">対応内容</a>で紹介する「1. Vue3での動作に必要な変更」をまず最優先で対応し、その後により良いプロダクトとするための取り組みとして「2. Vue3からの新規推奨事項の適用」の対応を行いました。</p><h1 id="対応内容"><a href="#対応内容" class="headerlink" title="対応内容"></a>対応内容</h1><p>まず最初に今回のVue2から3へのバージョンアップで行った変更の全貌を紹介します。</p><ol><li>Vue3での動作に必要な変更<ul><li><strong>Vue本体の更新</strong></li><li><strong>周辺パッケージの更新</strong></li></ul></li><li>Vue3からの新規推奨事項の適用<ul><li><strong>ビルドツール変更</strong>：Vue CLI ⇒ Vite<ul><li>起動時間の爆速化<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>のため実施</li></ul></li><li><strong>IDEサポート変更</strong>：Vetur ⇒ Vue - Official<ul><li>Veturの無効化<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup>のため実施</li><li><code>.vscode/extensions.json</code>に、推奨&#x2F;非推奨の拡張機能を記載して実装<sup id="fnref:3"><a href="#fn:3" rel="footnote">3</a></sup></li></ul></li><li><strong>状態管理ライブラリ変更</strong>：Vuex ⇒ Pinia<ul><li>TypeScript化の容易性のため実施</li></ul></li><li><strong>テストライブラリ変更</strong>：Jest ⇒ Vitest<ul><li>Vite使用時、大幅簡潔化できるため実施</li></ul></li><li><strong>API変更</strong><sup id="fnref:4"><a href="#fn:4" rel="footnote">4</a></sup>：Options API ⇒ Composition API（<code>script setup</code>）<ul><li>TypeScript化の容易性のため実施</li></ul></li><li><strong>TypeScript化（環境設定のみ）</strong><sup id="fnref:5"><a href="#fn:5" rel="footnote">5</a></sup><ul><li>コードの型安全性向上のため実施</li></ul></li></ul></li></ol><h2 id="躓いたポイント"><a href="#躓いたポイント" class="headerlink" title="躓いたポイント"></a>躓いたポイント</h2><h3 id="Auth0の移行"><a href="#Auth0の移行" class="headerlink" title="Auth0の移行"></a>Auth0の移行</h3><p>（<strong>周辺パッケージの更新</strong>に対応）</p><p>Vue2では<code>@auth0/auth0-spa-js</code>というライブラリを使用して、ラッパーを自作する形で使用することが推奨されていました。<br>一方でVue3からは<code>auth0-vue</code>というラッパーを内包したライブラリを使用することが推奨されるようになりました。</p><p>特にラッパーをカスタマイズせず使用していた場合はそのまま移行すれば問題ないですが、カスタマイズされている場合は大変な作業になると思います。</p><p>私の場合は、カスタマイズされたラッパーが使用されていましたが、その後すぐに認証システムがAuth0から変更になる予定であったため、暫定的にライブラリを改造して対応しました。</p><h3 id="Vuetifyの移行"><a href="#Vuetifyの移行" class="headerlink" title="Vuetifyの移行"></a>Vuetifyの移行</h3><p>（<strong>周辺パッケージの更新</strong>に対応）</p><p><a href="#%E6%8C%AF%E3%82%8A%E8%BF%94%E3%82%8A">振り返り</a>でVuetifyの移行の大変さには触れていますが、ここではとりわけ躓いたポイントに絞って紹介します。</p><h4 id="v-date-pickerが取る値の型がString型からDate型に変更"><a href="#v-date-pickerが取る値の型がString型からDate型に変更" class="headerlink" title="v-date-pickerが取る値の型がString型からDate型に変更"></a><code>v-date-picker</code>が取る値の型が<code>String</code>型から<code>Date</code>型に変更</h4><p>データの受け渡しが当然うまくいかなくなりました。<br>私の場合、以下状況を踏まえ、<code>Date</code>型用の変数を新たに用意し、<code>watch</code>と<code>@update:model-value</code>を用いて同期させる形で修正しました。</p><ul><li>常に<code>v-text-field</code>と組み合わせて使用されている</li><li>データの受け渡しは広い範囲で行われている</li></ul><p>実装例：<br>※比較が容易のため、Options APIで記載しています。<br>※<code>v-menu</code>や<code>v-slot</code>の変更も含まれています。</p><figure class="highlight diff"><figcaption><span>DatePicker.vue</span></figcaption><table><tr><td class="code"><pre><span class="line"> &lt;script&gt;</span><br><span class="line"><span class="addition">+import dayjs from &#x27;dayjs&#x27;</span></span><br><span class="line"> export default &#123;</span><br><span class="line">   data() &#123;</span><br><span class="line">     return &#123;</span><br><span class="line">       dateText: &#x27;&#x27;,</span><br><span class="line"><span class="addition">+      dateTime: undefined,</span></span><br><span class="line"><span class="addition">+      menuFlg: false,</span></span><br><span class="line">     &#125;</span><br><span class="line">   &#125;,</span><br><span class="line"><span class="addition">+  watch: &#123;</span></span><br><span class="line"><span class="addition">+    dateText() &#123;</span></span><br><span class="line"><span class="addition">+      if (this.dateText) &#123;</span></span><br><span class="line"><span class="addition">+        this.dateTime = dayjs(this.dateText).toDate()</span></span><br><span class="line"><span class="addition">+      &#125; else &#123;</span></span><br><span class="line"><span class="addition">+        this.dataTime = undefined</span></span><br><span class="line"><span class="addition">+      &#125;</span></span><br><span class="line"><span class="addition">+    &#125;,</span></span><br><span class="line"><span class="addition">+  &#125;,</span></span><br><span class="line"><span class="addition">+  methods: &#123;</span></span><br><span class="line"><span class="addition">+    setDateText() &#123;</span></span><br><span class="line"><span class="addition">+      this.dateText = dayjs(this.dateTime).format(&#x27;YYYY-MM-DD&#x27;)</span></span><br><span class="line"><span class="addition">+      this.menuFlg = false</span></span><br><span class="line"><span class="addition">+    &#125;,</span></span><br><span class="line"><span class="addition">+  &#125;,</span></span><br><span class="line"> &#125;</span><br><span class="line"> &lt;/script&gt;</span><br><span class="line"></span><br><span class="line"> &lt;template&gt;</span><br><span class="line">   &lt;div&gt;</span><br><span class="line">     &lt;!-- dateTextの値が直接変更される場合を再現するボタン --&gt;</span><br><span class="line">     &lt;v-btn @click=&quot;dateText = &#x27;2024-04-01&#x27;&quot;&gt; dateText = &#x27;2024-04-01&#x27; &lt;/v-btn&gt;</span><br><span class="line"></span><br><span class="line"><span class="deletion">-    &lt;v-menu&gt;</span></span><br><span class="line"><span class="deletion">-      &lt;template #activator=&quot;&#123; on, attrs &#125;&quot;&gt;</span></span><br><span class="line"><span class="addition">+    &lt;v-menu v-model=&quot;menuFlg&quot; :close-on-content-click=&quot;false&quot;&gt;</span></span><br><span class="line"><span class="addition">+      &lt;template #activator=&quot;&#123; props &#125;&quot;&gt;</span></span><br><span class="line">         &lt;v-text-field</span><br><span class="line">           v-model=&quot;dateText&quot;</span><br><span class="line"><span class="deletion">-          v-bind=&quot;attrs&quot;</span></span><br><span class="line"><span class="deletion">-          v-on=&quot;on&quot;</span></span><br><span class="line"><span class="addition">+          v-bind=&quot;props&quot;</span></span><br><span class="line">           readonly</span><br><span class="line">           clearable</span><br><span class="line">         &gt;&lt;/v-text-field&gt;</span><br><span class="line">       &lt;/template&gt;</span><br><span class="line">       &lt;v-date-picker</span><br><span class="line"><span class="deletion">-        v-model=&quot;dateText&quot;</span></span><br><span class="line"><span class="deletion">-        :day-format=&quot;(date) =&gt; new Date(date).getDate()&quot;</span></span><br><span class="line"><span class="addition">+        v-model=&quot;dateTime&quot;</span></span><br><span class="line"><span class="addition">+        @update:model-value=&quot;setDateText&quot;</span></span><br><span class="line">       &gt;&lt;/v-date-picker&gt;</span><br><span class="line">     &lt;/v-menu&gt;</span><br><span class="line">   &lt;/div&gt;</span><br><span class="line"> &lt;/template&gt;</span><br></pre></td></tr></table></figure><p>もっとも、タイムゾーンの問題があるため、基本的に日付データの受け渡しは単なる文字列ではなく、タイムゾーン情報を含めて行うのがベターです。</p><h4 id="一部コンポーネントが未実装"><a href="#一部コンポーネントが未実装" class="headerlink" title="一部コンポーネントが未実装"></a>一部コンポーネントが未実装</h4><p>Vuetifyはまだ一部コンポーネントが未実装であり、該当コンポーネントが実装に含まれる場合は個別で対応が必要になります。</p><p>私の場合は<code>v-treeview</code>が未実装でした（<code>v3.5.9</code>で実装済）。<br>自作難度がそこまで高くないコンポーネントであったため助かりました。</p><h3 id="Vue3に対応していないライブラリの移行"><a href="#Vue3に対応していないライブラリの移行" class="headerlink" title="Vue3に対応していないライブラリの移行"></a>Vue3に対応していないライブラリの移行</h3><p>（<strong>周辺パッケージの更新</strong>に対応）</p><h4 id="smartweb-vue-flash-messageの廃止"><a href="#smartweb-vue-flash-messageの廃止" class="headerlink" title="@smartweb/vue-flash-messageの廃止"></a><code>@smartweb/vue-flash-message</code>の廃止</h4><p>使用していたフラッシュメッセージ機能を提供してくれるライブラリがVue3では使用できませんでした。</p><p>こちらはコンポーネントを自作しても対応できそうでしたが、ちょうど良さそうな代替ライブラリ<code>@alamtheinnov/flashtoast</code>を発見したため、こちらを代わりに使用する形で対応しました。</p><h4 id="vue-clipboard2の廃止"><a href="#vue-clipboard2の廃止" class="headerlink" title="vue-clipboard2の廃止"></a><code>vue-clipboard2</code>の廃止</h4><p>使用していたクリップボード機能を提供してくれるライブラリがVue3では使用できませんでした。</p><p>Vue3に対応した類似ライブラリはいくつか存在したものの、Web APIの<a href="https://developer.mozilla.org/ja/docs/Web/API/Clipboard/writeText">Clipboard.writeText()</a>が主要ブラウザのいずれにも対応しており、機能面の差異もほとんどないことから、このAPIを使用して対応する方針に決めました。<br>（ただし、実際に蓋を開けてみるとプロジェクト内で使用されていなかったため、この対応は不要になりました。）</p><h3 id="Yarnがおかしい"><a href="#Yarnがおかしい" class="headerlink" title="Yarnがおかしい"></a>Yarnがおかしい</h3><p>（<strong>ビルドツール変更</strong>に対応）</p><p>パッケージ管理ツールとしてYarn v1が使用されていたのですが、ViteでファイルをES Modulesとして扱って実行した際に、次のようなエラーに遭遇しました。</p><p>推測ですが、CommonJSとES Modulesが併存するライブラリをインストールする際に、パッケージの依存関係次第でうまくいかなくなるようです。</p><p>結論としてはYarn v1はそもそも非推奨であるため、npmに移行して対応しました。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">Error [ERR_REQUIRE_ESM]: require() of ES Module &lt;path&gt;/node_modules/string-width/index.js</span><br></pre></td></tr></table></figure><p>類似のissueは様々に挙げられており（<a href="https://github.com/storybookjs/storybook/issues/22431">https://github.com/storybookjs/storybook/issues/22431</a> 等）、Yarn v1のバグであると考えられています。</p><h1 id="振り返り"><a href="#振り返り" class="headerlink" title="振り返り"></a>振り返り</h1><p>私にとって一番大変だったのは、このメジャーバージョンアップを行うにあたり、Vueの何をどのように更新すれば良いのか把握する所だったかと思います。自分的にもここが最も重要な所であると考えていたため、Vueの全体像把握に注力しながら対応内容の洗い出しを行った記憶があります。</p><p>対応内容が洗い出された後は、基本的にそれぞれのパッケージに対応する公式ドキュメントに従って移行すれば問題なくVue3化できました。</p><p>とはいえ、以下の点で大変であることは間違いないと思います。</p><ul><li>公式ドキュメントを逐一確認する必要がある</li><li>バージョンを上げれば完了するものからソースコードを大きく修正する必要のあるものまで幅広く存在する</li><li>Vue3に対応していないものも存在する</li></ul><p>他と比較しても群を抜いて大変だったのが、Vuetifyの更新でした。</p><p>UIを担ってくれるこのライブラリの変更点は、公式ドキュメントですら網羅できないほどあるだけでなく、見た目も変化してしまう箇所があるため、実装箇所を逐一確認して修正する他ありませんでした。（もちろん<code>eslint-plugin-vuetify</code>を使用すれば幾分か楽できますが、これも変更点を全て網羅しているわけではないため注意が必要です。）</p><p>一方で、API変更に伴うテストコードの修正は予想に反してほとんどありませんでした。</p><h1 id="さいごに"><a href="#さいごに" class="headerlink" title="さいごに"></a>さいごに</h1><p>比較的ざっくりとVueバージョンアップについて経験を踏まえたお話ししました。</p><p>詳細な部分については、各々のVueプロジェクトに対し、使用しているライブラリを踏まえ、比較的整備されている公式ドキュメント類とにらめっこしながら、柔軟に対応していくしかないと思いました。</p><p>本記事の内容は、これからVueバージョンアップする際に直接的な手助けはしてくれないと思いますが、心構えの助けなんかになればと思っています。</p><p>今回のバージョンアップにあたり、Vue.js周りの様々な質問に答えて下さった太田洋介さん、そして本案件を通じて様々なサポートをして下さった澁川喜規さんには深く感謝申し上げます。</p><p>最後までありがとうございました。</p><div id="footnotes"><hr><div id="footnotelist"><ol style="list-style:none; padding-left: 0;"><li id="fn:1"><span style="vertical-align: top; padding-right: 10px;">1.</span><span style="vertical-align: top;">冗談抜きで100倍くらい早くなりました。</span><a href="#fnref:1" rev="footnote"> ↩</a></li><li id="fn:2"><span style="vertical-align: top; padding-right: 10px;">2.</span><span style="vertical-align: top;"><a href="https://ja.vuejs.org/guide/scaling-up/tooling.html#ide-support">https://ja.vuejs.org/guide/scaling-up/tooling.html#ide-support</a> より、無効化が推奨されています。</span><a href="#fnref:2" rev="footnote"> ↩</a></li><li id="fn:3"><span style="vertical-align: top; padding-right: 10px;">3.</span><span style="vertical-align: top;">デフォルトでは非推奨の拡張機能が使用されていても通知してくれないので<code>Unwanted Recommendations</code>という拡張機能も追加しています。</span><a href="#fnref:3" rev="footnote"> ↩</a></li><li id="fn:4"><span style="vertical-align: top; padding-right: 10px;">4.</span><span style="vertical-align: top;">便宜上&quot;Vue3からの新規推奨事項の適用&quot;に記載していますが、公式ドキュメントで名言されている箇所は特に存在していなかったと記憶しています（注目の新機能とは言われています）。</span><a href="#fnref:4" rev="footnote"> ↩</a></li><li id="fn:5"><span style="vertical-align: top; padding-right: 10px;">5.</span><span style="vertical-align: top;">Vue3からTypeScriptへのサポートが強化されたため実施しています。工数の関係でJavaScriptからTypeScriptへ書き換えることはできず、環境設定のみの対応となったため、&quot;<strong>（環境設定のみ）</strong>&quot;としています。</span><a href="#fnref:5" rev="footnote"> ↩</a></li></ol></div></div>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;img src=&quot;/images/20240405a/top.png&quot; alt=&quot;&quot; width=&quot;800&quot; height=&quot;487&quot;&gt;

&lt;h1 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot;</summary>
        
      
    
    
    
    <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
    <category term="Vue.js" scheme="https://future-architect.github.io/tags/Vue-js/"/>
    
    <category term="Vue3" scheme="https://future-architect.github.io/tags/Vue3/"/>
    
    <category term="Vuetify" scheme="https://future-architect.github.io/tags/Vuetify/"/>
    
    <category term="バージョン管理" scheme="https://future-architect.github.io/tags/%E3%83%90%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3%E7%AE%A1%E7%90%86/"/>
    
    <category term="vue2" scheme="https://future-architect.github.io/tags/vue2/"/>
    
  </entry>
  
  <entry>
    <title>Difyで生成AIアプリケーション入門　後編：自作プログラムで機能追加して生成AIの指向性と精度を高める</title>
    <link href="https://future-architect.github.io/articles/20240404a/"/>
    <id>https://future-architect.github.io/articles/20240404a/</id>
    <published>2024-04-03T15:00:00.000Z</published>
    <updated>2024-04-08T00:52:52.721Z</updated>
    
    <content type="html"><![CDATA[<h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><p><a href="/articles/20240402a/">前回</a>に引き続き <a href="https://dify.ai/">Dify</a> と <a href="https://console.anthropic.com/dashboard">Anthropic Claude</a> （OpenAI でも OpenRouter 経由の何かでもOK）を使って簡単に生成AIアプリケーションを構築する方法をご紹介します。</p><h2 id="チュートリアル3：セルフレビュー機能付きのSQL生成AIチャットbot"><a href="#チュートリアル3：セルフレビュー機能付きのSQL生成AIチャットbot" class="headerlink" title="チュートリアル3：セルフレビュー機能付きのSQL生成AIチャットbot"></a>チュートリアル3：セルフレビュー機能付きのSQL生成AIチャットbot</h2><p><a href="/articles/20240402a/">前編のチュートリアル1</a>で作ったSQL生成チャットbotをベースに、セルフレビュー機能を追加し、間違ったSQL文や存在しないテーブルやカラムを使用しようとした時に自動でやり直すように改修します。</p><h3 id="DB用意"><a href="#DB用意" class="headerlink" title="DB用意"></a>DB用意</h3><p>SQLの実行環境が必要になりますが、ちょうど Dify が使用している DB（Postgresql） サービスがあるので、これにホストOSからアクセスできるようにします。別でDBを用意できる場合はそちらでもOKです。</p><p><code>docker-compose.yml</code> で以下の行をアンコメントしてください。</p><figure class="highlight yml"><figcaption><span>docker-compoese.yml</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment"># uncomment to expose db(postgresql) port to host</span></span><br><span class="line"><span class="comment"># ports:</span></span><br><span class="line"><span class="comment">#   - &quot;5432:5432&quot;</span></span><br></pre></td></tr></table></figure><p>これでホストOSから下記で接続できます。</p><ul><li>ホスト・ポート <code>localhost:5432</code> </li><li>DB名 <code>dify</code></li><li>ユーザ名 <code>postgres</code></li><li>パスワード <code>difyai123456</code></li></ul><p>適当に新しいスキーマを作り、DDLを流します。ここでは例としてスキーマ名 <code>test1</code> に<a href="/articles/20240402a/">前編で例示したDDL</a>を実行した事にして話を進めます。</p><h3 id="レビュー機能を提供するアプリケーションを実装"><a href="#レビュー機能を提供するアプリケーションを実装" class="headerlink" title="レビュー機能を提供するアプリケーションを実装"></a>レビュー機能を提供するアプリケーションを実装</h3><p>「SQL文を受け取り」「実行結果の正否とエラーメッセージを返す」だけの簡単な Web API を備えたアプリケーションを開発します。このIN&#x2F;OUTさえ守っていれば言語やフレームワークは問いませんが、この例では Java の Spring Boot アプリケーションにします。</p><details><summary>pom.xml & Applicationクラス</summary><figure class="highlight xml"><figcaption><span>pom.xml</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rdb-repository<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span>rdb-repository<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">java.version</span>&gt;</span>17<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springdoc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springdoc-openapi-starter-webmvc-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>jp.co.future<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>uroborosql<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>0.26.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.postgresql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>postgresql<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>42.7.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.32<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><figcaption><span>RdbRepositoryApplication.java</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.rdbrepository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RdbRepositoryApplication</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">SpringApplication.run(RdbRepositoryApplication.class, args);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details><figure class="highlight java"><figcaption><span>RdbRepositoryController.java</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/rdb&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RdbRepositoryController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(RdbRepositoryController.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/sql_review&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> SqlReviewResponse <span class="title function_">sqlReview</span><span class="params">(<span class="meta">@RequestParam</span> String query)</span> &#123;</span><br><span class="line">        <span class="type">SqlConfig</span> <span class="variable">config</span> <span class="operator">=</span> UroboroSQL.builder(<span class="string">&quot;jdbc:postgresql://localhost:5432/dify?currentSchema=test1&quot;</span>, <span class="string">&quot;postgres&quot;</span>, <span class="string">&quot;difyai123456&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">SqlAgent</span> <span class="variable">agent</span> <span class="operator">=</span> config.agent()) &#123;</span><br><span class="line">            agent.queryWith(query).collect(); <span class="comment">// ⛔受け取ったSQL何でも実行するので実験環境以外で真似しない事😱</span></span><br><span class="line">            logger.info(query);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SqlReviewResponse</span>().setSuccess(<span class="literal">true</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(e.getMessage(), e);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SqlReviewResponse</span>().setErrorMessage(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="meta">@Accessors(chain = true)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SqlReviewResponse</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">String</span> <span class="variable">errorMessage</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>OpenAPI (Swagger) 準拠のスキーマが必要になります。上の例では <code>dependency</code> に <code>springdoc-openapi-starter-webmvc-ui</code> を加えているのでアプリケーション起動後に <a href="http://localhost:8080/v3/api-docs">http://localhost:8080/v3/api-docs</a> に勝手に生成されています。</p><h3 id="作ったアプリケーションをDifyにツールとして登録"><a href="#作ったアプリケーションをDifyにツールとして登録" class="headerlink" title="作ったアプリケーションをDifyにツールとして登録"></a>作ったアプリケーションをDifyにツールとして登録</h3><p>（先ほど作ったアプリケーションは起動してリクエストを受け付ける状態にしておいてください。）</p><p>画面上部のメニュー右端の<a href="http://localhost/tools?category=api">ツール</a>をクリックし、左上の「カスタムツールを作成する」をクリックします。</p><img src="/images/20240404a/image.png" alt="" width="573" height="143" loading="lazy"><p>名前は適当につけて、APIのスキーマは手動でコピペするか、（Dockerの設定でホスト名 <code>host.docker.internal</code> を有効にしているなら） <a href="http://host.docker.internal:8080/v3/api-docs">http://host.docker.internal:8080/v3/api-docs</a> 等を使ってインポートします。ここで念のためテストして通れば準備OKです。保存してください。</p><img src="/images/20240404a/image_2.png" alt="" width="581" height="694" loading="lazy"><img src="/images/20240404a/image_3.png" alt="" width="450" height="362" loading="lazy"><h3 id="AIアプリケーションを開発"><a href="#AIアプリケーションを開発" class="headerlink" title="AIアプリケーションを開発"></a>AIアプリケーションを開発</h3><p>チュートリアル2と同様、スタジオ→新しいアプリを作成する→アシスタント で新しいアプリケーションを作成し、アシスタントタイプをエージェントアシスタントにします。</p><p>画面中央のツールの「+追加」をクリックし「カスタム」を選択すると、先ほど登録した自作ツールが表示されているので選択して「追加」ボタンをクリックします。</p><img src="/images/20240404a/image_4.png" alt="" width="588" height="228" loading="lazy"><p>「手順」はチュートリアル2の内容に1行追加し、ツールを使うように指示します。変数 <code>&#123;&#123;DDL&#125;&#125;</code> <code>&#123;&#123;DataModelDescriptions&#125;&#125;</code> は前回同様「段落」に変更するのをお忘れなく。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">You can behave as an expert of database expert. Provide a clear answer to the main purpose of the order. Omit preamble, phase, and repeating the order.</span><br><span class="line"></span><br><span class="line">DDL:</span><br><span class="line">```</span><br><span class="line">&#123;&#123;DDL&#125;&#125;</span><br><span class="line">```</span><br><span class="line">Data model descriptions:</span><br><span class="line">```</span><br><span class="line">&#123;&#123;DataModelDescriptions&#125;&#125;</span><br><span class="line"></span><br><span class="line">Generated SQL must be validated using the tool `sqlReview`, then respond only with the SQL that passed the inspection.</span><br></pre></td></tr></table></figure><h3 id="動作確認"><a href="#動作確認" class="headerlink" title="動作確認"></a>動作確認</h3><p>チュートリアル2で使用したDDLとデータモデル概要を設定しつつ、「全売上金額を合計するSQL」のようにごく単純な要件でテストすると、ツールを使用してから回答する様子が確認できます。</p><img src="/images/20240404a/image_5.png" alt="" width="436" height="451" loading="lazy"><p>ところが、少し複雑な要求に変更すると途端に回答が破綻します。</p><img src="/images/20240404a/image_6.png" alt="" width="820" height="645" loading="lazy"><p>出力をよく見ると、　<code>&quot;action_input&quot;: &quot; ~ &quot;&#125;</code> の中身が改行付きのSQL文のため、JSONとして破綻しています。 <code>&#123;&quot;action&quot;: $TOOL_NAME, &quot;action_input&quot;: $ACTION_INPUT&#125;</code> の部分が（ReAct方式での）ツール呼び出しのキモなので、この部分に異常があると上手くツールを使用できないようです。</p><p>プロンプトに「SQLは1行に纏めよ」と付け加えれば動作はするのですが……。Function Calling 方式を指定できないモデルでは現状スマートな解決策は無さそうです。 <sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup></p><img src="/images/20240404a/image_7.png" alt="" width="827" height="259" loading="lazy"><p>さて、SQLのレビューに失敗した場合はどうなるのか？少し意地悪をして、変数 <code>DDL</code> をオプション扱いにして、空欄にして実行してみます。</p><img src="/images/20240404a/image_8.png" alt="" width="608" height="147" loading="lazy"><img src="/images/20240404a/image_9.png" alt="" width="821" height="872" loading="lazy"><p>本来なら「カラム名が分からないから答えられない」と回答させるようコンテキストで誘導するのがベストな場面ではありますが、ともあれこれでセルフレビューによりAIが試行錯誤する様子を確認できました。</p><h3 id="このツールの改善アイデア"><a href="#このツールの改善アイデア" class="headerlink" title="このツールの改善アイデア"></a>このツールの改善アイデア</h3><p>ここまでの試行の延長として、レビューの質を高めるために例えば次のようなアイデアが挙げられます。よければチャレンジしてみてください。</p><ul><li>生成されたSQLのSELECT結果を返して「要件通りの検索結果が全パターン・全カラム抽出できたか」「算出項目の数値が期待値通りか」を検証させる</li><li>実行計画を返して「最大のパフォーマンスが出る結合順序・条件を指定できたか」を考えさせる</li></ul><p>また、折角生成AIの領域とプログラマブルな領域に接点が出来たのだから、生成AIから自作プログラムが呼ばれた時のパラメータとそれへの返り値をDBに登録して、「どんな要求を受けた時にどんなSQLが生成されて、それがどう成功(or失敗)したか」を記録する事で後々分析したりAIの教育データとして使うといった事も考えられます。</p><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>Dify を使ってノーコードで生成AIを使ったアプリケーションを開発する方法と、従来型のアプリケーションとの連携方法について入門する所までご紹介してきました。入門とは言えある程度までの規模の問題解決の手段としては充分実用レベルになると思います。</p><p>が、これを例えばエンタープライズシステム開発など大規模な領域で活用しようと思うとすぐさま「膨大なデータモデルや業務要件を全て詰め込むとコンテキストが飽和する・トークン数が爆発する」といった問題に突き当たります。</p><p>RAG（ユーザが入力したプロンプトをAIに投げる前に、関連する情報を抜粋し追記してから生成AIに中継する仕組み）やモデル自体の追加学習によって解決するアプローチもありますがそれはまた別のお話で。</p><p>ちなみにただ”RAGとやらを作って使ってみたい”だけであれば Dify では画面上部メニューの「ナレッジ」で作成してアプリ側で「コンテキスト」に追加してやるだけなのですぐにでもできます。RAGの品質を問わなければの話ですが…今回はここまでです。</p><div id="footnotes"><hr><div id="footnotelist"><ol style="list-style:none; padding-left: 0;"><li id="fn:1"><span style="vertical-align: top; padding-right: 10px;">1.</span><span style="vertical-align: top;">4月5日に、GPT の Function Calling に相当する機能 &quot;Tool&quot; が Claude に追加されました。 Dify も当日中(!)に対応しました。4月6日現在、まだバージョン付けされた Docker イメージは有りませんが、 <code>docker-compose.yaml</code> で <code>api</code>,<code>worker</code>,<code>web</code> の <code>image</code> のタグの部分を <code>main</code> にすれば一応動作確認はできますので自己責任でどうぞ。複数行に跨るSQLもちゃんとツールに渡されてますね！ <img src="/images/20240404a/image_10.png" alt="" width="759" height="446" loading="lazy"></span><a href="#fnref:1" rev="footnote"> ↩</a></li></ol></div></div>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;概要&quot;&gt;&lt;a href=&quot;#概要&quot; class=&quot;headerlink&quot; title=&quot;概要&quot;&gt;&lt;/a&gt;概要&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;/articles/20240402a/&quot;&gt;前回&lt;/a&gt;に引き続き &lt;a</summary>
        
      
    
    
    
    <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
    <category term="Java" scheme="https://future-architect.github.io/tags/Java/"/>
    
    <category term="ノーコード" scheme="https://future-architect.github.io/tags/%E3%83%8E%E3%83%BC%E3%82%B3%E3%83%BC%E3%83%89/"/>
    
    <category term="生成AI" scheme="https://future-architect.github.io/tags/%E7%94%9F%E6%88%90AI/"/>
    
    <category term="Dify" scheme="https://future-architect.github.io/tags/Dify/"/>
    
    <category term="Anthropic Claude" scheme="https://future-architect.github.io/tags/Anthropic-Claude/"/>
    
  </entry>
  
  <entry>
    <title>技育祭2024春で「2064年もITで仕事し続けるためのキャリアプラン」というタイトルで発表してきました。</title>
    <link href="https://future-architect.github.io/articles/20240403a/"/>
    <id>https://future-architect.github.io/articles/20240403a/</id>
    <published>2024-04-02T15:00:00.000Z</published>
    <updated>2024-04-03T00:48:43.524Z</updated>
    
    <content type="html"><![CDATA[<img src="/images/20240403a/top.png" alt="" width="800" height="441"><p>技育祭はサポーターズが実施している未来の「技」術者を「育」てる活動としている学生向けの「技育プロジェクト」の一大イベントです。僕自身も何度かかかわっているイベントで、先日開催された2024年3月17日に開催された「技育祭2024春」で登壇してきました。発表資料はこちらになります。</p><iframe src="https://www.slideshare.net/slideshow/embed_code/key/1vsRjQlfzzpNfo?hostedIn=slideshare&page=upload" width="476" height="400" frameborder="0" marginwidth="0" marginheight="0" scrolling="no"></iframe><p>タイトルの2064年というのは、技育祭で一番ボリュームゾーンだと思われる20歳ぐらいの学部2年、3年の若者が60歳定年まで働くとしたら、という年ですね。AIでIT技術者がいらなくなる、みたいな話がよくされていますが、AI以前に優秀すぎる若者が周りにいっぱい増えてきて、ずっと前から危機感を感じていた40代のおっさんのキャリアプランをテーマに今回は講演を行いました。</p><p>私は今後AIの革新的発展によってプログラマーの人数が半分になるとしても、上から半分に入っていれば生き残れるだろうという打算のもと、技術力の向上や、プログラマーとしての市場価値を向上させていく、そしてそれを見える化する、というのが基本戦略としてやっています。今回の発表では時間もなかったので割愛しましたが書籍執筆もそのための一手です。本を書く、というのをここしばらくは年に2冊ぐらい継続しています。これに関する説明を一枠しゃべったときの、2021年の技育祭の資料も張っておきますね。</p><iframe src="https://www.slideshare.net/slideshow/embed_code/key/EjKVxpJUE56bPZ?hostedIn=slideshare&page=upload" width="476" height="400" frameborder="0" marginwidth="0" marginheight="0" scrolling="no"></iframe><p>今回のイベントでは自分と聴講者層の大学生の年齢差が大きくなってきたということで、まさに技育祭でフューチャーを知って入ってくれた若手の大岩さんにもアシスタントとして参加してもらいました。親子といっても嘘じゃないぐらい年齢差があっても仲良く仕事しているというのも伝わればいいな、というのもちょっぴり思っていましたがいかがでしたでしょうか？大岩さんとは、技術広報として、会社の魅力を外に伝えていくにはどうすればよいのか？という課外活動を一緒にやっています。</p><h1 id="質疑応答"><a href="#質疑応答" class="headerlink" title="質疑応答"></a>質疑応答</h1><h2 id="Q-IT職は人気なのに人手不足なのはどうしてでしょうか？"><a href="#Q-IT職は人気なのに人手不足なのはどうしてでしょうか？" class="headerlink" title="Q: IT職は人気なのに人手不足なのはどうしてでしょうか？"></a>Q: IT職は人気なのに人手不足なのはどうしてでしょうか？</h2><p>みんなIT力を高めてビジネスを強くしたいと思って、たくさん人が欲しいので、需要がすごく増えています。</p><h2 id="Q-早く一人前にならなければという危機感があるが一人前になるというのはどういうことか？"><a href="#Q-早く一人前にならなければという危機感があるが一人前になるというのはどういうことか？" class="headerlink" title="Q: 早く一人前にならなければという危機感があるが一人前になるというのはどういうことか？"></a>Q: 早く一人前にならなければという危機感があるが一人前になるというのはどういうことか？</h2><p>言われたことができる→自発的にできる→自分より若手をリードしつつできる→自分から道を切り開ける</p><p>というのが思っていることで、実際にフューチャーのランクアップ要件もこんな感じ。フューチャーは年功序列ではないので、これができている若者は年齢関係なくじゃんじゃんランクアップしていますね。</p><h2 id="Q-ITコンサルは-要件定義など人と関わる部分がメインで開発に携わることが少ないと考えているのですが-いかがですか"><a href="#Q-ITコンサルは-要件定義など人と関わる部分がメインで開発に携わることが少ないと考えているのですが-いかがですか" class="headerlink" title="Q: ITコンサルは, 要件定義など人と関わる部分がメインで開発に携わることが少ないと考えているのですが, いかがですか?"></a>Q: ITコンサルは, 要件定義など人と関わる部分がメインで開発に携わることが少ないと考えているのですが, いかがですか?</h2><p>会社にもよると思いますが、フューチャーは一次受けで、お客さんとグランドデザイン策定から要件定義、実装、運用まで一気通貫でやる会社なので、実装とかもよくやっています。</p><h2 id="Q-現状未経験の人がこれから勉強を始める場合まず何から始めるべきでしょうか？"><a href="#Q-現状未経験の人がこれから勉強を始める場合まず何から始めるべきでしょうか？" class="headerlink" title="Q: 現状未経験の人がこれから勉強を始める場合まず何から始めるべきでしょうか？"></a>Q: 現状未経験の人がこれから勉強を始める場合まず何から始めるべきでしょうか？</h2><p>フューチャーは大学時代にITをやっていなかった学生も新卒で入っています。新入社員研修をきちんと行ってその後エンジニアとして活躍している社員も多いです。キャリアパスは自分で選べるので、学んだ上でお客さんと話をするのをメインとして選ぶ人もいますが。</p><p>そういうきちんと鍛えてくれる会社に入るのが良いと思います。でも、どうすれば入れるか、各社がどういう人材を求めているかは各社ばらばらなので「こうすれば大丈夫！」という正解はちょっとわからないですね。</p><h2 id="Q-他の方が「泥臭くても、コツコツ、貪欲にやる」が良いという旨の話をよくしているのですが、渋川さんもそう思いますか？"><a href="#Q-他の方が「泥臭くても、コツコツ、貪欲にやる」が良いという旨の話をよくしているのですが、渋川さんもそう思いますか？" class="headerlink" title="Q: 他の方が「泥臭くても、コツコツ、貪欲にやる」が良いという旨の話をよくしているのですが、渋川さんもそう思いますか？"></a>Q: 他の方が「泥臭くても、コツコツ、貪欲にやる」が良いという旨の話をよくしているのですが、渋川さんもそう思いますか？</h2><p>そう思います。といっても、同じ仕事を10年やり続けるとかそういうのはいらないと思います。学生のうちは「こんなことしたい」とキラキラした仕事をやりたいと思うかもしれないですが、自分が想像もしていない仕事が上から降ってきたりします。でもそういう未知だったものこそ、自分が知らないものがたくさんあって実力を伸ばすチャンスにつながるかもしれない。あらかじめ見えていた目線というのは実はそこまで広くなかった、ということは十分にある。目の前に来た仕事にまずは全力で取り組んでみるというのは大切。</p><h1 id="質疑応答の残りや拾ったコメント"><a href="#質疑応答の残りや拾ったコメント" class="headerlink" title="質疑応答の残りや拾ったコメント"></a>質疑応答の残りや拾ったコメント</h1><h2 id="ドメイン知識も若い人はすぐ追いつくと思う"><a href="#ドメイン知識も若い人はすぐ追いつくと思う" class="headerlink" title="ドメイン知識も若い人はすぐ追いつくと思う"></a>ドメイン知識も若い人はすぐ追いつくと思う</h2><p>ドメイン知識って教科書的に資料としてまとまっていたりはしないんですよね。お客さんもたくさんの部署に分かれていて、それぞれの領域で仕事をしている。それぞれの領域の中の「常識」をつなげていくと知識体系が現れる。あとは既存のシステムの中にソースコードとして書かれた知識もある。利用者はボタンを押す方法だけ知っているがコアの知識はコード解析しないとわからなかったり。今後はこういうシステム考古学がますます重要になってくるかと思います。</p><p>こういうたくさんの情報を引っ張って集める社会学的な活動を毎回やって初めて知識として取り出せるのですが、その知識の取り出し方、実際に取り出した知識（業界ごとではなく会社ごと、部署ごとに違ったりする）もあるので、学ぶのはだれがやっても大変かと思います。</p><h2 id="自分の得た知識は自分のもの！誰にも公開しない！でも他の人からは情報はもらう！って感じのエンジニアを学生の中に時々みるのですが、自分が長い時間を掛けて得た知識を本で共有するにあたってそのような考えにはならないのでしょうか？"><a href="#自分の得た知識は自分のもの！誰にも公開しない！でも他の人からは情報はもらう！って感じのエンジニアを学生の中に時々みるのですが、自分が長い時間を掛けて得た知識を本で共有するにあたってそのような考えにはならないのでしょうか？" class="headerlink" title="自分の得た知識は自分のもの！誰にも公開しない！でも他の人からは情報はもらう！って感じのエンジニアを学生の中に時々みるのですが、自分が長い時間を掛けて得た知識を本で共有するにあたってそのような考えにはならないのでしょうか？"></a>自分の得た知識は自分のもの！誰にも公開しない！でも他の人からは情報はもらう！って感じのエンジニアを学生の中に時々みるのですが、自分が長い時間を掛けて得た知識を本で共有するにあたってそのような考えにはならないのでしょうか？</h2><p>それで知識を持っていても、外からはどれだけの情報を持っていることが分からないので、結果として本人の魅力アップにはなっていないと思います。あと、自分が手を動かして作業者として仕事するのよりも、回りを導いて組織として成功できる方が社会としては必要とされます。ICよりもマネージャー採用しにくい問題。</p><h2 id="基幹システムって具体的にはどういうものですか？イメージ湧かなくて・・・"><a href="#基幹システムって具体的にはどういうものですか？イメージ湧かなくて・・・" class="headerlink" title="基幹システムって具体的にはどういうものですか？イメージ湧かなくて・・・"></a>基幹システムって具体的にはどういうものですか？イメージ湧かなくて・・・</h2><p>その会社のビジネスの根幹をささえるシステムですね。小売りなら商品を管理して売り上げを集計するなど。</p><h2 id="早いうちに一人前になるような人は外向性の高さやフットワークの軽さなどどのような特性がありますか？"><a href="#早いうちに一人前になるような人は外向性の高さやフットワークの軽さなどどのような特性がありますか？" class="headerlink" title="早いうちに一人前になるような人は外向性の高さやフットワークの軽さなどどのような特性がありますか？"></a>早いうちに一人前になるような人は外向性の高さやフットワークの軽さなどどのような特性がありますか？</h2><p>どちらかというと、求められていることをきちんと把握してやりきるための段取り力ですかねぇ。もちろん、ステージやその時のプロジェクトの状況によって必要な能力とかあるとうれしい能力は変わってくると思いますが。</p><h2 id="支援士のような資格がある人とCTF経験が豊富な人とではどちらの方が需要ありますか"><a href="#支援士のような資格がある人とCTF経験が豊富な人とではどちらの方が需要ありますか" class="headerlink" title="支援士のような資格がある人とCTF経験が豊富な人とではどちらの方が需要ありますか"></a>支援士のような資格がある人とCTF経験が豊富な人とではどちらの方が需要ありますか</h2><p>セキュリティ系ですかね？セキュリティ系はかなりタレント性が強い仕事もあったりするので一般化はしにくいですね。元フューチャーで海外からオファーが来て転職していった若者もいましたし。フューチャーにもセキュリティ特化のグループ会社DITとかフューチャー社内のセキュリティ部門のCSIGがあるので、興味がある方はカジュアル面談を申し込んでいただけると、中の人が事例とかどういうスキルが必要とされているかとかお話できるかと思います。</p><h2 id="失礼なことを聞くようで申し訳ないのですが、フューチャー株式会社は年収どこまで伸ばせますか？"><a href="#失礼なことを聞くようで申し訳ないのですが、フューチャー株式会社は年収どこまで伸ばせますか？" class="headerlink" title="失礼なことを聞くようで申し訳ないのですが、フューチャー株式会社は年収どこまで伸ばせますか？"></a>失礼なことを聞くようで申し訳ないのですが、フューチャー株式会社は年収どこまで伸ばせますか？</h2><p>おっと、それ聞いちゃいます？転職のときにもがっと上がったけど、入ったあともがっがっと上がっています。技育イベントは公開イベントですので、そのあたりはもうちょっとクローズドなフューチャーのイベントで社員の人にぶつけてもらえればと思います。</p><p>年収は能力というか入った会社次第なところがありますが、一般的な傾向としてはきちんと利益を上げていく、業績を伸ばし続けていたり安定している会社が延ばしやすいと思います。</p><p>就活対策で会社が公開しているプレスリリースはきちんと目を通した方が良いですよ、というお話はしましたが、決算資料の数値も見ておくと良いかと思います。</p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;img src=&quot;/images/20240403a/top.png&quot; alt=&quot;&quot; width=&quot;800&quot;</summary>
        
      
    
    
    
    <category term="Culture" scheme="https://future-architect.github.io/categories/Culture/"/>
    
    
    <category term="登壇レポート" scheme="https://future-architect.github.io/tags/%E7%99%BB%E5%A3%87%E3%83%AC%E3%83%9D%E3%83%BC%E3%83%88/"/>
    
    <category term="技育祭" scheme="https://future-architect.github.io/tags/%E6%8A%80%E8%82%B2%E7%A5%AD/"/>
    
    <category term="キャリア" scheme="https://future-architect.github.io/tags/%E3%82%AD%E3%83%A3%E3%83%AA%E3%82%A2/"/>
    
  </entry>
  
  <entry>
    <title>Difyで生成AIアプリケーション入門　前編：生成AIアプリケーションをノーコードで開発</title>
    <link href="https://future-architect.github.io/articles/20240402a/"/>
    <id>https://future-architect.github.io/articles/20240402a/</id>
    <published>2024-04-01T15:00:00.000Z</published>
    <updated>2024-04-04T05:12:16.537Z</updated>
    
    <content type="html"><![CDATA[<h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><p><a href="https://dify.ai/">Dify</a> （DeFiではない）と <a href="https://console.anthropic.com/dashboard">Anthropic Claude</a> （OpenAI でも OpenRouter 経由の何かでもOK）を使って簡単に生成AIアプリケーションを構築する方法をご紹介します。</p><ul><li>前編：ノーコードで生成AIアプリケーションを構築するチュートリアル</li><li><a href="/articles/20240404a/">後編</a>：自作プログラムで機能追加して生成AIの指向性と精度を高めるサンプル</li></ul><p>の2本立ての予定です。</p><h3 id="対象読者"><a href="#対象読者" class="headerlink" title="対象読者"></a>対象読者</h3><ul><li>生成AIに興味があるがまだチャット以上の利用法を見出せず手を出せていない方</li><li>お試しに手軽に生成AIアプリケーションを構築してみたい方</li><li>特にOpenAIに月額費用に躊躇っている方</li></ul><h3 id="前提知識・環境"><a href="#前提知識・環境" class="headerlink" title="前提知識・環境"></a>前提知識・環境</h3><ul><li>Docker (Docker Compose)。Windows なら Docker Desktop。後編ではホスト名 <code>host.docker.internal</code> を使用します</li><li>“時々生成AIをチャットで活用している”程度のプロンプト操作の知識</li></ul><h3 id="取り上げない話題"><a href="#取り上げない話題" class="headerlink" title="取り上げない話題"></a>取り上げない話題</h3><p>何が実現可能になるかを示唆する事にフォーカスするので、手段は深堀しません。例えばRAGには触れません。</p><h2 id="準備"><a href="#準備" class="headerlink" title="準備"></a>準備</h2><p>Anthropic API のAPIキーを取得し、Difyをローカルで起動します。</p><p>サービスとして提供されている <a href="https://dify.ai/">https://dify.ai/</a> を使ってもいいですが、APIキーを預けるのは何となく不安なので＆後編で便利なのでローカルで話を進めます。</p><h3 id="Anthropic-API-でAPIキー取得"><a href="#Anthropic-API-でAPIキー取得" class="headerlink" title="Anthropic API でAPIキー取得"></a>Anthropic API でAPIキー取得</h3><p><a href="https://console.anthropic.com/settings/plans">https://console.anthropic.com/settings/plans</a> で電話番号認証後の初回だけ5ドル分の無料お試し枠が貰えます。既に OpenAI や OpenRouter に課金されている方はそちらでも良いですが以下でモデルを指定する箇所では適宜読み替えてください。</p><p>モデルによりトークン当たりのクレジットの消費量が異なりますが、コスト軸での選択の目安は以下の通りです。</p><ul><li>Haiku：ガンガン使っても殆ど減らないので感触を探る間は当面これで</li><li>Sonnet：試行錯誤していると目に見えて減っていくので残高注意</li><li>Opus：ごっそり減るのでお試し中の常用は非推奨。比較検証したい時のワンポイントで</li></ul><p>もうAnthropicの無料枠を消化してしまった人は <a href="https://openrouter.ai/">https://openrouter.ai/</a> が使えるかもしれません。入金しなくても謎に0.2ドル程度をタダで使わせてくれたり、仮想通貨（PolygonネットワークのUSDC）決済が出来たりします。</p><h3 id="Difyセットアップ"><a href="#Difyセットアップ" class="headerlink" title="Difyセットアップ"></a>Difyセットアップ</h3><h4 id="インストール"><a href="#インストール" class="headerlink" title="インストール"></a>インストール</h4><p><code>git clone https://github.com/langgenius/dify</code> するか、<a href="https://github.com/langgenius/dify/tree/main/docker">https://github.com/langgenius/dify/tree/main/docker</a> の <code>docker-compose.yaml</code> と <code>nginx</code> ディレクトリをダウンロードして、 <code>docker-compose.yaml</code> のある場所で <code>docker compose up -d</code> します。</p><p>実行時のディレクトリ直下にボリュームディレクトリ <code>volumes</code> が作成されます。</p><p>nginx がポート <code>80</code> で起動するので空けておくか <code>services.nginx.ports</code> を適当な値に変えてください。</p><h4 id="初期設定"><a href="#初期設定" class="headerlink" title="初期設定"></a>初期設定</h4><p><a href="http://localhost/">http://localhost/</a> にアクセスすると初回は「管理者アカウントの設定」画面が表示されます。メールアドレスは適当な値で大丈夫ですが次のサインイン画面で使うので何を入れたかは忘れないでください。<br>言語設定は日本語のままでもあまり不自由しませんが、ところどころ未翻訳のテキストが空欄で表示されたり <code>undefined</code> になったりしてしまうので出来れば英語の方がお勧めです。</p><p>サインインしたら、右上のアカウント名をクリックして設定→モデルプロバイダー→Anthropicにマウスオーバーしてセットアップ、と進んでAPIキーを入力します。そのままだとシステムモデルに Claude 3 Opus が使われてしまうので Haiku を選択します。寄稿時点では <code>claude-3-haiku-20240307</code> というモデル名でした。ここでClaudeシリーズが選択できない場合は何かしらエラーが発生しています。原因が分からなければAPIキーを再発行＆再入力してください。</p><img src="/images/20240402a/image.png" alt="" width="891" height="530" loading="lazy"><p>ちなみに OpenRouter を使用するなどして OpenAI 互換のモデルを使用する場合は一番下の <code>Model providers compatible with OpenAI&#39;s API standard, such as LM Studio.</code> で使用できます。が、恐らくDifyの不具合でそれだけではモデルとして使用可能になりません。一度保存したモデル情報を開いて保存しなおすと使用可能になります。</p><h2 id="チュートリアル1：シンプルな生成AIチャットbot"><a href="#チュートリアル1：シンプルな生成AIチャットbot" class="headerlink" title="チュートリアル1：シンプルな生成AIチャットbot"></a>チュートリアル1：シンプルな生成AIチャットbot</h2><p>特定のテーブル定義に対して特化したSQLを生成するチャットbotを作ってみましょう。</p><h3 id="開発"><a href="#開発" class="headerlink" title="開発"></a>開発</h3><ol><li>画面上部の<a href="">スタジオ</a>→新しいアプリを作成する、をクリック。タイプにアシスタントを選択し、適当な名前を付けます。後から変更可能です。（実はおなじみのAIチャットとして使うだけならここまでで完成してしまっています）</li><li>画面左の「手順」に以下を入力します。フォーカスを外すと変数追加をリコメンドしてくれます。追加後このままだと短文しか入力できないので両方 ⚙ で「段落」に変更します。</li></ol><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">You can behave as an expert of database expert. Provide a clear answer to the main purpose of the order. Omit preamble, phase, and repeating the order.</span><br><span class="line"></span><br><span class="line">DDL:</span><br><span class="line">```</span><br><span class="line">&#123;&#123;DDL&#125;&#125;</span><br><span class="line">```</span><br><span class="line">Data model descriptions:</span><br><span class="line">```</span><br><span class="line">&#123;&#123;DataModelDescriptions&#125;&#125;</span><br><span class="line">```</span><br></pre></td></tr></table></figure><img src="/images/20240402a/image_2.png" alt="" width="873" height="321" loading="lazy"><img src="/images/20240402a/image_3.png" alt="" width="768" height="465" loading="lazy"><h3 id="動作確認"><a href="#動作確認" class="headerlink" title="動作確認"></a>動作確認</h3><ol><li>ここで画面右上の「公開」をクリックしてください。しなくても動作確認は出来ますが、変更が保存されていません。実はこの時点で完成したアプリケーションとして公開されてしまいますが、これ以外に開発中のアプリケーションを保存する方法が見当たりませんでした。</li><li><code>DDL</code> に <code>CREATE TABLE ~</code> などのDDLを貼り付けてください。<br><code>DataModelDescriptions</code> に各テーブルの内容や結合方式などについての説明文を貼り付けてください。必須ではありませんがこれが無いとAIはすぐ存在しないカラムの幻覚を見始めるので強く推奨します。<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup><br>（ここで入力した値は永続化されないので、何度も使い回す用に自分でテキストファイルにでも貼り付けて保存しておきましょう）</li><li>画面右下に薄っすらと入力欄が有るのでそこにSQL生成を依頼するプロンプトを入力してください。</li><li>速い安い旨いの Haiku でも3，4テーブル程度の結合・集約なども結構な高精度で生成してくれます。</li></ol><img src="/images/20240402a/image_4.png" alt="" width="914" height="862" loading="lazy"><p>参考までに私が使用した変数の値を下記に貼り付けておきます。少し実務みのある区分値やリレーションを設定してあります。</p><details><summary>DDL</summary><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- Project Name : retail</span></span><br><span class="line"><span class="comment">-- Date/Time    : 2024/03/22 金 22:25:09</span></span><br><span class="line"><span class="comment">-- Author       : </span></span><br><span class="line"><span class="comment">-- RDBMS Type   : PostgreSQL</span></span><br><span class="line"><span class="comment">-- Application  : A5:SQL Mk-2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  &lt;&lt; 注意！！ &gt;&gt;</span></span><br><span class="line"><span class="comment">  BackupToTempTable, RestoreFromTempTable疑似命令が付加されています。</span></span><br><span class="line"><span class="comment">  これにより、drop table, create table 後もデータが残ります。</span></span><br><span class="line"><span class="comment">  この機能は一時的に $$TableName のような一時テーブルを作成します。</span></span><br><span class="line"><span class="comment">  この機能は A5:SQL Mk-2でのみ有効であることに注意してください。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 売上</span></span><br><span class="line"><span class="comment">-- * BackupToTempTable</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> sale cascade;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- * RestoreFromTempTable</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> sale (</span><br><span class="line">  id <span class="type">integer</span> <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">  , palce_id <span class="type">integer</span> <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">  , product_id <span class="type">integer</span> <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">  , selling_price_ID <span class="type">integer</span> <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">  , business_date <span class="type">date</span> <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">  , sales_at <span class="type">timestamp</span> <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">  , transfer_id <span class="type">integer</span> <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">  , discount_amount <span class="type">integer</span></span><br><span class="line">  , sales_amount <span class="type">integer</span> <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">  , <span class="keyword">constraint</span> sale_PKC <span class="keyword">primary</span> key (id)</span><br><span class="line">) ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 移動</span></span><br><span class="line"><span class="comment">-- * BackupToTempTable</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> transfer cascade;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- * RestoreFromTempTable</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> transfer (</span><br><span class="line">  id <span class="type">integer</span> <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">  , place_id <span class="type">integer</span> <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">  , product_id <span class="type">integer</span> <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">  , business_date <span class="type">date</span> <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">  , transfer_at <span class="type">timestamp</span></span><br><span class="line">  , transfer_classification <span class="type">character</span> <span class="type">varying</span> <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">  , transfer_quantity <span class="type">integer</span> <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">  , transfer_destination_classification <span class="type">character</span> <span class="type">varying</span> <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">  , transfer_destination_place_id <span class="type">integer</span></span><br><span class="line">  , <span class="keyword">constraint</span> transfer_PKC <span class="keyword">primary</span> key (id)</span><br><span class="line">) ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 在庫</span></span><br><span class="line"><span class="comment">-- * BackupToTempTable</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> stock cascade;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- * RestoreFromTempTable</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> stock (</span><br><span class="line">  place_id <span class="type">integer</span> <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">  , product_id <span class="type">integer</span> <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">  , business_date <span class="type">date</span> <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">  , stock_quantity <span class="type">integer</span> <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">  , <span class="keyword">constraint</span> stock_PKC <span class="keyword">primary</span> key (place_id,product_id,business_date)</span><br><span class="line">) ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> index stock_IX1</span><br><span class="line">  <span class="keyword">on</span> stock(product_id,business_date);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 売価</span></span><br><span class="line"><span class="comment">-- * BackupToTempTable</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> selling_price cascade;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- * RestoreFromTempTable</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> selling_price (</span><br><span class="line">  id <span class="type">integer</span> <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">  , product_id <span class="type">integer</span> <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">  , selling_price_classification <span class="type">character</span> <span class="type">varying</span> <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">  , start_date <span class="type">date</span> <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">  , end_date <span class="type">date</span> <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">  , selling_price <span class="type">integer</span> <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">  , <span class="keyword">constraint</span> selling_price_PKC <span class="keyword">primary</span> key (id)</span><br><span class="line">) ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">unique</span> index selling_price_IX1</span><br><span class="line">  <span class="keyword">on</span> selling_price(product_id,selling_price_classification);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 場所</span></span><br><span class="line"><span class="comment">-- * BackupToTempTable</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> place cascade;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- * RestoreFromTempTable</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> place (</span><br><span class="line">  id <span class="type">integer</span> <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">  , place_name <span class="type">character</span> <span class="type">varying</span> <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">  , selling_price_classification <span class="type">character</span> <span class="type">varying</span> <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">  , <span class="keyword">constraint</span> place_PKC <span class="keyword">primary</span> key (id)</span><br><span class="line">) ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 商品</span></span><br><span class="line"><span class="comment">-- * BackupToTempTable</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> product cascade;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- * RestoreFromTempTable</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> product (</span><br><span class="line">  id <span class="type">integer</span> <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">  , product_name <span class="type">character</span> <span class="type">varying</span> <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">  , <span class="keyword">constraint</span> product_PKC <span class="keyword">primary</span> key (id)</span><br><span class="line">) ;</span><br><span class="line"></span><br><span class="line">comment <span class="keyword">on</span> <span class="keyword">table</span> sale <span class="keyword">is</span> <span class="string">&#x27;売上&#x27;</span>;</span><br><span class="line">comment <span class="keyword">on</span> <span class="keyword">column</span> sale.id <span class="keyword">is</span> <span class="string">&#x27;ID&#x27;</span>;</span><br><span class="line">comment <span class="keyword">on</span> <span class="keyword">column</span> sale.palce_id <span class="keyword">is</span> <span class="string">&#x27;場所ID&#x27;</span>;</span><br><span class="line">comment <span class="keyword">on</span> <span class="keyword">column</span> sale.product_id <span class="keyword">is</span> <span class="string">&#x27;商品ID&#x27;</span>;</span><br><span class="line">comment <span class="keyword">on</span> <span class="keyword">column</span> sale.selling_price_ID <span class="keyword">is</span> <span class="string">&#x27;売価ID&#x27;</span>;</span><br><span class="line">comment <span class="keyword">on</span> <span class="keyword">column</span> sale.business_date <span class="keyword">is</span> <span class="string">&#x27;業務日付&#x27;</span>;</span><br><span class="line">comment <span class="keyword">on</span> <span class="keyword">column</span> sale.sales_at <span class="keyword">is</span> <span class="string">&#x27;売上日時&#x27;</span>;</span><br><span class="line">comment <span class="keyword">on</span> <span class="keyword">column</span> sale.transfer_id <span class="keyword">is</span> <span class="string">&#x27;入出荷ID&#x27;</span>;</span><br><span class="line">comment <span class="keyword">on</span> <span class="keyword">column</span> sale.discount_amount <span class="keyword">is</span> <span class="string">&#x27;値引額&#x27;</span>;</span><br><span class="line">comment <span class="keyword">on</span> <span class="keyword">column</span> sale.sales_amount <span class="keyword">is</span> <span class="string">&#x27;売上金額&#x27;</span>;</span><br><span class="line"></span><br><span class="line">comment <span class="keyword">on</span> <span class="keyword">table</span> transfer <span class="keyword">is</span> <span class="string">&#x27;移動&#x27;</span>;</span><br><span class="line">comment <span class="keyword">on</span> <span class="keyword">column</span> transfer.id <span class="keyword">is</span> <span class="string">&#x27;ID&#x27;</span>;</span><br><span class="line">comment <span class="keyword">on</span> <span class="keyword">column</span> transfer.place_id <span class="keyword">is</span> <span class="string">&#x27;場所ID&#x27;</span>;</span><br><span class="line">comment <span class="keyword">on</span> <span class="keyword">column</span> transfer.product_id <span class="keyword">is</span> <span class="string">&#x27;商品ID&#x27;</span>;</span><br><span class="line">comment <span class="keyword">on</span> <span class="keyword">column</span> transfer.business_date <span class="keyword">is</span> <span class="string">&#x27;業務日付&#x27;</span>;</span><br><span class="line">comment <span class="keyword">on</span> <span class="keyword">column</span> transfer.transfer_at <span class="keyword">is</span> <span class="string">&#x27;移動日時&#x27;</span>;</span><br><span class="line">comment <span class="keyword">on</span> <span class="keyword">column</span> transfer.transfer_classification <span class="keyword">is</span> <span class="string">&#x27;入出荷区分:1:入荷、2:出荷&#x27;</span>;</span><br><span class="line">comment <span class="keyword">on</span> <span class="keyword">column</span> transfer.transfer_quantity <span class="keyword">is</span> <span class="string">&#x27;移動数&#x27;</span>;</span><br><span class="line">comment <span class="keyword">on</span> <span class="keyword">column</span> transfer.transfer_destination_classification <span class="keyword">is</span> <span class="string">&#x27;移動先区分:1:場所間移動、2:売上、3:仕入&#x27;</span>;</span><br><span class="line">comment <span class="keyword">on</span> <span class="keyword">column</span> transfer.transfer_destination_place_id <span class="keyword">is</span> <span class="string">&#x27;移動先場所ID&#x27;</span>;</span><br><span class="line"></span><br><span class="line">comment <span class="keyword">on</span> <span class="keyword">table</span> stock <span class="keyword">is</span> <span class="string">&#x27;在庫&#x27;</span>;</span><br><span class="line">comment <span class="keyword">on</span> <span class="keyword">column</span> stock.place_id <span class="keyword">is</span> <span class="string">&#x27;場所ID&#x27;</span>;</span><br><span class="line">comment <span class="keyword">on</span> <span class="keyword">column</span> stock.product_id <span class="keyword">is</span> <span class="string">&#x27;商品ID&#x27;</span>;</span><br><span class="line">comment <span class="keyword">on</span> <span class="keyword">column</span> stock.business_date <span class="keyword">is</span> <span class="string">&#x27;業務日付&#x27;</span>;</span><br><span class="line">comment <span class="keyword">on</span> <span class="keyword">column</span> stock.stock_quantity <span class="keyword">is</span> <span class="string">&#x27;在庫数&#x27;</span>;</span><br><span class="line"></span><br><span class="line">comment <span class="keyword">on</span> <span class="keyword">table</span> selling_price <span class="keyword">is</span> <span class="string">&#x27;売価&#x27;</span>;</span><br><span class="line">comment <span class="keyword">on</span> <span class="keyword">column</span> selling_price.id <span class="keyword">is</span> <span class="string">&#x27;ID&#x27;</span>;</span><br><span class="line">comment <span class="keyword">on</span> <span class="keyword">column</span> selling_price.product_id <span class="keyword">is</span> <span class="string">&#x27;商品ID&#x27;</span>;</span><br><span class="line">comment <span class="keyword">on</span> <span class="keyword">column</span> selling_price.selling_price_classification <span class="keyword">is</span> <span class="string">&#x27;売価区分:区分値： 1:プロパー, 2:B品, 3:アウトレット, 4:催事&#x27;</span>;</span><br><span class="line">comment <span class="keyword">on</span> <span class="keyword">column</span> selling_price.start_date <span class="keyword">is</span> <span class="string">&#x27;適用開始日&#x27;</span>;</span><br><span class="line">comment <span class="keyword">on</span> <span class="keyword">column</span> selling_price.end_date <span class="keyword">is</span> <span class="string">&#x27;適用終了日&#x27;</span>;</span><br><span class="line">comment <span class="keyword">on</span> <span class="keyword">column</span> selling_price.selling_price <span class="keyword">is</span> <span class="string">&#x27;売価&#x27;</span>;</span><br><span class="line"></span><br><span class="line">comment <span class="keyword">on</span> <span class="keyword">table</span> place <span class="keyword">is</span> <span class="string">&#x27;場所&#x27;</span>;</span><br><span class="line">comment <span class="keyword">on</span> <span class="keyword">column</span> place.id <span class="keyword">is</span> <span class="string">&#x27;ID&#x27;</span>;</span><br><span class="line">comment <span class="keyword">on</span> <span class="keyword">column</span> place.place_name <span class="keyword">is</span> <span class="string">&#x27;場所名&#x27;</span>;</span><br><span class="line">comment <span class="keyword">on</span> <span class="keyword">column</span> place.selling_price_classification <span class="keyword">is</span> <span class="string">&#x27;売価区分:区分値： 1:プロパー, 2:B品, 3:アウトレット, 4:催事&#x27;</span>;</span><br><span class="line"></span><br><span class="line">comment <span class="keyword">on</span> <span class="keyword">table</span> product <span class="keyword">is</span> <span class="string">&#x27;商品&#x27;</span>;</span><br><span class="line">comment <span class="keyword">on</span> <span class="keyword">column</span> product.id <span class="keyword">is</span> <span class="string">&#x27;ID&#x27;</span>;</span><br><span class="line">comment <span class="keyword">on</span> <span class="keyword">column</span> product.product_name <span class="keyword">is</span> <span class="string">&#x27;商品名&#x27;</span>;</span><br></pre></td></tr></table></figure></details><details><summary>Data Model Descriptions</summary><figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="section"># データモデル概要</span></span><br><span class="line"></span><br><span class="line"><span class="section">## 売価テーブル ( `selling<span class="emphasis">_price` )</span></span></span><br><span class="line"><span class="emphasis"><span class="section"></span></span></span><br><span class="line"><span class="emphasis"><span class="section">* 売価は商品別・売価区分別・業務日付別に登録される。但し業務日付は日々ではなく開始日～終了日の範囲指定で登録される。</span></span></span><br><span class="line"><span class="emphasis"><span class="section">* 売価区分にはプロパー・B品・アウトレット・催事の4種類がある。つまり商品ごとに最大で4つの売価が設定されうる。</span></span></span><br><span class="line"><span class="emphasis"><span class="section">* 売価区分の定義は以下の通り。</span></span></span><br><span class="line"><span class="emphasis"><span class="section">  </span></span></span><br><span class="line"><span class="emphasis"><span class="section">| 売価区分 | 意味 |</span></span></span><br><span class="line"><span class="emphasis"><span class="section">| - | - |</span></span></span><br><span class="line"><span class="emphasis"><span class="section">| プロパー | 発売当初の定価 |</span></span></span><br><span class="line"><span class="emphasis"><span class="section">| B品 | 傷物など、商品個体の不具合により販売場所（以下「売場」と呼ぶ）の判断で値下げを要する場合の売価 |</span></span></span><br><span class="line"><span class="emphasis"><span class="section">| アウトレット | 商品のターゲットシーズンを過ぎて値下げした後の売価 |</span></span></span><br><span class="line"><span class="emphasis"><span class="section">| 催事 | 催事場で使用される特別売価 |</span></span></span><br><span class="line"><span class="emphasis"><span class="section"></span></span></span><br><span class="line"><span class="emphasis"><span class="section">## 場所テーブル( `place` )</span></span></span><br><span class="line"><span class="emphasis"><span class="section"></span></span></span><br><span class="line"><span class="emphasis"><span class="section">* 場所テーブルには場所の名前と標準の売価区分が登録されている。</span></span></span><br><span class="line"><span class="emphasis"><span class="section">* 場所に設定されている売価区分によって、その場所で発生しうる売上の売価区分が制限される。組み合わせは以下の通り。</span></span></span><br><span class="line"><span class="emphasis"><span class="section"> </span></span></span><br><span class="line"><span class="emphasis"><span class="section">| 場所の売価区分 | 売上として発生しうる売価区分 |</span></span></span><br><span class="line"><span class="emphasis"><span class="section">| - | - |</span></span></span><br><span class="line"><span class="emphasis"><span class="section">| プロパー | プロパー・B品・アウトレット |</span></span></span><br><span class="line"><span class="emphasis"><span class="section">| アウトレット | プロパー・B品・アウトレット |</span></span></span><br><span class="line"><span class="emphasis"><span class="section">| 催事 | プロパー・催事 |</span></span></span><br><span class="line"><span class="emphasis"><span class="section"></span></span></span><br><span class="line"><span class="emphasis"><span class="section">* 場所の売価区分としてB品は選択できない。</span></span></span><br><span class="line"><span class="emphasis"><span class="section"></span></span></span><br><span class="line"><span class="emphasis"><span class="section">## 移動テーブル( `transfer` )</span></span></span><br><span class="line"><span class="emphasis"><span class="section"></span></span></span><br><span class="line"><span class="emphasis"><span class="section">* 移動テーブルにはある場所で発生した商品の入出荷情報が全て登録される。仕入による入荷、販売による出荷、場所間での移動による入荷/出荷など。</span></span></span><br><span class="line"><span class="emphasis"><span class="section">* 場所間で発生した移動の場合、</span></span></span><br><span class="line"><span class="emphasis"><span class="section">  * 移動元の場所において出荷、移動先の場所において入荷のレコードが登録される。互いのレコードの移動数は一致する。</span></span></span><br><span class="line"><span class="emphasis"><span class="section">  * 移動先場所IDカラムに移動先の場所IDが登録される。</span></span></span><br><span class="line"><span class="emphasis"><span class="section"></span></span></span><br><span class="line"><span class="emphasis"><span class="section">## 在庫テーブル( `stock` )</span></span></span><br><span class="line"><span class="emphasis"><span class="section"></span></span></span><br><span class="line"><span class="emphasis"><span class="section">* 在庫テーブルには日々の当初の場所別・商品別の在庫数が記録される。</span></span></span><br><span class="line"><span class="emphasis"><span class="section">* 移動テーブルに全ての入出荷情報が登録されているため、ある日の在庫レコードの在庫数は `前日の在庫レコードの在庫数 + 前日の移動テーブルの入荷分の移動数の合計 - 前日の移動テーブルの出荷分の移動数の合計` と一致する。</span></span></span><br><span class="line"><span class="emphasis"><span class="section"></span></span></span><br><span class="line"><span class="emphasis"><span class="section">## 売上テーブル( `sale` )</span></span></span><br><span class="line"><span class="emphasis"><span class="section"></span></span></span><br><span class="line"><span class="emphasis"><span class="section">* 売上テーブルには場所別・商品別・売価別の売上情報が登録される。</span></span></span><br><span class="line"><span class="emphasis"><span class="section">* 売上の登録に際して必要な入力値は場所ID・商品ID・売価区分・売上数・値引額の4個。</span></span></span><br><span class="line"><span class="emphasis"><span class="section">* 売上数は売上テーブル上では管理しない。売上の発生に伴い移動テーブルに入出荷区分：出荷、移動先区分：売上、移動数：売上数のレコードが登録される。そのレコードのIDが売上レコードの移動IDカラムに保持される。</span></span></span><br><span class="line"><span class="emphasis"><span class="section">* 売価区分は売上を登録する時点で任意に選択される。</span></span></span><br><span class="line"><span class="emphasis"><span class="section">  * 但し、その売場に該当する場所テーブル上の売価区分の設定値により、取り得る売価区分は制限される。詳細は場所テーブルの項を参照。</span></span></span><br><span class="line"><span class="emphasis"><span class="section">* 販売した商品の売上金額は、登録時の入力値に従って次のように計算されて登録される: `売価 * 移動数 - 値引額`</span></span></span><br><span class="line"><span class="emphasis"><span class="section">* 売価は売価テーブルより `適用開始日 &lt;= 業務日付 &lt;= 適用終了日` の条件で取得する。</span></span></span><br></pre></td></tr></table></figure></details><p>プロンプト：「売上金額と売上数を場所別・商品別・月別に集計するSQL」</p><h3 id="アプリケーション公開"><a href="#アプリケーション公開" class="headerlink" title="アプリケーション公開"></a>アプリケーション公開</h3><p>ここまでの操作で（公開をクリックした時点で）既にDify上で動作するアプリケーションが完成し公開されています。<br>画面左のメニューで「概要」で下記の画面が表示されます。UIもAPIも使用可能な上にAPIキー管理機能まで自動で提供されていてまさに至れり尽くせり。プレビューをクリックするとアプリケーションの画面が開きます。</p><img src="/images/20240402a/image_5.png" alt="" width="632" height="519" loading="lazy"><img src="/images/20240402a/image_6.png" alt="" width="795" height="562" loading="lazy"><h2 id="チュートリアル2：外部ツールの使用"><a href="#チュートリアル2：外部ツールの使用" class="headerlink" title="チュートリアル2：外部ツールの使用"></a>チュートリアル2：外部ツールの使用</h2><p>文章を生成するだけのLLMに、外部サイトの情報を収集する機能と、グラフを描画する機能を追加します。</p><h3 id="開発-1"><a href="#開発-1" class="headerlink" title="開発"></a>開発</h3><ol><li>また画面上部のメニューからスタジオ→新しいアプリを作成する→アシスタントを選択して適当な名前で作成してください。</li><li>「基本アシスタント」をクリックして「エージェントアシスタント」を選択します。<img src="/images/20240402a/image_7.png" alt="" width="465" height="337" loading="lazy"></li><li>画面左側に「ツール」エリアが出現するので、「＋追加」をクリックして、 Wikipedia と ChartGenerator の Pie Chart を追加します。<img src="/images/20240402a/image_8.png" alt="" width="1157" height="644" loading="lazy"></li><li>「手順」に <code>ユーザの入力したプロンプトについてWikipediaで検索し、数値の情報をもとにパイチャートを作成してください。</code> と入力します。無くても動作はしますがそのままだと LLM が Wikipedia を参照せず手持ちの情報で回答してしまいがちなので念を押しておきます。</li></ol><h3 id="動作確認-1"><a href="#動作確認-1" class="headerlink" title="動作確認"></a>動作確認</h3><p>「公開」をクリックしてプロンプトに「アメリカの全人口における州ごとの人口のパイチャート」と入力すると若干怪しい動きを見せつつ作図されます。<br><img src="/images/20240402a/image_9.png" alt="" width="510" height="692" loading="lazy"></p><p>実は残念ながら現時点では Anthropic の Functions &amp; external tools には直接対応していないらしく、エージェント設定を見るとエージェントモードが ReAct になっています（GPTやGPT互換だと Function Calling のはず）。どうもこの場合Difyは、「LLMが生成した文字列からツール用パラメータっぽい部分をパースしてツールに中継する」という形で Function Calling を模した機能を提供するようで、生成された文字列が一部でもJSONとして破綻（値の中で改行など）していると失敗します。ツールの呼び出しに失敗するとツールを呼び出そうとした文字列がそのまま最終回答文として出力されます。</p><img src="/images/20240402a/image_10.png" alt="" width="437" height="358" loading="lazy"><img src="/images/20240402a/image_11.png" alt="" width="603" height="603" loading="lazy"><h2 id="後編に続く"><a href="#後編に続く" class="headerlink" title="後編に続く"></a>後編に続く</h2><p>前編では下記のステップを辿りました。</p><ul><li>チャットbotに手順(Instruction)を与えて特定の問題領域に特化したチャットbotを作る</li><li>既製のToolを使用して自然言語処理以外の機能を獲得する</li></ul><p><a href="/articles/20240404a/">後編</a>はこれらを進めて以下の内容を書きます。</p><ul><li>Toolを自作して機能を拡張する</li><li>生成AIに自分の生成した回答を自己レビューさせる</li></ul><div id="footnotes"><hr><div id="footnotelist"><ol style="list-style:none; padding-left: 0;"><li id="fn:1"><span style="vertical-align: top; padding-right: 10px;">1.</span><span style="vertical-align: top;">RAG用テキストやベクトルデータベースを作る場合にも言えますが、生成AIに前提知識を与える時には詳細な情報に加えてその概要と補足情報などで多面的に与えると精度が上がります。単純に手軽さだけで言えば、データのフォーマットの工夫に腐心するより表現のバリエーションを増やす方が楽です。パケ死ならぬトークン死しますが…</span><a href="#fnref:1" rev="footnote"> ↩</a></li></ol></div></div>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;概要&quot;&gt;&lt;a href=&quot;#概要&quot; class=&quot;headerlink&quot; title=&quot;概要&quot;&gt;&lt;/a&gt;概要&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://dify.ai/&quot;&gt;Dify&lt;/a&gt; （DeFiではない）と &lt;a</summary>
        
      
    
    
    
    <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
    <category term="ノーコード" scheme="https://future-architect.github.io/tags/%E3%83%8E%E3%83%BC%E3%82%B3%E3%83%BC%E3%83%89/"/>
    
    <category term="生成AI" scheme="https://future-architect.github.io/tags/%E7%94%9F%E6%88%90AI/"/>
    
    <category term="Dify" scheme="https://future-architect.github.io/tags/Dify/"/>
    
    <category term="Anthropic Claude" scheme="https://future-architect.github.io/tags/Anthropic-Claude/"/>
    
  </entry>
  
  <entry>
    <title>Microsoft 365 Developer ProgramでEntraID(旧名AzureAD)にアクセスする</title>
    <link href="https://future-architect.github.io/articles/20240401a/"/>
    <id>https://future-architect.github.io/articles/20240401a/</id>
    <published>2024-03-31T15:00:00.000Z</published>
    <updated>2024-04-01T01:28:27.878Z</updated>
    
    <content type="html"><![CDATA[<p>過去にいくつかEntraID(旧名AzureAD)の記事を<a href="/tags/AzureAD/">何本も書いています</a>が、久々にMicrosoft 365 Developer Programにアクセスしたら、どこにEntraIDがあるのか場所が分からなかったのでメモです。Microsoft 365全般で同じかもしれませんが、僕自身はDeveloper Programしか触っていないのでわかりません。</p><p><a href="https://developer.microsoft.com/en-us/microsoft-365/dev-program">Microsoft 365 Developer Programのウェブサイト</a>で上のメニューのDeveloper Programの「My Dashboard」を選びます。この遷移がわからなくていつもJoin Nowをしていました。</p><img src="/images/20240401a/image.png" alt="image.png" width="610" height="287" loading="lazy"><p>こちらがダッシュボードです。</p><img src="/images/20240401a/image_2.png" alt="image.png" width="911" height="633" loading="lazy"><p>ここでGo to subscritpionを選択すると、次のオフィスのポータルっぽいページに移動します。</p><img src="/images/20240401a/image_3.png" alt="image.png" width="1200" height="646" loading="lazy"><p>左のツールバーのAdminアイコンをクリックして・・・上のツールバーにentraidを入れて検索して出てくるIdentityがEntraIDです。</p><img src="/images/20240401a/image_4.png" alt="image.png" width="859" height="517" loading="lazy">]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;過去にいくつかEntraID(旧名AzureAD)の記事を&lt;a href=&quot;/tags/AzureAD/&quot;&gt;何本も書いています&lt;/a&gt;が、久々にMicrosoft 365 Developer</summary>
        
      
    
    
    
    <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
    <category term="Azure" scheme="https://future-architect.github.io/tags/Azure/"/>
    
    <category term="EntraID" scheme="https://future-architect.github.io/tags/EntraID/"/>
    
    <category term="Microsoft365" scheme="https://future-architect.github.io/tags/Microsoft365/"/>
    
  </entry>
  
  <entry>
    <title>GoでAWS Lambdaのミドルウェアをジェネリクスを用いて実装する</title>
    <link href="https://future-architect.github.io/articles/20240329a/"/>
    <id>https://future-architect.github.io/articles/20240329a/</id>
    <published>2024-03-28T15:00:00.000Z</published>
    <updated>2024-03-29T01:56:47.173Z</updated>
    
    <content type="html"><![CDATA[<h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>TIG真野です。</p><p>AWS SDK for Goを用いてAWS Lambdaを実装する際に、共通的に行いたいミドルウェア的な処理をデコレータで実装する方法を説明します。内容的には <code>http.HandlerFunc</code> に対してミドルウェアを作るのとほぼ同義です。</p><h2 id="前提知識"><a href="#前提知識" class="headerlink" title="前提知識"></a>前提知識</h2><p>AWS SDK for GoでLambdaを実装するにあたり、<a href="https://docs.aws.amazon.com/ja_jp/lambda/latest/dg/golang-handler.html">関数ハンドラは複数のシグネチャを許容</a>して、そのうち引数に <code>context.Context</code> を取るのは以下の4パターンです。この記事では便宜的に1~4で採番してパターン名を入れています</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// No.1 プレーンパターン</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(context.Context)</span></span> <span class="type">error</span></span><br><span class="line"><span class="comment">// No2 TInパターン</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(context.Context, TIn)</span></span> <span class="type">error</span></span><br><span class="line"><span class="comment">// No3 TOutパターン</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(context.Context)</span></span> (TOut, <span class="type">error</span>)</span><br><span class="line"><span class="comment">// No4 TInToutパターン</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(context.Context, TIn)</span></span> (TOut, <span class="type">error</span>)</span><br></pre></td></tr></table></figure><p>例えば、「No.1 プレーンパターン」は<code>main.go</code> から、 <code>plain</code> パッケージの <code>Handle()</code> 関数を呼び出すように実装します。そうすると、SDK側で任意のトリガーでLambdaを起動するようハンドリングしてくれます。この例では2ファイルに分割していますが、このような技術的な制約は無いです。後の説明の都合で最初から分離しています。</p><figure class="highlight go"><figcaption><span>cmd/lambda/main.go</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;context&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;github.com/aws/aws-lambda-go/lambda&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/myproject/myapp/plain&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">lambda.Start(plain.Handle)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><figcaption><span>plain/handler.go</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> plain</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Handle</span><span class="params">(ctx context.Context)</span></span> <span class="type">error</span> &#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">// アプリケーションのロジックなど</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>さきほど提示したLambda関数ハンドラに登場する <code>TIn</code>, <code>TOut</code> は any型でどのような型をとっても良いため、ジェネリクス以前はデコレータ的な共通的な処理を書くためには、リフレクションに頼るか、イベント種別ごとに個別に作成する必要がありました。後者もTOutの場合はうまく扱うことができず最終的にはリフレクションに頼っていたと思います。</p><p><a href="/articles/20220209a/">Go 1.18から入ったジェネリクス</a>を用いてリフレクション無しで、上記の関数ハンドラをデコレータの設計でラップした実装を考えます。</p><p>前提知識をもう少し細かく知りたい人は次の記事もお勧めです。</p><ul><li>TIn, TOutの挙動については<a href="/articles/20200326/">AWS Lambda×Goの開発Tips</a> に言及があります</li><li>AWS SDK for Goが守るべきシグネチャを違反していないかのチェックは、辻さんの<a href="/articles/20210603a/">静的解析によるInvalidなAWS Lambda関数シグネチャの検知</a>で紹介する静的解析ツールで行えます</li><li>デレコータについては<a href="/articles/20221021a/">CSV処理における共通処理をDecoratorパターンで実現する</a>も言及があります</li></ul><h2 id="共通で行いたい処理をデコレータで扱うの意"><a href="#共通で行いたい処理をデコレータで扱うの意" class="headerlink" title="共通で行いたい処理をデコレータで扱うの意"></a>共通で行いたい処理をデコレータで扱うの意</h2><p>例えば、次のような処理は機能横断的（ある機能の閉じず、サービス全体に統制を図って適用したい）に実現したいことが多いです。</p><ul><li>panicのキャプチャ</li><li>errorがnilでない場合のエラーハンドリング</li><li>実行時間の遅延監視</li><li>トランザクション管理</li></ul><p>扱うLambdaの数が少なければあまり気にしなくても良いですが、チーム規模が増え、開発規模もLambda関数が数十程度になってくると何かしら統制を図りたくなってくるものです。</p><p>デコレータの処理イメージですが、次のようなイメージです。先ほどの <code>plain/handler.go</code> で実装した <code>Handle()</code> 関数が真ん中のビジネスロジックの部分で、外側を1つ以上の共通処理でラップするようなことを行います。</p><img src="/images/20240329a/godecorator.drawio.png" alt="godecorator.drawio.png" width="1030" height="459" loading="lazy"><p>次の章からは具体的に実装例を紹介していきます。</p><h2 id="No1-プレーンパターンのデコレータ実装"><a href="#No1-プレーンパターンのデコレータ実装" class="headerlink" title="No1. プレーンパターンのデコレータ実装"></a>No1. プレーンパターンのデコレータ実装</h2><p>まず <code>func (context.Context) error</code> の共通処理を書きます。このケースはジェネリクスの利用無しで対応できます。</p><p>次のように <code>LambdaFunc</code> を型定義します。<code>LambdaFunc</code>を引数と戻り値にした<code>Do()</code> 関数を作ります。これがデコレーターの本体（エントリーポイント）です。</p><figure class="highlight go"><figcaption><span>lambdamiddleware/lambda_middleware.go</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> lambdamiddleware</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;context&quot;</span></span><br><span class="line"><span class="string">&quot;runtime/debug&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;github.com/rs/zerolog/log&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// プレーンパターンのLambda関数をデコレートするための型定義</span></span><br><span class="line"><span class="keyword">type</span> LambdaFunc <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context)</span></span> <span class="type">error</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// デコレート処理の本体</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Do</span><span class="params">(fn LambdaFunc)</span></span> LambdaFunc &#123;</span><br><span class="line"><span class="keyword">return</span> errCheck(fn)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 共通処理の一例（ここではエラーハンドリング）。これもデコレータ</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">errCheck</span><span class="params">(fn LambdaFunc)</span></span> LambdaFunc &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context)</span></span> <span class="type">error</span> &#123;</span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; <span class="comment">// パニックのキャプチャ</span></span><br><span class="line"><span class="keyword">if</span> err := <span class="built_in">recover</span>(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Error().Msgf(<span class="string">&quot;panic catch: %v\n%v&quot;</span>, err, <span class="type">string</span>(debug.Stack()))</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line">err := fn(ctx)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Error().Msgf(<span class="string">&quot;%v&quot;</span>, err) <span class="comment">// 共通的なエラーハンドリング（ここではエラーログを出したい）</span></span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>errCheck</code> では拡張したい共通処理を実装して、先ほどの <code>Do()</code> 内で <code>fn</code> に被せます。デコレートぽいですね。</p><p>さて、これをmain.goに適用すると、次のように下の <code>plain.Handle</code> を <code>lambdamiddleware.Do()</code> でラップしたような変更となります。</p><figure class="highlight diff"><figcaption><span>cmd/lambda/main.go</span></figcaption><table><tr><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">&quot;context&quot;</span><br><span class="line"></span><br><span class="line">&quot;github.com/aws/aws-lambda-go/lambda&quot;</span><br><span class="line">    &quot;github.com/myproject/myapp/plain&quot;</span><br><span class="line"><span class="addition">+   &quot;github.com/myproject/myapp/lambdamiddleware&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line"><span class="deletion">-lambda.Start(plain.Handle)</span></span><br><span class="line"><span class="addition">+lambda.Start(lambdamiddleware.Do(plain.Handle))</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>挙動としては <code>plain.Handle</code> が <code>lambdamiddleware.Do()</code> に渡され、 <code>errCheck()</code> で呼び出されます。 <code>errCheck()</code> は <code>func(ctx context.Context) error</code> という関数を返す、というところがポイントです。</p><p>この手の実装は慣れないと困惑する人もいそうですが、Goだと HTTP Middlewareを作るために、<code>http.HandlerFunc</code> で同様の設計をよく見かけます。</p><p>辻さんの<a href="https://tutuz-tech.hatenablog.com/entry/2020/03/23/220326">HTTP Middleware の作り方と使い方</a> を始め、参考になる情報が沢山あります。</p><h2 id="No2-TInパターンのデコレータ実装"><a href="#No2-TInパターンのデコレータ実装" class="headerlink" title="No2. TInパターンのデコレータ実装"></a>No2. TInパターンのデコレータ実装</h2><p>No1と異なり、<code>TIn</code> は任意の型なので、ジェネリクスが登場します。型定義でジェネリクスを用いる場合は、 <code>type LambdaTInFunc[TI any] func(ctx context.Context, e TI) error</code> といった順序で宣言します。構造は同じです。</p><figure class="highlight go"><figcaption><span>lambdamiddleware/lambda_tin_middleware.go</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> lambdamiddleware</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;context&quot;</span></span><br><span class="line"><span class="string">&quot;runtime/debug&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;github.com/rs/zerolog/log&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> LambdaTInFunc[TI any] <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context, e TI)</span></span> <span class="type">error</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DoTin</span>[<span class="title">TI</span> <span class="title">any</span>]<span class="params">(fn LambdaTInFunc[TI])</span></span> LambdaTInFunc[TI] &#123;</span><br><span class="line"><span class="keyword">return</span> errLogTIn(fn)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">errLogTIn</span>[<span class="title">TI</span> <span class="title">any</span>]<span class="params">(fn LambdaTInFunc[TI])</span></span> LambdaTInFunc[TI] &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context, e TI)</span></span> <span class="type">error</span> &#123;</span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> err := <span class="built_in">recover</span>(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Error().Msgf(<span class="string">&quot;panic catch: %v\n%v&quot;</span>, err, <span class="type">string</span>(debug.Stack()))</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line">err := fn(ctx, e)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Error().Msgf(<span class="string">&quot;%v&quot;</span>, err)</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>呼び出し方も、次のように同様です。先ほどと異なり、Handle()関数には、 <code>events.DynamoDBEvent</code> という引数がありますが、ジェネリクスを用いているためどのような型でも受け止めることができます。</p><figure class="highlight go"><figcaption><span>cmd/tinlambda/main.go</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;context&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;github.com/aws/aws-lambda-go/lambda&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/myproject/myapp/tin&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/myproject/myapp/lambdamiddleware&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">lambda.Start(lambdamiddleware.DoTin(tin.Handle))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><figcaption><span>tin/handler.go</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Handle</span><span class="params">(ctx context.Context, e events.DynamoDBEvent)</span></span> <span class="type">error</span> &#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">// アプリケーションのロジックなど</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="No3-TOutパターンのデコレータ実装"><a href="#No3-TOutパターンのデコレータ実装" class="headerlink" title="No3. TOutパターンのデコレータ実装"></a>No3. TOutパターンのデコレータ実装</h2><p>TOutパターンもほぼ同じです。1点補足すると <code>var zero TO</code> で初期値を生成している部分でしょうか。これもerr が not nil である状態ですので、 <code>return tout, err</code> としても挙動として問題ないため、好みに近いところです。</p><figure class="highlight go"><figcaption><span>lambdamiddleware/lambda_tout_middleware.go</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> lambdamiddleware</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;context&quot;</span></span><br><span class="line"><span class="string">&quot;runtime/debug&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;github.com/rs/zerolog/log&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> LambdaTOutFunc[TO any] <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context)</span></span> (TO, <span class="type">error</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DoTout</span>[<span class="title">TO</span> <span class="title">any</span>]<span class="params">(fn LambdaTOutFunc[TO])</span></span> LambdaTOutFunc[TO] &#123;</span><br><span class="line"><span class="keyword">return</span> errLogTOut(fn)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">errLogTOut</span>[<span class="title">TO</span> <span class="title">any</span>]<span class="params">(fn LambdaTOutFunc[TO])</span></span> LambdaTOutFunc[TO] &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context)</span></span> (TO, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> err := <span class="built_in">recover</span>(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Error().Msgf(<span class="string">&quot;panic catch: %v\n%v&quot;</span>, err, <span class="type">string</span>(debug.Stack()))</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line">tout, err := fn(ctx)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Error().Msgf(<span class="string">&quot;%v&quot;</span>, err)</span><br><span class="line"><span class="keyword">var</span> zero TO <span class="comment">// ゼロ値</span></span><br><span class="line"><span class="keyword">return</span> zero, err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> tout, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>呼び出され型はNo2, No4と類似になるため、割愛します。</p><h2 id="No4-TInTOutパターンのデコレータ実装"><a href="#No4-TInTOutパターンのデコレータ実装" class="headerlink" title="No4. TInTOutパターンのデコレータ実装"></a>No4. TInTOutパターンのデコレータ実装</h2><p>Tin, TOutパターンの組み合わせです。構造は同じです。</p><figure class="highlight go"><figcaption><span>lambdamiddleware/lambda_tintout_middleware.go</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> lambdamiddleware</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;context&quot;</span></span><br><span class="line"><span class="string">&quot;runtime/debug&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;github.com/rs/zerolog/log&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> LambdaTInTOutFunc[TI, TO any] <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context, e TI)</span></span> (TO, <span class="type">error</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DoTinTout</span>[<span class="title">TI</span>, <span class="title">TO</span> <span class="title">any</span>]<span class="params">(fn LambdaTInTOutFunc[TI, TO])</span></span> LambdaTInTOutFunc[TI, TO] &#123;</span><br><span class="line"><span class="keyword">return</span> errLogTInTOut(fn)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">errLogTInTOut</span>[<span class="title">TI</span>, <span class="title">TO</span> <span class="title">any</span>]<span class="params">(fn LambdaTInTOutFunc[TI, TO])</span></span> LambdaTInTOutFunc[TI, TO] &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context, e TI)</span></span> (TO, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> err := <span class="built_in">recover</span>(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Error().Msgf(<span class="string">&quot;panic catch: %v\n%v&quot;</span>, err, <span class="type">string</span>(debug.Stack()))</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line">tout, err := fn(ctx, e)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Error().Msgf(<span class="string">&quot;%v&quot;</span>, err)</span><br><span class="line"><span class="keyword">var</span> zero TO</span><br><span class="line"><span class="keyword">return</span> zero, err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> tout, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>呼び出し方も特筆すべきことは無いです。引数、戻り値ともに任意の型（この例ではCloudWatchEvent経由で起動し、独自定義の構造体を返す）を扱えていることに着目ください。</p><figure class="highlight go"><figcaption><span>cmd/tintoutlambda/main.go</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;context&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;github.com/aws/aws-lambda-go/lambda&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/myproject/myapp/tin&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/myproject/myapp/lambdamiddleware&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">lambda.Start(lambdatintoutmiddleware.DoTinTOut(tintout.Handle))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><figcaption><span>tintout/handler.go</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Handle</span><span class="params">(ctx context.Context, e events.CloudWatchEvent)</span></span>(MyStruct, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">// アプリケーションのロジックなど</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="別の共通処理を追加したい"><a href="#別の共通処理を追加したい" class="headerlink" title="別の共通処理を追加したい"></a>別の共通処理を追加したい</h2><p>ミドルウェアを拡張したい場合も紹介します。</p><p>例えば、Lambdaのタイムアウト100ms前にエラーログを出したいとします。最後のTinTouに追加すると次のように <code>delayCheckTInTOut()</code> を追加し、<code>DoTinTout()</code> にそれを追加して呼び出すことで対応できます。</p><figure class="highlight diff"><table><tr><td class="code"><pre><span class="line">func DoTinTOut[TI, TO any](fn LambdaTInTOutFunc[TI, TO]) LambdaTInTOutFunc[TI, TO] &#123;</span><br><span class="line"><span class="deletion">-return errLogTInTOut(fn)</span></span><br><span class="line"><span class="addition">+return delayCheckTInTOut(errLogTInTOut(fn))</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="addition">+func delayCheckTInTOut[TI, TO any](fn LambdaTInTOutFunc[TI, TO]) LambdaTInTOutFunc[TI, TO] &#123;</span></span><br><span class="line"><span class="addition">+return func(ctx context.Context, e TI) (TO, error) &#123;</span></span><br><span class="line"><span class="addition">+deadline, _ := ctx.Deadline()</span></span><br><span class="line"><span class="addition">+deadlineTerm := time.Until(deadline.Add(-100 * time.Millisecond))</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+errTime := time.AfterFunc(deadlineTerm, func() &#123;</span></span><br><span class="line"><span class="addition">+log.Error().Msgf(&quot;job process time error: %s sec has passed&quot;, deadlineTerm.String())</span></span><br><span class="line"><span class="addition">+&#125;)</span></span><br><span class="line"><span class="addition">+defer errTime.Stop()</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+return fn(ctx, e)</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br></pre></td></tr></table></figure><p>同様の処理を、<code>lambda_middleware.go</code>、<code>lambda_tin_middleware.go</code>、<code>lambda_tout_middleware.go</code> に追加すれば完成です。</p><p>呼び出し側の <code>cmd/tintoutlambda/main.go</code> などには影響せずに横断的な遅延チェックを行えます。</p><h2 id="シグネチャが異なるミドルウェアを呼び出してしまった場合"><a href="#シグネチャが異なるミドルウェアを呼び出してしまった場合" class="headerlink" title="シグネチャが異なるミドルウェアを呼び出してしまった場合"></a>シグネチャが異なるミドルウェアを呼び出してしまった場合</h2><p>例えば、本来lambdatintoutmiddleware.DoTinTOut()を呼び出すべきはずが、誤って <code>lambdatintoutmiddleware.DoOut()</code> を呼び出してしまったとします。</p><p>この場合、コンパイルエラーにすることができます。</p><figure class="highlight diff"><figcaption><span>cmd/tintoutlambda/main.go</span></figcaption><table><tr><td class="code"><pre><span class="line">func main() &#123;</span><br><span class="line"><span class="deletion">-lambda.Start(lambdatintoutmiddleware.DoTinTOut(tintout.Handle))</span></span><br><span class="line"><span class="addition">+lambda.Start(lambdatintoutmiddleware.DoOut(tintout.Handle)) // コンパイルエラー(Cannot infer TI)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>リフレクションでゆるふわ対応していたときは、実行時で検知（あるいは静的解析でがんばるか）だったので、レビュー時なども安心感があります。</p><h2 id="運用してみて"><a href="#運用してみて" class="headerlink" title="運用してみて"></a>運用してみて</h2><p>今の私のチームは数十のLambdaがあり、Lambdaを追加するたびに共通的な処理が行えているかレビューするのは大変でした。また、共通的な処理がLambdaによって微妙に進化し始めるなど危険な状態でした。それらは完全に解消し、コード数も減ってハッピーな状態です。</p><p>ミドルウェアの呼び出しの使い分けはさほど難しくもなく、コンパイルエラーで誤りにはすぐ気がつくことができるためか、チームメンバーからも特に問い合わせが無く、今のところ何か困ったことにはなっていません。</p><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>AWS Lambdaの関数ハンドラのミドルウェアを、http.HandlerFuncのようにして作ってみました。Lambda関数ハンドラのシグネチャは、http.HandlerFuncより窓口が広いので、ジェネリクスを用いるとスッキリするよという話でした。</p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot; title=&quot;はじめに&quot;&gt;&lt;/a&gt;はじめに&lt;/h2&gt;&lt;p&gt;TIG真野です。&lt;/p&gt;
&lt;p&gt;AWS SDK for Goを用いてAWS</summary>
        
      
    
    
    
    <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
    <category term="Go" scheme="https://future-architect.github.io/tags/Go/"/>
    
    <category term="Lambda" scheme="https://future-architect.github.io/tags/Lambda/"/>
    
    <category term="Decorator" scheme="https://future-architect.github.io/tags/Decorator/"/>
    
    <category term="共通処理" scheme="https://future-architect.github.io/tags/%E5%85%B1%E9%80%9A%E5%87%A6%E7%90%86/"/>
    
  </entry>
  
  <entry>
    <title>Terraformでのループ処理と条件分岐</title>
    <link href="https://future-architect.github.io/articles/20240328b/"/>
    <id>https://future-architect.github.io/articles/20240328b/</id>
    <published>2024-03-27T15:00:01.000Z</published>
    <updated>2024-03-28T06:42:21.025Z</updated>
    
    <content type="html"><![CDATA[<img src="/images/20240328b/top.png" alt="" width="800" height="527"><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>はじめまして！TIG DXチームの小林と申します。</p><p>Terraformでは似たリソースを複数構築する際に、ループ処理や条件分岐を利用することで、コードの冗長化を防ぎ、可読性や保守性を上げることができます。</p><p>私自身まだTerraform歴半年ですが、初心者目線で「Terraformのコードをスマートに書きたい！」というモチベーションのもと本記事を書きました。</p><h2 id="サマリ"><a href="#サマリ" class="headerlink" title="サマリ"></a>サマリ</h2><h3 id="ループ処理"><a href="#ループ処理" class="headerlink" title="ループ処理"></a>ループ処理</h3><div class="scroll"><table><thead><tr><th>方法</th><th>分類</th><th>主な用途（個人的なイメージ）</th></tr></thead><tbody><tr><td><a href="https://developer.hashicorp.com/terraform/language/meta-arguments/count">count</a></td><td>メタ引数</td><td>・開発や検証用などで簡単なリソースを複数個作りたい場合 <br> ・将来的に数が増減しないようなリソースを作る場合</td></tr><tr><td><a href="https://developer.hashicorp.com/terraform/language/meta-arguments/for_each">for_each</a></td><td>メタ引数</td><td>・ループ処理で複数リソースを作りたい場合は基本こちら</td></tr><tr><td><a href="https://developer.hashicorp.com/terraform/language/expressions/for">for</a></td><td>式</td><td>・フィルタリング機能を利用して条件によってリソース構築を制御したい場合 <br> ・既存の設定値や構築済リソースから任意のリストやマップを取得したい場合 <br> ・その他使ったら幸せになれる場合</td></tr><tr><td><a href="https://developer.hashicorp.com/terraform/language/expressions/dynamic-blocks">dynamic block</a></td><td>式</td><td>・resource block内で同一のブロックを複数定義する場合 <br> ・可読性や保守性が落ちないことが明確な場合</td></tr></tbody></table></div><h3 id="条件分岐"><a href="#条件分岐" class="headerlink" title="条件分岐"></a>条件分岐</h3><div class="scroll"><table><thead><tr><th>方法</th><th>分類</th><th>主な用途（個人的なイメージ）</th></tr></thead><tbody><tr><td><a href="https://developer.hashicorp.com/terraform/language/expressions/conditionals">三項演算子</a></td><td>式</td><td>・条件分岐を行いたい場合は基本こちら</td></tr><tr><td><a href="https://developer.hashicorp.com/terraform/language/meta-arguments/for_each">for_each</a> と <a href="https://developer.hashicorp.com/terraform/language/expressions/for">for</a> を併用</td><td>-</td><td>・forループ内の要素の特定条件でリソースを作り分ける場合</td></tr></tbody></table></div><h2 id="構築するリソース（ベース）"><a href="#構築するリソース（ベース）" class="headerlink" title="構築するリソース（ベース）"></a>構築するリソース（ベース）</h2><p>本記事で構築するリソースはこちらです。</p><p>AWS上に10.10.0.0&#x2F;16 のVPC1つと、10.10.0.0&#x2F;24 ～ 10.10.3.0&#x2F;24 でサブネットを計4つ（public2つ、private2個想定）を各パターンで作成していきます。</p><p>まずはベースとして、シンプルにresource blockを羅列したものを記載しています。<br>（以降、サブネット部分の処理がメインのため、VPC部分の記述は省略します。）</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">resource <span class="string">&quot;aws_vpc&quot;</span> <span class="string">&quot;test-vpc&quot;</span> &#123;</span><br><span class="line">  cidr_block        = <span class="string">&quot;10.10.0.0/16&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource <span class="string">&quot;aws_subnet&quot;</span> <span class="string">&quot;public-1&quot;</span> &#123;</span><br><span class="line">  vpc_id            = aws_vpc.test-vpc.id</span><br><span class="line">  availability_zone = <span class="string">&quot;ap-northeast-1a&quot;</span></span><br><span class="line">  cidr_block        = cidrsubnet(aws_vpc.test-vpc.cidr_block, 8, 0)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource <span class="string">&quot;aws_subnet&quot;</span> <span class="string">&quot;public-2&quot;</span> &#123;</span><br><span class="line">  vpc_id            = aws_vpc.test-vpc.id</span><br><span class="line">  availability_zone = <span class="string">&quot;ap-northeast-1a&quot;</span></span><br><span class="line">  cidr_block        = cidrsubnet(aws_vpc.test-vpc.cidr_block, 8, 1)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource <span class="string">&quot;aws_subnet&quot;</span> <span class="string">&quot;private-1&quot;</span> &#123;</span><br><span class="line">  vpc_id            = aws_vpc.test-vpc.id</span><br><span class="line">  availability_zone = <span class="string">&quot;ap-northeast-1a&quot;</span></span><br><span class="line">  cidr_block        = cidrsubnet(aws_vpc.test-vpc.cidr_block, 8, 2)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource <span class="string">&quot;aws_subnet&quot;</span> <span class="string">&quot;private-2&quot;</span> &#123;</span><br><span class="line">  vpc_id            = aws_vpc.test-vpc.id</span><br><span class="line">  availability_zone = <span class="string">&quot;ap-northeast-1a&quot;</span></span><br><span class="line">  cidr_block        = cidrsubnet(aws_vpc.test-vpc.cidr_block, 8, 3)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>参考：<a href="https://developer.hashicorp.com/terraform/language/functions/cidrsubnet">cidrsubnet</a></p><h2 id="ループ処理-count"><a href="#ループ処理-count" class="headerlink" title="ループ処理(count)"></a>ループ処理(count)</h2><p><code>count</code>を利用すると、このように書くことができます。</p><p><code>count = x</code>とカウント回数を定義し、<code>count.index</code> で0からx回カウントアップする引数を指定できます。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">resource <span class="string">&quot;aws_subnet&quot;</span> <span class="string">&quot;public&quot;</span> &#123;</span><br><span class="line">  count             = 2</span><br><span class="line">  vpc_id            = aws_vpc.test-vpc.id</span><br><span class="line">  availability_zone = <span class="string">&quot;ap-northeast-1a&quot;</span></span><br><span class="line">  cidr_block        = cidrsubnet(aws_vpc.test-vpc.cidr_block, 8, count.index)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource <span class="string">&quot;aws_subnet&quot;</span> <span class="string">&quot;private&quot;</span> &#123;</span><br><span class="line">  count             = 2</span><br><span class="line">  vpc_id            = aws_vpc.test-vpc.id</span><br><span class="line">  availability_zone = <span class="string">&quot;ap-northeast-1a&quot;</span></span><br><span class="line">  cidr_block        = cidrsubnet(aws_vpc.test-vpc.cidr_block, 8, count.index + 2)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>publicとprivateの区別が無ければ、<code>count = 4</code>としてresource blockを1つで全サブネットを構築可能ですが、可読性や保守性が落ちるため分けています。</p><p>さて、ここでpublicのサブネットを1つ増やしたくなった場合はどうすれば良いでしょうか。</p><p>簡単な話ではありますが、以下のように<code>count</code>の値を3に修正することで、増やすことができます。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">resource <span class="string">&quot;aws_subnet&quot;</span> <span class="string">&quot;public&quot;</span> &#123;</span><br><span class="line">  count             = 3</span><br><span class="line">  vpc_id            = aws_vpc.test-vpc.id</span><br><span class="line">  availability_zone = <span class="string">&quot;ap-northeast-1a&quot;</span></span><br><span class="line">  cidr_block        = cidrsubnet(aws_vpc.test-vpc.cidr_block, 8, count.index)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource <span class="string">&quot;aws_subnet&quot;</span> <span class="string">&quot;private&quot;</span> &#123;</span><br><span class="line">  count             = 2</span><br><span class="line">  vpc_id            = aws_vpc.test-vpc.id</span><br><span class="line">  availability_zone = <span class="string">&quot;ap-northeast-1a&quot;</span></span><br><span class="line">  cidr_block        = cidrsubnet(aws_vpc.test-vpc.cidr_block, 8, count.index + 3)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>しれっと修正しましたが、privateの方の <code>count.index + 2</code>も<code>count.index + 3</code>としています。</p><p>これを忘れると、以下のようなCIDRブロックのコンフリクトエラーが起きます。</p><blockquote><p>Error: creating EC2 Subnet: InvalidSubnet.Conflict: The CIDR ‘10.10.2.0&#x2F;24’ conflicts with another subnet </p></blockquote><p>countの使いづらいところは主にここだと思っています。数を増減させたいときに<code>count.index</code>の値の変動がどこまで影響するか、大規模や複雑なリソースでは把握が難しく、保守性が低下します。</p><p>また、<code>index</code>とあるように、<code>count</code>を利用して構築したリソースは配列として管理されます。</p><p>tfstateを覗いてみると、<code>index_key</code>というキーの値が0や1などの数値で存在します。</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;managed&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;aws_subnet&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;public&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;provider&quot;</span><span class="punctuation">:</span> <span class="string">&quot;provider[\&quot;registry.terraform.io/hashicorp/aws\&quot;]&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;instances&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;index_key&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">（後略）</span><br></pre></td></tr></table></figure><p>これは、<code>index</code>の途中（↑のpublicサブネットで言うと<code>count.index</code>が1のサブネット）が削除された場合に、その後のリソースが全て作り直しになることを意味します。</p><p>ここも<code>count</code>の不便なところで、将来的に数が増減するようなリソースを構築する際は向いていません。</p><h2 id="ループ処理-for-each"><a href="#ループ処理-for-each" class="headerlink" title="ループ処理(for_each)"></a>ループ処理(for_each)</h2><p><code>count</code>の不便なところを解決したのが<code>for_each</code>だと思います。</p><p><code>for_each</code>を使うと以下のように書くことができます。</p><p><a href="https://developer.hashicorp.com/terraform/language/expressions/type-constraints#set">set</a>や<a href="https://developer.hashicorp.com/terraform/language/expressions/type-constraints#map">map</a>を定義して、その要素の数だけリソースを構築することができます。</p><p>setやmapの値は<code>each.key</code>（setの値やmapのkey）や<code>each.value</code>（setの値やmapのvalue）を使って各変数に定義できます。（＝setを使う場合は<code>each.key</code>と<code>each.value</code>は同じになります。）</p><p>mapが多重構造になっている場合は、以下のように<code>each.value.xxx</code>と書くことで変数に定義できます。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">resource <span class="string">&quot;aws_subnet&quot;</span> <span class="string">&quot;subnet&quot;</span> &#123;</span><br><span class="line">  for_each = tomap(&#123;</span><br><span class="line">    public-1a = &#123;</span><br><span class="line">      az     = <span class="string">&quot;ap-northeast-1a&quot;</span></span><br><span class="line">      netnum = 0</span><br><span class="line">    &#125;,</span><br><span class="line">    public-1c = &#123;</span><br><span class="line">      az     = <span class="string">&quot;ap-northeast-1c&quot;</span></span><br><span class="line">      netnum = 1</span><br><span class="line">    &#125;,</span><br><span class="line">    private-1a = &#123;</span><br><span class="line">      az     = <span class="string">&quot;ap-northeast-1a&quot;</span></span><br><span class="line">      netnum = 2</span><br><span class="line">    &#125;,</span><br><span class="line">    private-1c = &#123;</span><br><span class="line">      az     = <span class="string">&quot;ap-northeast-1c&quot;</span></span><br><span class="line">      netnum = 3</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">  vpc_id            = aws_vpc.test-vpc.id</span><br><span class="line">  availability_zone = each.value.az</span><br><span class="line">  cidr_block        = cidrsubnet(aws_vpc.test-vpc.cidr_block, 8, each.value.netnum)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可読性も比較的保たれたまま、resource blockを1つで書くことができました！</p><p>もちろん、publicとprivateでresource blockを分けても良いです。<code>count</code>と違い、リソースを増減させたい場合はmapに要素を追加するだけで良く、かつkeyで管理されているので既存のリソースに影響が及びません。</p><p>また<code>for_each</code>は複数の属性をループで回せて便利なので、<code>az</code>もループに含めてマルチAZ構成も実現しています。</p><h2 id="ループ処理-for"><a href="#ループ処理-for" class="headerlink" title="ループ処理(for)"></a>ループ処理(for)</h2><p>後述する<code>dynamic block</code>も同様ですが、<code>count</code>や<code>for_each</code>と違って<code>for</code>は「式」です。誤解を恐れず簡単に言うと、そもそもリソースを複数作るためのものではないということです。</p><p>具体的には、<code>for</code>は<a href="https://developer.hashicorp.com/terraform/language/expressions/type-constraints#list">list</a>, <a href="https://developer.hashicorp.com/terraform/language/expressions/type-constraints#set">set</a>, <a href="https://developer.hashicorp.com/terraform/language/expressions/type-constraints#tuple">tuple</a>, <a href="https://developer.hashicorp.com/terraform/language/expressions/type-constraints#map">map</a>, <a href="https://developer.hashicorp.com/terraform/language/expressions/type-constraints#object">object</a>を入力として、<a href="https://developer.hashicorp.com/terraform/language/expressions/type-constraints#tuple">tuple</a>もしくは<a href="https://developer.hashicorp.com/terraform/language/expressions/type-constraints#object">object</a>を出力するものです。そのため使い方は多様ですが、個人的に嬉しい使い方を2つ記載します。</p><h3 id="使い方①-特定条件でフィルタリングしてリソースを構築する"><a href="#使い方①-特定条件でフィルタリングしてリソースを構築する" class="headerlink" title="使い方① 特定条件でフィルタリングしてリソースを構築する"></a>使い方① 特定条件でフィルタリングしてリソースを構築する</h3><p>構築するリソースが増えてくると、tfファイルの数やコードの行数が多くなって管理が大変でしょう。</p><p>そんな時は<code>local values</code>に各設定値を一元的に記載しておくと管理しやすくなるかもしれません。</p><p>以下の例は無理やり<code>for</code>を使いに行ってるので良い例ではありませんが、<code>local values</code>に条件となる値を設定しておき、resource blockではその条件によって構築や設定をするかを振り分ける、ということが可能です。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">locals &#123;</span><br><span class="line">  subnet = &#123;</span><br><span class="line">    public-1a = &#123;</span><br><span class="line">      public = <span class="literal">true</span></span><br><span class="line">      az     = <span class="string">&quot;ap-northeast-1a&quot;</span></span><br><span class="line">      netnum = 0</span><br><span class="line">    &#125;,</span><br><span class="line">    public-1c = &#123;</span><br><span class="line">      public = <span class="literal">true</span></span><br><span class="line">      az     = <span class="string">&quot;ap-northeast-1c&quot;</span></span><br><span class="line">      netnum = 1</span><br><span class="line">    &#125;,</span><br><span class="line">    private-1a = &#123;</span><br><span class="line">      public = <span class="literal">false</span></span><br><span class="line">      az     = <span class="string">&quot;ap-northeast-1a&quot;</span></span><br><span class="line">      netnum = 3</span><br><span class="line">    &#125;,</span><br><span class="line">    private-1c = &#123;</span><br><span class="line">      public = <span class="literal">false</span></span><br><span class="line">      az     = <span class="string">&quot;ap-northeast-1c&quot;</span></span><br><span class="line">      netnum = 4</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource <span class="string">&quot;aws_subnet&quot;</span> <span class="string">&quot;public&quot;</span> &#123;</span><br><span class="line">  for_each          = &#123; <span class="keyword">for</span> key, value <span class="keyword">in</span> local.subnet : key =&gt; value <span class="keyword">if</span> value.public == <span class="literal">true</span> &#125;</span><br><span class="line">  vpc_id            = aws_vpc.test-vpc.id</span><br><span class="line">  availability_zone = each.value.az</span><br><span class="line">  cidr_block        = cidrsubnet(aws_vpc.test-vpc.cidr_block, 8, each.value.netnum)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource <span class="string">&quot;aws_subnet&quot;</span> <span class="string">&quot;private&quot;</span> &#123;</span><br><span class="line">  for_each          = &#123; <span class="keyword">for</span> key, value <span class="keyword">in</span> local.subnet : key =&gt; value <span class="keyword">if</span> value.public == <span class="literal">false</span> &#125;</span><br><span class="line">  vpc_id            = aws_vpc.test-vpc.id</span><br><span class="line">  availability_zone = each.value.az</span><br><span class="line">  cidr_block        = cidrsubnet(aws_vpc.test-vpc.cidr_block, 8, each.value.netnum)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>参考：<a href="https://developer.hashicorp.com/terraform/language/values/locals">Local Values</a></p><h3 id="使い方②-あるリソースの特定の設定値一覧を取得する"><a href="#使い方②-あるリソースの特定の設定値一覧を取得する" class="headerlink" title="使い方② あるリソースの特定の設定値一覧を取得する"></a>使い方② あるリソースの特定の設定値一覧を取得する</h3><p>例えばprivateサブネットからのみアクセス可能としたいリソース（EC2など）を構築し、そのセキュリティグループを構築するような場合を考えます。</p><p>サブネットは将来的に増減する可能性があり、それらのCIDRブロックを反映させて適切なインバウンドルールを設定する必要があります。</p><p>以下の<code>local.allow_cidr_block</code>のように記載することで、publicサブネットとprivateサブネットのCIDRブロック一覧が簡単に取得できます。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">locals &#123;</span><br><span class="line">  subnet = &#123;</span><br><span class="line">    public = &#123;</span><br><span class="line">      public-1a = &#123;</span><br><span class="line">        az     = <span class="string">&quot;ap-northeast-1a&quot;</span></span><br><span class="line">        netnum = 0</span><br><span class="line">      &#125;,</span><br><span class="line">      public-1c = &#123;</span><br><span class="line">        az     = <span class="string">&quot;ap-northeast-1c&quot;</span></span><br><span class="line">        netnum = 1</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    private = &#123;</span><br><span class="line">      private-1a = &#123;</span><br><span class="line">        az     = <span class="string">&quot;ap-northeast-1a&quot;</span></span><br><span class="line">        netnum = 2</span><br><span class="line">      &#125;,</span><br><span class="line">      private-1c = &#123;</span><br><span class="line">        az     = <span class="string">&quot;ap-northeast-1c&quot;</span></span><br><span class="line">        netnum = 3</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">  allow_cidr_block = &#123;</span><br><span class="line">    public = [</span><br><span class="line">      <span class="keyword">for</span> k, v <span class="keyword">in</span> local.subnet.public :</span><br><span class="line">      aws_subnet.public[k].cidr_block</span><br><span class="line">    ]</span><br><span class="line">    private = [</span><br><span class="line">      <span class="keyword">for</span> k, v <span class="keyword">in</span> local.subnet.private :</span><br><span class="line">      aws_subnet.private[k].cidr_block</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource <span class="string">&quot;aws_subnet&quot;</span> <span class="string">&quot;public&quot;</span> &#123;</span><br><span class="line">  for_each          = local.subnet.public</span><br><span class="line">  vpc_id            = aws_vpc.test-vpc.id</span><br><span class="line">  availability_zone = each.value.az</span><br><span class="line">  cidr_block        = cidrsubnet(aws_vpc.test-vpc.cidr_block, 8, each.value.netnum)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource <span class="string">&quot;aws_subnet&quot;</span> <span class="string">&quot;private&quot;</span> &#123;</span><br><span class="line">  for_each          = local.subnet.private</span><br><span class="line">  vpc_id            = aws_vpc.test-vpc.id</span><br><span class="line">  availability_zone = each.value.az</span><br><span class="line">  cidr_block        = cidrsubnet(aws_vpc.test-vpc.cidr_block, 8, each.value.netnum)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource <span class="string">&quot;aws_security_group&quot;</span> <span class="string">&quot;private_resource&quot;</span> &#123;</span><br><span class="line">  vpc_id = aws_vpc.test-vpc.id</span><br><span class="line">  ingress &#123;</span><br><span class="line">    from_port   = 443</span><br><span class="line">    to_port     = 443</span><br><span class="line">    protocol    = <span class="string">&quot;tcp&quot;</span></span><br><span class="line">    cidr_blocks = local.allow_cidr_block.private</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ループ処理-dynamic-block"><a href="#ループ処理-dynamic-block" class="headerlink" title="ループ処理(dynamic block)"></a>ループ処理(dynamic block)</h2><p><code>count</code>や<code>for_each</code>がresource blockを複数作成するときに利用したのに対し、<code>dynamic block</code>はresource block内のブロックを複製するときに利用できます。</p><p>例えば、<code>for</code>の使い方②で述べたようなセキュリティグループを構築する場合で、publicとprivate両方のサブネットからアクセス可能なセキュリティグループを作りたいとします。</p><p>この場合は、<code>ingress</code>のブロックを複製すると簡単に構築できるため、以下のように<code>dynamic block</code>が利用して書くことができます。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">locals &#123;</span><br><span class="line">  subnet = &#123;</span><br><span class="line">    public = &#123;</span><br><span class="line">      public-1a = &#123;</span><br><span class="line">        az     = <span class="string">&quot;ap-northeast-1a&quot;</span></span><br><span class="line">        netnum = 0</span><br><span class="line">      &#125;,</span><br><span class="line">      public-1c = &#123;</span><br><span class="line">        az     = <span class="string">&quot;ap-northeast-1c&quot;</span></span><br><span class="line">        netnum = 1</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    private = &#123;</span><br><span class="line">      private-1a = &#123;</span><br><span class="line">        az     = <span class="string">&quot;ap-northeast-1a&quot;</span></span><br><span class="line">        netnum = 2</span><br><span class="line">      &#125;,</span><br><span class="line">      private-1c = &#123;</span><br><span class="line">        az     = <span class="string">&quot;ap-northeast-1c&quot;</span></span><br><span class="line">        netnum = 3</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">  allow_cidr_block = &#123;</span><br><span class="line">    public = [</span><br><span class="line">      <span class="keyword">for</span> k, v <span class="keyword">in</span> local.subnet.public :</span><br><span class="line">      aws_subnet.public[k].cidr_block</span><br><span class="line">    ]</span><br><span class="line">    private = [</span><br><span class="line">      <span class="keyword">for</span> k, v <span class="keyword">in</span> local.subnet.private :</span><br><span class="line">      aws_subnet.private[k].cidr_block</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource <span class="string">&quot;aws_subnet&quot;</span> <span class="string">&quot;public&quot;</span> &#123;</span><br><span class="line">  for_each          = local.subnet.public</span><br><span class="line">  vpc_id            = aws_vpc.test-vpc.id</span><br><span class="line">  availability_zone = each.value.az</span><br><span class="line">  cidr_block        = cidrsubnet(aws_vpc.test-vpc.cidr_block, 8, each.value.netnum)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource <span class="string">&quot;aws_subnet&quot;</span> <span class="string">&quot;private&quot;</span> &#123;</span><br><span class="line">  for_each          = local.subnet.private</span><br><span class="line">  vpc_id            = aws_vpc.test-vpc.id</span><br><span class="line">  availability_zone = each.value.az</span><br><span class="line">  cidr_block        = cidrsubnet(aws_vpc.test-vpc.cidr_block, 8, each.value.netnum)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource <span class="string">&quot;aws_security_group&quot;</span> <span class="string">&quot;public_resource&quot;</span> &#123;</span><br><span class="line">  vpc_id = aws_vpc.test-vpc.id</span><br><span class="line">  dynamic <span class="string">&quot;ingress&quot;</span> &#123;</span><br><span class="line">    for_each = local.allow_cidr_block</span><br><span class="line">    content &#123;</span><br><span class="line">      from_port   = 443</span><br><span class="line">      to_port     = 443</span><br><span class="line">      protocol    = <span class="string">&quot;tcp&quot;</span></span><br><span class="line">      cidr_blocks = ingress.value</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ただし、<code>dynamic block</code>は冒頭の説明でも述べた通り「resource block内のブロック」を複製するもので、単純なkey : value の形で定義する変数では利用できなかったりと、使い方が限定的です。（本記事では主にサブネットを複製してきましたが、サブネットの複製にdynamic blockは使えません。）</p><p>もう少しだけ<code>dynamic block</code>の使い道を考えます。</p><p>実践ではセキュリティグループは1個ということは基本ありえず、様々なリソース用に色々なセキュリティグループを構築することになるでしょう。</p><p>また、それぞれのセキュリティグループにはルールはいくつか存在し、CIDRブロックでなくセキュリティグループがソースになったり、ポートやプロトコルが異なっていたりもするでしょう。そうなると、以下のように全ての設定値を<code>local values</code>にmapとしてまとめておくのが良いでしょう。（長くなるのでサブネット部分の記述も省略しました。）</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">locals &#123;</span><br><span class="line">  subnet = &#123;</span><br><span class="line">    public = &#123;</span><br><span class="line">      public-1a = &#123;</span><br><span class="line">        az     = <span class="string">&quot;ap-northeast-1a&quot;</span></span><br><span class="line">        netnum = 0</span><br><span class="line">      &#125;,</span><br><span class="line">      public-1c = &#123;</span><br><span class="line">        az     = <span class="string">&quot;ap-northeast-1c&quot;</span></span><br><span class="line">        netnum = 1</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    private = &#123;</span><br><span class="line">      private-1a = &#123;</span><br><span class="line">        az     = <span class="string">&quot;ap-northeast-1a&quot;</span></span><br><span class="line">        netnum = 2</span><br><span class="line">      &#125;,</span><br><span class="line">      private-1c = &#123;</span><br><span class="line">        az     = <span class="string">&quot;ap-northeast-1c&quot;</span></span><br><span class="line">        netnum = 3</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">  allow_cidr_block = &#123;</span><br><span class="line">    public = [</span><br><span class="line">      <span class="keyword">for</span> k, v <span class="keyword">in</span> local.subnet.public :</span><br><span class="line">      aws_subnet.public[k].cidr_block</span><br><span class="line">    ]</span><br><span class="line">    private = [</span><br><span class="line">      <span class="keyword">for</span> k, v <span class="keyword">in</span> local.subnet.private :</span><br><span class="line">      aws_subnet.private[k].cidr_block</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">  security_group = &#123;</span><br><span class="line">    ec2_a = &#123;</span><br><span class="line">      ingress_1 = &#123;</span><br><span class="line">        from_port       = 22</span><br><span class="line">        to_port         = 22</span><br><span class="line">        protocol        = <span class="string">&quot;tcp&quot;</span></span><br><span class="line">        cidr_blocks     = local.allow_cidr_block.private</span><br><span class="line">        security_groups = null</span><br><span class="line">      &#125;,</span><br><span class="line">      ingress_2 = &#123;</span><br><span class="line">        from_port       = 80</span><br><span class="line">        to_port         = 80</span><br><span class="line">        protocol        = <span class="string">&quot;tcp&quot;</span></span><br><span class="line">        cidr_blocks     = null</span><br><span class="line">        security_groups = [aws_security_group.alb.id]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ec2_b = &#123;</span><br><span class="line">      ingress_1 = &#123;</span><br><span class="line">        from_port       = 22</span><br><span class="line">        to_port         = 22</span><br><span class="line">        protocol        = <span class="string">&quot;tcp&quot;</span></span><br><span class="line">        cidr_blocks     = local.allow_cidr_block.private</span><br><span class="line">        security_groups = null</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource <span class="string">&quot;aws_security_group&quot;</span> <span class="string">&quot;ec2_a&quot;</span> &#123;</span><br><span class="line">  vpc_id = aws_vpc.test-vpc.id</span><br><span class="line">  dynamic <span class="string">&quot;ingress&quot;</span> &#123;</span><br><span class="line">    for_each = local.security_group.ec2_a</span><br><span class="line">    content &#123;</span><br><span class="line">      from_port       = ingress.value.from_port</span><br><span class="line">      to_port         = ingress.value.to_port</span><br><span class="line">      protocol        = ingress.value.protocol</span><br><span class="line">      cidr_blocks     = ingress.value.cidr_blocks != null ? ingress.value.cidr_blocks : null</span><br><span class="line">      security_groups = ingress.value.security_groups != null ? ingress.value.security_groups : null</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource <span class="string">&quot;aws_security_group&quot;</span> <span class="string">&quot;ec2_b&quot;</span> &#123;</span><br><span class="line">  vpc_id = aws_vpc.test-vpc.id</span><br><span class="line">  dynamic <span class="string">&quot;ingress&quot;</span> &#123;</span><br><span class="line">    for_each = local.security_group.ec2_b</span><br><span class="line">    content &#123;</span><br><span class="line">      from_port   = ingress.value.from_port</span><br><span class="line">      to_port     = ingress.value.to_port</span><br><span class="line">      protocol    = ingress.value.protocol</span><br><span class="line">      cidr_blocks     = ingress.value.cidr_blocks != null ? ingress.value.cidr_blocks : null</span><br><span class="line">      security_groups = ingress.value.security_groups != null ? ingress.value.security_groups : null</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>…なんとか書けました。</p><p>ご覧の通り<code>cidr_blocks</code>と<code>security_groups</code>はどちらかのみ設定するため、それを実現させるために後述する<code>三項演算子</code>を用いたり、<code>local values</code>にもわざわざnullとして定義しています。</p><p>さて、ループ処理の目的である<code>コードの冗長化を防ぎ、可読性や保守性を上げる</code>ことはできたでしょうか。<code>dynamic block</code>を使わずにシンプルに<code>ingress</code>のブロックを羅列しても行数はむしろ減りますし、ループや条件分岐がなくなる分、可読性や保守性も上がりそうです。</p><p>ちなみに<a href="https://developer.hashicorp.com/terraform/language/expressions/dynamic-blocks#best-practices-for-dynamic-blocks">公式のベストプラクティス</a>でも<code>dynamic block</code>の使い過ぎは推奨されておらず、モジュールの再利用を目的としてシンプルな構成にしたいような場合に、利用することを推奨しています。</p><p>このため、<code>dynamic block</code>は可読性や保守性を考えて慎重に利用するのが良いと思われます。</p><h2 id="条件分岐-三項演算子"><a href="#条件分岐-三項演算子" class="headerlink" title="条件分岐(三項演算子)"></a>条件分岐(三項演算子)</h2><p>Terraformでは条件分岐を行いたい場合は基本1通りで、この三項演算子を利用します。</p><p>構文は以下の通りで、<code>condition</code>に記載した条件がtrueなら<code>true_val</code>が、falseなら<code>false_val</code>が採用されます。</p><blockquote><p>condition ? true_val : false_val</p></blockquote><p>参考：<a href="https://developer.hashicorp.com/terraform/language/expressions/conditionals#syntax">Conditional Expressions</a></p><p>簡単な例では、環境ごとにリソースの数を変えるような場合があります。</p><p>例えば本番環境は冗長化したいのでマルチAZで構築するが、開発&#x2F;検証環境はシングルAZで良い場合などに、環境名ごとにcountの値を変えるような操作が可能です。<br>以下のように書くことで、環境名（<code>local.env</code>）の値を変えるだけで本番環境と開発&#x2F;検証環境で、リソース数の切り替えができます。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">locals &#123;</span><br><span class="line">  <span class="built_in">env</span> = <span class="string">&quot;prod&quot;</span></span><br><span class="line">  az = [</span><br><span class="line">    <span class="string">&quot;ap-northeast-1a&quot;</span>,</span><br><span class="line">    <span class="string">&quot;ap-northeast-1c&quot;</span>,</span><br><span class="line">    <span class="string">&quot;ap-northeast-1d&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource <span class="string">&quot;aws_subnet&quot;</span> <span class="string">&quot;public&quot;</span> &#123;</span><br><span class="line">  count             = local.env == <span class="string">&quot;prod&quot;</span> ? 2 : 1</span><br><span class="line">  vpc_id            = aws_vpc.test-vpc.id</span><br><span class="line">  availability_zone = local.az[count.index]</span><br><span class="line">  cidr_block        = cidrsubnet(aws_vpc.test-vpc.cidr_block, 8, count.index)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource <span class="string">&quot;aws_subnet&quot;</span> <span class="string">&quot;private&quot;</span> &#123;</span><br><span class="line">  count             = local.env == <span class="string">&quot;prod&quot;</span> ? 2 : 1</span><br><span class="line">  vpc_id            = aws_vpc.test-vpc.id</span><br><span class="line">  availability_zone = local.az[count.index]</span><br><span class="line">  cidr_block        = cidrsubnet(aws_vpc.test-vpc.cidr_block, 8, count.index + 2)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="条件分岐-for-each-と-for-を併用"><a href="#条件分岐-for-each-と-for-を併用" class="headerlink" title="条件分岐(for_each と for を併用)"></a>条件分岐(for_each と for を併用)</h2><p>こちらは、<code>for</code>の部分で記載したものの再掲となります。</p><p>Terraformに一般的なプログラミング言語でいうif文はありませんが、<code>for</code>文の中のifによってループ処理の中で条件分岐を行うことができます。</p><p>使い方は<a href="#%E4%BD%BF%E3%81%84%E6%96%B9%E2%91%A0-%E7%89%B9%E5%AE%9A%E6%9D%A1%E4%BB%B6%E3%81%A7%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF%E3%83%AA%E3%83%B3%E3%82%B0%E3%81%97%E3%81%A6%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%92%E6%A7%8B%E7%AF%89%E3%81%99%E3%82%8B">for（使い方① 特定条件でフィルタリングしてリソースを構築する）</a>をご参照ください。</p><h1 id="最後に"><a href="#最後に" class="headerlink" title="最後に"></a>最後に</h1><p>Terraformにおけるループ処理と条件分岐をまとめました。</p><p>自分も例外ではなく、初心者はまずTerraformの構文に慣れるところが難しいかと思います。</p><p>本記事が同じようなTerraform初心者の一助となれば幸いです。</p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;img src=&quot;/images/20240328b/top.png&quot; alt=&quot;&quot; width=&quot;800&quot; height=&quot;527&quot;&gt;

&lt;h2 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot;</summary>
        
      
    
    
    
    <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
    <category term="初心者向け" scheme="https://future-architect.github.io/tags/%E5%88%9D%E5%BF%83%E8%80%85%E5%90%91%E3%81%91/"/>
    
    <category term="Terraform" scheme="https://future-architect.github.io/tags/Terraform/"/>
    
  </entry>
  
  <entry>
    <title>言語処理学会 (NLP2024) 参加報告</title>
    <link href="https://future-architect.github.io/articles/20240328a/"/>
    <id>https://future-architect.github.io/articles/20240328a/</id>
    <published>2024-03-27T15:00:00.000Z</published>
    <updated>2024-03-28T03:38:43.429Z</updated>
    
    <content type="html"><![CDATA[<h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>フューチャー技術ブログでは長らくご無沙汰しております。フューチャー株式会社の佐藤と申します。Strategic AI Group (SAIG) の一員として様々な先端技術の研究や社会実装に取り組んでおりますが、このところはもっぱら自然言語処理 (NLP) 畑出身の人たちに揉まれながら過ごしています。</p><p>2024年3月11日(月)〜3月15日(金)において神戸国際会議場にて開催されました<a href="https://www.anlp.jp/nlp2024/">言語処理学会第30回年次大会 (NLP2024)</a> に参加しました。</p><p>当社はプラチナスポンサーとして SAIG の 4 名がオンサイトで参加し、スポンサーブースでの会社紹介及びポスター発表を行いました。「<a href="https://www.anlp.jp/proceedings/annual_meeting/2024/pdf_dir/P10-13.pdf">機密情報検知における生成AIを用いたデータ拡張</a>」と題した我々のポスター発表について、詳しくは先日 SAIG 岸波さんが公開した技術ブログ記事「<a href="/articles/20240326b/">言語処理学会 (NLP2024) でポスター発表を行いました</a>」をご覧ください。<br><img src="/images/20240328a/20240314_172101.JPG" alt="20240314_172101.JPG" width="1200" height="900" loading="lazy"></p><h2 id="言語処理学会とは"><a href="#言語処理学会とは" class="headerlink" title="言語処理学会とは"></a>言語処理学会とは</h2><p>言語処理学会は NLP 分野における国内最大の学会で、毎年 3 月に開催されています。年次大会は今年でちょうど 30 回目となり、記念講演も行われていました。口頭発表は 4 会場に分かれ、それと並行して 3 会場×日に 3-4 交代するポスター発表、最終日にはワークショップと盛りだくさんの内容です。</p><p>今回の大会スローガンは「30年のプロンプトから未来を創造する」でした。プロンプトとある通り、ChatGPT はじめ LLM の隆盛によって自然言語処理はいま最もホットな分野といっても過言ではありません。参加者数は当日登録含まない一日目時点で 2045 名と、昨年以上の伸び幅を見せ 2000 の大台に乗りました。加えて発表件数、スポンサー数も史上最多であり、参加していて非常に活気を感じる学会でした。</p><h2 id="スポンサーブース"><a href="#スポンサーブース" class="headerlink" title="スポンサーブース"></a>スポンサーブース</h2><p>企業ブースを出展し AI 案件実績の紹介と人材募集を行いました。当社をご存じなかった方々にも数多くリーチでき、研究についてのディスカッションも盛り上がりました。</p><p>主に学生の方へ向けては、会社紹介のパンフレットと共にノベルティとしてトートバッグを配布しました。かなり多めに持っていったつもりでしたが、会期中ブースへ次々に足を運んでいただいたおかげでほぼほぼ売り切れました。</p><img src="/images/20240328a/20240311_122953.JPG" alt="20240311_122953.JPG" width="1200" height="900" loading="lazy"><h2 id="発表・セッションの紹介"><a href="#発表・セッションの紹介" class="headerlink" title="発表・セッションの紹介"></a>発表・セッションの紹介</h2><p>このセクションでは、参加した各メンバーごとに口頭発表・ポスター発表の中からいくつか紹介します。</p><ul><li><strong><a href="https://www.anlp.jp/proceedings/annual_meeting/2024/pdf_dir/A1-2.pdf">[A1-2] プロンプトチューニングとkNN-LMを組み合わせたリスティング広告のタイトル自動生成</a></strong><br>リスティング広告 (:&#x3D;ググったときに画面の上に出てくるテキスト広告) のタイトル生成を題材に、言語モデル (LM)をファインチューニング (FT) することなく経時的な社会トレンド変化に追従させる方法を検討しています。筆者らは、LM の中間表現を事前に格納しておくことで FT なしにドメイン適応可能な kNN-LM と、prompting を行いより柔軟にトレンドに追従できる Instruction-Tuning 済の LM を組み合わせる方法を提案しました。さらに、これらのモデルを分割・変更しても性能の劣化が小さいことを示し、例えばある LM でシステムを構築した後により高性能な LM が公開された場合に、前者の中間表現をそのままに後者だけ更新してもよいのではないかと示唆しています。<br>実際の運用上定期的に FT を行うことは労力的に困難なことが多く、分割して一部だけ prompting を行えば性能が保持できそうという考察に惹かれました。発表における題材はリスティング広告という30字程度の生成でしたが、より長文の生成に対しても利用できれば楽しそうです。(佐藤)</li><li><strong><a href="https://www.anlp.jp/proceedings/annual_meeting/2024/pdf_dir/P8-6.pdf">[P8-6] 大規模言語モデル開発における日本語 Web 文書のフィルタリング手法の検証</a></strong><br>日本語に適応した大規模言語モデル(LLM) のために日本語コーパスが求められる一方で、コーパスの大部分を占める Web コンテンツのフィルタリング手法が確立されていないことから、高速に処理できるフィルタリング処理方法を複数検討しています。ベンチマークの結果 N-gram LM の perplexity を元にした分類器の精度が最も良かったと評価できるものの、フィルタリングをかけても下流タスクの精度向上が有意にはみられず、また強すぎるフィルタリングによって下流タスク精度は大幅に悪化しました。フィルタリングによって特定トピックや特定ドメインのコンテンツ――端的に言うと楽天市場の商品名――が大きく減少していることや、perplexity が低くフィルタリングを通過しても日本語として支離滅裂な文章が存在することを観察しています。<br>直感的に低品質とわかる商品名等を除外できても精度向上に不足というのは難しいなと感じました。逆説的に、世の LLM が単純な N-gram 単位の perplexity によらない「文脈」を獲得していることの傍証とも言えそうです。(佐藤)</li><li><strong><a href="https://www.anlp.jp/proceedings/annual_meeting/2024/pdf_dir/B2-4.pdf">[B2-4] 対訳データを用いた継続事前訓練による大規模言語モデルの翻訳精度評価</a></strong><br>この研究では、大規模言語モデル (LLM) の翻訳性能を高めるための手法として、対訳データを結合した文を用いる継続事前学習を提案しています。本研究の興味深い点は、はじめから大規模な翻訳データを指示学習のフォーマットに当てはめて学習する場合に比べて、継続事前学習の方式を取ることが極めて有効であったという点です。指示学習形式のfine-tuning (SFT) は指示文という羅針盤の存在により、空白から次のトークンを予測する (継続) 事前学習よりもはるかに小さな学習データから精度の向上を見込むことができる手法です。<br>今回、大規模な学習データを用意できる設定で指示学習 &lt; 継続事前学習 (+指示学習) という構図が示されたことは非常に面白いと感じます。この研究では翻訳を題材としていますが、input-outputペアの結合による継続事前学習の他のタスクにおける有効性や、指示学習のスケーラビリティーに関する示唆が得られれば、LLMに関する理解を一歩深める良い研究になると思いました。 (藤井)</li><li><strong><a href="https://www.anlp.jp/proceedings/annual_meeting/2024/pdf_dir/B9-4.pdf">[B9-4] タスク指向型対話システムへの項目反応理論の適用によるユーザのタスク達成能力の推定</a></strong><br>この研究では、タスク指向対話システムにおけるユーザのタスク遂行能力を項目反応理論 (IRT) に基づいて推定しています。項目反応理論 (IRT) は教育分野で用いられる考え方で、テストのある設問に対する多数の受験者の正誤データから設問の特性 (難しさや受験者の能力を判別する識別力) を分析し、各設問に対する解答パターンから尤もらしい受験者の能力を推定する、というものです。本研究では旅行案内タスクのデータセットを用いて、例えば「ホテルの予約に関する予算の希望を聞く質問に正しく予算を回答できるか？」といった質問をテストにおける1つの設問になぞらえることでIRTを適用しています。実験の結果、提案手法でユーザの能力を推定した場合、後続の対話におけるタスク遂行能力を比較的高精度で予測できることが示されています。<br>なお、実応用に際しては、事前に識別力の高い質問 (≒ ユーザの能力に応じて解答に大きくブレが生じるような質問) を一度は聞かなれけばならない、推定したユーザ能力に基づいて最短のターン数で目的を達成する対話に最適化する方法は自明でない等、残り越えるべき課題も残されています。しかしながら、システムが対話を通じてユーザに適応していくという考え方は非常に興味深く、今後の進展に期待できると考えます。 (藤井)</li><li><strong><a href="https://www.anlp.jp/proceedings/annual_meeting/2024/pdf_dir/P8-8.pdf">[P8-8] 日本語タスクにおけるLLMを用いた疑似学習データ生成の検討</a></strong><br>近年、大規模言語モデル (LLM) にタスクの説明文と少数の事例を入力するFew-Shot等の手法が様々なタスクで高い性能を発揮することが知られていますが、GPUリソースの制約等、LLMの運用コストは高いです。この研究では、6つの日本語の自然言語処理タスクに関して、LLMを用いて疑似データを作成し、そのデータを用いてBERTのような小規模モデルを学習することで、LLMのFew-Shot等の性能にどの程度迫れるかを検証しています。各タスクの疑似データを作成するために、タスクの知識を利用したKADGという疑似データ生成手法を提案しています。提案手法はシンプルで、疑似データを生成する際のプロンプトにタスクに関する内容語を含めるというものです。提案手法によって疑似データを作成し、小規模モデルを学習させた結果、フォーマルなテキストを入力とするタスクでLLMの性能を上回ることを明らかにしました。<br>生成AIブームの中で、様々な場面でLLMが使用されがちですが、タスクによっては小規模モデルで十分と感じるケースもあります。そんななかで、学習データの作成にLLMを活用することで、小規模モデルでもLLMを超えられる可能性を示しているのは興味深いと感じました。また、今回の言語処理学会で我々もLLMを用いたデータ拡張の研究を発表しており、このような方向性の研究が発展していってほしいという期待も込めて挙げさせていただきました。 (岸波)</li></ul><h2 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h2><p>大学院時代から実に 5 年ぶりのオフライン学会参加でした。奇跡的に、その 5 年前にも神戸のポートアイランドで発表をした覚えがあります。</p><p>NLP2024 は当時の研究分野から垣根を 2 つほど超えた先の分野ではありましたが、数多くの研究を見ることができとても良い刺激になりました。</p><p>現在 SAIG ではともに働くメンバーを募集しています。特に NLP分野における社会実装のニーズは根強く、多くの仲間を必要としているところです。キャリア採用ページでは <a href="https://open.talentio.com/r/1/c/future/pages/76795">シニアNLPエンジニアの募集</a> がピックアップされております。採用ページができておらず恐縮ですが、NLPリサーチエンジニア及びNLPエンジニアも同じく絶賛募集中です。条件等応相談ですので、我こそはという読者の方、是非先のリンクよりご応募をお待ちしております。</p><p>ほかにも幅広く <a href="https://www.future.co.jp/recruit/recruit/rec-fresh/">新卒採用</a> および <a href="https://www.future.co.jp/recruit/recruit/rec-career/">キャリア採用</a> を募集中です。興味のある方は是非一緒に働きましょう。よろしくお願いします！</p><img src="/images/20240328a/20240313_112622.JPG" alt="20240313_112622.JPG" width="1200" height="900" loading="lazy">▲ 会場近くの南公園の噴水。]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot; title=&quot;はじめに&quot;&gt;&lt;/a&gt;はじめに&lt;/h2&gt;&lt;p&gt;フューチャー技術ブログでは長らくご無沙汰しております。フューチャー株式会社の佐藤と申します。Strategic AI</summary>
        
      
    
    
    
    <category term="Infrastructure" scheme="https://future-architect.github.io/categories/Infrastructure/"/>
    
    
    <category term="参加レポート" scheme="https://future-architect.github.io/tags/%E5%8F%82%E5%8A%A0%E3%83%AC%E3%83%9D%E3%83%BC%E3%83%88/"/>
    
    <category term="機械学習" scheme="https://future-architect.github.io/tags/%E6%A9%9F%E6%A2%B0%E5%AD%A6%E7%BF%92/"/>
    
    <category term="NLP" scheme="https://future-architect.github.io/tags/NLP/"/>
    
    <category term="学会" scheme="https://future-architect.github.io/tags/%E5%AD%A6%E4%BC%9A/"/>
    
    <category term="NLP2024" scheme="https://future-architect.github.io/tags/NLP2024/"/>
    
  </entry>
  
  <entry>
    <title>手動運用しているCloudflareをTerraformでInfrastructure as Codeする</title>
    <link href="https://future-architect.github.io/articles/20240327a/"/>
    <id>https://future-architect.github.io/articles/20240327a/</id>
    <published>2024-03-26T15:00:00.000Z</published>
    <updated>2024-03-27T01:19:23.558Z</updated>
    
    <content type="html"><![CDATA[<h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>この記事は、<a href="/articles/20240311a/">Terraform連載2024</a>の10記事目です。</p><p>みなさんこんにちは。TIG所属の大岩潤矢( <a href="https://x.com/920OJ">@920OJ</a> ) です。</p><p>本記事ではCloudflareで管理しているドメインのDNS設定やCloudflare Pages等のサービスの設定を、Terraform管理に移行した際の手順などを記載します。</p><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>私は個人開発や自身のポートフォリオWebサイトの公開のために、 <code>920oj.net</code> というドメインを所持しています。このドメインはGoogle Domainsで取得し、ネームサーバを変更してCloudflare上でDNSレコードを管理しています。</p><p>また、自身の <a href="https://920oj.net/">ポートフォリオサイトWebサイト</a> はCloudflare Pagesでホスティングしています。転送量無制限で月500ビルドまで無料というのはお財布に優しくありがたいです。</p><p>一方で、Webの管理画面からCloudflareでのドメイン管理や各種設定を変更する際、バージョン履歴を表示する機能がないため、一度変更してしまったものは元に戻すことができません。例えばDNS設定を更新する際、間違えた値に更新してしまった場合、元の値を記憶していない限りは戻せなくなってしまいます。<a href="https://developers.cloudflare.com/version-management/">バージョニング機能</a>はあるものの、Enterpriseプランのみでしか使えないようです。</p><p>そこで利用したいと思い立ったのがTerraformです。CloudflareをTerrafromで構築し、そのコードをGit等で管理することにより、変更をバージョン管理できます。記事タイトルにある通り、「Infrastructure as Codeする」ということです。</p><p>一方でCloudflareはすでに利用中であるため、これまで手作業で実施してきた設定をTerraformへimportして管理することになります。</p><p>今回移行するものは、各ドメインのDNSレコードと、Cloudflare Pagesでホスティングしているプロジェクトの2つとします。</p><h2 id="CloudflareをTerraformで管理するための前準備"><a href="#CloudflareをTerraformで管理するための前準備" class="headerlink" title="CloudflareをTerraformで管理するための前準備"></a>CloudflareをTerraformで管理するための前準備</h2><p>早速、既存リソースをTerraformで管理するための手順を紹介します。まずは下準備として、以下を実施します。</p><ul><li>tfstate管理用のR2バケットを作成</li><li>APIトークンの発行</li><li>環境変数の設定</li></ul><h3 id="Cloudflare-R2へtfstate管理用のバケットを作成する"><a href="#Cloudflare-R2へtfstate管理用のバケットを作成する" class="headerlink" title="Cloudflare R2へtfstate管理用のバケットを作成する"></a>Cloudflare R2へtfstate管理用のバケットを作成する</h3><p>CloudflareにはR2というS3互換のストレージサービスがあり、tfstateはこのR2の中で管理する方針とします。R2でtfstateを管理する方法については、すでにこのテックブログで記事があるので、これを参考にします。</p><p><a href="https://future-architect.github.io/articles/20231016a/">https://future-architect.github.io/articles/20231016a/</a></p><p>まずはCloudflareの管理画面にログインし、R2を選択→「Add R2 subscription to my account」を押下します。</p><img src="/images/20240327a/image.png" alt="Add R2 subscription to my accountをクリック" width="1200" height="615" loading="lazy"><p>「Create bucket」 を押下します。</p><img src="/images/20240327a/image_2.png" alt="Create bucketをクリック" width="965" height="405" loading="lazy"><p>バケット名を入力し、Locationは「Automatic」を選択します。最後に「Create bucket」を押下すれば、バケットが出来上がります。</p><img src="/images/20240327a/image_3.png" alt="oj-cf-tfstateというバケット名を入力" width="952" height="832" loading="lazy"><img src="/images/20240327a/image_4.png" alt="Automaticのチェックボックスを選択" width="1200" height="612" loading="lazy"><h3 id="APIトークンを発行する"><a href="#APIトークンを発行する" class="headerlink" title="APIトークンを発行する"></a>APIトークンを発行する</h3><p>CloudflareをTerraform管理、すなわちAPIで操作する場合、APIトークンの発行が必須です。</p><p>右上ユーザアイコンより「My Profile」を押下→左メニューからAPI Tokensを選び、「Create Token」を押下します。</p><img src="/images/20240327a/image_5.png" alt="Cretate Tokenをクリック" width="1200" height="615" loading="lazy"><p>Create Custom Tokenの「Get started」を押下します。</p><img src="/images/20240327a/image_6.png" alt="Get startedボタンをクリック" width="866" height="217" loading="lazy"><p>各種設定値を入力します。</p><ul><li>Token name: 任意の名前を入力</li><li>Permissions: Terraform経由で操作するサービスを選び、それぞれEditの権限を指定する<ul><li>どのサービスで何の権限が必要かは<a href="https://developers.cloudflare.com/fundamentals/api/reference/permissions/">ドキュメント</a>にまとまっているので参照のこと</li></ul></li><li>Account Resources: 自分が権限を持っているアカウント（メールアドレス）を選択可能。ここではAll accountsとしたが、複数のアカウントがある場合はここで絞っておくことが好ましい</li><li>Zone Resources: アカウントの中のドメインを選択できる。ここではAll zonesとしたが、操作できるドメインを絞りたいときはここで指定する</li><li>Client IP Address Filtering: 仮に操作されるIPアドレスが決まっている場合はここで指定する。何も入力しなければ、すべてのIPアドレスからアクセスを許容する</li><li>すべて入力できたら「Continue to summary」を押下</li></ul><img src="/images/20240327a/image_7.png" alt="" width="1200" height="764" loading="lazy"><img src="/images/20240327a/image_8.png" alt="" width="1136" height="784" loading="lazy"><p>設定内容が表示されるので、問題なければ「Create Token」を押下します。</p><img src="/images/20240327a/image_9.png" alt="Create Tokneをクリック" width="1155" height="561" loading="lazy"><p>APIトークンが表示されますが、このままではR2のAccess KeyおよびSecretが表示されないため、再度作り直します。このページでのコピーは不要です。</p><img src="/images/20240327a/image_10.png" alt="ima" width="1200" height="550" loading="lazy"><p>R2の管理ページを開き、右側メニューより「Manage R2 API Tokens」を選びます。</p><img src="/images/20240327a/image_11.png" alt="" width="1200" height="615" loading="lazy"><p>先ほど作成したトークンの「・・・」を押下し、「Roll」を選択。注意書きを読み、「Roll」を押下します。</p><img src="/images/20240327a/image_12.png" alt="" width="1200" height="404" loading="lazy"><img src="/images/20240327a/image_13.png" alt="" width="775" height="540" loading="lazy"><p>「API Token」「Access Key ID」「Secret Access Key」「R2のエンドポイント」が表示されるので、これらをすべてコピーしておきましょう。</p><img src="/images/20240327a/image_14.png" alt="" width="1200" height="680" loading="lazy"><h3 id="環境変数の設定"><a href="#環境変数の設定" class="headerlink" title="環境変数の設定"></a>環境変数の設定</h3><p>ここからは操作するPCでの作業となります。まずはターミナルを開き、環境変数をセットします。</p><p>先ほどコピーしたAPIトークン等認証情報を、環境変数としてセットします。セットするキーと値は以下のとおりです。</p><div class="scroll"><table><thead><tr><th>No.</th><th>環境変数名</th><th>値</th></tr></thead><tbody><tr><td>1</td><td>AWS_ACCOUNT_ID</td><td>CloudflareのアカウントID</td></tr><tr><td>2</td><td>AWS_ACCESS_KEY_ID</td><td>APIトークンで払い出したアクセスキーID</td></tr><tr><td>3</td><td>AWS_SECRET_ACCESS_KEY</td><td>APIトークンで払い出したシークレットアクセスキー</td></tr><tr><td>4</td><td>CLOUDFLARE_ACCOUNT_ID</td><td>CloudflareのアカウントID</td></tr><tr><td>5</td><td>CLOUDFLARE_API_TOKEN</td><td>アクセスキー、シークレットアクセスキーと共に払い出したトークン</td></tr></tbody></table></div><p>1、4については管理画面より確認できます。2、3、5については前項でコピーしたものをセットしましょう。</p><p>以下のようにシェルスクリプトにまとめて、 <code>source set-env.sh</code> のコマンドで設定できるようにすると楽です。</p><figure class="highlight bash"><figcaption><span>set-env.sh</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> AWS_ACCOUNT_ID=xxxxxxxxxxxxxxx</span><br><span class="line"><span class="built_in">export</span> AWS_ACCESS_KEY_ID=xxxxxxxxxxxxxxx</span><br><span class="line"><span class="built_in">export</span> AWS_SECRET_ACCESS_KEY=xxxxxxxxxxxxxxx</span><br><span class="line"><span class="built_in">export</span> CLOUDFLARE_ACCOUNT_ID=xxxxxxxxxxxxxxx</span><br><span class="line"><span class="built_in">export</span> CLOUDFLARE_API_TOKEN=xxxxxxxxxxxxxxx</span><br></pre></td></tr></table></figure><h2 id="CloudflareをTerraform管理する"><a href="#CloudflareをTerraform管理する" class="headerlink" title="CloudflareをTerraform管理する"></a>CloudflareをTerraform管理する</h2><p>ここからが本題で、いよいよCloudflare上にあるリソースをTerraform管理にするため、インポート等の作業を実施していきます。</p><h3 id="ディレクトリ構成"><a href="#ディレクトリ構成" class="headerlink" title="ディレクトリ構成"></a>ディレクトリ構成</h3><p>任意の場所にCloudflareのTerraform管理用のディレクトリを作成します。これをgit管理とし、その配下のディレクトリ構造・ファイル構成は以下の形とします。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.</span><br><span class="line">├── domains</span><br><span class="line">│   └── 920oj-net</span><br><span class="line">│       ├── local.tf</span><br><span class="line">│       ├── record.tf</span><br><span class="line">│       └── setup.tf</span><br><span class="line">└── global</span><br><span class="line">    └── pages</span><br><span class="line">        └── 920oj-net</span><br><span class="line">            ├── local.tf</span><br><span class="line">            ├── pages_domain.tf</span><br><span class="line">            ├── pages_project.tf</span><br><span class="line">            └── setup.tf</span><br><span class="line"></span><br><span class="line">5 directories, 7 files</span><br></pre></td></tr></table></figure><p>ドメイン（ゾーン）管理は <code>domains/</code> 配下で実施し、利用するドメインごとにフォルダを切り、それぞれでtfstateを分ける形とします。</p><p>Cloudflare Pagesはアカウントでグローバルに管理するため、 <code>global/</code> 配下で管理し、 <code>pages</code> ディレクトリを切り、さらにプロジェクトごとにディレクトリを分ける形式とします。</p><h3 id="各ディレクトリのセットアップ"><a href="#各ディレクトリのセットアップ" class="headerlink" title="各ディレクトリのセットアップ"></a>各ディレクトリのセットアップ</h3><p>Terraformのバージョン情報やプロパイダの設定、tfstateの配置場所等の初期設定に必要なファイルは、 <code>setup.tf</code> にまとめて、各ディレクトリに配置します。</p><p><code>key</code> はディレクトリごとに分けておき、tfstateが分けられるようにします。自分は以下のようなルールで運用しています。</p><ul><li>ドメイン: <code>domains/ドメイン名.tfstate</code></li><li>Pages: <code>global/pages/プロジェクト名.tfstate</code></li><li>Workers: <code>global/workers/プロジェクト名.tfstate</code></li></ul><figure class="highlight sh"><figcaption><span>setup.tf</span></figcaption><table><tr><td class="code"><pre><span class="line">terraform &#123;</span><br><span class="line">  // terraformのバージョン設定</span><br><span class="line">  required_version = <span class="string">&quot;~&gt; 1.7.5&quot;</span></span><br><span class="line"></span><br><span class="line">  // cloudflareプロバイダを利用</span><br><span class="line">  required_providers &#123;</span><br><span class="line">    cloudflare = &#123;</span><br><span class="line">      <span class="built_in">source</span>  = <span class="string">&quot;cloudflare/cloudflare&quot;</span></span><br><span class="line">      version = <span class="string">&quot;~&gt; 4.26.0&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // tfstateの保存先の設定。R2 Storageを使用する</span><br><span class="line">  backend <span class="string">&quot;s3&quot;</span> &#123;</span><br><span class="line">    endpoints = &#123;</span><br><span class="line">      s3 = <span class="string">&quot;https://&lt;アカウントID&gt;.r2.cloudflarestorage.com&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    bucket                      = <span class="string">&quot;oj-cf-tfstate&quot;</span> <span class="comment"># ここでバケット名を指定</span></span><br><span class="line">    key                         = <span class="string">&quot;domains/920oj-net.tfstate&quot;</span> <span class="comment"># ディレクトリごとにキーを変更</span></span><br><span class="line">    region                      = <span class="string">&quot;us-east-1&quot;</span> <span class="comment"># 任意の値でOK</span></span><br><span class="line">    skip_credentials_validation = <span class="literal">true</span></span><br><span class="line">    skip_requesting_account_id  = <span class="literal">true</span></span><br><span class="line">    skip_s3_checksum            = <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">provider <span class="string">&quot;cloudflare&quot;</span> &#123;&#125;</span><br></pre></td></tr></table></figure><p>backend の設定で、 <code>skip_credentials_validation</code> と <code>skip_requesting_account_id</code> 、 <code>skip_s3_checksum</code> の3つを <code>true</code> にする必要があります。</p><h3 id="ドメインのDNSレコードをimportする"><a href="#ドメインのDNSレコードをimportする" class="headerlink" title="ドメインのDNSレコードをimportする"></a>ドメインのDNSレコードをimportする</h3><p>Cloudflareのimportには、Terraform公式で用意されているimportコマンドを利用するほか、Cloudflareが独自に提供している <a href="https://github.com/cloudflare/cf-terraforming">cf-terraforming</a> というツールを利用することができます。</p><p>cf-terraformingについては、これまた伊藤さんが書かれている記事があるので、こちらも読んでみてください。</p><p><a href="https://future-architect.github.io/articles/20230502a/">https://future-architect.github.io/articles/20230502a/</a></p><p>実際に現在の設定をimportしてみましょう。</p><h4 id="generate"><a href="#generate" class="headerlink" title="generate"></a>generate</h4><p>まずは現在の設定をTerraformの記述に落とし込んでくれる <code>generate</code> コマンドを試します。</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cf-terraforming generate --resource-type <span class="string">&quot;cloudflare_record&quot;</span> --zone <span class="string">&quot;ゾーンID&quot;</span> </span><br></pre></td></tr></table></figure><ul><li><code>--resource-type</code> オプションで取得したいリソースを指定します。今回はDNS設定を取得してみるので、 <code>cloudflare_record</code> を指定します。<ul><li>取得できるリソース一覧はドキュメントに無かったので、<a href="https://github.com/cloudflare/cf-terraforming/blob/master/internal/app/cf-terraforming/cmd/generate.go">ソースコード</a>を参照します。</li></ul></li><li><code>--zone</code> オプションで取得したいzoneのIDを指定します。</li></ul><p>実行してみたところ、以下のエラーが出ました。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">FATA[0000] --account and --zone are mutually exclusive, support <span class="keyword">for</span> both is deprecated </span><br></pre></td></tr></table></figure><p>どうやら先程セットした環境変数 <code>CLOUDFLARE_ACCOUNT_ID</code> がセットされていると正常に動いてくれなさそうなので、一旦 <code>unset CLOUDFLARE_ACCOUNT_ID</code> コマンドで環境変数を外しておきます。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">% cf-terraforming generate --resource-type <span class="string">&quot;cloudflare_record&quot;</span> --zone <span class="string">&quot;ゾーンID&quot;</span> </span><br><span class="line">resource <span class="string">&quot;cloudflare_record&quot;</span> <span class="string">&quot;terraform_managed_resource_xxxxxxxxxxx&quot;</span> &#123;</span><br><span class="line">  name    = <span class="string">&quot;920oj.net&quot;</span></span><br><span class="line">  proxied = <span class="literal">true</span></span><br><span class="line">  ttl     = 1</span><br><span class="line">  <span class="built_in">type</span>    = <span class="string">&quot;CNAME&quot;</span></span><br><span class="line">  value   = <span class="string">&quot;920oj-net.pages.dev&quot;</span></span><br><span class="line">  zone_id = <span class="string">&quot;ゾーンID&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource <span class="string">&quot;cloudflare_record&quot;</span> <span class="string">&quot;terraform_managed_resource_yyyyyyyyyyy&quot;</span> &#123;</span><br><span class="line">  name     = <span class="string">&quot;920oj.net&quot;</span></span><br><span class="line">  priority = 10</span><br><span class="line">  proxied  = <span class="literal">false</span></span><br><span class="line">  ttl      = 1</span><br><span class="line">  <span class="built_in">type</span>     = <span class="string">&quot;MX&quot;</span></span><br><span class="line">  value    = <span class="string">&quot;example.com&quot;</span></span><br><span class="line">  zone_id  = <span class="string">&quot;ゾーンID&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>問題なければ、先程のコマンドの末尾に <code>&gt;&gt; record.tf</code> をつけてファイルに書き出しましょう。</p><p>このままだとリソース名がランダムなものになっているので、わかりやすいように名前を変えると管理しやすいです。</p><ul><li>例: ルートドメインのCNAMEレコード: <code>cname_root</code></li><li>例: <code>hoge</code> という名前のAレコード: <code>a_hoge</code></li></ul><p>また、zone_idやルートドメイン名は何度か記述することになるので、local変数に定義しておくとミスが減ります。</p><figure class="highlight sh"><figcaption><span>local.tf</span></figcaption><table><tr><td class="code"><pre><span class="line">locals &#123;</span><br><span class="line">  zone_id = <span class="string">&quot;ゾーンID&quot;</span></span><br><span class="line">  root_domain = <span class="string">&quot;920oj.net&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight sh"><figcaption><span>record.tf</span></figcaption><table><tr><td class="code"><pre><span class="line">resource <span class="string">&quot;cloudflare_record&quot;</span> <span class="string">&quot;cname_root&quot;</span> &#123;</span><br><span class="line">  name    = local.root_domain</span><br><span class="line">  proxied = <span class="literal">true</span></span><br><span class="line">  ttl     = 1</span><br><span class="line">  <span class="built_in">type</span>    = <span class="string">&quot;CNAME&quot;</span></span><br><span class="line">  value   = <span class="string">&quot;920oj-net.pages.dev&quot;</span></span><br><span class="line">  zone_id = local.zone_id</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...以下略</span><br></pre></td></tr></table></figure><h4 id="import"><a href="#import" class="headerlink" title="import"></a>import</h4><p>このままでは新規追加した分がそのまま新規として認識されてしまうので、すでに作成されているリソースについてはimportしてtfstateへ反映させる必要があります。</p><p>importするためのコマンドはcf-terraformingを利用して出力することができます。ただし今回はリソース名をわかりやすく変更したため、コマンドを修正します。</p><p>まずはcf-terraformingを利用してコマンドを出力してみましょう。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"> % cf-terraforming import --resource-type &quot;cloudflare_record&quot; --zone &quot;ゾーンID&quot;</span><br><span class="line">terraform import cloudflare_record.terraform_managed_resource_xxxxxxxxxx ゾーンID/xxxxxxxxxx</span><br><span class="line">terraform import cloudflare_record.terraform_managed_resource_yyyyyyyyyy ゾーンID/yyyyyyyyyy</span><br></pre></td></tr></table></figure><p>出力されたコマンドをもとに、リソース名を変更した上で、シェルスクリプトファイルとして保存します。</p><figure class="highlight bash"><figcaption><span>import.sh</span></figcaption><table><tr><td class="code"><pre><span class="line">terraform import cloudflare_record.terraform_managed_resource_cname_root ゾーンID/xxxxxxxxxx</span><br><span class="line">terraform import cloudflare_record.terraform_managed_resource_mx_root ゾーンID/yyyyyyyyyy</span><br></pre></td></tr></table></figure><p>これを実行してみましょう。 Import successful! と表示されれば、インポート完了です。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"> % ./import.sh                  </span><br><span class="line">cloudflare_record.cname_root: Importing from ID <span class="string">&quot;ゾーンID/xxxxxxxxxx&quot;</span>...</span><br><span class="line">cloudflare_record.cname_root: Import prepared!</span><br><span class="line">  Prepared cloudflare_record <span class="keyword">for</span> import</span><br><span class="line">cloudflare_record.cname_root: Refreshing state... [<span class="built_in">id</span>=xxxxxxxxxxxxxxxxxxxxxx]</span><br><span class="line"></span><br><span class="line">・・・中略・・・</span><br><span class="line"></span><br><span class="line">Import successful!</span><br><span class="line"></span><br><span class="line">The resources that were imported are shown above. These resources are now <span class="keyword">in</span></span><br><span class="line">your Terraform state and will henceforth be managed by Terraform.</span><br></pre></td></tr></table></figure><p>ここで <code>terraform plan</code> を実行してみましょう。先ほどimportしたものが表示され、最後にNo chanegsと表示されれば、無事反映に成功しています。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"> % terraform plan</span><br><span class="line">cloudflare_record.cname_root: Refreshing state... [<span class="built_in">id</span>=xxxxxxxxxxxxxxxxxxxxxx]</span><br><span class="line">cloudflare_record.mx_root: Refreshing state... [<span class="built_in">id</span>=xxxxxxxxxxxxxxxxxxxxxx]</span><br><span class="line">・・・中略・・・</span><br><span class="line"></span><br><span class="line">No changes. Your infrastructure matches the configuration.</span><br><span class="line"></span><br><span class="line">Terraform has compared your real infrastructure against your configuration and found no differences, so no changes are needed.</span><br></pre></td></tr></table></figure><h3 id="Cloudflare-Pagesのimport"><a href="#Cloudflare-Pagesのimport" class="headerlink" title="Cloudflare Pagesのimport"></a>Cloudflare Pagesのimport</h3><p>続いてはCloudflare PagesをTerraform管理下となるよう設定します。</p><p>Pagesはドメイン（ゾーン）単位でなくアカウント単位での管理となるため、先ほどunsetした <code>CLOUDFLARE_ACCOUNT_ID</code> を再セットします。</p><p>また、Cloudflare Pagesはcf-terraformingが対応していないため、Terraform v1.5から追加されたImportブロックを利用してインポートします。</p><h4 id="importブロックの作成"><a href="#importブロックの作成" class="headerlink" title="importブロックの作成"></a>importブロックの作成</h4><p>自分の場合、 <code>920oj.net</code> のドメインで、プロジェクト <code>920oj-net</code> を設定しています。これをインポートしてみましょう。</p><img src="/images/20240327a/image_15.png" alt="image.png" width="873" height="200" loading="lazy"><p>Cloudflare Pagesは、 <code>cloudflare_pages_domain</code> リソースと <code>cloudflarepages_project</code> リソースから構築されます。</p><p>まずは <code>import.tf</code> を作成し、importブロックを記載します。 <code>local.account_id</code> でアカウントIDが呼び出せるようにしています。</p><p><code>cloudflare_pages_domain</code> のインポートでは、<code>to</code> にはimportする対象のリソース名を、 <code>id</code> には <code>&lt;アカウントID&gt;/&lt;プロジェクト名&gt;/&lt;設定しているドメイン名&gt;</code> を記載します。</p><p><code>cloudflare_pages_project</code> のインポートでは、 <code>to</code> にはimportする対象のリソース名を、 <code>id</code> には <code>&lt;アカウントID&gt;/&lt;プロジェクト名&gt;</code> を記載します。</p><figure class="highlight sh"><figcaption><span>import.tf</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment"># cloudflare_pages_domain のインポート</span></span><br><span class="line">import &#123;</span><br><span class="line">  to = cloudflare_pages_domain.domain-920oj-net  <span class="comment"># 対象のリソース名</span></span><br><span class="line">  <span class="built_in">id</span> = <span class="string">&quot;<span class="variable">$&#123;local.account_id&#125;</span>/920oj-net/920oj.net&quot;</span> <span class="comment"># ドメイン名</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># cloudflare_pages_project のインポート</span></span><br><span class="line">import &#123;</span><br><span class="line">  to = cloudflare_pages_project.project-920oj-net <span class="comment"># 対象のリソース名</span></span><br><span class="line">  <span class="built_in">id</span> = <span class="string">&quot;<span class="variable">$&#123;local.account_id&#125;</span>/920oj-net&quot;</span>            <span class="comment"># プロジェクト名</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="HCLコードの自動生成"><a href="#HCLコードの自動生成" class="headerlink" title="HCLコードの自動生成"></a>HCLコードの自動生成</h4><p>この状態で <code>terraform plan -generate-config-out=generate.tf</code> コマンドを実行します。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">% terraform plan -generate-config-out=generate.tf</span><br><span class="line">cloudflare_pages_domain.domain-920oj-net: Preparing import... [<span class="built_in">id</span>=xxxxxxxxxxxxxxx/920oj-net/920oj.net]</span><br><span class="line">cloudflare_pages_project.project-920oj-net: Preparing import... [<span class="built_in">id</span>=xxxxxxxxxxxxxxx/920oj-net]</span><br><span class="line">cloudflare_pages_domain.domain-920oj-net: Refreshing state... [<span class="built_in">id</span>=xxxxxxxxxxxxxxxxxxxxx]</span><br><span class="line">cloudflare_pages_project.project-920oj-net: Refreshing state... [<span class="built_in">id</span>=920oj-net]</span><br><span class="line"></span><br><span class="line">Terraform will perform the following actions:</span><br><span class="line"></span><br><span class="line">  <span class="comment"># cloudflare_pages_domain.domain-920oj-net will be imported</span></span><br><span class="line">    resource <span class="string">&quot;cloudflare_pages_domain&quot;</span> <span class="string">&quot;domain-920oj-net&quot;</span> &#123;</span><br><span class="line">        account_id   = <span class="string">&quot;xxxxxxxxxxxxxxxxxxxxxxx&quot;</span></span><br><span class="line">        domain       = <span class="string">&quot;920oj.net&quot;</span></span><br><span class="line">        <span class="built_in">id</span>           = <span class="string">&quot;xxxxxxxxxxxxxxxxxxxxxxx&quot;</span></span><br><span class="line">        project_name = <span class="string">&quot;920oj-net&quot;</span></span><br><span class="line">        status       = <span class="string">&quot;active&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># cloudflare_pages_project.project-920oj-net will be imported</span></span><br><span class="line">  <span class="comment"># (config will be generated)</span></span><br><span class="line">    resource <span class="string">&quot;cloudflare_pages_project&quot;</span> <span class="string">&quot;project-920oj-net&quot;</span> &#123;</span><br><span class="line">        account_id        = <span class="string">&quot;xxxxxxxxxxxxxxxxxxxxxxx&quot;</span></span><br><span class="line">        created_on        = <span class="string">&quot;2023-03-18T15:44:28Z&quot;</span></span><br><span class="line">        domains           = [</span><br><span class="line">            <span class="string">&quot;920oj-net.pages.dev&quot;</span>,</span><br><span class="line">            <span class="string">&quot;920oj.net&quot;</span>,</span><br><span class="line">        ]</span><br><span class="line">        <span class="built_in">id</span>                = <span class="string">&quot;920oj-net&quot;</span></span><br><span class="line">        name              = <span class="string">&quot;920oj-net&quot;</span></span><br><span class="line">        production_branch = <span class="string">&quot;main&quot;</span></span><br><span class="line">        subdomain         = <span class="string">&quot;920oj-net.pages.dev&quot;</span></span><br><span class="line"></span><br><span class="line">        build_config &#123;</span><br><span class="line">            build_caching   = <span class="literal">false</span></span><br><span class="line">            build_command   = <span class="string">&quot;npm run build&quot;</span></span><br><span class="line">            destination_dir = <span class="string">&quot;build&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">・・・中略</span><br><span class="line"></span><br><span class="line">Plan: 2 to import, 0 to add, 0 to change, 0 to destroy.</span><br></pre></td></tr></table></figure><p>設定値が読み取られ、出力されています。また、指定したファイル <code>generate.tf</code> に同様の設定値が記載されています！</p><p>内容が正しいか確認するのと、コメントを消したり、local変数に置き換えたりして体裁を整えましょう。また、ファイルもリソースごとに分けておきましょう。</p><figure class="highlight sh"><figcaption><span>pages_domain.tf</span></figcaption><table><tr><td class="code"><pre><span class="line">resource <span class="string">&quot;cloudflare_pages_domain&quot;</span> <span class="string">&quot;domain-920oj-net&quot;</span> &#123;</span><br><span class="line">  account_id   = local.account_id</span><br><span class="line">  domain       = <span class="string">&quot;920oj.net&quot;</span></span><br><span class="line">  project_name = <span class="string">&quot;920oj-net&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight sh"><figcaption><span>generate.tf</span></figcaption><table><tr><td class="code"><pre><span class="line">resource <span class="string">&quot;cloudflare_pages_project&quot;</span> <span class="string">&quot;project-920oj-net&quot;</span> &#123;</span><br><span class="line">  account_id        = local.account_id</span><br><span class="line">  name              = local.project_name</span><br><span class="line">  production_branch = <span class="string">&quot;main&quot;</span></span><br><span class="line">  build_config &#123;</span><br><span class="line">    build_caching       = <span class="literal">false</span></span><br><span class="line">    build_command       = <span class="string">&quot;npm run build&quot;</span></span><br><span class="line">    destination_dir     = <span class="string">&quot;build&quot;</span></span><br><span class="line">    root_dir            = null</span><br><span class="line">    web_analytics_tag   = null</span><br><span class="line">    web_analytics_token = null</span><br><span class="line">  &#125;</span><br><span class="line">  deployment_configs &#123;</span><br><span class="line">    preview &#123;</span><br><span class="line">      always_use_latest_compatibility_date = <span class="literal">false</span></span><br><span class="line">      compatibility_date                   = <span class="string">&quot;2023-03-18&quot;</span></span><br><span class="line">      compatibility_flags                  = []</span><br><span class="line">      d1_databases                         = &#123;&#125;</span><br><span class="line">      durable_object_namespaces            = &#123;&#125;</span><br><span class="line">      environment_variables = &#123;</span><br><span class="line">        GTAG_ID      = <span class="string">&quot;XXXXXXX&quot;</span></span><br><span class="line">        NODE_VERSION = <span class="string">&quot;XXXXXXX&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">      fail_open     = <span class="literal">true</span></span><br><span class="line">      kv_namespaces = &#123;&#125;</span><br><span class="line">      r2_buckets    = &#123;&#125;</span><br><span class="line">      secrets       = null <span class="comment"># sensitive</span></span><br><span class="line">      usage_model   = <span class="string">&quot;standard&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    production &#123;</span><br><span class="line">      always_use_latest_compatibility_date = <span class="literal">false</span></span><br><span class="line">      compatibility_date                   = <span class="string">&quot;2023-03-18&quot;</span></span><br><span class="line">      compatibility_flags                  = []</span><br><span class="line">      d1_databases                         = &#123;&#125;</span><br><span class="line">      durable_object_namespaces            = &#123;&#125;</span><br><span class="line">      environment_variables = &#123;</span><br><span class="line">        GTAG_ID      = <span class="string">&quot;XXXXXXXXXX&quot;</span></span><br><span class="line">        NODE_VERSION = <span class="string">&quot;XXXXXXXXXX&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">      fail_open     = <span class="literal">true</span></span><br><span class="line">      kv_namespaces = &#123;&#125;</span><br><span class="line">      r2_buckets    = &#123;&#125;</span><br><span class="line">      secrets       = null <span class="comment"># sensitive</span></span><br><span class="line">      usage_model   = <span class="string">&quot;standard&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">source</span> &#123;</span><br><span class="line">    <span class="built_in">type</span> = <span class="string">&quot;github&quot;</span></span><br><span class="line">    config &#123;</span><br><span class="line">      deployments_enabled           = <span class="literal">true</span></span><br><span class="line">      owner                         = <span class="string">&quot;920oj&quot;</span></span><br><span class="line">      pr_comments_enabled           = <span class="literal">true</span></span><br><span class="line">      preview_branch_excludes       = []</span><br><span class="line">      preview_branch_includes       = [<span class="string">&quot;*&quot;</span>]</span><br><span class="line">      preview_deployment_setting    = <span class="string">&quot;all&quot;</span></span><br><span class="line">      production_branch             = <span class="string">&quot;main&quot;</span></span><br><span class="line">      production_deployment_enabled = <span class="literal">true</span></span><br><span class="line">      repo_name                     = <span class="string">&quot;920oj-net&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="importの実行"><a href="#importの実行" class="headerlink" title="importの実行"></a>importの実行</h4><p>コードの記載は済んだので、tfstateへ取り込みましょう。</p><p>先ほどのimportブロックは残したままで、 <code>terraform plan</code> を実行します。 <code>Plan: 2 to import, 0 to add, 0 to change, 0 to destroy.</code> が出ていれば、インポートの準備ができていることがわかります。</p><p>次に、 <code>terraform apply</code> を実行します。差分がないことを確認して、yesとタイプしましょう。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">Plan: 2 to import, 0 to add, 0 to change, 0 to destroy.</span><br><span class="line"></span><br><span class="line">Do you want to perform these actions?</span><br><span class="line">  Terraform will perform the actions described above.</span><br><span class="line">  Only <span class="string">&#x27;yes&#x27;</span> will be accepted to approve.</span><br><span class="line"></span><br><span class="line">  Enter a value: <span class="built_in">yes</span></span><br></pre></td></tr></table></figure><p><code>Apply complete! Resources: 2 imported, 0 added, 0 changed, 0 destroyed.</code> が出たらOKです。</p><p>このあと <code>terraform plan</code> を実行してみて、差分が出ていなければ問題なしです。</p><p>先ほどインポートに利用したimport.tfは削除しても構いません。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"> % terraform plan</span><br><span class="line">cloudflare_pages_domain.domain-920oj-net: Refreshing state... [<span class="built_in">id</span>=xxxxxxxxxx]</span><br><span class="line">cloudflare_pages_project.project-920oj-net: Refreshing state... [<span class="built_in">id</span>=xxxxxxxxxx]</span><br><span class="line"></span><br><span class="line">No changes. Your infrastructure matches the configuration.</span><br><span class="line"></span><br><span class="line">Terraform has compared your real infrastructure against your configuration and found no differences, so no changes are needed.</span><br></pre></td></tr></table></figure><p>これにて、Cloudflareで管理しているドメインのDNSレコードとCloudflare Pagesのリソースを、Terraformにて管理できるようになりました！</p><h2 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h2><p>これでCloudflareを操作する際の不安が軽減できるようになり、自分の個人開発モチベも（わずかながら）高まった気がします。また、Terraformのエコシステムや本体の機能の充実さも改めて実感しました。</p><p>ぜひ皆さんもCloudflareをTerraform管理してみましょう！</p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot; title=&quot;はじめに&quot;&gt;&lt;/a&gt;はじめに&lt;/h2&gt;&lt;p&gt;この記事は、&lt;a</summary>
        
      
    
    
    
    <category term="Infrastructure" scheme="https://future-architect.github.io/categories/Infrastructure/"/>
    
    
    <category term="IaC" scheme="https://future-architect.github.io/tags/IaC/"/>
    
    <category term="Terraform" scheme="https://future-architect.github.io/tags/Terraform/"/>
    
    <category term="Cloudflare" scheme="https://future-architect.github.io/tags/Cloudflare/"/>
    
  </entry>
  
  <entry>
    <title>言語処理学会 (NLP2024) でポスター発表を行いました</title>
    <link href="https://future-architect.github.io/articles/20240326b/"/>
    <id>https://future-architect.github.io/articles/20240326b/</id>
    <published>2024-03-25T15:00:01.000Z</published>
    <updated>2024-03-28T03:47:12.864Z</updated>
    
    <content type="html"><![CDATA[<h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>みなさんこんにちは！フューチャー株式会社の岸波と申します。学生時代は自然言語処理、特に雑談対話システムの研究をしておりました。フューチャー入社後はStrategic AI Group (SAIG) の一員として、主に自然言語処理に関する研究開発や社会実装に取り組んでいます。</p><p>先日、<a href="https://www.anlp.jp/nlp2024/">言語処理学会第30回年次大会 (NLP2024)</a> に参加し、当社で取り組んだ研究内容についてポスター発表を行いました。</p><p>言語処理学会は自然言語処理分野における国内最大の学会で、ChatGPTをはじめとする大規模言語モデルが大きな注目を集めていることもあり、今年は参加者数・発表論文数が過去最多となりました。</p><p>当社はプラチナスポンサーとして参加し、スポンサーブースも出展しました。学会全体を通しての参加報告については<a href="/articles/20240328a/">言語処理学会 (NLP2024) 参加報告 </a>にまとめていますのでぜひお読みください！</p><p>このブログでは、主にポスター発表を行った研究の内容と、当日の発表の様子についてご紹介できればと思います。</p><h2 id="発表内容"><a href="#発表内容" class="headerlink" title="発表内容"></a>発表内容</h2><p>今回私たちは「<a href="https://www.anlp.jp/proceedings/annual_meeting/2024/pdf_dir/P10-13.pdf">機密情報検知における生成AIを用いたデータ拡張</a>」というタイトルで発表を行いました。研究の概要としては、文章中から機密情報 (この研究では企業名) を検知するタスクにおいて、生成AIを用いて事実性に捉われない多様なデータ拡張を行うことで、企業名の検知精度が大幅に向上したというものです。</p><p>日々新しい企業が誕生したり、既に存在する企業が新しい事業を展開したりと、企業に関する事実というのは永続的に増えていくものです。そのため、そのような新たに発生した事実に関しても、機密情報は機密情報として検知される必要があります。そこで、機密情報検知モデルを学習するためのデータは現時点で事実として正しいものに限定すべきではないのではないか、というアイディアのもと、事実性に捉われないデータ拡張手法を提案しました。</p><p>具体的には、ある企業名を含むような文脈を生成AIを用いて増やす手法、架空の企業名を生成AIを用いて増やす手法の二つを提案しています。生成AIが事実に反する内容を生成してしまう現象、いわゆるハルシネーションを逆手に取った手法です。</p><p>これらの手法でデータを拡張し、拡張したデータセットで機密情報検知モデルを学習した結果、企業名検知タスクのF1スコアが最大2.5%向上する結果が得られました。</p><p>発表資料はこちらです。</p><img src="/images/20240326b/poster0001-1.jpg" alt="機密情報検知における生成AIを用いたデータ拡張の概要、背景、本研究のアイデア、提案手法、実験" width="1200" height="1697" loading="lazy"><p>この研究で特に面白いと思っているポイントは以下の二つです。</p><p>一つは幅広い応用の可能性があることです。今回は企業名の検知に着目しましたが、提案している事実性に捉われないデータ拡張は、他の機密情報 (例えば人名など) のデータ拡張にも簡単に適用することができます。また、同様の考え方で文書分類や機械翻訳など、他の自然言語処理タスクにも応用できるかもしれません。</p><p>そしてもう一つは、人間が行うには少し難しいデータ拡張を生成AIを用いて行える可能性を示している点です。例えば「ユートピア食品」などの架空の企業名を考えるのは、数十個程度なら頑張ればできるかもしれないですが、数百・数千と大量にリストアップすることは人間には少し難しい作業です。それを生成AIを用いて行うことで、低コストでデータを拡張できるのは嬉しい話です。さらにこういったデータが実際に精度向上にも寄与するという点も面白いと感じています。</p><h2 id="当日の様子"><a href="#当日の様子" class="headerlink" title="当日の様子"></a>当日の様子</h2><p>ありがたいことに発表当日は多くの方にポスター会場へ足を運んでいただき、コメント・アドバイスをいただくことができました。以下はいただいたコメントの抜粋ですが、この他にも今後の研究に繋がるコメントを多数いただくことができ、大変有意義な時間でした。</p><ul><li>今までにない新しい考え方のデータ拡張だと感じた。それでいて性能も上がっており今後の可能性を感じた</li><li>他のデータ拡張手法との組み合わせや、拡張するデータ量の観点での分析ができそう</li><li>今回は企業名に着目しているが、同じ固有表現でも文脈に応じて機密情報ではなくなるケースや、そもそも固有表現ではない機密情報もあると思う。今後企業名以外に拡張していくうえで色々な展開がありそうだと感じた</li></ul><img src="/images/20240326b/1000018486.jpg" alt="1000018486.jpg" width="1200" height="836" loading="lazy"><img src="/images/20240326b/1000018487.jpg" alt="1000018487.jpg" width="1200" height="1079" loading="lazy"><h2 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h2><p>フューチャーに入社してからは初めての言語処理学会参加でしたが、発表を通じて産学問わず様々な方々と交流することができ、今後のモチベーションにもつながる良い機会となりました。</p><p>生成AIのハルシネーションという一見課題として挙げられがちな特徴を逆手に取り、データ拡張に活用することが効果的だったのは非常に興味深く、今回の発表を通して新しい発想の生成AIの活用方法を提示できたかなと思います。</p><p>生成AIを筆頭に様々な業界で自然言語処理の需要が高まっていることもあり、フューチャーでも自然言語処理に関する研究開発・社会実装に力を入れています。そんな中で、今回の言語処理学会での発表を通してフューチャーの自然言語処理に関する取り組みを多くの方々に知っていただくことができて良かったです。</p><p>今後も継続的に発表していけるよう、引き続き研究開発などに取り組んでいければと思います。</p><p>最後に、SAIGでは自然言語処理の実社会応用を推進していくために、NLPリサーチエンジニア、NLPエンジニアを募集しています！<br>ご興味のある方、ぜひSAIGで一緒に働きましょう！</p><p>新卒採用 : <a href="https://www.future.co.jp/recruit/recruit/rec-fresh/">https://www.future.co.jp/recruit/recruit/rec-fresh/</a><br>キャリア採用 : <a href="https://www.future.co.jp/recruit/recruit/rec-career/">https://www.future.co.jp/recruit/recruit/rec-career/</a></p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot;</summary>
        
      
    
    
    
    <category term="DataScience" scheme="https://future-architect.github.io/categories/DataScience/"/>
    
    
    <category term="機械学習" scheme="https://future-architect.github.io/tags/%E6%A9%9F%E6%A2%B0%E5%AD%A6%E7%BF%92/"/>
    
    <category term="NLP" scheme="https://future-architect.github.io/tags/NLP/"/>
    
    <category term="学会" scheme="https://future-architect.github.io/tags/%E5%AD%A6%E4%BC%9A/"/>
    
    <category term="LLM" scheme="https://future-architect.github.io/tags/LLM/"/>
    
    <category term="固有表現抽出" scheme="https://future-architect.github.io/tags/%E5%9B%BA%E6%9C%89%E8%A1%A8%E7%8F%BE%E6%8A%BD%E5%87%BA/"/>
    
    <category term="NLP2024" scheme="https://future-architect.github.io/tags/NLP2024/"/>
    
  </entry>
  
  <entry>
    <title>Terraformの実装コードを、動かしながら読む</title>
    <link href="https://future-architect.github.io/articles/20240326a/"/>
    <id>https://future-architect.github.io/articles/20240326a/</id>
    <published>2024-03-25T15:00:00.000Z</published>
    <updated>2024-03-26T00:49:16.622Z</updated>
    
    <content type="html"><![CDATA[<img src="/images/20240326a/top.png" alt="" width="800" height="539"><p><a href="/articles/20240311a/">Terraform連載2024</a> の10本目記事です。</p><h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>こんにちは。CSIG（Cyber Security Innovation Group）の棚井です。</p><p>Terraform 連載ということで</p><ul><li>そういえば、実装コードは Go で書かれていたな</li><li>コマンドの使い方はインフラエンジニアの皆様が書いてくれるはずなので、コードリーディングしようかな</li></ul><p>との考えに至り、ソースコードリーディング自体をブログ化しました。<br>参考になる点が1つでもあれば幸いです。</p><h1 id="エディタの準備"><a href="#エディタの準備" class="headerlink" title="エディタの準備"></a>エディタの準備</h1><p>今回のコードリーディングでは VSCode を利用します。</p><p>Go のコードジャンプやテスト実行のため、以下の拡張機能を追加します。</p><ul><li><a href="https://marketplace.visualstudio.com/items?itemName=golang.go">Go</a></li><li><a href="https://marketplace.visualstudio.com/items?itemName=766b.go-outliner">Go Outliner</a></li><li><a href="https://marketplace.visualstudio.com/items?itemName=premparihar.gotestexplorer">Go Test Explorer</a></li></ul><p>また、コードリーディングのお供として「GitHub Copilot」も追加します。<br>GitHub アカウントで Copilot を有効化する方法や、VSCode の拡張機能とリンクする方法については、ネット上に多数情報がありますのでそちらをご参照ください。（ex. <a href="https://docs.github.com/ja/copilot">GitHub Copilot のドキュメント</a>）</p><ul><li><a href="https://marketplace.visualstudio.com/items?itemName=GitHub.copilot">GitHub Copilot</a></li><li><a href="https://marketplace.visualstudio.com/items?itemName=GitHub.copilot-chat">GitHub Copilot Chat</a></li></ul><p>「コードリーディングで生成系AIを使うの？」という疑問を持たれた方向けへの回答として、GitHub Copilotには「コード生成機能」以外に、「コードの説明機能」があります。</p><p>使い方としては、</p><ol><li>解説して欲しいコードをハイライトする</li><li><code>Ctrl + i</code> によりCopilotのポップアップを表示する</li><li><code>/explain</code>を入力する</li></ol><p>の3ステップで利用可能です。</p><p>VSCodeで表示されている実コードベースで解説してくれますので、途中に詰まる部分があったとしても、Copilotのサポートにより大抵は独力で解決可能です。OSSのコードリーディングでは、まさにこの解説機能が非常に便利だと感じています。</p><h1 id="実行環境の準備"><a href="#実行環境の準備" class="headerlink" title="実行環境の準備"></a>実行環境の準備</h1><p>コードリーディング中には「実際に動かしてみないと、イメージがつきにくい処理」が見つかります。いざという時にローカル環境で動かせるように、Terraformのビルド、動作検証が可能な環境を準備します。</p><p>ソースコードはこちらの <a href="https://github.com/hashicorp/terraform/tree/main">hashicorp&#x2F;terraform</a> リポジトリに公開されています。<br>Goのバージョンを確認したところ、トップディレクトリ配下の <a href="https://github.com/hashicorp/terraform/blob/main/.go-version"><code>.go-version</code></a> に <code>1.22.1</code>（執筆時点）と記載されていることを確認しました。</p><p>執筆時点での <a href="https://go.dev/dl/">Go All releases</a> も <code>1.22.1</code> なので、最新のGoバージョンに対応していることが分かります。</p><blockquote><p>&#x3D;&#x3D; 宣伝 &#x3D;&#x3D;<br>FutureではGoリリース連載を実施しております。<br><a href="https://future-architect.github.io/articles/20240129a/">Go 1.22リリース連載始まります</a><br><a href="https://future-architect.github.io/articles/20240307a/">Goリリースノートから技術ブログを書く流れ基礎</a></p></blockquote><p>リポジトリ側でGoのバージョンが指定されているので、ローカル環境もそれに合わせて構築します。</p><p>ちなみに、私は <a href="https://asdf-vm.com/">asdf</a> を利用して開発言語のバージョン管理を行っています。asdf の利用方法は、左記の公式ドキュメント、および、こちらの解説記事（<a href="https://qiita.com/RuyPKG/items/d4ea8baab1e0a17ae927">asdf で開発言語と利用ツールのバージョン管理</a>）をご覧ください。</p><p><code>$ go version</code> 実行時に、<code>1.22.1</code> が表示されていれば、実行環境の準備は完了です。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ go version</span><br><span class="line">go version go1.22.1 linux/amd64</span><br></pre></td></tr></table></figure><h1 id="リポジトリの取得、テスト実行"><a href="#リポジトリの取得、テスト実行" class="headerlink" title="リポジトリの取得、テスト実行"></a>リポジトリの取得、テスト実行</h1><p>それではさっそく、Terraform のソースコードを取得していきます。<br>といっても、ここでは <a href="https://github.com/hashicorp/terraform/tree/main">hashicorp&#x2F;terraform</a> リポジトリをクローンするだけです。</p><p>クローンに成功したら、まずはテストに通過するかを確認します。</p><details><summary>テスト実行ログ</summary><div><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> terraform/</span><br><span class="line"></span><br><span class="line">$ go <span class="built_in">test</span> ./...</span><br><span class="line">?       github.com/hashicorp/terraform/internal/backend [no <span class="built_in">test</span> files]</span><br><span class="line">ok      github.com/hashicorp/terraform  0.065s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/addrs   0.030s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/backend/backendbase     0.007s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/backend/backendrun      0.009s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/backend/init    0.051s</span><br><span class="line">?       github.com/hashicorp/terraform/internal/cloudplugin/cloudproto1 [no <span class="built_in">test</span> files]</span><br><span class="line">?       github.com/hashicorp/terraform/internal/cloudplugin/mock_cloudproto1    [no <span class="built_in">test</span> files]</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/backend/local   6.211s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/backend/remote  4.009s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/backend/remote-state/http       7.266s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/backend/remote-state/inmem      0.010s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/builtin/providers/terraform     0.150s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/builtin/provisioners/file       0.008s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/builtin/provisioners/local-exec 0.196s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/builtin/provisioners/remote-exec        2.050s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/checks  0.060s</span><br><span class="line">?       github.com/hashicorp/terraform/internal/command/jsonformat/collections  [no <span class="built_in">test</span> files]</span><br><span class="line">?       github.com/hashicorp/terraform/internal/command/jsonformat/computed     [no <span class="built_in">test</span> files]</span><br><span class="line">?       github.com/hashicorp/terraform/internal/command/jsonformat/jsondiff     [no <span class="built_in">test</span> files]</span><br><span class="line">?       github.com/hashicorp/terraform/internal/command/jsonformat/structured   [no <span class="built_in">test</span> files]</span><br><span class="line">?       github.com/hashicorp/terraform/internal/command/testing [no <span class="built_in">test</span> files]</span><br><span class="line">?       github.com/hashicorp/terraform/internal/e2e     [no <span class="built_in">test</span> files]</span><br><span class="line">?       github.com/hashicorp/terraform/internal/experiments     [no <span class="built_in">test</span> files]</span><br><span class="line">?       github.com/hashicorp/terraform/internal/getmodules      [no <span class="built_in">test</span> files]</span><br><span class="line">?       github.com/hashicorp/terraform/internal/grpcwrap        [no <span class="built_in">test</span> files]</span><br><span class="line">?       github.com/hashicorp/terraform/internal/lang/langrefs   [no <span class="built_in">test</span> files]</span><br><span class="line">?       github.com/hashicorp/terraform/internal/lang/marks      [no <span class="built_in">test</span> files]</span><br><span class="line">?       github.com/hashicorp/terraform/internal/lang/types      [no <span class="built_in">test</span> files]</span><br><span class="line">?       github.com/hashicorp/terraform/internal/modsdir [no <span class="built_in">test</span> files]</span><br><span class="line">?       github.com/hashicorp/terraform/internal/plans/planproto [no <span class="built_in">test</span> files]</span><br><span class="line">?       github.com/hashicorp/terraform/internal/plugin/mock_proto       [no <span class="built_in">test</span> files]</span><br><span class="line">?       github.com/hashicorp/terraform/internal/plugin6/mock_proto      [no <span class="built_in">test</span> files]</span><br><span class="line">?       github.com/hashicorp/terraform/internal/provider-simple [no <span class="built_in">test</span> files]</span><br><span class="line">?       github.com/hashicorp/terraform/internal/provider-simple/main    [no <span class="built_in">test</span> files]</span><br><span class="line">?       github.com/hashicorp/terraform/internal/provider-simple-v6      [no <span class="built_in">test</span> files]</span><br><span class="line">?       github.com/hashicorp/terraform/internal/provider-simple-v6/main [no <span class="built_in">test</span> files]</span><br><span class="line">?       github.com/hashicorp/terraform/internal/provider-terraform/main [no <span class="built_in">test</span> files]</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/cloud   36.011s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/cloud/cloudplan 0.111s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/cloud/e2e       8.538s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/cloudplugin     0.239s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/cloudplugin/cloudplugin1        0.029s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/collections     0.013s</span><br><span class="line">?       github.com/hashicorp/terraform/internal/providers/testing       [no <span class="built_in">test</span> files]</span><br><span class="line">?       github.com/hashicorp/terraform/internal/provisioner-local-exec/main     [no <span class="built_in">test</span> files]</span><br><span class="line">?       github.com/hashicorp/terraform/internal/provisioners    [no <span class="built_in">test</span> files]</span><br><span class="line">?       github.com/hashicorp/terraform/internal/registry/test   [no <span class="built_in">test</span> files]</span><br><span class="line">?       github.com/hashicorp/terraform/internal/replacefile     [no <span class="built_in">test</span> files]</span><br><span class="line">?       github.com/hashicorp/terraform/internal/rpcapi/dynrpcserver     [no <span class="built_in">test</span> files]</span><br><span class="line">?       github.com/hashicorp/terraform/internal/rpcapi/dynrpcserver/generator   [no <span class="built_in">test</span> files]</span><br><span class="line">?       github.com/hashicorp/terraform/internal/rpcapi/terraform1       [no <span class="built_in">test</span> files]</span><br><span class="line">?       github.com/hashicorp/terraform/internal/stacks/stackconfig/stackconfigtypes     [no <span class="built_in">test</span> files]</span><br><span class="line">?       github.com/hashicorp/terraform/internal/stacks/stackconfig/typeexpr     [no <span class="built_in">test</span> files]</span><br><span class="line">?       github.com/hashicorp/terraform/internal/schemarepo/loadschemas  [no <span class="built_in">test</span> files]</span><br><span class="line">?       github.com/hashicorp/terraform/internal/schemarepo      [no <span class="built_in">test</span> files]</span><br><span class="line">?       github.com/hashicorp/terraform/internal/stacks/stackaddrs       [no <span class="built_in">test</span> files]</span><br><span class="line">?       github.com/hashicorp/terraform/internal/stacks/stackruntime/hooks       [no <span class="built_in">test</span> files]</span><br><span class="line">?       github.com/hashicorp/terraform/internal/stacks/stackruntime/testing     [no <span class="built_in">test</span> files]</span><br><span class="line">?       github.com/hashicorp/terraform/internal/stacks/stackutils       [no <span class="built_in">test</span> files]</span><br><span class="line">?       github.com/hashicorp/terraform/internal/tfplugin5       [no <span class="built_in">test</span> files]</span><br><span class="line">?       github.com/hashicorp/terraform/internal/tfplugin6       [no <span class="built_in">test</span> files]</span><br><span class="line">?       github.com/hashicorp/terraform/tools/loggraphdiff       [no <span class="built_in">test</span> files]</span><br><span class="line">?       github.com/hashicorp/terraform/tools/protobuf-compile   [no <span class="built_in">test</span> files]</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/command 88.238s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/command/arguments       0.014s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/command/cliconfig       0.027s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/command/clistate        0.010s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/command/e2etest 30.692s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/command/format  0.010s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/command/jsonchecks      0.009s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/command/jsonconfig      0.013s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/command/jsonformat      0.111s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/command/jsonformat/computed/renderers   0.035s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/command/jsonformat/differ       0.058s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/command/jsonformat/structured/attribute_path    0.014s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/command/jsonfunction    0.019s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/command/jsonplan        0.028s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/command/jsonprovider    0.024s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/command/jsonstate       0.036s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/command/views   3.473s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/command/views/json      0.053s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/command/webbrowser      0.016s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/command/workdir 0.029s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/communicator    1.049s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/communicator/remote     0.010s [no tests to run]</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/communicator/shared     0.005s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/communicator/ssh        3.183s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/communicator/winrm      0.045s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/configs 7.155s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/configs/configload      0.888s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/configs/configschema    0.038s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/configs/configtesting   0.004s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/configs/hcl2shim        0.036s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/copy    0.012s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/dag     2.168s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/depsfile        0.214s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/didyoumean      0.012s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/genconfig       0.051s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/getmodules/moduleaddrs  0.063s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/getproviders    4.428s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/getproviders/providerreqs       0.101s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/helper/slowmessage      0.105s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/httpclient      0.020s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/initwd  0.312s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/instances       0.019s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/ipaddr  0.026s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/lang    0.250s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/lang/blocktoattr        0.016s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/lang/funcs      0.792s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/lang/globalref  0.326s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/logging 0.004s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/moduledeps      0.021s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/moduletest      0.203s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/moduletest/config       0.028s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/moduletest/hcl  0.045s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/moduletest/mocking      0.025s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/namedvals       0.010s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/plans   0.018s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/plans/deferring 0.010s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/plans/objchange 0.115s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/plans/planfile  0.331s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/plugin  0.040s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/plugin/convert  0.027s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/plugin/discovery        0.013s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/plugin6 0.028s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/plugin6/convert 0.022s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/promising       0.041s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/providercache   0.232s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/providers       0.012s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/refactoring     0.261s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/registry        3.826s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/registry/regsrc 0.008s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/registry/response       0.010s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/releaseauth     0.167s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/repl    0.096s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/rpcapi  0.263s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/stacks/stackconfig      0.017s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/stacks/stackplan        0.029s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/stacks/stackruntime     0.484s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/stacks/stackruntime/internal/stackeval  1.489s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/stacks/stackstate       0.022s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/stacks/stackstate/statekeys     0.028s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/stacks/tfstackdata1     0.017s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/states  0.018s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/states/remote   0.032s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/states/statefile        0.070s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/states/statemgr 5.951s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/terminal        0.005s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/terraform       8.988s</span><br><span class="line">ok      github.com/hashicorp/terraform/internal/tfdiags 0.012s</span><br><span class="line">ok      github.com/hashicorp/terraform/version  0.003s</span><br></pre></td></tr></table></figure></div></details><p>テストを実行してみたところ、<code>[no test files]</code> が多数見つかりました。<br>少し気になりますので、テストのカバレッジを見てみます。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ go <span class="built_in">test</span> -cover</span><br><span class="line">Terraform has no <span class="built_in">command</span> named <span class="string">&quot;bar&quot;</span>.</span><br><span class="line"></span><br><span class="line">To see all of Terraform<span class="string">&#x27;s top-level commands, run:</span></span><br><span class="line"><span class="string">  terraform -help</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">PASS</span></span><br><span class="line"><span class="string">coverage: 36.7% of statements</span></span><br><span class="line"><span class="string">ok      github.com/hashicorp/terraform  0.049s</span></span><br></pre></td></tr></table></figure><p>上記ログには</p><blockquote><p>coverage: 36.7% of statements</p></blockquote><p>とありますので、Terraform 実装コードのテストカバレッジ率は <code>36.7%</code> です。<br>数字の是非はさておいて、テストが通過することは確認できました。</p><h1 id="ビルドして動かしてみる"><a href="#ビルドして動かしてみる" class="headerlink" title="ビルドして動かしてみる"></a>ビルドして動かしてみる</h1><p><code>terraform</code> がコマンドの1つである以上、「ビルドして動かせる」はずなので、実際に試してみます。</p><p>Go言語では王道の <a href="https://github.com/hashicorp/terraform/blob/main/Makefile">Makefile</a> を見たところ、<code>go build</code> に相当しそうなコマンドは見つかりません。<br>ただし、いくつかのコマンドが <code>$(CURDIR)/scripts/</code> 配下のシェルスクリプトを参照していますので、当該ディレクトリにお目当てのファイルがないかを確認します。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">ls</span> -l scripts/</span><br><span class="line">total 40</span><br><span class="line">-rwxr-xr-x 1 blog-user blog-user 2853 Mar 25 05:19 build.sh</span><br><span class="line">-rwxr-xr-x 1 blog-user blog-user  958 Mar 24 22:52 changelog-links.sh</span><br><span class="line">-rwxr-xr-x 1 blog-user blog-user  610 Mar 24 22:52 copyright.sh</span><br><span class="line">-rwxr-xr-x 1 blog-user blog-user 1171 Mar 24 22:52 debug-terraform</span><br><span class="line">-rwxr-xr-x 1 blog-user blog-user  344 Mar 24 22:52 exhaustive.sh</span><br><span class="line">-rwxr-xr-x 1 blog-user blog-user  401 Mar 24 22:52 gofmtcheck.sh</span><br><span class="line">-rwxr-xr-x 1 blog-user blog-user  351 Mar 24 22:52 gogetcookie.sh</span><br><span class="line">-rwxr-xr-x 1 blog-user blog-user 2730 Mar 24 22:52 goimportscheck.sh</span><br><span class="line">-rwxr-xr-x 1 blog-user blog-user  666 Mar 24 22:52 staticcheck.sh</span><br><span class="line">-rwxr-xr-x 1 blog-user blog-user 1096 Mar 24 22:52 syncdeps.sh</span><br></pre></td></tr></table></figure><p><code>scripts/</code> 配下に、<a href="https://github.com/hashicorp/terraform/blob/main/scripts/build.sh"><code>build.sh</code></a> というシェルスクリプトが見つかりました。<br>また、VSCode で <code>Ctrl + Shift + f</code> を実行して <code>build.sh</code> を検索すると、<a href="https://github.com/hashicorp/terraform/blob/main/Dockerfile#L23">Dockerfile</a> の中でこのシェルスクリプトが呼ばれていることも確認できます。</p><p>シェル冒頭に以下の記載があり、<code>bash</code> によリコールされた後、1つ上のディレクトリでビルドプロセスを動かしていることが分かります。</p><figure class="highlight sh"><figcaption><span>build.sh</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment"># Get the parent directory of where this script is.</span></span><br><span class="line">SOURCE=<span class="string">&quot;<span class="variable">$&#123;BASH_SOURCE[0]&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">while</span> [ -h <span class="string">&quot;<span class="variable">$SOURCE</span>&quot;</span> ] ; <span class="keyword">do</span> SOURCE=<span class="string">&quot;<span class="subst">$(readlink <span class="string">&quot;<span class="variable">$SOURCE</span>&quot;</span>)</span>&quot;</span>; <span class="keyword">done</span></span><br><span class="line">DIR=<span class="string">&quot;<span class="subst">$( cd -P <span class="string">&quot;<span class="subst">$( dirname <span class="string">&quot;<span class="variable">$SOURCE</span>&quot;</span> )</span>/..&quot;</span> &amp;&amp; pwd )</span>&quot;</span></span><br></pre></td></tr></table></figure><p>上記を踏まえて、さっそくビルドしてみます。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ /usr/bin/bash build.sh</span><br><span class="line">==&gt; Removing old directory...</span><br><span class="line">==&gt; Installing gox...</span><br><span class="line">==&gt; Building...</span><br><span class="line">Number of parallel builds: 11</span><br><span class="line"></span><br><span class="line">--&gt;   solaris/amd64: github.com/hashicorp/terraform</span><br><span class="line">--&gt;   windows/amd64: github.com/hashicorp/terraform</span><br><span class="line">--&gt;     freebsd/arm: github.com/hashicorp/terraform</span><br><span class="line">--&gt;     openbsd/386: github.com/hashicorp/terraform</span><br><span class="line">--&gt;   openbsd/amd64: github.com/hashicorp/terraform</span><br><span class="line">--&gt;       linux/arm: github.com/hashicorp/terraform</span><br><span class="line">--&gt;       linux/386: github.com/hashicorp/terraform</span><br><span class="line">--&gt;     freebsd/386: github.com/hashicorp/terraform</span><br><span class="line">--&gt;     linux/amd64: github.com/hashicorp/terraform</span><br><span class="line">--&gt;   freebsd/amd64: github.com/hashicorp/terraform</span><br><span class="line">--&gt;     windows/386: github.com/hashicorp/terraform</span><br></pre></td></tr></table></figure><p>計11個のビルドプロセスが並列で動いています。</p><p>このまましばらく放置していれば、11環境分すべての <code>terraform</code> 実行バイナリが作成されるのですが、私のPC環境では以下の問題が発生しました。</p><img src="/images/20240326a/disc.png" alt="disc.png" width="544" height="170" loading="lazy"><p>リポジトリからクローンしたソースコード全体と、ビルドで生成した実行バイナリのダブルパンチにより、ローカル PC が悲鳴を上げていました。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">du</span> -h terraform/bin/terraform</span><br><span class="line">119M    terraform</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">du</span> -h terraform/</span><br><span class="line">...</span><br><span class="line">820M    terraform/</span><br></pre></td></tr></table></figure><p>何とかならないか？と <code>build.sh</code> を読み進めたところ、環境変数 <code>TF_DEV</code> に値を設定すれば、ビルド環境だけの実行バイナリを生成してくれるとありました。</p><figure class="highlight sh"><figcaption><span>build.sh</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment"># If its dev mode, only build for ourself</span></span><br><span class="line"><span class="keyword">if</span> [[ -n <span class="string">&quot;<span class="variable">$&#123;TF_DEV&#125;</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    XC_OS=$(go <span class="built_in">env</span> GOOS)</span><br><span class="line">    XC_ARCH=$(go <span class="built_in">env</span> GOARCH)</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><p>また、<code>TF_DEV</code> を設定しない場合には、ビルドした実行バイナリのパッケージ化が行われるとの記載も見つかりました。</p><figure class="highlight sh"><figcaption><span>build.sh</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$&#123;TF_DEV&#125;</span>x&quot;</span> = <span class="string">&quot;x&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="comment"># Zip and copy to the dist dir</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;==&gt; Packaging...&quot;</span></span><br><span class="line">    <span class="keyword">for</span> PLATFORM <span class="keyword">in</span> $(find ./pkg -mindepth 1 -maxdepth 1 -<span class="built_in">type</span> d); <span class="keyword">do</span></span><br><span class="line">        OSARCH=$(<span class="built_in">basename</span> <span class="variable">$&#123;PLATFORM&#125;</span>)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;--&gt; <span class="variable">$&#123;OSARCH&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">pushd</span> <span class="variable">$PLATFORM</span> &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">        zip ../<span class="variable">$&#123;OSARCH&#125;</span>.zip ./*</span><br><span class="line">        <span class="built_in">popd</span> &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><p>今回はローカル環境でのみビルド、動作検証ができれば十分ですので、環境変数 <code>TF_DEV</code> を設定し再ビルドします。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">export</span> TF_DEV=<span class="built_in">yes</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$TF_DEV</span></span><br><span class="line"><span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line">$ go <span class="built_in">env</span> GOOS</span><br><span class="line">linux</span><br><span class="line"></span><br><span class="line">$ go <span class="built_in">env</span> GOARCH</span><br><span class="line">amd64</span><br><span class="line"></span><br><span class="line">$ /usr/bin/bash build.sh</span><br><span class="line">==&gt; Removing old directory...</span><br><span class="line">==&gt; Building...</span><br><span class="line">Number of parallel builds: 11</span><br><span class="line"></span><br><span class="line">--&gt;     linux/amd64: github.com/hashicorp/terraform</span><br><span class="line">==&gt; Creating GOPATH/bin directory...</span><br><span class="line"></span><br><span class="line">==&gt; Results:</span><br><span class="line">total 119M</span><br><span class="line">-rwxr-xr-x 1 blog-user blog-user 119M Mar 25 03:45 terraform</span><br></pre></td></tr></table></figure><p>無事に、<code>linux/amd64</code> 分のビルドに成功しました。<br>実行バイナリは、以下2つのディレクトリに出力されています。</p><ul><li>terraform&#x2F;bin</li><li>GOPATH&#x2F;bin</li></ul><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ ./terraform/bin/terraform version</span><br><span class="line">Terraform v1.9.0-dev</span><br><span class="line">on linux_amd64</span><br></pre></td></tr></table></figure><p>ここまでの操作により、ソースコードのビルドから、コマンドの実行手順まで確認できました。</p><p>続いて、コードに手を加えた場合には、ビルド後のコマンド中身に反映されていることを検証してみます。</p><p>サブコマンドの <code>version</code> が分かりやすいので、以下のログを追加します。<br>（<a href="https://github.com/hashicorp/terraform/blob/main/internal/command/version.go#L81-L84">対応箇所</a>）</p><figure class="highlight go"><figcaption><span>version.go</span></figcaption><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">fmt.Fprintf(&amp;versionString, <span class="string">&quot;Terraform v%s&quot;</span>, c.Version)</span><br><span class="line"><span class="keyword">if</span> c.VersionPrerelease != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line"> fmt.Fprintf(&amp;versionString, <span class="string">&quot;-%s&quot;</span>, c.VersionPrerelease)</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>↓</p><figure class="highlight go"><figcaption><span>version.go</span></figcaption><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">fmt.Println(<span class="string">&quot;バージョン確認コマンドを実行してみた。&quot;</span>) <span class="comment">// 追加</span></span><br><span class="line">fmt.Fprintf(&amp;versionString, <span class="string">&quot;Terraform v%s&quot;</span>, c.Version)</span><br><span class="line"><span class="keyword">if</span> c.VersionPrerelease != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line"> fmt.Fprintf(&amp;versionString, <span class="string">&quot;-%s&quot;</span>, c.VersionPrerelease)</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>この1行が追記された状態で実行バイナリをビルドすると、コマンドのログ出力が増えていることを確認できます。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ /usr/bin/bash ./terraform/scripts/build.sh</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">$ ./terraform/bin/terraform version</span><br><span class="line">バージョン確認コマンドを実行してみた。</span><br><span class="line">Terraform v1.9.0-dev</span><br><span class="line">on linux_amd64</span><br></pre></td></tr></table></figure><h1 id="エントリーポイントから見ていく"><a href="#エントリーポイントから見ていく" class="headerlink" title="エントリーポイントから見ていく"></a>エントリーポイントから見ていく</h1><p>ここまでが事前準備です。<br>さっそく、Terraform の実コードを見ていきます。</p><p>まずはプログラムの始まりとなる「エントリーポイント」を探します。</p><p>Go であれば</p><ul><li>main.go</li><li>func main() {…}</li></ul><p>がプログラムのエントリーポイントです。<br>トップディレクトリ配下の「<a href="https://github.com/hashicorp/terraform/blob/main/main.go#L63-L65">terraform&#x2F;main.go</a>」に以下の記述が見つかりました。</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"> os.Exit(realMain())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>初手、<code>main()</code> の中で <code>realMain()</code>（直訳すると「本当のmain」）を呼び出しているようです。<br>呼び出し先の関数を見ると、今度は defer で <code>logging.PanicHandler()</code> を呼び出しているようなので、この関数の中身を見てみます。</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">realMain</span><span class="params">()</span></span> <span class="type">int</span> &#123;</span><br><span class="line"> <span class="keyword">defer</span> logging.PanicHandler()</span><br><span class="line"> ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>VSCode のコードジャンプが有効となっていれば、Ctrl を押しながら対象関数を左クリックすることにより、関数の定義元にジャンプすることができます。</p><h2 id="PanicHandler"><a href="#PanicHandler" class="headerlink" title="PanicHandler()"></a><code>PanicHandler()</code></h2><p>「<a href="https://github.com/hashicorp/terraform/blob/main/internal/logging/panic.go#L41">PanicHandler()の実装</a>」を見ますと、<strong>TERRAFORM CRASH</strong> という仰々しい言葉が沢山の <code>!</code> で囲まれていることが分かります。<br>通常のインフラ構築、運用保守作業にてこのようなメッセージをお目にかかることは、まずないと思います。私は今回、初めてこんなメッセージが仕込まれていることを知りました。</p><p>メッセージ内容を日本語訳しますと「Terraform が壊れたよ！ 公式リポジトリの issue に記票して」とありますので、さっそく、壊してみます。</p><p>panic 発生時に <strong>TERRAFORM CRASH</strong> が表示されるようなので、エントリーポイントの直後で強制的に panic を起こす1行を入れます。</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">realMain</span><span class="params">()</span></span> <span class="type">int</span> &#123;</span><br><span class="line"> <span class="keyword">defer</span> logging.PanicHandler()</span><br><span class="line"> <span class="built_in">panic</span>(<span class="string">&quot;バルス！&quot;</span>)</span><br><span class="line"> ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>また、<code>terraform</code> のビルド時に渡される <code>GOFLAGS</code> を「<a href="https://github.com/hashicorp/terraform/blob/main/scripts/build.sh#L41-L42">リポジトリのコード</a>」のまま利用した場合、ビルド環境のフルパスが表示されてしまいますので、以下の <code>-trimpath</code> フラグを追加します。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> GOFLAGS=<span class="string">&quot;-mod=readonly&quot;</span></span><br></pre></td></tr></table></figure><p>↓</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> GOFLAGS=<span class="string">&quot;-mod=readonly -trimpath&quot;</span></span><br></pre></td></tr></table></figure><p>この状態でソースコードのビルド、及び、コマンドの実行を試してみます。</p><p>サブコマンドを与えずに <code>terraform</code> を実行した場合、本来ならば <code>help</code> が表示されますが、無事に「壊す」ことができました。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ ./terraform</span><br><span class="line"></span><br><span class="line">!!!!!!!!!!!!!!!!!!!!!!!!!!! TERRAFORM CRASH !!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><br><span class="line"></span><br><span class="line">Terraform crashed! This is always indicative of a bug within Terraform.</span><br><span class="line">Please report the crash with Terraform[1] so that we can fix this.</span><br><span class="line"></span><br><span class="line">When reporting bugs, please include your terraform version, the stack trace</span><br><span class="line">shown below, and any additional information <span class="built_in">which</span> may <span class="built_in">help</span> replicate the issue.</span><br><span class="line"></span><br><span class="line">[1]: https://github.com/hashicorp/terraform/issues</span><br><span class="line"></span><br><span class="line">!!!!!!!!!!!!!!!!!!!!!!!!!!! TERRAFORM CRASH !!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><br><span class="line"></span><br><span class="line">panic: バルス！</span><br><span class="line">goroutine 1 [running]:</span><br><span class="line">runtime/debug.Stack()</span><br><span class="line">        runtime/debug/stack.go:24 +0x5e</span><br><span class="line">github.com/hashicorp/terraform/internal/logging.PanicHandler()</span><br><span class="line">        github.com/hashicorp/terraform/internal/logging/panic.go:84 +0x18b</span><br><span class="line">panic(&#123;0x1ade400?, 0x249fc00?&#125;)</span><br><span class="line">        runtime/panic.go:770 +0x132</span><br><span class="line">main.realMain()</span><br><span class="line">        github.com/hashicorp/terraform/main.go:69 +0x47</span><br><span class="line">main.main()</span><br><span class="line">        github.com/hashicorp/terraform/main.go:64 +0x13</span><br></pre></td></tr></table></figure><p><code>terraform</code> コマンドの実行時、何らかの理由により panic が起きてしまった場合には、<strong>TERRAFORM CRASH</strong> のメッセージ表示と issue の起票催促、デバックトレースが表示されることを確認できました。</p><p>それでは、意図的に仕込んだ panic の1行を削除して、再ビルドまで完了したら、次の処理を見ていきます。</p><h2 id="openTelemetryInit"><a href="#openTelemetryInit" class="headerlink" title="openTelemetryInit()"></a><code>openTelemetryInit()</code></h2><p>次の実装として、Open Telemetry を扱う処理が見つかります。</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> err <span class="type">error</span></span><br><span class="line"></span><br><span class="line">err = openTelemetryInit()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">  <span class="comment">// openTelemetryInit can only fail if Terraform was run with an</span></span><br><span class="line">  <span class="comment">// explicit environment variable to enable telemetry collection,</span></span><br><span class="line">  <span class="comment">// so in typical use we cannot get here.</span></span><br><span class="line">  Ui.Error(fmt.Sprintf(<span class="string">&quot;Could not initialize telemetry: %s&quot;</span>, err)) </span><br><span class="line">  Ui.Error(fmt.Sprintf(<span class="string">&quot;Unset environment variable %s if you don&#x27;t intend to collect telemetry from Terraform.&quot;</span>, openTelemetryExporterEnvVar))</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> ctx context.Context</span><br><span class="line"><span class="keyword">var</span> otelSpan trace.Span</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// At minimum we emit a span covering the entire command execution.</span></span><br><span class="line">  _, displayArgs := shquot.POSIXShellSplit(os.Args)</span><br><span class="line">  ctx, otelSpan = tracer.Start(context.Background(), fmt.Sprintf(<span class="string">&quot;terraform %s&quot;</span>, displayArgs))</span><br><span class="line">  <span class="keyword">defer</span> otelSpan.End()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>openTelemetryInit()</code> の定義元にコードジャンプしますと、トップディレクトリ配下の「<a href="https://github.com/hashicorp/terraform/blob/main/telemetry.go#L56-L63">terraform&#x2F;telemetry.go</a>」にて詳細内容が説明されています。</p><p>まず、実装コードのコメントには以下の記載があります。</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// If this environment variable is set to &quot;otlp&quot; when running Terraform CLI</span></span><br><span class="line"><span class="comment">// then we&#x27;ll enable an experimental OTLP trace exporter.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// BEWARE! This is not a committed external interface.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Everything about this is experimental and subject to change in future</span></span><br><span class="line"><span class="comment">// releases. Do not depend on anything about the structure of this output.</span></span><br><span class="line"><span class="comment">// This mechanism might be removed altogether if a different strategy seems</span></span><br><span class="line"><span class="comment">// better based on experience with this experiment.</span></span><br><span class="line"><span class="keyword">const</span> openTelemetryExporterEnvVar = <span class="string">&quot;OTEL_TRACES_EXPORTER&quot;</span></span><br></pre></td></tr></table></figure><p>Terraform の実行環境にて、環境変数として以下を設定した場合のみ、Open Telemetry 機能が有効となるようです。<br><code>otlp</code> 以外の値（値ナシも含む）が設定された場合には、この機能は有効化されずに関数の呼び出し元へ戻ります。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> OTEL_TRACES_EXPORTER=otlp</span><br></pre></td></tr></table></figure><p>コメントには「<a href="https://opentelemetry.io/docs/specs/otel/protocol/exporter/#configuration-options">OpenTelemetry Protocol Exporter Configuration Options</a>」へのリンクが添付されています。</p><p>ただし、Open Telemetry について本記事では立ち入りません。<br>気になる方は、以下の公式ドキュメント・日本語記事・翻訳書籍をご参照ください。</p><ul><li>公式ドキュメント<ul><li><a href="https://opentelemetry.io/docs/what-is-opentelemetry/">What is OpenTelemetry?</a></li></ul></li><li>日本語記事<ul><li><a href="https://zenn.dev/yuta28/articles/what-is-opentelemetry">OpenTelemetryに触れてみた</a></li></ul></li><li>翻訳書籍<ul><li><a href="https://www.oreilly.co.jp/books/9784814400126/">オブザーバビリティ・エンジニアリング</a></li></ul></li></ul><p>ここでは、実装コードを参照する中で、Terraform には「環境変数の <code>OTEL_TRACES_EXPORTER</code> に <code>otlp</code> を与えることで、Open Telemetry が有効化される」ことが分かりました。</p><p>このような知識はもちろん公式ドキュメントを漁れば見つかるのだとは思いますが、自分で探索して見つけたときの「自力で発見できた感覚」を味わえるのが、OSS コードリーディングの面白さだと私は感じております。少々、蛇足に過ぎましたので、元のコードに戻ります。</p><h2 id="tmpLogPath"><a href="#tmpLogPath" class="headerlink" title="tmpLogPath"></a><code>tmpLogPath</code></h2><p>続いて、<code>tmpLogPath</code> という「一時的なログファイルの出力先」になりそうな変数が見つかりました。<br>適切な変数名は「適切なメンタルモデル」を脳内に作るために重要なので、こういった側面においても、OSS のコードリーディングでは書籍からは得られない実践知が詰っていると感じます。</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line">tmpLogPath := os.Getenv(envTmpLogPath)</span><br><span class="line"><span class="keyword">if</span> tmpLogPath != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">  f, err := os.OpenFile(tmpLogPath, os.O_RDWR|os.O_APPEND, <span class="number">0666</span>)</span><br><span class="line">  <span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">defer</span> f.Close()</span><br><span class="line"></span><br><span class="line">    log.Printf(<span class="string">&quot;[DEBUG] Adding temp file log sink: %s&quot;</span>, f.Name())</span><br><span class="line">    logging.RegisterSink(f)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    log.Printf(<span class="string">&quot;[ERROR] Could not open temp log file: %v&quot;</span>, err)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ここの実装では、環境変数の <code>TF_TEMP_LOG_PATH</code> で指定したファイルに、ログを追記する処理が定義されています。<br>それでは、ログの出力先を指定して、出力ログと実装コードの対応を確認していきます。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ログの出力先を /tmp/tf.log に指定</span></span><br><span class="line"><span class="built_in">export</span> TF_TEMP_LOG_PATH=<span class="string">&quot;/tmp/tf.log&quot;</span></span><br></pre></td></tr></table></figure><p>ログ出力先の環境変数を設定してから任意の <code>terraform</code> コマンドを実行すると、ファイルには以下のログが追記されます。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">2024-03-25T05:07:16.800+0900 [INFO]  Terraform version: 1.9.0 dev</span><br><span class="line">2024-03-25T05:07:16.800+0900 [DEBUG] using github.com/hashicorp/go-tfe v1.41.0</span><br><span class="line">2024-03-25T05:07:16.800+0900 [DEBUG] using github.com/hashicorp/hcl/v2 v2.20.0</span><br><span class="line">2024-03-25T05:07:16.800+0900 [DEBUG] using github.com/hashicorp/terraform-svchost v0.1.1</span><br><span class="line">2024-03-25T05:07:16.800+0900 [DEBUG] using github.com/zclconf/go-cty v1.14.3</span><br><span class="line">2024-03-25T05:07:16.800+0900 [INFO]  Go runtime version: go1.22.1</span><br><span class="line">2024-03-25T05:07:16.800+0900 [INFO]  CLI args: []string&#123;&quot;./terraform&quot;, &quot;version&quot;&#125;</span><br><span class="line">2024-03-25T05:07:16.800+0900 [TRACE] Stdout is a terminal of width 125</span><br><span class="line">2024-03-25T05:07:16.800+0900 [TRACE] Stderr is a terminal of width 125</span><br><span class="line">2024-03-25T05:07:16.800+0900 [TRACE] Stdin is a terminal</span><br><span class="line">2024-03-25T05:07:16.800+0900 [DEBUG] Attempting to open CLI config file: /home/blog-user/.terraformrc</span><br><span class="line">2024-03-25T05:07:16.800+0900 [DEBUG] File doesn&#x27;t exist, but doesn&#x27;t need to. Ignoring.</span><br><span class="line">2024-03-25T05:07:16.800+0900 [DEBUG] ignoring non-existing provider search directory terraform.d/plugins</span><br><span class="line">2024-03-25T05:07:16.800+0900 [DEBUG] ignoring non-existing provider search directory /home/blog-user/.terraform.d/plugins</span><br><span class="line">2024-03-25T05:07:16.800+0900 [DEBUG] ignoring non-existing provider search directory /home/blog-user/.local/share/terraform/plugins</span><br><span class="line">2024-03-25T05:07:16.800+0900 [DEBUG] ignoring non-existing provider search directory /usr/local/share/terraform/plugins</span><br><span class="line">2024-03-25T05:07:16.800+0900 [DEBUG] ignoring non-existing provider search directory /usr/share/terraform/plugins</span><br><span class="line">2024-03-25T05:07:16.800+0900 [DEBUG] ignoring non-existing provider search directory /var/lib/snapd/desktop/terraform/plugins</span><br><span class="line">2024-03-25T05:07:16.801+0900 [INFO]  CLI command args: []string&#123;&quot;version&quot;&#125;</span><br></pre></td></tr></table></figure><p>これらのログと実装コードの対応を見ますと、<code>TF_TEMP_LOG_PATH</code> を設定した「<a href="https://github.com/hashicorp/terraform/blob/main/main.go#L103-L134">直後の処理内容</a>」が、そのままログとして格納されていることが分かります。</p><p>例えば、<code>version.InterestingDependencies()</code> により取得された「<a href="https://github.com/hashicorp/terraform/blob/main/version/dependencies.go#L11-L16">依存モジュールのバージョン情報</a>」は、以下のように記録されています。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">2024-03-25T05:07:16.800+0900 [DEBUG] using github.com/hashicorp/go-tfe v1.41.0</span><br><span class="line">2024-03-25T05:07:16.800+0900 [DEBUG] using github.com/hashicorp/hcl/v2 v2.20.0</span><br><span class="line">2024-03-25T05:07:16.800+0900 [DEBUG] using github.com/hashicorp/terraform-svchost v0.1.1</span><br><span class="line">2024-03-25T05:07:16.800+0900 [DEBUG] using github.com/zclconf/go-cty v1.14.3</span><br></pre></td></tr></table></figure><p>ログの対応を1つ1つ、実装コードと突き合わせてみますと、以下に対応するログが出力されていないことが分かります。</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> ExperimentsAllowed() &#123;</span><br><span class="line">  log.Printf(<span class="string">&quot;[INFO] This build of Terraform allows using experimental features&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ExperimentsAllowed()</code> の定義にコードジャンプすると、「<a href="https://github.com/hashicorp/terraform/blob/main/experiments.go#L25">terraform&#x2F;experiments.go</a>」のコメントとして、この関数を有効化する方法（返り値がtrueにする方法）が記載されています。</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// experimentsAllowed can be set to any non-empty string using Go linker</span></span><br><span class="line"><span class="comment">// arguments in order to enable the use of experimental features for a</span></span><br><span class="line"><span class="comment">// particular Terraform build:</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//   go install -ldflags=&quot;-X &#x27;main.experimentsAllowed=yes&#x27;&quot;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// By default this variable is initialized as empty, in which case</span></span><br><span class="line"><span class="comment">// experimental features are not available.</span></span><br></pre></td></tr></table></figure><p>コメントの内容に従うと、<code>terraform</code> のビルド時に</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">go install -ldflags=<span class="string">&quot;-X &#x27;main.experimentsAllowed=yes&#x27;&quot;</span></span><br></pre></td></tr></table></figure><p>を混ぜ込むことにより、<code>experiments</code>（実験的機能）を有効化できるようです。</p><p>「<a href="https://github.com/hashicorp/terraform/blob/main/scripts/build.sh">scripts&#x2F;build.sh</a>」を確認すると、<code>-ldflags</code> に渡される値は以下のように定義されていることが分かります。<code>TF_RELEASE</code> に値を設定した場合のみ、<code>gox -ldflags &quot;&quot;$&#123;LD_FLAGS&#125;&quot;&quot;</code> が「<a href="https://github.com/hashicorp/terraform/blob/main/scripts/build.sh#L44-L62">ビルド時に追加</a>」されています。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># In release mode we don&#x27;t want debug information in the binary and we don&#x27;t</span></span><br><span class="line"><span class="comment"># want the -dev version marker</span></span><br><span class="line"><span class="keyword">if</span> [[ -n <span class="string">&quot;<span class="variable">$&#123;TF_RELEASE&#125;</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    LD_FLAGS=<span class="string">&quot;-s -w -X &#x27;github.com/hashicorp/terraform/version.dev=no&#x27;&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><p>今回は <code>TF_RELEASE</code> を利用しないので、以下の分岐を追加します。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> [[ -n <span class="string">&quot;<span class="variable">$&#123;TF_RELEASE&#125;</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    LD_FLAGS=<span class="string">&quot;-s -w -X &#x27;github.com/hashicorp/terraform/version.dev=no&#x27;&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    LD_FLAGS=<span class="string">&quot;-X &#x27;main.experimentsAllowed=yes&#x27;&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><p>この状態で実行バイナリをビルドし、任意の <code>terraform</code> コマンドを実行すると、ログファイルに以下の1文が追記されることを確認できます。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">[INFO]  This build of Terraform allows using experimental features</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p><code>experiments</code> を有効化することにより、何かしらの実験的コマンドが利用可能となったのだと思います。しかし、ここまでのコードリーディングの範囲では「どのような機能が有効化されたのか？」についての情報に遭遇していないため、<code>ExperimentsAllowed()</code> の探索はここまでとします。</p><h2 id="terminal-Init"><a href="#terminal-Init" class="headerlink" title="terminal.Init()"></a><code>terminal.Init()</code></h2><p>コードリーディングとしては、ログ後半に注目してみます。<br>ここでは、ターミナルを初期化しているような <code>terminal.Init()</code> という関数と、その関数の返り値を利用して</p><ul><li>標準入力</li><li>標準出力</li><li>標準エラー出力</li></ul><p>のそれぞれに対して、<code>IsXXX()</code> の方式で「ターミナルであるか、否か」を判断している以下の実装が見つかります。</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line">streams, err := terminal.Init()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">  Ui.Error(fmt.Sprintf(<span class="string">&quot;Failed to configure the terminal: %s&quot;</span>, err))</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> streams.Stdout.IsTerminal() &#123;</span><br><span class="line">  log.Printf(<span class="string">&quot;[TRACE] Stdout is a terminal of width %d&quot;</span>, streams.Stdout.Columns())</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  log.Printf(<span class="string">&quot;[TRACE] Stdout is not a terminal&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> streams.Stderr.IsTerminal() &#123;</span><br><span class="line">  log.Printf(<span class="string">&quot;[TRACE] Stderr is a terminal of width %d&quot;</span>, streams.Stderr.Columns())</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  log.Printf(<span class="string">&quot;[TRACE] Stderr is not a terminal&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> streams.Stdin.IsTerminal() &#123;</span><br><span class="line">  log.Printf(<span class="string">&quot;[TRACE] Stdin is a terminal&quot;</span>)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  log.Printf(<span class="string">&quot;[TRACE] Stdin is not a terminal&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>terminal.Init()</code> の定義元にコードジャンプすると、こちらも「<a href="https://github.com/hashicorp/terraform/blob/main/internal/terminal/streams.go#L4-L17">長文コメント</a>」で実装内容、実装意図が説明されています。</p><p>コマンドの実行環境は <code>terraform</code> が正しく入力・出力を扱える環境なのか、この terminal パッケージ内にて確認処理を行っています。普段、ツールやコマンドを取得する際には <code>Requirements</code> を確認してインストールしますが、コマンドの実行プロセス内においても、実行環境の確認を行っていることが確認できました。</p><p>…</p><p>本ブログでのコードリーディングは一旦ここまでとします。<br><code>func main() &#123;...&#125;</code> から読み始め、進捗行数としては70行程度です。ただし、途中でコードジャンプやシェルスクリプトの確認が入ったため、単純に「<code>main()</code> からの進捗行数 &#x3D; コードリーディング行数」というカウントにはなりません。「実際に動かしながらのコードリーディング」のスピードを実感いただけたでしょうか。</p><h1 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h1><p>本ブログでは、「Terraform の実装コードを、動かしながら読む」という目標を掲げ、実行バイナリのビルドやコードの改造を取り入れながら、OSS のコードリーディングを行いました。前半の環境準備に原稿の多くが割かれているため、実際のコードリーディング行数は100行未満ではないかと思います。OSS コードリーディングの面白さは「各自が、自分の好き勝手に読めること」にあると思いますので、私ならどのように読むか？を詳しく解説してきました。</p><p>ここまで長文にお付き合いいただき、ありがとうございました。</p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;img src=&quot;/images/20240326a/top.png&quot; alt=&quot;&quot; width=&quot;800&quot; height=&quot;539&quot;&gt;

&lt;p&gt;&lt;a href=&quot;/articles/20240311a/&quot;&gt;Terraform連載2024&lt;/a&gt;</summary>
        
      
    
    
    
    <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
    <category term="Go" scheme="https://future-architect.github.io/tags/Go/"/>
    
    <category term="Terraform" scheme="https://future-architect.github.io/tags/Terraform/"/>
    
    <category term="CodeReading" scheme="https://future-architect.github.io/tags/CodeReading/"/>
    
    <category term="Copilot" scheme="https://future-architect.github.io/tags/Copilot/"/>
    
  </entry>
  
  <entry>
    <title>Azure環境Terraform実行におけるリソースプロバイダーについて</title>
    <link href="https://future-architect.github.io/articles/20240325a/"/>
    <id>https://future-architect.github.io/articles/20240325a/</id>
    <published>2024-03-24T15:00:00.000Z</published>
    <updated>2024-03-25T03:53:19.175Z</updated>
    
    <content type="html"><![CDATA[<img src="/images/20240325a/top.png" alt="" width="800" height="515"><p><a href="/articles/20240311a/">Terraform連載2024を</a> の8本目です。</p><h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>こんにちは、SAIG(Strategic AI Group)の真鍋です。</p><p>昨今のOpenAI需要によって、Azure環境の利用を本格的に始める方も多いかと思います。</p><p>Azure環境でTerraformを利用する際、裏で動いているリソースプロバイダーについてご紹介します。</p><h1 id="Terraform実行時に踏んだエラー"><a href="#Terraform実行時に踏んだエラー" class="headerlink" title="Terraform実行時に踏んだエラー"></a>Terraform実行時に踏んだエラー</h1><p>利用中のAzure環境にて<code>terraform plan</code>を実行した際に、下記エラーが発生しました。</p><p>見やすいように改行等追加しています。</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Original Error: Cannot register providers: </span><br><span class="line">Microsoft.ServiceBus,</span><br><span class="line">Microsoft.DBforPostgreSQL,</span><br><span class="line">(中略)...</span><br><span class="line">Microsoft.TimeSeriesInsights.</span><br><span class="line">Errors were:</span><br><span class="line">Cannot register provider Microsoft.ServiceBus with Azure Resource Manager:</span><br><span class="line">unexpected status 403 with error:</span><br><span class="line">AuthorizationFailed:</span><br><span class="line">The client &#x27;xxx.xxx.xxx@exapmle.co.jp&#x27; with object id &#x27;xxxxx-xxxx-xxxx-xxxx-xxxx&#x27;</span><br><span class="line">does not have authorization to perform action &#x27;Microsoft.ServiceBus/register/action&#x27;</span><br><span class="line">over scope &#x27;/subscriptions/xxxx-xxxx-xxxx-xxxx&#x27; or the scope is invalid.</span><br><span class="line">If access was recently granted, please refresh your credentials..</span><br></pre></td></tr></table></figure><p>Terraformコード上はVMやStorage Account等、作成権限が確認できているリソースしか記載していませんでしたが、providerなるものを追加する際に権限不足で失敗したとのことです。</p><p>ちなみに利用するAzure環境は他チームから払い出された環境であり、Terraform実行時に認証した個人アカウントは権限が絞られています。</p><h1 id="リソースプロバイダーとは"><a href="#リソースプロバイダーとは" class="headerlink" title="リソースプロバイダーとは"></a>リソースプロバイダーとは</h1><p>今回遭遇したエラーのproviderはリソースプロバイダーといい、<a href="https://learn.microsoft.com/ja-jp/azure/azure-resource-manager/management/azure-services-resource-providers">Azure サービスのリソース プロバイダーとは何か</a>に説明があります。</p><p>概要について抜粋します。</p><blockquote><p>リソース プロバイダーは、Azure サービスの機能を実現する REST 操作のコレクションです。 各リソース プロバイダーには、company-name.service-label という形式の名前空間があります。</p></blockquote><p>例えばAzureストレージについては、<code>Microsoft.Storage</code>という名前空間で表現されます。</p><p>REST APIへリクエストを送信した際にAzureリソースマネージャーがそれを受け取りますが、実際の操作はリソースプロバイダーによって実施します。</p><p>下記ページが分かりやすくまとめられています。<br><a href="https://milestone-of-se.nesuke.com/sv-advanced/azure/resource-manager-provider/">【図解】初心者向けリソースマネージャーとリソースプロバイダー</a></p><p>リソースプロバイダーは既定で登録されているものもありますが、手動で登録する場合や、Azureポータルにおいてリソースを作ることで自動登録される場合もあります。</p><p>今回のエラーは、Terraformプロバイダーの一つであるAzureRM利用時にリソースプロバイダーを登録しようとして発生しました。</p><h1 id="Terraform実行時におけるリソースプロバイダー"><a href="#Terraform実行時におけるリソースプロバイダー" class="headerlink" title="Terraform実行時におけるリソースプロバイダー"></a>Terraform実行時におけるリソースプロバイダー</h1><p>AzureにおけるTerraformプロバイダーとしては下記が用意されています。</p><ul><li>AzureRM</li><li>AzureAD</li><li>AzureDevops</li><li>AzAPI</li><li>AzureStack</li></ul><p>今回はVMやStorage Account等を管理するため、AzureRMを利用していました。</p><p><a href="https://github.com/hashicorp/terraform-provider-azurerm/blob/main/internal/resourceproviders/required.go">terraform-provider-azurerm&#x2F;internal&#x2F;resourceproviders</a>のページによると、AzureRMでは複数のリソースプロバイダーを自動で登録するとのことです。</p><p>リソースプロバイダーの登録ですが、providerブロックに<code>skip_provider_registration = true</code>とすることで無効化できます。</p><p>あるいは環境変数<code>ARM_SKIP_PROVIDER_REGISTRATION</code>を設定することも可能とのことです。</p><figure class="highlight sh"><figcaption><span>terraform</span></figcaption><table><tr><td class="code"><pre><span class="line">provider <span class="string">&quot;azurerm&quot;</span> &#123;</span><br><span class="line">  skip_provider_registration = <span class="literal">true</span></span><br><span class="line">  features &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs#skip_provider_registration">Azure Provider#skip_provider_registration</a></p><h1 id="解決法"><a href="#解決法" class="headerlink" title="解決法"></a>解決法</h1><p>今回発生したエラーの解決には下記1,2の方法が考えられます。</p><ol><li>Terraform実行ユーザにリソースプロバイダー関連の権限を付与する</li><li>事前に手動でリソースプロバイダーを登録し、Terraformのリソースプロバイダー登録を無効化する</li></ol><p>1つ目の方法ですが、サブスクリプション全体に対するリソースごとの<code>company-name.service-label/register/action</code>等の権限を付与する形です。権限を付与し<code>terraform plan</code>を実行したタイミングでリソースプロバイダーが登録されます。</p><p>2つ目の方法は、手動でリソースプロバイダーを登録しておき、Terraform実行時には<code>skip_provider_registration</code>の記載や環境変数でリソースプロバイダー登録をスキップする方法です。手動でリソースプロバイダーを登録する場合は、Azureポータルのサブスクリプションからリソースプロバイダーを選択し、該当リソースプロバイダーを登録します。</p><p>私たちは、リソースプロバイダーの登録をより上位の管理者に依頼して実施するフローを作成した上で、2つ目の方法を採用しました。同一サブスクリプション内で複数チームがそれぞれTerraform実行するようなケースにおいて、利用可能なリソースを制限する場合等に採り得る方法なのかと思います。</p><h1 id="さいごに"><a href="#さいごに" class="headerlink" title="さいごに"></a>さいごに</h1><p>これまで強い権限でTerraformを操作していたためリソースプロバイダーを意識することは無かったのですが、今回はチームの運用ポリシーとして権限が制限されていたため改めて調査しました。</p><p>リソースプロバイダーの登録を必要最低限にすることで、不要なリソースをサブスクリプション内で作成されないようにすることが可能です。リソースプロバイダー登録の権限を分離することで、より厳格にAzure環境を運用できます。</p><p>より良い運用方法について、今後も考えていきたいと思います。</p><p>また、今回の記事で扱ったリソースプロバイダーについての調査は、同チームの戸井田さんにご協力いただきました。ありがとうございました！</p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;img src=&quot;/images/20240325a/top.png&quot; alt=&quot;&quot; width=&quot;800&quot; height=&quot;515&quot;&gt;


&lt;p&gt;&lt;a href=&quot;/articles/20240311a/&quot;&gt;Terraform連載2024を&lt;/a&gt;</summary>
        
      
    
    
    
    <category term="Infrastructure" scheme="https://future-architect.github.io/categories/Infrastructure/"/>
    
    
    <category term="Terraform" scheme="https://future-architect.github.io/tags/Terraform/"/>
    
    <category term="Azure" scheme="https://future-architect.github.io/tags/Azure/"/>
    
  </entry>
  
  <entry>
    <title>爆速習得、初心者からRustの即戦力を備えるまで</title>
    <link href="https://future-architect.github.io/articles/20240322a/"/>
    <id>https://future-architect.github.io/articles/20240322a/</id>
    <published>2024-03-21T15:00:00.000Z</published>
    <updated>2024-03-22T02:31:03.866Z</updated>
    
    <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>週末を利活用したく、新しい言語をゼロから学習して即戦力を備えるまでどのぐらいかかるかを実験してみました。</p><h4 id="事前状態"><a href="#事前状態" class="headerlink" title="事前状態"></a>事前状態</h4><ul><li>いくつかのプログラミング言語（C++,Python,JavaScript,Java,Go,Bash,etc.）の経験</li><li>基礎的なウェブアプリ構築（フロントエンド、バックエンド）の経験</li><li>Rustは未経験。事前に知っていたこと<ul><li>コンパイル言語</li><li>実行速度が速い、C&#x2F;C++からGoの間ぐらい</li><li>WebAssemblyにコンパイルできる、ブラウザ上で動くゲームやシミュレーターなどを作れる</li></ul></li></ul><h4 id="実績"><a href="#実績" class="headerlink" title="実績"></a>実績</h4><ol><li>開発環境を備える (30 min, 15:30~16:30)</li><li>基本コンセプトを把握する (45 min, 16:00～16:30,&lt;休憩&gt;,19:30～19:45)</li><li><del>Hello World</del> Game of Lifeを実装してみる (135 min, 19:45～22:00)</li></ol><ul><li>スタートから１個目のシンプルなデモプログラミング（<a href="https://ja.wikipedia.org/wiki/%E3%83%A9%E3%82%A4%E3%83%95%E3%82%B2%E3%83%BC%E3%83%A0">Conway’s Game of Life</a>のコンソール版）の作成まで、環境整備+概念学習+コーディング+デバグ時間実績は<strong>210 min</strong>でした。（途中で飲んでいたので後半は効率悪かった）</li><li>爆速学習の流れは、ChatGPT先生に聞く＋少しグーグル検索（Rustの本を３冊買いましたが、最初は読みませんでした。理由は効率重視のため、アウトプット駆動でやりたいと考えたためです）</li><li>また、自分の手で作りたいので、基本はウェブからソースをコピーしないことをルールとしました</li></ul><p><em>ChatGPTさんとのやり取りログは<a href="https://chat.openai.com/share/8f9d3ac3-85ca-46cd-8ebe-730490e40db8">こちら</a><br>（全部英語でやりました、質問の仕方に興味ある方ご参考を）</em></p><h2 id="学習ログ"><a href="#学習ログ" class="headerlink" title="学習ログ"></a>学習ログ</h2><h4 id="15-30-Start"><a href="#15-30-Start" class="headerlink" title="15:30 Start"></a>15:30 Start</h4><p>ChatGPT先生にRustの学習ステップを教えてくれたのは、</p><ol><li>Understand the Basics</li><li>Setup Rust Development Environment</li><li>Write Your First Rust Program</li><li>Learn Ownership, Borrowing, and Lifetimes</li><li>Explore Rust’s Standard Library</li><li>Understand Error Handling</li><li>Work on Small Projects</li><li>Read Advanced Topics and Best Practices</li><li>Join the Rust Community</li><li>Continuous Learning and Practice</li></ol><p>1番目を飛ばし、直接2番の環境構築を行います。</p><h4 id="15-30-15-33-Installation"><a href="#15-30-15-33-Installation" class="headerlink" title="15:30~15:33 Installation"></a>15:30~15:33 Installation</h4><p>推奨された一番楽の方法でcurl|shのワンライナーでrustupをインストールします。<br>（rustupってなに？というのは後にします）</p><p><a href="https://www.rust-lang.org/tools/install">https://www.rust-lang.org/tools/install</a></p><h4 id="15-33-15-37-Hello-World"><a href="#15-33-15-37-Hello-World" class="headerlink" title="15:33~15:37 Hello World"></a>15:33~15:37 Hello World</h4><p>インストール成功の証にもなるため、Hello Worldの書き方を聞きました。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> my_rust_project</span><br><span class="line">$ <span class="built_in">cd</span> my_rust_project</span><br><span class="line">$ <span class="built_in">touch</span> main.rs</span><br></pre></td></tr></table></figure><p>main.rsの内容です。</p><figure class="highlight rs"><table><tr><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Hello, World!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>コンパイルと実行</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ rustc main.rs</span><br><span class="line">$ ./main</span><br><span class="line">Hello, World!</span><br></pre></td></tr></table></figure><p>楽勝ですね！</p><h4 id="15-38-add-extension"><a href="#15-38-add-extension" class="headerlink" title="15:38 add extension"></a>15:38 add extension</h4><p>普段VisualStudioCodeを愛用しているため、Rust用のExtensionなにかおすすめある？って聞いたら、次の回答でした</p><ol><li>Rust (rls) by rust-lang</li><li>rust-analyzer by matklad</li><li>CodeLLDB by Vadim Chugunov</li><li>Better TOML by bungcip</li><li>Crates by serayuzgur</li><li>Cargo by serayuzgur</li></ol><p>…しかし、中に(deprecated)などメンテを続けなくなるものや、機能重複のものもあったため、詳細を確認しつつ、最終的には以下を利用しました。</p><ol><li>Language support: <a href="https://marketplace.visualstudio.com/items?itemName=rust-lang.rust-analyzer">rust-analyzer</a></li><li>Debugger: <a href="https://marketplace.visualstudio.com/items?itemName=vadimcn.vscode-lldb">CodeLLDB</a></li><li>TOML support for <code>Cargo.toml</code>: <a href="https://marketplace.visualstudio.com/items?itemName=tamasfe.even-better-toml">Even Better TOML</a></li><li>Dependency manager: <a href="https://marketplace.visualstudio.com/items?itemName=serayuzgur.crates">crates</a></li></ol><p>15:44 データタイプ、変数、関数、コントロールフロー(if文、ループ文)などのお勉強</p><h4 id="15-47-15-57-VSCodeで動かす"><a href="#15-47-15-57-VSCodeで動かす" class="headerlink" title="15:47~15:57 VSCodeで動かす"></a>15:47~15:57 VSCodeで動かす</h4><p>やっぱりChatGPT先生だけに聞くのがなかなか不安であるため、Googleで<code>vscode run for rust</code>を検索しました。</p><p><a href="https://code.visualstudio.com/docs/languages/rust">https://code.visualstudio.com/docs/languages/rust</a></p><p>やはり <code>cargo</code> を使うことにしました。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ cargo new MyRustApp</span><br><span class="line">warning: the name `MyRustApp` is not snake_case or kebab-case <span class="built_in">which</span> is recommended <span class="keyword">for</span> package names, consider `myrustapp`</span><br><span class="line">     Created binary (application) `MyRustApp` package</span><br></pre></td></tr></table></figure><p>命名制約違反ということでwarningで怒られました。snakeケースに変えてみましょう。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ cargo new my_rust_app</span><br><span class="line">     Created binary (application) `my_rust_app` package</span><br></pre></td></tr></table></figure><p>フォルダ構成も確認しましょう。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> my_rust_app  </span><br><span class="line">$ tree -a -L 2</span><br><span class="line">.</span><br><span class="line">├── .git</span><br><span class="line">│   ├── FETCH_HEAD</span><br><span class="line">│   ├── HEAD</span><br><span class="line">│   ├── config</span><br><span class="line">│   ├── description</span><br><span class="line">│   ├── hooks</span><br><span class="line">│   ├── info</span><br><span class="line">│   ├── objects</span><br><span class="line">│   └── refs</span><br><span class="line">├── .gitignore</span><br><span class="line">├── Cargo.lock</span><br><span class="line">├── Cargo.toml</span><br><span class="line">├── src</span><br><span class="line">│   └── main.rs</span><br><span class="line">└── target</span><br><span class="line">    ├── .rustc_info.json</span><br><span class="line">    ├── CACHEDIR.TAG</span><br><span class="line">    └── debug</span><br><span class="line"></span><br><span class="line">9 directories, 10 files</span><br></pre></td></tr></table></figure><p>gitや.gitignoreも生成されています。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> .gitignore</span><br><span class="line">/target</span><br></pre></td></tr></table></figure><p><code>/target</code>をignoreされているので、コンパイルした中間ファイルやバイナリなどだろうか、一旦無視します。</p><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line">$ cat Cargo.toml </span><br><span class="line"><span class="section">[package]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;my_rust_app&quot;</span></span><br><span class="line"><span class="attr">version</span> = <span class="string">&quot;0.1.0&quot;</span></span><br><span class="line"><span class="attr">edition</span> = <span class="string">&quot;2021&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html</span></span><br><span class="line"></span><br><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"></span><br><span class="line">$ cat Cargo.lock </span><br><span class="line"><span class="comment"># This file is automatically @generated by Cargo.</span></span><br><span class="line"><span class="comment"># It is not intended for manual editing.</span></span><br><span class="line"><span class="attr">version</span> = <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="section">[[package]]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;my_rust_app&quot;</span></span><br><span class="line"><span class="attr">version</span> = <span class="string">&quot;0.1.0&quot;</span></span><br></pre></td></tr></table></figure><p><code>Cargo.toml</code>はmeta情報やライブラリ導入用だろう(dependenciesが追加する箇所みたい)<br><code>Cargo.lock</code>は自動生成のようで、編集不可とあります。</p><p>VSCodeでmy_rust_appをopenし、main.rsを見てみると、この前のHello Worldそのままでした。</p><p>とにかく、Ctrl+F5 (Run Without Debugging)でmain.rsを実行してみます。</p><img src="/images/20240322a/1acd3193-ce50-e995-9953-e4016732cc01.png" alt="" width="536" height="430" loading="lazy"><img src="/images/20240322a/95894823-e76d-382b-7b3b-84bf51dd5410.png" alt="" width="534" height="650" loading="lazy"><p>OKとYesを押すと<code>.vscode/launch.json</code>が自動生成される</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="comment">// Use IntelliSense to learn about possible attributes.</span></span><br><span class="line">    <span class="comment">// Hover to view descriptions of existing attributes.</span></span><br><span class="line">    <span class="comment">// For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;configurations&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lldb&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Debug executable &#x27;my_rust_app&#x27;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;cargo&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                    <span class="string">&quot;build&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="string">&quot;--bin=my_rust_app&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="string">&quot;--package=my_rust_app&quot;</span></span><br><span class="line">                <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;my_rust_app&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bin&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;cwd&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceFolder&#125;&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lldb&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Debug unit tests in executable &#x27;my_rust_app&#x27;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;cargo&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                    <span class="string">&quot;test&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="string">&quot;--no-run&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="string">&quot;--bin=my_rust_app&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="string">&quot;--package=my_rust_app&quot;</span></span><br><span class="line">                <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;my_rust_app&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bin&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;cwd&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceFolder&#125;&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>もう一度 Ctrl+F5、コンパイルと実行の一連が発動し、<code>Hello, world!</code>メッセージがコンソールに現れて実行成功でした。<br>もちろん、コンソールで<code>cargo run</code>を実行してもよいです。</p><p>ちなみに、cargoでのビルドは以下です。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"> *  Executing task: CodeLLDB: cargo </span><br><span class="line"></span><br><span class="line">Running `cargo build --bin=my_rust_app --package=my_rust_app --message-format=json`...</span><br><span class="line">   Compiling my_rust_app v0.1.0 (/Users/wsysuper/my_rust_app)</span><br><span class="line">    Finished dev [unoptimized + debuginfo] target(s) <span class="keyword">in</span> 0.11s</span><br><span class="line"> *  Terminal will be reused by tasks, press any key to close it. </span><br></pre></td></tr></table></figure><p>続けて、ChatGPT先生から基本知識を勉強します。</p><h4 id="15-57-16-07-basic-data-types-variables-functions-and-control-flow-constructs"><a href="#15-57-16-07-basic-data-types-variables-functions-and-control-flow-constructs" class="headerlink" title="15:57~16:07 basic data types, variables, functions, and control flow constructs"></a>15:57~16:07 basic data types, variables, functions, and control flow constructs</h4><ol><li>Basic Data Types and Variables: <figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Declare variables with explicit types</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">number</span>: <span class="type">i32</span> = <span class="number">42</span>; <span class="comment">// Signed 32-bit integer</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">floating_point</span>: <span class="type">f64</span> = <span class="number">3.14</span>; <span class="comment">// Double-precision floating-point number</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Rust allows type inference</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">another_number</span> = <span class="number">123</span>; <span class="comment">// Compiler infers the type as i32</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Mutable variables using &#x27;mut&#x27; keyword</span></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">mutable_variable</span> = <span class="number">10</span>;</span><br><span class="line">mutable_variable = <span class="number">20</span>; <span class="comment">// Can be changed later</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Constants using &#x27;const&#x27; keyword (must be annotated with a type)</span></span><br><span class="line"><span class="keyword">const</span> PI: <span class="type">f64</span> = <span class="number">3.14159</span>;</span><br></pre></td></tr></table></figure></li><li>Functions: <figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Function to add two numbers</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">add</span>(a: <span class="type">i32</span>, b: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a + b; <span class="comment">// Explicit return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Function without explicit return</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">multiply</span>(a: <span class="type">i32</span>, b: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">    a * b <span class="comment">// Implicit return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Function with no parameters and no return value</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">greet</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Hello, World!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Function with multiple return values (using tuple)</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">calculate</span>(a: <span class="type">i32</span>, b: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> (<span class="type">i32</span>, <span class="type">i32</span>) &#123;</span><br><span class="line">    (a + b, a * b)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>Control Flow Constructs: <figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="comment">// If statement</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">number</span> = <span class="number">42</span>;</span><br><span class="line"><span class="keyword">if</span> number &gt; <span class="number">0</span> &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Positive&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> number &lt; <span class="number">0</span> &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Negative&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Zero&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// While loop</span></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">count</span> = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> count &lt; <span class="number">5</span> &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Count: &#123;&#125;&quot;</span>, count);</span><br><span class="line">    count += <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// For loop (range-based)</span></span><br><span class="line"><span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">5</span> &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Value: &#123;&#125;&quot;</span>, i);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// For loop (iterating over elements)</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">numbers</span> = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line"><span class="keyword">for</span> <span class="variable">num</span> <span class="keyword">in</span> numbers.<span class="title function_ invoke__">iter</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Value: &#123;&#125;&quot;</span>, num);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Match expression</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">number</span> = <span class="number">42</span>;</span><br><span class="line"><span class="keyword">match</span> number &#123;</span><br><span class="line">    <span class="number">0</span> =&gt; <span class="built_in">println!</span>(<span class="string">&quot;Zero&quot;</span>),</span><br><span class="line">    <span class="number">1</span>..=<span class="number">100</span> =&gt; <span class="built_in">println!</span>(<span class="string">&quot;Between 1 and 100&quot;</span>),</span><br><span class="line">    _ =&gt; <span class="built_in">println!</span>(<span class="string">&quot;Something else&quot;</span>),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h4 id="16-07-16-12-変数-mutable-immutable-そして定数-const-について教わる"><a href="#16-07-16-12-変数-mutable-immutable-そして定数-const-について教わる" class="headerlink" title="16:07~16:12 変数(mutable&#x2F;immutable)そして定数(const)について教わる"></a>16:07~16:12 変数(mutable&#x2F;immutable)そして定数(const)について教わる</h4><ul><li><p><code>let</code>: </p><ul><li>不変の変数を宣言するために使用される</li><li><code>let a = 1;</code>のように値を割り当てた後は変更できない</li><li>デフォルトでは不変であり、値の変更を意図していない場合に使用する</li></ul></li><li><p><code>let mut</code>: </p><ul><li>可変の変数を宣言するために使用される</li><li><code>let mut a = 1;</code>のように、<code>mut</code>修飾子を付けることで変更可能な変数を宣言できる</li></ul></li><li><p><code>const</code>: </p><ul><li>定数を宣言するために使用される</li><li><code>const A: i32 = 1;</code>のように、型を明示的に注釈付けし、値はコンパイル時に既知でなければならない</li><li>常に不変であり、プログラムの実行中に変更することはできない</li></ul></li></ul><p>さらに、試験して定数の評価式があってもうまくいきました（コンパイラが計算の結果を定数化してくれるね）。</p><figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> A: <span class="type">i32</span> = <span class="number">1</span> + <span class="number">1</span>;</span><br><span class="line"><span class="keyword">const</span> B: <span class="type">i32</span> = A + <span class="number">1</span>;</span><br></pre></td></tr></table></figure><p>ただ、変数を含めた計算式はダメでした。</p><figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">x</span> = <span class="number">100</span>;</span><br><span class="line"><span class="keyword">const</span> C: <span class="type">i32</span> = x + <span class="number">1</span>;</span><br></pre></td></tr></table></figure><p>以下のコンパイラエラーになった</p><figure class="highlight rust"><table><tr><td class="code"><pre><span class="line">error[E0435]: attempt to <span class="keyword">use</span> a non-constant value <span class="keyword">in</span> a constant</span><br><span class="line"> -<span class="punctuation">-&gt;</span> src/main.rs:<span class="number">6</span>:<span class="number">20</span></span><br><span class="line">  |</span><br><span class="line"><span class="number">6</span> |     <span class="keyword">const</span> C: <span class="type">i32</span> = x + <span class="number">1</span>;</span><br><span class="line">  |     -------        ^ non-constant value</span><br><span class="line">  |     |</span><br><span class="line">  |     help: consider using `<span class="keyword">let</span>` instead of `<span class="keyword">const</span>`: `<span class="keyword">let</span> <span class="variable">C</span>`</span><br></pre></td></tr></table></figure><h4 id="16-12-16-23-Ownership-Borrowing-and-Lifetimes"><a href="#16-12-16-23-Ownership-Borrowing-and-Lifetimes" class="headerlink" title="16:12~16:23 Ownership, Borrowing, and Lifetimes"></a>16:12~16:23 Ownership, Borrowing, and Lifetimes</h4><p>Ownership、Borrowing、そしてLifetimesの概念は、Rustが安全性とパフォーマンスを両立させるための基本的な仕組みとして重要です。</p><ul><li><strong>Ownership（所有権）</strong>:<ul><li>Rustの中心的な概念であり、メモリリソースの管理を行う</li><li>各値には所有者が存在し、所有者はその値を所有する</li><li>所有者がスコープを抜けると、その値は解放される（dropされる）</li></ul></li><li><strong>Borrowing（借用）</strong>:<ul><li>所有者が値を所有する間、他のコードに値の一時的な参照を許可する</li><li>借用は不変(<code>&amp;</code>)または可変(<code>&amp;mut</code>)の2つの形態がある</li><li>不変の借用は同時に複数の読み取りアクセスを可能にするが、可変の借用は一つの書き込みアクセスしか許可しない</li></ul></li><li><strong>Lifetimes（寿命）</strong>:<ul><li>借用の有効範囲を明示的に示すための仕組み</li><li>値の参照が有効である期間を示す</li><li>コンパイラは、借用が所有者より長く続かないように監視し、データ競合や無効なメモリアクセスを防ぐ</li></ul></li><li><strong>所有権ルール</strong>:<ul><li>Rustの値は常にただ1つの所有者を持つ</li><li>所有者がスコープから外れるとき、値は解放される</li><li>所有者は値を必要とするだけ持つ</li><li>値を参照する際には、所有権を借用することができるが、所有者が存在しなければならない</li></ul></li><li><strong>メリット</strong>:<ul><li>所有権、借用、および寿命のシステムは、ランタイムコストなしでメモリ安全性を保証する</li><li>データ競合やセグメンテーション違反などの一般的なランタイムエラーを排除する</li><li>コンパイラがコードの正当性を静的に確認することで、バグを早期に発見しやすくする</li></ul></li></ul><h4 id="16-23-16-30-Standard-Library"><a href="#16-23-16-30-Standard-Library" class="headerlink" title="16:23~16:30 Standard Library"></a>16:23~16:30 Standard Library</h4><ol><li><code>std::collections</code><ul><li>ベクタ、ハッシュマップ、セットなど、Rust のコレクション型が含まれている</li><li><code>Vec</code>、<code>HashMap</code>、<code>HashSet</code>、<code>LinkedList</code>、<code>BinaryHeap</code>などの型がある</li></ul></li><li><code>std::io</code><ul><li>入出力操作を行うためのモジュールです</li><li>ファイル I&#x2F;O、標準入出力、バッファリング、エラーハンドリングなどをサポートしている</li><li><code>Read</code>、<code>Write</code>、<code>BufReader</code>、<code>BufWriter</code>などの型や関数がある</li></ul></li><li><code>std::fs</code><ul><li>ファイルシステム関連の機能が提供されている</li><li>ファイルやディレクトリの操作、メタデータの取得、パスの処理などが可能です</li><li><code>File</code>、<code>DirEntry</code>、<code>Metadata</code>、<code>create_dir</code>、<code>read_dir</code>などの型や関数が含まれている</li></ul></li><li><code>std::thread</code><ul><li>スレッドの作成、スレッド間通信、同期処理などを行うためのモジュールである</li><li><code>thread::spawn</code>、<code>thread::sleep</code>、<code>Mutex</code>、<code>Arc</code>、<code>JoinHandle</code>などの型や関数がある</li></ul></li><li><code>std::sync</code><ul><li>同期プリミティブが提供されている</li><li>ミューテックス、アトミックなデータ型、チャネルなどが含まれている</li><li><code>Mutex</code>、<code>RwLock</code>、<code>AtomicBool</code>、<code>mpsc::channel</code>などの型や関数がある</li></ul></li><li><code>std::net</code><ul><li>ネットワークプログラミング関連の機能が提供されている</li><li>ソケットの作成、TCP&#x2F;UDP 通信、アドレス解決などが可能</li><li><code>TcpStream</code>、<code>UdpSocket</code>、<code>Ipv4Addr</code>、<code>SocketAddr</code>などの型や関数がある</li></ul></li><li><code>std::time</code><ul><li>時刻や時間に関連する操作が提供されている</li><li>システム時刻の取得、時間の計測、スリープなどが可能</li><li><code>SystemTime</code>、<code>Duration</code>、<code>Instant</code>などの型や関数がある</li></ul></li><li><code>std::path</code><ul><li>ファイルパスに関連する機能が提供されている</li><li>パスの結合、解析、正規化などが可能</li><li><code>Path</code>、<code>PathBuf</code>、<code>join</code>、<code>canonicalize</code>などの型や関数がある</li></ul></li><li><code>std::env</code><ul><li>実行環境とのやり取りに関連する機能が提供されている</li><li>コマンドライン引数の取得、環境変数の操作、ディレクトリの取得などが可能</li><li><code>args</code>、<code>var</code>、<code>current_dir</code>などの型や関数がある</li></ul></li><li><code>std::error</code><ul><li>エラー処理に関連する機能が提供されている</li><li>エラー型、エラーハンドリング機構などが含まれている</li><li><code>Error</code>、<code>Result</code>、<code>From</code>、<code>Display</code>などの型やトレイトがある</li></ul></li></ol><h4 id="16-30-休憩に入る"><a href="#16-30-休憩に入る" class="headerlink" title="16:30 休憩に入る"></a>16:30 休憩に入る</h4><p>&lt;3時間後再開&gt;</p><h4 id="19-30-19-40-Understand-Error-Handling"><a href="#19-30-19-40-Understand-Error-Handling" class="headerlink" title="19:30~19:40 Understand Error Handling"></a>19:30~19:40 Understand Error Handling</h4><p>Error handling in Rust is a fundamental aspect of writing robust and reliable code. Rust provides mechanisms to handle errors in a way that ensures safety and encourages explicit handling of error conditions. The two main types used for error handling in Rust are <code>Result&lt;T, E&gt;</code> and <code>Option&lt;T&gt;</code>.</p><ol><li><strong>Result&lt;T, E&gt;</strong>:<ul><li><code>Result&lt;T, E&gt;</code> is a type that represents either success with a value of type <code>T</code> or failure with an error of type <code>E</code></li><li>The <code>Ok(T)</code> variant signifies success and contains the value of type <code>T</code>, while the <code>Err(E)</code> variant represents failure and contains the error of type <code>E</code></li><li>Result types are commonly used for functions that may fail or encounter errors during execution <figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="keyword">use</span> std::fs::File;</span><br><span class="line"><span class="keyword">use</span> std::io::Read;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">read_file_contents</span>(file_path: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">String</span>, std::io::Error&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">file</span> = File::<span class="title function_ invoke__">open</span>(file_path)?;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">contents</span> = <span class="type">String</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    file.<span class="title function_ invoke__">read_to_string</span>(&amp;<span class="keyword">mut</span> contents)?;</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(contents)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">match</span> <span class="title function_ invoke__">read_file_contents</span>(<span class="string">&quot;example.txt&quot;</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(contents) =&gt; <span class="built_in">println!</span>(<span class="string">&quot;File contents: &#123;&#125;&quot;</span>, contents),</span><br><span class="line">        <span class="title function_ invoke__">Err</span>(err) =&gt; eprintln!(<span class="string">&quot;Error reading file: &#123;&#125;&quot;</span>, err),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></li><li><strong>Option<T></strong>:<ul><li><code>Option&lt;T&gt;</code> is a type that represents either some value of type <code>T</code> or none (null-like value)</li><li>The <code>Some(T)</code> variant contains the value of type <code>T</code>, while the <code>None</code> variant represents the absence of a value</li><li>Option types are commonly used for functions that may or may not return a value <figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">divide</span>(a: <span class="type">f64</span>, b: <span class="type">f64</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="type">f64</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> b != <span class="number">0.0</span> &#123;</span><br><span class="line">        <span class="title function_ invoke__">Some</span>(a / b)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="literal">None</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">result</span> = <span class="title function_ invoke__">divide</span>(<span class="number">10.0</span>, <span class="number">2.0</span>);</span><br><span class="line">    <span class="keyword">match</span> result &#123;</span><br><span class="line">        <span class="title function_ invoke__">Some</span>(value) =&gt; <span class="built_in">println!</span>(<span class="string">&quot;Result: &#123;&#125;&quot;</span>, value),</span><br><span class="line">        <span class="literal">None</span> =&gt; <span class="built_in">println!</span>(<span class="string">&quot;Cannot divide by zero&quot;</span>),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></li><li><strong>Error Propagation</strong>:<ul><li>Rust provides the <code>?</code> operator to propagate errors from functions that return <code>Result</code> or <code>Option</code></li><li>When used within a function that returns <code>Result</code> or <code>Option</code>, the <code>?</code> operator will return early with the error if an error occurs, simplifying error handling code <figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">read_file_contents</span>(file_path: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">String</span>, std::io::Error&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">file</span> = File::<span class="title function_ invoke__">open</span>(file_path)?;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">contents</span> = <span class="type">String</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    file.<span class="title function_ invoke__">read_to_string</span>(&amp;<span class="keyword">mut</span> contents)?;</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(contents)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></li><li><strong>Panics</strong>:<ul><li>Panics represent unrecoverable errors in Rust and are triggered by calling the <code>panic!</code> macro</li><li>Panics unwind the stack and terminate the program, printing an error message if provided</li><li>Panics are typically used for programming errors or unexpected conditions that cannot be handled gracefully <figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">divide</span>(a: <span class="type">f64</span>, b: <span class="type">f64</span>) <span class="punctuation">-&gt;</span> <span class="type">f64</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> b != <span class="number">0.0</span> &#123;</span><br><span class="line">        a / b</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">panic!</span>(<span class="string">&quot;Division by zero&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></li></ol><p>Error handling in Rust encourages developers to handle errors explicitly, promoting code safety and reliability. By using <code>Result&lt;T, E&gt;</code> and <code>Option&lt;T&gt;</code> types effectively, Rust ensures that error conditions are appropriately managed, improving code readability and maintainability.</p><h4 id="19-40-19-45-他の不明点について質問"><a href="#19-40-19-45-他の不明点について質問" class="headerlink" title="19:40~19:45 他の不明点について質問"></a>19:40~19:45 他の不明点について質問</h4><p>私: <code>What are rustc, cargo, and rustup used for?</code></p><p>ChatGPT回答:</p><ol><li><strong>rustc</strong>:<ul><li><code>rustc</code> is the Rust compiler, responsible for compiling Rust source code into executable programs or libraries</li><li>It takes Rust source files (<code>.rs</code>) as input and generates machine code for the target platform</li><li>Developers can invoke rustc directly from the command line to compile Rust programs without using any build system</li></ul></li><li><strong>cargo</strong>:<ul><li><code>cargo</code> is Rust’s build system and package manager. It automates the process of compiling Rust code, managing dependencies, and building projects</li><li>With <code>cargo</code>, developers can create, build, test, and publish Rust packages effortlessly</li><li>It provides commands like <code>cargo new</code> for creating new projects, <code>cargo build</code> for compiling code, <code>cargo run</code> for executing programs, <code>cargo test</code> for running tests, and <code>cargo publish</code> for publishing crates to the official package registry, crates.io</li></ul></li><li><strong>rustup</strong>:<ul><li><code>rustup</code> is the Rust toolchain installer and manager. It allows developers to install and manage multiple versions of the Rust toolchain on their system</li><li><code>rustup</code> makes it easy to switch between different versions of the Rust compiler, including stable, beta, and nightly releases</li><li>It also manages associated tools like <code>cargo</code>, <code>rustc</code>, and documentation</li><li><code>rustup</code> simplifies the process of setting up a Rust development environment and ensures compatibility with Rust projects across different environments</li></ul></li></ol><p>In summary, <code>rustc</code> is the Rust compiler used for compiling Rust code, <code>cargo</code> is the build system and package manager for Rust projects, and <code>rustup</code> is the toolchain installer and manager for managing Rust installations and associated tools. Together, these tools form the foundation of the Rust development ecosystem, enabling efficient and reliable development of Rust applications.</p><h4 id="19-45-Starting-with-a-classic-project-like-Conway’s-Game-of-Life"><a href="#19-45-Starting-with-a-classic-project-like-Conway’s-Game-of-Life" class="headerlink" title="19:45 Starting with a classic project like Conway’s Game of Life"></a>19:45 Starting with a classic project like Conway’s Game of Life</h4><p>いよいよ本気に初めてのプロジェクトを開始します。</p><figure class="highlight rust"><table><tr><td class="code"><pre><span class="line">cargo new game_of_life</span><br><span class="line">code game_of_life</span><br></pre></td></tr></table></figure><p>ChatGPTに教えられた骨格を利用します。（ここだけコピペ）</p><figure class="highlight rs"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Your main.rs file</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">GameOfLife</span> &#123;</span><br><span class="line">    <span class="comment">// Define your game board here</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">GameOfLife</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">new</span>(width: <span class="type">usize</span>, height: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="comment">// Initialize the game board</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        GameOfLife &#123;</span><br><span class="line">            <span class="comment">// Initialize your fields here</span></span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">update</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="comment">// Update the game board based on the rules of the game</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">render</span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="comment">// Render the game board to the console</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">game</span> = GameOfLife::<span class="title function_ invoke__">new</span>(<span class="number">50</span>, <span class="number">30</span>); <span class="comment">// Example size for the board</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">loop</span> &#123;</span><br><span class="line">        game.<span class="title function_ invoke__">update</span>();</span><br><span class="line">        game.<span class="title function_ invoke__">render</span>();</span><br><span class="line">        std::thread::<span class="title function_ invoke__">sleep</span>(std::time::Duration::<span class="title function_ invoke__">from_millis</span>(<span class="number">100</span>)); <span class="comment">// Adjust the speed of the simulation</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>まずは、main()から改修します。<br>ちょっとリテラルのパラメータを切り出し、デバグしやすいようにloopを一旦コメントアウトします。</p><figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">width</span> = <span class="number">50</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">height</span> = <span class="number">30</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">sleep_time</span> = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">game</span> = GameOfLife::<span class="title function_ invoke__">new</span>(width, height);</span><br><span class="line">    <span class="comment">// loop &#123;</span></span><br><span class="line">    game.<span class="title function_ invoke__">update</span>();</span><br><span class="line">    game.<span class="title function_ invoke__">render</span>();</span><br><span class="line">    std::thread::<span class="title function_ invoke__">sleep</span>(std::time::Duration::<span class="title function_ invoke__">from_millis</span>(sleep_time));</span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>次に、<code>struct GameOfLife</code>に状態データを保持する場所だろうかと思い、2d配列をこの前教えられたstd::collectionsのVecを使うぐらいの感覚だが、Vecと2次元のVecの使い方を具体的にまた聞きました。</p><h4 id="20-00-20-30-2d-Vecを利用し、struct-GameOfLifeとそのimplのnewの実装"><a href="#20-00-20-30-2d-Vecを利用し、struct-GameOfLifeとそのimplのnewの実装" class="headerlink" title="20:00~20:30 2d Vecを利用し、struct GameOfLifeとそのimplのnewの実装"></a>20:00~20:30 2d Vecを利用し、<code>struct GameOfLife</code>とそのimplの<code>new</code>の実装</h4><figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">GameOfLife</span> &#123;</span><br><span class="line">    width: <span class="type">usize</span>,</span><br><span class="line">    height: <span class="type">usize</span>,</span><br><span class="line">    cells: <span class="type">Vec</span>&lt;<span class="type">Vec</span>&lt;<span class="type">bool</span>&gt;&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">GameOfLife</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">new</span>(width: <span class="type">usize</span>, height: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">gol</span> = GameOfLife &#123;</span><br><span class="line">            width,</span><br><span class="line">            height,</span><br><span class="line">            cells: <span class="type">Vec</span>::<span class="title function_ invoke__">with_capacity</span>(height),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">for</span> <span class="variable">_</span> <span class="keyword">in</span> <span class="number">0</span>..height &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">row</span> = <span class="type">Vec</span>::<span class="title function_ invoke__">with_capacity</span>(width);</span><br><span class="line">            <span class="keyword">for</span> <span class="variable">_</span> <span class="keyword">in</span> <span class="number">0</span>..width &#123;</span><br><span class="line">                row.<span class="title function_ invoke__">push</span>(<span class="literal">false</span>); <span class="comment">// ここはrandomのtrue/falseする方法が分からない、一旦全部falseに</span></span><br><span class="line">            &#125;</span><br><span class="line">            gol.cells.<span class="title function_ invoke__">push</span>(row);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> gol;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="20-30-20-34-renderの実装"><a href="#20-30-20-34-renderの実装" class="headerlink" title="20:30~20:34 renderの実装"></a>20:30~20:34 <code>render</code>の実装</h4><figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">render</span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">row</span> <span class="keyword">in</span> &amp;<span class="keyword">self</span>.cells &#123;</span><br><span class="line">        <span class="keyword">for</span> <span class="variable">cell</span> <span class="keyword">in</span> row &#123;</span><br><span class="line">            <span class="keyword">if</span> *cell &#123;</span><br><span class="line">                <span class="built_in">print!</span>(<span class="string">&quot;* &quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">print!</span>(<span class="string">&quot;. &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">print!</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">print!</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>初期状態の出力ができました！</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . </span><br><span class="line">. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . </span><br><span class="line">. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . </span><br><span class="line">. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . </span><br><span class="line">. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . </span><br><span class="line">. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . </span><br><span class="line">. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . </span><br><span class="line">. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . </span><br><span class="line">. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . </span><br><span class="line">. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . </span><br><span class="line">. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . </span><br><span class="line">. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . </span><br><span class="line">. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . </span><br><span class="line">. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . </span><br><span class="line">. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . </span><br><span class="line">. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . </span><br><span class="line">. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . </span><br><span class="line">. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . </span><br><span class="line">. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . </span><br><span class="line">. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . </span><br><span class="line">. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . </span><br><span class="line">. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . </span><br><span class="line">. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . </span><br><span class="line">. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . </span><br><span class="line">. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . </span><br><span class="line">. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . </span><br><span class="line">. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . </span><br><span class="line">. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . </span><br><span class="line">. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . </span><br><span class="line">. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . </span><br></pre></td></tr></table></figure><h4 id="20-34-20-37-ランダム値の生成方法を習得"><a href="#20-34-20-37-ランダム値の生成方法を習得" class="headerlink" title="20:34~20:37 ランダム値の生成方法を習得"></a>20:34~20:37 ランダム値の生成方法を習得</h4><p>Cargo.tomlのdependenciesに<a href="https://crates.io/crates/rand">rand</a>というcratesとそのバージョンを記載します。</p><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">rand</span> = <span class="string">&quot;0.8.5&quot;</span></span><br></pre></td></tr></table></figure><p>プログラミング先頭にuse文を入れて、ランダム使うところで、<code>random()</code>をこの前のダミーの<code>false</code>を入れ替える。型は推論してくれるらしいです(ここはbool。i32やf64でも同じ書き方で、自動的に推論できて素晴らしい)。</p><figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="keyword">use</span> rand::prelude::random;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">// row.push(false);</span></span><br><span class="line">row.<span class="title function_ invoke__">push</span>(<span class="title function_ invoke__">random</span>());</span><br></pre></td></tr></table></figure><p>ランダムの初期状態の出力ができた！</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">. . * * * * * * . . * . . . . . * * * * * . * . * * . * . . . . * . * . * . . . . . . . * . . * . . </span><br><span class="line">* . * * * * * . . . . . * * . * . . * . * . * . . . . . . * * . . . . * * * . . . * * . . * . . . * </span><br><span class="line">* . . . . . . . * . * * . * . * * * . * * . * . * . . * . * . . . * . * . * * * * . * * . . * . * * </span><br><span class="line">* . . * * * . * . . . * * . * . * * . * . . * * * * . . * . * * . * * * . * . * . . * . . * . . * . </span><br><span class="line">. . . . * * * * . . . * . * . * * . * * * * . . . . . * . * . * * * * . * * . * . * * * . * * . * . </span><br><span class="line">* * . * * . * . * . . * . * * . * * . * . * . . . . * . * . * * . * . * . . . . * . . * * . . * * * </span><br><span class="line">* . . * * . * * * * * * * * . * . . . . . . * * . * * . * * * . * . . * . * * * . * . . . . * * * * </span><br><span class="line">. . * . * * . * * . * . . * . . * . . * * . * . . . . * * * * * . * * . . . * . * * * . * . . . * . </span><br><span class="line">. . * * * . . . . * . . * . . . . . * . . * . * * . * . . * * . . . . . * . . * . * * . * . * * * . </span><br><span class="line">* . . * * . * . . . . . * * * * . . . . * * * . * * * . * . . . * * . * . . * * . * . . * * . * . * </span><br><span class="line">. * . * . . . . * . . . * . . * * . . . . . . . * . * * * * . * . . . . . * . * * * * . . . . . * * </span><br><span class="line">* * * . . * * . * * * * * * * . * . * * . . . * . . . * * . * * . . * . * . * . * . * * . . * . . * </span><br><span class="line">. * * . * * . * . . . . * * . * . . * . . . * . * . * * . * * . * * . . * * . . . . . . * . . * * . </span><br><span class="line">* . . . . . . . . . . . . * * * . . * * * * . . * . . . . * * * * . * * * * * * * * . . * * . . * . </span><br><span class="line">* * . * . * . . * * * * . . . . . . . . * * . . . * * . . . . . . . * * . . . . . * . * . * . * . * </span><br><span class="line">. . * . * . . * * . * . . * . * . * . . . . * . . * * * . . * . * * * . . . . . * . * * . . * . * . </span><br><span class="line">* * . . . . * . . * . * * . * . * . . * . * . * . * * * . * * * . . . * * . . * . . * . * * . . . * </span><br><span class="line">. * . . . . * * * * * * * * * . . * . . . * . . . . . * * * . . * * . . * * * . . * * * . * . . * . </span><br><span class="line">* . . * . . * * * * * . . . . . * . * . . . . * * * . * * * * * . * . . * . . * . . . . * . . * * . </span><br><span class="line">* . * . * * . * . * . . . * * . . . . * . . . . * * * * * . . * . . * * * * . * * * . * * . * * . . </span><br><span class="line">. . * * * . * . * . * * * . * * . * * . . . * * * * . . * * . . * . . . . * . * . * . * * * * * * . </span><br><span class="line">* . . . * . * * . * * * . * * * . . * * . . . . * * * . . * . * * * . * * . * . * . * . * * * * * . </span><br><span class="line">* * . . . * . * * * . * . . * * . . * . . . * . . . * * . . . . . . * . * * * . . . . * . . . * * . </span><br><span class="line">* . . * . . * . . * . * * * . . . . . . * . * * * . . * . * . * * . * * . . * . * * * * * * * . . . </span><br><span class="line">. . * * * * . * * * * . * * * * * * * . * . . . * . . * * * * . . . . * . . * * . * . * . . . * * * </span><br><span class="line">* . . * * * . . . . * * * * . * . * . . * * * . * . * . * . * * . . . . . . . . . . . . * * * * * * </span><br><span class="line">* . . * * . . . . * * * * * . * . . * . * . . * . . . * * . * . * * . * * . . * . * . . * * . . * . </span><br><span class="line">. * . * . * * . * * . * * . * . * * . . . . . . * . . * * . * . * * * . * * . * . * * * . * . . . * </span><br><span class="line">. . . . . . . . * * * * . . . * . * . * . * . . * . . * * * * * * . . * * * * . * . * . * . . * . * </span><br><span class="line">* . * . * . * . * . . * . . * . . . . * . * . . . * . . * . * . * * . . . * . . . * * * * . . . * . </span><br></pre></td></tr></table></figure><h4 id="20-38-22-00-apply-the-rule"><a href="#20-38-22-00-apply-the-rule" class="headerlink" title="20:38~22:00 apply the rule"></a>20:38~22:00 apply the rule</h4><p>ここからは、だいぶ効率悪くなってきて、苦戦しながらやっていきます。</p><p>ライフゲームのルールは以下です。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">In Conway&#x27;s Game of Life, each cell interacts with its eight neighbors. The rules are:</span><br><span class="line">Any live cell with fewer than two live neighbors dies (underpopulation).</span><br><span class="line">Any live cell with two or three live neighbors survives to the next generation.</span><br><span class="line">Any live cell with more than three live neighbors dies (overpopulation).</span><br><span class="line">Any dead cell with exactly three live neighbors becomes alive (reproduction).</span><br></pre></td></tr></table></figure><p>2次元のVecの初期化や、別fnの切り方、cloneがdeep copyなのか、shallow copyなのか、色々詰まったりしたが、<code>count_neighbors</code>を切り出して少し後回しして、<code>update</code>だけは先に完成させました。</p><p><code>&amp;</code>や<code>mut</code>はどこにつけるべきかがよく迷ったが、コンパイラが親切に怒られてくれるから、なんとかできました。</p><figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="keyword">impl</span> <span class="title class_">GameOfLife</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">count_neighbors</span>(&amp;<span class="keyword">self</span>, r: <span class="type">usize</span>, c: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="type">usize</span> &#123;</span><br><span class="line">        <span class="comment">// TODO</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">update</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">new_cells</span> = <span class="type">Vec</span>::<span class="title function_ invoke__">with_capacity</span>(<span class="keyword">self</span>.height);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> <span class="variable">_</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="keyword">self</span>.height &#123;</span><br><span class="line">            new_cells.<span class="title function_ invoke__">push</span>(<span class="built_in">vec!</span>[<span class="literal">false</span>; <span class="keyword">self</span>.width]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> <span class="variable">r</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="keyword">self</span>.height &#123;</span><br><span class="line">            <span class="keyword">for</span> <span class="variable">c</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="keyword">self</span>.width &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="variable">neighbors</span> = <span class="keyword">self</span>.<span class="title function_ invoke__">count_neighbors</span>(r, c);</span><br><span class="line">                <span class="keyword">match</span> neighbors &#123;</span><br><span class="line">                    <span class="number">0</span>..=<span class="number">1</span> =&gt; new_cells[r][c] = <span class="literal">false</span>,</span><br><span class="line">                    <span class="number">2</span> =&gt; new_cells[r][c] = <span class="keyword">self</span>.cells[r][c],</span><br><span class="line">                    <span class="number">3</span> =&gt; new_cells[r][c] = <span class="literal">true</span>,</span><br><span class="line">                    _ =&gt; new_cells[r][c] = <span class="literal">false</span>,</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>.cells = new_cells;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>次に、<code>count_neighbors</code>も完成した。分岐が多すぎて全然美しくないですが…。</p><p>三項演算子<code>cond?a:b</code>はないらしいが、<code>if cond &#123;a&#125; else &#123;b&#125;</code>は該当する使い方がグーグルして分かりました。<br>調べると、ブロックの最後が <code>;</code> のない式であれば、戻り値として使用されるからですね！（関数型言語の特徴かな？）</p><figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">count_neighbors</span>(&amp;<span class="keyword">self</span>, r: <span class="type">usize</span>, c: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="type">usize</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">cnt</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> r &gt; <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> c &gt; <span class="number">0</span> &#123;</span><br><span class="line">            cnt += <span class="keyword">if</span> <span class="keyword">self</span>.cells[r - <span class="number">1</span>][c - <span class="number">1</span>] &#123; <span class="number">1</span> &#125; <span class="keyword">else</span> &#123; <span class="number">0</span> &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        cnt += <span class="keyword">if</span> <span class="keyword">self</span>.cells[r - <span class="number">1</span>][c] &#123; <span class="number">1</span> &#125; <span class="keyword">else</span> &#123; <span class="number">0</span> &#125;;</span><br><span class="line">        <span class="keyword">if</span> c &lt; <span class="keyword">self</span>.width - <span class="number">1</span> &#123;</span><br><span class="line">            cnt += <span class="keyword">if</span> <span class="keyword">self</span>.cells[r - <span class="number">1</span>][c + <span class="number">1</span>] &#123; <span class="number">1</span> &#125; <span class="keyword">else</span> &#123; <span class="number">0</span> &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> c &gt; <span class="number">0</span> &#123;</span><br><span class="line">        cnt += <span class="keyword">if</span> <span class="keyword">self</span>.cells[r][c - <span class="number">1</span>] &#123; <span class="number">1</span> &#125; <span class="keyword">else</span> &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> c &lt; <span class="keyword">self</span>.width - <span class="number">1</span> &#123;</span><br><span class="line">        cnt += <span class="keyword">if</span> <span class="keyword">self</span>.cells[r][c + <span class="number">1</span>] &#123; <span class="number">1</span> &#125; <span class="keyword">else</span> &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> r &lt; <span class="keyword">self</span>.height - <span class="number">1</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> c &gt; <span class="number">0</span> &#123;</span><br><span class="line">            cnt += <span class="keyword">if</span> <span class="keyword">self</span>.cells[r + <span class="number">1</span>][c - <span class="number">1</span>] &#123; <span class="number">1</span> &#125; <span class="keyword">else</span> &#123; <span class="number">0</span> &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        cnt += <span class="keyword">if</span> <span class="keyword">self</span>.cells[r + <span class="number">1</span>][c] &#123; <span class="number">1</span> &#125; <span class="keyword">else</span> &#123; <span class="number">0</span> &#125;;</span><br><span class="line">        <span class="keyword">if</span> c &lt; <span class="keyword">self</span>.width - <span class="number">1</span> &#123;</span><br><span class="line">            cnt += <span class="keyword">if</span> <span class="keyword">self</span>.cells[r + <span class="number">1</span>][c + <span class="number">1</span>] &#123; <span class="number">1</span> &#125; <span class="keyword">else</span> &#123; <span class="number">0</span> &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cnt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="22-00-Completed"><a href="#22-00-Completed" class="headerlink" title="22:00 Completed"></a>22:00 Completed</h4><p>最終的に次のコードが完成形です。</p><figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="keyword">use</span> rand::prelude::random;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">GameOfLife</span> &#123;</span><br><span class="line">    width: <span class="type">usize</span>,</span><br><span class="line">    height: <span class="type">usize</span>,</span><br><span class="line">    cells: <span class="type">Vec</span>&lt;<span class="type">Vec</span>&lt;<span class="type">bool</span>&gt;&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">GameOfLife</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">new</span>(width: <span class="type">usize</span>, height: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">gol</span> = GameOfLife &#123;</span><br><span class="line">            width,</span><br><span class="line">            height,</span><br><span class="line">            cells: <span class="type">Vec</span>::<span class="title function_ invoke__">with_capacity</span>(height),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">for</span> <span class="variable">_</span> <span class="keyword">in</span> <span class="number">0</span>..height &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">row</span> = <span class="type">Vec</span>::<span class="title function_ invoke__">with_capacity</span>(width);</span><br><span class="line">            <span class="keyword">for</span> <span class="variable">_</span> <span class="keyword">in</span> <span class="number">0</span>..width &#123;</span><br><span class="line">                row.<span class="title function_ invoke__">push</span>(<span class="title function_ invoke__">random</span>());</span><br><span class="line">            &#125;</span><br><span class="line">            gol.cells.<span class="title function_ invoke__">push</span>(row);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> gol;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">count_neighbors</span>(&amp;<span class="keyword">self</span>, r: <span class="type">usize</span>, c: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="type">usize</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">cnt</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> r &gt; <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> c &gt; <span class="number">0</span> &#123;</span><br><span class="line">                cnt += <span class="keyword">if</span> <span class="keyword">self</span>.cells[r - <span class="number">1</span>][c - <span class="number">1</span>] &#123; <span class="number">1</span> &#125; <span class="keyword">else</span> &#123; <span class="number">0</span> &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">            cnt += <span class="keyword">if</span> <span class="keyword">self</span>.cells[r - <span class="number">1</span>][c] &#123; <span class="number">1</span> &#125; <span class="keyword">else</span> &#123; <span class="number">0</span> &#125;;</span><br><span class="line">            <span class="keyword">if</span> c &lt; <span class="keyword">self</span>.width - <span class="number">1</span> &#123;</span><br><span class="line">                cnt += <span class="keyword">if</span> <span class="keyword">self</span>.cells[r - <span class="number">1</span>][c + <span class="number">1</span>] &#123; <span class="number">1</span> &#125; <span class="keyword">else</span> &#123; <span class="number">0</span> &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> c &gt; <span class="number">0</span> &#123;</span><br><span class="line">            cnt += <span class="keyword">if</span> <span class="keyword">self</span>.cells[r][c - <span class="number">1</span>] &#123; <span class="number">1</span> &#125; <span class="keyword">else</span> &#123; <span class="number">0</span> &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> c &lt; <span class="keyword">self</span>.width - <span class="number">1</span> &#123;</span><br><span class="line">            cnt += <span class="keyword">if</span> <span class="keyword">self</span>.cells[r][c + <span class="number">1</span>] &#123; <span class="number">1</span> &#125; <span class="keyword">else</span> &#123; <span class="number">0</span> &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> r &lt; <span class="keyword">self</span>.height - <span class="number">1</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> c &gt; <span class="number">0</span> &#123;</span><br><span class="line">                cnt += <span class="keyword">if</span> <span class="keyword">self</span>.cells[r + <span class="number">1</span>][c - <span class="number">1</span>] &#123; <span class="number">1</span> &#125; <span class="keyword">else</span> &#123; <span class="number">0</span> &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">            cnt += <span class="keyword">if</span> <span class="keyword">self</span>.cells[r + <span class="number">1</span>][c] &#123; <span class="number">1</span> &#125; <span class="keyword">else</span> &#123; <span class="number">0</span> &#125;;</span><br><span class="line">            <span class="keyword">if</span> c &lt; <span class="keyword">self</span>.width - <span class="number">1</span> &#123;</span><br><span class="line">                cnt += <span class="keyword">if</span> <span class="keyword">self</span>.cells[r + <span class="number">1</span>][c + <span class="number">1</span>] &#123; <span class="number">1</span> &#125; <span class="keyword">else</span> &#123; <span class="number">0</span> &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> cnt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">update</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">new_cells</span> = <span class="type">Vec</span>::<span class="title function_ invoke__">with_capacity</span>(<span class="keyword">self</span>.height);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> <span class="variable">_</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="keyword">self</span>.height &#123;</span><br><span class="line">            new_cells.<span class="title function_ invoke__">push</span>(<span class="built_in">vec!</span>[<span class="literal">false</span>; <span class="keyword">self</span>.width]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> <span class="variable">r</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="keyword">self</span>.height &#123;</span><br><span class="line">            <span class="keyword">for</span> <span class="variable">c</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="keyword">self</span>.width &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="variable">neighbors</span> = <span class="keyword">self</span>.<span class="title function_ invoke__">count_neighbors</span>(r, c);</span><br><span class="line">                <span class="keyword">match</span> neighbors &#123;</span><br><span class="line">                    <span class="number">0</span>..=<span class="number">1</span> =&gt; new_cells[r][c] = <span class="literal">false</span>,</span><br><span class="line">                    <span class="number">2</span> =&gt; new_cells[r][c] = <span class="keyword">self</span>.cells[r][c],</span><br><span class="line">                    <span class="number">3</span> =&gt; new_cells[r][c] = <span class="literal">true</span>,</span><br><span class="line">                    _ =&gt; new_cells[r][c] = <span class="literal">false</span>,</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>.cells = new_cells;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">render</span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> <span class="variable">row</span> <span class="keyword">in</span> &amp;<span class="keyword">self</span>.cells &#123;</span><br><span class="line">            <span class="keyword">for</span> <span class="variable">cell</span> <span class="keyword">in</span> row &#123;</span><br><span class="line">                <span class="keyword">if</span> *cell &#123;</span><br><span class="line">                    <span class="built_in">print!</span>(<span class="string">&quot;* &quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">print!</span>(<span class="string">&quot;. &quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">print!</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">print!</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">width</span> = <span class="number">50</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">height</span> = <span class="number">30</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">sleep_time</span> = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">game</span> = GameOfLife::<span class="title function_ invoke__">new</span>(width, height);</span><br><span class="line">    <span class="keyword">loop</span> &#123;</span><br><span class="line">        game.<span class="title function_ invoke__">update</span>();</span><br><span class="line">        game.<span class="title function_ invoke__">render</span>();</span><br><span class="line">        std::thread::<span class="title function_ invoke__">sleep</span>(std::time::Duration::<span class="title function_ invoke__">from_millis</span>(sleep_time));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>cargo run</code> の実行結果です。</p><img src="/images/20240322a/Screen_Recording_2024-03-18_at_0.28.59.gif" alt="Screen_Recording_2024-03-18_at_0.28.59.gif" width="1200" height="729" loading="lazy"><h2 id="Next-Step"><a href="#Next-Step" class="headerlink" title="Next Step"></a>Next Step</h2><ul><li>現在はランダムな開始状態でスタートするしか対応していないが、<a href="https://conwaylife.com/wiki/Run_Length_Encoded">RLE</a>フォーマットなどのパターンファイルを読むようにしたい</li><li>現在は固定なステージサイズになっているが、動的に拡大するなり、Rustの威力を発揮できる並行計算を試したい</li><li>Rust+WebAssemblyを使ってブラウザ上でUIを作りたい</li></ul><h2 id="感想"><a href="#感想" class="headerlink" title="感想"></a>感想</h2><ul><li>Rustが古くはないが、割とC&#x2F;C++のようにローレベルで、型やメモリの形態などをケアする言語であり、コーディングゼロ経験の人にPythonやJavaScriptほど優しくない</li><li>型推論が限界までやってくれてすごく優秀で、好きになる理由の一つ</li><li>コンパイラが厳しくて、コーディングのあるべきをちゃんと教えてくれるので、とても勉強になる</li></ul><h2 id="他の良い学習リソース"><a href="#他の良い学習リソース" class="headerlink" title="他の良い学習リソース"></a>他の良い学習リソース</h2><p>Rust Documentation<br><a href="https://doc.rust-lang.org/beta/">https://doc.rust-lang.org/beta/</a></p><p>Official Learn Rust<br><a href="https://www.rust-lang.org/learn">https://www.rust-lang.org/learn</a></p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h2&gt;&lt;p&gt;週末を利活用したく、新しい言語をゼロから学習して即戦力を備えるまでどのぐらいかかるかを実験してみました。&lt;/p&gt;
&lt;h4</summary>
        
      
    
    
    
    <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
    <category term="初心者向け" scheme="https://future-architect.github.io/tags/%E5%88%9D%E5%BF%83%E8%80%85%E5%90%91%E3%81%91/"/>
    
    <category term="Rust" scheme="https://future-architect.github.io/tags/Rust/"/>
    
    <category term="ChatGPT" scheme="https://future-architect.github.io/tags/ChatGPT/"/>
    
    <category term="Conways_Game_of_Life" scheme="https://future-architect.github.io/tags/Conways-Game-of-Life/"/>
    
  </entry>
  
  <entry>
    <title>Terraform連載2024 テストとモックを使ってみる</title>
    <link href="https://future-architect.github.io/articles/20240321a/"/>
    <id>https://future-architect.github.io/articles/20240321a/</id>
    <published>2024-03-20T15:00:00.000Z</published>
    <updated>2024-03-21T01:27:34.967Z</updated>
    
    <content type="html"><![CDATA[<img src="/images/20240321a/top.png" alt="" width="800" height="555"><p><a href="/articles/20240311a/">Terraform連載2024を</a> の7本目です。</p><h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>こんにちは！ TIG Chill Architect の前原です。<br>Terraform を使ってクラウド環境とか構築する人は多くいると思います。<br>その中で毎回のようにどうやってテストをやるべきなのかなーとか悩んで、結果大したことも出来ずにリリースまで来てしまったということはないでしょうか。</p><p>今回は、その悩みを少しでも払拭できないかと思い、Terraform v1.6 とv1.7 で提供された<a href="https://developer.hashicorp.com/terraform/language/tests">tests</a>と<a href="https://developer.hashicorp.com/terraform/language/tests/mocking">mocks</a>に触れていきたいと思います。</p><h1 id="今までの試み"><a href="#今までの試み" class="headerlink" title="今までの試み"></a>今までの試み</h1><p>今までは、<a href="https://github.com/terraform-linters/tflint">TFLint</a>を導入し、コードチェックを行うことを実施していました。</p><p>ただし、この方式だと静的コード解析のため、より踏み込んだところまでいけませんでした。静的コード解析にプラスして動的なテストができると良いなーって感じていました。（<a href="https://github.com/gruntwork-io/terratest">terratest</a>というのもありますが、導入コストが高い）</p><h1 id="terraform-test"><a href="#terraform-test" class="headerlink" title="terraform test"></a>terraform test</h1><p><code>terraform test</code>は、実際にコードを実行し、動的にテストを行うことができます。</p><p>これによりコードの信頼性、品質を高めることができます。</p><p>module に対してのテストが強力ですが、module 以外でも利用可能です。</p><h2 id="こんなことができる"><a href="#こんなことができる" class="headerlink" title="こんなことができる"></a>こんなことができる</h2><p><code>terraform test</code> は、以下のようなことができます（他にもできることがある）</p><ul><li><code>terraform plan</code> を実行し、期待する結果が得られるかを確認することができる</li><li><code>terraorm apply</code> を実行した時に期待する結果が得られるかを確認することができる<ul><li>実際にリソースを作成し、削除まで行う</li></ul></li><li>期待する結果を<code>condition</code>に書いて判定を行う</li><li>Data Source を取得できる</li></ul><h2 id="実際に動かしてみる"><a href="#実際に動かしてみる" class="headerlink" title="実際に動かしてみる"></a>実際に動かしてみる</h2><p>それでは、実際に簡単なコードを作成して動かしてみたいと思います。<br>Terraform のバージョンは、1.6以上にしてください。<br>バージョンの切り替えが面倒だなって思ったら<a href="https://github.com/tfutils/tfenv">tfenv</a>をインストールすると少し幸せになれます。<br>また、クラウドは、AWS です。</p><p>S3 バケットを作成し、そのS3 バケット名が期待する名前なのかをテストするコードを書きたいと思います。<br>正直、このコードがテスト用途として必要か？というのはありますが、まずは慣れるというのを目的にしたいと思います。</p><p>ディレクトリは、以下の構成です。</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">.</span><br><span class="line">├── backend.tf</span><br><span class="line">├── local.tf</span><br><span class="line">├── s3_bucket.tf</span><br><span class="line">├── s3_bucket.tftest.hcl</span><br><span class="line">└── versions.tf</span><br></pre></td></tr></table></figure><p>コードは、以下です。<br><code>backend.tf</code> を省略していますが、よしなにお願いします。</p><figure class="highlight sh"><figcaption><span>local.tf</span></figcaption><table><tr><td class="code"><pre><span class="line">locals &#123;</span><br><span class="line">  project_name  = <span class="string">&quot;sample&quot;</span></span><br><span class="line">  region        = <span class="string">&quot;ap-northeast-1&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight sh"><figcaption><span>s3_bucket.tf</span></figcaption><table><tr><td class="code"><pre><span class="line">resource <span class="string">&quot;aws_s3_bucket&quot;</span> <span class="string">&quot;test001&quot;</span> &#123;</span><br><span class="line">  bucket = <span class="string">&quot;<span class="variable">$&#123;terraform.workspace&#125;</span>-<span class="variable">$&#123;local.project_name&#125;</span>-test001&quot;</span></span><br><span class="line">  tags = &#123;</span><br><span class="line">    Name        = <span class="string">&quot;<span class="variable">$&#123;terraform.workspace&#125;</span>-<span class="variable">$&#123;local.project_name&#125;</span>-test001&quot;</span></span><br><span class="line">    Environment = terraform.workspace</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight sh"><figcaption><span>versions.tf</span></figcaption><table><tr><td class="code"><pre><span class="line">terraform &#123;</span><br><span class="line">  required_version = <span class="string">&quot;~&gt; 1.7.5&quot;</span></span><br><span class="line">  required_providers &#123;</span><br><span class="line">    aws = &#123;</span><br><span class="line">      <span class="built_in">source</span>  = <span class="string">&quot;hashicorp/aws&quot;</span></span><br><span class="line">      version = <span class="string">&quot;5.41.0&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">provider <span class="string">&quot;aws&quot;</span> &#123;</span><br><span class="line">  region = local.region</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>テストコードを作成します。<br>conditionに記述したS3 バケット名と実際のS3 バケット名を比較して問題ないかをチェックしています。<br>仮に期待していない値の場合は、<code>error_message</code>の値が出力されます。</p><figure class="highlight sh"><figcaption><span>s3_bucket.tftest.hcl</span></figcaption><table><tr><td class="code"><pre><span class="line">run <span class="string">&quot;test&quot;</span> &#123;</span><br><span class="line">  assert &#123;</span><br><span class="line">    condition     = aws_s3_bucket.test.bucket == <span class="string">&quot;<span class="variable">$&#123;terraform.workspace&#125;</span>-<span class="variable">$&#123;local.project_name&#125;</span>-test&quot;</span></span><br><span class="line">    error_message = <span class="string">&quot;S3 bucket name did not match expected&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>テストが成功した時は、以下の出力となります。</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ terraform <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line">tests/s3_bucket.tftest.hcl... <span class="keyword">in</span> progress</span><br><span class="line">  run <span class="string">&quot;test&quot;</span>... pass</span><br><span class="line">tests/s3_bucket.tftest.hcl... tearing down</span><br><span class="line">tests/s3_bucket.tftest.hcl... pass</span><br><span class="line"></span><br><span class="line">Success! 1 passed, 0 failed.</span><br></pre></td></tr></table></figure><p>失敗した時は、以下です。</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ terraform <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line">tests/s3_bucket.tftest.hcl... <span class="keyword">in</span> progress</span><br><span class="line">  run <span class="string">&quot;test&quot;</span>... fail</span><br><span class="line">╷</span><br><span class="line">│ Error: Test assertion failed</span><br><span class="line">│</span><br><span class="line">│   on tests/s3_bucket.tftest.hcl line 4, <span class="keyword">in</span> run <span class="string">&quot;test&quot;</span>:</span><br><span class="line">│    4:     condition     = aws_s3_bucket.test.bucket == <span class="string">&quot;<span class="variable">$&#123;terraform.workspace&#125;</span>-<span class="variable">$&#123;local.project_name&#125;</span>-test1&quot;</span></span><br><span class="line">│     ├────────────────</span><br><span class="line">│     │ aws_s3_bucket.test.bucket is <span class="string">&quot;dev-sample-test&quot;</span></span><br><span class="line">│     │ local.project_name is <span class="string">&quot;sample&quot;</span></span><br><span class="line">│     │ terraform.workspace is <span class="string">&quot;dev&quot;</span></span><br><span class="line">│</span><br><span class="line">│ S3 bucket name did not match expected</span><br><span class="line">╵</span><br><span class="line">tests/s3_bucket.tftest.hcl... tearing down</span><br><span class="line">tests/s3_bucket.tftest.hcl... fail</span><br><span class="line"></span><br><span class="line">Failure! 0 passed, 1 failed.</span><br></pre></td></tr></table></figure><p>テストファイルをカレントディレクトリに配置していますが、ディレクトリを分けることも可能です。<br>例えば以下のようにすることが可能です。<br><code>tests</code>ディレクトリであればデフォルト指定されているため、読み込まれます。</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">.</span><br><span class="line">├── backend.tf</span><br><span class="line">├── local.tf</span><br><span class="line">├── s3_bucket.tf</span><br><span class="line">├── tests</span><br><span class="line">│   └── s3_bucket.tftest.hcl</span><br><span class="line">└── versions.tf</span><br></pre></td></tr></table></figure><p>別のディレクトリ名で実行したい場合は、以下のように指定することも可能です。</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">terraform <span class="built_in">test</span> -test-directory=hoge</span><br></pre></td></tr></table></figure><p>今回は、<code>apply</code>を実行したのですが、<code>plan</code>を実行したいときは、以下のように<code>command</code>　指定します。</p><figure class="highlight sh"><figcaption><span>s3_bucket.tftest.hcl</span></figcaption><table><tr><td class="code"><pre><span class="line">run <span class="string">&quot;test&quot;</span> &#123;</span><br><span class="line">  <span class="built_in">command</span> = plan</span><br><span class="line">  assert &#123;</span><br><span class="line">    condition     = aws_s3_bucket.test.bucket == <span class="string">&quot;<span class="variable">$&#123;terraform.workspace&#125;</span>-<span class="variable">$&#123;local.project_name&#125;</span>-test&quot;</span></span><br><span class="line">    error_message = <span class="string">&quot;S3 bucket name did not match expected&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意としては、<code>apply</code>を実行する際に既にリソースが作成されている場合は、以下のエラーが出力されます。</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ terraform <span class="built_in">test</span></span><br><span class="line">sample.tftest.hcl... <span class="keyword">in</span> progress</span><br><span class="line">  run <span class="string">&quot;sample&quot;</span>... fail</span><br><span class="line">╷</span><br><span class="line">│ Error: creating S3 Bucket (dev-sample-test): operation error S3: CreateBucket, https response error StatusCode: 409, RequestID: 5FC2KQ07G6SGK0W1, HostID: uhahHveFHZBJiEnSDfTsnqVd6gQBmRx+GabbLzMB2jlBkxlPGjblnyuY17MHMoo3UC2uODLSMWk=, BucketAlreadyOwnedByYou:</span><br></pre></td></tr></table></figure><h1 id="terraform-mock"><a href="#terraform-mock" class="headerlink" title="terraform mock"></a>terraform mock</h1><p><code>terraform test</code> は、非常に便利で日々の運用を良くするための強力なツールであることがわかるかと思います。<br>ただ、ローカル開発する中で強力なキーを持たせたくないや、使用できない状況があると思います。<br>また、CI を回すためにも必要といったケースもあるかと思います。<br>そういった時に便利な<code>terraform mock</code>を使っていきたいと思います。</p><h2 id="実際に動かしてみる-1"><a href="#実際に動かしてみる-1" class="headerlink" title="実際に動かしてみる"></a>実際に動かしてみる</h2><p>ディレクトリは、以下の構成です。</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">.</span><br><span class="line">├── backend.tf</span><br><span class="line">├── local.tf</span><br><span class="line">├── mocked_providers.tftest.hcl</span><br><span class="line">├── s3_bucket.tf</span><br><span class="line">├── s3_bucket.tftest.hcl</span><br><span class="line">└── versions.tf</span><br></pre></td></tr></table></figure><p><code>terraform test</code> をベースに作成しているため差分のみを記載します。<br>以下にモック用のプロバイダを指定します。</p><figure class="highlight sh"><figcaption><span>mocked_providers.tftest.hcl</span></figcaption><table><tr><td class="code"><pre><span class="line">mock_provider <span class="string">&quot;aws&quot;</span> &#123;</span><br><span class="line">  <span class="built_in">alias</span> = <span class="string">&quot;fake&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run <span class="string">&quot;use_mocked_provider&quot;</span> &#123;</span><br><span class="line">  providers = &#123;</span><br><span class="line">    aws = aws.fake</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>versions.tf</code>のprovider 定義を削除します。</p><figure class="highlight sh"><figcaption><span>versions.tf</span></figcaption><table><tr><td class="code"><pre><span class="line">terraform &#123;</span><br><span class="line">  required_version = <span class="string">&quot;~&gt; 1.7.5&quot;</span></span><br><span class="line">  required_providers &#123;</span><br><span class="line">    aws = &#123;</span><br><span class="line">      <span class="built_in">source</span>  = <span class="string">&quot;hashicorp/aws&quot;</span></span><br><span class="line">      version = <span class="string">&quot;5.41.0&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>モックを動かす際も<code>terraform test</code> コマンドを使用します。<br>実際に実行したいと思います。<br>アクセスキーを利用せずとも実行できることが確認できるかと思います。</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ terraform <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line">mocked_providers.tftest.hcl... <span class="keyword">in</span> progress</span><br><span class="line">  run <span class="string">&quot;use_mocked_provider&quot;</span>... pass</span><br><span class="line">mocked_providers.tftest.hcl... tearing down</span><br><span class="line">mocked_providers.tftest.hcl... pass</span><br><span class="line">s3_bucket.tftest.hcl... <span class="keyword">in</span> progress</span><br><span class="line">  run <span class="string">&quot;test&quot;</span>... pass</span><br><span class="line">s3_bucket.tftest.hcl... tearing down</span><br><span class="line">s3_bucket.tftest.hcl... pass</span><br><span class="line"></span><br><span class="line">Success! 2 passed, 0 failed.</span><br></pre></td></tr></table></figure><p>もしモックと<code>terraform test</code>のように実際のリソースに対してテストを行いたい場合は、以下のプロバイダ指定で行うことができます。</p><figure class="highlight sh"><figcaption><span>mocked_providers.tftest.hcl</span></figcaption><table><tr><td class="code"><pre><span class="line">provider <span class="string">&quot;aws&quot;</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">mock_provider <span class="string">&quot;aws&quot;</span> &#123;</span><br><span class="line">  <span class="built_in">alias</span> = <span class="string">&quot;fake&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run <span class="string">&quot;use_real_provider&quot;</span> &#123;</span><br><span class="line">  providers = &#123;</span><br><span class="line">    aws = aws</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run <span class="string">&quot;use_mocked_provider&quot;</span> &#123;</span><br><span class="line">  providers = &#123;</span><br><span class="line">    aws = aws.fake</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>他にもモックで返される値をよしなに変更するといったことも可能です。</p><h2 id="どういったケースで使うのがいいのだろうか"><a href="#どういったケースで使うのがいいのだろうか" class="headerlink" title="どういったケースで使うのがいいのだろうか"></a>どういったケースで使うのがいいのだろうか</h2><p>すべてのリソースに対して無邪気にテストコードを書くのは、とても非効率です。<br>そのため、テストを行う場合の考慮すべきポイントを以下にまとめたいと思います。<br>（個人的なポイントのため、あくまで参考レベルです）</p><h3 id="クリティカルなインフラ系のリソース"><a href="#クリティカルなインフラ系のリソース" class="headerlink" title="クリティカルなインフラ系のリソース"></a>クリティカルなインフラ系のリソース</h3><p>セキュリティグループ、IAMポリシー、VPC設定など、セキュリティやアプリケーションの正常な動作に直接影響を与えるクリティカルなインフラ系のリソースに対してテストを行うのが良いと思います。</p><h3 id="依存関係のあるリソース"><a href="#依存関係のあるリソース" class="headerlink" title="依存関係のあるリソース"></a>依存関係のあるリソース</h3><p>複数のリソース間で複雑な依存関係を持つパターン（例えば、セキュリティグループのルールが特定のリソースに依存している場合など）<br>これらの依存関係を正確に反映しているかを確認するときに良いと思います。</p><h3 id="コストに大きな影響を与えるリソース"><a href="#コストに大きな影響を与えるリソース" class="headerlink" title="コストに大きな影響を与えるリソース"></a>コストに大きな影響を与えるリソース</h3><p>インスタンスタイプによっては、大きくコストに跳ねるため、サイズ、数などをテストすることは有効です。<br>これにより、予期しないコストの発生を防ぐことができます。</p><h3 id="変更頻度の高いリソース"><a href="#変更頻度の高いリソース" class="headerlink" title="変更頻度の高いリソース"></a>変更頻度の高いリソース</h3><p>変更頻度が高いとミスが発生する可能性が高くなります。<br>そのため、それらに対してテストを行うのは有効かと思います。</p><h3 id="モジュール"><a href="#モジュール" class="headerlink" title="モジュール"></a>モジュール</h3><p>モジュールは、複数のリソースを包括的に管理するため、複雑な構成となります。<br>モジュールの期待する結果をテストでカバーすることができるため、再利用性、品質の向上につながるかと思います。</p><h1 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h1><p>いかがでしたでしょうか。<br>今回紹介したTerraform の機能を利用することで少しでもテストの有効性や導入のきっかけになれば幸いです。</p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul><li><a href="https://www.hashicorp.com/blog/terraform-1-7-adds-test-mocking-and-config-driven-remove">Terraform 1.7 adds test mocking and config-driven remove</a></li><li><a href="https://developer.hashicorp.com/terraform/tutorials/configuration-language/test">Write Terraform Tests</a></li><li><a href="https://developer.hashicorp.com/terraform/language/tests/mocking#mock-provider-data">Mocks</a></li><li><a href="https://developer.hashicorp.com/terraform/language/tests">Tests</a></li></ul>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;img src=&quot;/images/20240321a/top.png&quot; alt=&quot;&quot; width=&quot;800&quot; height=&quot;555&quot;&gt;

&lt;p&gt;&lt;a href=&quot;/articles/20240311a/&quot;&gt;Terraform連載2024を&lt;/a&gt;</summary>
        
      
    
    
    
    <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
    <category term="Terraform" scheme="https://future-architect.github.io/tags/Terraform/"/>
    
    <category term="terraform test" scheme="https://future-architect.github.io/tags/terraform-test/"/>
    
    <category term="terraform mock" scheme="https://future-architect.github.io/tags/terraform-mock/"/>
    
  </entry>
  
  <entry>
    <title>cfn-guardを使ってTerraformをポリシーチェックしようとした話</title>
    <link href="https://future-architect.github.io/articles/20240318a/"/>
    <id>https://future-architect.github.io/articles/20240318a/</id>
    <published>2024-03-17T15:00:00.000Z</published>
    <updated>2024-03-18T04:40:03.505Z</updated>
    
    <content type="html"><![CDATA[<p><a href="/articles/20240311a/">Terraform連載2024を</a> の6本目です。</p><h2 id="導入"><a href="#導入" class="headerlink" title="導入"></a>導入</h2><p>インフラエンジニアとして働いているTIGの原木です。</p><p>cfn-guardを使用してTerraformをポリシーチェックしようとした話をします。</p><h2 id="cfn-guardとは？"><a href="#cfn-guardとは？" class="headerlink" title="cfn-guardとは？"></a>cfn-guardとは？</h2><p>cfn-guardのcfnとはAWSのCloudFormation(AWSのIaCソリューションのこと)の略称です。</p><p>このツールはCloudFormationを使ってAWSのリソースをデプロイするときにその内容をチェックするポリシーチェックツールとしてよく使われています。</p><p>しかし、cfn-guardはその名前に反して、CloudFormationに限らず、JSON&#x2F;YAMLファイルに対する汎用的なポリシーチェックツールとしても使用することができます。</p><p>READMEの記載にも、次の通り説明があります。</p><blockquote><p>Guard offers a policy-as-code domain-specific language (DSL) to write rules and validate JSON- and YAML-formatted data such as CloudFormation Templates, K8s configurations, and Terraform JSON plans&#x2F;configurations against those rules.</p><p>Guardは、CloudFormationテンプレート、K8sコンフィグレーション、TerraformのJSONプラン&#x2F;コンフィグレーションなどのJSONやYAMLフォーマットのデータに対して、ルールを記述し検証するためのPolicy as Codeなドメイン固有言語(DSL)を提供します。</p></blockquote><p>AWS Certified Securityの勉強をしていて本ツールの名前を知り、READMEを見て、自分は興味を持ちました。</p><h2 id="cfn-guardでTerraformをチェックしようとしたモチベーション"><a href="#cfn-guardでTerraformをチェックしようとしたモチベーション" class="headerlink" title="cfn-guardでTerraformをチェックしようとしたモチベーション"></a>cfn-guardでTerraformをチェックしようとしたモチベーション</h2><p>Terraformのポリシーチェックとしては、過去にFuture技術ブログで紹介したtflintやterraform validator<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>、tfsec<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup>等すでに様々なツールがあります。</p><p>その中でなぜあえて、cfn-guardをTerraform planをチェックしようとしたのか？</p><p>それはcfn-guardに読み込ませるルール表となるCFn Guard DSLとAWSマネージドサービスの力を借りてインフラをデプロイする前から後まで一貫したポリシーチェックができるのではないか。と考えたためです。</p><p>一度CFn Guard DSL(ポリシールール)を書くことで二度おいしいメリットがあると考えました。</p><ul><li>Terraformのコーディング中に、cfn-guardによりユニットテストを動かす感覚でポリシーチェックを随時できるようになります</li><li>Terraformを使ってAWSインフラを構築後、意図しない形でリソースが変更されてもAWS ConfigによりトリガーされたCFn Guardルールのスキャンによってインフラのドリフトを検知できるようになります</li></ul><p><a href="https://speakerdeck.com/ohmura/policy-as-code-with-cloudformation-guard?slide=7">CloudFormation Guard で Policy as Code！ 実際どうよ？ &#x2F; Policy as Code with CloudFormation Guard</a>のスライドをお借りすると次のようなイメージです。</p><img src="/images/20240318a/image.png" alt="image.png" width="1200" height="682" loading="lazy"><p>このような <strong>青写真</strong> を描きました。</p><p>このブログでは、cfn-guardを検証し…そして、思ってたのと違った!!という話をしたいと思います。</p><h2 id="なにはともあれ実践してみよう"><a href="#なにはともあれ実践してみよう" class="headerlink" title="なにはともあれ実践してみよう"></a>なにはともあれ実践してみよう</h2><p>一番基礎的な使い方として、S3ファイルをデプロイするterraformのファイルをチェックする方法について書きたいと思います。</p><p>前提として、cfn-guardはHCLファイル(要は.tfファイル)を直接チェックできず、JSON&#x2F;YAMLファイルを読み込ませないといけないので、 <code>terraform plan</code> の実行結果からJSONファイルを作成する必要があります。</p><p>下記のようにS3バケットを作成するHCLファイルがあったとしましょう。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># provider等は省略します</span></span><br><span class="line">resource <span class="string">&quot;aws_s3_bucket&quot;</span> <span class="string">&quot;my_bucket&quot;</span> &#123;</span><br><span class="line">  bucket = <span class="string">&quot;my-bucket&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource <span class="string">&quot;aws_s3_bucket_public_access_block&quot;</span> <span class="string">&quot;my_bucket&quot;</span> &#123;</span><br><span class="line">  bucket = aws_s3_bucket.my_bucket.id</span><br><span class="line"></span><br><span class="line">  block_public_acls       = <span class="literal">true</span></span><br><span class="line">  block_public_policy     = <span class="literal">true</span></span><br><span class="line">  ignore_public_acls      = <span class="literal">true</span></span><br><span class="line">  restrict_public_buckets = <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>このファイルがまだ未作成の場合、次のようにコマンドを実行することで<br>作成後に想定されるリソース構成をJSONファイルで出力することができます。</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">terraform plan -out tfplan.bin</span><br><span class="line">terraform show --json tfplan.bin &gt; tfplan.json</span><br></pre></td></tr></table></figure><p><code>tfplan.json</code> のファイル構造を分解して中身を見てみましょう。<br>※そのままだと見づらいのでJSONファイルをサブセットであるYAMLファイルに変換して表示します。<br>※YAMLファイルでも素のJSONファイルでもcfn-guardは動かすことができます。</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">format_version:</span> <span class="string">&quot;1.2&quot;</span></span><br><span class="line"><span class="attr">terraform_version:</span> <span class="number">1.6</span><span class="number">.1</span></span><br><span class="line"><span class="attr">planned_values:</span></span><br><span class="line">  <span class="string">//</span> <span class="string">terraformがplanしたリソースの最終的な構成情報</span></span><br><span class="line">  <span class="attr">root_module:</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">address:</span> <span class="string">aws_s3_bucket.my_bucket</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="string">managed</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">aws_s3_bucket</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">my_bucket</span></span><br><span class="line">        <span class="attr">provider_name:</span> <span class="string">registry.terraform.io/hashicorp/aws</span></span><br><span class="line">        <span class="attr">schema_version:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">values:</span></span><br><span class="line">          <span class="attr">bucket:</span> <span class="string">my-bucket1</span></span><br><span class="line">          <span class="attr">force_destroy:</span> <span class="literal">false</span></span><br><span class="line">          <span class="attr">tags:</span> <span class="literal">null</span></span><br><span class="line">          <span class="attr">tags_all:</span></span><br><span class="line">            <span class="attr">env:</span> <span class="string">dev</span></span><br><span class="line">          <span class="attr">timeouts:</span> <span class="literal">null</span></span><br><span class="line">        <span class="attr">sensitive_values:</span></span><br><span class="line">          <span class="attr">cors_rule:</span> []</span><br><span class="line">          <span class="attr">grant:</span> []</span><br><span class="line">          <span class="attr">lifecycle_rule:</span> []</span><br><span class="line">          <span class="attr">logging:</span> []</span><br><span class="line">          <span class="attr">object_lock_configuration:</span> []</span><br><span class="line">          <span class="attr">replication_configuration:</span> []</span><br><span class="line">          <span class="attr">server_side_encryption_configuration:</span> []</span><br><span class="line">          <span class="attr">tags_all:</span> &#123;&#125;</span><br><span class="line">          <span class="attr">versioning:</span> []</span><br><span class="line">          <span class="attr">website:</span> []</span><br><span class="line">      <span class="bullet">-</span> <span class="attr">address:</span> <span class="string">aws_s3_bucket_public_access_block.my_bucket</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="string">managed</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">aws_s3_bucket_public_access_block</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">my_bucket</span></span><br><span class="line">        <span class="attr">provider_name:</span> <span class="string">registry.terraform.io/hashicorp/aws</span></span><br><span class="line">        <span class="attr">schema_version:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">values:</span></span><br><span class="line">          <span class="attr">block_public_acls:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">block_public_policy:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">ignore_public_acls:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">restrict_public_buckets:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">sensitive_values:</span> &#123;&#125;</span><br><span class="line"><span class="attr">resource_changes:</span></span><br><span class="line">  <span class="string">//</span> <span class="string">既存リソースに対する変更内容</span></span><br><span class="line">  <span class="string">//</span> <span class="string">省略</span></span><br><span class="line"><span class="attr">configuration:</span></span><br><span class="line">  <span class="string">//</span> <span class="string">元の状態に適用される構成のこと</span></span><br><span class="line">  <span class="string">//</span> <span class="string">省略</span></span><br><span class="line"><span class="attr">relevant_attributes:</span></span><br><span class="line">  <span class="string">//</span> <span class="string">変更されたリソースの関連属性</span></span><br><span class="line">  <span class="string">//</span> <span class="string">省略</span></span><br><span class="line"><span class="attr">timestamp:</span> <span class="string">&quot;2024-03-17T05:58:17Z&quot;</span></span><br><span class="line"><span class="attr">errored:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure><p>上記リソースをチェックするためのリソースポリシーを書いてみます。</p><p>よくあるリソースポリシーとして</p><ul><li>S3のバケット名が特定の命名規則にしたがっていること</li><li>リソースに特定の環境を示すタグが入っていること</li></ul><p>をチェックしたいと思います。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">let</span> aws_s3_bucket_resources = planned_values.root_module.resources[<span class="built_in">type</span> == <span class="string">&quot;aws_s3_bucket&quot;</span>]</span><br><span class="line"></span><br><span class="line">rule aws_s3_bucket_rule when %aws_s3_bucket_resources !empty &#123;</span><br><span class="line">  <span class="comment"># バケット名は &quot;test-&quot; で始まる必要があります</span></span><br><span class="line">  %aws_s3_bucket_resources.values.bucket == /^<span class="built_in">test</span>-.*/</span><br><span class="line"></span><br><span class="line">  <span class="comment"># &quot;env&quot; タグが必ず含まれること</span></span><br><span class="line">  <span class="built_in">let</span> required_tags = %aws_s3_bucket_resources.values.tags_all[ </span><br><span class="line">      Key == <span class="string">&#x27;env&#x27;</span> ] </span><br><span class="line">  %required_tags[*] &#123;</span><br><span class="line">      Value IN [<span class="string">&#x27;dev&#x27;</span>, <span class="string">&#x27;stg&#x27;</span>, <span class="string">&#x27;prod&#x27;</span>, <span class="string">&#x27;demo&#x27;</span>]</span><br><span class="line">      &lt;&lt;<span class="string">Tag must have a permitted value&gt;&gt;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><p>このルールに従っているか実際に <code>cfn-guard</code> を動かし、チェックしてみましょう。</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">cfn-guard validate -r s3_template_example.guard -d infrastructure/tfplan1.json -o yaml</span></span><br><span class="line">tfplan1.json Status = FAIL</span><br><span class="line">FAILED rules</span><br><span class="line">s3_template_example.guard/aws_s3_bucket_rule                    FAIL</span><br><span class="line">---</span><br><span class="line">name: tfplan1.json</span><br><span class="line">metadata: &#123;&#125;</span><br><span class="line">status: FAIL</span><br><span class="line">not_compliant:</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">出力内容はわかりやすくするために途中端折ってます</span></span><br><span class="line">- Rule:</span><br><span class="line">    name: aws_s3_bucket_rule</span><br><span class="line">    checks:</span><br><span class="line">    - Clause:</span><br><span class="line">        Binary:</span><br><span class="line">          context: &#x27; %aws_s3_bucket_resources[*].values.bucket EQUALS  &quot;/^test-.*/&quot;&#x27;</span><br><span class="line">          messages:</span><br><span class="line">            custom_message: &#x27;&#x27;</span><br><span class="line">            error_message: Check was not compliant as property value [Path=/planned_values/root_module/resources/0/values/bucket[L:0,C:286] Value=&quot;my-bucket&quot;] not equal to value [Path=[L:0,C:0] Value=&quot;/^test-.*/&quot;].</span><br><span class="line">          check:</span><br><span class="line">            Resolved:</span><br><span class="line">              from:</span><br><span class="line">                path: /planned_values/root_module/resources/0/values/bucket</span><br><span class="line">                value: my-bucket</span><br><span class="line">              to:</span><br><span class="line">                path: &#x27;&#x27;</span><br><span class="line">                value: /^test-.*/</span><br><span class="line">              comparison:</span><br><span class="line">              - Eq</span><br><span class="line">              - false</span><br></pre></td></tr></table></figure><p>エラーになりました。contextを確認すると、 <code>context: &#39; %aws_s3_bucket_resources[*].values.bucket EQUALS  &quot;/^test-.*/&quot;&#39;</code> とあるようにバケットの命名規則がルールに従っていないことがわかります。</p><p>そこでバケット名を修正し、再度 <code>cfn-guard</code> にかけてみます。</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修正したs3.tf及びyamlファイルは割愛</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">cfn-guard validate -r s3_template_example.guard -d infrastructure/tfplan2.json -o yaml</span></span><br><span class="line">name: tfplan2.json</span><br><span class="line">metadata: &#123;&#125;</span><br><span class="line">status: PASS</span><br><span class="line">not_compliant: []</span><br><span class="line">not_applicable: []</span><br><span class="line">compliant:</span><br><span class="line">- aws_s3_bucket_rule</span><br><span class="line">- public_access_block_resources_rule</span><br></pre></td></tr></table></figure><p>今度は通りました。</p><p>序の口ではありますが、cfn-guardを使ったチェック方法について、雰囲気は掴めたのではないかと思います。しかし、ここから先、cfn-guardを深掘りするうちにギャップが広がっていくことに気づきました。</p><h2 id="ここが思ってたのと違ってたよという話"><a href="#ここが思ってたのと違ってたよという話" class="headerlink" title="ここが思ってたのと違ってたよという話"></a>ここが思ってたのと違ってたよという話</h2><p>当初の自分の妄想では、cfn-guardとは、AWSのリソースAPIにアクセスしていい感じにチェックするツールなのかなとふわっと思ってました。ですが、実践例にあるように実態はどうでしょうか？</p><p>カンの良い方はすぐに気づかれたかもしれません。</p><p>CloudFormationを例に先ほどと同じことをしてみましょう。</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">AWSTemplateFormatVersion:</span> <span class="number">2010-09-09</span></span><br><span class="line"><span class="attr">Resources:</span></span><br><span class="line">  <span class="attr">MyS3Bucket4646DF6F:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">AWS::S3::Bucket</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">BucketName:</span> <span class="string">my-bucket</span></span><br><span class="line">    <span class="attr">UpdateReplacePolicy:</span> <span class="string">Delete</span></span><br><span class="line">    <span class="attr">DeletionPolicy:</span> <span class="string">Delete</span></span><br><span class="line">    <span class="attr">Metadata:</span></span><br><span class="line">      <span class="attr">aws:cdk:path:</span> <span class="string">CdkAppStack/MyS3Bucket/Resource</span></span><br></pre></td></tr></table></figure><p>というファイルに対してS3のバケット名の命名規則をチェックします。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">let</span> buckets = Resources.*[ Type == <span class="string">&#x27;AWS::S3::Bucket&#x27;</span> ]</span><br><span class="line"></span><br><span class="line">rule BucketEncryption when %buckets !empty &#123;</span><br><span class="line">  %buckets.Properties &#123;</span><br><span class="line">    BucketName == /^<span class="built_in">test</span>-.*/</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>別物やんけ。</p><p>その通りです。なぜなら、CloudFormationとTerraform planではファイルの構造が全然異なりますので。</p><p>cfn-guardの実態は、CFn Guard DSLに基づきJSONやYAMLなどの構造型データを検査する、ある意味シンプルな構文解析ツールです。</p><p>したがって、ポリシーファイルについてCloudFormation向けはCloudFormation向け、Terraform plan向けはTerraform plan向けに書く必要があります。そして後者のTerraform plan向けのポリシーファイルは、当然AWS Config上で動きません。</p><p>ここに当初の構想はからくも崩れたのでした。</p><p>ECSのTask Definitionのようにインラインで文字列化したJSONファイルをいい感じにパースする方法が見つからなかった、tagチェックでtagsとtags_allを別々にチェックする必要があった、そもそも構文エラー時説明してるようで何も説明してくれないエラーログ等、細かいことを言い出すときりがない不満があり、最終的に自分はおとなしくtflintに戻りました。</p><h2 id="最後に"><a href="#最後に" class="headerlink" title="最後に"></a>最後に</h2><p>Terraformユーザーには、cfn-guardの扱いは少々難しいところがあるという話でした。</p><p>ポリシールール等の設定について最近はChatGPT先生に下書きをお願いすることが多いのですが、彼女に自由に書かせたら、明らかにAWS CloudFormationテンプレート向けのguardファイルをTerraformと言い張ったのは悲しかったです。</p><p>WHY?と聞いたら次の通り開き直った回答が返ってきました。<br><img src="/images/20240318a/image_2.png" alt="" width="1200" height="1142" loading="lazy"></p><p>しかし、AWS CDKを使ってCloufFormationのテンプレートファイルを生成し、AWSリソースのデプロイを行っているユーザーにとって強力なポリシーチェックツールなのは間違いありません。</p><p><a href="https://github.com/aws-cloudformation/aws-guard-rules-registry">CFn Guard Rules Registry</a>には、ルールの実装例が多数掲載されております。<br>Amazon Web Services’ Well-Architected Framework Reliability Pillar等、インフラエンジニアが非機能要件を考える時のベストプラクティスを実装したポリシーファイル等もあり、痒い所に手が届く例となっています。</p><p>以上、参考になれば幸いです。</p><div id="footnotes"><hr><div id="footnotelist"><ol style="list-style:none; padding-left: 0;"><li id="fn:1"><span style="vertical-align: top; padding-right: 10px;">1.</span><span style="vertical-align: top;">現在は <code>gcloud beta terraform vet</code> として提供中</span><a href="#fnref:1" rev="footnote"> ↩</a></li><li id="fn:2"><span style="vertical-align: top; padding-right: 10px;">2.</span><span style="vertical-align: top;">現在は <code>trivyの1機能</code> として提供中</span><a href="#fnref:2" rev="footnote"> ↩</a></li></ol></div></div>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;&lt;a href=&quot;/articles/20240311a/&quot;&gt;Terraform連載2024を&lt;/a&gt; の6本目です。&lt;/p&gt;
&lt;h2 id=&quot;導入&quot;&gt;&lt;a href=&quot;#導入&quot; class=&quot;headerlink&quot;</summary>
        
      
    
    
    
    <category term="Infrastructure" scheme="https://future-architect.github.io/categories/Infrastructure/"/>
    
    
    <category term="Terraform" scheme="https://future-architect.github.io/tags/Terraform/"/>
    
    <category term="cfn-guard" scheme="https://future-architect.github.io/tags/cfn-guard/"/>
    
    <category term="Policy-as-Cod" scheme="https://future-architect.github.io/tags/Policy-as-Cod/"/>
    
    <category term="CloudFormation" scheme="https://future-architect.github.io/tags/CloudFormation/"/>
    
  </entry>
  
  <entry>
    <title>サービスの多国展開を支えるTerraform構成</title>
    <link href="https://future-architect.github.io/articles/20240315a/"/>
    <id>https://future-architect.github.io/articles/20240315a/</id>
    <published>2024-03-14T15:00:00.000Z</published>
    <updated>2024-03-15T01:10:34.991Z</updated>
    
    <content type="html"><![CDATA[<img src="/images/20240315a/image.png" alt="" width="1088" height="542" loading="lazy"><p><a href="/articles/20240311a/">Terraform連載2024</a>の5日目です。</p><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>IaCを利用してインフラを構成することで、構築忘れや設定ミスといったイージーなミスが減らせるようになりました。とはいえ、展開していく範囲が増えれば増えるほどコードの量も増えていくので、このリソースはどこで作ったっけ…みたいなことが起きてしまいます。</p><p>現在の業務ではサービスの海外展開に携わっており、まさに多国展開絶賛実施中という状態です。その際、スペックは同じでもリージョンのみが異なるリソースを作成することが多々あり、環境の管理方法って大切だなーと実感しております。</p><p>そこで本記事では、Terraformを利用してシステムを他リージョンへロールアウトする場合のリソース管理・展開方法を3つ挙げてみました。もちろん、他にもたくさんあると思いますので、本記事が参考になると幸いです。</p><p>また、本連載の1日目でも伊藤さんがマルチリージョンによるDR（Disaster Recovery）戦略についての記事を書かれているので、こちらも参考にしてください。</p><p>参考：<a href="/articles/20240311a/">TerraformにおけるDR戦略を考える</a></p><h2 id="仮定"><a href="#仮定" class="headerlink" title="仮定"></a>仮定</h2><p>以下のような前提で考えてみます。</p><ul><li>Google Cloudを利用<ul><li>他クラウドベンダーでも応用可能だと思います</li></ul></li><li>各環境（Development&#x2F;Staging&#x2F;Production）毎でプロジェクトは同じになる<ul><li>dev-app&#x2F;stg-app&#x2F;prd-appの様に3つのプロジェクトが存在します</li></ul></li><li>ほぼ同じシステムを他リージョンへロールアウトしていく<ul><li>インスタンスのマシンスペックなど、リソース周りはカスタム可能にしたいと思います</li></ul></li><li>Terraformを実行するためのBastionサーバーが存在する<ul><li>各環境のBastionサーバーからTerraformをApplyすることになります</li><li>各BastionサーバーでBackendバケットへのアクセスは既に認証済みとなっています</li></ul></li></ul><h2 id="構成案①：ディレクトリ分けのみで管理する"><a href="#構成案①：ディレクトリ分けのみで管理する" class="headerlink" title="構成案①：ディレクトリ分けのみで管理する"></a>構成案①：ディレクトリ分けのみで管理する</h2><p>以下のように環境、リージョン<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>をそれぞれディレクトリ分けして管理します。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">envs</span><br><span class="line">├── modules</span><br><span class="line">│   └── ...</span><br><span class="line">├── development</span><br><span class="line">│   ├── common</span><br><span class="line">│   │   ├── backend.tf</span><br><span class="line">│   │   ├── compute_network.tf</span><br><span class="line">│   │   ├── project.tf</span><br><span class="line">│   │   ├── variable.tf</span><br><span class="line">│   │   └── versions.tf</span><br><span class="line">│   ├── sydney</span><br><span class="line">│   │   ├── backend.tf</span><br><span class="line">│   │   ├── compute_subnetwork.tf</span><br><span class="line">│   │   ├── data.tf</span><br><span class="line">│   │   ├── compute_instance.tf</span><br><span class="line">│   │   └── versions.tf</span><br><span class="line">│   └── tokyo</span><br><span class="line">├── production</span><br><span class="line">│   ├── common</span><br><span class="line">│   ├── ...</span><br><span class="line">└── staging</span><br><span class="line">    ├── common</span><br><span class="line">    ├── ...</span><br></pre></td></tr></table></figure><p>各環境の中にcommonとリージョン毎のディレクトリを持ちます。commonにはVPCやプロジェクトといった共通となるリソースを置き、リージョン毎に必要なリソースはリージョンディレクトリに配置します。<br>また、各ディレクトリでbackendを持ち、tfstateの管理を行う形となるため<code>terraform</code>コマンドは各ディレクトリに対して行う必要があります。</p><p>単純にディレクトリをコピペして展開していけるので、リージョンの追加があった場合でも共通リソースの展開であれば容易に実行できます。視覚的にもしっかり分かれているので、新規参画者などにも認知負荷が高くないです。</p><p>ただ、共通リソースを参照する場合は<code>data</code>として用意する必要があり、冗長な感じは否めません。</p><figure class="highlight sh"><figcaption><span>terraform data.tf</span></figcaption><table><tr><td class="code"><pre><span class="line">data <span class="string">&quot;google_project&quot;</span> <span class="string">&quot;my_project&quot;</span> &#123;</span><br><span class="line">  project_id = <span class="string">&quot;ksst-bastion&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="構成案②：ディレクトリ分けとworkspaceを使って管理する"><a href="#構成案②：ディレクトリ分けとworkspaceを使って管理する" class="headerlink" title="構成案②：ディレクトリ分けとworkspaceを使って管理する"></a>構成案②：ディレクトリ分けとworkspaceを使って管理する</h2><p>以下のように環境をそれぞれディレクトリ分けして管理します。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">envs</span><br><span class="line">├── modules</span><br><span class="line">│   └── ...</span><br><span class="line">├── development</span><br><span class="line">│   ├── configs</span><br><span class="line">│   │   ├── sydney.tfvars</span><br><span class="line">│   │   └── tokyo.tfvars</span><br><span class="line">│   ├── backend.tf</span><br><span class="line">│   ├── compute_instance.tf</span><br><span class="line">│   ├── compute_network.tf</span><br><span class="line">│   ├── compute_subnetwork.tf</span><br><span class="line">│   ├── storage_bucket.tf</span><br><span class="line">│   ├── project.tf</span><br><span class="line">│   ├── variables.tf</span><br><span class="line">│   └── versions.tf</span><br><span class="line">├── production</span><br><span class="line">│   ├── configs</span><br><span class="line">│   │   ├── ...</span><br><span class="line">│   ├── backend.tf</span><br><span class="line">│   ...</span><br><span class="line">└── staging</span><br><span class="line">    ├── configs</span><br><span class="line">    │   ├── ...</span><br><span class="line">    ├── backend.tf</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p>先ほどとは異なり、各環境でbackendを1つとしてWorkspaceによってリージョンを区別していきます。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ terraform workspace list</span><br><span class="line">  default</span><br><span class="line">* sydney</span><br><span class="line">  tokyo</span><br></pre></td></tr></table></figure><p>また、plan&#x2F;apply時にtfvarsを利用することによって各環境ワンリソースで管理することが可能となります。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ terraform plan -var-file config/sydney.tfvars</span><br><span class="line">$ terraform plan -var-file config/sydney.tfvars</span><br></pre></td></tr></table></figure><figure class="highlight sh"><figcaption><span>terraform storage_bucket.tf</span></figcaption><table><tr><td class="code"><pre><span class="line">resource <span class="string">&quot;google_storage_bucket&quot;</span> <span class="string">&quot;bucket&quot;</span> &#123;</span><br><span class="line">  project       = google_project.my_project.project_id</span><br><span class="line">  name          = <span class="string">&quot;<span class="variable">$&#123;var.region_short&#125;</span>-bucket-test&quot;</span></span><br><span class="line">  location      = var.region</span><br><span class="line">  force_destroy = <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Terraform Workspaceは機能として存在するものの、開発環境を区別するのには非推奨<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup>など、中々使いどころの難しい存在でしたがリージョンを区別するのには使えそうです。この構成であれば、他リージョン展開時に新しい<code>tfvars</code>ファイルを作成するだけでよいので、ロールアウト時の作業が激減します。</p><p>ただ、新しいリソース・変数を定義する場合には全<code>tfvars</code>ファイルに値の追加が必要なので注意が必要です。</p><p>ちょっとした亜種ですが、Workspace名をそのまま変数として持ってきてリソースに適用することも可能です。<br><strong>※この場合は、Workspace名に<code>asia-northeast1</code>や<code>australia-southeast1</code>を使う必要があります。</strong></p><figure class="highlight sh"><figcaption><span>storage_bucket.tf</span></figcaption><table><tr><td class="code"><pre><span class="line">resource <span class="string">&quot;google_storage_bucket&quot;</span> <span class="string">&quot;bucket&quot;</span> &#123;</span><br><span class="line">...</span><br><span class="line">  location      = terraform.workspace</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="構成案③：ワンリソースにしてtfvarsで管理する"><a href="#構成案③：ワンリソースにしてtfvarsで管理する" class="headerlink" title="構成案③：ワンリソースにしてtfvarsで管理する"></a>構成案③：ワンリソースにしてtfvarsで管理する</h2><p>以下のようなディレクトリ構成で管理します。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">envs</span><br><span class="line">├── modules</span><br><span class="line">│   └── ...</span><br><span class="line">├── configs</span><br><span class="line">│   ├── development</span><br><span class="line">│   │   ├── sydney.tfvars</span><br><span class="line">│   │   └── tokyo.tfvars</span><br><span class="line">│   ├── production</span><br><span class="line">│   │   ├── sydney.tfvars</span><br><span class="line">│   │   └── tokyo.tfvars</span><br><span class="line">│   └── staging</span><br><span class="line">│       ├── sydney.tfvars</span><br><span class="line">│       └── tokyo.tfvars</span><br><span class="line">├── backend.tf</span><br><span class="line">├── compute_instance.tf</span><br><span class="line">├── compute_network.tf</span><br><span class="line">├── compute_subnetwork.tf</span><br><span class="line">├── data.tf</span><br><span class="line">├── project.tf</span><br><span class="line">├── storage_bucket.tf</span><br><span class="line">├── variable.tf</span><br><span class="line">├── versions.tf</span><br><span class="line">└── terraform_init.sh</span><br></pre></td></tr></table></figure><p>各種リソースはワンリソースとして、Plan&#x2F;Apply時に各<code>tfvars</code>ファイルで変数を渡す形となります。<br>環境やリージョンを変更する場合のbackendの変更はどうするのか？という部分ですが、<code>terraform_init.sh</code>というbashスクリプトを介して、各環境ごとでbackendを構成し直します。</p><figure class="highlight sh"><figcaption><span>terraform_init.sh</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="function"><span class="title">usage</span></span> () &#123;</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;Usage: <span class="variable">$0</span> [option ...] [arg ...]&quot;</span></span><br><span class="line">  <span class="built_in">cat</span> &lt;&lt;<span class="string">&quot;EOM&quot;</span></span><br><span class="line">Options:</span><br><span class="line">  -h: Show this <span class="built_in">help</span></span><br><span class="line">  -c: city: Specify region<span class="string">&#x27;s city name </span></span><br><span class="line"><span class="string">  -e: environment: Specify enviroment</span></span><br><span class="line"><span class="string">EOM</span></span><br><span class="line"><span class="string">  exit 1</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">while getopts c:e:o:a option ; do</span></span><br><span class="line"><span class="string">  case $option in</span></span><br><span class="line"><span class="string">    c)</span></span><br><span class="line"><span class="string">      city=$OPTARG</span></span><br><span class="line"><span class="string">      echo &quot;City of region: $city&quot;</span></span><br><span class="line"><span class="string">      ;;</span></span><br><span class="line"><span class="string">    e)</span></span><br><span class="line"><span class="string">      env=$OPTARG</span></span><br><span class="line"><span class="string">      echo &quot;Environment: $env&quot;</span></span><br><span class="line"><span class="string">      ;;</span></span><br><span class="line"><span class="string">    h | \?)</span></span><br><span class="line"><span class="string">      echo &quot;-h or invalid option is used (OPTIND: $OPTIND)&quot;</span></span><br><span class="line"><span class="string">      usage</span></span><br><span class="line"><span class="string">      ;;</span></span><br><span class="line"><span class="string">  esac</span></span><br><span class="line"><span class="string">done</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Create backend.tf</span></span><br><span class="line"><span class="string">cat &lt;&lt;EOF &gt; backend.tf</span></span><br><span class="line"><span class="string">terraform &#123;</span></span><br><span class="line"><span class="string">  backend &quot;gcs&quot; &#123;</span></span><br><span class="line"><span class="string">    bucket = &quot;$&#123;env&#125;-multi-region-rollout-tfstate&quot;</span></span><br><span class="line"><span class="string">    prefix = &quot;$&#123;city&#125;/state&quot;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Initialize terraform&#x27;</span>s backend</span><br><span class="line">terraform init -reconfigure</span><br></pre></td></tr></table></figure><p>そのため、リージョン毎のbackend変更に関しては都度スクリプトを実行する運用でカバーしていく形となります。</p><p>以下の記事で紹介されているようにplan&#x2F;applyなどTerraformのコマンドもラッピングすることで、Terraformの操作を全てシェルスクリプト経由にしてしまったほうが誤ったbackendでのplan&#x2F;applyが起きないかもしれません。<br>参考：<a href="https://zenn.dev/smartround_dev/articles/5e20fa7223f0fd">Terraformでmoduleを使わずに複数環境を構築する</a></p><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>上記3つの方法をまとめると以下のようになります。</p><div class="scroll"><table><thead><tr><th>案</th><th>リージョン展開方法</th><th>リージョン毎の運用</th><th>新しいリソースの追加方法</th><th>認知負荷</th></tr></thead><tbody><tr><td>①ディレクトリ分けのみ</td><td>ディレクトリを追加</td><td>ディレクトリ毎でApply</td><td>各環境・リージョンでファイル追加</td><td>低</td></tr><tr><td>②ディレクトリ分けとworkspace</td><td>各環境でtfvarsとWorkspaceを追加</td><td>Workspace毎でApply</td><td>各環境でファイル追加</td><td>中</td></tr><tr><td>③ワンリソースにしてtfvars</td><td>各環境でtfvarsを追加</td><td>シェルスクリプトを実行してからApply</td><td>1ファイル追加</td><td>高</td></tr></tbody></table></div><p>展開するリージョンの数が少なければ①が楽そうですが、どんどん増えていくのであれば②と③のどちらかな気がします。</p><p>実務上では参画当初から③の方法で運用を回しており、CIでデプロイの自動化をしている部分もあるのでシェルスクリプトの実行に関してはそこまで負担に感じておりません。ただ、個人的には②のやり方がよりシンプルになるので好みです。</p><p>本記事ではインフラの多国展開時におけるTerraformの管理方法を紹介してみました。これらが正解というわけではなく、運用を回していく中で強み・弱みが見えてくると思いますので、せひチームに適した形を探してみてください。</p><p>アイキャッチ画像のアイコンは以下から引用させて頂いております。<br><a href="https://www.hashicorp.com/brand">HashiCorp Brand</a><br><a href="https://cloud.google.com/icons?hl=ja">Google Cloud - アーキテクチャ図用のプロダクト アイコン</a></p><div id="footnotes"><hr><div id="footnotelist"><ol style="list-style:none; padding-left: 0;"><li id="fn:1"><span style="vertical-align: top; padding-right: 10px;">1.</span><span style="vertical-align: top;">リージョン名を都市・州名で表していますが、正式名称のasia-northeast1とかでも良いです。</span><a href="#fnref:1" rev="footnote"> ↩</a></li><li id="fn:2"><span style="vertical-align: top; padding-right: 10px;">2.</span><span style="vertical-align: top;"><a href="https://developer.hashicorp.com/terraform/cli/workspaces#when-not-to-use-multiple-workspaces">https://developer.hashicorp.com/terraform/cli/workspaces#when-not-to-use-multiple-workspaces</a></span><a href="#fnref:2" rev="footnote"> ↩</a></li></ol></div></div>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;img src=&quot;/images/20240315a/image.png&quot; alt=&quot;&quot; width=&quot;1088&quot; height=&quot;542&quot; loading=&quot;lazy&quot;&gt;

&lt;p&gt;&lt;a</summary>
        
      
    
    
    
    <category term="Infrastructure" scheme="https://future-architect.github.io/categories/Infrastructure/"/>
    
    
    <category term="Terraform" scheme="https://future-architect.github.io/tags/Terraform/"/>
    
    <category term="マルチリージョン" scheme="https://future-architect.github.io/tags/%E3%83%9E%E3%83%AB%E3%83%81%E3%83%AA%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3/"/>
    
    <category term="海外展開" scheme="https://future-architect.github.io/tags/%E6%B5%B7%E5%A4%96%E5%B1%95%E9%96%8B/"/>
    
  </entry>
  
  <entry>
    <title>Terraform連載2024 Stateを統合してみる</title>
    <link href="https://future-architect.github.io/articles/20240314a/"/>
    <id>https://future-architect.github.io/articles/20240314a/</id>
    <published>2024-03-13T15:00:00.000Z</published>
    <updated>2024-03-14T00:29:14.399Z</updated>
    
    <content type="html"><![CDATA[<p><a href="/articles/20240311a/">Terraform 連載2024</a>の4本目です。</p><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>はじめまして。Technology Inovation Group (TIG) の原田と申します。</p><p>私が所属しているチームではTerraformでAWSリソースを管理しており、tfstateを統合する機会があったので、その経験をもとに記事を書きます。</p><h3 id="環境"><a href="#環境" class="headerlink" title="環境"></a>環境</h3><p>Terraform バージョン 1.5.7</p><h2 id="ことの経緯"><a href="#ことの経緯" class="headerlink" title="ことの経緯"></a>ことの経緯</h2><p>私が所属しているチームでは、サービスごとに複数のtfstateでリソースを管理していました。</p><p>ただ、プロダクトが成熟してきて、リリース頻度が非常に低い&amp;リリースをしたとしても複数サービスが同じタイミングでリリースされることが多くなりました。</p><p>そういった理由から、成熟しきったStateを統合しようという機運が高まりました。</p><h2 id="方針"><a href="#方針" class="headerlink" title="方針"></a>方針</h2><p>ゴールは、移行元のtfstate(a.tfstate)を移行先のtfstate(b.tfstate)にマージしてb.tfstateですべてのAWSリソースを管理できる状態です。</p><p>そのための作業パターンとして大きく2つの案を考えました。</p><h2 id="二つの作業パターン"><a href="#二つの作業パターン" class="headerlink" title="二つの作業パターン"></a>二つの作業パターン</h2><h3 id="パターン①「import-removeコマンド」"><a href="#パターン①「import-removeコマンド」" class="headerlink" title="パターン①「import &amp; removeコマンド」"></a>パターン①「import &amp; removeコマンド」</h3><p>手順:</p><ol><li>統合元のStateで <code>remove</code> コマンド</li><li>統合先のStateで <code>import</code> コマンド</li><li>Terraform のコードを統合</li><li><code>plan</code> にて差分が発生しないことを確認</li></ol><p>お手軽ですね。Terraform直々に提供している機能ということもあって、安心感もあります。</p><p>1. 統合元のStateで <code>remove</code> コマンド</p><figure class="highlight sh"><figcaption><span>s3の場合</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment"># 統合元のStateにて</span></span><br><span class="line">$ terraform state <span class="built_in">rm</span> aws_s3_bucket.s3</span><br></pre></td></tr></table></figure><p>2. 統合先のStateで <code>import</code> コマンド</p><figure class="highlight sh"><figcaption><span>s3の場合</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment"># 統合先のStateにて</span></span><br><span class="line">$ terraform state import aws_s3_bucket.s3 バケット名</span><br></pre></td></tr></table></figure><p>Terraformのバージョンが1.5以上の場合はimport ブロックを使用するのもよいでしょう。</p><p><a href="https://developer.hashicorp.com/terraform/language/import">https://developer.hashicorp.com/terraform/language/import</a></p><p>3. Terraform のコードを統合<br>コピペでいいですね。リソースが多い場合はかなり根気が要ります。</p><p>4. <code>plan</code> にて差分が発生しないことを確認</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ terraform plan</span><br><span class="line"></span><br><span class="line">==(略)==</span><br><span class="line"></span><br><span class="line">No changes. Your infrastructure matches the configuration.</span><br></pre></td></tr></table></figure><p>お疲れ様でした。</p><p>お気づきの方もいらっしゃるかと思いますが、管理リソースが多い場合はかなり作業コストが高いです。リソースごとに、import・removed・コードの修正が必要になります。</p><p>私のチームでは100を優に超えるAWSリソースを管理していたため、この方法は現実的ではありませんでした。</p><h3 id="パターン②「Stateを編集」"><a href="#パターン②「Stateを編集」" class="headerlink" title="パターン②「Stateを編集」"></a>パターン②「Stateを編集」</h3><p>Stateを直接操作することはあまり推奨されないですが、今回はこの選択をとりました。</p><p>操作イメージとしては以下のような手順です</p><img src="/images/20240314a/terraform_merge.drawio.png" alt="terraform_merge.drawio.png" width="427" height="429" loading="lazy"><p>手順:</p><ol><li>ローカルにtfstateをローカルに取得</li><li>二つのStateファイルをマージ</li><li>マージしたtfstateファイルを統合先にpush</li><li>Terraform のコードを統合</li><li><code>plan</code> にて差分が発生しないことを確認</li></ol><p>パターン①よりステップが一つ多くなっているように見えますが、ちょっと待ってください。詳しく見ていきましょう。</p><p>1. ローカルにtfstateをローカルに取得</p><figure class="highlight sh"><figcaption><span>作業例</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment"># 統合元のStateにて</span></span><br><span class="line">$ terraform state pull &gt; a.tfstate</span><br></pre></td></tr></table></figure><figure class="highlight sh"><figcaption><span>作業例</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment"># 統合先のStateにて</span></span><br><span class="line">$ terraform state pull &gt; b.tfstate</span><br></pre></td></tr></table></figure><p>2. 二つのStateファイルをマージ</p><p>ここが今回の作業のキモです。頑張って手作業でStateファイルをマージしていきましょう。</p><p>…というのは危険なので、今回は<a href="https://github.com/fujiwara">fujiwara</a>さんが開発された、便利なツールを利用させていただきましょう。</p><p><a href="https://github.com/fujiwara/tfstate-merge">https://github.com/fujiwara/tfstate-merge</a></p><p>コマンド一撃でtfstateファイルをマージしてくれる、何ともありがたいツールです。</p><p>ある程度のバリデーション機能も実装されているので、手動でマージするより、格段に安心して作業できます。</p><p>こちらで作者であるfujiwaraさんの解説があるので、詳細に関してはそちらをぜひご覧ください。</p><p><a href="https://sfujiwara.hatenablog.com/entry/tfstate-merge">https://sfujiwara.hatenablog.com/entry/tfstate-merge</a></p><figure class="highlight sh"><figcaption><span>作業例</span></figcaption><table><tr><td class="code"><pre><span class="line">$ tfstate-merge b.tfstate a.tfstate &gt; b<span class="string">&#x27;.tfstate</span></span><br></pre></td></tr></table></figure><p>3. マージしたtfstateファイルを統合先にpush</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">terraform state push b<span class="string">&#x27;.tfstate</span></span><br></pre></td></tr></table></figure><div class="note warn" style="background: #fdf9e2; padding:16px; margin:24px 12px; border-radius:8px;">  <span class="fa fa-fw fa-check-circle"></span>tfstateファイルは必ずバックアップを取っておくようにしましょう</div><p>4. Terraform のコードを統合</p><p>ここはパターン①と同様、根気よく作業していきましょう。<br>git の 差分の増減などを確認するもよいでしょう。</p><p>5. <code>plan</code> にて差分が発生しないことを確認</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ terraform plan</span><br><span class="line"></span><br><span class="line">==(略)==</span><br><span class="line"></span><br><span class="line">No changes. Your infrastructure matches the configuration.</span><br></pre></td></tr></table></figure><p>お疲れ様でした。</p><p>こちらのパターンの利点は作業の負担が圧倒的に少ないです。ただ、<code>terraform state push</code>というかなり危険なコマンドを使用するので実行には細心の注意を払いましょう。</p><h2 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h2><p>tfstateを統合した経験について書きました。</p><p>Stateの統廃合や、moduleへの移行など、Terraformのリファクタには様々な手札がありますが、エンジニアたるもの日常的により良いコードを目指していきたいですね。これは自身への戒めでもあります。</p><p>新卒でIT業界に飛び込み、もうすぐ2年が過ぎようとしていますが、自身の経験を発信していくことは良い刺激になりました。<a href="/articles/20240311a/">Terraform 連載2024</a>の一環として執筆させていただきましたが、非常に興味深いトピックが目白押しなので、ぜひ他の記事もご覧ください！</p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;&lt;a href=&quot;/articles/20240311a/&quot;&gt;Terraform 連載2024&lt;/a&gt;の4本目です。&lt;/p&gt;
&lt;h2 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot;</summary>
        
      
    
    
    
    <category term="Infrastructure" scheme="https://future-architect.github.io/categories/Infrastructure/"/>
    
    
    <category term="Terraform" scheme="https://future-architect.github.io/tags/Terraform/"/>
    
    <category term="tfstate-merge" scheme="https://future-architect.github.io/tags/tfstate-merge/"/>
    
  </entry>
  
  <entry>
    <title>Terraform連載2024 Terraformにおける変数の制御について</title>
    <link href="https://future-architect.github.io/articles/20240313a/"/>
    <id>https://future-architect.github.io/articles/20240313a/</id>
    <published>2024-03-12T15:00:00.000Z</published>
    <updated>2024-03-14T00:24:17.043Z</updated>
    
    <content type="html"><![CDATA[<img src="/images/20240313a/terraform_top.png" alt="" width="900" height="628"><p><a href="/articles/20240311a/">Terraform 連載2024</a>の3本目です。</p><h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>はじめまして。フューチャーキャリア入社1年半の森と申します。</p><p>Terraformにおける変数を、構築するインフラの要件に合わせてどのように制御していくかについてまとめます。</p><p>Terraformにおける変数制御は、構築するインフラの要件を明確化させる上で重要です。そのため、どのような変数制御があるか、ユースケースを踏まえ見ていきます。</p><h2 id="Terraformの変数制御"><a href="#Terraformの変数制御" class="headerlink" title="Terraformの変数制御"></a>Terraformの変数制御</h2><p>Terraformには型による制約の他に、下記3種類の変数の制御方法があります。</p><ul><li>validation : 変数の<strong>静的な事前チェック</strong>を実施する</li><li>precondition(v1.2以降) : 変数の<strong>動的な事前チェック</strong>を実施する</li><li>postcondition(v1.2以降) : 変数の<strong>動的な事後チェック</strong>を実施する</li></ul><p>静的・動的の可不可や、事前・事後のチェックなどの違いがありますが、図にするとこのような感じです。</p><div class="scroll"><table><thead><tr><th></th><th>動的チェック</th><th>事前チェック</th><th>事後チェック</th></tr></thead><tbody><tr><td>validation</td><td>不可</td><td>可</td><td>不可</td></tr><tr><td>precondition</td><td>可</td><td>可</td><td>不可</td></tr><tr><td>postcondition</td><td>可</td><td>不可</td><td>可</td></tr></tbody></table></div><p>具体的に1つずつ確認していきましょう。</p><h2 id="validationについて"><a href="#validationについて" class="headerlink" title="validationについて"></a>validationについて</h2><p><code>validation</code>は3つの変数制御の中でも最もシンプルで簡単な制御の方法です</p><p>例えば、AWSのEC2でEBSを暗号化したい場合、以下のように<code>validation</code>ブロックを暗号化の有無に関する変数に追加します。</p><p>このブロックの<code>condition</code>の内容で真偽を判定し、偽の場合<code>error_message</code>で指定のエラーメッセージを出力できます。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">resource <span class="string">&quot;aws_instance&quot;</span> <span class="string">&quot;example&quot;</span> &#123;</span><br><span class="line">  ami           = <span class="string">&quot;ami-020283e959651b381&quot;</span></span><br><span class="line">  instance_type = <span class="string">&quot;t2.micro&quot;</span></span><br><span class="line">  subnet_id     = <span class="string">&quot;subnet-xxxxxxx&quot;</span></span><br><span class="line"></span><br><span class="line">  ebs_block_device &#123;</span><br><span class="line">    device_name = <span class="string">&quot;/dev/sdh&quot;</span></span><br><span class="line">    encrypted   = var.ebs_encryption</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable <span class="string">&quot;ebs_encryption&quot;</span> &#123;</span><br><span class="line">  <span class="built_in">type</span> = bool</span><br><span class="line">  validation &#123;</span><br><span class="line">    condition     = var.ebs_encryption == <span class="literal">true</span></span><br><span class="line">    error_message = <span class="string">&quot;EBS Should Be Encrypted&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">  description = <span class="string">&quot;A Boolean of EBS Encryption in the EC2 Instances&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ebs_encryption</code>に<code>false</code>を指定した場合、<code>terraform plan</code>時に<code>validation</code>ブロックで指定した下記のエラーメッセージが出されます。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">╷</span><br><span class="line">│ Error: Invalid value <span class="keyword">for</span> variable</span><br><span class="line">│</span><br><span class="line">│   on variables.tf line 1:</span><br><span class="line">│    1: variable <span class="string">&quot;ebs_encryption&quot;</span> &#123;</span><br><span class="line">│     ├────────────────</span><br><span class="line">│     │ var.ebs_encryption is <span class="literal">false</span></span><br><span class="line">│</span><br><span class="line">│ EBS Should Be Encrypted</span><br><span class="line">│</span><br><span class="line">│ This was checked by the validation rule at variables.tf:3,3-13.</span><br></pre></td></tr></table></figure><p>このように<code>condition</code>に条件式を書いておくことで、誤ってEBSの暗号化を無効にする事のないように事前にチェックをしてくれるのが<code>validation</code>の特徴です。</p><h3 id="validationのユースケース"><a href="#validationのユースケース" class="headerlink" title="validationのユースケース"></a>validationのユースケース</h3><p>構築したいインフラに対して、あらかじめ変数の条件をハードコードすることで制約を課したい場合に<code>validation</code>ブロックが使えます。</p><h2 id="preconditionについて"><a href="#preconditionについて" class="headerlink" title="preconditionについて"></a>preconditionについて</h2><p>上述の<code>validation</code>で課すことのできる制約は静的な条件に限りました。つまり、全て条件式にハードコードして制御する必要があり、動的にAWSから情報を取得して条件を絞ることは不可能でした。</p><p>これを解決したのがTerraform v1.2から追加された<code>precondition</code>です。例えば、EC2のインスタンスタイプを無料利用枠のみに制限したい場合、<code>aws_ec2_instance_type</code>データソースから最新の無料利用枠の情報をAWSから取得し、インスタンス構築の際の条件に課すことが可能です。</p><p><code>lifecycle</code>ブロック内に<code>precondition</code>ブロックを作成し、<code>condition</code>の条件で真偽を判定し、偽の場合に<code>error_message</code>に記載されているメッセージを出力できます。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">data <span class="string">&quot;aws_ec2_instance_type&quot;</span> <span class="string">&quot;example&quot;</span> &#123;</span><br><span class="line">  instance_type = <span class="string">&quot;c5.xlarge&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource <span class="string">&quot;aws_instance&quot;</span> <span class="string">&quot;example&quot;</span> &#123;</span><br><span class="line">  ami           = <span class="string">&quot;ami-0f7b55661ecbbe44c&quot;</span></span><br><span class="line">  instance_type = data.aws_ec2_instance_type.example.instance_type</span><br><span class="line">  subnet_id     = <span class="string">&quot;subnet-xxxxxxxxxx&quot;</span></span><br><span class="line">  lifecycle &#123;</span><br><span class="line">    precondition &#123;</span><br><span class="line">      condition     = data.aws_ec2_instance_type.example.free_tier_eligible</span><br><span class="line">      error_message = <span class="string">&quot;This instance type is not free in AWS&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上記のようにインスタンスタイプを<code>c5.xlarge</code>(無料利用枠でないインスタンスタイプ)でplanを流してみるとどうなるでしょうか？</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">╷</span><br><span class="line">│ Error: Resource precondition failed</span><br><span class="line">│</span><br><span class="line">│   on main.tf line 18, <span class="keyword">in</span> resource <span class="string">&quot;aws_instance&quot;</span> <span class="string">&quot;example&quot;</span>:</span><br><span class="line">│   18:       condition     = data.aws_ec2_instance_type.example.free_tier_eligible</span><br><span class="line">│     ├────────────────</span><br><span class="line">│     │ data.aws_ec2_instance_type.example.free_tier_eligible is <span class="literal">false</span></span><br><span class="line">│</span><br><span class="line">│ This instance <span class="built_in">type</span> is not free <span class="keyword">in</span> AWS</span><br></pre></td></tr></table></figure><p>指定のエラーメッセージとともに無事？planが通らなくなりました。(当然、applyもできません。)</p><p>このように<code>validation</code>と違って動的な変数の制御を可能にするのが<code>precondition</code>の特徴です。</p><h3 id="preconditionのユースケース"><a href="#preconditionのユースケース" class="headerlink" title="preconditionのユースケース"></a>preconditionのユースケース</h3><p><code>validation</code>でハードコーディングするのが難しい場合に使うのが良いでしょう。</p><p>最新のAWSからの情報が常に反映されるため、より安定的なチェックが実施できます。</p><h2 id="postconditionについて"><a href="#postconditionについて" class="headerlink" title="postconditionについて"></a>postconditionについて</h2><p><code>varidation</code>や<code>precondition</code>はapply前に変数をチェックする<strong>事前チェック</strong>でした。一方で<code>postcondition</code>は、<strong>applyの後にエラーを追跡</strong>する事後チェックが可能です。</p><p>例としてオートスケーリンググループを作成する際、AZが２つ以上あるかどうかをチェックしたい場合を考えます。書き方は<code>precondition</code>と同様で、<code>postcondition</code>ブロックの<code>condition</code>でAZの数が1よりも大きくない場合に指定のエラーメッセージを出力するようにします。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">resource <span class="string">&quot;aws_launch_configuration&quot;</span> <span class="string">&quot;example&quot;</span> &#123;</span><br><span class="line">  image_id      = <span class="string">&quot;ami-020283e959651b381&quot;</span></span><br><span class="line">  instance_type = <span class="string">&quot;t2.micro&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource <span class="string">&quot;aws_autoscaling_group&quot;</span> <span class="string">&quot;example&quot;</span> &#123;</span><br><span class="line">  name                 = <span class="string">&quot;ASG&quot;</span></span><br><span class="line">  launch_configuration = aws_launch_configuration.example.name</span><br><span class="line">  vpc_zone_identifier  = [<span class="string">&quot;subnet-xxxxxxx&quot;</span>]</span><br><span class="line">  min_size             = 1</span><br><span class="line">  max_size             = 1</span><br><span class="line"></span><br><span class="line">  lifecycle &#123;</span><br><span class="line">    postcondition &#123;</span><br><span class="line">      condition     = length(self.availability_zones) &gt; 1</span><br><span class="line">      error_message = <span class="string">&quot;You need to choose more than 1 AZ to ensure high availability&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>planをしてみましょう。この時点でAZは<code>known after apply</code>とあるので、エラーは捕捉されずにplan自体は通ります。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">Terraform will perform the following actions:</span><br><span class="line"></span><br><span class="line">  <span class="comment"># aws_autoscaling_group.example will be created</span></span><br><span class="line">  + resource <span class="string">&quot;aws_autoscaling_group&quot;</span> <span class="string">&quot;example&quot;</span> &#123;</span><br><span class="line">      + arn                              = (known after apply)</span><br><span class="line">      + availability_zones               = (known after apply)</span><br><span class="line">      + default_cooldown                 = (known after apply)</span><br><span class="line">      + desired_capacity                 = (known after apply)</span><br><span class="line">      + force_delete                     = <span class="literal">false</span></span><br><span class="line">      + force_delete_warm_pool           = <span class="literal">false</span></span><br><span class="line">      + health_check_grace_period        = 300</span><br><span class="line">      + health_check_type                = (known after apply)</span><br><span class="line">      + <span class="built_in">id</span>                               = (known after apply)</span><br><span class="line">      + ignore_failed_scaling_activities = <span class="literal">false</span></span><br><span class="line">      + launch_configuration             = (known after apply)</span><br><span class="line">      + load_balancers                   = (known after apply)</span><br><span class="line">      + max_size                         = 1</span><br><span class="line">      + metrics_granularity              = <span class="string">&quot;1Minute&quot;</span></span><br><span class="line">      + min_size                         = 1</span><br><span class="line">      + name                             = <span class="string">&quot;ASG&quot;</span></span><br><span class="line">      + name_prefix                      = (known after apply)</span><br><span class="line">      + predicted_capacity               = (known after apply)</span><br><span class="line">      + protect_from_scale_in            = <span class="literal">false</span></span><br><span class="line">      + service_linked_role_arn          = (known after apply)</span><br><span class="line">      + target_group_arns                = (known after apply)</span><br><span class="line">      + vpc_zone_identifier              = [</span><br><span class="line">          + <span class="string">&quot;subnet-xxxxxxx&quot;</span>,</span><br><span class="line">        ]</span><br><span class="line">      + wait_for_capacity_timeout        = <span class="string">&quot;10m&quot;</span></span><br><span class="line">      + warm_pool_size                   = (known after apply)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># aws_launch_configuration.example will be created</span></span><br><span class="line">  + resource <span class="string">&quot;aws_launch_configuration&quot;</span> <span class="string">&quot;example&quot;</span> &#123;</span><br><span class="line">      + arn                         = (known after apply)</span><br><span class="line">      + associate_public_ip_address = (known after apply)</span><br><span class="line">      + ebs_optimized               = (known after apply)</span><br><span class="line">      + enable_monitoring           = <span class="literal">true</span></span><br><span class="line">      + <span class="built_in">id</span>                          = (known after apply)</span><br><span class="line">      + image_id                    = <span class="string">&quot;ami-020283e959651b381&quot;</span></span><br><span class="line">      + instance_type               = <span class="string">&quot;t2.micro&quot;</span></span><br><span class="line">      + key_name                    = (known after apply)</span><br><span class="line">      + name                        = (known after apply)</span><br><span class="line">      + name_prefix                 = (known after apply)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">Plan: 2 to add, 0 to change, 0 to destroy.</span><br></pre></td></tr></table></figure><p>この状態でapplyすると完了後に下記のエラーが出ます。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">╷</span><br><span class="line">│ Error: Resource postcondition failed</span><br><span class="line">│</span><br><span class="line">│   on main.tf line 38, <span class="keyword">in</span> resource <span class="string">&quot;aws_autoscaling_group&quot;</span> <span class="string">&quot;example&quot;</span>:</span><br><span class="line">│   38:       condition     = length(self.availability_zones) &gt; 1</span><br><span class="line">│     ├────────────────</span><br><span class="line">│     │ self.availability_zones is <span class="built_in">set</span> of string with 1 element</span><br><span class="line">│</span><br><span class="line">│ You need to choose more than 1 AZ to ensure high availability</span><br></pre></td></tr></table></figure><p>エラーは出力されていますが、<code>precondition</code>と異なり、planはちゃんと通ってリソースまで作成されているのが分かります。</p><p>これが<code>postcondition</code>の事後チェックというもので、apply後へのリソースの変数に対するチェックを実施することが可能になっています。</p><h3 id="postconditionのユースケース"><a href="#postconditionのユースケース" class="headerlink" title="postconditionのユースケース"></a>postconditionのユースケース</h3><p><code>validation</code>や<code>precondition</code>などの事前チェックのみで補足しきれない条件を課すのが良いでしょう。</p><p>上記のような例だと、apply時にリソースが作成されてしまうので、事前チェックのようにリソース作成前に制限を課すような強い制約ができないことには注意が必要です。</p><h2 id="おまけ"><a href="#おまけ" class="headerlink" title="おまけ"></a>おまけ</h2><p>インスタンスタイプの選定で<code>precondition</code>を使いましたが、<code>precondition</code>→<code>postcondition</code>と単純に置き換えてみたらどうなるでしょうか？</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">data <span class="string">&quot;aws_ec2_instance_type&quot;</span> <span class="string">&quot;example&quot;</span> &#123;</span><br><span class="line">  instance_type = <span class="string">&quot;c5.xlarge&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource <span class="string">&quot;aws_instance&quot;</span> <span class="string">&quot;example&quot;</span> &#123;</span><br><span class="line">  ami           = <span class="string">&quot;ami-0f7b55661ecbbe44c&quot;</span></span><br><span class="line">  instance_type = data.aws_ec2_instance_type.example.instance_type</span><br><span class="line">  subnet_id     = <span class="string">&quot;subnet-xxxxxxx&quot;</span></span><br><span class="line">  lifecycle &#123;</span><br><span class="line">    postcondition &#123;</span><br><span class="line">      condition     = data.aws_ec2_instance_type.example.free_tier_eligible</span><br><span class="line">      error_message = <span class="string">&quot;This instance type is not free in AWS&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上記は<a href="#precondition%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">preconditionについて</a>におけるコードで<code>precondition</code>が<code>postcondition</code>に置き換わっているだけです。</p><p>planで下記エラーが出てきます。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:</span><br><span class="line">  + create</span><br><span class="line"></span><br><span class="line">Terraform planned the following actions, but <span class="keyword">then</span> encountered a problem:</span><br><span class="line"></span><br><span class="line">  <span class="comment"># aws_instance.example will be created</span></span><br><span class="line">  + resource <span class="string">&quot;aws_instance&quot;</span> <span class="string">&quot;example&quot;</span> &#123;</span><br><span class="line">      + ami                                  = <span class="string">&quot;ami-0f7b55661ecbbe44c&quot;</span></span><br><span class="line">      + arn                                  = (known after apply)</span><br><span class="line">      + associate_public_ip_address          = (known after apply)</span><br><span class="line">      + availability_zone                    = (known after apply)</span><br><span class="line">      + cpu_core_count                       = (known after apply)</span><br><span class="line">      + cpu_threads_per_core                 = (known after apply)</span><br><span class="line">      + disable_api_stop                     = (known after apply)</span><br><span class="line">      + disable_api_termination              = (known after apply)</span><br><span class="line">      + ebs_optimized                        = (known after apply)</span><br><span class="line">      + get_password_data                    = <span class="literal">false</span></span><br><span class="line">      + host_id                              = (known after apply)</span><br><span class="line">      + host_resource_group_arn              = (known after apply)</span><br><span class="line">      + iam_instance_profile                 = (known after apply)</span><br><span class="line">      + <span class="built_in">id</span>                                   = (known after apply)</span><br><span class="line">      + instance_initiated_shutdown_behavior = (known after apply)</span><br><span class="line">      + instance_lifecycle                   = (known after apply)</span><br><span class="line">      + instance_state                       = (known after apply)</span><br><span class="line">      + instance_type                        = <span class="string">&quot;c5.xlarge&quot;</span></span><br><span class="line">      + ipv6_address_count                   = (known after apply)</span><br><span class="line">      + ipv6_addresses                       = (known after apply)</span><br><span class="line">      + key_name                             = (known after apply)</span><br><span class="line">      + monitoring                           = (known after apply)</span><br><span class="line">      + outpost_arn                          = (known after apply)</span><br><span class="line">      + password_data                        = (known after apply)</span><br><span class="line">      + placement_group                      = (known after apply)</span><br><span class="line">      + placement_partition_number           = (known after apply)</span><br><span class="line">      + primary_network_interface_id         = (known after apply)</span><br><span class="line">      + private_dns                          = (known after apply)</span><br><span class="line">      + private_ip                           = (known after apply)</span><br><span class="line">      + public_dns                           = (known after apply)</span><br><span class="line">      + public_ip                            = (known after apply)</span><br><span class="line">      + secondary_private_ips                = (known after apply)</span><br><span class="line">      + security_groups                      = (known after apply)</span><br><span class="line">      + source_dest_check                    = <span class="literal">true</span></span><br><span class="line">      + spot_instance_request_id             = (known after apply)</span><br><span class="line">      + subnet_id                            = <span class="string">&quot;subnet-xxxxxxx&quot;</span></span><br><span class="line">      + tags_all                             = (known after apply)</span><br><span class="line">      + tenancy                              = (known after apply)</span><br><span class="line">      + user_data                            = (known after apply)</span><br><span class="line">      + user_data_base64                     = (known after apply)</span><br><span class="line">      + user_data_replace_on_change          = <span class="literal">false</span></span><br><span class="line">      + vpc_security_group_ids               = (known after apply)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">Plan: 1 to add, 0 to change, 0 to destroy.</span><br><span class="line">╷</span><br><span class="line">│ Error: Resource postcondition failed</span><br><span class="line">│</span><br><span class="line">│   on main.tf line 11, <span class="keyword">in</span> resource <span class="string">&quot;aws_instance&quot;</span> <span class="string">&quot;example&quot;</span>:</span><br><span class="line">│   11:       condition     = data.aws_ec2_instance_type.example.free_tier_eligible</span><br><span class="line">│     ├────────────────</span><br><span class="line">│     │ data.aws_ec2_instance_type.example.free_tier_eligible is <span class="literal">false</span></span><br><span class="line">│</span><br><span class="line">│ This instance <span class="built_in">type</span> is not free <span class="keyword">in</span> AWS</span><br></pre></td></tr></table></figure><p>エラーメッセージは<code>precondition</code>とほぼ変わらないのですが、<code>postcondition</code>では plan によるリソース出力が成功します（<code>precondition</code>ではplanが失敗してリソース出力がされませんでした）。</p><p>これは<code>postcondition</code>が事後チェックであることを反映している例で、データソースやリソースが取得された後で値が評価されていることを如実に表しています。</p><p>こうなると <code>postcondition</code>で全部チェックしてしまっても良い気もしますが、事後チェックであるか事後チェックであるかを明示するため、<code>precondition</code>で制御できる箇所は<code>precondition</code>で制御するようにしましょう。</p><h2 id="さいごに"><a href="#さいごに" class="headerlink" title="さいごに"></a>さいごに</h2><p>多くの変数に対して制限を課すのはなかなか大変で工数を取る上、可読性にも影響します。</p><p>修正の際にupdate in placeなどで気軽にアップデート出来ない変数(EBS暗号化の有無など)に対する制約から優先的に実施するのが個人的には良いと思います。</p><h2 id="参考リンク"><a href="#参考リンク" class="headerlink" title="参考リンク"></a>参考リンク</h2><ul><li><a href="https://www.oreilly.co.jp/books/9784814400522/">詳解Terraform</a></li></ul>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;img src=&quot;/images/20240313a/terraform_top.png&quot; alt=&quot;&quot; width=&quot;900&quot; height=&quot;628&quot;&gt;

&lt;p&gt;&lt;a href=&quot;/articles/20240311a/&quot;&gt;Terraform</summary>
        
      
    
    
    
    <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
    <category term="Terraform" scheme="https://future-architect.github.io/tags/Terraform/"/>
    
    <category term="Terraform1.2" scheme="https://future-architect.github.io/tags/Terraform1-2/"/>
    
  </entry>
  
  <entry>
    <title>Terraform連載2024 hclwriteを用いたtfコード生成入門</title>
    <link href="https://future-architect.github.io/articles/20240312a/"/>
    <id>https://future-architect.github.io/articles/20240312a/</id>
    <published>2024-03-11T15:00:00.000Z</published>
    <updated>2024-03-14T00:33:22.647Z</updated>
    
    <content type="html"><![CDATA[<p><a href="/articles/20240311a/">Terraform 連載2024</a> の2本目の記事です。</p><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>TIG真野です。</p><p>Terraformファイルをコード生成するため、hclwriteというGoパッケージの使い方を調べました。</p><h2 id="モチベーション"><a href="#モチベーション" class="headerlink" title="モチベーション"></a>モチベーション</h2><p>ある複数のリソースをセットで定義する設計開発ルールがあったとします。AWSの例ですが、以下のようにDynamoDBとその監視をCloudwatch Metricsを用いてセットで行いたいとします。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># DynamoDB</span></span><br><span class="line">resource <span class="string">&quot;aws_dynamodb_table&quot;</span> <span class="string">&quot;myproduct_read&quot;</span> &#123;</span><br><span class="line">  name         = <span class="string">&quot;<span class="variable">$&#123;terraform.workspace&#125;</span>-myproduct-read&quot;</span></span><br><span class="line">  billing_mode = <span class="string">&quot;PAY_PER_REQUEST&quot;</span></span><br><span class="line">  hash_key     = <span class="string">&quot;user_id&quot;</span></span><br><span class="line">  range_key    = <span class="string">&quot;content_id&quot;</span></span><br><span class="line"></span><br><span class="line">  deletion_protection_enabled = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  attribute &#123;</span><br><span class="line">    name = <span class="string">&quot;user_id&quot;</span></span><br><span class="line">    <span class="built_in">type</span> = <span class="string">&quot;S&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">  attribute &#123;</span><br><span class="line">    name = <span class="string">&quot;content_id&quot;</span></span><br><span class="line">    <span class="built_in">type</span> = <span class="string">&quot;S&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># DynamoDBに対して、Cloudwatch Metricsで監視する。例では1件だが複数あるとする</span></span><br><span class="line">resource <span class="string">&quot;aws_cloudwatch_metric_alarm&quot;</span> <span class="string">&quot;myproduct_read_dynamodb_throttledrequests&quot;</span> &#123;</span><br><span class="line">  alarm_name          = <span class="string">&quot;<span class="variable">$&#123;aws_dynamodb_table.myproduct_read.name&#125;</span>-ThrottledRequests&quot;</span></span><br><span class="line">  comparison_operator = <span class="string">&quot;GreaterThanOrEqualToThreshold&quot;</span></span><br><span class="line">  datapoints_to_alarm = <span class="string">&quot;1&quot;</span></span><br><span class="line">  evaluation_periods  = <span class="string">&quot;1&quot;</span></span><br><span class="line">  metric_name         = <span class="string">&quot;ThrottledRequests&quot;</span></span><br><span class="line">  namespace           = <span class="string">&quot;AWS/DynamoDB&quot;</span></span><br><span class="line">  period              = <span class="string">&quot;60&quot;</span></span><br><span class="line">  statistic           = <span class="string">&quot;Maximum&quot;</span></span><br><span class="line">  threshold           = <span class="string">&quot;1&quot;</span></span><br><span class="line">  alarm_actions       = aws_sns_topic.myproduct_alert.arn</span><br><span class="line">  dimensions = &#123;</span><br><span class="line">    TableName = aws_dynamodb_table.read.name</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ここではスロットリング数だけを監視していますが、もう1~5個くらい監視したい項目があったとします。この例のように、あるリソースの追加に合わせて整合性を保ちつつ別のリソースを追加することは難しく、抜け漏れがちです。</p><p>正攻法だとTerraform module化でしょう。しかし、このケースではモジュール化するにしてはリソース数が少なく、モジュール化すること自体が新規参画した開発者にとって認知負荷が高いことを考えると、もう少しプロダクトが成長して、関連するリソースが増えるかどうかを待ってから対応を考えたいケースもあるでしょう。もちろんチームの方針としてこれくらいでもすぐにモジュール化に取り掛かる場合もあるかと思いますが、チームのTerraform習熟度にバラツキがあり設計パターンを抑えたいなど、様々な背景があったとします。</p><p>こうした場面で、あるTerraformで定義したリソース（ここではDynamoDB）をインプットに別のコード（Cloudwatch Metrics）を生成し、モジュール化しなくとも不整合が生じにくい開発フローを整備したいと思います。これでモジュール化の判断を先送りにできますね。</p><img src="/images/20240312a/dynamodb_hclwrite.drawio.png" alt="" width="1200" height="631" loading="lazy"><p>ちなみに、通常、DynamoDBはそこまで数が増えない（ほいほい増えるようであればおそらくDynamoDBを使うべきではない）し、監視項目もそう変更しないだろうから、コード生成もモジュール化しなくても良いんじゃないか？という意見もあるかと思いますが、それはそれとします。</p><h2 id="整合性チェック"><a href="#整合性チェック" class="headerlink" title="整合性チェック"></a>整合性チェック</h2><p>この回のケースではRego（<a href="https://www.conftest.dev/">Conftest</a>）を使って整合性チェックを入れるのも有効でしょう。しかし開発チームにRego経験者はほとんど供給され無いと思うので、学習コストが多少なりとも掛かります。また、不整合を検知できるのであれば自動でFixしてくれた方が開発者フレンドリーです。</p><p>そのため、この記事では .tf ファイルの自動生成に注目します。</p><h2 id="利用パッケージ"><a href="#利用パッケージ" class="headerlink" title="利用パッケージ"></a>利用パッケージ</h2><p>Terraformの .tf コードをパース、生成する方法として有名なのは、<a href="https://github.com/hashicorp/hcl">hashicorp&#x2F;hcl</a> を用いることです。Go言語でインポートしてライブラリとして使えます。HCLはTerraformの.tfファイルが利用するファイルフォーマットのことです。</p><p>管理されているパッケージはいくつかあり、以下のようなものが含まれていて、いい感じに使い分けるリテラシーが求められます。</p><p>パッケージの概略はthaimさんのZenn記事の<a href="https://zenn.dev/thaim/articles/2023-03-go-hcl">HCLファイルを hashicorp&#x2F;hcl で読み書きする</a>が実装もありイメージしやすいです。</p><p>ここでも簡単に一覧を載せます。</p><div class="scroll"><table><thead><tr><th>Name</th><th>Memo</th></tr></thead><tbody><tr><td>hclsimple</td><td>HCLをGoの構造体にマッピングする、encoding&#x2F;json 的な高レベルなパッケージです。しかし、拡張子.tf には対応しておらず、全ての.tfファイルに対応していないことを言外に伝えています。</td></tr><tr><td>hclparse</td><td>HCLファイルをパースして、結果を独自のStructで取得できます</td></tr><tr><td>hclwrite</td><td>HCLファイルを加工するのに適したペッケージです。元のHCLファイルの構造を壊さず、リソースの追加&#x2F;削除、コメントや属性などの編集を行えます</td></tr><tr><td>hclsyntax</td><td>HCLを解析してASTを作るパッケージです。hclparseなどにも使われています</td></tr></tbody></table></div><p>今回はTerraformコードの細かい解析は不要であるため、hclwriteパッケージを利用します。</p><h2 id="hclwrite-でファイル読み込み"><a href="#hclwrite-でファイル読み込み" class="headerlink" title="hclwrite でファイル読み込み"></a>hclwrite でファイル読み込み</h2><p>バージョンは <code>hashicorp/hcl/v2 v2.20.0</code> を利用します。</p><p>まずは.tfファイルを読み込みます。</p><p><code>hclwrite.ParseConfig()</code> でパースしたいファイルを指定します。</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;github.com/hashicorp/hcl/v2&quot;</span></span><br><span class="line"><span class="string">&quot;github.com/hashicorp/hcl/v2/hclwrite&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(os.Args) == <span class="number">1</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">&quot;Usage: %s &lt;filepath&gt;\n&quot;</span>, os.Args[<span class="number">0</span>])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">hclFilePath := os.Args[<span class="number">1</span>]</span><br><span class="line">file, err := os.ReadFile(os.Args[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">&quot;Usage: %s &lt;filepath&gt;\n&quot;</span>, os.Args[<span class="number">1</span>])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tfFile, diags := hclwrite.ParseConfig(file, hclFilePath, hcl.Pos&#123;Line: <span class="number">1</span>, Column: <span class="number">1</span>&#125;)</span><br><span class="line"><span class="keyword">if</span> diags != <span class="literal">nil</span> &amp;&amp; diags.HasErrors() &#123;</span><br><span class="line">log.Fatalf(<span class="string">&quot;hclwrite parse: %s&quot;</span>, diags)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> tfFile == <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">&quot;parse result is nil: %s&quot;</span>, hclFilePath)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">blocks := tfFile.Body().Blocks()</span><br><span class="line">referenceNames := <span class="built_in">make</span>([]<span class="type">string</span>, <span class="number">0</span>, <span class="built_in">len</span>(blocks))</span><br><span class="line"><span class="keyword">for</span> _, b := <span class="keyword">range</span> blocks &#123;</span><br><span class="line"><span class="keyword">if</span> b.Type() != <span class="string">&quot;resource&quot;</span> || b.Labels()[<span class="number">0</span>] != <span class="string">&quot;aws_dynamodb_table&quot;</span> &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line">referenceNames = <span class="built_in">append</span>(referenceNames, b.Labels()[<span class="number">1</span>])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Println(referenceNames)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>結果の取得は <code>tfFile.Body().Blocks()</code> という部分で取得できます。</p><p>Blockとはなにかですが、 <code>resource</code>、<code>module</code>、<code>locals</code> のようなTerraform上でインデントをともなうような塊を指します。例えば、<code>resource &quot;aws_dynamodb_table&quot; &quot;table1&quot; &#123;...&#125;</code> といった定義が10あれば、for文が10呼ばれます。</p><p>次にわかりにくいのが <code>b.Labels()</code> の部分です。これは <code>aws_dynamodb_table</code>, <code>table1</code> といったブロックを開くときに設定されるTerraformのリソースタイプ、リソース名が入ります。</p><p>今回はTerraformのリソース名を取得して表示するとします。</p><p>次のようなファイルがあるとします。</p><figure class="highlight sh"><figcaption><span>dynamodb_table.tf</span></figcaption><table><tr><td class="code"><pre><span class="line">resource <span class="string">&quot;aws_dynamodb_table&quot;</span> <span class="string">&quot;myproduct_read&quot;</span> &#123;</span><br><span class="line">  name         = <span class="string">&quot;<span class="variable">$&#123;terraform.workspace&#125;</span>-myproduct-read&quot;</span></span><br><span class="line">  billing_mode = <span class="string">&quot;PAY_PER_REQUEST&quot;</span></span><br><span class="line">  hash_key     = <span class="string">&quot;user_id&quot;</span></span><br><span class="line">  range_key    = <span class="string">&quot;content_id&quot;</span></span><br><span class="line"></span><br><span class="line">  deletion_protection_enabled = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  attribute &#123;</span><br><span class="line">    name = <span class="string">&quot;user_id&quot;</span></span><br><span class="line">    <span class="built_in">type</span> = <span class="string">&quot;S&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">  attribute &#123;</span><br><span class="line">    name = <span class="string">&quot;content_id&quot;</span></span><br><span class="line">    <span class="built_in">type</span> = <span class="string">&quot;S&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource <span class="string">&quot;aws_dynamodb_table&quot;</span> <span class="string">&quot;myproduct_content&quot;</span> &#123;</span><br><span class="line">  name         = <span class="string">&quot;<span class="variable">$&#123;terraform.workspace&#125;</span>-myproduct-read&quot;</span></span><br><span class="line">  billing_mode = <span class="string">&quot;PAY_PER_REQUEST&quot;</span></span><br><span class="line">  hash_key     = <span class="string">&quot;content_id&quot;</span></span><br><span class="line"></span><br><span class="line">  deletion_protection_enabled = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  attribute &#123;</span><br><span class="line">    name = <span class="string">&quot;content_id&quot;</span></span><br><span class="line">    <span class="built_in">type</span> = <span class="string">&quot;S&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>さきほどのコードを実行すると、Terraformリソース名が取れています。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ go run . ../example/dynamodb_table.tf</span><br><span class="line">[myproduct_read myproduct_content]</span><br></pre></td></tr></table></figure><p>属性を取得するためには、<code>b.Body().GetAttribute()</code> などで取得できますので、目的に応じて条件を追加することができます。</p><h2 id="空リソース生成"><a href="#空リソース生成" class="headerlink" title="空リソース生成"></a>空リソース生成</h2><p>次に.tfファイルを生成します。</p><p><code>hclwrite.NewFile()</code> で初期化し、そこにブロック（Terraformリソース）を追加していきます。</p><p>今回は新規コード生成なので、先頭に <code>// DO NOT EDIT</code> コメントを追加しましょう。</p><p>hclwriteを用いるとコメントを追加する便利な関数は（おそらく）存在しないので、いきなりですがトークンレベルの操作となる、<code>AppendUnstructedTokens()</code> を用います。</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// 中略</span></span><br><span class="line"></span><br><span class="line">newFile := hclwrite.NewFile()</span><br><span class="line">newFile.Body().AppendUnstructuredTokens(hclwrite.Tokens&#123; <span class="comment">// 先頭行にコメント追加</span></span><br><span class="line">&#123;</span><br><span class="line">Type:  hclsyntax.TokenIdent,</span><br><span class="line">Bytes: []<span class="type">byte</span>(<span class="string">&quot;// DO NOT EDIT, MADE BY hclwrite-dynamodb-generator\n&quot;</span>),</span><br><span class="line">&#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, resourceName := <span class="keyword">range</span> referenceNames &#123;</span><br><span class="line">newFile.Body().AppendUnstructuredTokens(hclwrite.Tokens&#123;</span><br><span class="line">&#123;Type: hclsyntax.TokenNewline, Bytes: []<span class="type">byte</span>(<span class="string">&quot;\n&quot;</span>)&#125;, <span class="comment">// 先頭行に改行を入れる</span></span><br><span class="line">&#125;)</span><br><span class="line">labels := []<span class="type">string</span>&#123;<span class="string">&quot;aws_cloudwatch_metric_alarm&quot;</span>, fmt.Sprintf(<span class="string">&quot;dynamodb_throttledrequests_%s&quot;</span>, resourceName)&#125;</span><br><span class="line">newFile.Body().AppendNewBlock(<span class="string">&quot;resource&quot;</span>, labels)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">out := hclwrite.Format(newFile.BuildTokens(<span class="literal">nil</span>).Bytes())</span><br><span class="line">_, _ = fmt.Fprint(os.Stdout, <span class="type">string</span>(out))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>for 文の中にある、 <code>AppendNewBlock()</code> が今回出力したい本丸の、<code>aws_cloudwatch_metric_alarm</code> リソースを追加する部分です。</p><p>実行すると次のような空リソースが生成されます。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ go run . ../example/dynamodb_table_one.tf</span><br><span class="line">// DO NOT EDIT, MADE BY hclwrite-dynamodb-generator</span><br><span class="line"></span><br><span class="line">resource <span class="string">&quot;aws_cloudwatch_metric_alarm&quot;</span> <span class="string">&quot;dynamodb_throttledrequests_myproduct_read&quot;</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource <span class="string">&quot;aws_cloudwatch_metric_alarm&quot;</span> <span class="string">&quot;dynamodb_throttledrequests_myproduct_content&quot;</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="属性の追加"><a href="#属性の追加" class="headerlink" title="属性の追加"></a>属性の追加</h2><p><code>SetAttributeRaw()</code> を用いて各属性ごとに項目を追加していきます。 <code>SetAttributeRaw()</code> は低レベルのAPIで、トークンを直接追加します。今回、<code>&quot;$&#123;aws_dynamodb_table.myproduct_read.name&#125;-throttledrequests&quot;</code> といったリファレンスを追加したいため利用しています。<code>SetAttributeValue()</code> を使う方法だと、 <code>$</code> がエスケープされて、 <code>$$</code> と出力されてしまうためです。</p><p>また、特記したいことは<a href="https://github.com/zclconf/go-cty">zclconf&#x2F;go-cty</a> というライブラリの型で値を競ってしないとならないことです。ここでさらに別のライブラリ？と一瞬焦る気持ちがありますが、慣れていきましょう。</p><p>属性の型がオブジェクトであり、その中にリファレンスが入ると、再び <code>AppendNewBlock()</code> を呼び出す必要があるなど、生成したい定義によっては試行錯誤する必要があるので、注意してください。</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// 中略</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _, resourceName := <span class="keyword">range</span> referenceNames &#123;</span><br><span class="line">newFile.Body().AppendUnstructuredTokens(hclwrite.Tokens&#123;</span><br><span class="line">&#123;Type: hclsyntax.TokenNewline, Bytes: []<span class="type">byte</span>(<span class="string">&quot;\n&quot;</span>)&#125;, <span class="comment">// 先頭行に改行を入れる</span></span><br><span class="line">&#125;)</span><br><span class="line">labels := []<span class="type">string</span>&#123;<span class="string">&quot;aws_cloudwatch_metric_alarm&quot;</span>, fmt.Sprintf(<span class="string">&quot;dynamodb_throttledrequests_%s&quot;</span>, resourceName)&#125;</span><br><span class="line">resource := newFile.Body().AppendNewBlock(<span class="string">&quot;resource&quot;</span>, labels).Body()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 属性の定義</span></span><br><span class="line">resource.SetAttributeRaw(<span class="string">&quot;alarm_name&quot;</span>, hclwrite.Tokens&#123;</span><br><span class="line">&#123;</span><br><span class="line">Type:  hclsyntax.TokenIdent,</span><br><span class="line">Bytes: []<span class="type">byte</span>(<span class="string">`&quot;$&#123;aws_dynamodb_table.myproduct_read.name&#125;-throttledrequests&quot;`</span>),</span><br><span class="line">&#125;,</span><br><span class="line">&#125;)</span><br><span class="line">resource.SetAttributeValue(<span class="string">&quot;comparison_operator&quot;</span>, cty.StringVal(<span class="string">&quot;GreaterThanOrEqualToThreshold&quot;</span>))</span><br><span class="line">resource.SetAttributeValue(<span class="string">&quot;datapoints_to_alarm&quot;</span>, cty.StringVal(<span class="string">&quot;1&quot;</span>))</span><br><span class="line">resource.SetAttributeValue(<span class="string">&quot;evaluation_periods&quot;</span>, cty.StringVal(<span class="string">&quot;1&quot;</span>))</span><br><span class="line">resource.SetAttributeValue(<span class="string">&quot;metric_name&quot;</span>, cty.StringVal(<span class="string">&quot;ThrottledRequests&quot;</span>))</span><br><span class="line">resource.SetAttributeValue(<span class="string">&quot;namespace&quot;</span>, cty.StringVal(<span class="string">&quot;AWS/DynamoDB&quot;</span>))</span><br><span class="line">resource.SetAttributeValue(<span class="string">&quot;period&quot;</span>, cty.StringVal(<span class="string">&quot;60&quot;</span>))</span><br><span class="line">resource.SetAttributeValue(<span class="string">&quot;statistic&quot;</span>, cty.StringVal(<span class="string">&quot;Maximum&quot;</span>))</span><br><span class="line">resource.SetAttributeValue(<span class="string">&quot;threshold&quot;</span>, cty.StringVal(<span class="string">&quot;1&quot;</span>))</span><br><span class="line">resource.SetAttributeTraversal(<span class="string">&quot;alarm_actions&quot;</span>, hcl.Traversal&#123;</span><br><span class="line">hcl.TraverseRoot&#123;Name: <span class="string">&quot;aws_sns_topic&quot;</span>&#125;,</span><br><span class="line">hcl.TraverseAttr&#123;Name: <span class="string">&quot;myproduct_alert&quot;</span>&#125;,</span><br><span class="line">hcl.TraverseAttr&#123;Name: <span class="string">&quot;arn&quot;</span>&#125;,</span><br><span class="line">&#125;)</span><br><span class="line">dimensions := resource.AppendNewBlock(<span class="string">&quot;dimensions&quot;</span>, <span class="literal">nil</span>).Body()</span><br><span class="line">dimensions.SetAttributeTraversal(<span class="string">&quot;TableName&quot;</span>, hcl.Traversal&#123;</span><br><span class="line">hcl.TraverseRoot&#123;Name: <span class="string">&quot;aws_dynamodb_table&quot;</span>&#125;,</span><br><span class="line">hcl.TraverseAttr&#123;Name: <span class="string">&quot;myproduct_read&quot;</span>&#125;,</span><br><span class="line">hcl.TraverseAttr&#123;Name: <span class="string">&quot;name&quot;</span>&#125;,</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">out := hclwrite.Format(newFile.BuildTokens(<span class="literal">nil</span>).Bytes())</span><br><span class="line">_, _ = fmt.Fprint(os.Stdout, <span class="type">string</span>(out))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>これを実行すると次のようにTerraformコードが生成されます。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ go run . example/dynamodb_table_one.tf</span><br><span class="line">// DO NOT EDIT, MADE BY hclwrite-dynamodb-generator</span><br><span class="line"></span><br><span class="line">resource <span class="string">&quot;aws_cloudwatch_metric_alarm&quot;</span> <span class="string">&quot;dynamodb_throttledrequests_myproduct_read&quot;</span> &#123;</span><br><span class="line">  alarm_name          = <span class="string">&quot;<span class="variable">$&#123;aws_dynamodb_table.myproduct_read.name&#125;</span>-throttledrequests&quot;</span></span><br><span class="line">  comparison_operator = <span class="string">&quot;GreaterThanOrEqualToThreshold&quot;</span></span><br><span class="line">  datapoints_to_alarm = <span class="string">&quot;1&quot;</span></span><br><span class="line">  evaluation_periods  = <span class="string">&quot;1&quot;</span></span><br><span class="line">  metric_name         = <span class="string">&quot;ThrottledRequests&quot;</span></span><br><span class="line">  namespace           = <span class="string">&quot;AWS/DynamoDB&quot;</span></span><br><span class="line">  period              = <span class="string">&quot;60&quot;</span></span><br><span class="line">  statistic           = <span class="string">&quot;Maximum&quot;</span></span><br><span class="line">  threshold           = <span class="string">&quot;1&quot;</span></span><br><span class="line">  alarm_actions       = aws_sns_topic.myproduct_alert.arn</span><br><span class="line">  dimensions &#123;</span><br><span class="line">    TableName = aws_dynamodb_table.myproduct_read.name</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource <span class="string">&quot;aws_cloudwatch_metric_alarm&quot;</span> <span class="string">&quot;dynamodb_throttledrequests_myproduct_content&quot;</span> &#123;</span><br><span class="line">  alarm_name          = <span class="string">&quot;<span class="variable">$&#123;aws_dynamodb_table.myproduct_read.name&#125;</span>-throttledrequests&quot;</span></span><br><span class="line">  comparison_operator = <span class="string">&quot;GreaterThanOrEqualToThreshold&quot;</span></span><br><span class="line">  datapoints_to_alarm = <span class="string">&quot;1&quot;</span></span><br><span class="line">  evaluation_periods  = <span class="string">&quot;1&quot;</span></span><br><span class="line">  metric_name         = <span class="string">&quot;ThrottledRequests&quot;</span></span><br><span class="line">  namespace           = <span class="string">&quot;AWS/DynamoDB&quot;</span></span><br><span class="line">  period              = <span class="string">&quot;60&quot;</span></span><br><span class="line">  statistic           = <span class="string">&quot;Maximum&quot;</span></span><br><span class="line">  threshold           = <span class="string">&quot;1&quot;</span></span><br><span class="line">  alarm_actions       = aws_sns_topic.myproduct_alert.arn</span><br><span class="line">  dimensions &#123;</span><br><span class="line">    TableName = aws_dynamodb_table.myproduct_read.name</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>hclwriteパッケージ自体は文法チェックを行いません。そのため　<code>alarm_actions = aws_sns_topic.myproduct_alert.arn</code> としれっと存在しないリソースを参照してもエラーにはなりません。</p><p>説明を省きましたが <code>hclwrite.Format()</code> でフォーマットをかけられるので、お手軽です。</p><p>今回使用したコードの全量は↓のリポジトリにコミットしています。</p><p><a href="https://github.com/ma91n/hclwrite-dynamodb">https://github.com/ma91n/hclwrite-dynamodb</a></p><h2 id="hclwriteパッケージを利用すべきか"><a href="#hclwriteパッケージを利用すべきか" class="headerlink" title="hclwriteパッケージを利用すべきか"></a>hclwriteパッケージを利用すべきか</h2><p>究極的には生成したいTerraformコードがどのようなものであるかに依存しますが、あるTerraformコードを読み取って別のファイルを生成するだけであれば、hclwriteパッケージを用いてもそれほど難しくはありません。</p><p>今回の内容であれば、パース部分もHCLの構造を無視し、スクラッチで解析しても良さそうなレベルではあります。しかし、複数のリソースタイプが混ざったり、ある属性の条件でのみを対象としたいといった拡張はしばしばありえるので、こういったライブラリを用いてパースすると良いでしょう。</p><p>一方で生成側です。今回の用途だと、既存ファイルの更新ではなく新規生成です。しかも成果物の構造のシンプル。この場合は、<code>hclwrite</code> の仕様を学んでゴリッと出力するより、Go Templateなどお好きなてプレートエンジンで生成するほうが遥かにメンテナンスがしやすいいと思います。HCLのフォーマットだけは使っても良いかもしれませんが、全てをhclwriteで閉じて生成するのは、出力がこれだけであれば割に合わない気がしました。</p><p><code>hclwrite</code> ですが主な用途はすでに存在するTerraformのコードを破壊せず、一律でタグを付けたり属性を変えたりといった用途に向いているパッケージのようです。</p><h2 id="最後に"><a href="#最後に" class="headerlink" title="最後に"></a>最後に</h2><p>hclwriteというパッケージを用いてあるTerraformリソースから、別のリソースを生成しました。新規生成については別のテンプレートエンジンを利用する方が良いかなと個人的には思います。</p><p>こういった開発フローは少し特殊で、通常はTerraformモジュール化などを試みると思いますが、モジュール化するにしてはリソース対象が少なく、ちょっと抽象度が弱いんだよな～といった場面では、コード生成案も考えてみても良いのではないでしょうか。</p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;&lt;a href=&quot;/articles/20240311a/&quot;&gt;Terraform 連載2024&lt;/a&gt; の2本目の記事です。&lt;/p&gt;
&lt;h2 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot;</summary>
        
      
    
    
    
    <category term="Infrastructure" scheme="https://future-architect.github.io/categories/Infrastructure/"/>
    
    
    <category term="Go" scheme="https://future-architect.github.io/tags/Go/"/>
    
    <category term="Terraform" scheme="https://future-architect.github.io/tags/Terraform/"/>
    
    <category term="hclwrite" scheme="https://future-architect.github.io/tags/hclwrite/"/>
    
  </entry>
  
  <entry>
    <title>Terraform連載2024を開始します &amp; TerraformにおけるDR戦略を考える</title>
    <link href="https://future-architect.github.io/articles/20240311a/"/>
    <id>https://future-architect.github.io/articles/20240311a/</id>
    <published>2024-03-10T15:00:00.000Z</published>
    <updated>2024-03-28T06:42:47.217Z</updated>
    
    <content type="html"><![CDATA[<img src="/images/20240311a/terraform.png" alt="" width="800" height="418" loading="lazy"><p>こんにちは。技術ブログ運営の伊藤です。<br>本日、3&#x2F;11よりTerraform連載を開始します。</p><h2 id="昨年の連載振り返りと今年の連載について"><a href="#昨年の連載振り返りと今年の連載について" class="headerlink" title="昨年の連載振り返りと今年の連載について"></a>昨年の連載振り返りと今年の連載について</h2><p>昨年はTerraform v1.4がリリースされたことをトリガーとして技術ブログでは初となるTerraform連載2023を開催しました。その時の募集形態は以下です。</p><blockquote><ul><li>v1.4のリリース内容</li><li>これまでTerraformを触ってきたノウハウ、Tips</li><li>エコシステムについての調査、学習</li></ul></blockquote><p>今年の連載については上記の中から1点目を除き、社内に募集をかけました。すると、募集開始後数日であっという間に10人強集まり、社内でも利用者が増えていること、ナレッジが蓄積されてきていることを感じています。</p><p>さて、目を世の中に向けてみて、どれくらいTerraformに対しての興味関心があるのかと思い、Google Trendsで調べたところ、以下のグラフとなりました。</p><img src="/images/20240311a/スクリーンショット_2024-03-11_0.02.27.png" alt="" width="1000" height="244" loading="lazy">注) 青: Terraform, 赤: CloudFormation<p>Terraformとパブリッククラウドの中では利用比率が最も高い、AWSのCloudFormationとの比較ですが、大きく差が開いており、その興味関心度を伺うことができます。ちなみに、v1.0のリリースが2021年の夏頃でしたが、その半年後の2022年に入って以降が伸びているようです。</p><h2 id="連載スケジュール"><a href="#連載スケジュール" class="headerlink" title="連載スケジュール"></a>連載スケジュール</h2><p>今回の連載は10人を超すメンバーでお送りします。まだテーマ未定のところもありますが、公開時までのお楽しみということでしばらくお待ちください。</p><p>また、テーマが決まっているものも変更になったり順番が前後する可能性もありますが、ご了承ください。</p><div class="scroll"><table><thead><tr><th>日付</th><th>投稿者</th><th>テーマ</th></tr></thead><tbody><tr><td>3&#x2F;11(月)</td><td>伊藤太斉</td><td>本インデックス記事 &amp; <br> TerraformにおけるDR戦略を考える</td></tr><tr><td>3&#x2F;12(火)</td><td>真野隼記</td><td><a href="/articles/20240312a/">hclwriteを用いたtfコード生成入門</a></td></tr><tr><td>3&#x2F;13(水)</td><td>森大作</td><td><a href="/articles/20240313a/">Terraformにおける変数の制御について</a></td></tr><tr><td>3&#x2F;14(木)</td><td>原田達也</td><td><a href="/articles/20240314a/">Stateを統合してみる</a>]</td></tr><tr><td>3&#x2F;15(金)</td><td>岸下優介</td><td><a href="/articles/20240315a/">サービスの多国展開を支えるTerraform構成</a></td></tr><tr><td>3&#x2F;18(月)</td><td>原木翔</td><td><a href="/articles/20240318a/">cfn-guardを使ってTerraformをポリシーチェックしようとした話</a></td></tr><tr><td>3&#x2F;21(木)</td><td>前原応光</td><td><a href="/articles/20240321a/">Terraform連載2024 テストとモックを使ってみる</a></td></tr><tr><td>3&#x2F;25(月)</td><td>真鍋優</td><td><a href="/articles/20240325a/">Azure環境Terraform実行におけるリソースプロバイダーについて</a></td></tr><tr><td>3&#x2F;26(火)</td><td>棚井龍之介</td><td><a href="/articles/20240326a/">Terraformの実装コードを、動かしながら読む</a></td></tr><tr><td>3&#x2F;27(水)</td><td>大岩潤矢</td><td><a href="/articles/20240327a/">手動運用しているCloudflareをTerraformでInfrastructure as Codeする</a></td></tr><tr><td>3&#x2F;28(木)</td><td>小林弘樹</td><td><a href="/articles/20240328b/">Terraformでのループ処理と条件分岐</a></td></tr></tbody></table></div><hr><h2 id="Terraformで考えるマルチリージョン構成"><a href="#Terraformで考えるマルチリージョン構成" class="headerlink" title="Terraformで考えるマルチリージョン構成"></a>Terraformで考えるマルチリージョン構成</h2><p>Terraform、もといIaCのメリット、思想として謳われるものの中には可搬性、再利用性があります。再利用性を上げておくことで、同じ構成のインフラ、サービス群を一括して作成することができ、手作業と比べた時の再現性、信頼度が大きくなることはいうまでもありません。</p><p>具体、業務を前提としたITインフラ環境を考えたときに、社会インフラとして稼働しているサービスや、どんな状況であろうとも24時間365日稼働していないといけないサービス、企業があります。このような企業では災害対策環境として、地理的に大きく離れたエリアにDCを構えることで、ある1点で甚大な災害が発生してサービス断になったとしても、別のDCで継続することが可能になります(もちろん一定時間のサービス断は発生しますが、数日、数ヶ月単位になることはほぼないでしょう）。</p><p>この災害対策環境（この後はDR環境と記載します）については…</p><ol><li>本環境と100％同じ環境で常時稼働</li><li>本環境→DR環境へ切り替え時に100%にする（一部はDRで常時稼働）</li><li>DRを一括して稼働（直前までDRでの稼働はなし）</li></ol><p>…のいくつかのパターンが考えられます。昨今のクラウドインフラを鑑みると、コストメリット、移行の容易性を考えると2が妥当と考えられるケースが多いかと思います。事前にDR環境へ作成するリソースについても本環境と同等、同様のものを作ることは少なく、このハンドリングについてはTerraformの記載に依存するものがあります。本記事ではいくつかのパターンに分けつつ、今私自身が実践している方法について説明します。</p><h2 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h2><p>今回のTerraformの構成はモジュールを利用して説明します。採用理由はモジュールという形でパッキングしておくことで、特定の単位のリソースを一括して起動することができることにあります。本環境とDR環境では基本的には同一のインフラができることが望ましいので、モジュールであれば任意の単位で横展開できることを考えています。</p><p>また、本環境のリージョンを東京（ap-northeast-1）、DR環境を大阪リージョン（ap-northeast-3)で構成することを前提とします。</p><h3 id="どの単位で分割するか"><a href="#どの単位で分割するか" class="headerlink" title="どの単位で分割するか"></a>どの単位で分割するか</h3><p>いくつか、分割する単位にも考える余地があるかと思います。これは、私自身が構築した所感ですが、1つのモジュールでDR環境まで表現することはせず、<strong>本環境向けで構築をした上で、DRにも展開できる様に手を入れる</strong>のが良いのではないかと考えています。これには</p><ul><li>Terraformの機能としてリソースの作成可否をハンドリングできること</li><li>1つのモジュールでDR環境まで表現するとモジュールが肥大化する</li></ul><p>があげられます。前者についてはさらに3点に場合分けして説明しますが、後者については肥大化することで可読性や重複した表現でリソースの適用漏れなどヒューマンエラーの元になります。また、肥大化したとしても本環境、DR環境にフォーカスするのであればあまり大きな問題にはなりません。ただ、実際にはDR環境まで作らない環境（開発環境など）にも同じモジュールを適用する場合、DR向けとして定義したリソースのハンドリングが煩雑になることが容易に想像されます。いきなりDR環境も同じモジュールで構築する、というのは難しいですが、本環境向けのみに作成の上、少々のテコ入れをすることが望ましいです。</p><p>前者について、さらに場合分けすると…</p><ul><li>本環境、DR環境に同等のリソースを作成する場合</li><li>本環境のパラメータ（リソース）を引用する形で作成する場合</li><li>本番のみに作成する場合<ul><li>DRは有事の際に作成する前提</li></ul></li></ul><p>…の3つが挙げられます。これらについてさらに説明します。</p><h3 id="本環境にもDR環境にも同等のリソースを作成する場合-純粋な複製"><a href="#本環境にもDR環境にも同等のリソースを作成する場合-純粋な複製" class="headerlink" title="本環境にもDR環境にも同等のリソースを作成する場合(純粋な複製)"></a>本環境にもDR環境にも同等のリソースを作成する場合(純粋な複製)</h3><p>まずは純粋な複製で済む場合です、ちょっと極端ですが、VPCのみをラップしているモジュールがあると仮定します。</p><figure class="highlight sh"><figcaption><span>vpc.tf</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment"># vpc.tf</span></span><br><span class="line">resource <span class="string">&quot;aws_vpc&quot;</span> <span class="string">&quot;main&quot;</span> &#123;</span><br><span class="line">  cidr_block = var.vpc_cidr_block</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable <span class="string">&quot;vpc_cidr_block&quot;</span> &#123;</span><br><span class="line">  <span class="built_in">type</span> = string</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight sh"><figcaption><span>main.tf</span></figcaption><table><tr><td class="code"><pre><span class="line">provider <span class="string">&quot;aws&quot;</span> &#123;</span><br><span class="line">  region = <span class="string">&quot;ap-northeast-1&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">provider <span class="string">&quot;aws&quot;</span> &#123;</span><br><span class="line">  region = <span class="string">&quot;ap-northeast-3&quot;</span></span><br><span class="line">  <span class="built_in">alias</span>  = <span class="string">&quot;ap3&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module <span class="string">&quot;vpc&quot;</span> &#123;</span><br><span class="line">  <span class="built_in">source</span> = <span class="string">&quot;任意のディレクトリ&quot;</span></span><br><span class="line"></span><br><span class="line">  vpc_cidr_block = <span class="string">&quot;10.10.100.0/24&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module <span class="string">&quot;vpc_dr&quot;</span> &#123;</span><br><span class="line">  <span class="built_in">source</span> = <span class="string">&quot;任意のディレクトリ&quot;</span></span><br><span class="line"></span><br><span class="line">  providers = &#123;</span><br><span class="line">    aws = aws.ap3</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  vpc_cidr_block = <span class="string">&quot;10.10.101.0/24&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>モジュールに、作成するリソースごと重複を許容できない場合には変数を切り出し、モジュールの呼び出し側で適切なパラメータを渡してあげるイメージになります。また、Providerがクラウドのエンドポイントをさし示しているので、モジュールごとエンドポイントの向く先も変わるでしょう。</p><h3 id="本環境のパラメータ（リソース）を引用する形で作成する場合"><a href="#本環境のパラメータ（リソース）を引用する形で作成する場合" class="headerlink" title="本環境のパラメータ（リソース）を引用する形で作成する場合"></a>本環境のパラメータ（リソース）を引用する形で作成する場合</h3><p>これは本環境、DR環境両方で常時稼働させるパターンのもの、かつ、本環境のリソースを引用、および継承してDRを作る場合がここに当てはまります。そもそもDR環境で稼働させるものは何かと考えたとき、迅速な回復、喪失を避けて通りたいのはDBやバケットなどのストレージ系が当てはまるかと思います。その中でRDSを例とします。</p><figure class="highlight sh"><figcaption><span>db_instance.tf</span></figcaption><table><tr><td class="code"><pre><span class="line">resource <span class="string">&quot;aws_db_instance&quot;</span> <span class="string">&quot;postgres&quot;</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  db_name                  = var.db_primary_arn == null ? <span class="string">&quot;default&quot;</span> : null</span><br><span class="line">  engine                   = <span class="string">&quot;postgres&quot;</span></span><br><span class="line">  username                 = var.db_primary_arn == null ? <span class="string">&quot;admin&quot;</span> : null</span><br><span class="line">  password                 = var.db_primary_arn == null ? <span class="string">&quot;admin&quot;</span> : null</span><br><span class="line">  publicly_accessible      = <span class="literal">false</span></span><br><span class="line">  backup_retention_period  = 7</span><br><span class="line">  backup_window            = <span class="string">&quot;20:00-20:30&quot;</span></span><br><span class="line">  maintenance_window       = <span class="string">&quot;mon:06:00-mon:06:30&quot;</span></span><br><span class="line">  port                     = 5432</span><br><span class="line">  replicate_source_db      = var.db_primary_arn</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  tags = &#123;</span><br><span class="line">    Name  = <span class="string">&quot;prod-db&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable <span class="string">&quot;db_primary_arn&quot;</span> &#123;</span><br><span class="line">  <span class="built_in">type</span>    = string</span><br><span class="line">  default = null</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output <span class="string">&quot;db_arn&quot;</span> &#123;</span><br><span class="line">  value = aws_db_instance.postgres.arn</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight sh"><figcaption><span>main.tf</span></figcaption><table><tr><td class="code"><pre><span class="line">provider <span class="string">&quot;aws&quot;</span> &#123;</span><br><span class="line">  region = <span class="string">&quot;ap-northeast-1&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">provider <span class="string">&quot;aws&quot;</span> &#123;</span><br><span class="line">  region = <span class="string">&quot;ap-northeast-3&quot;</span></span><br><span class="line">  <span class="built_in">alias</span>  = <span class="string">&quot;ap3&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module <span class="string">&quot;db&quot;</span> &#123;</span><br><span class="line">  <span class="built_in">source</span> = <span class="string">&quot;任意のディレクトリ&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module <span class="string">&quot;db_dr&quot;</span> &#123;</span><br><span class="line">  <span class="built_in">source</span> = <span class="string">&quot;任意のディレクトリ&quot;</span></span><br><span class="line"></span><br><span class="line">  providers = &#123;</span><br><span class="line">    aws = aws.ap3</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  db_primary_arn = module.db.db_arn</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ポイントだと考えているのは…</p><ul><li>プライマリ（本環境）のインスタンスについては通常のパラメータを入れること</li><li>環境ごと入れるパラメータ、nullにするパラメータをハンドリングすること</li></ul><p>…だと考えています。変数として<code>db_primary_arn</code>を書き出し、この変数に値が入っているかどうかを判定することで、プライマリのインスタンスになるか、DR向けのレプリカインスタンスかを判定して作成することが可能になります。</p><p>三項演算子を多く使っていることはもう少し改善ポイントですが、少ない変数でリソースのハンドリングができることで、使いやすさを意識しています。そして、<code>default = null</code>にしておくことで、不要な変数を定義を回避しています。</p><h3 id="DR環境では構築しないリソース"><a href="#DR環境では構築しないリソース" class="headerlink" title="DR環境では構築しないリソース"></a>DR環境では構築しないリソース</h3><p>コストの観点から、DRでは構築せず、有事の際に作成するリソースもあり得るでしょう。その際にはcountやfor_eachといったTerraformにおけるループ構文を用いてハンドリングしています。例ではEC2インスタンスを記載しています。</p><figure class="highlight sh"><figcaption><span>instance.tf</span></figcaption><table><tr><td class="code"><pre><span class="line">resource <span class="string">&quot;aws_instance&quot;</span> <span class="string">&quot;instance&quot;</span> &#123;</span><br><span class="line">  count = length(var.instance_ip_address)</span><br><span class="line">  ...</span><br><span class="line">  vpc_security_group_ids  = [....]</span><br><span class="line">  private_ip              = var.instance_ip_address[count.index]</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable <span class="string">&quot;instance_ip_address&quot;</span> &#123;</span><br><span class="line">  <span class="built_in">type</span>    = list(string)</span><br><span class="line">  default = []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight sh"><figcaption><span>main.tf</span></figcaption><table><tr><td class="code"><pre><span class="line">provider <span class="string">&quot;aws&quot;</span> &#123;</span><br><span class="line">  region = <span class="string">&quot;ap-northeast-1&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">provider <span class="string">&quot;aws&quot;</span> &#123;</span><br><span class="line">  region = <span class="string">&quot;ap-northeast-3&quot;</span></span><br><span class="line">  <span class="built_in">alias</span>  = <span class="string">&quot;ap3&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module <span class="string">&quot;instance&quot;</span> &#123;</span><br><span class="line">  <span class="built_in">source</span> = <span class="string">&quot;任意のディレクトリ&quot;</span></span><br><span class="line"></span><br><span class="line">  instance_ip_address = [<span class="string">&quot;xx.xx.xx.xx&quot;</span>, <span class="string">&quot;yy.yy.yy.yy&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module <span class="string">&quot;instance_dr&quot;</span> &#123;</span><br><span class="line">  <span class="built_in">source</span> = <span class="string">&quot;任意のディレクトリ&quot;</span></span><br><span class="line"></span><br><span class="line">  providers = &#123;</span><br><span class="line">    aws = aws.ap3</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>instance_ip_address</code>の配列に対して、IPがあればその分だけリソースを作成し、空の配列（デフォルト値）が入ったときは<code>count = 0</code>になるので作成されないことになります。</p><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>Terraformを使ったマルチリージョン構築は、IaC自体のメリットを最大限かせるものだと考えています。その中で再利用性、可搬性を意識していくと、私はここまでに記載したような方法でそれなりにスマートに実装ができたと思います。</p><p>途中にも記載しましが、まずは本環境向けの構築を中心におこない、その上でDR環境に向けて何を切り出さないといけないか、微修正を重ねながら実装していくことが1つの方法でしょう。<br>本記事以外の構成も気になるので、ぜひリアクションいただけると幸いです。</p><p>最後になりますが、今日から約10記事、Terraformのネタが続きますので、この連載や技術ブログにこれまで上がっているTerraformの記事もぜひご覧ください。</p><ul><li><a href="/articles/20230327a/">2023年 Terraform連載</a></li><li><a href="/tags/Terraform/">Terraformタグの記事</a></li></ul><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>本記事では触れていませんが、1つのモジュールに対して2つのリージョンに投げる場合（CloudFrontとALB）の構成の場合には、<code>configuration_aliases</code>を使うことで対応できます。<br>(<code>configuration_aliases</code>の使い方は「<a href="https://qiita.com/kaedemalu/items/d148c86f901f654f2930">かゆいところに手が届く、Terraformの書き方 (configuration_aliasesの使い方)</a>」を参照ください。)</p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;img src=&quot;/images/20240311a/terraform.png&quot; alt=&quot;&quot; width=&quot;800&quot; height=&quot;418&quot;</summary>
        
      
    
    
    
    <category term="Infrastructure" scheme="https://future-architect.github.io/categories/Infrastructure/"/>
    
    
    <category term="Terraform" scheme="https://future-architect.github.io/tags/Terraform/"/>
    
    <category term="インデックス" scheme="https://future-architect.github.io/tags/%E3%82%A4%E3%83%B3%E3%83%87%E3%83%83%E3%82%AF%E3%82%B9/"/>
    
    <category term="DR" scheme="https://future-architect.github.io/tags/DR/"/>
    
    <category term="マルチリージョン" scheme="https://future-architect.github.io/tags/%E3%83%9E%E3%83%AB%E3%83%81%E3%83%AA%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3/"/>
    
  </entry>
  
  <entry>
    <title>Goリリースノートから技術ブログを書く流れ基礎</title>
    <link href="https://future-architect.github.io/articles/20240307a/"/>
    <id>https://future-architect.github.io/articles/20240307a/</id>
    <published>2024-03-06T15:00:00.000Z</published>
    <updated>2024-03-07T07:41:15.042Z</updated>
    
    <content type="html"><![CDATA[<img src="/images/20240307a/image.png" alt="" width="1200" height="818" loading="lazy"><p>The Gopher character is based on the Go mascot designed by Renée French</p><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>TIG真野です。</p><p>フューチャーでは2021年の2月に公開されたGo 1.16から、Goのリリースノートを読んで気になったところをブログにまとめるというブログリレーを続けています。</p><ul><li><a href="/articles/20210207/">Go 1.16連載が始まります</a></li><li><a href="/articles/20210810a/">Go 1.17連載が始まります: コンパイラとgo mod</a></li><li><a href="/articles/20220209a/">Go 1.18集中連載 ジェネリクス</a></li><li><a href="/articles/20220801a/">Go 1.19リリース連載始まります GoDoc&#x2F;ツール周りのアップデート</a></li><li><a href="/articles/20230123a/">Go 1.20リリース連載が始まります＆メモリアリーナの紹介＆落ち穂拾い</a></li><li><a href="/articles/20230731a/">Go 1.21連載始まります＆slogをどう使うべきか</a></li><li><a href="/articles/20240129a/">Go 1.22リリース連載始まります &amp; ループの変化とTinyGo 0.31</a></li></ul><p>単なる翻訳ではなく自分たちならではの付加価値を提供するための執筆のフローや秘訣を、初心者向けにまとめます。社内外あるいはGoだけのとどまらず、次の新しいソフトウェアや技術のリリース時に技術ブログが増えると良いなと思っています。</p><h2 id="時期"><a href="#時期" class="headerlink" title="時期"></a>時期</h2><p><a href="https://go.dev/doc/devel/release">Release History</a>を見るとわかりやすいですが、Goは年2回のペースでメジャーアップデートを繰り返しています。だいたい、2月と8月です。</p><p>その1, 2ヶ月ほど前になるとRelease Candidate（RC）版が公開され、先立って機能を試すことができます。RC版は、 <code>Go1.x.rc1</code>, <code>Go1.x.rc2</code> などというサフィックスで公開され、<code>rc1</code>　とか <code>rc2</code> が出るともうそろそろメジャーリリースが出そうだなと個人的にはワイワイな気持ちになります。</p><p>フューチャーでは、この <code>RC</code> 版が公開されてから、実際にメジャーリリースされる期間（1ヶ月程度）の間に触ってみてブログを公開していくという流れを取ることが多いです。</p><p>リリース状況は以下のXのアカウントをフォローしておくと便利だなと思います。</p><p><a href="https://twitter.com/golang">https://twitter.com/golang</a></p><h2 id="お題の選定"><a href="#お題の選定" class="headerlink" title="お題の選定"></a>お題の選定</h2><p>リリースノートはRC版が公開されるころにはDraft版が公開されていますので、ざっと見て、各人の興味がある部分を選定します。テーマ選定が個人的に一番悩ましいポイントです。</p><p>Go 1.22を例にします。「私見」ですがリリースノートは大きく６つのブロックに分割できます。</p><img src="/images/20240307a/release_note.drawio_(2).png" alt="release_note.drawio_(2).png" width="1200" height="655" loading="lazy"><p>それぞれ、ブログに取り上げるテーマとして「私見」を述べます。</p><ol><li>言語レベルの変更<ul><li>Go 1.18だとジェネリクス、Go 1.22だとforループの変数についての変更など、メジャーリリース目玉と言っても良い項目です。注目度も高いゆえ多くの人によって発信されることが比較的多いです</li></ul></li><li>コマンド系の更新<ul><li><code>go test</code> のようなコマンドのアップデート系です</li><li>もし利用頻度が高いコマンドにアップデートがあれば、テーマに取り上げると差別化が図りやすいです</li><li><strong>お勧めです</strong></li></ul></li><li>ビルド,実行時の改善系<ul><li>個人的には中級者向けのアップデートです。GCやメモリ配置の最適化により実行時の性能改善や、コンパイラがインライン化するなどの更新があればここに含まれます。興味深いですが、中級者以上向けです</li><li>渋川さんの<a href="https://future-architect.github.io/articles/20220808a/">GCの記事</a> や<a href="https://future-architect.github.io/articles/20230123a/">メモリアリーナ</a>の記事が該当します。学びです</li></ul></li><li>新パッケージの追加<ul><li>新しい標準パッケージを使ってみるのはGoではGoDocやExampleがある程度整備されていることが多く、動かしやすいためお勧めです</li><li>ライブラリによっては人を選ぶものがあり（例えば、Go 1.20では<a href="https://tip.golang.org/doc/go1.20#library">crypto&#x2F;ecdh</a> という鍵交換の暗号周りに利用するパッケージが追加されました）、前提知識からキャッチアップが必要な内容もしばしばあります</li><li><code>net/http</code> など利用頻度が高いメジャーなパッケージの変更は、役立つことが多いので調べると多くの人にとっても学びになります</li><li><strong>お勧めです</strong></li></ul></li><li>マイナーアップデート<ul><li>すでに存在するパッケージに、APIが追加されたという内容です（Goの互換性ポリシーでは関数の削除や、シグネチャの変更はありません）</li><li><strong>お勧めです</strong></li></ul></li><li>OS&#x2F;プロセッサのサポート<ul><li>例えば、RISC-VやOpenBSDのサポートの更新についての紹介です</li><li>上級者向けです</li></ul></li></ol><p>「お勧め」と書いた部分も、メジャーバージョンごとに差異が大きく、実際にテーマ選定時には当然リリースノートを確認する必要があります。面白そうなアップデートだと思ったけど、Windows OS特有の修正で、検証が難しくて途中で諦めたケースなどが過去の連載でもありました。</p><p>※改めて強調しますが、全て個人の意見です。初心者だろうがベテランだろうが、気になったところを興味が赴くままに触ってみることが大事だと思っています。一方で、ピンと来る内容が無いことも初心者だと多いと思います。その時に、あえて絞り込むならという視点で書いています。</p><h2 id="アドバイスを出す-貰う"><a href="#アドバイスを出す-貰う" class="headerlink" title="アドバイスを出す&#x2F;貰う"></a>アドバイスを出す&#x2F;貰う</h2><p>初心者の場合は、どのテーマを深掘りすべきか決め手にかけるということも多いと思います。</p><p>その場合は、有識者に「書きやすそうなネタリスト」を出してもらって、そこから選ぶというのも良い進め方だと思います。</p><p>過去、わたしも社内で執筆メンバーを募集したときは以下のネタが書きやすいのでは？という内容をリストアップして告知しました。</p><img src="/images/20240307a/unnamed.png" alt="unnamed.png" width="731" height="374" loading="lazy"><p>改めて見ると、このリストアップもどうなんだ…とも思いますが、これを見てテーマを決めたという人もいました。</p><p>難易度を判定できる人に教えてもらう、というのは最初の取っ掛かりとして悪くないため、周囲に頼れる人がいれば頼り、テックリード的な人は補助線を引いて上げると良いかなと思います。</p><h2 id="環境を構築する"><a href="#環境を構築する" class="headerlink" title="環境を構築する"></a>環境を構築する</h2><p>お手軽な手法として、 <code>go install</code> を使う方法があります。例えば <code>go 1.22rc2</code> をインストールする場合は<a href="https://pkg.go.dev/golang.org/dl#section-readme">このページから</a>バージョンをたどり、次のコマンドが用意されています。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ go install golang.org/dl/go1.22rc2@latest</span><br><span class="line">$ go1.22rc2 download</span><br></pre></td></tr></table></figure><p>これで <code>go</code> コマンドのように <code>go1.22rc2</code> コマンドを利用することができます。 <code>go1.22rc2 run main.go</code> といった形でいち早く新バージョンを動かせ、かつ既存のGoのバージョンを変えなくても済むので便利です。</p><p>GoLandを使っている人はさらに楽ができます。</p><img src="/images/20240307a/image_2.png" alt="image.png" width="903" height="470" loading="lazy"><p>設定＞Go＞GOROOT＞＋記号＞ダウンロードで、GoLand側でバージョンリストを出してくれ、指定したいバージョンをクリックするとダウンロードからIDE内でPATHまで諸々設定してくれます。GoLandのターミナルで実行する <code>go</code> コマンドまで指定のバージョンを利用してくれるため便利です。</p><h2 id="プロポーサル（Issue）を探す"><a href="#プロポーサル（Issue）を探す" class="headerlink" title="プロポーサル（Issue）を探す"></a>プロポーサル（Issue）を探す</h2><p>リリースノートからブログを書くと言いましたが、リリースノートの内容は簡略化した内容ですので、加えてGoDocやプロポーサルを確認して、背景や議論のやり取りを確認すると内容が深まります。</p><p>プロポーサル（Issue）の探し方ですが、一番簡単なのは、ページのHTMLを開き（Chromeであれば ctrl + U）、そこにコメントされているURLを取得する方法です。おそらくこの手法が最速です。</p><p>次のように range overが議論されていたIssueが見つかります。</p><img src="/images/20240307a/image_3.png" alt="image.png" width="959" height="273" loading="lazy"><p>それを開くとGitHub Issueに飛べると思います。</p><img src="/images/20240307a/image_4.png" alt="image.png" width="1149" height="445" loading="lazy"><p>時には長い議論になっていることも多いですので、サマリにまとめるだけでも良いとっかかりな記事にしやすいと思います。</p><p>社内メンバーは次のようなポイントを拾うことが多いです。</p><ul><li>背景（なぜそれが必要なのか、従来の課題は何か）</li><li>それがなかった場合、従来はどう対応していたか</li><li>受け入れられなかった別案にはどういったものがあったか</li><li>レビュアーが懸念していることにどんなことがあるか</li></ul><p>辻さんの<a href="https://future-architect.github.io/articles/20230128a/">HTTP ResponseController</a>記事では、互換性の立場からこっちのメソッドを拡張できずといった説明があります。ある断面だけだと不自然に思えることも、歴史的経緯を知ると理解しやすくなりますよね。</p><p>IssueからはコードレビューのURLがリンクされていることが多いので、どのようなファイルの修正があったかも確認できます。コードの修正内容まで踏み込めるとオリジナリティ溢れること間違いないです。</p><h2 id="触ってみる"><a href="#触ってみる" class="headerlink" title="触ってみる"></a>触ってみる</h2><p>実際にサンプルコードを書いて動かすと理解が深まります。</p><p>もし、標準パッケージの追加&#x2F;更新であればテストコードが存在するため、GoDocだけみて動かし方がわからない場合も、標準パッケージのテストコードを参考にするとよいです。それらをデバック実行してみて、どのような実装になっているか内部のコードを見ても面白いですね。</p><p>棚井さんは <code>encoding/base32</code> をテーマに、<a href="https://future-architect.github.io/articles/20240201a/">Base32そのものの変換処理の流れを解説</a>する記事を書いていました。こうした派生は面白いですね。</p><p>Bug Fix系であれば、新バージョンと旧バージョンで比較して動作検証してみても良いかもしれません。</p><p>また、性能が気になればベンチマークを取ってみるというのも、知見を増やしやすいポイントです。例えば、<a href="https://future-architect.github.io/articles/20240202a/#%E6%80%A7%E8%83%BD%E8%A8%88%E6%B8%AC">武田さんの記事</a>では、標準のnet&#x2F;httpとサードパーティ製ライブラリでベンチマークを取っていて、使えそうかそうじゃないかの1つの材料を提供しています。</p><p><a href="https://future-architect.github.io/articles/20240214a/">私もnet&#x2F;httpの記事</a>では、CPUプロファイルや、<code>strace</code> を用いて、システムコールの発行具合を調査した記事を書きました。Goは標準に様々なツールがあり分析できるので、引き出しを増やすという意味でも学びになります。</p><p>触ってみて得た知見や疑問点も、記事に書いたり周囲のGopherな人に雑談で話すと、ネタが広がることも多いので、記事を書く前にもどんどん発信してフィードバックをもらいましょう。</p><h2 id="コードリーディングのお供に"><a href="#コードリーディングのお供に" class="headerlink" title="コードリーディングのお供に"></a>コードリーディングのお供に</h2><p>コードリーディングのサポートとしてGitHub Copilotをうまく活用しているよというメンバーもいます。</p><p>途中で難易度の高い処理にぶつかっても、エディタ上でCopilotに質問すれば、処理内容を解説して頂けます。</p><p>VSCodeプラグインもあります。</p><img src="/images/20240307a/image_5.png" alt="image.png" width="1200" height="296" loading="lazy"><p><a href="https://marketplace.visualstudio.com/items?itemName=GitHub.copilot">https://marketplace.visualstudio.com/items?itemName=GitHub.copilot</a></p><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>自分のレベルと興味にあったテーマの選定が最も難しく、決まればプロポーサルはリリースノートからすぐにたどり着けますので、あとはテストコードやデバック、ベンチマーク、プロファイルなどのツールを駆使していろいろ触ってみて得た知見を記事にしましょう、という内容でした。</p><p>リリースを記念に祝う目的でブログを書くと、良い感じの緩さ加減な期日感もあり機会としてはちょうどいいですし、適度に学びになります。</p><p>もっと良い方法があればXでぜひ教えてください。</p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;img src=&quot;/images/20240307a/image.png&quot; alt=&quot;&quot; width=&quot;1200&quot; height=&quot;818&quot; loading=&quot;lazy&quot;&gt;

&lt;p&gt;The Gopher character is based on the Go mascot</summary>
        
      
    
    
    
    <category term="Programming" scheme="https://future-architect.github.io/categories/Programming/"/>
    
    
    <category term="初心者向け" scheme="https://future-architect.github.io/tags/%E5%88%9D%E5%BF%83%E8%80%85%E5%90%91%E3%81%91/"/>
    
    <category term="Go" scheme="https://future-architect.github.io/tags/Go/"/>
    
    <category term="リリースノート" scheme="https://future-architect.github.io/tags/%E3%83%AA%E3%83%AA%E3%83%BC%E3%82%B9%E3%83%8E%E3%83%BC%E3%83%88/"/>
    
    <category term="技術ブログ" scheme="https://future-architect.github.io/tags/%E6%8A%80%E8%A1%93%E3%83%96%E3%83%AD%E3%82%B0/"/>
    
  </entry>
  
</feed>
